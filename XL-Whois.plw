#!/usr/bin/perl
# Perl - v: 5.16.3
#------------------------------------------------------------------------------#
# Tool name     : XL-Whois
# Description   : Part of the XL-Toolkit, XL-Whois is a tool to gather whois
#                 information on domain and IP address. It store the responses
#                 into a database that can be used with other tools of the
#                 XL-Toolkit.
# WebSite       : http://le-tools.com/XL-Whois.html
# Documentation : http://le-tools.com/XL-WhoisDoc.html
# SourceForge   : https://sourceforge.net/p/xl-whois
# GitHub        : https://github.com/arioux/XL-Whois
# Creation      : 2015-09-30
# Modified      : 2019-02-18
my $VERSION     = "5.0.1";
# Author        : Alain Rioux (admin@le-tools.com)
#
# Copyright (C) 2015-2019  Alain Rioux (le-tools.com)
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#------------------------------------------------------------------------------#
# Modules
#------------------------------------------------------------------------------#
use strict;
use warnings;
use threads;
use threads::shared;
use Thread::Queue;
use ActiveState::DateTime qw(gmt_offset);
use HTTP::Date qw(parse_date str2time);
use Encode qw(decode encode decode_utf8);
use Text::Unidecode;
use Win32::API();
use Win32::GUI();
use Win32::GUI 1.06 qw(:toolbar ILC_MASK CW_USEDEFAULT);
use Win32::GUI::Grid;
use Win32::Clipboard;
use Win32::Process;
use DBI;
use Regexp::IPv6 qw($IPv6_re);
use Domain::PublicSuffix;
use Net::Whois::IP qw(whoisip_query);
use Net::Whois::Raw qw(whois);
use Net::DNS;
use Net::CIDR qw(cidr2range range2cidr);
use Net::IP::Lite;
use NetAddr::IP;
use JSON::Parse qw/json_file_to_perl parse_json/;
use Data::Dump qw(dump);
use base qw/Net::DNS::Resolver::Base/;
use HTTP::Request::Common qw(POST);
use LWP::UserAgent;
use LWP::Simple;
use REST::Client;
use XML::MyXML qw(tidy_xml xml_to_object);
use GeoIP2::Database::Reader;
use Archive::Tar;
use Try::Tiny;
require "XL-WhoisGraph.pl";
require "XL-WhoisLang.pl";

#------------------------------------------------------------------------------#
# Global variables
#------------------------------------------------------------------------------#
$ENV{'PERL_LWP_SSL_VERIFY_HOSTNAME'} = 0;
my $PROGDIR = $0;                                                              # Program path
while (chop($PROGDIR) ne "\\") { }                                             # Dir only
my $USERDIR;                                                                   # User path
if (-d "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Whois") { $USERDIR = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Whois"; }
else                                            { $USERDIR = $PROGDIR;                                }
my $CONFIG_FILE = "$USERDIR\\XL-Whois.ini";                                    # Configuration file
my $LANG_FILE   = "$USERDIR\\Lang.ini";                                        # Langage file
my $URL_DOC     = "http://le-tools.com/XL-WhoisDoc.html";                      # Online documentation
my $URL_TOOL    = 'http://le-tools.com/XL-Whois.html#Download';                # Url of the tool
my $URL_VER     = 'http://www.le-tools.com/download/XL-WhoisVer.txt';          # Url of the version file
my %CONFIG      :shared;                                                       # Configuration
my %STR;                                                                       # Strings for GUI
my $TLDDB_URL   = 'https://publicsuffix.org/list/effective_tld_names.dat';                       # URL of the TLD DB
my $WSDB_URL    = 'https://raw.githubusercontent.com/weppos/whois/master/data/tld.json';         # URL of the Whois Server DB
my $WSLOG_URL   = 'https://github.com/weppos/whois/commits/master/data/tld.json';                # URL of the Whois Server DB (Commit page)
my $IPv4DB_URL  = 'http://www.iana.org/assignments/ipv4-address-space/ipv4-address-space.xhtml'; # URL of the IPv4 Address Space (to get modified date)
my $IPv4DB_CSV  = 'http://www.iana.org/assignments/ipv4-address-space/ipv4-address-space.csv';   # URL of the IPv4 Address Space (the csv file)
my $IPv6DB_URL  = 'http://www.iana.org/assignments/ipv6-unicast-address-assignments/ipv6-unicast-address-assignments.xhtml'; # URL of the IPv6 Address Space (to get modified date)
my $IPv6DB_CSV  = 'http://www.iana.org/assignments/ipv6-unicast-address-assignments/ipv6-unicast-address-assignments.csv';   # URL of the IPv6 Address Space (the csv file)
my $GEOIPDB_URL = 'https://geolite.maxmind.com/download/geoip/database/GeoLite2-City.tar.gz';                                # URL of the GeoIP DB
my $TOTAL_SIZE      :shared = 0;                                               # Total size for download
my $START = 0;                                                                 # Indicate when program is started
my $ARROW           :shared;                                                   # Arrow pointer
my $HOURGLASS       :shared;                                                   # Hourglass pointer
my $THR;                                                                       # Thread
my $THR_UPDATE;                                                                # Thread for update
my $LISTNO          = 0;                                                       # For CTRL+A
my $NBR_CHARS       = 0;                                                       # Number of CHAR in search DB
my $ADD_FILTER      = 0;                                                       # Indicate that filter must be added to current value
my $ANALYSIS_QUEUE;                                                            # Queue for Whois Database Analysis
my $NBR_DELETED_ISP :shared = 0;                                               # Number of deleted ISP in Whois Database Analysis
my $TLDDB;                                                                     # TLD Database
my $ROW;                                                                       # Selected row on right click
my $COLUMN;                                                                    # Selected column on right click

#------------------------------------------------------------------------------#
# Graphic elements
#------------------------------------------------------------------------------#
my ($winICO, $logoBmp, $logo128Bmp, $browseBmp, $openDirBmp, $fileOpenBmp, $fileNewBmp,
    $downloadBmp, $clipboardBmp, $whoisBmp, $databaseBmp, $config32Bmp, $config128Bmp,
    $helpBmp, $aboutBmp, $exportBmp, $importBmp, $extractBmp, $validdbBmp, $searchDB,
    $searchDB_p, $searchDB_n, $filterDB, $filterDB_p, $filterDB_n, $database16,
    $checkBmp, $errorBmp) = &loadGraph();

#------------------------------------------------------------------------------#
# Strings
#------------------------------------------------------------------------------#
&loadDefaultStr(\%STR); # Load default language (en)
if (-e $LANG_FILE and -T $LANG_FILE) { &loadStr(\%STR, $LANG_FILE); } # If language file, load translated strings

#------------------------------------------------------------------------------#
# Main window
#------------------------------------------------------------------------------#
my $screen    = Win32::GUI::GetDesktopWindow(); # Screen resolution
my $scrnX     = Win32::GUI::Width($screen);
my $scrnY     = Win32::GUI::Height($screen);
my $winWidth  = 503;
my $winHeight = 372;
my $winPosX   = ($scrnX - $winWidth)  / 2;
my $winPosY   = ($scrnY - $winHeight) / 2;
# Keyboard shorcut
my $accel = new Win32::GUI::AcceleratorTable("Ctrl-A" => "selectAll");
# Main Window
my $win = Win32::GUI::Window->new( -name        => 'winMain'              ,
                                   -text        => 'XL-Whois'             ,
                                   -background  => [255, 255, 255]        ,
                                   -size        => [$winWidth, $winHeight],
                                   -pos         => [$winPosX , $winPosY]  ,
                                   -resizable   => 0                      ,
                                   -hasmaximize => 0                      , 
                                   -accel       => $accel                 , );
$win->SetIcon($winICO);
# Fonts
sub LOGPIXELSX() {88}
sub getDPI       { return(Win32::GUI::DC->new()->GetDeviceCaps(LOGPIXELSX)); }
my $DPI = &getDPI();
my $fontGB;
my $font10;
my $font10b;
my $font10u;
my $font12;
# Larger size (125% and 150%)
if ($DPI >= 120) {
  $fontGB = new Win32::GUI::Font( -name => 'Arial', -size => 10, -bold => 1, -underline => 1);
  $font10  = new Win32::GUI::Font(-name => 'Arial', -size =>  8);
  $font10b = new Win32::GUI::Font(-name => 'Arial', -size =>  8, -bold => 1);
  $font10u = new Win32::GUI::Font(-name => 'Arial', -size =>  8, -bold => 1, -underline => 1);
  $font12  = new Win32::GUI::Font(-name => 'Arial', -size =>  9);
# Normal size
} else {
  $fontGB = new Win32::GUI::Font( -name => 'Arial', -size => 12, -bold => 1, -underline => 1);
  $font10  = new Win32::GUI::Font(-name => 'Arial', -size => 10);
  $font10b = new Win32::GUI::Font(-name => 'Arial', -size => 10, -bold => 1);
  $font10u = new Win32::GUI::Font(-name => 'Arial', -size => 10, -bold => 1, -underline => 1);
  $font12  = new Win32::GUI::Font(-name => 'Arial', -size => 11);  
}
# Load Pointers
my $loadImage = new Win32::API('user32', 'LoadImage', ['N','N','I','I','I','I'],'N');
$HOURGLASS    = $loadImage->Call(0, 32514, 2, 0, 0, 0x8040);
$ARROW        = $loadImage->Call(0, 32512, 2, 0, 0, 0x8040);
# Taskbar
$win->AddNotifyIcon(  -name        => "Tray"                  , 
                      -icon        => $winICO                 ,
                      -tip         => 'XL-Whois'              ,
                      -balloon     => 1                       , );
# Title
$win->AddLabel(       -name        => 'lblLogo'               ,
                      -size        => [499, 70]               ,
                      -pos         => [  0,  0]               ,
                      -bitmap      => $logoBmp                ,
                      -background  => [255, 255, 255]         , );  # Text color in image: #54a0eeff

$win->AddButton(      -name        => 'btnItemClip'           ,
                      -size        => [ 40, 40]               ,
                      -pos         => [  5, 75]               ,
                      -bitmap      => $clipboardBmp           ,
                      -tip         => $STR{'btnItemClip'}     , );
$win->AddLabel(       -name        => 'lblInput'              ,
                      -size        => [350, 22]               ,
                      -pos         => [ 55, 85]               ,
                      -background  => [255, 255, 255]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'lblInput'}        ,
                      -font        => $font12                 , );
$win->AddLabel(       -name        => 'lblOptions'            ,
                      -size        => [115, 22]               ,
                      -pos         => [  5,125]               ,
                      -background  => [255, 255, 255]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'Options'}.':'     ,
                      -font        => $fontGB                 , );
$win->AddCheckbox(    -name        => 'chDomain'              ,
                      -size        => [120, 20]               ,
                      -pos         => [130,125]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => 'Domain whois'          ,
                      -font        => $font10                 , );
$win->AddCheckbox(    -name        => 'chNetwork'             ,
                      -size        => [120, 20]               ,
                      -pos         => [255,125]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => 'Network whois'         ,
                      -font        => $font10                 , );
$win->AddCheckbox(    -name        => 'chDNS'                 ,
                      -size        => [110, 20]               ,
                      -pos         => [380,125]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => 'DNS Records'           ,
                      -font        => $font10                 , );
$win->AddCheckbox(    -name        => 'chGeoIP'               ,
                      -size        => [120, 20]               ,
                      -pos         => [130,150]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => 'GeoIP'                 ,
                      -font        => $font10                 , );
$win->AddLabel(       -name        => 'lblWSSelect'           ,
                      -size        => [115, 22]               ,
                      -pos         => [  5,182]               ,
                      -background  => [255, 255, 255]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'WSSelect'}.':'    ,
                      -font        => $fontGB                 , );
$win->AddCombobox(    -name        => 'cbWSSelect'            ,
                      -dropdownlist => 1                      ,
                      -vscroll     => 1                       ,
                      -size        => [130, 80]               ,
                      -pos         => [130,180]               ,
                      -font        => $font10                 , );
$win->cbWSSelect->Add($STR{'WSSelect1'}, 'ARIN', 'LACNIC', 'RIPE', 'AFRINIC', 'APNIC');
$win->cbWSSelect->SetCurSel(0);
$win->AddLabel(       -name        => 'lblCheckDB'            ,
                      -size        => [115, 22]               ,
                      -pos         => [  5,217]               ,
                      -background  => [255, 255, 255]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'lblCheckDB'}.':'  ,
                      -font        => $fontGB                 , );
$win->AddCombobox(    -name        => 'cbCheckWhoisDB'        ,
                      -dropdownlist => 1                      ,
                      -vscroll     => 1                       ,
                      -size        => [130, 80]               ,
                      -pos         => [130,215]               ,
                      -font        => $font10                 , );
$win->cbCheckWhoisDB->Add($STR{'cbCheckWhoisDB1'}, $STR{'cbCheckWhoisDB2'}, $STR{'cbCheckWhoisDB3'}, $STR{'cbCheckWhoisDB4'});
$win->AddCheckbox(    -name        => 'chCheckLogging'        ,
                      -size        => [210, 20]               ,
                      -pos         => [275,216]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => $STR{'chCheckLogging'}  ,
                      -font        => $font10                 , );
$win->AddLabel(       -name        => 'lblAddComment'         ,
                      -size        => [115, 22]               ,
                      -pos         => [  5,250]               ,
                      -background  => [255, 255, 255]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'lblAddComment'}.':',
                      -font        => $fontGB                 , );
$win->AddTextfield(   -name        => 'tfComment'             ,
                      -size        => [300, 24]               ,
                      -pos         => [130,250]               ,
                      -font        => $font10                 ,
                      -disabled    => 1                       , );
# Buttons
$win->AddLabel(       -name        => 'lblFooter'             ,
                      -size        => [494, 80]               ,
                      -pos         => [  2,290]               ,
                      -valign      => 'top'                   ,
                      -background  => [250, 250, 250]         ,
                      -foreground  => [128, 128, 128]         , );
$win->AddLabel(       -name        => 'lblNotReady'           ,
                      -size        => [170, 22]               ,
                      -pos         => [ 10,300]               ,
                      -background  => [250, 250, 250]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'lblNotReady'}     ,
                      -font        => $font10u                ,
                      -notify      => 1                       , );
$win->AddButton(      -name        => 'btnWhois'              ,
                      -size        => [ 40, 40]               ,
                      -pos         => [270,298]               ,
                      -bitmap      => $whoisBmp               ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'btnWhoisTip'}     ,
                      -disabled    => 1                       ,
                      -ok          => 1                       ,
                      -default     => 1                       , );
$win->AddButton(      -name        => 'btnWinDatabase'        ,
                      -size        => [ 40, 40]               ,
                      -pos         => [315,298]               ,
                      -bitmap      => $databaseBmp            ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'btnWinDatabaseTip'}, );
$win->AddButton(      -name        => 'btnWinConfig'          ,
                      -size        => [ 40, 40]               ,
                      -pos         => [360,298]               ,
                      -bitmap      => $config32Bmp            ,
                      -background  => [250, 250, 250]         ,
                      -tip         => 'Configuration'         , );
$win->AddButton(      -name        => 'btnHelp'               ,
                      -size        => [ 40, 40]               ,
                      -pos         => [405,298]               ,
                      -bitmap      => $helpBmp                ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'btnHelpTip'}      , );
$win->AddButton(      -name        => 'btnAbout'              ,
                      -size        => [ 40, 40]               ,
                      -pos         => [450,298]               ,
                      -bitmap      => $aboutBmp               ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'btnAboutTip'}     , );
# Load taskbar menu
my $trayMenu = Win32::GUI::Menu->new(
 	"SysTray"                           => "SysTray",
  ">$STR{'Whois'}"                    => { -name => 'whois'       , -onClick => \&btnWhois_Click        },
  ">$STR{'WhoisComment'}"             => { -name => 'whoisComment', -onClick => \&btnWhoisComment_Click },
  ">$STR{'btnItemClip'}..."           => { -name => 'clipboard'   , -onClick => \&btnItemClip_Click     },
  " > -"                              => 0,
  ">$STR{'Show'} XL-Whois..."         => { -name => 'showWin'     , -onClick => \&Tray_DblClick         },
  ">$STR{'Options'}"                  => { -name => 'MenuOptions' , -item    => 1                       },
  ">>Domain whois"                      => { -name => 'domainWhois' , -onClick => \&DWTrayMenu_Click      },
  ">>Network whois"                     => { -name => 'networkWhois', -onClick => \&NWTrayMenu_Click      },
  ">>DNS Records"                       => { -name => 'dnsRecords'  , -onClick => \&DRTrayMenu_Click      },
  ">>GeoIP"                             => { -name => 'geoip'       , -onClick => \&GeoIPTrayMenu_Click   },
  ">$STR{'WSSelect'}"                 => { -name => 'MenuRegistry' , -item   => 1                       },
  ">>$STR{'WSSelect1'}"                 => { -name => 'regAuto'     , -onClick => \&Reg1TrayMenu_Click    },
  ">>ARIN"                              => { -name => 'regARIN'     , -onClick => \&Reg2TrayMenu_Click    },
  ">>LACNIC"                            => { -name => 'regLACNIC'   , -onClick => \&Reg3TrayMenu_Click    },
  ">>RIPE"                              => { -name => 'regRIPE'     , -onClick => \&Reg4TrayMenu_Click    },
  ">>AFRINIC"                           => { -name => 'regAFRINIC'  , -onClick => \&Reg5TrayMenu_Click    },
  ">>APNIC"                             => { -name => 'regAPNIC'    , -onClick => \&Reg6TrayMenu_Click    },
  ">$STR{'lblCheckDB'}"               => { -name => 'MenuCheckDB'   , -item   => 1                       },
  ">>$STR{'cbCheckWhoisDB1'}"           => { -name => 'chDB1'       , -onClick => \&chDB1TrayMenu_Click   },
  ">>$STR{'cbCheckWhoisDB2'}"           => { -name => 'chDB2'       , -onClick => \&chDB2TrayMenu_Click   },
  ">>$STR{'cbCheckWhoisDB3'}"           => { -name => 'chDB3'       , -onClick => \&chDB3TrayMenu_Click   },
  ">>$STR{'cbCheckWhoisDB4'}"           => { -name => 'chDB4'       , -onClick => \&chDB4TrayMenu_Click   },
  ">>$STR{'chCheckLogging'}"            => { -name => 'chLogDB'     , -onClick => \&chLogDBTrayMenu_Click },
  " > -"                              => 0,
  ">$STR{'Show'} $STR{'winDB'}..."    => { -name => 'whoisdb'     , -onClick => \&btnWinDatabase_Click  },
  ">$STR{'Show'} $STR{'winLogDB'}..." => { -name => 'loggingdb'   , -onClick => \&btnLogDbView_Click    },
  ">$STR{'btnOpenDirTip'}..."         => { -name => 'openRepDir'  , -onClick => \&btnOpenDir_Click      },
  " > -"                              => 0,
  ">$STR{'extractFromClip'}"          => { -name => 'extractClip' , -onClick => \&extractClip_Click     },
  " > -"                              => 0,
  ">$STR{'config'}..."                => { -name => "Config"      , -onClick => \&btnWinConfig_Click    },
  ">$STR{'checkUpdate'}"              => { -name => 'Update'      , -onClick => \&btnCheckUpdate_Click  },
  " > -"                              => 0,
  ">$STR{'Help'}..."                  => { -name => 'Help'        , -onClick => \&btnHelp_Click         },
  ">$STR{'About'}..."                 => { -name => 'About'       , -onClick => \&btnAbout_Click        },
  ">$STR{'Quit'}"                     => { -name => 'Quit'        , -onClick => \&btnQuit_Click         },
);

#------------------------------------------------------------------------------#
# Clipboard Window
#------------------------------------------------------------------------------#
my $winClip = Win32::GUI::Window->new( -name        => 'winClip'             ,
                                       -background  => [255, 255, 255]       ,
                                       -text        => $STR{'winClip'}       ,
                                       -pos         => [$winPosX, $winPosY]  ,
                                       -size        => [$winWidth,$winHeight],
                                       -minsize     => [$winWidth,$winHeight],
                                       -hasmaximize => 1                     ,
                                       -hasminimize => 1                     ,
                                       -resizable   => 1                     ,
                                       -dialogui    => 1                     ,
                                       -accel       => $accel                , );
$winClip->SetIcon($winICO);
$winClip->AddTextfield( -name        => 'tfClip'            ,
                        -size        => [$winWidth-25, $winHeight-85] ,
                        -pos         => [  5,  5]           ,
                        -background  => [255, 255, 255]     ,
                        -multiline   => 1                   ,
                        -wantreturn  => 1                   ,
                        -hscroll     => 1                   ,
                        -vscroll     => 1                   , );
$winClip->AddButton(    -name        => 'btnClipOk'         ,
                        -text        => $STR{'OK'}          ,
                        -size        => [ 80, 30]           ,
                        -pos         => [($winWidth-280)/2,$winHeight-73] ,
                        -ok          => 1                   ,
                        -default     => 1                   , );
$winClip->AddButton(    -name        => 'btnClipSave'       ,
                        -text        => $STR{'Save'}        ,
                        -size        => [ 80, 30]           ,
                        -pos         => [($winWidth-280)/2+100,$winHeight-73] ,
                        -disabled    => 1                   , );
$winClip->AddButton(    -name        => 'btnClipParse'      ,
                        -text        => $STR{'btnClipParse'},
                        -size        => [ 80, 30]           ,
                        -pos         => [($winWidth-280)/2+200,$winHeight-73] , );

#------------------------------------------------------------------------------#
# Config window
#------------------------------------------------------------------------------#
my $winConfig = Win32::GUI::DialogBox->new( -name        => 'winConfig'             ,
                                            -text        => $STR{'config'}          ,
                                            -pos         => [$winPosX, $winPosY]    ,
                                            -size        => [650, 400]              ,
                                            -background  => [255, 255, 255]         ,
                                            -hasmaximize => 0                       ,
                                            -hasminimize => 0                       ,
                                            -helpbutton  => 0                       ,
                                            -resizable   => 0                       ,
                                            -dialogui    => 1                       , );
$winConfig->SetIcon($winICO);
$winConfig->AddLabel(     -name         => 'lblLogo'             ,
                          -size         => [128,128]             ,
                          -pos          => [  0,  5]             ,
                          -bitmap       => $config128Bmp         ,
                          -background   => [255, 255, 255]       , );
# Tabstrip
$winConfig->AddTabStrip(            -name         => 'configTab'           ,
                                    -size         => [505,365]             ,
                                    -pos          => [140,  5]             ,
                                    -fixedwidth   => 1                     ,
                                    -background   => [255, 255, 255]       , );
$winConfig->configTab->InsertItem(  -text         => $STR{'General'}       , );
$winConfig->configTab->InsertItem(  -text         => $STR{'storage'}       , );
$winConfig->configTab->InsertItem(  -text         => $STR{'Databases'}     , );
$winConfig->configTab->SetItemSize(167,20);
# General tab - Tool Section
$winConfig->AddLabel(     -name        => 'lblToolShadowT'        ,
                          -size        => [ 80, 22]               ,
                          -pos         => [151, 36]               ,
                          -foreground  => [180, 180, 180]         ,
                          -background  => [255, 255, 255]         ,
                          -text        => $STR{'tool'}.':'        ,
                          -font        => $fontGB                 , );
$winConfig->AddLabel(     -name        => 'lblToolT'              ,
                          -size        => [ 80, 22]               ,
                          -pos         => [150, 35]               ,
                          -addstyle    => 11                      , # Transparent
                          -foreground  => [  90, 150, 255]        ,
                          -text        => $STR{'tool'}.':'        ,
                          -font        => $fontGB                 , );
$winConfig->AddButton(    -name        => 'btnExportLang'         ,
                          -size        => [125, 24]               ,
                          -pos         => [150, 68]               ,
                          -text        => $STR{'Export'}.' Lang.ini',
                          -font        => $font10                 , );
$winConfig->AddButton(    -name        => 'btnOpenUserDir'        ,
                          -size        => [125, 24]               ,
                          -pos         => [285, 68]               ,
                          -text        => $STR{'OpenUserDir'}.'...',
                          -font        => $font10                 , );
$winConfig->AddButton(    -name        => 'btnCheckUpdate'        ,
                          -size        => [125, 24]               ,
                          -pos         => [150, 98]               ,
                          -text        => $STR{'checkUpdate'}     ,
                          -font        => $font10                 , );
$winConfig->AddCheckbox(  -name        => 'chAutoUpdate'          ,
                          -size        => [200, 20]               ,
                          -pos         => [285,100]               ,
                          -text        => $STR{'chAutoUpdate'}    ,
                          -background  => [255, 255, 255]         ,
                          -font        => $font10                 ,
                          -checked     => 1                       , );
# General tab - Whois section
$winConfig->AddLabel(     -name        => 'lblGeneralShadowT'     ,
                          -size        => [115, 22]               ,
                          -pos         => [151,136]               ,
                          -foreground  => [180, 180, 180]         ,
                          -background  => [255, 255, 255]         ,
                          -text        => $STR{'General'}.':'     ,
                          -font        => $fontGB                 , );
$winConfig->AddLabel(     -name        => 'lblGeneralT'           ,
                          -size        => [115, 22]               ,
                          -pos         => [150,135]               ,
                          -addstyle    => 11                      , # Transparent
                          -foreground  => [  90, 150, 255]        ,
                          -text        => $STR{'General'}.':'     ,
                          -font        => $fontGB                 , );
$winConfig->AddCheckbox(  -name        => 'chStartMinimized'      ,
                          -size        => [220, 20]               ,
                          -pos         => [270,136]               ,
                          -text        => $STR{'chStartMinimized'},
                          -background  => [255, 255, 255]         ,
                          -font        => $font10                 ,
                          -checked     => 1                       , );
$winConfig->AddLabel(     -name        => 'lblNWMode'             ,
                          -size        => [130, 22]               ,
                          -pos         => [150,167]               ,
                          -background  => [255, 255, 255]         ,
                          -text        => $STR{'NWMode'}.':'      ,
                          -font        => $font10                 , );
$winConfig->AddRadioButton( -name        => 'rbNWModeNormal'      ,
                            -size        => [ 80, 22]             ,
                            -pos         => [285,165]             ,
                            -background  => [255, 255, 255]       ,
                            -text        => $STR{'NWModeNormal'}  ,
                            -font        => $font10               ,
                            -checked     => 1                     ,
                            -group       => 1                     , );
$winConfig->AddRadioButton( -name        => 'rbNWModeRDAP'        ,
                            -size        => [ 80, 22]             ,
                            -pos         => [370,165]             ,
                            -background  => [255, 255, 255]       ,
                            -text        => $STR{'NWModeRDAP'}    ,
                            -font        => $font10               , );
$winConfig->AddLabel(     -name        => 'lblGeoIPLang'          ,
                          -size        => [130, 22]               ,
                          -pos         => [150,194]               ,
                          -background  => [255, 255, 255]         ,
                          -text        => "$STR{'GeoIP'} $STR{'language'}:",
                          -font        => $font10                 , );
$winConfig->AddCombobox(  -name        => 'cbGeoIPLang'           ,
                          -dropdownlist => 1                      ,
                          -vscroll     => 1                       ,
                          -size        => [ 60, 80]               ,
                          -pos         => [285,192]               ,
                          -font        => $font10                 , );
$winConfig->cbGeoIPLang->Add('en', 'de', 'es', 'fr', 'ja', 'pt-BR', 'ru', 'zh-CN');
$winConfig->cbGeoIPLang->SetCurSel(0);
$winConfig->AddLabel(     -name        => 'lblNsLookupTO1'        ,
                          -size        => [130, 22]               ,
                          -pos         => [150,224]               ,
                          -background  => [255, 255, 255]         ,
                          -text        => $STR{'lblNsLookupTO1'}.':',
                          -font        => $font10                 , );
$winConfig->AddTextfield( -name        => 'tfLookupTO'            ,
                          -size        => [ 30, 22]               ,
                          -pos         => [285,222]               , );
$winConfig->AddLabel(     -name        => 'lblNsLookupTO2'        ,
                          -size        => [ 70, 22]               ,
                          -pos         => [320,224]               ,
                          -background  => [255, 255, 255]         ,
                          -text        => $STR{'lblNsLookupTO2'}  ,
                          -font        => $font10                 , );
$winConfig->AddLabel(     -name        => 'lblUserAgent'          ,
                          -size        => [130, 22]               ,
                          -pos         => [150,255]               ,
                          -background  => [255, 255, 255]         ,
                          -text        => $STR{'UserAgent'}.':'   ,
                          -font        => $font10                 , );
$winConfig->AddTextfield( -name        => 'tfUserAgent'           ,
                          -size        => [350, 22]               ,
                          -pos         => [285,252]               , );
# General tab - Parser section
$winConfig->AddLabel(     -name        => 'lblParserShadowT'      ,
                          -size        => [ 80, 22]               ,
                          -pos         => [151,285]               ,
                          -foreground  => [180, 180, 180]         ,
                          -background  => [255, 255, 255]         ,
                          -text        => $STR{'lblParser'}.':'   ,
                          -font        => $fontGB                 , );
$winConfig->AddLabel(     -name        => 'lblParserT'            ,
                          -size        => [ 80, 22]               ,
                          -pos         => [150,284]               ,
                          -addstyle    => 11                      , # Transparent
                          -foreground  => [  90, 150, 255]        ,
                          -text        => $STR{'lblParser'}.':'   ,
                          -font        => $fontGB                 , );
$winConfig->AddCheckbox(  -name        => 'chIPv4'                ,
                          -size        => [ 40, 20]               ,
                          -pos         => [150,314]               ,
                          -background  => [255, 255, 255]         ,
                          -text        => 'IPv4'                  ,
                          -font        => $font10                 , );
$winConfig->AddCheckbox(  -name        => 'chIPv6'                ,
                          -size        => [ 40, 20]               ,
                          -pos         => [150,339]               ,
                          -background  => [255, 255, 255]         ,
                          -text        => 'IPv6'                  ,
                          -font        => $font10                 , );
$winConfig->AddCheckbox(  -name        => 'chHostname'            ,
                          -size        => [ 80, 20]               ,
                          -pos         => [280,314]               ,
                          -background  => [255, 255, 255]         ,
                          -text        => 'Hostname'              ,
                          -font        => $font10                 , );
$winConfig->AddCheckbox(  -name        => 'chDomainName'          ,
                          -size        => [100, 20]               ,
                          -pos         => [280,339]               ,
                          -background  => [255, 255, 255]         ,
                          -text        => 'Domain Name'           ,
                          -font        => $font10                 , );
# Storage tab - Report section
$winConfig->AddLabel(       -name        => 'lblReportShadowT'      ,
                            -size        => [260, 22]               ,
                            -pos         => [151, 36]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'lblReport'}.':'   ,
                            -font        => $fontGB                , 
                            -visible     => 0                       , );
$winConfig->AddLabel(       -name        => 'lblReportT'            ,
                            -size        => [260, 22]               ,
                            -pos         => [150, 35]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [  90, 150, 255]        ,
                            -text        => $STR{'lblReport'}.':'   ,
                            -font        => $fontGB                ,
                            -visible     => 0                       ,  );
$winConfig->AddCheckbox(    -name        => 'chAutoViewing'         ,
                            -size        => [175, 20]               ,
                            -pos         => [415, 38]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chAutoViewing'}   ,
                            -font        => $font10                 ,
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfMaxView'             ,
                            -size        => [ 30, 22]               ,
                            -pos         => [595, 38]               ,
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfReportDir'           ,
                            -size        => [412, 22]               ,
                            -pos         => [150, 68]               ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnReportDir'          ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565, 68]               ,
                            -bitmap      => $browseBmp              ,
                            -tip         => $STR{'btnReportDirTip'} ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnOpenDir'            ,
                            -size        => [ 22, 22]               ,
                            -pos         => [588, 68]               ,
                            -bitmap      => $openDirBmp             ,
                            -tip         => $STR{'btnOpenDirTip'}   ,
                            -visible     => 0                       , );
$winConfig->AddCheckbox(    -name        => 'chReplace'             ,
                            -size        => [200, 20]               ,
                            -pos         => [150, 98]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chReplace'}       ,
                            -font        => $font10                 ,
                            -visible     => 0                       , );
$winConfig->AddCheckbox(    -name        => 'chAutoViewDir'         ,
                            -size        => [175, 20]               ,
                            -pos         => [415, 98]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chAutoViewDir'}   ,
                            -font        => $font10                 ,
                            -visible     => 0                       , );
# Storage tab - Logging Database section
$winConfig->AddLabel(       -name        => 'lblLogDbFileShadowT'   ,
                            -size        => [260, 22]               ,
                            -pos         => [151,134]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'lblLogDbFile'}.':',
                            -font        => $fontGB                 , 
                            -visible     => 0                       , );
$winConfig->AddLabel(       -name        => 'lblLogDbFileT'         ,
                            -size        => [260, 22]               ,
                            -pos         => [150,133]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [  90, 150, 255]        ,
                            -text        => $STR{'lblLogDbFile'}.':',
                            -font        => $fontGB                 ,
                            -visible     => 0                       ,  );
$winConfig->AddCheckbox(    -name        => 'chLogActivate'         ,
                            -size        => [220, 20]               ,
                            -pos         => [415,133]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chLogActivate'}   ,
                            -font        => $font10                 ,
                            -visible     => 0                       ,
                            -disabled    => 1                       , );
$winConfig->AddTextfield(   -name        => 'tfLogDbFile'           ,
                            -size        => [412, 22]               ,
                            -pos         => [150,163]               ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnLogDbFile'          ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565,163]               ,
                            -bitmap      => $fileOpenBmp            ,
                            -tip         => "$STR{'Select'} $STR{'winLogDB'} $STR{'file'}",
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnLogDbFileNew'       ,
                            -size        => [ 22, 22]               ,
                            -pos         => [588,163]               ,
                            -bitmap      => $fileNewBmp             ,
                            -tip         => $STR{'btnLogDbFileNewTip'},
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnLogDbView'          ,
                            -size        => [ 22, 22]               ,
                            -pos         => [611,163]               ,
                            -bitmap      => $database16             ,
                            -tip         => $STR{'btnLogDbViewTip'} ,
                            -visible     => 0                       , );
# Storage tab - Whois Database Section
$winConfig->AddLabel(       -name        => 'lblDbFileShadowT'      ,
                            -size        => [260, 22]               ,
                            -pos         => [151,204]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'winDB'}.':'       ,
                            -font        => $fontGB                 , 
                            -visible     => 0                       , );
$winConfig->AddLabel(       -name        => 'lblDbFileT'            ,
                            -size        => [260, 22]               ,
                            -pos         => [150,203]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [  90, 150, 255]        ,
                            -text        => $STR{'winDB'}.':'       ,
                            -font        => $fontGB                 ,
                            -visible     => 0                       ,  );
$winConfig->AddTextfield(   -name        => 'tfDbFile'              ,
                            -size        => [412, 22]               ,
                            -pos         => [150,233]               ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnDbFile'             ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565,233]               ,
                            -bitmap      => $fileOpenBmp            ,
                            -tip         => "$STR{'Select'} $STR{'winDB'} $STR{'file'}",
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnDbFileNew'          ,
                            -size        => [ 22, 22]               ,
                            -pos         => [588,233]               ,
                            -bitmap      => $fileNewBmp             ,
                            -tip         => $STR{'btnDbFileNewTip'} ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnWhoisDbView'        ,
                            -size        => [ 22, 22]               ,
                            -pos         => [611,233]               ,
                            -bitmap      => $database16             ,
                            -tip         => $STR{'btnWhoisDbViewTip'} ,
                            -visible     => 0                       , );
$winConfig->AddCheckbox(    -name        => 'chDBCache'             ,
                            -size        => [350, 20]               ,
                            -pos         => [150,263]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chDBCache'}       ,
                            -font        => $font10                 ,
                            -visible     => 0                       , );
$winConfig->AddCheckbox(    -name        => 'chRelRangeSearches'    ,
                            -size        => [350, 20]               ,
                            -pos         => [150,288]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chGetRelRangeCache'},
                            -font        => $font10                 ,
                            -visible     => 0                       , );

# Database tab - TLD Database section
$winConfig->AddLabel(       -name        => 'lblTLDDBShadowT'       ,
                            -size        => [260, 22]               ,
                            -pos         => [151, 36]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'lblTLDDB'}.':'    ,
                            -font        => $fontGB                 , 
                            -visible     => 0                       , );
$winConfig->AddLabel(       -name        => 'lblTLDDBT'             ,
                            -size        => [260, 22]               ,
                            -pos         => [150, 35]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [ 90, 150, 255]         ,
                            -text        => $STR{'lblTLDDB'}.':'    ,
                            -font        => $fontGB                 ,
                            -visible     => 0                       ,  );
$winConfig->AddCheckbox(    -name        => 'chTLDDBAutoUpt'        ,
                            -size        => [220, 20]               ,
                            -pos         => [415, 38]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chDBAutoUpt'}     ,
                            -font        => $font10                 ,
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfTLDDB'               ,
                            -size        => [412, 22]               ,
                            -pos         => [150, 68]               ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnTLDDB'              ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565, 68]               ,
                            -bitmap      => $fileOpenBmp            ,
                            -tip         => "$STR{'Select'} $STR{'lblTLDDB'} $STR{'file'}",
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnTLDDBUpt'           ,
                            -size        => [ 22, 22]               ,
                            -pos         => [588, 68]               ,
                            -bitmap      => $downloadBmp            ,
                            -tip         => "$STR{'CheckUpdateFor'} $STR{'lblTLDDB'}",
                            -visible     => 0                       , );
# Database tab - Whois Server Database section
$winConfig->AddLabel(       -name        => 'lblWSDBShadowT'        ,
                            -size        => [260, 22]               ,
                            -pos         => [151,104]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'lblWSDB'}.':'     ,
                            -font        => $fontGB                 , 
                            -visible     => 0                       , );
$winConfig->AddLabel(       -name        => 'lblWSDBT'              ,
                            -size        => [260, 22]               ,
                            -pos         => [150,103]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [ 90, 150, 255]         ,
                            -text        => $STR{'lblWSDB'}.':'     ,
                            -font        => $fontGB                 ,
                            -visible     => 0                       ,  );
$winConfig->AddCheckbox(    -name        => 'chWSDBAutoUpt'         ,
                            -size        => [220, 20]               ,
                            -pos         => [415,103]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chDBAutoUpt'}     ,
                            -font        => $font10                 ,
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfWSDB'                ,
                            -size        => [412, 22]               ,
                            -pos         => [150,133]               ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnWSDB'               ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565,133]               ,
                            -bitmap      => $fileOpenBmp            ,
                            -tip         => "$STR{'Select'} $STR{'lblWSDB'} $STR{'file'}",
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnWSDBUpt'            ,
                            -size        => [ 22, 22]               ,
                            -pos         => [588,133]               ,
                            -bitmap      => $downloadBmp            ,
                            -tip         => "$STR{'CheckUpdateFor'} $STR{'lblWSDB'}",
                            -visible     => 0                       , );
# Database tab - IPv4 Database section
$winConfig->AddLabel(       -name        => 'lblIPv4ShadowT'        ,
                            -size        => [260, 22]               ,
                            -pos         => [151,169]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'lblIPv4DB'}.':'   ,
                            -font        => $fontGB                 , 
                            -visible     => 0                       , );
$winConfig->AddLabel(       -name        => 'lblIPv4T'              ,
                            -size        => [260, 22]               ,
                            -pos         => [150,168]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [ 90, 150, 255]         ,
                            -text        => $STR{'lblIPv4DB'}.':'   ,
                            -font        => $fontGB                 ,
                            -visible     => 0                       ,  );
$winConfig->AddCheckbox(    -name        => 'chIPv4DBAutoUpt'       ,
                            -size        => [220, 20]               ,
                            -pos         => [415,168]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chDBAutoUpt'}     ,
                            -font        => $font10                 ,
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfIPv4DB'              ,
                            -size        => [412, 22]               ,
                            -pos         => [150,198]               ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnIPv4DB'             ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565,198]               ,
                            -bitmap      => $fileOpenBmp            ,
                            -tip         => "$STR{'Select'} $STR{'lblIPv4DB'} $STR{'file'}",
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnIPv4DBUpt'          ,
                            -size        => [ 22, 22]               ,
                            -pos         => [588,198]               ,
                            -bitmap      => $downloadBmp            ,
                            -tip         => "$STR{'CheckUpdateFor'} $STR{'lblIPv4DB'}",
                            -visible     => 0                       , );
# Database tab - IPv6 Database section
$winConfig->AddLabel(       -name        => 'lblIPv6ShadowT'        ,
                            -size        => [260, 22]               ,
                            -pos         => [151,234]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'lblIPv6DB'}.':'   ,
                            -font        => $fontGB                 , 
                            -visible     => 0                       , );
$winConfig->AddLabel(       -name        => 'lblIPv6T'              ,
                            -size        => [260, 22]               ,
                            -pos         => [150,233]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [ 90, 150, 255]         ,
                            -text        => $STR{'lblIPv6DB'}.':'   ,
                            -font        => $fontGB                 ,
                            -visible     => 0                       ,  );
$winConfig->AddCheckbox(    -name        => 'chIPv6DBAutoUpt'       ,
                            -size        => [220, 20]               ,
                            -pos         => [415,233]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chDBAutoUpt'}     ,
                            -font        => $font10                 ,
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfIPv6DB'              ,
                            -size        => [412, 22]               ,
                            -pos         => [150,263]               ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnIPv6DB'             ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565,263]               ,
                            -bitmap      => $fileOpenBmp            ,
                            -tip         => "$STR{'Select'} $STR{'lblIPv6DB'} $STR{'file'}",
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnIPv6DBUpt'          ,
                            -size        => [ 22, 22]               ,
                            -pos         => [588,263]               ,
                            -bitmap      => $downloadBmp            ,
                            -tip         => "$STR{'CheckUpdateFor'} $STR{'lblIPv6DB'}",
                            -visible     => 0                       , );
# Database tab - GeoIP Database section
$winConfig->AddLabel(       -name        => 'lblGeoIPDBShadowT'     ,
                            -size        => [250, 22]               ,
                            -pos         => [151,299]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'GeoIPDB'}.':'     ,
                            -font        => $fontGB                 ,
                            -visible     => 0                       , );
$winConfig->AddLabel(       -name        => 'lblGeoIPDBT'           ,
                            -size        => [250, 22]               ,
                            -pos         => [150,298]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [ 90, 150, 255]         ,
                            -text        => $STR{'GeoIPDB'}.':'     ,
                            -font        => $fontGB                 ,
                            -visible     => 0                       , );
$winConfig->AddCheckbox(    -name        => 'chGeoIPDBAutoUpt'      ,
                            -size        => [220, 20]               ,
                            -pos         => [415,298]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chDBAutoUpt'}     ,
                            -font        => $font10                 ,
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfGeoIPDB'             ,
                            -size        => [412, 22]               ,
                            -pos         => [150,328]               ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnGeoIPDB'            ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565,328]               ,
                            -bitmap      => $fileOpenBmp            ,
                            -tip         => "$STR{'Select'} $STR{'GeoIPDB'} $STR{'file'}",
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnGeoIPDBUpt'         ,
                            -size        => [ 22, 22]               ,
                            -pos         => [588,328]               ,
                            -bitmap      => $downloadBmp            ,
                            -tip         => "$STR{'CheckUpdateFor'} $STR{'GeoIPDB'}",
                            -visible     => 0                       , );

#------------------------------------------------------------------------------#
# Whois Database Window
#------------------------------------------------------------------------------#
my $winDBw = 850;
my $winDBh = 500;
my $winDB = Win32::GUI::Window->new(  -name        => 'winDB'               ,
                                      -background  => [255, 255, 255]       ,
                                      -text        => $STR{'winDB'}         ,
                                      -pos         => [$winPosX, $winPosY]  ,
                                      -size        => [$winDBw+250, $winDBh+200],
                                      -minsize     => [$winDBw, $winDBh]    ,
                                      -hasmaximize => 1                     ,
                                      -hasminimize => 1                     ,
                                      -resizable   => 1                     , );
$winDB->SetIcon($winICO);
# Functions
$winDB->AddButton(    -name        => 'btnExportDB'           ,
                      -size        => [ 40, 40]               ,
                      -pos         => [  5,  8]               ,
                      -bitmap      => $exportBmp              ,
                      -background  => [255, 255, 255]         ,
                      -tip         => "$STR{'Export'} $STR{'database'}", );
$winDB->AddButton(    -name        => 'btnImportDB'           ,
                      -size        => [ 40, 40]               ,
                      -pos         => [ 50,  8]               ,
                      -bitmap      => $importBmp              ,
                      -background  => [255, 255, 255]         ,
                      -tip         => $STR{'btnImportDBTip'}  , );
$winDB->AddButton(    -name        => 'btnExtract2DB'         ,
                      -size        => [ 40, 40]               ,
                      -pos         => [ 95,  8]               ,
                      -bitmap      => $extractBmp             ,
                      -background  => [255, 255, 255]         ,
                      -tip         => $STR{'btnExtract2DBTip'}, );
$winDB->AddButton(    -name        => 'btnValidDB'            ,
                      -size        => [ 40, 40]               ,
                      -pos         => [140,  8]               ,
                      -bitmap      => $validdbBmp             ,
                      -background  => [255, 255, 255]         ,
                      -tip         => $STR{'winAWD'}          , );
# Search
$winDB->AddLabel(     -name        => 'lblSearchDB'           ,
                      -size        => [ 60, 22]               ,
                      -pos         => [190,  8]               ,
                      -background  => [255, 255, 255]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'Search'}.':'      ,
                      -font        => $font10                 , );
$winDB->AddTextfield( -name        => 'tfSearchDB'            ,
                      -size        => [$winDBw-350, 22]       ,
                      -pos         => [255,  5]               , );
$winDB->AddButton(    -name        => 'btnSearchDB'           ,
                      -size        => [ 22, 22]               ,
                      -pos         => [$winDBw-92,  5]        ,
                      -bitmap      => $searchDB               ,
                      -tip         => "$STR{'Search'} $STR{'database'}",
                      -disabled    => 1                       , );
$winDB->AddButton(    -name        => 'btnSearchDB_p'         ,
                      -size        => [ 22, 22]               ,
                      -pos         => [$winDBw-67,  5]        ,
                      -bitmap      => $searchDB_p             ,
                      -tip         => "$STR{'Search'} $STR{'previous'}",
                      -disabled    => 1                       , );
$winDB->AddButton(    -name        => 'btnSearchDB_n'         ,
                      -size        => [ 22, 22]               ,
                      -pos         => [$winDBw-42,  5]        ,
                      -bitmap      => $searchDB_n             ,
                      -tip         => "$STR{'Search'} $STR{'next'}",
                      -disabled    => 1                       , );
# Filter
$winDB->AddLabel(     -name        => 'lblFilterDB'           ,
                      -size        => [ 60, 22]               ,
                      -pos         => [190, 33]               ,
                      -background  => [255, 255, 255]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'lblFilterDB'}.':' ,
                      -font        => $font10                 , );
$winDB->AddTextfield( -name        => 'tfFilterDB'            ,
                      -size        => [$winDBw-350, 22]       ,
                      -pos         => [255, 30]               ,
                      -readonly    => 1                       , );
$winDB->AddButton(    -name        => 'btnFilterDB'           ,
                      -size        => [ 22, 22]               ,
                      -pos         => [$winDBw-92, 30]        ,
                      -bitmap      => $filterDB               ,
                      -tip         => $STR{'btnFilterDBTip'}  , );
$winDB->AddButton(    -name        => 'btnFilterDB_del'       ,
                      -size        => [ 22, 22]               ,
                      -pos         => [$winDBw-67, 30]        ,
                      -bitmap      => $filterDB_p             ,
                      -tip         => $STR{'btnFilterDB_delTip'},
                      -disabled    => 1                       , );
$winDB->AddButton(    -name        => 'btnFilterDB_add'       ,
                      -size        => [ 22, 22]               ,
                      -pos         => [$winDBw-42, 30]        ,
                      -bitmap      => $filterDB_n             ,
                      -tip         => $STR{'btnFilterDB_addTip'},
                      -disabled    => 1                       , );
# Grid
$winDB->AddGrid(      -name         => 'DBGrid'               ,
                      -size         => [$winDBw-14, $winDBh-116],
                      -pos          => [  0, 60]              ,
                      -background   => [255, 255, 255]        ,
                      -columns      => 5                      ,
                      -fixedrows    => 1                      ,
                      -fixedcolumns => 0                      ,
                      -editable     => 0                      , );
$winDB->DBGrid->EnableRowHide();
# Status bar
$winDB->AddStatusBar(-name => 'statusBar' ,
                     -font  => $font10    ,);
# Popup menu for grid
my $GridPopupMenu = new Win32::GUI::Menu(
  'GridMenu'                    => 'GridMenu'     ,
  "> $STR{'showProperties'}"    => 'showNWData'   ,
  "> $STR{'Add'} $STR{'ISP'}"   => 'addISP'       ,
  " > -"                        => 0              ,
  "> $STR{'lblFilterDB'}"       => { name => 'filterOn', -item => 1 },
  ">> $STR{'Selected'}"           => 'filterOnSel'   ,
  ">> $STR{'NotSelected'}"        => 'filterOnNotSel',
  " > -"                        => 0              ,
  "> $STR{'Refresh'}"           => 'refreshISP'   ,
  "> $STR{'getAllRanges'}"      => 'getAllRanges' ,
  " > -"                        => 0              ,
  "> $STR{'gridSelectAll'}"     => 'gridSelectAll',
  "> $STR{'lineCopy'}"          => 'lineCopy'     ,
  " > -"                        => 0              ,
  "> $STR{'deleteLine'}"        => 'deleteLine'   ,
);
$GridPopupMenu->{'showNWData'}->Change(-default => 1);

#------------------------------------------------------------------------------#
# Add ISP Ranges Window
#------------------------------------------------------------------------------#
my $winAddRanges = Win32::GUI::Window->new( -name        => 'winAddRanges'            ,
                                            -background  => [255, 255, 255]           ,
                                            -parent      => $winDB                    ,
                                            -text        => $STR{'winAddRanges'}      ,
                                            -pos         => [$winPosX, $winPosY]      ,
                                            -size        => [$winDBw, $winDBh]        ,
                                            -minsize     => [$winDBw, $winDBh]        ,
                                            -hasmaximize => 1                         ,
                                            -hasminimize => 1                         ,
                                            -resizable   => 1                         ,
                                            -dialogui    => 1                         , );
$winAddRanges->SetIcon($winICO);
$winAddRanges->AddLabel(        -name         => 'lblTitle'               ,
                                -size         => [150, 20]                ,
                                -pos          => [  5,  5]                ,
                                -background   => [255, 255, 255]          ,
                                -foreground   => [  0, 102, 204]          ,
                                -text         => $STR{'Organisation'}     ,
                                -font         => $fontGB                  , );
# Organisation controls
$winAddRanges->AddLabel(        -name         => 'lblRangesOrgName'       ,
                                -size         => [ 50, 22]                ,
                                -pos          => [  5, 30]                ,
                                -background   => [255, 255, 255]          ,
                                -text         => $STR{'Name'}.':'         ,
                                -font         => $font10                  , );
$winAddRanges->AddLabel(        -name         => 'lblRangesOrgNameVal'    ,
                                -size         => [300, 22]                ,
                                -pos          => [ 60, 30]                ,
                                -background   => [255, 255, 255]          ,
                                -foreground   => [  0, 102, 204]          ,
                                -font         => $font10                  , );
$winAddRanges->AddLabel(        -name         => 'lblRangesSource'        ,
                                -size         => [ 50, 22]                ,
                                -pos          => [  5, 55]                ,
                                -background   => [255, 255, 255]          ,
                                -text         => $STR{'Source'}.':'       ,
                                -font         => $font10                  , );
$winAddRanges->AddLabel(        -name         => 'lblRangesSourceVal'     ,
                                -size         => [300, 22]                ,
                                -pos          => [ 60, 55]                ,
                                -background   => [255, 255, 255]          ,
                                -foreground   => [  0, 102, 204]          ,
                                -font         => $font10                  , );
$winAddRanges->AddLabel(        -name         => 'lblRangesORG'           ,
                                -size         => [ 60, 22]                ,
                                -pos          => [590, 30]                ,
                                -background   => [255, 255, 255]          ,
                                -text         => $STR{'OrgID'}.':'        ,
                                -font         => $font10                  ,
                                -visible      => 0                        , );
$winAddRanges->AddTextfield(    -name         => 'tfRangesORGVal'         ,
                                -size         => [120, 22]                ,
                                -pos          => [645, 27]                ,
                                -font         => $font10                  ,
                                -visible      => 0                        , );
$winAddRanges->AddButton(       -name         => 'btnGetRangesORG'        ,
                                -size         => [ 60, 24]                ,
                                -pos          => [770, 26]                ,
                                -text         => $STR{'Get'}.' >>'        ,
                                -font         => $font10                  ,
                                -visible      => 0                        , );
$winAddRanges->AddLabel(        -name         => 'lblRangesASN'           ,
                                -size         => [ 60, 22]                ,
                                -pos          => [590, 55]                ,
                                -background   => [255, 255, 255]          ,
                                -text         => $STR{'ASN'}.':'          ,
                                -font         => $font10                  ,
                                -visible      => 0                        , );
$winAddRanges->AddCombobox(     -name         => 'cbRangesASNVal'         ,
                                -size         => [120, 22]                ,
                                -pos          => [645, 52]                ,
                                -dropdown     => 1                        ,
                                -font         => $font10                  ,
                                -visible      => 0                        , );
$winAddRanges->AddButton(       -name         => 'btnGetRangesASN'        ,
                                -size         => [ 60, 24]                ,
                                -pos          => [770, 51]                ,
                                -text         => $STR{'Get'}.' >>'        ,
                                -font         => $font10                  ,
                                -visible      => 0                        , );
$winAddRanges->AddTabStrip(     -name         => 'tsGetRanges'            ,
                                -size         => [$winDBw-15, 330]        ,
                                -pos          => [  0, 83]                ,
                                -fixedwidth   => 1                        ,
                                -background   => [255, 255, 255]          ,
                                -font         => $font10                  , );
$winAddRanges->tsGetRanges->InsertItem(-text  => $STR{'Route'}            , );
$winAddRanges->AddTextfield(    -name         => 'tfGetRangesRoute'       ,
                                -size         => [$winDBw-25, 260]        ,
                                -pos          => [  5,110]                ,
                                -background   => [255, 255, 255]          ,
                                -font         => $font10                  ,
                                -multiline    => 1                        ,
                                -wantreturn   => 1                        ,
                                -hscroll      => 1                        ,
                                -vscroll      => 1                        ,
                                -readonly     => 1                        , );
$winAddRanges->tfGetRangesRoute->MaxLength(5000000);
$winAddRanges->AddTextfield(    -name         => 'tfGetRangesOrg'         ,
                                -size         => [$winDBw-25, 260]        ,
                                -pos          => [  5,110]                ,
                                -background   => [255, 255, 255]          ,
                                -font         => $font10                  ,
                                -multiline    => 1                        ,
                                -wantreturn   => 1                        ,
                                -hscroll      => 1                        ,
                                -vscroll      => 1                        ,
                                -readonly     => 1                        ,
                                -visible      => 0                        , );
$winAddRanges->tfGetRangesOrg->MaxLength(5000000);
$winAddRanges->AddTextfield(    -name         => 'tfGetRangesASN'         ,
                                -size         => [$winDBw-25, 260]        ,
                                -pos          => [  5,110]                ,
                                -background   => [255, 255, 255]          ,
                                -font         => $font10                  ,
                                -multiline    => 1                        ,
                                -wantreturn   => 1                        ,
                                -hscroll      => 1                        ,
                                -vscroll      => 1                        ,
                                -readonly     => 1                        ,
                                -visible      => 0                        , );
$winAddRanges->tfGetRangesASN->MaxLength(5000000);
$winAddRanges->AddTreeView(     -name         => 'tvGetRangesRoute'       ,
                                -size         => [$winDBw-25, 260]        ,
                                -pos          => [  5,110]                ,
                                -background   => [255, 255, 255]          ,
                                -font         => $font10                  ,
                                -rootlines    => 1                        ,
                                -lines        => 1                        ,
                                -buttons      => 1                        ,
                                -visible      => 0                        , );
$winAddRanges->AddTreeView(     -name         => 'tvGetRangesOrg'         ,
                                -size         => [$winDBw-25, 260]        ,
                                -pos          => [  5,110]                ,
                                -background   => [255, 255, 255]          ,
                                -font         => $font10                  ,
                                -rootlines    => 1                        ,
                                -lines        => 1                        ,
                                -buttons      => 1                        ,
                                -visible      => 0                        , );
$winAddRanges->AddTreeView(     -name         => 'tvGetRangesASN'         ,
                                -size         => [$winDBw-25, 260]        ,
                                -pos          => [  5,110]                ,
                                -background   => [255, 255, 255]          ,
                                -font         => $font10                  ,
                                -rootlines    => 1                        ,
                                -lines        => 1                        ,
                                -buttons      => 1                        ,
                                -visible      => 0                        , );
$winAddRanges->AddTextfield(    -name         => 'tfGetRangesRouteRaw'    ,
                                -size         => [$winDBw-25, 260]        ,
                                -pos          => [  5,110]                ,
                                -background   => [255, 255, 255]          ,
                                -font         => $font10                  ,
                                -multiline    => 1                        ,
                                -wantreturn   => 1                        ,
                                -hscroll      => 1                        ,
                                -vscroll      => 1                        ,
                                -readonly     => 1                        ,
                                -visible      => 0                        , );
$winAddRanges->tfGetRangesRouteRaw->MaxLength(5000000);
$winAddRanges->AddTextfield(    -name         => 'tfGetRangesOrgRaw'      ,
                                -size         => [$winDBw-25, 260]        ,
                                -pos          => [  5,110]                ,
                                -background   => [255, 255, 255]          ,
                                -font         => $font10                  ,
                                -multiline    => 1                        ,
                                -wantreturn   => 1                        ,
                                -hscroll      => 1                        ,
                                -vscroll      => 1                        ,
                                -readonly     => 1                        ,
                                -visible      => 0                        , );
$winAddRanges->tfGetRangesOrgRaw->MaxLength(5000000);
$winAddRanges->AddTextfield(    -name         => 'tfGetRangesASNRaw'      ,
                                -size         => [$winDBw-25, 260]        ,
                                -pos          => [  5,110]                ,
                                -background   => [255, 255, 255]          ,
                                -font         => $font10                  ,
                                -multiline    => 1                        ,
                                -wantreturn   => 1                        ,
                                -hscroll      => 1                        ,
                                -vscroll      => 1                        ,
                                -readonly     => 1                        ,
                                -visible      => 0                        , );
$winAddRanges->tfGetRangesASNRaw->MaxLength(5000000);
$winAddRanges->AddRadioButton(  -name         => 'rbGetRangesForm'        ,
                                -size         => [120, 22]                ,
                                -pos          => [  5,$winDBh-125]        ,
                                -background   => [255, 255, 255]          ,
                                -text         => $STR{'Formatted'}        ,
                                -font         => $font10                  ,
                                -checked      => 1                        ,
                                -group        => 1                        , );
$winAddRanges->AddRadioButton(  -name         => 'rbGetRangesTV'          ,
                                -size         => [120, 22]                ,
                                -pos          => [130,$winDBh-125]        ,
                                -background   => [255, 255, 255]          ,
                                -text         => $STR{'Treeview'}         ,
                                -font         => $font10                  , );
$winAddRanges->AddRadioButton(  -name         => 'rbGetRangesRaw'         ,
                                -size         => [120, 22]                ,
                                -pos          => [255,$winDBh-125]        ,
                                -background   => [255, 255, 255]          ,
                                -text         => $STR{'Raw'}              ,
                                -font         => $font10                  , );
# Related ranges
$winAddRanges->AddLabel(        -name         => 'lblShowRanges'          ,
                                -size         => [ 60, 22]                ,
                                -pos          => [  5, 33]                ,
                                -background   => [255, 255, 255]          ,
                                -text         => $STR{'Show'}.':'         ,
                                -font         => $font10                  ,
                                -visible      => 0                        , );
$winAddRanges->AddCombobox(     -name         => 'cbShowRanges'           ,
                                -size         => [120, 30]                ,
                                -pos          => [ 70, 30]                ,
                                -dropdownlist => 1                        ,
                                -font         => $font10                  ,
                                -visible      => 0                        , );
$winAddRanges->cbShowRanges->Add($STR{'AllRanges'}, $STR{'ParentOnly'}, $STR{'SmallerOnly'});
$winAddRanges->cbShowRanges->SetCurSel(0);
$winAddRanges->AddButton(       -name         => 'btnRemNetNames'         ,
                                -size         => [160, 26]                ,
                                -pos          => [200, 29]                ,
                                -text         => $STR{'RemNetNames'}      ,
                                -font         => $font10                  , );
$winAddRanges->AddLabel(        -name         => 'lblChoiceSel'           ,
                                -size         => [ 60, 22]                ,
                                -pos          => [400, 33]                ,
                                -background   => [255, 255, 255]          ,
                                -text         => $STR{'Select'}.':'       ,
                                -align        => 'right'                  ,
                                -font         => $font10                  ,
                                -visible      => 0                        , );
$winAddRanges->AddCombobox(     -name         => 'cbChoiceSel'            ,
                                -size         => [ 80, 30]                ,
                                -pos          => [465, 30]                ,
                                -dropdownlist => 1                        ,
                                -font         => $font10                  ,
                                -visible      => 0                        , );
$winAddRanges->cbChoiceSel->Add($STR{'First'}, $STR{'Second'}, $STR{'Last'});
$winAddRanges->cbChoiceSel->SetCurSel(0);
$winAddRanges->AddLabel(        -name         => 'lblChoiceSel2'          ,
                                -size         => [160, 22]                ,
                                -pos          => [550, 33]                ,
                                -background   => [255, 255, 255]          ,
                                -text         => $STR{'ChoiceOfEachRow'}  ,
                                -font         => $font10                  ,
                                -visible      => 0                        , );
$winAddRanges->AddGrid (        -name         => 'GridISPRanges'          ,
                                -size         => [$winDBw-15, $winDBh-115],
                                -pos          => [  5, 60]                ,
                                -background   => [255, 255, 255]          ,
                                -columns      => 5                        ,
                                -fixedrows    => 1                        ,
                                -fixedcolumns => 1                        ,
                                -visible      => 0                        ,
                                -editable     => 1                        , );
$winAddRanges->GridISPRanges->SetListMode();
$winAddRanges->GridISPRanges->EnableRowHide();
$winAddRanges->GridISPRanges->EnableColumnHide();
# Buttons
$winAddRanges->AddButton(       -name         => 'btnGetRangesPrev'       ,
                                -size         => [120, 30]                ,
                                -pos          => [  5, $winDBh-65]        ,
                                -text         => '<< ' . $STR{'Previous'} ,
                                -font         => $font10                  , );
$winAddRanges->AddButton(       -name         => 'btnAddRCancel'          ,
                                -size         => [100, 30]                ,
                                -pos          => [375,$winDBh-75]         ,
                                -text         => $STR{'Cancel'}           ,
                                -font         => $font10                  , );
$winAddRanges->AddButton(       -name         => 'btnAddRSelected'        ,
                                -size         => [210, 30]                ,
                                -pos          => [$winDBw-170,$winDBh-75] ,
                                -text         => $STR{'winAddRSelected'}.'>>',
                                -font         => $font10                  ,
                                -disabled     => 1                        ,
                                -visible      => 0                        , );

#------------------------------------------------------------------------------#
# Network whois properties Window
#------------------------------------------------------------------------------#
my $winNWP = Win32::GUI::Window->new(  -name        => 'winNWP'              ,
                                       -background  => [255, 255, 255]       ,
                                       -parent      => $winDB                ,
                                       -text        => $STR{'winNWP'}        ,
                                       -pos         => [$winPosX, $winPosY]  ,
                                       -size        => [$winDBw+150, $winDBh+150],
                                       -minsize     => [$winDBw, $winDBh]    ,
                                       -hasmaximize => 1                     ,
                                       -hasminimize => 1                     ,
                                       -resizable   => 1                     ,
                                       -dialogui    => 1                     , );
$winNWP->SetIcon($winICO);
# Fields
$winNWP->AddLabel(      -name         => 'lblNWP'                 ,
                        -size         => [100, 22]                ,
                        -pos          => [  5,  5]                ,
                        -background   => [255, 255, 255]          ,
                        -foreground   => [  0, 102, 204]          ,
                        -text         => $STR{'NWProperties'}     ,
                        -font         => $fontGB                  , );
$winNWP->AddLabel(      -name         => 'lblRangeStart'          ,
                        -size         => [ 80, 20]                ,
                        -pos          => [  5, 38]                ,
                        -background   => [255, 255, 255]          ,
                        -text         => $STR{'From'}.':'         ,
                        -font         => $font10                  , );
$winNWP->AddTextfield(  -name         => 'tfRangeStart'           ,
                        -size         => [200, 24]                ,
                        -pos          => [ 90, 35]                ,
                        -font         => $font10                  , );
$winNWP->AddLabel(      -name         => 'lblRangeEnd'            ,
                        -size         => [ 80, 20]                ,
                        -pos          => [  5, 68]                ,
                        -background   => [255, 255, 255]          ,
                        -text         => $STR{'To'}.':'           ,
                        -font         => $font10                  , );
$winNWP->AddTextfield(  -name         => 'tfRangeEnd'             ,
                        -size         => [200, 24]                ,
                        -pos          => [ 90, 65]                ,
                        -font         => $font10                  , );
$winNWP->AddLabel(      -name         => 'lblCIDR'                ,
                        -size         => [ 80, 20]                ,
                        -pos          => [  5, 98]                ,
                        -background   => [255, 255, 255]          ,
                        -text         => $STR{'CIDR'}.':'         ,
                        -font         => $font10                  , );
$winNWP->AddTextfield(  -name         => 'tfCIDR'                 ,
                        -size         => [200, 24]                ,
                        -pos          => [ 90, 95]                ,
                        -font         => $font10                  , );
$winNWP->AddLabel(      -name         => 'lblISP'                 ,
                        -size         => [ 80, 20]                ,
                        -pos          => [  5,128]                ,
                        -background   => [255, 255, 255]          ,
                        -text         => $STR{'ISP'}.':'          ,
                        -font         => $font10                  , );
$winNWP->AddTextfield(  -name         => 'tfISP'                  ,
                        -size         => [200, 24]                ,
                        -pos          => [ 90,125]                ,
                        -font         => $font10                  , );
$winNWP->AddLabel(      -name         => 'lblCountry'             ,
                        -size         => [ 80, 20]                ,
                        -pos          => [  5,158]                ,
                        -background   => [255, 255, 255]          ,
                        -text         => $STR{'Country'}.':'      ,
                        -font         => $font10                  , );
$winNWP->AddTextfield(  -name         => 'tfCountry'              ,
                        -size         => [ 32, 24]                ,
                        -pos          => [ 90,155]                ,
                        -font         => $font10                  , );
$winNWP->AddLabel(      -name         => 'lblDate'                ,
                        -size         => [ 80, 20]                ,
                        -pos          => [  5,188]                ,
                        -background   => [255, 255, 255]          ,
                        -text         => $STR{'date'}.':'         ,
                        -font         => $font10                  , );
$winNWP->AddTextfield(  -name         => 'tfDate'                 ,
                        -size         => [150, 24]                ,
                        -pos          => [ 90,185]                ,
                        -font         => $font10                  ,
                        -readonly     => 1                        , );
$winNWP->AddTextfield(  -name         => 'tfEntryLine'            , # Hidden field, to store the line number when editing a row
                        -visible      => 0                        ,
                        -pos          => [600, 65]                , );
$winNWP->AddButton(     -name         => 'btnSaveNWP'             ,
                        -size         => [ 80, 25]                ,
                        -pos          => [($winDBw-180)/2,225]    ,
                        -text         => $STR{'Save'}             ,
                        -font         => $font10                  ,
                        -disabled     => 1                        ,
                        -ok           => 1                        ,
                        -default      => 1                        , );
$winNWP->AddLabel(      -name         => 'lblNWGeoIP'             ,
                        -size         => [100, 22]                ,
                        -pos          => [380,  5]                ,
                        -background   => [255, 255, 255]          ,
                        -foreground   => [  0, 102, 204]          ,
                        -text         => $STR{'GeoIP'}            ,
                        -font         => $fontGB                  , );
$winNWP->AddTextfield(  -name         => 'tfNWGeoIP'              ,
                        -size         => [160,220]                ,
                        -pos          => [380, 35]                ,
                        -background   => [255, 255, 255]          ,
                        -font         => $font10                  ,
                        -multiline    => 1                        ,
                        -wantreturn   => 1                        ,
                        -wrap         => 1                        ,
                        -vscroll      => 1                        ,
                        -readonly     => 1                        , );
$winNWP->AddLabel(      -name         => 'lblNWD'                 ,
                        -size         => [300, 22]                ,
                        -pos          => [  5,263]                ,
                        -background   => [255, 255, 255]          ,
                        -foreground   => [  0, 102, 204]          ,
                        -text         => $STR{'NWData'}           ,
                        -font         => $fontGB                  , );
$winNWP->AddTextfield(  -name         => 'tfNWData'               ,
                        -size         => [$winDBw-25, $winDBh-185],
                        -pos          => [  5,290]                ,
                        -background   => [255, 255, 255]          ,
                        -font         => $font10                  ,
                        -multiline    => 1                        ,
                        -wantreturn   => 1                        ,
                        -hscroll      => 1                        ,
                        -vscroll      => 1                        ,
                        -readonly     => 1                        , );
$winNWP->AddButton(     -name         => 'btnGetNWData'           ,
                        -size         => [220, 25]                ,
                        -pos          => [  5, $winDBh-35]        ,
                        -text         => "$STR{'GetUpdate'} $STR{'NWData'}",
                        -font         => $font10                  , );

#------------------------------------------------------------------------------#
# Filter window
#------------------------------------------------------------------------------#
my $winFilter  = Win32::GUI::DialogBox->new(-name        => 'winFilter'               ,
                                            -parent      => $winDB                    ,
                                            -text        => $STR{'winFilter'}         ,
                                            -pos         => [$winPosX, $winPosY]      ,
                                            -size        => [260,170]                 ,
                                            -background  => [255, 255, 255]           ,
                                            -hasmaximize => 0                         ,
                                            -hasminimize => 1                         ,
                                            -helpbutton  => 0                         ,
                                            -resizable   => 0                         ,
                                            -dialogui    => 1                         , );
$winFilter->SetIcon($winICO);
# Add filter operator
$winFilter->AddLabel(     -name         => 'lblAddFilterOp'       ,
                          -size         => [120, 22]              ,
                          -pos          => [ 10,  5]              ,
                          -background   => [255, 255, 255]        ,
                          -text         => $STR{'lblAddFilterOp'} ,
                          -font         => $font10                , );
$winFilter->AddCombobox(  -name         => 'cbAddFilterOp'        ,
                          -dropdownlist => 1                      ,
                          -vscroll      => 1                      ,
                          -size         => [105, 30]              ,
                          -pos          => [135,  5]              ,
                          -disabled     => 1                      , );
# Selected field
$winFilter->AddLabel(     -name         => 'lblFilterField'       ,
                          -size         => [120, 22]              ,
                          -pos          => [ 10, 33]              ,
                          -background   => [255, 255, 255]        ,
                          -text         => $STR{'lblFilterField'}.':',
                          -font         => $font10                , );
$winFilter->AddCombobox(  -name         => 'cbFilterField'        ,
                          -dropdownlist => 1                      ,
                          -vscroll      => 1                      ,
                          -size         => [105, 80]              ,
                          -pos          => [135, 30]              , );
$winFilter->cbFilterField->Add('', $STR{'cbFilterField1'}, $STR{'cbFilterField2'},
                               $STR{'ISP'}, $STR{'Country'}, $STR{'date'});
$winFilter->cbFilterField->SetCurSel(0);
# Operator
$winFilter->AddLabel(     -name         => 'lblOperator'          ,
                          -size         => [120, 22]              ,
                          -pos          => [ 10, 58]              ,
                          -background   => [255, 255, 255]        ,
                          -text         => $STR{'lblOperator'}    ,
                          -font         => $font10                , );
$winFilter->AddCombobox(  -name         => 'cbOperator'           ,
                          -dropdownlist => 1                      ,
                          -vscroll      => 1                      ,
                          -size         => [105, 80]              ,
                          -pos          => [135, 55]              ,
                          -disabled     => 1                      , );
# Value
$winFilter->AddLabel(     -name         => 'lblFilterValue'       ,
                          -size         => [ 60, 22]              ,
                          -pos          => [ 10, 83]              ,
                          -background   => [255, 255, 255]        ,
                          -text         => $STR{'lblFilterValue'} ,
                          -font         => $font10                , );
$winFilter->AddTextfield( -name         => 'tfFilterValue'        ,
                          -size         => [155, 22]              ,
                          -pos          => [ 85, 80]              ,
                          -visible      => 0                      ,
                          -disabled     => 1                      , );
$winFilter->AddCombobox(  -name         => 'cbFilterValue'        ,
                          -dropdownlist => 1                      ,
                          -vscroll      => 1                      ,
                          -size         => [105, 80]              ,
                          -pos          => [135, 80]              ,
                          -visible      => 1                      ,
                          -disabled     => 1                      , );
# Button
$winFilter->AddButton(    -name         => 'btnApplyFilter'       ,
                          -size         => [100, 25]              ,
                          -pos          => [ 80,110]              ,
                          -text         => $STR{'btnApplyFilter'} ,
                          -font         => $font10                ,
                          -disabled     => 1                      , );

#------------------------------------------------------------------------------#
# Analysis Whois Database Window (AWD)
#------------------------------------------------------------------------------#

my $winAWD = Win32::GUI::Window->new( -name        => 'winAWD'                  ,
                                      -background  => [255, 255, 255]           ,
                                      -parent      => $winDB                    ,
                                      -text        => $STR{'winAWD'}            ,
                                      -pos         => [$winPosX, $winPosY]      ,
                                      -size        => [$winDBw, $winDBh]        ,
                                      -minsize     => [$winDBw, $winDBh]        ,
                                      -hasmaximize => 1                         ,
                                      -hasminimize => 1                         ,
                                      -resizable   => 1                         ,
                                      -dialogui    => 1                         , );
$winAWD->SetIcon($winICO);
# Matches found section
$winAWD->AddLabel(        -name         => 'lblChoice'              ,
                          -size         => [$winDBw-25, $winDBh-122],
                          -pos          => [  5,  5]                ,
                          -background   => [255, 255, 255]          ,
                          -foreground   => [  0, 102, 204]          ,
                          -text         => $STR{'lblChoice'}        ,
                          -font         => $fontGB                  , );
$winAWD->AddLabel(        -name         => 'lblISPWide'             ,
                          -size         => [$winDBw-60, 20]         ,
                          -pos          => [  5, 27]                ,
                          -background   => [255, 255, 255]          ,
                          -font         => $font10                  ,
                          -text         => $STR{'lblISPWide'}       , );
$winAWD->AddGrid (        -name         => 'GridISPWide'            ,
                          -size         => [$winDBw-15, 67]         ,
                          -pos          => [  5, 45]                ,
                          -background   => [255, 255, 255]          ,
                          -columns      => 6                        ,
                          -fixedrows    => 1                        ,
                          -fixedcolumns => 1                        ,
                          -editable     => 0                        , );
$winAWD->GridISPWide->SetListMode();
$winAWD->AddLabel(        -name         => 'lblISPin'               ,
                          -size         => [$winDBw-60, 20]         ,
                          -pos          => [  5,122]                ,
                          -background   => [255, 255, 255]          ,
                          -font         => $font10                  ,
                          -text         => $STR{'lblISPin'}         , );
$winAWD->AddGrid (        -name         => 'GridISPin'              ,
                          -size         => [$winDBw-15,195]         ,
                          -pos          => [  5,140]                ,
                          -background   => [255, 255, 255]          ,
                          -columns      => 6                        ,
                          -fixedrows    => 1                        ,
                          -fixedcolumns => 1                        ,
                          -editable     => 0                        , );
$winAWD->GridISPin->SetListMode();
$winAWD->AddLabel(        -name         => 'lblISPMsg'              ,
                          -size         => [$winDBw-60, 20]         ,
                          -pos          => [  5,345]                ,
                          -background   => [255, 255, 255]          ,
                          -font         => $font10                  ,
                          -text         => $STR{'lblISPMsg'}        , );
# Progress
$winAWD->AddLabel(        -name         => 'lblPbCurr'              ,
                          -size         => [$winDBw-140, 22]        ,
                          -pos          => [  5,370]                ,
                          -background   => [255, 255, 255]          ,
                          -foreground   => [  0, 102, 204]          ,
                          -font         => $font10                  ,
                          -truncate     => 1                        , );
$winAWD->AddProgressBar(  -name         => 'pbWinPb'                ,
                          -size         => [$winDBw-140, 22]        ,
                          -pos          => [  5,395]                ,
                          -background   => [255, 255, 255]          ,
                          -smooth       => 1                        , );
$winAWD->AddLabel(        -name         => 'lblWinPb'               ,
                          -size         => [100, 22]                ,
                          -pos          => [$winDBw-125,397]        ,
                          -background   => [255, 255, 255]          ,
                          -foreground   => [  0, 102, 204]          ,
                          -font         => $font10                  ,
                          -truncate     => 1                        , );
# Buttons
$winAWD->AddButton(       -name         => 'btnAWDCancel'           ,
                          -size         => [100, 30]                ,
                          -pos          => [$winDBw-215,$winDBh-65] ,
                          -text         => $STR{'Cancel'}           ,
                          -font         => $font10                  , );
$winAWD->AddButton(       -name         => 'btnAWDNext'             ,
                          -size         => [100, 30]                ,
                          -pos          => [$winDBw-110,$winDBh-65] ,
                          -text         => $STR{'btnAWDNext'}.' >>' ,
                          -font         => $font10                  , );

#------------------------------------------------------------------------------#
# Logging Database Window
#------------------------------------------------------------------------------#
my $winLogDB = Win32::GUI::Window->new( -name        => 'winLogDB'            ,
                                        -background  => [255, 255, 255]       ,
                                        -text        => $STR{'winLogDB'}      ,
                                        -pos         => [$winPosX, $winPosY]  ,
                                        -size        => [$winDBw, $winDBh]    ,
                                        -minsize     => [$winDBw, $winDBh-200],
                                        -hasmaximize => 1                     ,
                                        -hasminimize => 1                     ,
                                        -resizable   => 1                     , );
$winLogDB->SetIcon($winICO);
# Grid
$winLogDB->AddGrid( -name         => 'LogDBGrid'              ,
                    -size         => [$winDBw-14, $winDBh-36],
                    -pos          => [  0,  0]                ,
                    -background   => [255, 255, 255]          ,
                    -columns      => 4                        ,
                    -fixedrows    => 1                        ,
                    -fixedcolumns => 0                        , );
# Popup menu fro grid
my $LogDBGridPopupMenu = new Win32::GUI::Menu(
  'logDBGridMenu'                     => 'logDBGridMenu'      ,
  "> $STR{'openReport'}"              => 'openReport'         ,
  " > -"                              => 0                    ,
  "> $STR{'gridSelectAll'}"           => 'logDBGridSelectAll' ,
  "> $STR{'lineCopy'}"                => 'logDBlineCopy'      ,
  "> $STR{'deleteLine'}"              => 'logDBlineDelete'    ,
  " > -"                              => 0                    ,
  "> $STR{'btnImportDBTip'}"          => 'importLogDB'        ,
  "> $STR{'Export'} $STR{'database'}" => 'exportLogDB'        ,
);
$LogDBGridPopupMenu->{'openReport'}->Enabled(0);
$LogDBGridPopupMenu->{'openReport'}->Change(-default => 1);

#------------------------------------------------------------------------------#
# Simple Progress window
#------------------------------------------------------------------------------#
my $winPbW = 600;
my $winPbH = 170;
my $winPb  = Win32::GUI::DialogBox->new(-name        => 'winPb'             ,
                                        -text        => $STR{'winPb'}       ,
                                        -pos         => [$winPosX, $winPosY],
                                        -size        => [$winPbW , $winPbH] ,
                                        -background  => [255, 255, 255]     ,
                                        -hasmaximize => 0                   ,
                                        -hasminimize => 1                   ,
                                        -helpbutton  => 0                   ,
                                        -resizable   => 0                   ,
                                        -dialogui    => 1                   , );
$winPb->SetIcon($winICO);
$winPb->AddLabel(       -name        => 'lblLogo2'       ,
                        -size        => [128,128]        ,
                        -pos         => [  0,  5]        ,
                        -bitmap      => $logo128Bmp      , );
$winPb->AddLabel(       -name        => 'lblPbCurr'      ,
                        -size        => [360, 22]        ,
                        -pos         => [140, 25]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0, 102, 204]  , );
$winPb->AddProgressBar( -name        => 'pbWinPb'        ,
                        -size        => [355, 22]        ,
                        -pos         => [140, 50]        ,
                        -smooth      => 1                , );
$winPb->AddLabel(       -name        => 'lblCount'       ,
                        -size        => [100, 22]        ,
                        -pos         => [500, 52]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0, 102, 204]  , );
$winPb->AddButton(      -name        => 'btnCancel'      ,
                        -text        => $STR{'Cancel'}   ,
                        -font        => $font10          ,
                        -size        => [ 80, 30]        ,
                        -pos         => [300, 95]        ,
                        -cancel      => 1                , );

#------------------------------------------------------------------------------#
# Starting program
#------------------------------------------------------------------------------#
my $winComment;
if (-T $CONFIG_FILE) {
  &loadConfig(\%CONFIG);
  # Check update for tool and databases?
  if ($CONFIG{'TOOL_AUTO_UPDATE'}    or $CONFIG{'TLD_DB_AUTO_UPDATE'} or $CONFIG{'WS_DB_AUTO_UPDATE'} or
      $CONFIG{'IPv4_DB_AUTO_UPDATE'} or $CONFIG{'IPv6_DB_AUTO_UPDATE'} or $CONFIG{'GEOIP_DB_AUTO_UPDATE'}) {
    $THR_UPDATE = threads->create(sub { &updateAll(); });
  }
  &isWhoisReady(0);
} else { # Configuration Wizard Window
  my $refWinCW = &createCW();
  $THR_UPDATE = threads->create(sub { &firstStart($refWinCW); });
}
$trayMenu->{'regAuto'}->Checked(1);
$START = 1;
$win->Show() if !$CONFIG{'START_MINIMIZED'};
Win32::GUI::Dialog();

#--------------------------#
sub btnQuit_Click
#--------------------------#
{
  $win->Tray->Remove();
  -1; # Exit signal

}  #--- End btnQuit_Click

#--------------------------#
sub winMain_Terminate
#--------------------------#
{
  $win->Hide();
  $win->Tray->ShowBalloon() if $THR and $THR->is_running();
  return(0);

}  #--- End winMain_Terminate

#--------------------------#
sub winMain_Minimize
#--------------------------#
{
  $win->Hide();
  $win->Tray->ShowBalloon() if $THR and $THR->is_running();
  return(0);

}  #--- End winMain_Minimize

#--------------------------#
sub DWTrayMenu_Click
#--------------------------#
{
  # Save the choice
  if (!$trayMenu->{'domainWhois'}->Checked()) {
    $trayMenu->{'domainWhois'}->Checked(1);
    $CONFIG{'OPT_DOMAIN'} = 1;
    $win->chDomain->Checked(1);
    &saveConfig(\%CONFIG);
  } else {
    $trayMenu->{'domainWhois'}->Checked(0);
    $CONFIG{'OPT_DOMAIN'} = 0;
    $win->chDomain->Checked(0);
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End DWTrayMenu_Click

#--------------------------#
sub NWTrayMenu_Click
#--------------------------#
{
  # Save the choice
  if (!$trayMenu->{'networkWhois'}->Checked()) {
    $trayMenu->{'networkWhois'}->Checked(1);
    $CONFIG{'OPT_NETWORK'} = 1;
    $win->chNetwork->Checked(1);
    &saveConfig(\%CONFIG);
  } else {
    $trayMenu->{'networkWhois'}->Checked(0);
    $CONFIG{'OPT_NETWORK'} = 0;
    $win->chNetwork->Checked(0);
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End NWTrayMenu_Click

#--------------------------#
sub DRTrayMenu_Click
#--------------------------#
{
  # Save the choice
  if (!$trayMenu->{'dnsRecords'}->Checked()) {
    $trayMenu->{'dnsRecords'}->Checked(1);
    $CONFIG{'OPT_DNS'} = 1;
    $win->chDNS->Checked(1);
    &saveConfig(\%CONFIG);
  } else {
    $trayMenu->{'dnsRecords'}->Checked(0);
    $CONFIG{'OPT_DNS'} = 0;
    $win->chDNS->Checked(0);
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End DRTrayMenu_Click

#--------------------------#
sub GeoIPTrayMenu_Click
#--------------------------#
{
  # Save the choice
  if (!$trayMenu->{'geoip'}->Checked()) {
    $trayMenu->{'geoip'}->Checked(1);
    $CONFIG{'OPT_GEOIP'} = 1;
    $win->chGeoIP->Checked(1);
    &saveConfig(\%CONFIG);
  } else {
    $trayMenu->{'geoip'}->Checked(0);
    $CONFIG{'OPT_GEOIP'} = 0;
    $win->chGeoIP->Checked(0);
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End GeoIPTrayMenu_Click

#--------------------------#
sub Reg1TrayMenu_Click
#--------------------------#
{
  if (!$trayMenu->{'regAuto'}->Checked()) {
    # Check the option in menu
    $trayMenu->{'regAuto'}->Checked(1);
    $trayMenu->{'regARIN'}->Checked(0);
    $trayMenu->{'regLACNIC'}->Checked(0);
    $trayMenu->{'regRIPE'}->Checked(0);
    $trayMenu->{'regAFRINIC'}->Checked(0);
    $trayMenu->{'regAPNIC'}->Checked(0);
    # Select the option in the combobox of the main interface
    $win->cbWSSelect->SetCurSel($win->cbWSSelect->FindStringExact($STR{'WSSelect1'}));
  }

}  #--- End Reg1TrayMenu_Click

#--------------------------#
sub Reg2TrayMenu_Click
#--------------------------#
{
  if (!$trayMenu->{'regARIN'}->Checked()) {
    # Check the option in menu
    $trayMenu->{'regAuto'}->Checked(0);
    $trayMenu->{'regARIN'}->Checked(1);
    $trayMenu->{'regLACNIC'}->Checked(0);
    $trayMenu->{'regRIPE'}->Checked(0);
    $trayMenu->{'regAFRINIC'}->Checked(0);
    $trayMenu->{'regAPNIC'}->Checked(0);
    # Select the option in the combobox of the main interface
    $win->cbWSSelect->SetCurSel($win->cbWSSelect->FindStringExact('ARIN'));
  }

}  #--- End Reg2TrayMenu_Click

#--------------------------#
sub Reg3TrayMenu_Click
#--------------------------#
{
  if (!$trayMenu->{'regLACNIC'}->Checked()) {
    # Check the option in menu
    $trayMenu->{'regAuto'}->Checked(0);
    $trayMenu->{'regARIN'}->Checked(0);
    $trayMenu->{'regLACNIC'}->Checked(1);
    $trayMenu->{'regRIPE'}->Checked(0);
    $trayMenu->{'regAFRINIC'}->Checked(0);
    $trayMenu->{'regAPNIC'}->Checked(0);
    # Select the option in the combobox of the main interface
    $win->cbWSSelect->SetCurSel($win->cbWSSelect->FindStringExact('LACNIC'));
  }

}  #--- End Reg3TrayMenu_Click

#--------------------------#
sub Reg4TrayMenu_Click
#--------------------------#
{
  if (!$trayMenu->{'regRIPE'}->Checked()) {
    # Check the option in menu
    $trayMenu->{'regAuto'}->Checked(0);
    $trayMenu->{'regARIN'}->Checked(0);
    $trayMenu->{'regLACNIC'}->Checked(0);
    $trayMenu->{'regRIPE'}->Checked(1);
    $trayMenu->{'regAFRINIC'}->Checked(0);
    $trayMenu->{'regAPNIC'}->Checked(0);
    # Select the option in the combobox of the main interface
    $win->cbWSSelect->SetCurSel($win->cbWSSelect->FindStringExact('RIPE'));
  }

}  #--- End Reg4TrayMenu_Click

#--------------------------#
sub Reg5TrayMenu_Click
#--------------------------#
{
  if (!$trayMenu->{'regAFRINIC'}->Checked()) {
    # Check the option in menu
    $trayMenu->{'regAuto'}->Checked(0);
    $trayMenu->{'regARIN'}->Checked(0);
    $trayMenu->{'regLACNIC'}->Checked(0);
    $trayMenu->{'regRIPE'}->Checked(0);
    $trayMenu->{'regAFRINIC'}->Checked(1);
    $trayMenu->{'regAPNIC'}->Checked(0);
    # Select the option in the combobox of the main interface
    $win->cbWSSelect->SetCurSel($win->cbWSSelect->FindStringExact('AFRINIC'));
  }

}  #--- End Reg5TrayMenu_Click

#--------------------------#
sub Reg6TrayMenu_Click
#--------------------------#
{
  if (!$trayMenu->{'regAPNIC'}->Checked()) {
    # Check the option in menu
    $trayMenu->{'regAuto'}->Checked(0);
    $trayMenu->{'regARIN'}->Checked(0);
    $trayMenu->{'regLACNIC'}->Checked(0);
    $trayMenu->{'regRIPE'}->Checked(0);
    $trayMenu->{'regAFRINIC'}->Checked(0);
    $trayMenu->{'regAPNIC'}->Checked(1);
    # Select the option in the combobox of the main interface
    $win->cbWSSelect->SetCurSel($win->cbWSSelect->FindStringExact('APNIC'));
  }

}  #--- End Reg6TrayMenu_Click

#--------------------------#
sub chDB1TrayMenu_Click
#--------------------------#
{
  if (!$trayMenu->{'chDB1'}->Checked()) {
    # Check the option in menu
    $trayMenu->{'chDB1'}->Checked(1);
    $trayMenu->{'chDB2'}->Checked(0);
    $trayMenu->{'chDB3'}->Checked(0);
    $trayMenu->{'chDB4'}->Checked(0);
    # Select the option in the combobox of the main interface
    # Possible values: 0 = Don't check, 1 = If present, ask, 2 = If present, ignore, 3 = Check after
    my $index = $win->cbCheckWhoisDB->FindStringExact($STR{'cbCheckWhoisDB1'});
    $win->cbCheckWhoisDB->SetCurSel($index);
    $CONFIG{'CHECK_WHOIS_DB'} = $index;
    &saveConfig(\%CONFIG);
  }

}  #--- End chDB1TrayMenu_Click

#--------------------------#
sub chDB2TrayMenu_Click
#--------------------------#
{
  if (!$trayMenu->{'chDB2'}->Checked()) {
    # Check the option in menu
    $trayMenu->{'chDB1'}->Checked(0);
    $trayMenu->{'chDB2'}->Checked(1);
    $trayMenu->{'chDB3'}->Checked(0);
    $trayMenu->{'chDB4'}->Checked(0);
    # Select the option in the combobox of the main interface
    # Possible values: 0 = Don't check, 1 = If present, ask, 2 = If present, ignore, 3 = Check after
    my $index = $win->cbCheckWhoisDB->FindStringExact($STR{'cbCheckWhoisDB2'});
    $win->cbCheckWhoisDB->SetCurSel($index);
    $CONFIG{'CHECK_WHOIS_DB'} = $index;
    &saveConfig(\%CONFIG);
  }

}  #--- End chDB2TrayMenu_Click

#--------------------------#
sub chDB3TrayMenu_Click
#--------------------------#
{
  if (!$trayMenu->{'chDB3'}->Checked()) {
    # Check the option in menu
    $trayMenu->{'chDB1'}->Checked(0);
    $trayMenu->{'chDB2'}->Checked(0);
    $trayMenu->{'chDB3'}->Checked(1);
    $trayMenu->{'chDB4'}->Checked(0);
    # Select the option in the combobox of the main interface
    # Possible values: 0 = Don't check, 1 = If present, ask, 2 = If present, ignore, 3 = Check after
    my $index = $win->cbCheckWhoisDB->FindStringExact($STR{'cbCheckWhoisDB3'});
    $win->cbCheckWhoisDB->SetCurSel($index);
    $CONFIG{'CHECK_WHOIS_DB'} = $index;
    &saveConfig(\%CONFIG);
  }

}  #--- End chDB3TrayMenu_Click

#--------------------------#
sub chDB4TrayMenu_Click
#--------------------------#
{
  if (!$trayMenu->{'chDB4'}->Checked()) {
    # Check the option in menu
    $trayMenu->{'chDB1'}->Checked(0);
    $trayMenu->{'chDB2'}->Checked(0);
    $trayMenu->{'chDB3'}->Checked(0);
    $trayMenu->{'chDB4'}->Checked(1);
    # Select the option in the combobox of the main interface
    # Possible values: 0 = Don't check, 1 = If present, ask, 2 = If present, ignore, 3 = Check after
    my $index = $win->cbCheckWhoisDB->FindStringExact($STR{'cbCheckWhoisDB4'});
    $win->cbCheckWhoisDB->SetCurSel($index);
    $CONFIG{'CHECK_WHOIS_DB'} = $index;
    &saveConfig(\%CONFIG);
  }

}  #--- End chDB4TrayMenu_Click

#--------------------------#
sub chLogDBTrayMenu_Click
#--------------------------#
{
  if (!$trayMenu->{'chLogDB'}->Checked()) {
    $trayMenu->{'chLogDB'}->Checked(1);
    $win->chCheckLogging->Checked(1);
    $CONFIG{'CHECK_LOGGING_DB'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $trayMenu->{'chLogDB'}->Checked(0);
    $win->chCheckLogging->Checked(0);
    $CONFIG{'CHECK_LOGGING_DB'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chLogDBTrayMenu_Click

#--------------------------#
sub Tray_DblClick { $win->Show(1); }
#--------------------------#

#--------------------------#
sub Tray_RightClick
#--------------------------#
{
  $trayMenu->{'domainWhois'}->Checked(1)  if $win->chDomain->Checked();
  $trayMenu->{'networkWhois'}->Checked(1) if $win->chNetwork->Checked();
  $trayMenu->{'dnsRecords'}->Checked(1)   if $win->chDNS->Checked();
  $trayMenu->{'geoip'}->Checked(1)        if $win->chGeoIP->Checked();
  &isWhoisReady(0);
  if ($trayMenu->{'whois'}->Enabled()) {
    # Parse the first item of clipboard
    my $menuText;
    my %itemsIndex;
    my %itemsType;
    my $nbrItems = &extractRequestItems(\%itemsIndex, \%itemsType);
    if ($nbrItems > 0) {
      # Found the first extracted item
      foreach my $item (sort { $itemsIndex{$a} <=> $itemsIndex{$b} } keys(%itemsIndex)) {
        $menuText .= $item;
        last;
      }
      # More than one item
      $menuText .= '...' if $nbrItems > 1;
      $trayMenu->{'whois'}->Change( -text => "Whois $menuText");
    # Disable Whois function in Tray Menu
    } else {
      $trayMenu->{'whois'}->Change( -text => "Whois");
      $trayMenu->{'whois'}->Enabled(0);
      $trayMenu->{'whoisComment'}->Enabled(0);
    }    
  # Menu item disabled
  } else { $trayMenu->{'whois'}->Change( -text => "Whois"); }
  if (Win32::Clipboard::GetText() =~ /(?:OrgName|CustName|org-name|owner|descr|remarks|inetnum|NetRange|Country|inet6num|CIDR)/) {
    $trayMenu->{'extractClip'}->Enabled(1);
  } else { $trayMenu->{'extractClip'}->Enabled(0); }
  $win->TrackPopupMenu($trayMenu->{SysTray});
  return(1);

}  #--- End Tray_RightClick

#--------------------------#
sub btnItemClip_Click
#--------------------------#
{
  # Gather clipboard content
  if (my $text = Win32::Clipboard::GetText()) {
    $winClip->tfClip->Text($text);
  } else { $winClip->tfClip->Text($STR{'errNoTextData'}); }
  $winClip->Center($win);
  $winClip->DoModal();
  return(1);

}  #--- End btnItemClip_Click

#--------------------------#
sub winClip_Resize
#--------------------------#
{
  $winClip->tfClip->Resize(     $winClip->ScaleWidth()-12         , $winClip->ScaleHeight()-50);
  $winClip->btnClipOk->Move(    ($winClip->ScaleWidth()-280)/2    , $winClip->ScaleHeight()-38);
  $winClip->btnClipSave->Move(  ($winClip->ScaleWidth()-280)/2+100, $winClip->ScaleHeight()-38);
  $winClip->btnClipParse->Move( ($winClip->ScaleWidth()-280)/2+200, $winClip->ScaleHeight()-38);
  return(1);

}  #--- End winClip_Resize

#--------------------------#
sub tfClip_Change
#--------------------------#
{
  my $tfClip = $winClip->tfClip->Text();
  if ($tfClip) { $winClip->btnClipSave->Enable();  }
  else         { $winClip->btnClipSave->Disable(); }

}  #--- End tfClip_Change

#--------------------------#
sub tfClip_GotFocus { $LISTNO = 3; }
#--------------------------#

#--------------------------#
sub btnClipOk_Click { return(-1); }
#--------------------------#

#--------------------------#
sub btnClipSave_Click
#--------------------------#
{
  # Set clipboard content
  my $text = $winClip->tfClip->Text();
  Win32::Clipboard::Set($text);
  $winClip->btnClipSave->Disable();

}  #--- End btnClipSave_Click

#--------------------------#
sub btnClipParse_Click
#--------------------------#
{
  # Extract Items from Clipboard
  my %itemsIndex;
  my %itemsType;
  my $nbrItems = &extractRequestItems(\%itemsIndex, \%itemsType);
  if (!$nbrItems) {
    Win32::GUI::MessageBox($win, $STR{'errNoValidData'}, $STR{'Error'}, 0x40010);
    return(0);
  # Whois Request
  } else {
    my $parsedItems;
    foreach my $item (sort { $itemsIndex{$a} <=> $itemsIndex{$b} } keys(%itemsIndex)) { $parsedItems .= "$item\r\n"; }
    $winClip->tfClip->Text($parsedItems);
    Win32::Clipboard::Set($parsedItems);
  }
  return(1);

}  #--- End btnClipParse_Click

#--------------------------#
sub chDomain_Click
#--------------------------#
{
  # Save the choice
  if ($win->chDomain->Checked()) {
    $CONFIG{'OPT_DOMAIN'} = 1;
    $trayMenu->{'domainWhois'}->Checked(1);
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'OPT_DOMAIN'} = 0;
    $trayMenu->{'domainWhois'}->Checked(0);
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End chDomain_Click

#--------------------------#
sub chNetwork_Click
#--------------------------#
{
  # Save the choice
  if ($win->chNetwork->Checked()) {
    $CONFIG{'OPT_NETWORK'} = 1;
    $trayMenu->{'networkWhois'}->Checked(1);
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'OPT_NETWORK'} = 0;
    $trayMenu->{'networkWhois'}->Checked(0);
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End chNetwork_Click

#--------------------------#
sub chDNS_Click
#--------------------------#
{
  # Save the choice
  if ($win->chDNS->Checked()) {
    $CONFIG{'OPT_DNS'} = 1;
    $trayMenu->{'dnsRecords'}->Checked(1);
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'OPT_DNS'} = 0;
    $trayMenu->{'dnsRecords'}->Checked(0);
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End chDNS_Click

#--------------------------#
sub chGeoIP_Click
#--------------------------#
{
  # Save the choice
  if ($win->chGeoIP->Checked()) {
    $CONFIG{'OPT_GEOIP'} = 1;
    $trayMenu->{'geoip'}->Checked(1);
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'OPT_GEOIP'} = 0;
    $trayMenu->{'geoip'}->Checked(0);
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End chGeoIP_Click

#--------------------------#
sub cbWSSelect_Change
#--------------------------#
{
  # Local variables
  my $curSel = $win->cbWSSelect->GetCurSel();
  # Uncheck all options
  $trayMenu->{'regAuto'}->Checked(0);
  $trayMenu->{'regARIN'}->Checked(0);
  $trayMenu->{'regLACNIC'}->Checked(0);
  $trayMenu->{'regRIPE'}->Checked(0);
  $trayMenu->{'regAFRINIC'}->Checked(0);
  $trayMenu->{'regAPNIC'}->Checked(0);
  # Check the right option
  if    (!$curSel    ) { $trayMenu->{'regAuto'}->Checked(1);    }
  elsif ($curSel == 1) { $trayMenu->{'regARIN'}->Checked(1);    }
  elsif ($curSel == 2) { $trayMenu->{'regLACNIC'}->Checked(1);  }
  elsif ($curSel == 3) { $trayMenu->{'regRIPE'}->Checked(1);    }
  elsif ($curSel == 4) { $trayMenu->{'regAFRINIC'}->Checked(1); }
  elsif ($curSel == 5) { $trayMenu->{'regAPNIC'}->Checked(1);   }

}  #--- End cbWSSelect_Change

#--------------------------#
sub cbCheckWhoisDB_Change
#--------------------------#
{
  # Local variables
  my $curSel = $win->cbCheckWhoisDB->GetCurSel();
  # Possible values for field: 0 = Don't check, 1 = If present, ask, 2 = If present, ignore, 3 = Check after
  # Uncheck all in tray menu
  $trayMenu->{'chDB1'}->Checked(0);
  $trayMenu->{'chDB2'}->Checked(0);
  $trayMenu->{'chDB3'}->Checked(0);
  $trayMenu->{'chDB4'}->Checked(0);
  # Check the right option
  if    (!$curSel    ) { $trayMenu->{'chDB1'}->Checked(1); }
  elsif ($curSel == 1) { $trayMenu->{'chDB2'}->Checked(1); }
  elsif ($curSel == 2) { $trayMenu->{'chDB3'}->Checked(1); }
  elsif ($curSel == 3) { $trayMenu->{'chDB4'}->Checked(1); }
  $CONFIG{'CHECK_WHOIS_DB'} = $curSel;
  &saveConfig(\%CONFIG);

}  #--- End cbCheckWhoisDB_Change

#--------------------------#
sub chCheckLogging_Click
#--------------------------#
{
  # Save the choice
  if ($win->chCheckLogging->Checked()) {
    $trayMenu->{'chLogDB'}->Checked(1);
    $CONFIG{'CHECK_LOGGING_DB'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $trayMenu->{'chLogDB'}->Checked(0);
    $CONFIG{'CHECK_LOGGING_DB'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chCheckLogging_Click

#--------------------------#
sub winLogDB_Resize
#--------------------------#
{
  $winLogDB->LogDBGrid->Resize($winLogDB->ScaleWidth(), $winLogDB->ScaleHeight());
  $winLogDB->LogDBGrid->ExpandColumnsToFit(0);
  return(1);

}  #--- End winLogDB_Resize

#--------------------------#
sub loadLoggingDB
#--------------------------#
{
  # Local variables
  my $logDbFile = $winConfig->tfLogDbFile->Text();
  if (-f $logDbFile) {
    my $dsn = "DBI:SQLite:dbname=$logDbFile";
    my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
              or Win32::GUI::MessageBox($win, $STR{'errConnectingDB'}.$DBI::errstr, $STR{'Error'}, 0x40010);
    # Check if LOGGING_DB table exists
    my $sth;
    eval { $sth = $dbh->table_info(undef, undef, '%', 'TABLE'); };
    if ($@) {
      Win32::GUI::MessageBox($win, $STR{'errConnectingDB'}.$DBI::errstr, $STR{'Error'}, 0x40010);
      return(0);
    }
    # If table WHOIS_DB exists, than load data
    my $refInfo = $sth->fetchall_arrayref;
    $sth->finish();
    if ($$refInfo[0][2] eq 'LOGGING_DB') {
      my $all = $dbh->selectall_arrayref("SELECT * FROM LOGGING_DB ORDER BY date DESC");
      # Database: table = LOGGING_DB, Fields = date, request, details, comment
      # Feed the grid
      my $i = 0;
      $winLogDB->LogDBGrid->SetRows(scalar(@$all)+1);
      $winLogDB->LogDBGrid->SetCellText($i, 0, $STR{'date'}    );
      $winLogDB->LogDBGrid->SetCellText($i, 1, $STR{'request'} );
      $winLogDB->LogDBGrid->SetCellText($i, 2, $STR{'details'} );
      $winLogDB->LogDBGrid->SetCellText($i, 3, $STR{'comment'} );
      $i++;
      foreach my $row (@$all) {
        my (@values) = @$row;
        $winLogDB->LogDBGrid->SetCellText($i, 0, $values[0]);
        $winLogDB->LogDBGrid->SetCellText($i, 1, $values[1]);
        $winLogDB->LogDBGrid->SetCellText($i, 2, $values[2]) if $values[2] ne 'NULL';
        $winLogDB->LogDBGrid->SetCellText($i, 3, $values[3]) if $values[3] ne 'NULL';
        $winLogDB->LogDBGrid->SetCellEditable($i, 0, 0);
        $winLogDB->LogDBGrid->SetCellEditable($i, 1, 0);
        $winLogDB->LogDBGrid->SetCellEditable($i, 2, 0);
        $winLogDB->LogDBGrid->SetCellEditable($i, 3, 1);
        # If Report exist, set background color to green
        if (my $reportDir = $winConfig->tfReportDir->Text()) {
          $values[1] =~ s/\:/_/g;;
          my $reportFile = "$reportDir\\$values[1]\.html";
          if (-T $reportFile) {
            $winLogDB->LogDBGrid->SetCellBkColor($i, 0, 0x33FF66);
            $winLogDB->LogDBGrid->SetCellBkColor($i, 1, 0x33FF66);
            $winLogDB->LogDBGrid->SetCellBkColor($i, 2, 0x33FF66);
            $winLogDB->LogDBGrid->SetCellBkColor($i, 3, 0x33FF66);
          }
        }
        $i++;
      }
      # Refresh grid
      $winLogDB->LogDBGrid->ExpandColumnsToFit(0);
      $winLogDB->LogDBGrid->ScrollPos(1,0);
      $winLogDB->LogDBGrid->SetListMode();
    } else {
      Win32::GUI::MessageBox($win, $STR{'errTableLoggingDB'}, $STR{'Error'}, 0x40010);
      $dbh->disconnect();
      return(0);
    }
    $dbh->disconnect();
    return(1);
  } else { return(0); } # No valid Logging DB file

}  #--- End loadLoggingDB

#--------------------------#
sub addToLogDBGrid
#--------------------------#
{
  # Local variables
  my ($dateStrGMT, $item, $lookup, $comment) = @_;
  # Add entry in grid
  if (my $newLine = $winLogDB->LogDBGrid->InsertRow($item, 1)) {
    $winLogDB->LogDBGrid->SetCellText($newLine, 0, $dateStrGMT);
    $winLogDB->LogDBGrid->SetCellText($newLine, 1, $item);
    $winLogDB->LogDBGrid->SetCellText($newLine, 2, $lookup)   if $lookup ne 'NULL';
    $winLogDB->LogDBGrid->SetCellText($newLine, 3, $comment)  if $comment ne 'NULL';
    $winLogDB->LogDBGrid->SetCellEditable($newLine, 0, 0);
    $winLogDB->LogDBGrid->SetCellEditable($newLine, 1, 0);
    $winLogDB->LogDBGrid->SetCellEditable($newLine, 2, 0);
    $winLogDB->LogDBGrid->SetCellEditable($newLine, 3, 1);
    # Refresh grid
    $winLogDB->LogDBGrid->ExpandColumnsToFit(0);
    $winLogDB->LogDBGrid->Refresh();
  } else { Win32::GUI::MessageBox($win, $STR{'errCreating'}.$STR{'newLineGrid'}, $STR{'Error'}, 0x40010); }
  
}  #--- End addToLogDBGrid

#--------------------------#
sub modLogDBGrid
#--------------------------#
{
  # Local variables
  my $item      = shift;
  my $name      = $item;
  $name         =~ s/\:/_/g;
  my $reportDir = $winConfig->tfReportDir->Text();
  my $reportFile = "$reportDir\\$name\.html" if $reportDir;
  if (-T $reportFile) {
    # Find the item in grid and set background to green
    for (my $i = 1; $i < $winLogDB->LogDBGrid->GetRows(); $i++) {
      if ($item eq $winLogDB->LogDBGrid->GetCellText($i, 1)) {
        $winLogDB->LogDBGrid->SetCellBkColor($i, 0, 0x33FF66);
        $winLogDB->LogDBGrid->SetCellBkColor($i, 1, 0x33FF66);
        $winLogDB->LogDBGrid->SetCellBkColor($i, 2, 0x33FF66);
        $winLogDB->LogDBGrid->SetCellBkColor($i, 3, 0x33FF66);
        last;
      }
    }
  }
  
}  #--- End modLogDBGrid

#--------------------------#
sub LogDBGrid_Click
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  $LISTNO = 2;
  if (!$row) {
    $winLogDB->LogDBGrid->SetHeaderSort();
    my $order = $winLogDB->LogDBGrid->GetSortAscending();
    $winLogDB->LogDBGrid->SortCells($column, $order, \&sortLC) if $column > 1;
    $winLogDB->LogDBGrid->Refresh();
  }
  return(1);

}  #--- End LogDBGrid_Click

#--------------------------#
sub LogDBGrid_RClick
#--------------------------#
{
  # Show popup menu
  my ($row, $column) = @_;
  my(@coord) = $winLogDB->LogDBGrid->GetSelectedCellRange();
  if (($coord[0] and ($row < $coord[0])) or
      ($coord[2] and ($row > $coord[2])) or
      !$coord[0]) {
    $winLogDB->LogDBGrid->SetSelectedCellRange($row, 0, $row, 4);
  }
  my $bgColor = $winLogDB->LogDBGrid->GetCellBkColor($row, $column); # 3407718 = green, -16777216 = white
  if ($bgColor > 0) { $LogDBGridPopupMenu->{'openReport'}->Enabled(1); }
  else              { $LogDBGridPopupMenu->{'openReport'}->Enabled(0); }
  my ($X, $Y) = Win32::GUI::GetCursorPos();
  $winLogDB->TrackPopupMenu($LogDBGridPopupMenu->{logDBGridMenu},$X, $Y);
  return(1);

}  #--- End LogDBGrid_RClick

#--------------------------#
sub LogDBGrid_DblClick
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  if ($row) {
    if (my $item = $winLogDB->LogDBGrid->GetCellText($row, 1)) {
      $item =~ s/\:/_/g if $item; # Replace not allowed characters for windows filename (IPv6)
      # If Report exist, open it
      if (my $reportDir = $winConfig->tfReportDir->Text()) {
        my $reportFile = "$reportDir\\$item\.html";
        if (-T $reportFile) {
          $win->ShellExecute('open', $reportFile,'','',1)
            or Win32::GUI::MessageBox($win, $STR{'errViewingReport'}.Win32::GetLastError(), $STR{'Error'}, 0x40010);
        }
      }
    }
  }
  return(1);

}  #--- End LogDBGrid_DblClick

#--------------------------#
sub openReport_Click
#--------------------------#
{
  # Get first selected row
  &LogDBGrid_DblClick(($winLogDB->LogDBGrid->GetSelectedCellRange())[0], 0);
  return(1);

}  #--- End openReport_Click

#--------------------------#
sub logDBGridSelectAll_Click
#--------------------------#
{
  $winLogDB->LogDBGrid->OnEditSelectAll();
  return(1);

}  #--- End logDBGridSelectAll_Click

#--------------------------#
sub logDBlineCopy_Click
#--------------------------#
{
  my (@coord) = $winLogDB->LogDBGrid->GetSelectedCellRange();
  my $content;
  # Selected entries
  my $lastSelectedRow; 
  if ($coord[2]) { $lastSelectedRow = $coord[2]; }
  else           { $lastSelectedRow = $coord[0]; }
  # Header is always inserted
  for (my $col = 0; $col <= $winLogDB->LogDBGrid->GetColumns(); $col++) {
    $content .= $winLogDB->LogDBGrid->GetCellText(0, $col) . "\t";
  }
  chop($content);
  $content .= "\r\n";
  for (my $row = $coord[0]; $row <= $lastSelectedRow; $row++) {
    if ($winLogDB->LogDBGrid->IsCellSelected($row, 1)) {
      for (my $col = 0; $col <= $winLogDB->LogDBGrid->GetColumns(); $col++) {
        $content .= $winLogDB->LogDBGrid->GetCellText($row, $col) . "\t";
      }
      chop($content);
      $content .= "\r\n";
    }
  }
  Win32::Clipboard::Set($content) if $content;
  return(1);

}  #--- End logDBlineCopy_Click

#--------------------------#
sub logDBlineDelete_Click
#--------------------------#
{
  # Local variables
  my(@coord)      = $winLogDB->LogDBGrid->GetSelectedCellRange();
  my $nbrEntries  = $winLogDB->LogDBGrid->GetRows();
  my $logDbFile   = $winConfig->tfLogDbFile->Text();
  my @Entries2del;
  # Select data to delete
  my $lastSelectedRow; 
  if ($coord[2]) { $lastSelectedRow = $coord[2]; }
  else           { $lastSelectedRow = $coord[0]; }
  for (my $row = $coord[0]; $row <= $lastSelectedRow; $row++) {
    if ($winLogDB->LogDBGrid->IsCellSelected ($row, 0)) {
      my $dateEntry = $winLogDB->LogDBGrid->GetCellText($row, 0);
      push(@Entries2del, $dateEntry);
    }
  }
  $THR = threads->create(sub {
    # Thread 'cancellation' signal handler
    $SIG{'KILL'} = sub {
      $winLogDB->LogDBGrid->Refresh();
      &winPb_Terminate;
      $winLogDB->ChangeCursor($ARROW);
      threads->exit();
    };
    # Thread 'die' signal handler
    $SIG{__DIE__} = sub {
      $winLogDB->LogDBGrid->Refresh();
      &winPb_Terminate;
      $winLogDB->ChangeCursor($ARROW);
    };
    # Show progress window
    my $nbrEntries2del = @Entries2del;
    $winPb->lblPbCurr->Text($STR{'deletingEntries'});
    $winPb->lblCount->Text("0 / $nbrEntries2del");
    $winPb->pbWinPb->SetRange(0, $nbrEntries2del);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    $winPb->Center($winLogDB);
    $winPb->Show();
    $winLogDB->Disable();
    $winLogDB->ChangeCursor($HOURGLASS);
    # Connect to DB
    my $dsn = "DBI:SQLite:dbname=$logDbFile";
    my $dbh = DBI->connect($dsn, undef, undef, { AutoCommit => 1 })
              or Win32::GUI::MessageBox($win, $STR{'errCreating'}.' '.$STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010);
    # Loop each entry and delete
    my $j = 0;
    foreach my $dateEntry2del (@Entries2del) {
      for (my $i = 0; $i < $nbrEntries; $i++) {
        my $dateEntry = $winLogDB->LogDBGrid->GetCellText($i, 0);
        # Entry have been found
        if ($dateEntry eq $dateEntry2del) {
          # Delete entry in DB
          # Database: table = LOGGING_DB, Fields = date, request, details, comment
          my $sth = $dbh->prepare("DELETE from LOGGING_DB where date == ?");
          my $rv = $sth->execute($dateEntry);
          if ($rv < 0) { Win32::GUI::MessageBox($winLogDB, $STR{'Error'}.' '.STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010); }
          else { 
            # Find the entry in grid and delete
            for (my $k = $i; $k < $winLogDB->LogDBGrid->GetRows(); $k++) {
              my $currEntryDate = $winLogDB->LogDBGrid->GetCellText($k, 0);
              if ($dateEntry eq $currEntryDate) {
                $winLogDB->LogDBGrid->DeleteRow($k);
                last;
              }
            }
          }
          last;
        }
      }
      $j++;
      $winPb->lblCount->Text("$j / $nbrEntries2del");
      $winPb->pbWinPb->StepIt();
    }
    $winLogDB->LogDBGrid->Refresh();
    $winLogDB->ChangeCursor($ARROW);
    &winPb_Terminate;
    $dbh->disconnect();
  });
  return(1);
  
}  #--- End logDBlineDelete_Click

#--------------------------#
sub LogDBGrid_EndEdit
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  my $logDbFile      = $winConfig->tfLogDbFile->Text();
  my $date           = $winLogDB->LogDBGrid->GetCellText($row, 0);
  my $comment        = $winLogDB->LogDBGrid->GetCellText($row, 3);
  $comment           = 'NULL' if !$comment;
  # Add or modify comment in Logging Database
  if (-f $logDbFile) {
    # Connect to DB
    my $dsn = "DBI:SQLite:dbname=$logDbFile";
    my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
              or Win32::GUI::MessageBox($win, $STR{'errCreating'}.' '.$STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010);
    # Database: table = LOGGING_DB, Fields = date, request, details, comment
    my $sth = $dbh->prepare("UPDATE LOGGING_DB SET comment = ? WHERE ? == date");
    my $rv  = $sth->execute($comment, $date);
    if ($rv < 0) {
      Win32::GUI::MessageBox($win, $STR{'errUpdatingDB'}.$DBI::errstr, $STR{'Error'}, 0x40010);
      $dbh->disconnect();
      return(0);
    }
    $dbh->disconnect();
  }
  return(1);

}  #--- End LogDBGrid_EndEdit

#--------------------------#
sub importLogDB_Click
#--------------------------#
{
  # Local variables
  my $logFile = Win32::GUI::GetOpenFileName(-owner            => $winLogDB            ,
                                            -title            => $STR{'selectLogFile'},
                                            -defaultfilter    => 0                    ,
                                            -directory        => $USERDIR             ,
                                            -file             => 'Logging_db.txt'     ,
                                            -defaultextension => 'txt'                ,
                                            -explorer         => 1                    , );
  # Selected file
  if ($logFile) {
    if (-T $logFile) {
      # Validate content
      open(FILE, $logFile) or Win32::GUI::MessageBox($win, $STR{'errReading'}.$!, $STR{'Error'}, 0x40010);
      my @logging = <FILE>;
      close(FILE);
      shift(@logging); # Remove headers
      my $nbrEntries = @logging;
      if ($nbrEntries > 1 and $logging[0]) { # At least one entry
        my @fields = split(/\t/, $logging[0]);
        # 4 fields and first one is a date
        if ($fields[0] and $fields[1] and $fields[2] and $fields[3] and $fields[0] =~ /\d{4}\-\d{2}\-\d{2} \d{2}\:\d{2}\:\d{2}/) {
          # Import
          $THR = threads->create(sub { &importLoggingDB(\@logging, $nbrEntries); });
        } else { Win32::GUI::MessageBox($winLogDB, $STR{'errNoValidFile'}, $STR{'Error'}, 0x40010); }
      } else { Win32::GUI::MessageBox($winLogDB, $STR{'errFileEmpty'}, $STR{'Error'}, 0x40010); }
    } else { Win32::GUI::MessageBox($winLogDB, $STR{'selectValidFile'}, $STR{'Error'}, 0x40010); }
  }
  return(1);

}  #--- End importLogDB_Click

#--------------------------#
sub importLoggingDB
#--------------------------#
{
  # Local variables
  my ($refLogging, $nbrEntries) = @_;
  my $dbLogFile = $winConfig->tfLogDbFile->Text();
  # Cancel button
  $SIG{'KILL'} = sub {
    # Sort grid
    $winLogDB->LogDBGrid->SortCells(0, 0, \&sortLC);
    $winLogDB->LogDBGrid->Refresh();
    # Turn off progress bar
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    &winPb_Terminate;
    $winLogDB->ChangeCursor($ARROW);
    threads->exit();
  };
  # Turn on progress bar
  $winPb->Center($winDB);
  $winPb->Show();
  $winPb->lblPbCurr->Text('');
  $winPb->lblCount->Text('');
  $winLogDB->Disable();
  $winLogDB->ChangeCursor($HOURGLASS);
  # Update DB
  # Database: table = LOGGING_DB, Fields = date, request, details, comment
  $winPb->lblPbCurr->Text($STR{'ImportingData'});
  my $dsn = "DBI:SQLite:dbname=$dbLogFile";
  my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
              or Win32::GUI::MessageBox($win, $STR{'errConnectingDB'}.$DBI::errstr, $STR{'Error'}, 0x40010);
  foreach my $entry (@{$refLogging}) {
    chomp($entry);
    my @fields = split(/\t/, $entry);
    # Add to Logging Database
    &logRequest($fields[1], \$dbh, $fields[2], $fields[0], $fields[3]);
    # Verify if entry already exists in Logging Grid
    my $entryExists = 0;
    for (my $i = 1; $i < $winLogDB->LogDBGrid->GetRows(); $i++) {
      my $date = $winLogDB->LogDBGrid->GetCellText($i, 0);
      $entryExists = 1 if $fields[0] eq $date;
    }
    # Add to Logging Grid
    if (!$entryExists) {
      if (my $newLine = $winLogDB->LogDBGrid->InsertRow($fields[0], -1)) {
        $winLogDB->LogDBGrid->SetCellText($newLine, 0, $fields[0]);
        $winLogDB->LogDBGrid->SetCellText($newLine, 1, $fields[1]);
        $winLogDB->LogDBGrid->SetCellText($newLine, 2, $fields[2]) if $fields[2] ne 'NULL';
        $winLogDB->LogDBGrid->SetCellText($newLine, 3, $fields[3]) if $fields[3] ne 'NULL';
        $winLogDB->LogDBGrid->SetCellEditable($newLine, 0, 0);
        $winLogDB->LogDBGrid->SetCellEditable($newLine, 1, 0);
        $winLogDB->LogDBGrid->SetCellEditable($newLine, 2, 0);
        $winLogDB->LogDBGrid->SetCellEditable($newLine, 3, 1);
      } else { Win32::GUI::MessageBox($win, $STR{'errCreating'}.$STR{'newLineGrid'}, $STR{'Error'}, 0x40010); }
    }
  }
  # Refresh grid
  $winLogDB->LogDBGrid->ExpandColumnsToFit(0);
  $winLogDB->LogDBGrid->ScrollPos(1,0);
  $winLogDB->LogDBGrid->SortCells(0, 0, \&sortLC);
  $winLogDB->LogDBGrid->Refresh();
  # Turn off progress bar
  $winPb->lblPbCurr->Text('');
  $winPb->lblCount->Text('');
  $winPb->pbWinPb->SetPos(0);
  &winPb_Terminate;
  $winLogDB->ChangeCursor($ARROW);
  
}  #--- End importLoggingDB

#--------------------------#
sub exportLogDB_Click
#--------------------------#
{
  # Local variables
  my $logDbFile = $winConfig->tfLogDbFile->Text();
  # Show SaveFileWindow
  my $file = Win32::GUI::GetSaveFileName( -owner            => $winLogDB        ,
                                          -title            => "$STR{'Select'} $STR{'file'}:",
                                          -file             => 'Logging_db.txt' ,
                                          -defaultextension => 'txt'            ,
                                          -createprompt     => 1                ,
                                          -explorer         => 1                , );
  if ($file) {
    $THR = threads->create(sub {
      # Thread 'cancellation' signal handler
      $SIG{'KILL'} = sub {
        &winPb_Terminate;
        $winLogDB->ChangeCursor($ARROW);
        threads->exit();
      };
      # Connect to DB
      my $dsn = "DBI:SQLite:dbname=$logDbFile";
      my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
                or Win32::GUI::MessageBox($win, $STR{'errCreating'}.' '.$STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010);
      # Database: table = LOGGING_DB, Fields = date, request, details, comment
      my $all = $dbh->selectall_arrayref("SELECT * FROM LOGGING_DB ORDER BY date ASC");
      my $nbrEntries = scalar(@$all);
      $winLogDB->ChangeCursor($HOURGLASS);
      # Show progress window
      $winPb->lblPbCurr->Text("$STR{'Exporting'} $STR{'winLogDB'}...");
      $winPb->lblCount->Text("0 / $nbrEntries");
      $winPb->pbWinPb->SetRange(0, $nbrEntries);
      $winPb->pbWinPb->SetPos(0);
      $winPb->pbWinPb->SetStep(1);
      $winPb->Center($winLogDB);
      $winPb->Show();
      $winLogDB->Disable();
      $winLogDB->ChangeCursor($HOURGLASS);
      # Export DB
      &exportLoggingDB($file, $all, $nbrEntries);
      $dbh->disconnect();
      # Message
      $winLogDB->ChangeCursor($ARROW);
      &winPb_Terminate;
      Win32::GUI::MessageBox($winLogDB, $STR{'exportSuccess'}, "XL-Whois $VERSION", 0x40040);
      $winLogDB->BringWindowToTop();
    });
  }
  return(1);

}  #--- End exportLogDB_Click

#--------------------------#
sub exportLoggingDB
#--------------------------#
{
  # Local variables
  my ($file, $refData, $nbrEntries) = @_;
  my $i = 0;
  # Open and write data to file
  open my $db_export, '>', $file or Win32::GUI::MessageBox($win, $STR{'errWriting'}.' '.$STR{'file'}.': '.$!, $STR{'Error'}, 0x40010);
  print $db_export "$STR{'date'}\t$STR{'request'}\t$STR{'details'}\t$STR{'comment'}\n";
  foreach my $row (@$refData) {
    my (@fields) = @$row;
    print $db_export "$fields[0]\t$fields[1]\t$fields[2]\t$fields[3]\n";
    $i++;
    # Display progress and refresh
    $winPb->lblCount->Text("$i / $nbrEntries");
    $winPb->pbWinPb->StepIt();
  }
  close($db_export);
  
}  #--- End exportLoggingDB

#--------------------------#
sub winLogDB_Terminate
#--------------------------#
{
  $winLogDB->Hide();
  return(0);

}  #--- End winLogDB_Terminate

#--------------------------#
sub lblNotReady_Click { &isWhoisReady(1); }
#--------------------------#

#--------------------------#
sub isWhoisReady
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  my $nextStep;
  # Parser
  $nextStep = $STR{'readyParserOpt'} if !$winConfig->chIPv4->Checked() and !$winConfig->chIPv6->Checked() and
                                        !$winConfig->chHostname->Checked() and !$winConfig->chDomainName->Checked();
  # Options
  $nextStep = $STR{'readySelWhoisOpt'} if !$win->chDomain->Checked() and !$win->chNetwork->Checked() and !$win->chDNS->Checked();
  # Folder for report
  my $saveDir = $winConfig->tfReportDir->Text();
  $nextStep = $STR{'btnReportDirTip'} if !$saveDir or !-d $saveDir;
  # Whois Database location
  $nextStep = $STR{'readySelWhoisDB'} if !$CONFIG{'WHOIS_DB_FILE'} or !-f $CONFIG{'WHOIS_DB_FILE'};
  # Logging Database location (optional)
  $nextStep = $STR{'readySelLoggingDB'} if ($CONFIG{'CHECK_LOGGING_DB'} or $winConfig->chLogActivate->Checked()) and
                                           (!$CONFIG{'LOGGING_DB_FILE'} or !-f $CONFIG{'LOGGING_DB_FILE'});
  # TLD Database location
  $nextStep = $STR{'readySelTLDDB'} if !$CONFIG{'TLD_DB_FILE'} or !-f $CONFIG{'TLD_DB_FILE'};
  # Whois Server Database location
  $nextStep = $STR{'readySelWSDB'}  if !$CONFIG{'WS_DB_FILE'} or !-f $CONFIG{'WS_DB_FILE'};
  # Return an error message or enable the button
  if ($nextStep) {
    $win->btnWhois->Disable();
    $trayMenu->{'whois'}->Enabled(0);
    $trayMenu->{'whoisComment'}->Enabled(0);
    $win->lblNotReady->Show();
    Win32::GUI::MessageBox($win, "$STR{'notReady'}?\n\n$STR{'nextStep'}: $nextStep", $STR{'notReady'}, 0x40040) if $confirm;
  } else {
    $win->btnWhois->Enable();
    $trayMenu->{'whois'}->Enabled(1);
    $trayMenu->{'whoisComment'}->Enabled(1);
    $win->lblNotReady->Hide();
  }

}  #--- End isWhoisReady

#--------------------------#
sub extractRequestItems
#--------------------------#
{
  # Local variables
  my ($refItemsIndex, $refItemsType)  = @_;
  # $refItemsIndex: hash contains item original position in list
  # $refItemsType:  hash contains item value type: IPv4, Hostname, Domain, IPv6
  my $nbrItems = 0;
  my @content  = split(/\r\n/, Win32::Clipboard::GetText());
  # Load TLD Database
  if (!$TLDDB) {
    $TLDDB = Domain::PublicSuffix->new({ 'data_file' => $CONFIG{'TLD_DB_FILE'} }) or
    Win32::GUI::MessageBox($win, $STR{'errLoadingDB'}, $STR{'Error'},0x40010);
  }
  # List items
  foreach my $item (@content) {
    while ($item =~ /(?:[^0-9]|^)(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(?:[^0-9\.]|$)/ or
           $item =~ /(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.){2,}[a-zA-Z]{2,}(?:[^a-zA-Z]|$)/ or
           $item =~ /(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}(?:[^\w\.\-]|$)/ or
           $item =~ /$IPv6_re/) {
      my $el;
      my $ipv4Found     = 0;
      my $hostnameFound = 0;
      my $domainFound   = 0;
      my $ipv6Found     = 0;
      # IPv4
      if ($item =~ /(?:[^0-9]|^)((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))(?:[^0-9\.]|$)/ and
          $winConfig->chIPv4->Checked()) {
        $nbrItems++;
        $el = $1;
        $$refItemsIndex{$el} = $nbrItems;
        $$refItemsType{$el} = 'IPv4';
        $item =~ s/$el//;
        $ipv4Found = 1;
      }
      # Hostname
      if ($item =~ /((?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.){2,}[a-zA-Z]{2,})(?:[^a-zA-Z]|$)/ and $winConfig->chHostname->Checked()) {
        $el         = $1;
        my $testObj = $el;
        # Domain must be valid
        if ($el and my $ext = $TLDDB->get_root_domain(lc($el))) {
          $testObj =~ s/$ext//i;
          if ($testObj) {
            $nbrItems++;
            $$refItemsIndex{$el} = $nbrItems;
            $$refItemsType{$el} = 'Hostname';
            $item =~ s/$el//;
            $hostnameFound = 1;
          }
        }
      }
      # Domain name
      if ($item =~ /((?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z]{2,})(?:[^\w\.\-]|$)/ and $winConfig->chDomainName->Checked()) {
        $el = $1;
        # Domain must be valid
        if ($el and my $dom = $TLDDB->get_root_domain(lc($el))) {
          $nbrItems++;
          $$refItemsIndex{$el} = $nbrItems;
          $$refItemsType{$el} = 'Domain';
          $item =~ s/$el//;
          $domainFound = 1;
        }
      }
      # IPv6
      if ($item =~ /($IPv6_re)/ and $winConfig->chIPv6->Checked()) {
        $el = $1;
        if ($el =~ /^$IPv6_re$/) {
          $nbrItems++;
          $$refItemsIndex{$el} = $nbrItems;
          $$refItemsType{$el} = 'IPv6';
          $item =~ s/$el//;
          $ipv6Found = 0;
        }
      }
      # Nothing found
      last if !$ipv4Found and !$hostnameFound and !$domainFound and !$ipv6Found;
    }
  }
  return($nbrItems);
  
}  #--- End extractRequestItems

#--------------------------#
sub btnWinDatabase_Click { &btnWhoisDbView_Click; }
#--------------------------#

#--------------------------#
sub winDB_Resize
#--------------------------#
{
  $winDB->tfSearchDB->Resize(       $winDB->ScaleWidth()-335   , 22);
  $winDB->btnSearchDB->Move(        $winDB->ScaleWidth()-77    , 5);
  $winDB->btnSearchDB_p->Move(      $winDB->ScaleWidth()-52    , 5);
  $winDB->btnSearchDB_n->Move(      $winDB->ScaleWidth()-27    , 5);
  $winDB->tfFilterDB->Resize(       $winDB->ScaleWidth()-335   , 22);
  $winDB->btnFilterDB->Move(        $winDB->ScaleWidth()-77    , 30);
  $winDB->btnFilterDB_del->Move(    $winDB->ScaleWidth()-52    , 30);
  $winDB->btnFilterDB_add->Move(    $winDB->ScaleWidth()-27    , 30);
  $winDB->DBGrid->Resize(           $winDB->ScaleWidth()       , $winDB->ScaleHeight()-80);
  $winDB->statusBar->Move(          0                          , $winDB->ScaleHeight()-120);
  $winDB->statusBar->Resize(        $winDB->ScaleWidth()       , 40);
  $winDB->statusBar->Move(          0                          , $winDB->ScaleHeight() - $winDB->statusBar->Height);
  $winDB->statusBar->Resize(        $winDB->ScaleWidth()       , $winDB->statusBar->Height);
  $winDB->DBGrid->AutoSizeColumns();
  $winDB->DBGrid->ExpandColumnsToFit(0);
  return(1);

}  #--- End winDB_Resize

#--------------------------#
sub loadWhoisDB
#--------------------------#
{
  # Local variables
  my $whoisDB = $winConfig->tfDbFile->Text();
  if (-f $whoisDB) {
    my $nbrISP = 0;
    my $i      = 0;
    # Connect to DB
    my $dsn = "DBI:SQLite:dbname=$whoisDB";
    my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 }) or Win32::GUI::MessageBox($win, $STR{'errConnectingDB'}.$DBI::errstr, $STR{'Error'}, 0x40010);
    # Check if WHOIS_DB table exists
    my $sth;
    eval { $sth = $dbh->table_info(undef, undef, '%', 'TABLE'); };
    if ($@) {
      Win32::GUI::MessageBox($win, $STR{'errConnectingDB'}.$DBI::errstr, $STR{'Error'}, 0x40010);
      return(0);
    }
    # If table WHOIS_DB exists, than load data
    my $refInfo = $sth->fetchall_arrayref;
    $sth->finish();
    if ($$refInfo[0][2] eq 'WHOIS_DB') {
      my $all = $dbh->selectall_arrayref("SELECT * FROM WHOIS_DB ORDER BY range_s ASC");
      # Fields: 0 = ip start, 1 = ip end, 2 = ISP name, 3 = country, 4 = date
      $nbrISP = scalar(@$all);
      $winDB->statusBar->Text(" $STR{'numberISP'}: ".$nbrISP);
      $winDB->DBGrid->SetRows($nbrISP + 1);
      # Feed the grid - Header
      $winDB->DBGrid->SetCellText($i, 0, $STR{'cbFilterField1'});
      $winDB->DBGrid->SetCellText($i, 1, $STR{'cbFilterField2'});
      $winDB->DBGrid->SetCellText($i, 2, $STR{'ISP'});
      $winDB->DBGrid->SetCellText($i, 3, $STR{'Country'});
      $winDB->DBGrid->SetCellText($i, 4, $STR{'date'});
      $i++;
      # Feed data
      foreach my $row (@$all) {
        my (@values) = @$row;
        my $ipStart = join '.', unpack 'C4', pack 'N', $values[0];
        my $ipEnd   = join '.', unpack 'C4', pack 'N', $values[1];
        $winDB->DBGrid->SetCellText($i, 0, $ipStart);
        $winDB->DBGrid->SetCellText($i, 1, $ipEnd);
        $winDB->DBGrid->SetCellText($i, 2, $values[2]);
        $winDB->DBGrid->SetCellText($i, 3, $values[3]);
        $winDB->DBGrid->SetCellText($i, 4, &time2DateLong($values[4]));
        $winDB->DBGrid->SetCellEditable($i, 0, 0);
        $winDB->DBGrid->SetCellEditable($i, 1, 0);
        $winDB->DBGrid->SetCellEditable($i, 2, 1); # Only ISP and country are editable
        $winDB->DBGrid->SetCellEditable($i, 3, 1);
        $winDB->DBGrid->SetCellEditable($i, 4, 0);
        # If Network Whois Data exist, set background color to green
        my $networkWhoisDataFile = "$CONFIG{'WHOIS_DATA_CACHE'}\\$ipStart\-$ipEnd\.txt";
        if (-T $networkWhoisDataFile) {
          $winDB->DBGrid->SetCellBkColor($i, 0, 0x33FF66);
          $winDB->DBGrid->SetCellBkColor($i, 1, 0x33FF66);
          $winDB->DBGrid->SetCellBkColor($i, 2, 0x33FF66);
          $winDB->DBGrid->SetCellBkColor($i, 3, 0x33FF66);
          $winDB->DBGrid->SetCellBkColor($i, 4, 0x33FF66);
        }
        $i++;
      }
    } else {
      Win32::GUI::MessageBox($win, $STR{'errTableWhoisDB'}, $STR{'Error'}, 0x40010);
      $dbh->disconnect();
      return(0);
    }
    # If table WHOIS_DB_IPV6 exists, than load data
    if ($$refInfo[1] and $$refInfo[1][2] eq 'WHOIS_DB_6') {
      my $all = $dbh->selectall_arrayref("SELECT * FROM WHOIS_DB_6 ORDER BY ipv6_range ASC");
      $nbrISP += scalar(@$all);
      $winDB->statusBar->Text(" $STR{'numberISP'}: ".$nbrISP);
      $winDB->DBGrid->SetRows($nbrISP + 1);
      # Create header if it doesn't exist
      if (!$i) {
        # Header
        $winDB->DBGrid->SetCellText($i, 0, $STR{'cbFilterField1'});
        $winDB->DBGrid->SetCellText($i, 1, $STR{'cbFilterField2'});
        $winDB->DBGrid->SetCellText($i, 2, $STR{'ISP'});
        $winDB->DBGrid->SetCellText($i, 3, $STR{'Country'});
        $winDB->DBGrid->SetCellText($i, 4, $STR{'date'});
        $i++;
      }
      # Feed data
      foreach my $row (@$all) {
        my (@values) = @$row;
        # Fields: 0 = cidr, 2 = ISP name, 3 = country, 4 = date
        my ($ipStart, $ipEnd) = split(/\-/, (Net::CIDR::cidr2range($values[0]))[0]);
        $winDB->DBGrid->SetCellText($i, 0, $ipStart);
        $winDB->DBGrid->SetCellText($i, 1, $ipEnd);
        $winDB->DBGrid->SetCellText($i, 2, $values[1]);
        $winDB->DBGrid->SetCellText($i, 3, $values[2]);
        $winDB->DBGrid->SetCellText($i, 4, &time2DateLong($values[3]));
        $winDB->DBGrid->SetCellEditable($i, 0, 0);
        $winDB->DBGrid->SetCellEditable($i, 1, 0);
        $winDB->DBGrid->SetCellEditable($i, 2, 1); # Only ISP and country are editable
        $winDB->DBGrid->SetCellEditable($i, 3, 1);
        $winDB->DBGrid->SetCellEditable($i, 4, 0);
        # If Network Whois Data exist, set background color to green
        $ipStart =~ s/\:/_/g;
        $ipEnd   =~ s/\:/_/g;
        my $networkWhoisDataFile = "$CONFIG{'WHOIS_DATA_CACHE'}\\$ipStart\-$ipEnd\.txt";
        if (-T $networkWhoisDataFile) {
          $winDB->DBGrid->SetCellBkColor($i, 0, 0x33FF66);
          $winDB->DBGrid->SetCellBkColor($i, 1, 0x33FF66);
          $winDB->DBGrid->SetCellBkColor($i, 2, 0x33FF66);
          $winDB->DBGrid->SetCellBkColor($i, 3, 0x33FF66);
          $winDB->DBGrid->SetCellBkColor($i, 4, 0x33FF66);
        }
        $i++;
      }
    # If table WHOIS_DB_6 does not exist, create the table
    } else { &createWhoisDB_IPV6(\$dbh); }
    # Refresh grid
    $winDB->DBGrid->AutoSizeColumns();
    $winDB->DBGrid->ExpandColumnsToFit(0);
    $winDB->DBGrid->SetListMode();
    $winDB->DBGrid->ScrollPos(1,0);
    $winDB->DBGrid->SortCells(0, 1, \&sortIP);
    $winDB->DBGrid->Refresh();
    $dbh->disconnect();
    return(1);
  } else { return(0); } # No valid WhoisDB file

}  #--- End loadWhoisDB

#--------------------------#
sub btnImportDB_Click
#--------------------------#
{
  # Show OpenFile dialog window
  my $importFile = Win32::GUI::GetOpenFileName( -owner         => $winDB,
                                                -title         => "$STR{'Select'} $STR{'winDB'} $STR{'file'}:",
                                                -defaultfilter => 0     ,
                                                -filemustexist => 1     ,
                                                -explorer      => 1     , );
  # Selected file
  if ($importFile) {
    if (-T $importFile) {
      # Validate content
      open(FILE, $importFile) or Win32::GUI::MessageBox($win, $STR{'errReading'}.$!, $STR{'Error'}, 0x40010);
      my @newISP = <FILE>;
      close(FILE);
      my $nbrISP = @newISP;
      if ($nbrISP > 0 and $newISP[0]) { # At least one item
        my @fields = split(/\t/, $newISP[0]);
        # At least 3 fields and first start with an IP range (IPv4 or IPv6)
        if ($fields[0] and $fields[1] and $fields[2] and
            ($fields[0] =~ /^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\-[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/ or
             $fields[0] =~ /$IPv6_re\-$IPv6_re/)) {
          # Import
          $THR = threads->create(sub { &importWhoisDB(\@newISP, $nbrISP); });
        } else { Win32::GUI::MessageBox($win, $STR{'errNoValidFile'}, $STR{'Error'}, 0x40010); }
      } else { Win32::GUI::MessageBox($win, $STR{'errFileEmpty'}, $STR{'Error'}, 0x40010); }
    } else { Win32::GUI::MessageBox($win, $STR{'selectValidFile'}, $STR{'Error'}, 0x40010); }
  }
  return(1);

}  #--- End btnImportDB_Click

#--------------------------#
sub importWhoisDB
#--------------------------#
{
  # Local variables
  my ($refImportedISPs, $nbrISP) = @_;
  my @newISPs;
  # Cancel button
  $SIG{'KILL'} = sub {
    # Sort grid
    $winDB->DBGrid->SortCells(0, 1, \&sortIP);
    $winDB->DBGrid->Refresh();
    # Status bar
    $nbrISP = $winDB->DBGrid->GetRows() - 1;
    $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP");
    # Turn off progress bar
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    &winPb_Terminate;
    $winDB->ChangeCursor($ARROW);
    threads->exit();
  };
  # Turn on progress bar
  $winPb->Center($winDB);
  $winPb->Show();
  $winPb->lblPbCurr->Text('');
  $winPb->lblCount->Text('');
  $winDB->Disable();
  $winDB->ChangeCursor($HOURGLASS);
  # Convert IP range
  # To Fields: 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
  while (my $isp = shift @{$refImportedISPs}) {
    my @fields = split(/\t/, $isp);
    # IPv4
    if      ($fields[0] =~ /^([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})\-/) {
      my ($ipStart,$ipEnd) = split(/\-/, $fields[0]);
      push(@newISPs, "IPv4\t$ipStart\t$ipEnd\t$fields[1]\t$fields[2]\t$fields[3]");
    # IPv6
    } elsif ($fields[0] =~ /^$IPv6_re\-/) {
      my ($ipStart,$ipEnd) = split(/\-/, $fields[0]);
      my $cidr = Net::CIDR::range2cidr("$ipStart\-$ipEnd");
      push(@newISPs, "IPv6\t$cidr\tNULL\t$fields[1]\t$fields[2]\t$fields[3]");
    }
  }
  # Update DB
  $winPb->lblPbCurr->Text($STR{'ImportingData'});
  my ($nbrAdd, $nbrModif) = &feedWhoisDatabase(\@newISPs, $nbrISP);
  # Refresh grid
  $winDB->DBGrid->AutoSizeColumns();
  $winDB->DBGrid->ExpandColumnsToFit(0);
  $winDB->DBGrid->SetListMode();
  $winDB->DBGrid->ScrollPos(1,0);
  $winDB->DBGrid->SortCells(0, 1, \&sortIP);
  $winDB->DBGrid->Refresh();
  # Status bar
  $nbrISP = $winDB->DBGrid->GetRows() - 1;
  $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP | $STR{'numberISP'} $STR{'added'}: $nbrAdd | $STR{'numberISP'} $STR{'modified'}: $nbrModif");
  # Turn off progress bar
  $winPb->lblPbCurr->Text('');
  $winPb->lblCount->Text('');
  $winPb->pbWinPb->SetPos(0);
  &winPb_Terminate;
  $winDB->ChangeCursor($ARROW);
  
}  #--- End importWhoisDB

#--------------------------#
sub feedWhoisDatabase
#--------------------------#
{
  # Local variables
  my ($refNewISP, $nbrISP, $refNWData) = @_;
  my $whoisDB   = $winConfig->tfDbFile->Text();
  my $nbrAdd    = 0;
  my $nbrModif  = 0;
  my $count     = 0;
  # Connect to DB
  my $dsn = "DBI:SQLite:dbname=$whoisDB";
  my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
            or Win32::GUI::MessageBox($win, $STR{'errCreating'}.' '.$STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010);
  # Progress bar
  $winPb->pbWinPb->SetRange(0, $nbrISP);
  $winPb->pbWinPb->SetPos(0);
  $winPb->pbWinPb->SetStep(1);
  # Check if ISP is known
  foreach my $newISP (@{$refNewISP}) {
    my $lineInGrid;
    $count++;
    $winPb->lblCount->Text("$count / $nbrISP");
    $winPb->pbWinPb->StepIt();
    if ($newISP) {
      my $key = $newISP;
      chomp($newISP);
      my @fieldsNewISP = split(/\t/, $newISP); # Fields: 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
      # If known ISP (same range), keep the newer
      my $response;
      if    ($fieldsNewISP[0] eq 'IPv4') { $response = &checkISP_IPv4(\$dbh, $fieldsNewISP[1], $fieldsNewISP[2]); }
      elsif ($fieldsNewISP[0] eq 'IPv6') { $response = &checkISP_IPv6(\$dbh, $fieldsNewISP[1]); }
      # Fields($response): 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
      if ($response) {
        my $newer = &newerISP($newISP, $response);
        # $newISP is newer
        if ($newer) {
          my @ISP2add = split(/\t/, $newISP);
          # Modify in database
          my $return = &modifyISP(\$dbh, \@ISP2add);
          if ($return) {
            $lineInGrid = &modifyISPGrid(\@ISP2add);
            $nbrModif++;
          }
          # Network whois data extracted (btnExtract2DB_Click only)
          &storeNWData($fieldsNewISP[1], $fieldsNewISP[2], \$$refNWData{$key}, $lineInGrid)
          if $winConfig->chDBCache->Checked() and exists($$refNWData{$key}) and length($$refNWData{$key}) > 1;
        }
      }
      # ISP is unknown, add it
      else {
        my $return = &addISP(\$dbh, \@fieldsNewISP);
        if ($return) {
          $lineInGrid = &addISPGrid(\@fieldsNewISP);
          $nbrAdd++;
          # Network whois data extracted (btnExtract2DB_Click only)
          &storeNWData($fieldsNewISP[1], $fieldsNewISP[2], \$$refNWData{$key}, $lineInGrid)
          if $winConfig->chDBCache->Checked() and exists($$refNWData{$key}) and length($$refNWData{$key}) > 1;
        }
      }
    }
  }
  $dbh->disconnect();
  return($nbrAdd, $nbrModif);

}  #--- End feedWhoisDatabase

#--------------------------#
sub btnExportDB_Click
#--------------------------#
{
  # Local variables
  my $whoisDB = $winConfig->tfDbFile->Text();
  # Show SaveFileWindow
  my $file = Win32::GUI::GetSaveFileName( -owner            => $winDB                     ,
                                          -title            => "$STR{'Select'} $STR{'file'}:",
                                          -file             => 'ISPdb.txt'                ,
                                          -defaultextension => 'txt'                      ,
                                          -createprompt     => 1                          ,
                                          -explorer         => 1                          , );
  if ($file) {
    $THR = threads->create(sub {
      # Thread 'cancellation' signal handler
      $SIG{'KILL'} = sub {
        &winPb_Terminate;
        $winDB->ChangeCursor($ARROW);
        threads->exit();
      };
      # Connect to DB
      my $dsn = "DBI:SQLite:dbname=$whoisDB";
      my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
                or Win32::GUI::MessageBox($win, $STR{'errCreating'}.' '.$STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010);
      # Count number of ISP
      # Database: table = WHOIS_DB, Fields = range_s, range_e, isp, country, date
      my $allIPv4 = $dbh->selectall_arrayref("SELECT * FROM WHOIS_DB ORDER BY range_s ASC");
      my $allIPv6 = $dbh->selectall_arrayref("SELECT * FROM WHOIS_DB_6 ORDER BY ipv6_range ASC");
      my @all = (@$allIPv4, @$allIPv6);
      my $nbrISP = scalar(@all);
      # Show progress window
      $winDB->ChangeCursor($HOURGLASS);
      $winPb->lblPbCurr->Text("$STR{'Exporting'} $STR{'winDB'}...");
      $winPb->lblCount->Text("0 / $nbrISP");
      $winPb->pbWinPb->SetRange(0, $nbrISP);
      $winPb->pbWinPb->SetPos(0);
      $winPb->pbWinPb->SetStep(1);
      $winPb->Center($winDB);
      $winPb->Show();
      $winDB->Disable();
      $winDB->ChangeCursor($HOURGLASS);
      # Export DB
      &exportWhoisDB($file, \@all, $nbrISP);
      $dbh->disconnect();
      # Message
      $winDB->ChangeCursor($ARROW);
      &winPb_Terminate;
      Win32::GUI::MessageBox($winDB, $STR{'exportSuccess'}, "XL-Whois $VERSION", 0x40040);
    });
  }
  return(1);
  
}  #--- End btnExportDB_Click

#--------------------------#
sub exportWhoisDB
#--------------------------#
{
  # Local variables
  my ($DBFile, $refData, $nbrISP) = @_;
  my $i = 0;
  # Open and write data to file
  open my $db_export, '>', $DBFile or Win32::GUI::MessageBox($win, $STR{'errWriting'}.' '.$STR{'file'}.': '.$!, $STR{'Error'}, 0x40010);
  foreach my $row (@$refData) {
    my (@fields) = @$row;
    my $str;
    my $ipStart;
    my $ipEnd;
    my $i;
    # Convert IPv4 addresses
    if ($fields[0] !~ /\:/) {
      $ipStart = join '.', unpack 'C4', pack 'N', $fields[0];
      $ipEnd   = join '.', unpack 'C4', pack 'N', $fields[1];
      $i = 2;
    # Convert IPv6 cidr to range
    } else {
      ($ipStart, $ipEnd) = split(/\-/, (Net::CIDR::cidr2range($fields[0]))[0]);
      $i = 1;
    }
    # Convert date
    my $dateStr = &time2DateLong($fields[$i+2]);
    # Display progress
    $winPb->lblPbCurr->Text("$STR{'Exporting'} [$ipStart, $ipEnd]");
    # Save entry to file
    $str .= "$ipStart\-$ipEnd\t";
    $str .= "$fields[$i]\t$fields[$i+1]\t$dateStr";
    print $db_export "$str\n";
    $i++;
    # Display progress and refresh
    $winPb->lblCount->Text("$i / $nbrISP");
    $winPb->pbWinPb->StepIt();
  }
  close($db_export);
  
}  #--- End exportWhoisDB

#--------------------------#
sub extractClip_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) { Win32::GUI::MessageBox($win, $STR{'errProcessRun'},$STR{'Error'},0x40010); }
  else {
    if (Win32::Clipboard::GetText() =~ /(?:OrgName|CustName|org-name|owner|descr|remarks|inetnum|NetRange|Country|inet6num|CIDR)/) {
      $THR = threads->create(sub {
        # Thread 'cancellation' signal handler
        $SIG{'KILL'} = sub {
          &winPb_Terminate;
          $winDB->ChangeCursor($ARROW);
          threads->exit();
        };
        $winDB->ChangeCursor($HOURGLASS);
        # Extract ISP data from each files
        my @newISP;
        my %NWData;
        my $refExtractedISP = &extractISPData('clipboard');
        foreach my $ISP (keys %{$refExtractedISP}) {
          push(@newISP, $ISP);
          $NWData{$ISP} = $$refExtractedISP{$ISP} if length($$refExtractedISP{$ISP}) > 1;
        }
        # Update DB
        my $nbrISP = @newISP;
        my ($nbrAdd, $nbrModif) = &feedWhoisDatabase(\@newISP, $nbrISP, \%NWData);
        # Refresh grid
        $winDB->DBGrid->AutoSizeColumns();
        $winDB->DBGrid->ExpandColumnsToFit(0);
        $winDB->DBGrid->SetListMode();
        $winDB->DBGrid->ScrollPos(1,0);
        $winDB->DBGrid->SortCells(0, 1, \&sortIP);
        $winDB->DBGrid->Refresh();
        # Message and status bar
        $nbrISP = $winDB->DBGrid->GetRows() - 1;
        my $msg;
        $msg .= "$STR{'numberISP'} $STR{'added'}: $nbrAdd\n"      if $nbrAdd;
        $msg .= "$STR{'numberISP'} $STR{'modified'}: $nbrModif\n" if $nbrModif;
        $msg .= "$STR{'totalNumberISP'}: $nbrISP\n";
        $winDB->statusBar->Text(" $STR{'numberISP'}: ".$nbrISP);
        $winDB->ChangeCursor($ARROW);
        Win32::GUI::MessageBox($winDB, $msg, $STR{'winDB'}, 0x40040);
      });
    } else { Win32::GUI::MessageBox($win, $STR{'errNoValidData'},$STR{'Error'},0x40010); }
  }

}  #--- End extractClip_Click

#--------------------------#
sub btnExtract2DB_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) { Win32::GUI::MessageBox($win, $STR{'errProcessRun'},$STR{'Error'},0x40010); }
  else {
    # Show OpenFile dialog window
    my @target = Win32::GUI::GetOpenFileName( -owner         => $winDB                    ,
                                              -title         => $STR{'selectFileExtract'} ,
                                              -filemustexist => 1                         ,
                                              -multisel      => 1                         ,
                                              -explorer      => 1                         , );
    # List the target files, must be readable
    my @listFiles;
    my $target = shift(@target);
    # No file or too much selected files
    if (!$target) { Win32::GUI::MessageBox($win, $STR{'errFileSelectedMax'},$STR{'Error'},0x40010); }
    else {
      # Multiple selection
      if (-d $target) {
        foreach (@target) {
          my $filePath = "$target\\$_";
          push(@listFiles, $filePath) if -T $filePath;
        }
      # Single selection
      } elsif (-T $target) { push(@listFiles, $target); }
    }
    my $nbrFiles = @listFiles;
    if ($nbrFiles > 0) {
      $THR = threads->create(sub {
        # Thread 'cancellation' signal handler
        $SIG{'KILL'} = sub {
          &winPb_Terminate;
          $winDB->ChangeCursor($ARROW);
          threads->exit();
        };
        # Show progress window
        $winDB->ChangeCursor($HOURGLASS);
        $winPb->lblPbCurr->Text($STR{'btnExtract2DBTip'});
        $winPb->lblCount->Text("0 / $nbrFiles");
        $winPb->pbWinPb->SetRange(0, $nbrFiles);
        $winPb->pbWinPb->SetPos(0);
        $winPb->pbWinPb->SetStep(1);
        $winPb->Center($win);
        $winPb->Show();
        $winDB->Disable();
        # Extract ISP data from each files
        my $count = 0;
        my @newISP;
        my %NWData;
        foreach my $file (@listFiles) {
          $count++;
          $winPb->lblCount->Text("$count / $nbrFiles");
          my $refExtractedISP = &extractISPData($file);
          foreach my $ISP (keys %{$refExtractedISP}) {
            push(@newISP, $ISP);
            $NWData{$ISP} = $$refExtractedISP{$ISP} if length($$refExtractedISP{$ISP}) > 1;
          }
          $winPb->pbWinPb->StepIt();
        }
        # Update DB
        $winPb->lblPbCurr->Text($STR{'updatingDB'});
        my $nbrISP = @newISP;
        my ($nbrAdd, $nbrModif) = &feedWhoisDatabase(\@newISP, $nbrISP, \%NWData);
        # Refresh grid
        $winDB->DBGrid->AutoSizeColumns();
        $winDB->DBGrid->ExpandColumnsToFit(0);
        $winDB->DBGrid->SetListMode();
        $winDB->DBGrid->ScrollPos(1,0);
        $winDB->DBGrid->SortCells(0, 1, \&sortIP);
        $winDB->DBGrid->Refresh();
        # Status bar
        $nbrISP = $winDB->DBGrid->GetRows() - 1;
        $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP | $STR{'numberISP'} $STR{'added'}: $nbrAdd | $STR{'numberISP'} $STR{'modified'}: $nbrModif");
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        &winPb_Terminate;
        $winDB->ChangeCursor($ARROW);
      });
    }
  }
  
}  #--- End btnExtract2DB_Click

#--------------------------#
sub winAWD_Resize
#--------------------------#
{
  $winAWD->GridISPWide->Width($winAWD->ScaleWidth()-12);
  $winAWD->GridISPin->Resize($winAWD->ScaleWidth()-12, $winAWD->ScaleHeight()-270);
  $winAWD->lblISPMsg->Top($winAWD->ScaleHeight()-120);
  $winAWD->lblPbCurr->Top($winAWD->ScaleHeight()-95);
  $winAWD->pbWinPb->Top($winAWD->ScaleHeight()-70);
  $winAWD->lblWinPb->Top($winAWD->ScaleHeight()-70);
  $winAWD->btnAWDCancel->Top($winAWD->ScaleHeight()-38);
  $winAWD->btnAWDNext->Top($winAWD->ScaleHeight()-38);
  $winAWD->lblPbCurr->Width($winAWD->ScaleWidth()-12);
  $winAWD->pbWinPb->Width($winAWD->ScaleWidth()-122);
  $winAWD->lblWinPb->Left($winAWD->ScaleWidth()-112);
  $winAWD->btnAWDCancel->Left($winAWD->ScaleWidth()-212);
  $winAWD->btnAWDNext->Left($winAWD->ScaleWidth()-107);
  $winAWD->GridISPWide->AutoSizeColumns();
  $winAWD->GridISPWide->ExpandColumnsToFit(0);
  $winAWD->GridISPin->AutoSizeColumns();
  $winAWD->GridISPin->ExpandColumnsToFit(0);
  return(1);

}  #--- End winAWD_Resize

#--------------------------#
sub btnValidDB_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) { Win32::GUI::MessageBox($win, $STR{'errProcessRun'},$STR{'Error'},0x40010); }
  else {
    # Display Analyse Window
    $winDB->Disable();
    $winAWD->Center($winDB);
    $winAWD->Show();
    # Progress
    my $nbrISP = $winDB->DBGrid->GetRows() - 1;
    $winAWD->pbWinPb->SetRange(0, $nbrISP);
    $winAWD->pbWinPb->SetPos(0);
    $winAWD->pbWinPb->SetStep(1);
    $NBR_DELETED_ISP = 0;
    $ANALYSIS_QUEUE = Thread::Queue->new();
    $ANALYSIS_QUEUE->enqueue('start');
    $THR = threads->new(\&validWhoisDB);
  }

}  #--- End btnValidDB_Click

#--------------------------#
sub validWhoisDB
#--------------------------#
{
  $SIG{'KILL'} = sub { threads->exit(); }; # Cancel button
  # Analyse each ISP starting from the end
  # IPv6 must be ignored in this function
  while (my $lastISP = $ANALYSIS_QUEUE->dequeue) {
    $winAWD->ChangeCursor($HOURGLASS);
    $lastISP    = 0 if $lastISP eq 'start';
    my $nbrISP  = $winDB->DBGrid->GetRows();
    my $i       = $lastISP + 1;
    $winAWD->pbWinPb->SetPos($i);
    while ($i < $nbrISP) {
      my $range_s = $winDB->DBGrid->GetCellText($i, 0);
      my $range_e = $winDB->DBGrid->GetCellText($i, 1);
      my $isp     = $winDB->DBGrid->GetCellText($i, 2);
      my $country = $winDB->DBGrid->GetCellText($i, 3);
      my $date    = $winDB->DBGrid->GetCellText($i, 4);
      # Fields: 0 = ip start, 1 = ip end, 2 = ISP name, 3 = country, 4 = date
      $winAWD->lblPbCurr->Text("$STR{'Analysing'}: $range_s-$range_e");
      my $curr       = $i;
      my $realNbrISP = $nbrISP - 1;
      $winAWD->lblWinPb->Text("$curr / $realNbrISP");
      # If a range is included
      my @rangesIn;
      my $ipv4 = $range_s =~ /\./ ? 1 : 0;
      for (my $j = $i; $j < $nbrISP; $j++) {
        if ($winDB->DBGrid->GetCellText($j, 0)) {
          my $range_s2cmp = $winDB->DBGrid->GetCellText($j, 0);
          if (($ipv4 and $range_s2cmp =~ /\./) or (!$ipv4 and $range_s2cmp =~ /\:/)) {
            my $range_e2cmp = $winDB->DBGrid->GetCellText($j, 1);
            my $isp2cmp     = $winDB->DBGrid->GetCellText($j, 2);
            my $country2cmp = $winDB->DBGrid->GetCellText($j, 3);
            my $date2cmp    = $winDB->DBGrid->GetCellText($j, 4);
            # If compared range is included in analysed range, keep it
            my ($included, $range_sInt, $range_eInt, $range_s2cmpInt, $range_e2cmpInt);
            if ($ipv4 and $range_s2cmp =~ /\./) { # Compare IPv4
              $range_sInt        = unpack 'N', pack 'C4', split '\.', $range_s;
              $range_eInt        = unpack 'N', pack 'C4', split '\.', $range_e;
              $range_s2cmpInt    = unpack 'N', pack 'C4', split '\.', $range_s2cmp;
              $range_e2cmpInt    = unpack 'N', pack 'C4', split '\.', $range_e2cmp;
              $included          = &inRange($range_sInt, $range_eInt, $range_s2cmpInt, $range_e2cmpInt);
            } else { # Compare IPv6
              my $range_sObj     = NetAddr::IP::Lite->new6($range_s);
              my $range_eObj     = NetAddr::IP::Lite->new6($range_e);
              my $range_s2cmpObj = NetAddr::IP::Lite->new6($range_s2cmp);
              my $range_e2cmpObj = NetAddr::IP::Lite->new6($range_e2cmp);
              $range_sInt        = $range_sObj->bigint();
              $range_eInt        = $range_eObj->bigint();
              $range_s2cmpInt    = $range_s2cmpObj->bigint();
              $range_e2cmpInt    = $range_e2cmpObj->bigint();
              $included          = &inRange($range_sInt, $range_eInt, $range_s2cmpInt, $range_e2cmpInt);
            }
            # Compared range is in the parent range
            if ($included == 2) {
              my $ISP2cmpStr = "$range_s2cmp|$range_e2cmp|$isp2cmp|$country2cmp|$date2cmp";
              push(@rangesIn, $ISP2cmpStr);
            # If start IP to compare is greater than the end IP to check, we overstep the ranges
            } elsif ($range_s2cmpInt >= $range_eInt) { last; }
          }
        }
      }
      my $nbrRangesIn = @rangesIn;
      if ($nbrRangesIn > 0) {
        $winAWD->GridISPWide->SetRows(2);
        $winAWD->GridISPWide->SetCellText( 0, 1, $STR{'cbFilterField1'});
        $winAWD->GridISPWide->SetCellText( 0, 2, $STR{'cbFilterField2'});
        $winAWD->GridISPWide->SetCellText( 0, 3, $STR{'ISP'});
        $winAWD->GridISPWide->SetCellText( 0, 4, $STR{'Country'});
        $winAWD->GridISPWide->SetCellText( 0, 5, $STR{'date'});
        $winAWD->GridISPWide->SetCellText( 1, 0, ""         );
        $winAWD->GridISPWide->SetCellType( 1, 0, GVIT_CHECK );
        $winAWD->GridISPWide->SetCellCheck(1, 0, 1);
        $winAWD->GridISPWide->SetCellText( 1, 1, $range_s);
        $winAWD->GridISPWide->SetCellText( 1, 2, $range_e);
        $winAWD->GridISPWide->SetCellText( 1, 3, $isp);
        $winAWD->GridISPWide->SetCellText( 1, 4, $country);
        $winAWD->GridISPWide->SetCellText( 1, 5, $date);
        $winAWD->GridISPin->SetRows($nbrRangesIn+1);
        $winAWD->GridISPin->SetCellText( 0, 0, ""         );
        $winAWD->GridISPin->SetCellType( 0, 0, GVIT_CHECK );
        $winAWD->GridISPin->SetCellCheck(0, 0, 1);
        $winAWD->GridISPin->SetCellText( 0, 1, $STR{'cbFilterField1'});
        $winAWD->GridISPin->SetCellText( 0, 2, $STR{'cbFilterField2'});
        $winAWD->GridISPin->SetCellText( 0, 3, $STR{'ISP'});
        $winAWD->GridISPin->SetCellText( 0, 4, $STR{'Country'});
        $winAWD->GridISPin->SetCellText( 0, 5, $STR{'date'});
        my $i = 1;
        foreach my $ispStr (@rangesIn) {
          my (@fields) = split(/\|/, $ispStr);
          $winAWD->GridISPin->SetCellText( $i, 0, "");
          $winAWD->GridISPin->SetCellType( $i, 0, GVIT_CHECK);
          $winAWD->GridISPin->SetCellCheck(0, 0, 1);
          $winAWD->GridISPin->SetCellCheck($i, 0, 1);
          $winAWD->GridISPin->SetCellText( $i, 1, $fields[0]);
          $winAWD->GridISPin->SetCellText( $i, 2, $fields[1]);
          $winAWD->GridISPin->SetCellText( $i, 3, $fields[2]);
          $winAWD->GridISPin->SetCellText( $i, 4, $fields[3]);
          $winAWD->GridISPin->SetCellText( $i, 5, $fields[4]);
          $i++;
        }
        $winAWD->GridISPWide->AutoSize();
        $winAWD->GridISPin->AutoSize();
        if ($winAWD->GridISPWide->GetColumnWidth(1) > $winAWD->GridISPin->GetColumnWidth(1)) {
          $winAWD->GridISPin->SetColumnWidth(1, $winAWD->GridISPWide->GetColumnWidth(1));
        } else { $winAWD->GridISPWide->SetColumnWidth(1, $winAWD->GridISPin->GetColumnWidth(1)); }
        if ($winAWD->GridISPWide->GetColumnWidth(2) > $winAWD->GridISPin->GetColumnWidth(2)) {
          $winAWD->GridISPin->SetColumnWidth(2, $winAWD->GridISPWide->GetColumnWidth(2));
        } else { $winAWD->GridISPWide->SetColumnWidth(2, $winAWD->GridISPin->GetColumnWidth(2)); }
        if ($winAWD->GridISPWide->GetColumnWidth(3) > $winAWD->GridISPin->GetColumnWidth(3)) {
          $winAWD->GridISPin->SetColumnWidth(3, $winAWD->GridISPWide->GetColumnWidth(3));
        } else { $winAWD->GridISPWide->SetColumnWidth(3, $winAWD->GridISPin->GetColumnWidth(3)); }
        if ($winAWD->GridISPWide->GetColumnWidth(4) > $winAWD->GridISPin->GetColumnWidth(4)) {
          $winAWD->GridISPin->SetColumnWidth(4, $winAWD->GridISPWide->GetColumnWidth(4));
        } else { $winAWD->GridISPWide->SetColumnWidth(4, $winAWD->GridISPin->GetColumnWidth(4)); }
        if ($winAWD->GridISPWide->GetColumnWidth(5) > $winAWD->GridISPin->GetColumnWidth(5)) {
          $winAWD->GridISPin->SetColumnWidth(5, $winAWD->GridISPWide->GetColumnWidth(5));
        } else { $winAWD->GridISPWide->SetColumnWidth(5, $winAWD->GridISPin->GetColumnWidth(5)); }
        $winAWD->GridISPWide->AutoSizeColumns();
        $winAWD->GridISPWide->ExpandColumnsToFit(0);
        $winAWD->GridISPin->AutoSizeColumns();
        $winAWD->GridISPin->ExpandColumnsToFit(0);
        $winAWD->ChangeCursor($ARROW);
        last;
      }
      $winAWD->pbWinPb->StepIt();
      $i++;
    } # End browsing rows
    if ($i == $nbrISP) {
      # Refresh grid
      $winDB->DBGrid->AutoSizeColumns();
      $winDB->DBGrid->ExpandColumnsToFit(0);
      $winDB->DBGrid->SetListMode();
      $winDB->DBGrid->ScrollPos(1,0);
      $winDB->DBGrid->SortCells(0, 1, \&sortIP);
      $winDB->DBGrid->Refresh();
      # Status bar
      $nbrISP = $winDB->DBGrid->GetRows() - 1;
      $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP | $STR{'numberISP'} $STR{'deleted'}: $NBR_DELETED_ISP");
      # Turn off progress bar
      $winAWD->lblPbCurr->Text('');
      $winAWD->lblWinPb->Text('');
      $winAWD->pbWinPb->SetPos(0);
      &winAWD_Terminate;
      $winAWD->ChangeCursor($ARROW);
      threads->exit();
    }
  } # End queue

}  #--- End validWhoisDB

#--------------------------#
sub GridISPWide_Click
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  # Select
  if (!$column) {
    my $selStatus = $winAWD->GridISPWide->GetCellCheck($row, 0);
    if (!$row) {
      if (!$selStatus) { # Check all
				for (my $i = 0; $i < $winAWD->GridISPWide->GetRows(); $i++) { $winAWD->GridISPWide->SetCellCheck($i, 0, 1); }
			} else { # Uncheck all
				for (my $i = 0; $i < $winAWD->GridISPWide->GetRows(); $i++) { $winAWD->GridISPWide->SetCellCheck($i, 0, 0); }
			}
    } else {
      if (!$selStatus) { $winAWD->GridISPWide->SetCellCheck($row, 0, 1); } # Check
      else             { $winAWD->GridISPWide->SetCellCheck($row, 0, 0); } # Uncheck
    }
  }
  return(1);

}  #--- End GridISPWide_Click

#--------------------------#
sub GridISPin_Click
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  # Select
  if (!$column) {
    my $selStatus = $winAWD->GridISPin->GetCellCheck($row, 0);
    if (!$row) {
      if (!$selStatus) { # Check all
				for (my $i = 0; $i < $winAWD->GridISPin->GetRows(); $i++) { $winAWD->GridISPin->SetCellCheck($i, 0, 1); }
			} else { # Uncheck all
				for (my $i = 0; $i < $winAWD->GridISPin->GetRows(); $i++) { $winAWD->GridISPin->SetCellCheck($i, 0, 0); }
			}
    } else {
      if (!$selStatus) { $winAWD->GridISPin->SetCellCheck($row, 0, 1); } # Check
      else             { $winAWD->GridISPin->SetCellCheck($row, 0, 0); } # Uncheck
    }
  }
  return(1);

}  #--- End GridISPin_Click

#--------------------------#
sub btnAWDNext_Click
#--------------------------#
{
  # List of entries to delete
  my @listRanges;
  my $nbrDeleted = 0;
  if (!$winAWD->GridISPWide->GetCellCheck(1, 0)) {
    my $range_s = $winAWD->GridISPWide->GetCellText(1, 1);
    my $range_e = $winAWD->GridISPWide->GetCellText(1, 2);
    push(@listRanges, "$range_s\-$range_e");
  }
  my $i = 1;
  while ($i < $winAWD->GridISPin->GetRows()) {
    if (!$winAWD->GridISPin->GetCellCheck($i, 0)) {
      my $range_s = $winAWD->GridISPin->GetCellText($i, 1);
      my $range_e = $winAWD->GridISPin->GetCellText($i, 2);
      push(@listRanges, "$range_s\-$range_e");
      $nbrDeleted++
    }
    $i++;
  }
  # Delete ISP
  if (scalar(@listRanges) > 0) {
    # Connect to DB
    my $whoisDB = $winConfig->tfDbFile->Text();
    my $dsn = "DBI:SQLite:dbname=$whoisDB";
    my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
              or Win32::GUI::MessageBox($win, $STR{'errCreating'}.' '.$STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010);
    # Delete from database
    foreach my $isp2del (@listRanges) {
      my ($ipStart2del, $ipEnd2del) = split(/\-/, $isp2del);
      my $return;
      if    ($ipStart2del =~ /\./) { $return = &deleteISP_IPv4(\$dbh, $ipStart2del, $ipEnd2del); } # Delete in Database (IPv4)
      elsif ($ipStart2del =~ /\:/) { $return = &deleteISP_IPv6(\$dbh, $ipStart2del, $ipEnd2del); } # Delete in Database (IPv6)
      if ($return) {
        # Delete in the grid
        &deleteISPGrid(0, $ipStart2del, $ipEnd2del) if $return;
        $NBR_DELETED_ISP++;
      }
    }
    $dbh->disconnect();
  }
  # Row number of the last processed entry
  my $progress = $winAWD->lblWinPb->Text();
  my $lastISP  = (split(/ \/ /, $progress))[0];
  $lastISP    += $nbrDeleted;
  $ANALYSIS_QUEUE->enqueue($lastISP);

}  #--- End btnAWDNext_Click

#--------------------------#
sub btnAWDCancel_Click
#--------------------------#
{
  # Stop requests
  if ($THR) {
    $ANALYSIS_QUEUE->end();
    $winAWD->lblPbCurr->Text($STR{'Cancelling'});
    $winAWD->lblWinPb->Text('');
    &winAWD_Terminate;
    $winAWD->ChangeCursor($ARROW);
    $THR->kill('KILL')->detach() if $THR and $THR->is_running();
  } else { &winAWD_Terminate; }
  return(1);
  
}  #--- End btnAWDCancel_Click

#--------------------------#
sub winAWD_Terminate
#--------------------------#
{
  # Stop requests
  if ($THR) {
    $ANALYSIS_QUEUE->end();
    $winAWD->ChangeCursor($ARROW);
    $THR->kill('KILL')->detach() if $THR and $THR->is_running();
  }
  $winAWD->Hide();
  $win->Enable();
  $winDB->Enable();
  $winDB->SetForegroundWindow();
  return(0);
  
}  #--- End winAWD_Terminate

#--------------------------#
sub tfSearchDB_Change
#--------------------------#
{
  # Local variables
  my $searchStr   = $winDB->tfSearchDB->Text();
  my $nbrStrChars = length($searchStr);
  # Activate search button
  if ($searchStr) {
    $winDB->btnSearchDB->Enable();
    $winDB->btnSearchDB_p->Disable();
    $winDB->btnSearchDB_n->Disable();
  } else {
    $winDB->DBGrid->SetSelectedCellRange(0, 0, 0, 4);
    $winDB->DBGrid->EnsureCellVisible(0,0);
    $winDB->btnSearchDB->Disable();
    $winDB->btnSearchDB_p->Disable();
    $winDB->btnSearchDB_n->Disable();
  }
  # Select line with partial IP
  if ($searchStr =~ /^([0-9\.]+)/) {
    $winDB->ChangeCursor($HOURGLASS);
    my ($ip) = $1;
    my ($nMinRow, $nMinCol, $nMaxRow, $nMaxCol) = $winDB->DBGrid->GetSelectedCellRange();
    my $rang    = 0;
    $rang       = $nMinRow if $nbrStrChars > $NBR_CHARS;
    $NBR_CHARS  = $nbrStrChars;
    for (my $i = $rang; $i < $winDB->DBGrid->GetRows(); $i++) {
      my $range_s = $winDB->DBGrid->GetCellText($i, 0);
      if ($range_s =~ /^$ip/) {
        $winDB->DBGrid->SetSelectedCellRange($i, 0, $i, 4);
        $winDB->DBGrid->EnsureCellVisible($i,0);
        last;
      }
      my ($searchIP_s, $searchIP_cmp);
      if ($searchStr =~ /^([0-9]+)\./) { $searchIP_s   = $1; }
      if ($range_s   =~ /^([0-9]+)\./) { $searchIP_cmp = $1; }
      if ($searchIP_s and $searchIP_cmp) { last if $searchIP_cmp gt $searchIP_s; }
    }
    $winDB->ChangeCursor($ARROW);
  }

}  #--- End tfSearchDB_Change

#--------------------------#
sub btnSearchDB_Click
#--------------------------#
{
  # Local variables
  my $searchStr = $winDB->tfSearchDB->Text();
  my $found     = 0;
  # Search IPv4
  if ($searchStr =~ /^([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})$/) {
    my $searchIP = $1;
    $winDB->ChangeCursor($HOURGLASS);
    for (my $i = 1; $i < $winDB->DBGrid->GetRows(); $i++) {
      my $range_s = $winDB->DBGrid->GetCellText($i, 0);
      my $range_e = $winDB->DBGrid->GetCellText($i, 1);
      if ($range_s !~ /\:/ and
          (pack('C4', split(/\./,$searchIP)) ge pack('C4', split(/\./,$range_s))) and
          (pack('C4', split(/\./,$searchIP)) le pack('C4', split(/\./,$range_e)))) {
        $winDB->DBGrid->SetSelectedCellRange($i, 0, $i, 4);
        $winDB->DBGrid->EnsureCellVisible($i,0);
        $found = 1;
      }
    }
  # Search IPv6
  } elsif ($searchStr =~ /($IPv6_re)/) {
    my $searchIP = $1;
    for (my $i = $winDB->DBGrid->GetRows()-1; $i > 1; $i--) {
      my $range_s = $winDB->DBGrid->GetCellText($i, 0);
      if ($range_s =~ /\:/) {
        my $range_e = $winDB->DBGrid->GetCellText($i, 1);
        my $cidr = Net::CIDR::range2cidr("$range_s\-$range_e");
        if (Net::CIDR::cidrlookup($searchIP, ($cidr))) {
          $winDB->DBGrid->SetSelectedCellRange($i, 0, $i, 4);
          $winDB->DBGrid->EnsureCellVisible($i,0);
          $found = 1;
        }
      }
    }
  # Search text in ISP field
  } elsif ($searchStr) {
    $winDB->ChangeCursor($HOURGLASS);
    for (my $i = 1; $i < $winDB->DBGrid->GetRows(); $i++) {
      my $ISPGrid = $winDB->DBGrid->GetCellText($i, 2);
      if ($ISPGrid =~ /$searchStr/i) {
        $winDB->DBGrid->SetSelectedCellRange($i, 0, $i, 4);
        $winDB->DBGrid->EnsureCellVisible($i,0);
        $winDB->DBGrid->AutoSizeRows();
        $found = 1;
        $winDB->btnSearchDB_p->Enable();
        $winDB->btnSearchDB_n->Enable();
        last;
      }
    }
  }
  # If not found
  $winDB->ChangeCursor($ARROW);
  Win32::GUI::MessageBox($win, $STR{'notFoundStr'}, $STR{'notFound'}, 0x40040) if !$found;
  
}  #--- End btnSearchDB_Click

#--------------------------#
sub btnSearchDB_p_Click
#--------------------------#
{
  # Local variables
  my $searchStr = $winDB->tfSearchDB->Text();
  my $selRow    = ($winDB->DBGrid->GetSelectedCellRange())[0];
  my $found     = 0;
  # Search in FSI field
  if ($searchStr) {
    for (my $i = $selRow-1; $i > 0; $i--) {
      my $ISPGrid = $winDB->DBGrid->GetCellText($i, 2);
      if ($ISPGrid =~ /$searchStr/i) {
        $winDB->DBGrid->SetSelectedCellRange($i, 0, $i, 4);
        $winDB->DBGrid->EnsureCellVisible($i,0);
        $winDB->DBGrid->AutoSizeRows();
        $found = 1;
        last;
      }
    }
  }
  # If not found
  $winDB->ChangeCursor($ARROW);
  Win32::GUI::MessageBox($win, $STR{'noMoreResults'}, $STR{'Searching'}, 0x40040)  if !$found;

}  #--- End btnSearchDB_p_Click

#--------------------------#
sub btnSearchDB_n_Click
#--------------------------#
{
  # Local variables
  my $searchStr = $winDB->tfSearchDB->Text();
  my $selRow    = ($winDB->DBGrid->GetSelectedCellRange())[0];
  my $found     = 0;
  # Search in FSI field
  if ($searchStr) {
    for (my $i = $selRow+1; $i < $winDB->DBGrid->GetRows(); $i++) {
      my $ISPGrid = $winDB->DBGrid->GetCellText($i, 2);
      if ($ISPGrid =~ /$searchStr/i) {
        $winDB->DBGrid->SetSelectedCellRange($i, 0, $i, 4);
        $winDB->DBGrid->EnsureCellVisible($i,0);
        $winDB->DBGrid->AutoSizeRows();
        $found = 1;
        last;
      }
    }
  }
  # If not found
  $winDB->ChangeCursor($ARROW);
  Win32::GUI::MessageBox($win, $STR{'noMoreResults'}, $STR{'Searching'}, 0x40040) if !$found;

}  #--- End btnSearchDB_n_Click

#--------------------------#
sub btnFilterDB_Click
#--------------------------#
{
  $ADD_FILTER = 0;
  $winFilter->cbAddFilterOp->ResetContent();
  $winFilter->cbAddFilterOp->Disable();
  $winFilter->cbFilterField->SetCurSel(0);
  $winFilter->cbOperator->ResetContent();
  $winFilter->cbOperator->Disable();
  $winFilter->cbFilterValue->ResetContent();
  $winFilter->cbFilterValue->Disable();
  $winFilter->cbFilterValue->Show();
  $winFilter->tfFilterValue->Text('');
  $winFilter->tfFilterValue->Disable();
  $winFilter->tfFilterValue->Hide();
  $winFilter->Center($win);
  $winFilter->Show();
  $winDB->Disable();
  return(1);

}  #--- End btnFilterDB_Click

#--------------------------#
sub btnFilterDB_add_Click
#--------------------------#
{
  $ADD_FILTER = 1;
  $winFilter->cbAddFilterOp->ResetContent();
  $winFilter->cbAddFilterOp->Add('OR', 'AND');
  $winFilter->cbAddFilterOp->SetCurSel(0);
  $winFilter->cbAddFilterOp->Enable();
  $winFilter->cbFilterField->SetCurSel(0);
  $winFilter->cbOperator->ResetContent();
  $winFilter->cbOperator->Disable();
  $winFilter->cbFilterValue->ResetContent();
  $winFilter->cbFilterValue->Disable();
  $winFilter->cbFilterValue->Show();
  $winFilter->tfFilterValue->Text('');
  $winFilter->tfFilterValue->Disable();
  $winFilter->tfFilterValue->Hide();
  $winFilter->Center($win);
  $winFilter->Show();
  $winDB->Disable();
  return(1);

}  #--- End btnFilterDB_add_Click

#--------------------------#
sub cbFilterField_Change
#--------------------------#
{
  # Local variables
  my $field        = $winFilter->cbFilterField->GetCurSel();
  my %operators    = (1 => ['', $STR{'equal'}, $STR{'notEqual'}, $STR{'greater'}, $STR{'greaterEqual'}, $STR{'lower'}, $STR{'lowerEqual'}],
                      2 => ['', $STR{'equal'}, $STR{'notEqual'}, $STR{'greater'}, $STR{'greaterEqual'}, $STR{'lower'}, $STR{'lowerEqual'}],
                      3 => ['', $STR{'equal'}, $STR{'notEqual'}, $STR{'contains'}, $STR{'notContains'}],
                      4 => ['', $STR{'equal'}, $STR{'notEqual'}],
                      5 => ['', $STR{'equal'}, $STR{'notEqual'}, $STR{'greater'}, $STR{'greaterEqual'}, $STR{'lower'}, $STR{'lowerEqual'}], );
  # Possible values for field: 0 = '' (No value), 1 = 'Start IP', 2 = 'End IP', 3 = 'ISP', 4 = 'Country', 5 = 'Date'
  # Start IP
  if ($field) {
    $winFilter->cbOperator->ResetContent();
    foreach (@{$operators{$field}}) { $winFilter->cbOperator->Add($_); }
    $winFilter->cbOperator->SetCurSel(0);
    $winFilter->cbOperator->Enable();
    $winFilter->cbFilterValue->Enable();
    $winFilter->cbFilterValue->ResetContent();
    $winFilter->tfFilterValue->Enable();
    $winFilter->tfFilterValue->Text('');
    if (!$ADD_FILTER) { $winDB->tfFilterDB->Text(''); } # Reset filter
  # There is no value
  } else {
    $winFilter->cbOperator->ResetContent();
    $winFilter->cbOperator->Disable();
    $winFilter->cbFilterValue->ResetContent();
    $winFilter->cbFilterValue->Disable();
    $winFilter->cbFilterValue->Show();
    $winFilter->tfFilterValue->Text('');
    $winFilter->tfFilterValue->Disable();
    $winFilter->tfFilterValue->Hide();
  }
  
}  #--- End cbFilterField_Change

#--------------------------#
sub cbOperator_Change
#--------------------------#
{
  # Local variables
  my $addOperator = $winFilter->cbAddFilterOp->GetCurSel(); # Add operator: 0 == OR, 1 == AND
  my $field       = $winFilter->cbFilterField->GetCurSel();
  my $operator    = $winFilter->cbOperator->GetCurSel();
  # Possible values for field: 0 = '' (No value), 1 = 'Start IP', 2 = 'End IP', 3 = 'ISP', 4 = 'Country', 5 = 'Date'
  # Values of operator depend on field value
  if ($operator) {
    # Case of a simple textfield (ISP, Contains or Not contains)
    if ($field == 3 and ($operator == 3 or $operator == 4)) {
      $winFilter->btnApplyFilter->Disable;
      $winFilter->cbFilterValue->Hide();
      $winFilter->tfFilterValue->Show();
    # Case of combobox values
    } else {
      $winFilter->cbFilterValue->Show();
      $winFilter->tfFilterValue->Hide();
      my %values;
      # Gather each row value
      for (my $row = 1; $row < $winDB->DBGrid->GetRows(); $row++) {
        if ($addOperator) {
          my $rowHeight = $winDB->DBGrid->GetRowHeight($row);
          if ($rowHeight > 0) {
            my $value = $winDB->DBGrid->GetCellText($row, $field-1);
            $values{$value} = 1 if !exists($values{$value});
          }
        } else {
          my $value = $winDB->DBGrid->GetCellText($row, $field-1);
          $values{$value} = 1 if !exists($values{$value});
        }
      }
      # Fill the combobox after sort
      my @listValues;
      if ($field == 1 or $field == 2) {
        @listValues = map { $_->[0] }
                      sort { $a->[1] cmp $b->[1] }
                      map { [ $_, eval { if (/\./) { unpack 'N', pack 'C4', split '\.', $_ } else { $_ } } ]} keys %values;
      } else {
        @listValues = sort {lc($a) cmp lc($b)} keys %values;
      }
      foreach (@listValues) { $winFilter->cbFilterValue->Add($_); }
      $winFilter->cbFilterValue->SetCurSel(0);
      $winFilter->btnApplyFilter->Enable;
    }
  # No operator selected
  } else {
    $winFilter->btnApplyFilter->Disable;
    $winFilter->cbFilterValue->ResetContent();
    $winFilter->cbFilterValue->Disable();
    $winFilter->cbFilterValue->Show();
    $winFilter->tfFilterValue->Text('');
    $winFilter->tfFilterValue->Disable();
    $winFilter->tfFilterValue->Hide();
  }
  
}  #--- End cbOperator_Change
  
#--------------------------#
sub tfFilterValue_Change
#--------------------------#
{
  my $filterValue = $winFilter->tfFilterValue->Text();
  if ($filterValue) { $winFilter->btnApplyFilter->Enable;  }
  else              { $winFilter->btnApplyFilter->Disable; }
  
}  #--- End tfFilterValue_Change

#--------------------------#
sub btnApplyFilter_Click
#--------------------------#
{
  # Local variables
  my $field       = $winFilter->cbFilterField->GetCurSel(); # Field: 0 = '' (No value), 1 = 'StartIP', 2 = 'EndIP', 3 = 'ISP', 4 = 'Country', 5 = 'Date'
  my $fieldStr    = $winFilter->cbFilterField->GetString($field);
  my $operator    = $winFilter->cbOperator->GetCurSel();
  my $valueStr    = $winFilter->cbFilterValue->GetString($winFilter->cbFilterValue->GetCurSel());
  # Operator symbol
  my %operatorSymbol = (1 => ['', '==', '!=', '>', '>=', '<', '<='],
                        2 => ['', '==', '!=', '>', '>=', '<', '<='],
                        3 => ['', '==', '!=', '=~', '!~'],
                        4 => ['', '==', '!='],
                        5 => ['', '==', '!=', '>', '>=', '<', '<='], );
  my $addOperatorStr;
  my @currFilters;
  my $filterStr;
  # If Add Filter, keep the current filter
  if ($ADD_FILTER) {
    my $currFilterStr  = $winDB->tfFilterDB->Text();
    $addOperatorStr = $winFilter->cbAddFilterOp->GetString($winFilter->cbAddFilterOp->GetCurSel()); # Add operator: 0 == OR, 1 == AND
    $addOperatorStr =~ s/AND/&&/;
    $addOperatorStr =~ s/OR/||/;
    $filterStr .= "$currFilterStr $addOperatorStr ";
  }
  # Case of a simple textfield (ISP, Contains or Not contains)
  $valueStr = $winFilter->tfFilterValue->Text() if $field == 3 and ($operator == 3 or $operator == 4);
  # Filter string
  $filterStr .= "$fieldStr $operatorSymbol{$field}[$operator] \"$valueStr\"";
  # Write new filter string in filter textfield
  $winDB->tfFilterDB->Text($filterStr);
  # Load Whois Database with Filters
  &applyFilters();
  &winFilter_Terminate;

}  #--- End btnApplyFilter_Click

#--------------------------#
sub applyFilters
#--------------------------#
{
  # Local variables
  my $filterStr = $winDB->tfFilterDB->Text();
  my @filters;
  my $nbrDisplayedRow = 0;
  # Split filters
  while ($filterStr =~ /((?: && | \|\| )?[^ ]+ [^ ]+ \"[^\"]+\")/) {
    my $filter = $1;
    push(@filters, $filter);
    my $filter2rem = quotemeta($filter);
    $filterStr =~ s/$filter2rem//;
  }
  # Apply each filter
  foreach (@filters) {
    my @partFilter = split(/ /, $_);
    my $addOperator;
    my $field;
    my $operator;
    my $value;
    # Additional filter
    if ($partFilter[1] eq '&&' or $partFilter[1] eq '||') {
      $addOperator = $partFilter[1];
      $field       = $partFilter[2];
      $operator    = $partFilter[3];
      for (my $i = 4; $i < scalar(@partFilter); $i++) { $value .= "$partFilter[$i] "; }
      $value =~ s/^\"//;
      $value =~ s/\" $//;
    # First filter
    } else {
      $field       = $partFilter[0];
      $operator    = $partFilter[1];
      for (my $i = 2; $i < scalar(@partFilter); $i++) { $value .= "$partFilter[$i] "; }
      $value =~ s/^\"//;
      $value =~ s/\" $//;
    }
    # Determine column to filter
    my $col2Filter;
    if    ($field eq $STR{'cbFilterField1'}) { $col2Filter = 0; }
    elsif ($field eq $STR{'cbFilterField2'}) { $col2Filter = 1; }
    elsif ($field eq $STR{'ISP'}           ) { $col2Filter = 2; }
    elsif ($field eq $STR{'Country'}       ) { $col2Filter = 3; }
    else                                     { $col2Filter = 4; }
    # Operator is AND, look at displayed rows
    if ($addOperator and $addOperator eq '&&') {
      # Test each row
      for (my $i = 1; $i < $winDB->DBGrid->GetRows(); $i++) {
        my $rowHeight = $winDB->DBGrid->GetRowHeight($i);
        if ($rowHeight > 0) {
          my $f2filter = $winDB->DBGrid->GetCellText($i, $col2Filter);
          if    ($operator eq '==' and $f2filter eq $value    ) { $winDB->DBGrid->SetRowHeight($i, 22); }
          elsif ($operator eq '!=' and $f2filter ne $value    ) { $winDB->DBGrid->SetRowHeight($i, 22); }
          elsif ($operator eq '>'  and $f2filter gt $value    ) { $winDB->DBGrid->SetRowHeight($i, 22); }
          elsif ($operator eq '>=' and $f2filter ge $value    ) { $winDB->DBGrid->SetRowHeight($i, 22); }
          elsif ($operator eq '<'  and $f2filter lt $value    ) { $winDB->DBGrid->SetRowHeight($i, 22); }
          elsif ($operator eq '<=' and $f2filter le $value    ) { $winDB->DBGrid->SetRowHeight($i, 22); }
          elsif ($operator eq '=~' and $f2filter =~ /$value/i ) { $winDB->DBGrid->SetRowHeight($i, 22); }
          elsif ($operator eq '!~' and $f2filter !~ /$value/i ) { $winDB->DBGrid->SetRowHeight($i, 22); }
          elsif ($operator)                                     { $winDB->DBGrid->SetRowHeight($i, 0); $nbrDisplayedRow--; }
        }
      }
    # Operator is OR, only look at hidden rows
    } elsif ($addOperator and $addOperator eq '||') {
      # Test each row
      for (my $i = 1; $i < $winDB->DBGrid->GetRows(); $i++) {
        my $rowHeight = $winDB->DBGrid->GetRowHeight($i);
        if (!$rowHeight) {
          my $f2filter = $winDB->DBGrid->GetCellText($i, $col2Filter);
          if    ($operator eq '==' and $f2filter eq $value    ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '!=' and $f2filter ne $value    ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '>'  and $f2filter gt $value    ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '>=' and $f2filter ge $value    ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '<'  and $f2filter lt $value    ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '<=' and $f2filter le $value    ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '=~' and $f2filter =~ /$value/i ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '!~' and $f2filter !~ /$value/i ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator)                                     { $winDB->DBGrid->SetRowHeight($i, 0); }
        }
      }
    # First filter, browse all the grid
    } else {
      # Test each row
      for (my $i = 1; $i < $winDB->DBGrid->GetRows(); $i++) {
        my $f2filter = $winDB->DBGrid->GetCellText($i, $col2Filter);
          if    ($operator eq '==' and $f2filter eq $value    ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '!=' and $f2filter ne $value    ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '>'  and $f2filter gt $value    ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '>=' and $f2filter ge $value    ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '<'  and $f2filter lt $value    ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '<=' and $f2filter le $value    ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '=~' and $f2filter =~ /$value/i ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '!~' and $f2filter !~ /$value/i ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
        elsif ($operator)                                       { $winDB->DBGrid->SetRowHeight($i, 0); } 
      }
    }
  }
  $winDB->DBGrid->Refresh();
  my $nbrISP = $winDB->DBGrid->GetRows() - 1;
  $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP | $STR{'numberISP'} $STR{'displayed'}: $nbrDisplayedRow");

}  #--- End applyFilters

#--------------------------#
sub winFilter_Terminate
#--------------------------#
{
  $winFilter->Hide();
  $win->Enable();
  $winDB->Enable();
  $winDB->SetForegroundWindow();
  return(0);

}  #--- End winFilter_Terminate

#--------------------------#
sub tfFilterDB_Change
#--------------------------#
{
  my $currFilterStr = $winDB->tfFilterDB->Text();
  if ($currFilterStr) {
    $winDB->btnFilterDB_del->Enable;
    $winDB->btnFilterDB_add->Enable;
  } else {
    $winDB->btnFilterDB_del->Disable;
    $winDB->btnFilterDB_add->Disable;
  }
  
}  #--- End tfFilterDB_Change

#--------------------------#
sub btnFilterDB_del_Click
#--------------------------#
{
  $winDB->tfFilterDB->Text('');
  $ADD_FILTER = 0;
  $winDB->btnFilterDB_del->Disable;
  $winDB->btnFilterDB_add->Disable;
  # Resize Rows
  for (my $i = 1; $i < $winDB->DBGrid->GetRows(); $i++) { $winDB->DBGrid->SetRowHeight($i, 22); }
  $winDB->DBGrid->Refresh();
  my $nbrISP = $winDB->DBGrid->GetRows() - 1;
  $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP");
  
}  #--- End btnFilterDB_del_Click

#--------------------------#
sub extractISPData
#--------------------------#
{
  # Local variables
  my ($file)  = shift;
  my $c1      = 0;  # Correspond to field order in typical whois answer, $c1 >= 1 when description has been found
  my $c2      = 0;  # $c2 >= 1 if range has been found
  my $c3      = 0;  # $c3 >= 1 if cidr has been found
  my $c4      = 0;  # $c4 >= 1 if country has been found
  my @parentRange;  # Parent ranges
  my %tempNewISP;   # Temp storage
  my %newISPs;      # All ISP entries returned
  my @tempNWData;   # Storage for raw Network Whois data
  my $startPre = 0; # Indicates that we are in <pre>...</pre>
  my $i = 1;        # Incremental value, used for multiple extractions
  my $last;         # Last extracted ISP
  my $dateFile;
  my @tab;
  # If data is clipboard
  if ($file eq 'clipboard') {
    my @temp  = split(/[\r\n]/, Win32::Clipboard::GetText());
    foreach (@temp) { chomp(); chomp(); push(@tab, $_) if $_; }
    $dateFile = &time2DateLong(time);
  } else {
    # Open file
    open(FILE, $file) or Win32::GUI::MessageBox($win, $STR{'errReading'}.$!, $STR{'Error'}, 0x40010);
    @tab = <FILE>;
    close(FILE);
    $dateFile = &time2DateLong((stat($file))[9]);
  }
  # Split lines
  my @tabLines;
  foreach my $line (@tab) {
    if ($line =~ /[\r\n]/) { push(@tabLines, split(/[\r\n]/, $line)); }
    else                   { push(@tabLines, $line);                  }
  }
  # ExtractData
  foreach my $line (@tabLines) {
    if ($line =~ /<pre(?:[^>]+)?>/) { $startPre = 1; } # Start of <pre>...</pre> 
    if ($line =~ /Date \: \<strong style\=\"color\:\#0099ff\;\"\>(\d{4}\-\d{2}\-\d{2}) /) { $tempNewISP{"date-$i"}     = $1; }
    if ($line =~ /OrgName\:\s*([^\r\n]*) ?/i                                            ) { $tempNewISP{"provider-$i"} = $1; }
    if ($line =~ /CustName\:\s*([^\r\n]*) ?/i                                           ) { $tempNewISP{"provider-$i"} = $1; }
    if ($line =~ /org-name\:\s*([^\r\n]*) ?/i                                           ) { $tempNewISP{"provider-$i"} = $1; }
    if ($line =~ /^owner\:\s*([^\r\n]*) ?/i                                             ) { $tempNewISP{"provider-$i"} = $1; }
    if ($line =~ /^descr\:\s*(\w[^\r\n]*) ?/i and ($c2 or $c3)) { if (!$c1) { $tempNewISP{"descr-$i"} = $1; $c1++; } }
    if ($line =~ /^remarks\:\s*[^\r\n]+\@([^\r\n]+)/i and !$tempNewISP{"provider-$i"}   ) { $tempNewISP{"provider-$i"} = $1; }
    # Range IPv4
    if ($line =~ /(?:inetnum|NetRange):\s*([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\s*-\s*[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})/i) {
      $tempNewISP{"type-$i"}  = 'IPv4';
      $tempNewISP{"range-$i"} = $1;
      $c2++;
    }
    # Range IPv4 (CIDR notation, used by LACNIC)
    if ($line =~ /inetnum:\s*((?:\d{1,3}\.){1,3}\d{1,3}\/\d{1,2})/i) {
      if (!$c3) {
        $tempNewISP{"type-$i"} = 'IPv4';
        $tempNewISP{"cidr-$i"} = $1;
        $c3++;
      }
    }
    if ($line =~ /^Country\:\s*(\w+) ?/i and ($c2 or $c3)) { if (!$c4) { $tempNewISP{"country-$i"} = uc($1); $c4++; } }
    # Parent Range IPv4 (ARIN only)
    if ($line =~ /\(NET-(?:[0-9]{1,3}\-){4}[0-9]{1,3}\) (?:[0-9]{1,3}\.){3}[0-9]{1,3}\s*-\s*(?:[0-9]{1,3}\.){3}[0-9]{1,3}/) {
      push(@parentRange, $line);
    }
    # Parent Range IPv6 (ARIN only)
    if ($line =~ /\(NET6-(?:[0-9a-fA-F]{1,4}\-){1,}[0-9a-fA-F]{1,4}\) $IPv6_re - $IPv6_re/) {
      push(@parentRange, $line);
    }
    # Range IPv6
    if ($line =~ /(?:inetnum|inet6num|NetRange):\s*([0-9A-Fa-f\:]+\s*-\s*[0-9A-Fa-f\:]+)/i) {
      $tempNewISP{"type-$i"}  = 'IPv6';
      $tempNewISP{"range-$i"} = $1;
      $c2++;
    }
    # CIDR (necessary for IPv6, optional for IPv4)
    if ($line =~ /(?:CIDR|inet6num):\s*((?:[0-9A-Fa-f\:]+\/\d{1,3}))/i) {
      $tempNewISP{"type-$i"} = 'IPv6';
      $tempNewISP{"cidr-$i"} = $1;
      $c3++;
    }
    push(@tempNWData, "$line\n") if $startPre;
    # End of <pre>...</pre>, if correspond to Network Whois data, keep it
    if ($line =~ /<\/pre>/) {
      $startPre = 0;
      if ($last) {
        $newISPs{$last} = join('', @tempNWData);
        $last = '';
      }
      # If country hasn't been found, use GeoIP?
      if ($tempNewISP{"type-$i"} and
          ((($tempNewISP{"type-$i"} eq 'IPv4' and ($tempNewISP{"range-$i"} or $tempNewISP{"cidr-$i"})) or # Range IPv4
            ($tempNewISP{"type-$i"} eq 'IPv6' and $tempNewISP{"cidr-$i"})) and                            # Range IPv6
           ($tempNewISP{"provider-$i"} or $tempNewISP{"descr-$i"})         and                            # Description
           !exists($tempNewISP{"country-$i"}))) {                                                         # No country
        if (my $geoIPDB = $winConfig->tfGeoIPDB->Text()) { # GeoIP database exists
          if (my $reader = GeoIP2::Database::Reader->new(file => $geoIPDB, locales => ['en'])) {
            # Convert CIDR if necessary
            $tempNewISP{"range-$i"} = &CIDR2Range($tempNewISP{"cidr-$i"}) if $tempNewISP{"cidr-$i"} and !$tempNewISP{"range-$i"};
            my $range_s = (split(/ - /, $tempNewISP{"range-$i"}))[0];
            my $record;
            eval { $record = $reader->city(ip => $range_s) };
            if (!$@) {
              $tempNewISP{"country-$i"} = $record->country()->iso_code() if $record->country()->iso_code();
              $tempNewISP{"date-$i"} = $dateFile if !exists($tempNewISP{"date-$i"});
              my $ISP2add = &formatISP(\%tempNewISP, $i);
              $newISPs{unidecode($ISP2add)} = join('', @tempNWData);
            }
          }
        }
      } else { @tempNWData = (); } # Empty temp storage
    }
    # Process the first ISP (if all necessary details have been found)
    if ($tempNewISP{"type-$i"} and
        ((($tempNewISP{"type-$i"} eq 'IPv4' and ($tempNewISP{"range-$i"} or $tempNewISP{"cidr-$i"})) or # Range IPv4
          ($tempNewISP{"type-$i"} eq 'IPv6' and $tempNewISP{"cidr-$i"})) and                            # Range IPv6
         ($tempNewISP{"provider-$i"} or $tempNewISP{"descr-$i"})         and                            # Description
         $tempNewISP{"country-$i"})) {                                                                  # Country
      # Convert CIDR if necessary
      $tempNewISP{"range-$i"} = &CIDR2Range($tempNewISP{"cidr-$i"}) if $tempNewISP{"cidr-$i"} and !$tempNewISP{"range-$i"};
      # If parent ISP is the same, keep the major range, keep both if different
      my $j = 0;
      my %parent;
      foreach my $parent (@parentRange) {
        my $tmpISP;
        my $tmpDesc;
        $tmpISP  = quotemeta($tempNewISP{"provider-$i"})  if $tempNewISP{"provider-$i"};
        $tmpDesc = quotemeta($tempNewISP{"descr-$i"})     if $tempNewISP{"descr-$i"};
        # If the same
        if (($tmpISP and $parent =~ /$tmpISP/i) or ($tmpDesc and $parent =~ /$tmpDesc/i)) {
          if ($parent =~ /((?:[0-9]{1,3}\.){3}[0-9]{1,3}) - ((?:[0-9]{1,3}\.){3}[0-9]{1,3})/) { # IPv4
            my $IpStartParentRange          = $1;
            my $IpEndParentRange            = $2;
            my $IpStartIntParentRange       = unpack 'N', pack 'C4', split '\.', $IpStartParentRange;
            my $IpEndIntParentRange         = unpack 'N', pack 'C4', split '\.', $IpEndParentRange;
            my ($IpStartRange, $IpEndRange) = split(/ ?\- ?/, $tempNewISP{"range-$i"});
            my $IpStartIntRange             = unpack 'N', pack 'C4', split '\.', $IpStartRange;
            my $IpEndIntRange               = unpack 'N', pack 'C4', split '\.', $IpEndRange;
            my $compRange                   = &inRange($IpStartIntRange, $IpEndIntRange, $IpStartIntParentRange, $IpEndIntParentRange);
            $tempNewISP{"range-$i"}         = "$IpStartParentRange - $IpEndParentRange" if $compRange == 1;
          } elsif ($parent =~ /($IPv6_re) - ($IPv6_re)/) {                                      # IPv6
            my $IpStartParentRange          = $1;
            my $IpEndParentRange            = $2;
            my $range_sObj                  = NetAddr::IP::Lite->new6($IpStartParentRange);
            my $range_eObj                  = NetAddr::IP::Lite->new6($IpEndParentRange);
            my ($IpStartRange, $IpEndRange) = split(/ ?\- ?/, $tempNewISP{"range-$i"});
            my $range_s2cmpObj              = NetAddr::IP::Lite->new6($IpStartRange);
            my $range_e2cmpObj              = NetAddr::IP::Lite->new6($IpEndRange);
            my $range_sInt                  = $range_sObj->bigint();
            my $range_eInt                  = $range_eObj->bigint();
            my $range_s2cmpInt              = $range_s2cmpObj->bigint();
            my $range_e2cmpInt              = $range_e2cmpObj->bigint();
            my $compRange                   = &inRange($range_sInt, $range_eInt, $range_s2cmpInt, $range_e2cmpInt);
            $tempNewISP{"range-$i"}         = "$IpStartParentRange - $IpEndParentRange" if $compRange == 1;
          }
        # If different
        } else {
          if ($parent =~ /(.+) \(NET[^\)]+\) ((?:[0-9]{1,3}\.){3}[0-9]{1,3}) - ((?:[0-9]{1,3}\.){3}[0-9]{1,3})/) {
            $parent{"type-$j"}     = 'IPv4';
            $parent{"range-$j"}    = "$2-$3";
            $parent{"provider-$j"} = $1;
            $parent{"country-$j"}  = $tempNewISP{"country-$i"};
            if ($tempNewISP{"date-$i"}) { $parent{"date-$j"} = $tempNewISP{"date-$i"}; }
            else                        { $parent{"date-$j"} = $dateFile;              }
            my $parentISP = &formatISP(\%parent, $j);
            $newISPs{$parentISP} = 1;
            $j++;
          } elsif ($parent =~ /(.+) \(NET6-(?:[0-9a-fA-F]{1,4}\-){1,}[0-9a-fA-F]{1,4}\) ($IPv6_re) - ($IPv6_re)/) {
            $parent{"type-$j"}     = 'IPv6';
            $parent{"range-$j"}    = "$2-$3";
            $parent{"provider-$j"} = $1;
            $parent{"country-$j"}  = $tempNewISP{"country-$i"};
            if ($tempNewISP{"date-$i"}) { $parent{"date-$j"} = $tempNewISP{"date-$i"}; }
            else                        { $parent{"date-$j"} = $dateFile;              }
            my $parentISP = &formatISP(\%parent, $j);
            $newISPs{$parentISP} = 1;
            $j++;
          }
        }
      }
      # Build new entries
      if ((($tempNewISP{"type-$i"} eq 'IPv4' and $tempNewISP{"range-$i"}) or
           ($tempNewISP{"type-$i"} eq 'IPv6' and $tempNewISP{"cidr-$i"})) and
          ($tempNewISP{"provider-$i"} or $tempNewISP{"descr-$i"}) and $tempNewISP{"country-$i"}) {
        $tempNewISP{"date-$i"} = $dateFile if !exists($tempNewISP{"date-$i"});
        my $ISP2add = &formatISP(\%tempNewISP, $i);
        $newISPs{unidecode($ISP2add)} = 1 if !exists($newISPs{unidecode($ISP2add)});
        $last = $ISP2add;
      }
      # Reset counter
      $i++;
      $c1 = 0; $c2 = 0; $c3 = 0; $c4 = 0;
    }
  }
  return(\%newISPs);
  
}  #--- End extractISPData

#--------------------------#
sub extractISPDataRDAP
#--------------------------#
{
  # Local variables
  my $refAnswer = shift;
  my $date      = &time2DateLong(time);
  my $i         = 1;
  my %newISPs;
  my %countries = (
    'Andorra' => 'AD',
    'United Arab Emirates' => 'AE',
    'Afghanistan' => 'AF',
    'Antigua and Barbuda' => 'AG',
    'Anguilla' => 'AI',
    'Albania' => 'AL',
    'Armenia' => 'AM',
    'Angola' => 'AO',
    'Antarctica' => 'AQ',
    'Argentina' => 'AR',
    'American Samoa' => 'AS',
    'Austria' => 'AT',
    'Australia' => 'AU',
    'Aruba' => 'AW',
    'land Islands' => 'AX',
    'Azerbaijan' => 'AZ',
    'Bosnia and Herzegovina' => 'BA',
    'Barbados' => 'BB',
    'Bangladesh' => 'BD',
    'Belgium' => 'BE',
    'Burkina Faso' => 'BF',
    'Bulgaria' => 'BG',
    'Bahrain' => 'BH',
    'Burundi' => 'BI',
    'Benin' => 'BJ',
    'Saint Barthlemy' => 'BL',
    'Bermuda' => 'BM',
    'Brunei Darussalam' => 'BN',
    'Bolivia (Plurinational State of)' => 'BO',
    'Bonaire, Sint Eustatius and Saba' => 'BQ',
    'Brazil' => 'BR',
    'Bahamas' => 'BS',
    'Bhutan' => 'BT',
    'Bouvet Island' => 'BV',
    'Botswana' => 'BW',
    'Belarus' => 'BY',
    'Belize' => 'BZ',
    'Canada' => 'CA',
    'Cocos (Keeling) Islands' => 'CC',
    'Congo, Democratic Republic of the' => 'CD',
    'Central African Republic' => 'CF',
    'Congo' => 'CG',
    'Switzerland' => 'CH',
    "Cte d'Ivoire" => 'CI',
    'Cook Islands' => 'CK',
    'Chile' => 'CL',
    'Cameroon' => 'CM',
    'China' => 'CN',
    'Colombia' => 'CO',
    'Costa Rica' => 'CR',
    'Cuba' => 'CU',
    'Cabo Verde' => 'CV',
    'Curaao' => 'CW',
    'Christmas Island' => 'CX',
    'Cyprus' => 'CY',
    'Czechia' => 'CZ',
    'Germany' => 'DE',
    'Djibouti' => 'DJ',
    'Denmark' => 'DK',
    'Dominica' => 'DM',
    'Dominican Republic' => 'DO',
    'Algeria' => 'DZ',
    'Ecuador' => 'EC',
    'Estonia' => 'EE',
    'Egypt' => 'EG',
    'Western Sahara' => 'EH',
    'Eritrea' => 'ER',
    'Spain' => 'ES',
    'Ethiopia' => 'ET',
    'Finland' => 'FI',
    'Fiji' => 'FJ',
    'Falkland Islands (Malvinas)' => 'FK',
    'Micronesia (Federated States of)' => 'FM',
    'Faroe Islands' => 'FO',
    'France' => 'FR',
    'Gabon' => 'GA',
    'United Kingdom of Great Britain and Northern Ireland' => 'GB',
    'Grenada' => 'GD',
    'Georgia' => 'GE',
    'French Guiana' => 'GF',
    'Guernsey' => 'GG',
    'Ghana' => 'GH',
    'Gibraltar' => 'GI',
    'Greenland' => 'GL',
    'Gambia' => 'GM',
    'Guinea' => 'GN',
    'Guadeloupe' => 'GP',
    'Equatorial Guinea' => 'GQ',
    'Greece' => 'GR',
    'South Georgia and the South Sandwich Islands' => 'GS',
    'Guatemala' => 'GT',
    'Guam' => 'GU',
    'Guinea-Bissau' => 'GW',
    'Guyana' => 'GY',
    'Hong Kong' => 'HK',
    'Heard Island and McDonald Islands' => 'HM',
    'Honduras' => 'HN',
    'Croatia' => 'HR',
    'Haiti' => 'HT',
    'Hungary' => 'HU',
    'Indonesia' => 'ID',
    'Ireland' => 'IE',
    'Israel' => 'IL',
    'Isle of Man' => 'IM',
    'India' => 'IN',
    'British Indian Ocean Territory' => 'IO',
    'Iraq' => 'IQ',
    'Iran (Islamic Republic of)' => 'IR',
    'Iceland' => 'IS',
    'Italy' => 'IT',
    'Jersey' => 'JE',
    'Jamaica' => 'JM',
    'Jordan' => 'JO',
    'Japan' => 'JP',
    'Kenya' => 'KE',
    'Kyrgyzstan' => 'KG',
    'Cambodia' => 'KH',
    'Kiribati' => 'KI',
    'Comoros' => 'KM',
    'Saint Kitts and Nevis' => 'KN',
    "Korea (Democratic People's Republic of)" => 'KP',
    'Korea, Republic of' => 'KR',
    'Kuwait' => 'KW',
    'Cayman Islands' => 'KY',
    'Kazakhstan' => 'KZ',
    "Lao People's Democratic Republic" => 'LA',
    'Lebanon' => 'LB',
    'Saint Lucia' => 'LC',
    'Liechtenstein' => 'LI',
    'Sri Lanka' => 'LK',
    'Liberia' => 'LR',
    'Lesotho' => 'LS',
    'Lithuania' => 'LT',
    'Luxembourg' => 'LU',
    'Latvia' => 'LV',
    'Libya' => 'LY',
    'Morocco' => 'MA',
    'Monaco' => 'MC',
    'Moldova, Republic of' => 'MD',
    'Montenegro' => 'ME',
    'Saint Martin (French part)' => 'MF',
    'Madagascar' => 'MG',
    'Marshall Islands' => 'MH',
    'Macedonia, the former Yugoslav Republic of' => 'MK',
    'Mali' => 'ML',
    'Myanmar' => 'MM',
    'Mongolia' => 'MN',
    'Macao' => 'MO',
    'Northern Mariana Islands' => 'MP',
    'Martinique' => 'MQ',
    'Mauritania' => 'MR',
    'Montserrat' => 'MS',
    'Malta' => 'MT',
    'Mauritius' => 'MU',
    'Maldives' => 'MV',
    'Malawi' => 'MW',
    'Mexico' => 'MX',
    'Malaysia' => 'MY',
    'Mozambique' => 'MZ',
    'Namibia' => 'NA',
    'New Caledonia' => 'NC',
    'Niger' => 'NE',
    'Norfolk Island' => 'NF',
    'Nigeria' => 'NG',
    'Nicaragua' => 'NI',
    'Netherlands[note 1]' => 'NL',
    'Norway' => 'NO',
    'Nepal' => 'NP',
    'Nauru' => 'NR',
    'Niue' => 'NU',
    'New Zealand' => 'NZ',
    'Oman' => 'OM',
    'Panama' => 'PA',
    'Peru' => 'PE',
    'French Polynesia' => 'PF',
    'Papua New Guinea' => 'PG',
    'Philippines' => 'PH',
    'Pakistan' => 'PK',
    'Poland' => 'PL',
    'Saint Pierre and Miquelon' => 'PM',
    'Pitcairn' => 'PN',
    'Puerto Rico' => 'PR',
    'Palestine, State of' => 'PS',
    'Portugal' => 'PT',
    'Palau' => 'PW',
    'Paraguay' => 'PY',
    'Qatar' => 'QA',
    'Runion' => 'RE',
    'Romania' => 'RO',
    'Serbia' => 'RS',
    'Russian Federation' => 'RU',
    'Rwanda' => 'RW',
    'Saudi Arabia' => 'SA',
    'Solomon Islands' => 'SB',
    'Seychelles' => 'SC',
    'Sudan' => 'SD',
    'Sweden' => 'SE',
    'Singapore' => 'SG',
    'Saint Helena, Ascension and Tristan da Cunha' => 'SH',
    'Slovenia' => 'SI',
    'Svalbard and Jan Mayen' => 'SJ',
    'Slovakia' => 'SK',
    'Sierra Leone' => 'SL',
    'San Marino' => 'SM',
    'Senegal' => 'SN',
    'Somalia' => 'SO',
    'Suriname' => 'SR',
    'South Sudan' => 'SS',
    'Sao Tome and Principe' => 'ST',
    'El Salvador' => 'SV',
    'Sint Maarten (Dutch part)' => 'SX',
    'Syrian Arab Republic' => 'SY',
    'Eswatini' => 'SZ',
    'Turks and Caicos Islands' => 'TC',
    'Chad' => 'TD',
    'French Southern Territories' => 'TF',
    'Togo' => 'TG',
    'Thailand' => 'TH',
    'Tajikistan' => 'TJ',
    'Tokelau' => 'TK',
    'Timor-Leste' => 'TL',
    'Turkmenistan' => 'TM',
    'Tunisia' => 'TN',
    'Tonga' => 'TO',
    'Turkey' => 'TR',
    'Trinidad and Tobago' => 'TT',
    'Tuvalu' => 'TV',
    'Taiwan, Province of China[note 2]' => 'TW',
    'Tanzania, United Republic of' => 'TZ',
    'Ukraine' => 'UA',
    'Uganda' => 'UG',
    'United States Minor Outlying Islands' => 'UM',
    'United States of America' => 'US',
    'Uruguay' => 'UY',
    'Uzbekistan' => 'UZ',
    'Holy See' => 'VA',
    'Saint Vincent and the Grenadines' => 'VC',
    'Venezuela (Bolivarian Republic of)' => 'VE',
    'Virgin Islands (British)' => 'VG',
    'Virgin Islands (U.S.)' => 'VI',
    'Viet Nam' => 'VN',
    'Vanuatu' => 'VU',
    'Wallis and Futuna' => 'WF',
    'Samoa' => 'WS',
    'Yemen' => 'YE',
    'Mayotte' => 'YT',
    'South Africa' => 'ZA',
    'Zambia' => 'ZM',
    'Zimbabwe' => 'ZW',
  );
  while (exists($$refAnswer{"networkInfos$i"}) and $$refAnswer{"networkInfos$i"}) {
    my $json = parse_json($$refAnswer{"networkInfos$i"});
    my $newISP = 'IP';
    if ($$json{ipVersion} and $$json{startAddress} and $$json{endAddress}) {
      $newISP     .= $$json{ipVersion} . "\t";
      # For IPv4, store start and end IP addresses of the range
      my $startIP  = (split(/\//, $$json{startAddress}))[0];
      my $endIP    = (split(/\//, $$json{endAddress}))[0];
      if ($$json{ipVersion} eq 'v4') { $newISP .= "$startIP\t$endIP\t"; }
      # For IPv6, store CIDR notation
      else {
        my $cidr = Net::CIDR::range2cidr("$startIP\-$endIP");
        $newISP .= "$cidr\tNULL\t";
      }
      # Find the registrant and the country
      my $country;
      my $orgName;
      $country = uc($$json{country}) if exists($$json{country}) and $$json{country}; # RIPE, AfriNIC, APNIC and LACNIC
      $orgName = $$json{name}        if exists($$json{name})    and $$json{name};    # RIPE, ARIN, APNIC and LACNIC
      # Name is in remarks (RIPE and APNIC)
      if (($$refAnswer{"networkAuth$i"} eq 'RIPE' or $$refAnswer{"networkAuth$i"} eq 'APNIC') and exists($$json{remarks})) {
        my $remark = $$json{remarks}[0];
        $orgName   = $$remark{description}[0] if exists($$remark{description}) and $$remark{description};
        if ($orgName and $country) { # For RIPE and APNIC
          $newISP .= "$orgName\t$country\t$date";
          $newISPs{$newISP} = $$refAnswer{"networkInfos$i"};
          return(\%newISPs);
        }
      }
      # Find the registrant or administrative in entities
      if (exists($$json{entities})) {
        foreach my $entity (@{$$json{entities}}) {
          # Roles
          if (exists($$entity{roles})) {
            foreach my $role (@{$$entity{roles}}) {
              if ($role eq 'registrant') { # Registrant
                if (exists($$entity{vcardArray})) {
                  foreach my $vcard (@{$$entity{vcardArray}[1]}) {
                    if ($$refAnswer{"networkAuth$i"} eq 'ARIN' and $$vcard[0] eq 'adr') { # For ARIN, the country must be parsed from vcard
                      if ($$vcard[1]{label} and $$vcard[1]{label} =~ /\n([^\n]+)$/) {
                        $country = $countries{$1} if exists($countries{$1}) and $countries{$1};
                      }
                    } elsif ($$vcard[0] eq 'fn') { $orgName = $$vcard[3]; }
                  }
                }
                if ($orgName and $country) { # For ARIN and LACNIC
                  $newISP .= "$orgName\t$country\t$date";
                  $newISPs{$newISP} = $$refAnswer{"networkInfos$i"};
                  return(\%newISPs);
                }
              } elsif ($role eq 'administrative') { # Afrinic
                if (exists($$entity{vcardArray})) {
                  foreach my $vcard (@{$$entity{vcardArray}[1]}) {
                    $orgName = $$vcard[3] if $$vcard[0] eq 'fn';
                    if ($orgName and $country) { # For Afrinic
                      $newISP .= "$orgName\t$country\t$date";
                      $newISPs{$newISP} = $$refAnswer{"networkInfos$i"};
                      return(\%newISPs);
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
    $i++;
  }
  return(undef);
  
}  #--- End extractISPDataRDAP

#--------------------------#
sub inRange
#--------------------------#
{
  # Local variables
  my($ipIntStart1, $ipIntEnd1, $ipIntStart2, $ipIntEnd2) = @_; # Parameters ex.: 24.37.0.0, 24.37.255.255, 24.37.63.0, 24.37.63.255
  my $results; # 0 = range1 == range2, 1 = range1 in range2, 2 = range2 in range1, 3 = Ranges are different
  # Check if range1 == range2
  if    (($ipIntStart1 == $ipIntStart2) and ($ipIntEnd1   == $ipIntEnd2)) { return(0); }
  # Check if range1 in range2
  elsif (($ipIntStart1 >= $ipIntStart2) and ($ipIntStart1 <= $ipIntEnd2) and
         ($ipIntEnd1   >= $ipIntStart2) and ($ipIntEnd1   <= $ipIntEnd2)) { return(1); }
  # Check if range2 in range1
  elsif (($ipIntStart2 >= $ipIntStart1) and ($ipIntStart2 <= $ipIntEnd1) and
         ($ipIntEnd2   >= $ipIntStart1) and ($ipIntEnd2   <= $ipIntEnd1)) { return(2); }
  # Ranges are different
  else { return(3); }
    
}  #--- End inRange

#--------------------------#
sub CIDR2Range
#--------------------------#
{
  # Local variables
  my ($range) = shift;
  # Convert range from CIDR to IP range
  # Ipv4: Ex.: 123.123/16 to 123.123.0.0 - 123.123.255.255
  if ($range =~ /(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){0,3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\/[0-9]{1,2}/) {
    my($refIp, $mask) = split(/\//, $range);
    my($range_s, $range_e) = split(/\-/, (Net::CIDR::cidr2range($range))[0]);
    while ($range_s !~ /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}/) { $range_s .= '.0';   }
    while ($range_e !~ /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}/) { $range_e .= '.255'; }
    return("$range_s - $range_e") if $range_s and $range_e;
  # Ipv6: Ex.: 2804:d50::/28 to 
  } elsif ($range =~ /$IPv6_re\/[0-9]{1,3}/) {
    my($refIp, $mask) = split(/\//, $range);
    my($range_s, $range_e) = split(/\-/, (Net::CIDR::cidr2range($range))[0]);
    while ($range_e =~ /:$/) { chop($range_e); }
    while ($range_e !~ /^(?:[0-9a-fA-F]{0,4}\:){7}[0-9a-fA-F]{1,4}/) { $range_e .= ':ffff'; }
    return("$range_s - $range_e") if $range_s and $range_e;
  }

}  #--- End CIDR2Range

#--------------------------#
sub formatISP
#--------------------------#
{
  # Local variables
  my ($refISP, $ind) = @_;
  my $newISP; # Ex.: IPv4\t123.123.0.0\t123.123.255.255\tProvider\tCountry\tDate
              # Ex.: IPv6\t2001:568::/29\tNULL\tProvider\tCountry\tDate
  # Format entry
  $newISP = $$refISP{"type-$ind"}; # Type: IPv4 or IPv6
  # IPv4
  if ($$refISP{"type-$ind"} eq 'IPv4') {
    $$refISP{"range-$ind"} =~ s/ //g;
    my ($ipStart, $ipEnd) = split(/\-/, $$refISP{"range-$ind"});
    $newISP .= "\t"."$ipStart\t$ipEnd";    # Range for IPv4
  # IPv6
  } else {
    if (!$$refISP{"cidr-$ind"}) {
      my ($ipStart, $ipEnd) = split(/\-/, $$refISP{"range-$ind"});
      my $cidr = Net::CIDR::range2cidr("$ipStart\-$ipEnd");
      $$refISP{"cidr-$ind"} = $cidr;
    }
    $newISP .= "\t".$$refISP{"cidr-$ind"}; # CIDR for IPv6
    $newISP .= "\t".'NULL';
  }
  if ($$refISP{"provider-$ind"}) {
    $$refISP{"provider-$ind"} =~ s/&amp;/&/g;
    $$refISP{"provider-$ind"} =~ s/&quot;/\"/g;
    while ($$refISP{"provider-$ind"} =~ / $/) { chop($$refISP{"provider-$ind"}); }
    $newISP .= "\t".$$refISP{"provider-$ind"}; # Provider
  } elsif ($$refISP{"descr-$ind"}) {
    $$refISP{"descr-$ind"}        =~ s/&amp;/&/g;
    $$refISP{"descr-$ind"}        =~ s/&quot;/\"/g;
    while ($$refISP{"descr-$ind"} =~ / $/) { chop($$refISP{"descr-$ind"});       }
    $newISP .= "\t".$$refISP{"descr-$ind"};    # If no provider, descr
  }
  $newISP .= "\t".$$refISP{"country-$ind"}; # Country
  $newISP .= "\t".$$refISP{"date-$ind"};    # Date
  return($newISP);

}  #--- End formatISP

#--------------------------#
sub checkISP_IPv4
#--------------------------#
{
  # Local variables
  my ($refDbh, $ipStart, $ipEnd) = @_;
  my $ipStartInt = unpack 'N', pack 'C4', split '\.', $ipStart;
  my $ipEndInt   = unpack 'N', pack 'C4', split '\.', $ipEnd;
  my $response;
  # Check range in the database
  # Database: table = WHOIS_DB, Fields = range_s, range_e, isp, country, date
  my $sth = $$refDbh->prepare("SELECT range_s,range_e,isp,country,date from WHOIS_DB
                              WHERE $ipStartInt == range_s AND $ipEndInt == range_e");
  my $rv  = $sth->execute();
  Win32::GUI::MessageBox($win, $STR{'Error'}.' '.STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010) if $rv < 0;
  while(my @row = $sth->fetchrow_array()) {
    my $ipStart = join '.', unpack 'C4', pack 'N', $row[0];
    my $ipEnd   = join '.', unpack 'C4', pack 'N', $row[1];
    my $dateStr = &time2DateLong($row[4]);
    $response .= "IPv4\t$ipStart\t$ipEnd\t$row[2]\t$row[3]\t$dateStr";
  }
  return($response);
  
}  #--- End checkISP_IPv4

#--------------------------#
sub checkISP_IPv6
#--------------------------#
{
  # Local variables
  my $refDbh = shift;
  my $cidr   = shift;
  my $response;
  # Check range in the database
  # Database: table = WHOIS_DB_6, Fields = ipv6_range, isp, country, date
  my $sth = $$refDbh->prepare("SELECT ipv6_range,isp,country,date from WHOIS_DB_6 WHERE ipv6_range == ?");
  my $rv  = $sth->execute(uc($cidr));
  Win32::GUI::MessageBox($win, $STR{'Error'}.' '.STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010) if $rv < 0;
  while(my @row = $sth->fetchrow_array()) {
    my $dateStr = &time2DateLong($row[3]);
    $response .= "IPv6\t$cidr\t$row[1]\t$row[2]\t$dateStr";
  }
  return($response);
  
}  #--- End checkISP_IPv6

#--------------------------#
sub newerISP
#--------------------------#
{
  # Local variables
  my ($newISP, $response) = @_;
  # If no date, consider as older
  return(1) if !(split(/\t/, $response))[5];
  return(0) if !(split(/\t/, $newISP))[5];
  # Date format 2019-01-01
  my ($dateNewISP) = (split(/\t/, $newISP))[5];
  my ($dateOld)    = (split(/\t/, $response))[5];
  # Convert to unixtime
  my $time1 = str2time($dateNewISP);
  my $time2 = str2time($dateOld);
  # Compare
  if ($time1 <= $time2) { return(0); } # $newISP is older or equal
  else                  { return(1); } # $newISP is newer

}  #--- End newerISP

#--------------------------#
sub modifyISP
#--------------------------#
{
  # Local variables
  my ($refDbh, $refISP2add) = @_;
  # Fields ($refISP2add): 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
  # Modify entry in IPv4 database
  if ($$refISP2add[0] eq 'IPv4') {
    # Database: table = WHOIS_DB, Fields = range_s, range_e, isp, country, date
    my $ipStart    = $$refISP2add[1];
    my $ipEnd      = $$refISP2add[2];
    my $ipStartInt = unpack 'N', pack 'C4', split '\.', $ipStart;
    my $ipEndInt   = unpack 'N', pack 'C4', split '\.', $ipEnd;
    my $isp        = $$refISP2add[3];
    my $country    = $$refISP2add[4];
    my $dateStr    = $$refISP2add[5];
    my $time       = str2time($dateStr);
    my $sth = $$refDbh->prepare("UPDATE WHOIS_DB SET isp = ?, country = ?, date = ?
                                WHERE $ipStartInt == range_s AND $ipEndInt == range_e");
    my $rv = $sth->execute($isp, $country, $time);
    if ($rv < 0) {
      Win32::GUI::MessageBox($win, $STR{'Error'}.' '.STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010);
      return(0);
    } else { return(1); }
  # Modify entry in IPv6 database
  } elsif ($$refISP2add[0] eq 'IPv6') {
    # Database: table = WHOIS_DB_6, Fields = ipv6_range, isp, country, date
    my $ipv6_range = $$refISP2add[1];
    my $isp        = $$refISP2add[3];
    my $country    = $$refISP2add[4];
    my $dateStr    = $$refISP2add[5];
    my $time       = str2time($dateStr);
    my $sth = $$refDbh->prepare("UPDATE WHOIS_DB_6 SET isp = ?, country = ?, date = ? WHERE ipv6_range == ?");
    my $rv = $sth->execute($isp, $country, $time, uc($ipv6_range));
    if ($rv < 0) {
      Win32::GUI::MessageBox($win, $STR{'Error'}.' '.STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010);
      return(0);
    } else { return(1); }
  }

}  #--- End modifyISP

#--------------------------#
sub modifyISPGrid
#--------------------------#
{
  # Local variables
  my ($refISP2add) = @_;
  # Fields ($refISP2add): 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
  # Find the older ISP in Grid and modify it
  if ($$refISP2add[0] eq 'IPv4') {
    for (my $i = 1; $i < $winDB->DBGrid->GetRows(); $i++) {
      my $range_s = $winDB->DBGrid->GetCellText($i, 0);
      my $range_e = $winDB->DBGrid->GetCellText($i, 1);
      if (($$refISP2add[1] eq $range_s) and ($$refISP2add[2] eq $range_e)) {
        $winDB->DBGrid->SetCellText($i, 2, $$refISP2add[3]);
        $winDB->DBGrid->SetCellText($i, 3, $$refISP2add[4]);
        $winDB->DBGrid->SetCellText($i, 4, $$refISP2add[5]);
        return($i);
      }
    }
  } elsif ($$refISP2add[0] eq 'IPv6') {
    my ($ipStart, $ipEnd) = split(/\-/, (Net::CIDR::cidr2range($$refISP2add[1]))[0]);
    for (my $i = $winDB->DBGrid->GetRows(); $i > 1; $i--) {
      my $range_s = $winDB->DBGrid->GetCellText($i, 0);
      my $range_e = $winDB->DBGrid->GetCellText($i, 1);
      if (($ipStart eq $range_s) and ($ipEnd eq $range_e)) {
        $winDB->DBGrid->SetCellText($i, 2, $$refISP2add[3]);
        $winDB->DBGrid->SetCellText($i, 3, $$refISP2add[4]);
        $winDB->DBGrid->SetCellText($i, 4, $$refISP2add[5]);
        return($i);
      }
    }
  }

}  #--- End modifyISPGrid

#--------------------------#
sub deleteISP_IPv4
#--------------------------#
{
  # Local variables
  my ($refDbh, $ipStart, $ipEnd) = @_;
  my $ipStartInt = unpack 'N', pack 'C4', split '\.', $ipStart;
  my $ipEndInt   = unpack 'N', pack 'C4', split '\.', $ipEnd;
  my $response;
  # Delete entry in DB
  # Database: table = WHOIS_DB, Fields = range_s, range_e, isp, country, date
  my $sth = $$refDbh->prepare("DELETE from WHOIS_DB where $ipStartInt == range_s AND $ipEndInt == range_e");
  my $rv = $sth->execute();
  if ($rv < 0) {
    Win32::GUI::MessageBox($win, $STR{'Error'}.' '.STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010);
    return(0);
  } else { return(1); }
  
}  #--- End deleteISP_IPv4

#--------------------------#
sub deleteISP_IPv6
#--------------------------#
{
  # Local variables
  my ($refDbh, $ipStart, $ipEnd) = @_;
  my $cidr = Net::CIDR::range2cidr("$ipStart\-$ipEnd");
  my $response;
  # Delete entry in DB
  # Database: table = WHOIS_DB_6, Fields = ipv6_range, isp, country, date
  my $sth = $$refDbh->prepare("DELETE from WHOIS_DB_6 WHERE ipv6_range == ?");
  my $rv  = $sth->execute(uc($cidr));
  if ($rv < 0) {
    Win32::GUI::MessageBox($win, $STR{'Error'}.' '.STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010);
    return(0);
  } else { return(1); }
  
}  #--- End deleteISP_IPv6

#--------------------------#
sub deleteISPGrid
#--------------------------#
{
  # Local variables
  my ($noRow, $ipStart, $ipEnd) = @_;
  # Find the ISP in grid and delete
  for (my $i = $noRow; $i < $winDB->DBGrid->GetRows(); $i++) {
    my $range_s = $winDB->DBGrid->GetCellText($i, 0);
    if ($ipStart eq $range_s) {
      my $range_e = $winDB->DBGrid->GetCellText($i, 1);
      if ($ipEnd eq $range_e) {
        $winDB->DBGrid->DeleteRow($i);
        last;
      }
    }
  }

}  #--- End deleteISPGrid

#--------------------------#
sub addISP
#--------------------------#
{
  # Local variables
  my ($refDbh, $refNewISP) = @_;
  # Fields ($refNewISP): 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
  # Add entry in IPv4 database
  if ($$refNewISP[0] eq 'IPv4') {
    # Database: table = WHOIS_DB, Fields = range_s, range_e, isp, country, date
    my $sth = $$refDbh->prepare("insert into WHOIS_DB (range_s,range_e,isp,country,date) values(?,?,?,?,?)");
    my $ipStart    = $$refNewISP[1];
    my $ipEnd      = $$refNewISP[2];
    my $ipStartInt = unpack 'N', pack 'C4', split '\.', $ipStart;
    my $ipEndInt   = unpack 'N', pack 'C4', split '\.', $ipEnd;
    my $isp        = $$refNewISP[3];
    my $country    = $$refNewISP[4];
    my $dateStr    = $$refNewISP[5];
    my $time       = str2time($dateStr);
    my $rv = $sth->execute($ipStartInt, $ipEndInt, $isp, $country, $time);
    if ($rv < 0) {
      Win32::GUI::MessageBox($win, $STR{'Error'}.' '.STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010);
      return(0);
    } else { return(1); }
  # Add entry in IPv6 database
  } elsif ($$refNewISP[0] eq 'IPv6') {
    # Database: table = WHOIS_DB_6, Fields = ipv6_range, isp, country, date
    my $sth = $$refDbh->prepare("insert into WHOIS_DB_6 (ipv6_range,isp,country,date) values(?,?,?,?)");
    my $ipv6_range = uc($$refNewISP[1]);
    my $isp        = $$refNewISP[3];
    my $country    = $$refNewISP[4];
    my $dateStr    = $$refNewISP[5];
    my $time       = str2time($dateStr);
    my $rv = $sth->execute($ipv6_range, $isp, $country, $time);
    if ($rv < 0) {
      Win32::GUI::MessageBox($win, $STR{'Error'}.' '.STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010);
      return(0);
    } else { return(1); }
  }

}  #--- End addISP

#--------------------------#
sub checkIP_WhoisDB_IPv4
#--------------------------#
{
  # Local variables
  my ($ip, $refDbh) = @_;
  my $ipInt = unpack 'N', pack 'C4', split '\.', $ip;
  my $isp;
  my $country;
  my $date;
  my $interMin = 4294967295;
  # Check if IP address fit any range in database
  my $sth = $$refDbh->prepare("SELECT range_s,range_e,isp,country,date from WHOIS_DB
                              WHERE $ipInt >= range_s AND $ipInt <= range_e");
  my $rv  = $sth->execute();
  Win32::GUI::MessageBox($win, $STR{'Error'}.' '.STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010) if $rv < 0;
  # Select the best answer (smaller range)
  my $refAllRows = $sth->fetchall_arrayref();
  foreach my $refRow (@{$refAllRows}) {
    my $inter = $$refRow[1] - $$refRow[0];
    if ($inter < $interMin) {
      $interMin = $inter;
      $isp     = $$refRow[2];
      $country = $$refRow[3];
      $date    = $$refRow[4];
    }
  }
  return($isp, $country, $date);

}  #--- End checkIP_WhoisDB_IPv4

#--------------------------#
sub checkIP_WhoisDB_IPv6
#--------------------------#
{
  # Local variables
  my ($ip, $refDbh) = @_;
  # Check if IP address fit any range in database
  my $all = $$refDbh->selectall_arrayref("SELECT * FROM WHOIS_DB_6");
  foreach my $row (@$all) {
    my $cidr = @$row[0];
    return(@$row[1], @$row[2], @$row[3]) if Net::CIDR::cidrlookup($ip, ($cidr));
  }

}  #--- End checkIP_WhoisDB_IPv6

#--------------------------#
sub checkRange_WhoisDB_IPv4
#--------------------------#
{
  # Local variables
  my ($ip, $refDbh) = @_;
  my $ipInt = unpack 'N', pack 'C4', split '\.', $ip;
  my $range_s;
  my $range_e;
  my $interMin = 4294967295;
  # Check if IP address fit any range in database
  my $sth = $$refDbh->prepare("SELECT range_s,range_e from WHOIS_DB
                              WHERE $ipInt >= range_s AND $ipInt <= range_e");
  my $rv  = $sth->execute();
  Win32::GUI::MessageBox($win, $STR{'Error'}.' '.STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010) if $rv < 0;
  # Select the best answer (smaller range)
  my $refAllRows = $sth->fetchall_arrayref();
  foreach my $refRow (@{$refAllRows}) {
    my $inter = $$refRow[1] - $$refRow[0];
    if ($inter < $interMin) {
      $interMin = $inter;
      $range_s = join '.', unpack 'C4', pack 'N', $$refRow[0];
      $range_e = join '.', unpack 'C4', pack 'N', $$refRow[1];
    }
  }
  if ($range_s and $range_e) { return($range_s, $range_e); }
  else                       { return(undef   , undef);    }

}  #--- End checkRange_WhoisDB_IPv4

#--------------------------#
sub checkRange_WhoisDB_IPv6
#--------------------------#
{
  # Local variables
  my ($ip, $refDbh) = @_;
  # Check if IP address fit any range in database
  my $all = $$refDbh->selectall_arrayref("SELECT ipv6_range FROM WHOIS_DB_6");
  foreach my $row (@$all) {
    my $cidr = @$row[0];
    if (Net::CIDR::cidrlookup($ip, ($cidr))) {
      my ($range_s, $range_e) = split(/\-/, (Net::CIDR::cidr2range($cidr))[0]);
      return($range_s, $range_e);
    }
  }
  return(undef, undef); # Not found

}  #--- End checkRange_WhoisDB_IPv6

#--------------------------#
sub addISPGrid
#--------------------------#
{
  # Local variables
  my ($refNewISP) = @_;
  # Fields ($refNewISP): 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
  # Add entry in grid
  if (my $newLine = $winDB->DBGrid->InsertRow($$refNewISP[0], -1)) {
    my ($start, $end);
    if ($$refNewISP[0] eq 'IPv6') { ($start, $end) = split(/\-/, (Net::CIDR::cidr2range($$refNewISP[1]))[0]); }
    else                          { $start = $$refNewISP[1]; $end = $$refNewISP[2]; }
    $winDB->DBGrid->SetCellText($newLine, 0, $start);
    $winDB->DBGrid->SetCellText($newLine, 1, $end);
    $winDB->DBGrid->SetCellText($newLine, 2, $$refNewISP[3]);
    $winDB->DBGrid->SetCellText($newLine, 3, $$refNewISP[4]);
    $winDB->DBGrid->SetCellText($newLine, 4, $$refNewISP[5]);
    return($newLine);
  } else { Win32::GUI::MessageBox($win, $STR{'errCreating'}.$STR{'newLineGrid'}, $STR{'Error'}, 0x40010); }
  
}  #--- End addISPGrid

#--------------------------#
sub DBGrid_Click
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  $LISTNO = 1;
  if (!$row) {
    threads->create(sub {
      $winDB->DBGrid->SetHeaderSort();
      my $order = $winDB->DBGrid->GetSortAscending();
      my $statusBarText = $winDB->statusBar->Text();
      $winDB->statusBar->Text($STR{'sortProgress'}.'...');
      if   ($column > 1) { $winDB->DBGrid->SortCells($column, $order, \&sortLC); }
      else               { $winDB->DBGrid->SortCells($column, $order, \&sortIP); }
      $winDB->DBGrid->Refresh();
      $winDB->statusBar->Text($statusBarText);
    });
  }
  return(1);

}  #--- End DBGrid_Click

#--------------------------#
sub DBGrid_RClick
#--------------------------#
{
  ($ROW, $COLUMN) = @_;
  my ($X, $Y) = Win32::GUI::GetCursorPos();
  $winDB->TrackPopupMenu($GridPopupMenu->{GridMenu},$X, $Y);
  return(1);

}  #--- End DBGrid_RClick

#--------------------------#
sub DBGrid_DblClick
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  if ($row) {
    # Reset fields
    $winNWP->tfRangeStart->Text('');
    $winNWP->tfRangeEnd->Text('');
    $winNWP->tfCIDR->Text('');
    $winNWP->tfISP->Text('');
    $winNWP->tfCountry->Text('');
    $winNWP->tfDate->Text('');
    $winNWP->tfNWGeoIP->Text(''); 
    $winNWP->tfNWData->Text('');
    $winNWP->btnSaveNWP->Disable();
    # Gather details in the selected line
    my ($range_s, $range_e, $isp, $country, $date);
    $range_s = $winDB->DBGrid->GetCellText($row, 0);
    $range_e = $winDB->DBGrid->GetCellText($row, 1);
    $isp     = $winDB->DBGrid->GetCellText($row, 2);
    $country = $winDB->DBGrid->GetCellText($row, 3);
    $date    = $winDB->DBGrid->GetCellText($row, 4);
    my @cidrs = Net::CIDR::range2cidr("$range_s\-$range_e");
    $winNWP->tfRangeStart->Text($range_s);
    $winNWP->tfRangeEnd->Text($range_e);
    $winNWP->tfCIDR->Text(join(', ', @cidrs));
    $winNWP->tfISP->Text($isp);
    $winNWP->tfCountry->Text($country);
    $winNWP->tfDate->Text($date);
    $winNWP->tfEntryLine->Text($row);
    $winNWP->btnSaveNWP->Disable();
    # Replace not allowed characters for windows filename (IPv6)
    if ($range_s =~ /\:/) {
      $range_s =~ s/\:/_/g;
      $range_e =~ s/\:/_/g;
    }
    # Show GeoIP details
    if (my $range_s = $winNWP->tfRangeStart->Text() and my $geoIPDB = $winConfig->tfGeoIPDB->Text()) {
      my %response;
      &getGeoIPData($range_s, $range_s, 1, \%response, $geoIPDB);
      $response{'geoIP1'} =~ s/\n/\r\n/g;
      $response{'geoIP1'} =~ s/\t/:\t/g;
      $response{'geoIP1'} =~ s/$STR{'Country'}:/$STR{'Country'}:\t/g;
      $response{'geoIP1'} =~ s/$STR{'Region'}:/$STR{'Region'}:\t/g;
      $response{'geoIP1'} =~ s/$STR{'City'}:/$STR{'City'}:\t/g;
      $response{'geoIP1'} .= "\r\nThis product includes GeoLite2 data created by MaxMind, available from https://www.maxmind.com.";
      $winNWP->tfNWGeoIP->Text($response{'geoIP1'});
    }
    # If Network Whois Data exist, show it
    if ($range_s and $range_e) {
      my $networkWhoisDataFile = "$CONFIG{'WHOIS_DATA_CACHE'}\\$range_s\-$range_e\.txt";
      if (-T $networkWhoisDataFile) {
        open(FILE, $networkWhoisDataFile) or Win32::GUI::MessageBox($winDB, $STR{'errReading'}.$!, $STR{'Error'}, 0x40010);
        my @networkWhoisData = <FILE>;
        close(FILE);
        my $data;
        @networkWhoisData = split(/\r/, $networkWhoisData[0]) if scalar(@networkWhoisData) < 2;
        foreach my $line (@networkWhoisData) { $line =~ s/[\r\n]//g; $data .= "$line\r\n"; }
        if ($data =~ /^{/) {
          my %response;
          $response{'networkInfos1'} = $data;
          $data = '';
          &addNWJSON(\$data, \%response, 1);
          $data =~ s/\n/\r\n/g;
          $winNWP->tfNWData->Text($data);
        } else { $winNWP->tfNWData->Text($data); }
      }
    }
    $winNWP->Center($winDB);
    $winNWP->Show();
  }
  return(1);

}  #--- End DBGrid_RClick

#--------------------------#
sub showNWData_Click
#--------------------------#
{
  # Get first selected row
  &DBGrid_DblClick(($winDB->DBGrid->GetSelectedCellRange())[0], 0);
  return(1);

}  #--- End showNWData_Click

#--------------------------#
sub winNWP_Resize
#--------------------------#
{
  $winNWP->tfRangeStart->Width(($winNWP->ScaleWidth()/2)-160);
  $winNWP->tfRangeEnd->Width(($winNWP->ScaleWidth()/2)-160);
  $winNWP->tfCIDR->Width(($winNWP->ScaleWidth()/2)-160);
  $winNWP->tfISP->Width(($winNWP->ScaleWidth()/2)-160);
  $winNWP->btnSaveNWP->Left(($winNWP->ScaleWidth()/4)-40);
  $winNWP->lblNWGeoIP->Left(($winNWP->ScaleWidth()/2)+10);
  $winNWP->tfNWGeoIP->Left(($winNWP->ScaleWidth()/2)+10);
  $winNWP->tfNWGeoIP->Width(($winNWP->ScaleWidth()/2)-15);
  $winNWP->tfNWData->Resize( $winNWP->ScaleWidth()-12, $winNWP->ScaleHeight()-330);
  $winNWP->btnGetNWData->Top($winNWP->ScaleHeight()-33);
  return(1);

}  #--- End winNWP_Resize

#--------------------------#
sub addISP_Click
#--------------------------#
{
  $winNWP->tfRangeStart->Text('');
  $winNWP->tfRangeEnd->Text('');
  $winNWP->tfCIDR->Text('');
  $winNWP->tfISP->Text('');
  $winNWP->tfCountry->Text('');
  $winNWP->tfDate->Text('');
  $winNWP->tfNWGeoIP->Text('');
  $winNWP->tfNWData->Text('');
  $winNWP->tfEntryLine->Text('');
  $winNWP->btnSaveNWP->Disable();
  $winNWP->Center($winDB);
  $winNWP->Show();
  
}  #--- End addISP_Click

#--------------------------#
sub tfRangeStart_Change { &isISPReady; }
sub tfRangeEnd_Change   { &isISPReady; }
sub tfISP_Change        { &isISPReady; }
sub tfCountry_Change    { &isISPReady; }
#--------------------------#

#--------------------------#
sub isISPReady
#--------------------------#
{
  # Local variables
  my $startIP = $winNWP->tfRangeStart->Text();
  my $endIP   = $winNWP->tfRangeEnd->Text();
  my $isp     = $winNWP->tfISP->Text();
  my $country = $winNWP->tfCountry->Text();
  if (($startIP =~ /^((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))$/ and
       $endIP   =~ /^((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))$/) or
     ($startIP =~ /^$IPv6_re$/ and $endIP =~ /^$IPv6_re$/)) {
    $winNWP->btnGetNWData->Enable();
    my @cidrs = Net::CIDR::range2cidr("$startIP\-$endIP");
    $winNWP->tfCIDR->Text(join(', ', @cidrs));
    if ($isp and $country =~ /^[a-zA-Z]{2}$/) { $winNWP->btnSaveNWP->Enable();  }
    else                                      { $winNWP->btnSaveNWP->Disable(); }
  } else {
    $winNWP->btnSaveNWP->Disable();
    $winNWP->btnGetNWData->Disable();
  }
  
}  #--- End isISPReady

#--------------------------#
sub btnSaveNWP_Click
#--------------------------#
{
  # Local variables
  my $startIP = $winNWP->tfRangeStart->Text();
  my $endIP   = $winNWP->tfRangeEnd->Text();
  my $isp     = $winNWP->tfISP->Text();
  my $country = $winNWP->tfCountry->Text();
  my $dateStr = time2DateLong(time);
  my $whoisDB = $winConfig->tfDbFile->Text();
  # Prepare entry
  my @newISP;
  if    ($startIP =~ /\./) { @newISP = ('IPv4', $startIP, $endIP, $isp, $country, $dateStr); } # IPv4
  elsif ($startIP =~ /\:/) { # IPv6
    my $cidr = Net::CIDR::range2cidr("$startIP\-$endIP");
    @newISP = ('IPv6', $cidr, 'NULL', $isp, $country, $dateStr);
  }
  # Connect to DB
  my $dsn = "DBI:SQLite:dbname=$whoisDB";
  if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
    # Check if ISP already exists
    my $response;
    if    ($startIP =~ /\./) { $response = &checkISP_IPv4(\$dbh, $newISP[1], $newISP[2]); }
    elsif ($startIP =~ /\:/) { $response = &checkISP_IPv6(\$dbh, $newISP[1]); }
    # Fields($response): 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
    if ($response) {
      # ISP exists, modify it
      if (my $return = &modifyISP(\$dbh, \@newISP)) { # Modify in database
        &modifyISPGrid(\@newISP);                     # Modify in grid
        $winDB->DBGrid->AutoSizeColumns();
        $winDB->DBGrid->ExpandColumnsToFit(0);
        $winDB->DBGrid->Refresh();
        $winNWP->tfDate->Text($dateStr);
        $winNWP->btnSaveNWP->Disable();
        Win32::GUI::MessageBox($winNWP, $STR{'ISPModified'}, $STR{'winDB'}, 0x40040);
      } else { Win32::GUI::MessageBox($winNWP, $STR{'errUpdatingDB'}.$DBI::errstr, $STR{'winDB'}, 0x40010); }
    } else {
      # ISP does not exist, add it
      if (my $return = &addISP(\$dbh, \@newISP)) {
        &addISPGrid(\@newISP); # Add ISP to grid
        # Update Status bar
        my $nbrISP = $winDB->DBGrid->GetRows() - 1;
        $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP");
        # Refresh grid
        $winDB->DBGrid->AutoSizeColumns();
        $winDB->DBGrid->ExpandColumnsToFit(0);
        $winDB->DBGrid->SetListMode();
        $winDB->DBGrid->ScrollPos(1,0);
        $winDB->DBGrid->SortCells(0, 1, \&sortIP);
        $winDB->DBGrid->Refresh();
        $winNWP->tfDate->Text($dateStr);
        $winNWP->btnSaveNWP->Disable();
        Win32::GUI::MessageBox($winNWP, $STR{'ISPAdded'}, $STR{'winDB'}, 0x40040);
      } else { Win32::GUI::MessageBox($winNWP, $STR{'errUpdatingDB'}.$DBI::errstr, $STR{'winDB'}, 0x40010); }
    }
    $dbh->disconnect();
  } else { Win32::GUI::MessageBox($winDB, $STR{'errConnectingDB'}.$DBI::errstr, $STR{'winDB'}, 0x40010); }
  return(1);  
  
}  #--- End btnSaveNWP_Click

#--------------------------#
sub btnGetNWData_Click
#--------------------------#
{
  if (my $range_s = $winNWP->tfRangeStart->Text() and my $range_e = $winNWP->tfRangeEnd->Text()) {
    $winNWP->tfNWData->Text('');
    $THR = threads->create(sub {
      # Thread 'cancellation' signal handler
      $SIG{'KILL'} = sub {
        $win->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        threads->exit();
      };
      # Thread 'die' signal handler
      $SIG{__DIE__} = sub {
        my $errMsg = (split(/ at /,$_[0]))[0];
        chomp($errMsg);
        $errMsg =~ s/[\t\r\n]/ /g;
        $win->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'Error'}, 0x40010);
      };
      # Turn on progress bar
      $winPb->Center($winNWP);
      $winPb->Show();
      $winPb->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
      $winNWP->Disable();
      $winNWP->ChangeCursor($HOURGLASS);
      # Progress bar
      $winPb->pbWinPb->SetRange(0, 3);
      $winPb->pbWinPb->SetPos(0);
      $winPb->pbWinPb->SetStep(1);
      # Load IPv4 and IPv6
      my %IPv4; # IPv4 Database
      my %IPv6; # IPv6 Database
      if ($winConfig->rbNWModeNormal->Checked()) { # Mode WHOIS
        &loadIPv4DB(\%IPv4)      if $CONFIG{'IPv4_DB_FILE'} and -T $CONFIG{'IPv4_DB_FILE'};
        &loadIPv6DB(\%IPv6)      if $CONFIG{'IPv6_DB_FILE'} and -T $CONFIG{'IPv6_DB_FILE'};
      } else {                                     # Mode RDAP
        &loadIPv4DB_RDAP(\%IPv4) if $CONFIG{'IPv4_DB_FILE'} and -T $CONFIG{'IPv4_DB_FILE'};
        &loadIPv6DB_RDAP(\%IPv6) if $CONFIG{'IPv6_DB_FILE'} and -T $CONFIG{'IPv6_DB_FILE'};
      }
      # Do the whois request
      my %response;
      $range_s           =~ s/ //g;
      $response{'query'} = $range_s;
      $response{'ip1'}   = $range_s;
      if ($winConfig->rbNWModeNormal->Checked()) { # Mode WHOIS
        &networkWhois(    $response{'query'}, 1, $range_s, \%response, \%IPv4, \%IPv6);
      } else {                                     # Mode RDAP
        &networkWhoisRDAP($response{'query'}, 1, $range_s, \%response, \%IPv4, \%IPv6);
      }
      $winPb->pbWinPb->StepIt();
      # Get local time
      my $dateStr    = &time2DateLong(time);
      my $dateOffset = gmt_offset();
      my $dateStrGMT = "$dateStr GMT $dateOffset";
      # Write the report
      my $return = &writeReport(\%response, $dateStrGMT, $winConfig->rbNWModeNormal->Checked());
      # Set report filename
      my $targetDir  = $winConfig->tfReportDir->Text();
      my $filename   = $range_s;
      $filename      =~ s/[\<\>\:\"\/\\\|\?\*]/_/g; # Replace unauthorized character by _
      my $reportPath =  "$targetDir\\$filename\.html";
      # Check if report already exists
      if (!$winConfig->chReplace->Checked()) {
        my $k = 1;
        while (-e $reportPath) {
          $k++;
          $reportPath = "$targetDir\\$filename req$k\.html";
        }
      }
      # Write report to file
      open(HTML, ">$reportPath") or Win32::GUI::MessageBox($win, $STR{'errWriting'}.' '.$STR{'report'}.': '.$!, $STR{'Error'}, 0x40010);
      flock(HTML, 2);
      print HTML $return;
      close(HTML);
      $winPb->pbWinPb->StepIt();
      # Feed whois database
      my $refExtractedISP;
      # Mode WHOIS
      if ($winConfig->rbNWModeNormal->Checked())  { $refExtractedISP = &extractISPData($reportPath);    }
      # Mode RDAP
      else                                        { $refExtractedISP = &extractISPDataRDAP(\%response); }
      $winPb->pbWinPb->StepIt();
      # Store and show the data
      my $lineInGrid  = undef;
      my $ispName     = $winNWP->tfISP->Text();
      $lineInGrid     = $winNWP->tfEntryLine->Text() if $winNWP->tfEntryLine->Text();
      my ($rangeFound, $ispDiff, @rangesFound) = &saveNWData($refExtractedISP, $range_e, $ispName, $lineInGrid);
      $winPb->pbWinPb->StepIt();
      # Turn off progress bar
      $winNWP->Enable();
      $winPb->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
      $winPb->pbWinPb->SetPos(0);
      &winPb_Terminate;
      $winNWP->ChangeCursor($ARROW);
      # Show message if no match found
      if (!$rangeFound) {
        my $text = $STR{'rangeNotFound'};
        if (scalar(@rangesFound)) {
          $text .= "\r\n$STR{'lblChoice'}:\r\n";
          foreach (@rangesFound) { $text .= "$_\r\n"; }
        }
        my $answer = Win32::GUI::MessageBox($win, $text . $STR{'ModifyIt'}, $STR{'NWData'}, 0x41024);
        if ($answer == 6) {
          # Save new range
          my @fields = split(/, /, $rangesFound[0]);
          my ($new_range_s, $new_range_e) = split(/\-/, shift(@fields));
          my $country = pop(@fields);
          my $isp     = join(',', @fields);
          $winNWP->tfRangeStart->Text($new_range_s);
          $winNWP->tfRangeEnd->Text($new_range_e);
          $winNWP->tfISP->Text($isp);
          $winNWP->tfCountry->Text($country);
          &btnSaveNWP_Click();
          $rangeFound = 0;
          # Add Network whois data for the new range
          foreach my $newISP (keys %{$refExtractedISP}) {
            if ($newISP =~ /$new_range_s\t$new_range_e/ and length($$refExtractedISP{$newISP}) > 2) {
              # Find line in grid for the new range
              my $newLineInGrid = 0;
              for (my $i = ($lineInGrid-10); $i < $winDB->DBGrid->GetRows(); $i++) {
                my $cmp_range_s = $winDB->DBGrid->GetCellText($i, 0);
                my $cmp_range_e = $winDB->DBGrid->GetCellText($i, 1);
                if ($new_range_s eq $cmp_range_s and $new_range_e eq $cmp_range_e) {
                  $newLineInGrid = $i;
                  last;
                }
              }
              if ($newLineInGrid) {
                ($rangeFound, $ispDiff, @rangesFound) = &saveNWData($refExtractedISP, $new_range_e, $isp, $newLineInGrid);
              }
            }
          }
          # Delete old range
          my $return;
          my $whoisDB = $winConfig->tfDbFile->Text();
          my $dsn = "DBI:SQLite:dbname=$whoisDB";
          my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 });
          if    ($range_s =~ /\./) { $return = &deleteISP_IPv4(\$dbh, $range_s, $range_e); } # Delete in Database (IPv4)
          elsif ($range_s =~ /\:/) { $return = &deleteISP_IPv6(\$dbh, $range_s, $range_e); } # Delete in Database (IPv6)
          $dbh->disconnect();
          if ($return) {
            &deleteISPGrid($lineInGrid, $range_s, $range_e); # Delete in Grid
            # Delete the Network Whois Data File
            my $networkWhoisDataFile = "$CONFIG{'WHOIS_DATA_CACHE'}\\$range_s\-$range_e\.txt";
            unlink($networkWhoisDataFile) if -e $networkWhoisDataFile;
          }
          $winDB->DBGrid->Refresh();
          if (!$rangeFound) { &btnGetNWData_Click(); }
        } else { $winNWP->tfNWData->Text($text); }
      } elsif ($ispDiff) {
        my $newISPName;
        foreach my $ispEntry (keys %{$refExtractedISP}) {
          my @fields = split(/\t/, $ispEntry);
          # Fields ($newISP): 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
          if ($fields[1] eq $range_s and $fields[2] eq $range_e) {
            $newISPName = $fields[3];
            last;
          }
        }
        if ($newISPName) {
          $winNWP->tfISP->Text($newISPName);
          my $dateStr = time2DateLong(time);
          $winNWP->tfDate->Text($dateStr);
          Win32::GUI::MessageBox($winNWP, $STR{'ISPDiff'}, $STR{'winDB'}, 0x40040);
        }
      }
    });
  }
  return(1);
  
}  #--- End btnGetNWData_Click

#--------------------------#
sub saveNWData
#--------------------------#
{
  # Local variables
  my ($refExtractedISP, $range_e, $isp, $lineInGrid) = @_;
  my @rangesFound;
  my $rangeFound = 0;
  my $ispDiff    = 0;
  foreach my $newISP (keys %{$refExtractedISP}) {
    if ($newISP) {
      my @fields = split(/\t/, $newISP);
      # Fields ($newISP): 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
      push(@rangesFound, "$fields[1]-$fields[2], $fields[3], $fields[4]");
      # If range is the same
      my $endRange;
      if ($fields[2] eq 'NULL' and $fields[1] =~ /\//) { # CIDR
        $endRange = (split(/ \- /, &CIDR2Range($fields[1])))[-1];
      } else { $endRange = $fields[2]; }
      if ($endRange eq $range_e) {
        my $networkWhoisDataFile = &storeNWData($fields[1], $fields[2], \$$refExtractedISP{$newISP}, $lineInGrid);
        $winNWP->tfRangeEnd->Text($endRange);
        if (-T $networkWhoisDataFile) {
          open(FILE, $networkWhoisDataFile) or Win32::GUI::MessageBox($winDB, $STR{'errReading'}.$!, $STR{'Error'}, 0x40010);
          my @networkWhoisData = <FILE>;
          close(FILE);
          my $data;
          @networkWhoisData = split(/\r/, $networkWhoisData[0]) if scalar(@networkWhoisData) < 2;
          foreach my $line (@networkWhoisData) { $line =~ s/[\r\n]//g; $data .= "$line\r\n"; }
          if ($data =~ /^{/) {
            my %response;
            $response{'networkInfos1'} = $data;
            $data = '';
            &addNWJSON(\$data, \%response, 1);
            $data =~ s/\n/\r\n/g;
            $winNWP->tfNWData->Text($data);
          } else { $winNWP->tfNWData->Text($data); }
        }
        $rangeFound++;
        $ispDiff++ if $isp ne $fields[3];
      }
    }
  }
  return($rangeFound, $ispDiff, @rangesFound);
  
}  #--- End saveNWData
  
#--------------------------#
sub winNWP_Terminate
#--------------------------#
{
  $winNWP->Hide();
  return(0);
  
}  #--- End winNWP_Terminate

#--------------------------#
sub filterOnSel_Click
#--------------------------#
{
  if ($ROW) {
    my $value         = $winDB->DBGrid->GetCellText($ROW, $COLUMN);
    my @fields        = ('StartIP', 'EndIP', 'ISP', 'Country', 'Date');
    my $newfilterStr  = "$fields[$COLUMN] == \"$value\"";
    my $currFilterStr = $winDB->tfFilterDB->Text();
    my $filterStr;
    # If a filter has already been set, keep current filter
    if ($currFilterStr) {
      $filterStr = "$currFilterStr && $newfilterStr";
    } else { $filterStr = $newfilterStr; }
    $winDB->tfFilterDB->Text($filterStr);
    &applyFilters();
  }
  return(1);

}  #--- End filterOnSel_Click

#--------------------------#
sub filterOnNotSel_Click
#--------------------------#
{
  if ($ROW) {
    my $sel = $winDB->DBGrid->GetCellText($ROW, $COLUMN);
    my $value         = $winDB->DBGrid->GetCellText($ROW, $COLUMN);
    my @fields        = ('StartIP', 'EndIP', 'ISP', 'Country', 'Date');
    my $newfilterStr  = "$fields[$COLUMN] != \"$value\"";
    my $currFilterStr = $winDB->tfFilterDB->Text();
    my $filterStr;
    # If a filter has already been set, keep current filter
    if ($currFilterStr) {
      $filterStr = "$currFilterStr && $newfilterStr";
    } else { $filterStr = $newfilterStr; }
    $winDB->tfFilterDB->Text($filterStr);
    &applyFilters();
  }
  return(1);

}  #--- End filterOnNotSel_Click

#--------------------------#
sub refreshISP_Click
#--------------------------#
{
  # Local variables
  my(@coord)  = $winDB->DBGrid->GetSelectedCellRange();
  if ($coord[0]) {
    # Push all selected starting IP in the clipboard
    my $toClipboard;
    my $lastSelectedRow; 
    if ($coord[2]) { $lastSelectedRow = $coord[2]; }
    else           { $lastSelectedRow = $coord[0]; }
    for (my $row = $coord[0]; $row <= $lastSelectedRow; $row++) {
      $toClipboard .= $winDB->DBGrid->GetCellText($row, 0) . "\r\n" if $winDB->DBGrid->IsCellSelected ($row, 0);
    }
    Win32::Clipboard::Set($toClipboard); # Push startIP in clipboard
    &btnWhois_Click; # Send whois
  }  

}  #--- End refreshISP_Click

#--------------------------#
sub getAllRanges_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) { Win32::GUI::MessageBox($win, $STR{'errProcessRun'},$STR{'Error'},0x40010); }
  else {
    # Get range of the selected entry
    my (@coord) = $winDB->DBGrid->GetSelectedCellRange();
    # Check if row contains Network Whois Data (single row only)
    if ($coord[0] and $coord[2] and $coord[0] == $coord[2]) {
      my $range_s = $winDB->DBGrid->GetCellText($coord[0], 0);
      my $range_e = $winDB->DBGrid->GetCellText($coord[0], 1);
      my $isp     = $winDB->DBGrid->GetCellText($coord[0], 2);
      my $country = $winDB->DBGrid->GetCellText($coord[0], 3);
      $THR = threads->create(sub {
        # Thread 'cancellation' signal handler
        $SIG{'KILL'} = sub {
          # Turn off progress bar
          $winPb->lblPbCurr->Text('');
          $winPb->lblCount->Text('');
          $winPb->pbWinPb->SetPos(0);
          $winPb->Hide();
          $winPb->ChangeCursor($ARROW);
          $winDB->Enable();
          threads->exit();
        };
        # Thread 'die' signal handler
        $SIG{__DIE__} = sub {
          my $errMsg = (split(/ at /,$_[0]))[0];
          chomp($errMsg);
          $errMsg =~ s/[\t\r\n]/ /g;
          # Turn off progress bar
          $winPb->lblPbCurr->Text('');
          $winPb->lblCount->Text('');
          $winPb->pbWinPb->SetPos(0);
          $winPb->Hide();
          $winPb->ChangeCursor($ARROW);
          $winDB->Enable();
          Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'Error'}, 0x40010);
        };
        # Reset window controls
        $winAddRanges->lblTitle->Text($STR{'Organisation'}.':');
        $winAddRanges->lblRangesOrgName->Show();
        $winAddRanges->lblRangesOrgNameVal->Show();
        $winAddRanges->lblRangesSource->Show();
        $winAddRanges->lblRangesSourceVal->Show();
        $winAddRanges->tsGetRanges->Show();
        $winAddRanges->tfGetRangesRoute->Show();
        $winAddRanges->rbGetRangesForm->Show();
        $winAddRanges->rbGetRangesTV->Show();
        $winAddRanges->rbGetRangesRaw->Show();
        $winAddRanges->lblShowRanges->Hide();
        $winAddRanges->cbShowRanges->Hide();
        $winAddRanges->btnRemNetNames->Hide();
        $winAddRanges->lblChoiceSel->Hide();
        $winAddRanges->cbChoiceSel->Hide();
        $winAddRanges->lblChoiceSel2->Hide();
        $winAddRanges->GridISPRanges->Hide();
        $winAddRanges->btnGetRangesPrev->Hide();
        $winAddRanges->btnAddRSelected->Hide();
        $winAddRanges->tsGetRanges->Reset();
        $winAddRanges->tsGetRanges->InsertItem(-text => $STR{'Route'});
        $winAddRanges->tfGetRangesOrg->Hide();
        $winAddRanges->tfGetRangesASN->Hide();
        $winAddRanges->tvGetRangesRoute->Hide();
        $winAddRanges->tvGetRangesOrg->Hide();
        $winAddRanges->tvGetRangesASN->Hide();
        $winAddRanges->tfGetRangesRouteRaw->Hide();
        $winAddRanges->tfGetRangesOrgRaw->Hide();
        $winAddRanges->tfGetRangesASNRaw->Hide();
        $winAddRanges->lblRangesOrgNameVal->Text('');
        $winAddRanges->lblRangesSourceVal->Text('');
        $winAddRanges->tfRangesORGVal->Text('');
        $winAddRanges->cbRangesASNVal->ResetContent();
        $winAddRanges->tfGetRangesRoute->Text('');
        $winAddRanges->tfGetRangesOrg->Text('');
        $winAddRanges->tfGetRangesASN->Text('');
        $winAddRanges->tvGetRangesRoute->Clear();
        $winAddRanges->tvGetRangesOrg->Clear();
        $winAddRanges->tvGetRangesASN->Clear();
        $winAddRanges->tfGetRangesRouteRaw->Text('');
        $winAddRanges->tfGetRangesOrgRaw->Text('');
        $winAddRanges->tfGetRangesASNRaw->Text('');
        $winAddRanges->rbGetRangesForm->Checked(1);
        $winAddRanges->rbGetRangesTV->Checked(0);
        $winAddRanges->rbGetRangesRaw->Checked(0);
        $winAddRanges->lblRangesASN->Text($STR{'ASN'}.':');
        # Turn on progress bar
        $winPb->Center($winDB);
        $winPb->Show();
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winDB->Disable();
        $winPb->ChangeCursor($HOURGLASS);
        # Progress bar
        $winPb->pbWinPb->SetRange(0, 3);
        $winPb->pbWinPb->SetPos(0);
        $winPb->pbWinPb->SetStep(1);
        # Identify registry
        $winPb->lblPbCurr->Text($STR{'identifyReg'}.'...');
        $winPb->pbWinPb->StepIt();
        my $registry = &getAuthority($range_s);
        # Send the advanced whois requests
        my ($return, $msg);
        ($return, $registry, $msg) = &getRelOrgARIN(  $range_s, $range_e) if $registry eq 'ARIN';
        ($return, $registry, $msg) = &getRelOrgRIPE(  $range_s, $range_e) if $registry eq 'RIPE' or $registry eq 'AFRINIC';
        ($return, $registry, $msg) = &getRelOrgLACNIC($range_s, $range_e) if $registry eq 'LACNIC';
        ($return, $registry, $msg) = &getRelOrgAPNIC( $range_s, $range_e) if $registry eq 'APNIC';
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        &winPb_Terminate;
        $winPb->ChangeCursor($ARROW);
        if (!$return and $msg and $msg ne 'Cancel') {
          Win32::GUI::MessageBox($winAddRanges, $msg, $STR{'Error'}, 0x40010);
        } else { # Show Window
          $winAddRanges->Resize($winAddRanges->Width()+50, $winAddRanges->Height()+50); # Stupid bug requires stupid trick...
          $winAddRanges->Center($winDB);
          $winAddRanges->Show();
        }
      });
    }
  }
  return(1);

}  #--- End getAllRanges_Click

#--------------------------#
sub getAuthority
#--------------------------#
{
  # Local variables
  my $range_s = shift;
  my %rirName = ( 'whois.arin.net'    => 'ARIN'   ,
                  'whois.ripe.net'    => 'RIPE'   ,
                  'whois.apnic.net'   => 'APNIC'  ,
                  'whois.krnic.net'   => 'KRNIC'  ,
                  'whois.lacnic.net'  => 'LACNIC' ,
                  'whois.afrinic.net' => 'AFRINIC', );
  my %IPv4; # IPv4 Database
  my %IPv6; # IPv6 Database
  # Complete IP
  if ($range_s =~ /\./) { while ($range_s !~ /(?:[0-9]{1,3}\.){3}[0-9]{1,3}/) { $range_s .= '.0';   } }
  # Find the registry
  &loadIPv4DB(\%IPv4) if $CONFIG{'IPv4_DB_FILE'} and -T $CONFIG{'IPv4_DB_FILE'};
  &loadIPv6DB(\%IPv6) if $CONFIG{'IPv6_DB_FILE'} and -T $CONFIG{'IPv6_DB_FILE'};
  my $whoisServer = &registry($range_s, \%IPv4, \%IPv6);
  $whoisServer    = 'whois.arin.net' if !$whoisServer;
  if ($rirName{$whoisServer}) {
    return($rirName{$whoisServer});
  } else { return(undef); }
  
}  #--- End getAuthority

#--------------------------#
sub getRelOrgARIN
#--------------------------#
{
  # Local variables
  my $range_s = shift;
  my $range_e = shift;
  # Create an agent
  my $ua = LWP::UserAgent->new;
  $ua->agent($CONFIG{'USERAGENT'});
  $ua->default_header('Accept-Language' => 'en', 'Accept' => 'application/json');
  # Gather details about the organisation
  my @cidrs = Net::CIDR::range2cidr("$range_s\-$range_e");
  my $cidr  = shift(@cidrs);
  $winPb->lblPbCurr->Text("ARIN: $STR{'SearchFor'} $cidr...");
  my $client = REST::Client->new(useragent => $ua, timeout => $CONFIG{'NSLOOKUP_TIMEOUT'}, follow => 1);
  $client->GET("http://whois.arin.net/rest/cidr/$cidr");
  if ($client->responseCode() eq '200' and $client->responseContent() and $client->responseContent() !~ /^Can't connect to/) {
    if ($client->responseContent() =~ /text="(ERROR[^\"]+)/) { return(0, 'ARIN', $1); }
    # Parse answer
    my $json = parse_json($client->responseContent());
    $cidr =~ s/\//%2F/;
    if ($winConfig->chRelRangeSearches->Checked()) {
      my $f_getAllRanges1 = "$CONFIG{'SEARCHES_CACHE'}\\$cidr route\.txt";
      open(FH_ALLRANGES1, ">$f_getAllRanges1");
      print FH_ALLRANGES1 $client->responseContent();
      close(FH_ALLRANGES1);
    }
    &ARIN_json2Text(\$winAddRanges->tfGetRangesRoute, $json);
    my $data = dump($json);
    $data    =~ s/\n/\r\n/g;
    $winAddRanges->tfGetRangesRouteRaw->Text($data);
    &json2Treeview(\$winAddRanges->tvGetRangesRoute, $json, 0);
    if (exists($$json{net})) {
      if (exists($$json{net}{netBlocks}) and exists($$json{net}{netBlocks}{netBlock})) {
        my $registry;
        if (ref($$json{net}{netBlocks}{netBlock}) eq "HASH" and exists($$json{net}{netBlocks}{netBlock}{description}) and
            exists($$json{net}{netBlocks}{netBlock}{description}{'$'}) and
            $$json{net}{netBlocks}{netBlock}{description}{'$'} =~ /(?:Allocated|Transferred) to (\w+)/) {
          $registry = $1;
        } elsif (ref($$json{net}{netBlocks}{netBlock}) eq "ARRAY" and exists(${$$json{net}{netBlocks}{netBlock}}[0]{description}) and
                 exists(${$$json{net}{netBlocks}{netBlock}}[0]{description}{'$'}) and 
                 ${$$json{net}{netBlocks}{netBlock}}[0]{description}{'$'} =~ /(?:Allocated|Transferred) to (\w+)/) {
          $registry = $1;
        }
        return(0, $registry, 'Wrong registry') if $registry and $registry ne 'ARIN'; # Authority is not ARIN
      }
      my @asns;
      if (exists($$json{net}{originASes}) and exists($$json{net}{originASes}{originAS})) {
        if (ref($$json{net}{originASes}{originAS}) eq 'ARRAY') {
          foreach (@{$$json{net}{originASes}{originAS}}) { push(@asns, $_->{'$'}); }
        } elsif (exists($$json{net}{originASes}{originAS}{'$'})) {
          push(@asns, $$json{net}{originASes}{originAS}{'$'});
        }
      }
      # If customer range, ask user what to do
      if (exists($$json{net}{customerRef})) {
        my $question  = $STR{'customerRange'};
        $question    .= ' ('.$$json{net}{parentNetRef}{'@name'}.')' if exists($$json{net}{parentNetRef}) and exists($$json{net}{parentNetRef}{'@name'});
        my $answer    = Win32::GUI::MessageBox($winDB, "$question?", $STR{'winAddRanges'}, 0x1023);
        if ($answer and $answer == 2 or $answer == 7) { # Cancel (2) or No (7)
          return(0, 'ARIN', 'Cancel');
        }
        # Answer is Yes (6), get the parent details
        if (exists($$json{net}{parentNetRef}{'$'}) and my $hrefParent = $$json{net}{parentNetRef}{'$'}) {
          $hrefParent =~ s/^https/http/;
          $client->GET($hrefParent);
          if ($client->responseCode() eq '200' and $client->responseContent() and $client->responseContent() !~ /^Can't connect to/) {
            if ($client->responseContent() =~ /text="(ERROR[^\"]+)/) { return(0, 'ARIN', $1); }
            $json = parse_json($client->responseContent());
            if ($winConfig->chRelRangeSearches->Checked()) {
              my $f_getAllRanges2 = "$CONFIG{'SEARCHES_CACHE'}\\$cidr parent\.txt";
              open(FH_ALLRANGES2, ">$f_getAllRanges2");
              print FH_ALLRANGES2 $client->responseContent();
              close(FH_ALLRANGES2);
            }
            $winAddRanges->tfGetRangesRoute->Text('');
            &ARIN_json2Text(\$winAddRanges->tfGetRangesRoute, $json);
            my $data = dump($json);
            $data    =~ s/\n/\r\n/g;
            $winAddRanges->tfGetRangesRouteRaw->Text($data);
            &json2Treeview(\$winAddRanges->tvGetRangesRoute, $json, 0);
          } else { return(0, 'ARIN', $STR{'errConnection'}.': '.$client->responseCode().' - '.$$client{_res}{_msg}); }
        } else { return(0, 'ARIN', $STR{'noASNorIDFound'}); }
      }
      $winPb->pbWinPb->StepIt();
      # This is an organisation range
      if (my $refOrg = $$json{net}{orgRef}) {
        my $nameORG = $$refOrg{'@name'}   if exists($$refOrg{'@name'}  ) and $$refOrg{'@name'};
        my $orgID   = $$refOrg{'@handle'} if exists($$refOrg{'@handle'}) and $$refOrg{'@handle'};
        my $hrefORG = $$refOrg{'$'}       if exists($$refOrg{'$'}       ) and $$refOrg{'$'};
        if ($nameORG and $hrefORG) {
          $hrefORG =~ s/^https/http/;
          $client->GET($hrefORG);
          $winPb->pbWinPb->StepIt();
          if ($client->responseCode() eq '200' and $client->responseContent() and $client->responseContent() !~ /^Can't connect to/) {
            if ($client->responseContent() =~ /text="(ERROR[^\"]+)/) { return(0, 'ARIN', $1); }
            $json = parse_json($client->responseContent());
            if ($winConfig->chRelRangeSearches->Checked()) {
              my $f_getAllRanges2 = "$CONFIG{'SEARCHES_CACHE'}\\$cidr org\.txt";
              open(FH_ALLRANGES2, ">$f_getAllRanges2");
              print FH_ALLRANGES2 $client->responseContent();
              close(FH_ALLRANGES2);
            }
            my $country = $$json{org}{'iso3166-1'}{code2}{'$'} if exists($$json{org}) and exists($$json{org}{'iso3166-1'}) and
                                                                  exists($$json{org}{'iso3166-1'}{code2}{'$'}) and $$json{org}{'iso3166-1'}{code2}{'$'};
            $nameORG .= ', ' . $country if $country;
            my $nameUTF8 = decode('utf8' , $nameORG);
            my $decName  = encode('cp1252', $nameUTF8);
            &setRelOrgDetails($decName, 'ARIN', $orgID, @asns);
            &ARIN_json2Text(\$winAddRanges->tfGetRangesOrg, $json);
            my $data = dump($json);
            $data    =~ s/\n/\r\n/g;
            $winAddRanges->tfGetRangesOrgRaw->Text($data);
            &json2Treeview(\$winAddRanges->tvGetRangesOrg, $json, 0);
            $winAddRanges->tsGetRanges->InsertItem(-text => $STR{'Org'});
            if (scalar(@asns)) { # Add ASN tab
              $client->GET('http://whois.arin.net/rest/asn/'.$asns[0]);
              if ($client->responseCode() eq '200' and $client->responseContent() and
                $client->responseContent() !~ /^Can't connect to/ and $client->responseContent() !~ /text="(ERROR[^\"]+)/) {
                $json = parse_json($client->responseContent());
                if ($winConfig->chRelRangeSearches->Checked()) {
                  my $f_getAllRanges2 = "$CONFIG{'SEARCHES_CACHE'}\\$cidr asn\.txt";
                  open(FH_ALLRANGES2, ">$f_getAllRanges2");
                  print FH_ALLRANGES2 $client->responseContent();
                  close(FH_ALLRANGES2);
                }
                $winAddRanges->tfGetRangesASN->Text('');
                $winAddRanges->tfGetRangesASNRaw->Text('');
                $winAddRanges->tvGetRangesASN->Clear();
                &ARIN_json2Text(\$winAddRanges->tfGetRangesASN, $json);
                my $data = dump($json);
                $data    =~ s/\n/\r\n/g;
                $winAddRanges->tfGetRangesASNRaw->Text($data);
                &json2Treeview(\$winAddRanges->tvGetRangesASN, $json, 0);
                $winAddRanges->tsGetRanges->InsertItem(-text => $STR{'ASN'});
              }
            }
            return(1, 'ARIN');
          } else { return(0, 'ARIN', $STR{'errConnection'}.': '.$client->responseCode().' - '.$$client{_res}{_msg}); }
        } else { return(0, 'ARIN', $STR{'noASNorIDFound'}); }
      } else { return(0, 'ARIN', $STR{'noASNorIDFound'}); }
    } else { return(0, 'ARIN', $STR{'noASNorIDFound'}); }
  } else { return(0, 'ARIN', $STR{'errConnection'}.': '.$client->responseCode().' - '.$$client{_res}{_msg}); }

}  #--- End getRelOrgARIN

#--------------------------#
sub getRelOrgRIPE
#--------------------------#
{
  # Local variables
  my $range_s = shift;
  my $range_e = shift;
  # Create an agent
  my $ua = LWP::UserAgent->new;
  $ua->agent($CONFIG{'USERAGENT'});
  $ua->default_header('Accept-Language' => 'en', 'Accept' => 'application/json');
  # Gather details about the organisation
  my @cidrs = Net::CIDR::range2cidr("$range_s\-$range_e");
  my $cidr  = shift(@cidrs);
  $winPb->lblPbCurr->Text("RIPE: $STR{'SearchFor'} $cidr...");
  my $client = REST::Client->new(useragent => $ua, timeout => $CONFIG{'NSLOOKUP_TIMEOUT'}, follow => 1);
  $cidr =~ s/\//%2F/;
  $client->GET("http://rest.db.ripe.net/search?type=route&query-string=$cidr");
  if ($client->responseCode() eq '200' and $client->responseContent() and $client->responseContent() !~ /^Can't connect to/) {
    if ($client->responseContent() =~ /text="(ERROR[^\"]+)/) { return(0, 'RIPE', $1); }
    # Parse answer
    my $json = parse_json($client->responseContent());
    if ($winConfig->chRelRangeSearches->Checked()) {
      my $f_getAllRanges1 = "$CONFIG{'SEARCHES_CACHE'}\\$cidr route\.txt";
      open(FH_ALLRANGES1, ">$f_getAllRanges1");
      print FH_ALLRANGES1 $client->responseContent();
      close(FH_ALLRANGES1);
    }
    &RIPE_json2Text(\$winAddRanges->tfGetRangesRoute, $json);
    my $data = dump($json);
    $data    =~ s/\n/\r\n/g;
    $winAddRanges->tfGetRangesRouteRaw->Text($data);
    &json2Treeview(\$winAddRanges->tvGetRangesRoute, $json, 0);
    if (exists($$json{netBlocks}) and exists($$json{netBlocks}{netBlock}) and exists($$json{netBlocks}{netBlock}{description}) and
        $$json{netBlocks}{netBlock}{description} =~ /(?:Allocated|Transferred) to (\w+)/) {
      return(0, $1, 'Wrong registry'); # Authority is not RIPE
    }
    my ($nameORG, $orgID, $asn);
    my $country = $$json{country} if exists($$json{country}) and $$json{country};
    foreach my $object (@{$$json{objects}{object}}) {
      if ($$object{type} eq 'organisation') {
        foreach my $attr (@{$$object{attributes}{attribute}}) {
          $nameORG = $$attr{value} if $$attr{name} eq 'org-name' and $$attr{value};
        }
      } elsif ($$object{type} eq 'route') {
        foreach my $attr (@{$$object{'primary-key'}{attribute}}) {
          $asn = $$attr{value} if $$attr{name} eq 'origin' and $$attr{value};
        }
      }
    }
    $winPb->pbWinPb->StepIt();
    if ($asn) {
      $winPb->lblPbCurr->Text("RIPE: $STR{'SearchFor'} $asn...");
      # Must get the organisation related to the ASN
      $client->GET("http://rest.db.ripe.net/search?query-string=$asn");
      if ($client->responseCode() eq '200' and $client->responseContent() and $client->responseContent() !~ /^Can't connect to/) {
        if ($client->responseContent() =~ /text="(ERROR[^\"]+)/) { return(0, 'RIPE', $1); }
        $json = parse_json($client->responseContent());
        if ($winConfig->chRelRangeSearches->Checked()) {
          my $f_getAllRanges2 = "$CONFIG{'SEARCHES_CACHE'}\\$cidr asn\.txt";
          open(FH_ALLRANGES2, ">$f_getAllRanges2");
          print FH_ALLRANGES2 $client->responseContent();
          close(FH_ALLRANGES2);
        }
        &RIPE_json2Text(\$winAddRanges->tfGetRangesASN, $json);
        my $data = dump($json);
        $data    =~ s/\n/\r\n/g;
        $winAddRanges->tfGetRangesASNRaw->Text($data);
        &json2Treeview(\$winAddRanges->tvGetRangesASN, $json, 0);
        $winAddRanges->tsGetRanges->InsertItem(-text => $STR{'ASN'});
        foreach my $object (@{$$json{objects}{object}}) {
          if ($$object{type} eq 'organisation') {
            foreach my $attr ((@{$$object{attributes}{attribute}})) {
              $nameORG = $$attr{value} if $$attr{name} eq 'org-name'     and $$attr{value};
              $orgID   = $$attr{value} if $$attr{name} eq 'organisation' and $$attr{value};
            }
          } elsif ($$object{type} eq 'aut-num') {
            my $descr;
            foreach my $attr ((@{$$object{attributes}{attribute}})) {
              if ($$attr{value}) {
                if ($$attr{name} eq 'as-name') {
                  $nameORG = $$attr{value};
                } elsif ($$attr{name} eq 'descr' and !$descr) {
                  $nameORG = $descr = $$attr{value};
                }
              }
            }
          }
        }
        $winPb->pbWinPb->StepIt();
        # Add country to orgname
        $nameORG .= ', ' . $country if $country and $nameORG;
        my $nameUTF8 = decode('utf8' , $nameORG);
        my $decName  = encode('cp1252', $nameUTF8);
        &setRelOrgDetails($nameORG, 'RIPE', $orgID, $asn);
        return(1, 'RIPE');
      } else { return(0, 'RIPE', $STR{'errConnection'}.': '.$client->responseCode().' - '.$$client{_res}{_msg}); }
    } else { return(0, 'RIPE', $STR{'noASNorIDFound'}); }
  } else { return(0, 'RIPE', $STR{'errConnection'}.': '.$client->responseCode().' - '.$$client{_res}{_msg}); }
  
}  #--- End getRelOrgRIPE

#--------------------------#
sub getRelOrgLACNIC
#--------------------------#
{
  # Local variables
  my $range_s = shift;
  my $range_e = shift;
  # Create an agent
  my $ua = LWP::UserAgent->new;
  $ua->agent($CONFIG{'USERAGENT'});
  $ua->default_header('Accept-Language' => 'en');
  # Gather details about the organisation
  my @cidrs = Net::CIDR::range2cidr("$range_s\-$range_e");
  my $cidr  = shift(@cidrs);
  $winPb->lblPbCurr->Text("LACNIC: $STR{'SearchFor'} $cidr...");
  my $client = REST::Client->new(useragent => $ua, timeout => $CONFIG{'NSLOOKUP_TIMEOUT'}, follow => 1);
  $client->GET("http://rdap.lacnic.net/rdap/ip/$cidr");
  if ($client->responseCode() eq '200' and $client->responseContent() and $client->responseContent() !~ /^Can't connect to/) {
    # Parse answer
    my $json = parse_json($client->responseContent());
    $cidr    =~ s/\//%2F/;
    if ($winConfig->chRelRangeSearches->Checked()) {
      my $f_getAllRanges1 = "$CONFIG{'SEARCHES_CACHE'}\\$cidr route\.txt";
      open(FH_ALLRANGES1, ">$f_getAllRanges1");
      print FH_ALLRANGES1 $client->responseContent();
      close(FH_ALLRANGES1);
    }
    &LACNIC_json2Text(\$winAddRanges->tfGetRangesRoute, $json);
    my $data = dump($json);
    $data    =~ s/\n/\r\n/g;
    $winAddRanges->tfGetRangesRouteRaw->Text($data);
    &json2Treeview(\$winAddRanges->tvGetRangesRoute, $json, 0);
    # Find the registrant or administrative in entities
    my $source  = 'LACNIC';
    my $asn;
    if (exists($$json{nicbr_autnum}) and $$json{nicbr_autnum}) {
      $asn    = $$json{nicbr_autnum};
      $source = 'NICBR';
    } elsif (exists($$json{originAutnum}) and $$json{originAutnum} and $$json{originAutnum} ne 'N/A') {
      $asn    = $$json{originAutnum};
    }
    my $country = $$json{country} if exists($$json{country}) and $$json{country};
    my ($nameORG, $orgID);
    if (exists($$json{entities})) {
      foreach my $entity (@{$$json{entities}}) {
        # Roles
        if (exists($$entity{roles})) {
          foreach my $role (@{$$entity{roles}}) {
            if ($role eq 'registrant') { # Registrant
              if (exists($$entity{vcardArray})) {
                foreach my $vcard (@{$$entity{vcardArray}[1]}) { $nameORG = $$vcard[3] if $$vcard[0] eq 'fn'; }
              }
              $orgID = $$entity{handle} if exists($$entity{handle}) and $$entity{handle};
              if (!$country and $orgID and $orgID =~ /(\w{2})\-/) { $country = $1; } # Get country initials from entity id
            } elsif ($role eq 'administrative') { # Administrative
              if (exists($$entity{vcardArray})) {
                foreach my $vcard (@{$$entity{vcardArray}[1]}) { $nameORG = $$vcard[3] if $$vcard[0] eq 'fn'; }
              }
              $orgID = $$entity{handle} if exists($$entity{handle}) and $$entity{handle};
              if (!$country and $orgID and $orgID =~ /(\w{2})\-/) { $country = $1; } # Get country initials from entity id
            }
          }
        }
      }
    }
    $winPb->pbWinPb->StepIt();
    if ($asn or $orgID) {
      $nameORG .= ', ' . $country if $country and $nameORG;
      my $nameUTF8 = decode('utf8' , $nameORG);
      my $decName  = encode('cp1252', $nameUTF8);
      &setRelOrgDetails($decName, $source, $orgID, $asn);
      return(1, $source);
    } else { return(0, $source, $STR{'noASNorIDFound'}); }
  } else { return(0, 'LACNIC', $STR{'errConnection'}.': '.$client->responseCode().' - '.$$client{_res}{_msg}); }
  
}  #--- End getRelOrgLACNIC

#--------------------------#
sub getRelOrgAPNIC
#--------------------------#
{
  # Local variables
  my $range_s = shift;
  my $range_e = shift;
  # Create an agent
  my $ua = LWP::UserAgent->new;
  $ua->agent($CONFIG{'USERAGENT'});
  $ua->default_header('Accept-Language' => 'en');
  # Gather details about the organisation
  my @cidrs = Net::CIDR::range2cidr("$range_s\-$range_e");
  my $cidr  = shift(@cidrs);
  $winPb->lblPbCurr->Text("APNIC: $STR{'SearchFor'} $cidr...");
  my $client = REST::Client->new(useragent => $ua, timeout => $CONFIG{'NSLOOKUP_TIMEOUT'}, follow => 1);
  $client->GET("http://wq.apnic.net/query?searchtext=$cidr");
  if ($client->responseCode() eq '200' and $client->responseContent() and $client->responseContent() !~ /^Can't connect to/) {
    # Parse answer
    my $json  = parse_json($client->responseContent());
    my $cidr2 = $cidr =~ s/\//%2F/r;
    if ($winConfig->chRelRangeSearches->Checked()) {
      my $f_getAllRanges1 = "$CONFIG{'SEARCHES_CACHE'}\\$cidr2 route\.txt";
      open(FH_ALLRANGES1, ">$f_getAllRanges1");
      print FH_ALLRANGES1 $client->responseContent();
      close(FH_ALLRANGES1);
    }
    &APNIC_json2Text(\$winAddRanges->tfGetRangesRoute, $json);
    my $data = dump($json);
    $data    =~ s/\n/\r\n/g;
    $winAddRanges->tfGetRangesRouteRaw->Text($data);
    &json2Treeview(\$winAddRanges->tvGetRangesRoute, $json, 0);
    # Find the registrant or administrative in entities
    my $source  = 'APNIC';
    my ($nameORG, $orgID, $asn, $adminC, $country);
    foreach my $part (@{$json}) {
      if (exists($$part{objectType}) and exists($$part{primaryKey})) {
        if ($$part{objectType} eq 'inetnum' and $$part{primaryKey} =~ /$range_e/ and $$part{primaryKey} =~ /$range_s/) { # Inetnum
          if (exists($$part{attributes})) {
            foreach my $attr (@{$$part{attributes}}) {
              $country = $$attr{values}[0]      if $$attr{name} eq 'country' and exists($$attr{values}) and $$attr{values}[0];
              $nameORG = $$attr{values}[0]      if !$nameORG and $$attr{name} eq 'descr' and exists($$attr{values}) and $$attr{values}[0];
              $orgID   = $$attr{values}[0]      if $$attr{name} eq 'org' and exists($$attr{values}) and $$attr{values}[0]; # Org if exists
              $adminC  = $$attr{links}[0]{text} if $$attr{name} eq 'admin-c' and exists($$attr{links}) and $$attr{links}[0]; # admin-c otherwise
              $source  = $$attr{values}[0]      if $$attr{name} eq 'source'  and exists($$attr{values}) and $$attr{values}[0];
            }
          }
        } elsif ($$part{objectType} eq 'organisation') { # Organisation
          if (exists($$part{attributes})) {
            foreach my $attr (@{$$part{attributes}}) {
              $country = $$attr{values}[0] if $$attr{name} eq 'country' and exists($$attr{values}) and $$attr{values}[0];
              $nameORG = $$attr{values}[0] if $$attr{name} eq 'org-name' and exists($$attr{values}) and $$attr{values}[0];
              $orgID   = $$attr{values}[0] if $$attr{name} eq 'organisation' and exists($$attr{values}) and $$attr{values}[0]; # Org if exists
              $source  = $$attr{values}[0] if $$attr{name} eq 'source'  and exists($$attr{values}) and $$attr{values}[0];
            }
          }
        } elsif ($$part{objectType} eq 'route' and $$part{primaryKey} =~ /$cidr/) { # route
          if (exists($$part{attributes})) {
            foreach my $attr (@{$$part{attributes}}) {
              # This one contain AS
              if ($$attr{name} eq 'origin' and exists($$attr{values}) and $asn = $$attr{values}[0]) {
                $winPb->lblPbCurr->Text("APNIC: $STR{'SearchFor'} $asn...");
                $client->GET("http://wq.apnic.net/query?searchtext=$asn");
                if ($client->responseCode() eq '200' and $client->responseContent() and $client->responseContent() !~ /^Can't connect to/) {
                  $json = parse_json($client->responseContent());
                  if ($winConfig->chRelRangeSearches->Checked()) {
                    my $f_getAllRanges2 = "$CONFIG{'SEARCHES_CACHE'}\\$cidr2 asn\.txt";
                    open(FH_ALLRANGES2, ">$f_getAllRanges2");
                    print FH_ALLRANGES2 $client->responseContent();
                    close(FH_ALLRANGES2);
                  }
                  &APNIC_json2Text(\$winAddRanges->tfGetRangesASN, $json);
                  my $data = dump($json);
                  $data    =~ s/\n/\r\n/g;
                  $winAddRanges->tfGetRangesASNRaw->Text($data);
                  &json2Treeview(\$winAddRanges->tvGetRangesASN, $json, 0);
                  $winAddRanges->tsGetRanges->InsertItem(-text => $STR{'ASN'});
                  $nameORG = '';
                  foreach my $part (@{$json}) {
                    if (exists($$part{objectType}) and exists($$part{primaryKey})) {
                      if ($$part{objectType} eq 'aut-num' and $$part{primaryKey} eq $asn) {
                        foreach my $attr (@{$$part{attributes}}) {
                          $country = $$attr{values}[0] if $$attr{name} eq 'country' and exists($$attr{values}) and $$attr{values}[0];
                          $nameORG = $$attr{values}[0] if !$nameORG and $$attr{name} eq 'descr' and exists($$attr{values}) and $$attr{values}[0];
                          $orgID   = $$attr{values}[0] if $$attr{name} eq 'org' and exists($$attr{values}) and $$attr{values}[0];
                          $source  = $$attr{values}[0] if $$attr{name} eq 'source'  and exists($$attr{values}) and $$attr{values}[0];
                        }
                      } elsif ($$part{objectType} eq 'organisation' and $$part{primaryKey} eq $asn or ($orgID and $$part{primaryKey} eq $orgID)) {
                        foreach my $attr (@{$$part{attributes}}) {
                          $country = $$attr{values}[0] if $$attr{name} eq 'country' and exists($$attr{values}) and $$attr{values}[0];
                          $nameORG = $$attr{values}[0] if $$attr{name} eq 'org-name' and exists($$attr{values}) and $$attr{values}[0];
                          $orgID   = $$attr{values}[0] if $$attr{name} eq 'organisation' and exists($$attr{values}) and $$attr{values}[0];
                          $source  = $$attr{values}[0] if $$attr{name} eq 'source'  and exists($$attr{values}) and $$attr{values}[0];
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
    # No organisation or origin found (only admin-c)
    if ($adminC and !$orgID and !$asn) {
      # Get details about admin-c (should be a person)
      foreach my $part (@{$json}) {
        if (exists($$part{objectType}) and exists($$part{primaryKey})) {
          if ($$part{objectType} eq 'person' and $$part{primaryKey} eq $adminC) { # Person
            if (exists($$part{attributes})) {
              foreach my $attr (@{$$part{attributes}}) {
                $country = $$attr{values}[0] if $$attr{name} eq 'country' and exists($$attr{values}) and $$attr{values}[0];
                $nameORG = $$attr{values}[0] if $$attr{name} eq 'person' and exists($$attr{values}) and $$attr{values}[0];
                $source  = $$attr{values}[0] if $$attr{name} eq 'source'  and exists($$attr{values}) and $$attr{values}[0];
              }
            }
          }
        }
      }
    }
    $winPb->pbWinPb->StepIt();
    if ($orgID or $adminC or $asn) {
      $nameORG .= ', ' . $country if $country and $nameORG;
      my $nameUTF8 = decode('utf8' , $nameORG);
      my $decName  = encode('cp1252', $nameUTF8);
      if ($adminC and !$asn) {
        $winAddRanges->lblRangesASN->Text($STR{'AdminC'}.':');
        $asn = $adminC;
      }
      &setRelOrgDetails($decName, $source, $orgID, $asn);
      return(1, $source);
    } else { return(0, $source, $STR{'noASNorIDFound'}); }
  } else { return(0, 'APNIC', $STR{'errConnection'}.': '.$client->responseCode().' - '.$$client{_res}{_msg}); }

}  #--- End getRelOrgAPNIC

#--------------------------#
sub setRelOrgDetails
#--------------------------#
{
  # Local variables
  my ($nameORG, $source, $orgID, @asns) = @_;
  # Set field values 
  $winAddRanges->lblRangesOrgNameVal->Text($nameORG) if $nameORG;
  $winAddRanges->lblRangesSourceVal->Text($source);
  if ($orgID) {
    $winAddRanges->lblRangesORG->Show();
    $winAddRanges->tfRangesORGVal->Show();
    $winAddRanges->tfRangesORGVal->Text($orgID);
    $winAddRanges->btnGetRangesORG->Show();
  } else {
    $winAddRanges->lblRangesORG->Hide();
    $winAddRanges->tfRangesORGVal->Hide();
    $winAddRanges->tfRangesORGVal->Text('');
    $winAddRanges->btnGetRangesORG->Hide();
  }
  if (scalar(@asns) > 1 or $asns[0]) {
    $winAddRanges->lblRangesASN->Show();
    $winAddRanges->cbRangesASNVal->Show();
    $winAddRanges->btnGetRangesASN->Show();
    foreach (@asns) { $winAddRanges->cbRangesASNVal->AddString($_) if $_; }
    $winAddRanges->cbRangesASNVal->SetCurSel(0);
  } else {
    $winAddRanges->lblRangesASN->Hide();
    $winAddRanges->cbRangesASNVal->Hide();
    $winAddRanges->btnGetRangesASN->Hide();
    $winAddRanges->cbRangesASNVal->ResetContent();
  }

}  #--- End setRelOrgDetails

#--------------------------#
sub ARIN_json2Text
#--------------------------#
{
  my ($refTF, $root) = @_;
  my $type;
  my @fields;
  if      (exists($$root{net})) {
    @fields = ('version', 'name', 'handle', 'startAddress', 'endAddress', 'ref', 'rdapRef', 'customerRef', 'orgRef',
               'parentNetRef', 'originASes', 'netBlocks', 'registrationDate', 'updateDate', '@xmlns', 'resources');
    $type = 'net';
  } elsif (exists($$root{org})) {
    @fields = ('name', 'handle', 'streetAddress', 'city', 'postalCode', 'iso3166-2', 'iso3166-1', 'ref', 'rdapRef',
               'registrationDate', 'updateDate', '@xmlns', 'resources');
    $type = 'org';
  } elsif (exists($$root{asn})) {
    @fields = ('name', 'handle', 'startAsNumber', 'endAsNumber', 'orgRef', 'ref', 'rdapRef',
               'registrationDate', 'updateDate', '@xmlns', 'resources');
    $type = 'asn';
  }
  if ($type and exists($$root{$type})) {
    $$refTF->Append("$type:\r\n");
    foreach my $field (@fields) {
      if (exists($$root{$type}{$field})) {
        $$refTF->Append("  $field:\r\n");
        &json2Text($refTF, $$root{$type}{$field}, 2);
        $$refTF->Append("\r\n") if $$refTF->Text() !~ /\r\n$/;
      }
    }
    foreach my $el (keys %{$$root{$type}}) {
      if ($el !~ /^(?:\@inaccuracyReportUrl|\@termsOfUse|\@copyrightNotice|name|handle|ref|rdapRef|registrationDate|updateDate|\@xmlns|resources)$/ and
          (($type eq 'net' and $el !~ /^(?:version|startAddress|endAddress|customerRef|orgRef|parentNetRef|originASes|netBlocks)$/) or
           ($type eq 'org' and $el !~ /^(?:streetAddress|city|postalCode|iso3166-2|iso3166-1)$/) or
           ($type eq 'asn' and $el !~ /^(?:startAsNumber|endAsNumber|orgRef)$/))) {
        $$refTF->Append("  $el:");
        &json2Text($refTF, $$root{$type}{$el}, 2);
        $$refTF->Append("\r\n") if $$refTF->Text() !~ /\r\n$/;
      }
    }
  }
  
}  #--- End ARIN_json2Text

#--------------------------#
sub RIPE_json2Text
#--------------------------#
{
  my ($refTF, $root) = @_;
  $$refTF->Append('service: ' . $$root{service}{name} . "\r\n") if exists($$root{service}) and exists($$root{service}{name});
  if (exists($$root{parameters})) {
    $$refTF->Append("parameters:\r\n");
    &json2Text($refTF, $$root{parameters}, 1);
  }
  if (exists($$root{objects})) {
    if (exists($$root{objects}{object}) and ref($$root{objects}{object}) eq 'ARRAY') {
      my $i = 0;
      foreach my $object (@{$$root{objects}{object}}) {
        $$refTF->Append($$object{type} . "\r\n") if exists($$object{type});
        if (exists($$object{'primary-key'}) and exists($$object{'primary-key'}{attribute})) {
          $$refTF->Append("  primary-key:\r\n");
          &json2Text($refTF, $$object{'primary-key'}{attribute}, 1);
        }
        if (exists($$object{source})) {
          $$refTF->Append('  source: ');
          $$refTF->Append($$object{source}{id}) if $$object{source}{id};
          $$refTF->Append("\r\n");
        }
        if (exists($$object{link})) {
          $$refTF->Append("  link:\r\n");
          &json2Text($refTF, $$object{link}, 2);
          $$refTF->Append("\r\n");
        }
        if (exists($$object{attributes}) and exists($$object{attributes}{attribute})) {
          &json2Text($refTF, $$object{attributes}{attribute}, 0);
        }
        $$refTF->Append("\r\n") if $$refTF->Text() !~ /\r\n$/;
      }
    }
  }
  if (exists($$root{'terms-and-conditions'})) {
    $$refTF->Append("terms-and-conditions:\r\n");
    &json2Text($refTF, $$root{'terms-and-conditions'}, 1);
  }
  
}  #--- End RIPE_json2Text

#--------------------------#
sub LACNIC_json2Text
#--------------------------#
{
  my ($refTF, $root) = @_;
  my @fields = ('objectClassName', 'handle', 'startAddress', 'endAddress', 'ipVersion', 'type', 'originAutnum', 'entities',
               'events', 'links', 'rdapConformance', 'notices', 'port43');
  foreach my $field (@fields) {
    if (exists($$root{$field})) {
      $$refTF->Append("$field:");
      if (ref($$root{$field})) {
        if (ref($$root{$field}) eq 'ARRAY' and scalar(@{$$root{$field}}) == 1 and !ref($$root{$field}[0])) {
          $$refTF->Append("  $$root{$field}[0]\r\n");
        } else {
          $$refTF->Append("\r\n");
          if ($field eq 'events' and ref($$root{$field}) eq 'ARRAY') {
            foreach my $event (@{$$root{$field}}) {
              if (exists($$event{eventAction}) and exists($$event{eventDate})) {
                $$refTF->Append("  $$event{eventAction}: $$event{eventDate}\r\n");
              } else { &json2Text($refTF, $event, 1); }
            }
          } elsif ($field eq 'notices' and ref($$root{$field}) eq 'ARRAY') {
            foreach my $notice (@{$$root{$field}}) {
              if    (exists($$notice{title})) { $$refTF->Append("  $$notice{title}\r\n"); }
              if (exists($$notice{description})) {
                if (!ref($$notice{description})) {
                  $$refTF->Append("    $$notice{description}\r\n");
                } else {
                  foreach my $descr (@{$$notice{description}}) {
                    $$refTF->Append("    $descr\r\n");
                  }
                }
              }
              if (exists($$notice{links})) {
                $$refTF->Append("    links:\r\n");
                &json2Text($refTF, $$notice{links}, 2);
              }
              foreach my $notice (keys %{$notice}) {
                if ($notice !~ /^(?:title|description|links)$/) {
                  $$refTF->Append("  $notice:");
                  &json2Text($refTF, $$root{$notice}, 1);
                }
              }
            }
          } else { &json2Text($refTF, $$root{$field}, 0); }
        }
      } else { $$refTF->Append(" $$root{$field}\r\n"); }
    }
  }
  foreach my $el (keys %{$root}) {
    if ($el !~ /^(?:objectClassName|handle|startAddress|endAddress|endAddress|ipVersion|type|originAutnum|entities|events|links|rdapConformance|notices|port43)$/) {
      $$refTF->Append("  $el:");
      &json2Text($refTF, $$root{$el}, 1);
    }
  }
  
}  #--- End LACNIC_json2Text

#--------------------------#
sub APNIC_json2Text
#--------------------------#
{
  my ($refTF, $root) = @_;
  foreach my $el (@{$root}) {
    $$refTF->Append($$el{type} . ":\r\n") if $$el{type} and $$el{type} !~ /^(?:comments|object)$/;
    $$refTF->Append($$el{objectType} . "\r\n") if $$el{objectType};
    $$refTF->Append('  primaryKey: ' . $$el{primaryKey} . "\r\n") if $$el{primaryKey};
    if ($$el{comments} and ref($$el{comments}) eq 'ARRAY') {
      foreach my $comment (@{$$el{comments}}) {
        $$refTF->Append("$comment\r\n");
      }
    }
    if ($$el{attributes} and ref($$el{attributes}) eq 'ARRAY') {
      foreach my $attr (@{$$el{attributes}}) {
        $$refTF->Append("  $$attr{name}: ") if $$attr{name};
        if ($$attr{values} and ref($$attr{values}) eq 'ARRAY') {
          my $i = 0;
          foreach my $values (@{$$attr{values}}) {
            $$refTF->Append($values) if $values;
            if (($i+1) < scalar(@{$$attr{values}})) {
              $$refTF->Append(', ');
            } else { $$refTF->Append("\r\n"); }
            $i++;
          }
        } elsif ($$attr{links} and ref($$attr{links}) eq 'ARRAY') {
          if (scalar(@{$$attr{links}}) == 1) {
            $$refTF->Append($$attr{links}[0]{text}) if exists($$attr{links}[0]{text});
            $$refTF->Append("\r\n");
            $$refTF->Append('    url: ' . $$attr{links}[0]{url} . "\r\n") if exists($$attr{links}[0]{url});
          } else {
            $$refTF->Append("\r\n");
            $$refTF->Append("    links:\r\n");
            &json2Text($refTF, $$attr{links}, 2);
          }
        }
      }
      $$refTF->Append("\r\n");
    }
  }
  
}  #--- End APNIC_json2Text

#--------------------------#
sub json2Text
#--------------------------#
{
  my ($refTF, $root, $level) = @_;
  if (ref($root) eq 'HASH') {
    if (scalar(keys %{$root}) == 2 and exists($$root{'name'}) and exists($$root{'value'})) {
      $$refTF->Append("  ") for (1..$level);
      $$refTF->Append($$root{'name'} . ': ' . $$root{'value'});
    } else {
      if (exists($$root{'name'}) and exists($$root{'value'})) {
        $$refTF->Append("  ") for (1..$level);
        $$refTF->Append($$root{'name'} . ': ' . $$root{'value'} . "\r\n");
      } elsif (exists($$root{'name'}) and exists($$root{'values'})) {
        $$refTF->Append("  ") for (1..$level);
        $$refTF->Append($$root{'name'} . ': ');
      }
      my $i = 0;
      foreach my $el (sort keys %{$root}) {
        if ($el) {
          if (ref($$root{$el})) {
            if ($el ne 'values' or (!exists($$root{'name'}) and !exists($$root{'values'}))) {
              $$refTF->Append("  ") for (1..$level);
              my $el2 = $el =~ s/^\@//r;
              $$refTF->Append("$el2: ") if $el2;
            }
            if (ref($$root{$el}) eq 'HASH' and exists($$root{$el}{'$'}) and scalar(keys %{$$root{$el}}) == 1) {
              $$refTF->Append($$root{$el}{'$'} . "\r\n") if $$root{$el}{'$'};
            } elsif (ref($$root{$el}) eq 'ARRAY' and scalar(@{$$root{$el}}) == 1 and !ref($$root{$el}[0])) {
              $$refTF->Append($$root{$el}[0]);
              $$refTF->Append("\r\n") if $$refTF->Text() !~ /\r\n$/;
            } else { $$refTF->Append("\r\n"); &json2Text($refTF, $$root{$el}, $level+1); }
          } else {
            if ($el ne '@number' and (!exists($$root{'name'}) or (!exists($$root{'value'}) and !exists($$root{'values'})))) {
              $$refTF->Append("  ") for (1..$level);
              my $el2 = $el =~ s/^\@//r;
              $$refTF->Append($el2 . ': ') if $el2 and $el2 ne '$'  and !exists($$root{'name'}) and (!exists($$root{'value'}) and !exists($$root{'values'}));
              $$refTF->Append($$root{$el}) if $$root{$el};
              $$refTF->Append("\r\n") if ($i+1) < scalar(keys %{$root});
            }
          }
        }
        $i++;
      }
    }
  } elsif (ref($root) eq 'ARRAY') {
    foreach my $el (@{$root}) {
      if ($el) {
        if (ref($el)) {
          if    ((ref($el) eq 'ARRAY' and scalar(@{$el})) or (ref($el) eq 'HASH' and scalar(keys %{$el}))) {
            if (ref($el) eq 'HASH' and exists($$el{'$'})) {
              $$refTF->Append("  ") for (1..$level);
              if ($$el{'$'}) {
                chop($$el{'$'}) if $$el{'$'} =~ /[\r\n]$/;
                $$refTF->Append($$el{'$'}."\r\n");
              }
            } elsif (ref($el) eq 'ARRAY' and scalar(@{$el}) == 4 and $$el[2] and $$el[2] eq 'text') { # vcard
              $$refTF->Append("  ") for (1..$level);
              $$refTF->Append("$$el[0]: $$el[3]\r\n");
            } else {
              &json2Text($refTF, $el, $level+1);
              $$refTF->Append("\r\n") if $$refTF->Text() !~ /\r\n$/;
            }
          }
        } else {
          $$refTF->Append("  ") for (1..$level);
          chomp($el);
          $$refTF->Append("$el\r\n") if $el;
        }
      }
    }
  }
  
}  #--- End json2Text

#--------------------------#
sub json2Treeview
#--------------------------#
{
  my ($refTV, $root, $parent) = @_;
  if (ref($root) eq 'HASH') {
    foreach my $el (keys %{$root}) {
      if (ref($$root{$el})) {
        my $newParent;
        if ($parent) { $newParent = $$refTV->InsertItem(-text => $el, -parent => $parent); }
        else         { $newParent = $$refTV->InsertItem(-text => $el); }
        &json2Treeview($refTV, $$root{$el}, $newParent);
      } else {
        my $newEl = $el . ': ' . $$root{$el};
        if ($parent) { $$refTV->InsertItem(-text => $newEl, -parent => $parent); }
        else         { $$refTV->InsertItem(-text => $newEl); }   
      }
    }
  } elsif (ref($root) eq 'ARRAY') {
    my $i = 0;
    foreach my $el (@{$root}) {
      if (ref($el)) {
        if    ((ref($el) eq 'ARRAY' and scalar(@{$el})) or (ref($el) eq 'HASH' and scalar(keys %{$el}))) {
          my $newParent;
          if ($parent) { $newParent = $$refTV->InsertItem(-text => $i, -parent => $parent); }
          else         { $newParent = $$refTV->InsertItem(-text => $i); }
          &json2Treeview($refTV, $el, $newParent);
        }
      } else {
        if ($parent) { $$refTV->InsertItem(-text => $el, -parent => $parent); }
        else         { $$refTV->InsertItem(-text => $el); }
      }
      $i++;
    }
  } else { print ref($root) . "\n"; }
  
}  #--- End json2Treeview

#--------------------------#
sub tsGetRanges_Click
#--------------------------#
{
  # Show selected tab
  my $curTabSel = $winAddRanges->tsGetRanges->GetString($winAddRanges->tsGetRanges->GetCurSel());
  $winAddRanges->tfGetRangesRoute->Hide();
  $winAddRanges->tfGetRangesOrg->Hide();
  $winAddRanges->tfGetRangesASN->Hide();
  $winAddRanges->tvGetRangesRoute->Hide();
  $winAddRanges->tvGetRangesOrg->Hide();
  $winAddRanges->tvGetRangesASN->Hide();
  $winAddRanges->tfGetRangesRouteRaw->Hide();
  $winAddRanges->tfGetRangesOrgRaw->Hide();
  $winAddRanges->tfGetRangesASNRaw->Hide();
  $winAddRanges->rbGetRangesForm->Checked(1);
  $winAddRanges->rbGetRangesTV->Checked(0);
  $winAddRanges->rbGetRangesRaw->Checked(0);
  if    ($curTabSel eq $STR{'Route'}) { $winAddRanges->tfGetRangesRoute->Show(); }
  elsif ($curTabSel eq $STR{'Org'}  ) { $winAddRanges->tfGetRangesOrg->Show();   }
  else                                { $winAddRanges->tfGetRangesASN->Show();   }

}  #--- End tsGetRanges_Click

#--------------------------#
sub rbGetRangesForm_Click
#--------------------------#
{
  # Show formatted data
  my $curTabSel = $winAddRanges->tsGetRanges->GetString($winAddRanges->tsGetRanges->GetCurSel());
  $winAddRanges->tfGetRangesRoute->Hide();
  $winAddRanges->tfGetRangesOrg->Hide();
  $winAddRanges->tfGetRangesASN->Hide();
  $winAddRanges->tvGetRangesRoute->Hide();
  $winAddRanges->tvGetRangesOrg->Hide();
  $winAddRanges->tvGetRangesASN->Hide();
  $winAddRanges->tfGetRangesRouteRaw->Hide();
  $winAddRanges->tfGetRangesOrgRaw->Hide();
  $winAddRanges->tfGetRangesASNRaw->Hide();  
  if    ($curTabSel eq $STR{'Route'}) { $winAddRanges->tfGetRangesRoute->Show(); }
  elsif ($curTabSel eq $STR{'Org'}  ) { $winAddRanges->tfGetRangesOrg->Show();   }
  else                                { $winAddRanges->tfGetRangesASN->Show();   }

}  #--- End rbGetRangesForm_Click

#--------------------------#
sub rbGetRangesTV_Click
#--------------------------#
{
  # Show formatted data
  my $curTabSel = $winAddRanges->tsGetRanges->GetString($winAddRanges->tsGetRanges->GetCurSel());
  $winAddRanges->tfGetRangesRoute->Hide();
  $winAddRanges->tfGetRangesOrg->Hide();
  $winAddRanges->tfGetRangesASN->Hide();
  $winAddRanges->tvGetRangesRoute->Hide();
  $winAddRanges->tvGetRangesOrg->Hide();
  $winAddRanges->tvGetRangesASN->Hide();
  $winAddRanges->tfGetRangesRouteRaw->Hide();
  $winAddRanges->tfGetRangesOrgRaw->Hide();
  $winAddRanges->tfGetRangesASNRaw->Hide();  
  if    ($curTabSel eq $STR{'Route'}) { $winAddRanges->tvGetRangesRoute->Show(); }
  elsif ($curTabSel eq $STR{'Org'}  ) { $winAddRanges->tvGetRangesOrg->Show();   }
  else                                { $winAddRanges->tvGetRangesASN->Show();   }

}  #--- End rbGetRangesTV_Click

#--------------------------#
sub rbGetRangesRaw_Click
#--------------------------#
{
  # Show formatted data
  my $curTabSel = $winAddRanges->tsGetRanges->GetString($winAddRanges->tsGetRanges->GetCurSel());
  $winAddRanges->tfGetRangesRoute->Hide();
  $winAddRanges->tfGetRangesOrg->Hide();
  $winAddRanges->tfGetRangesASN->Hide();
  $winAddRanges->tvGetRangesRoute->Hide();
  $winAddRanges->tvGetRangesOrg->Hide();
  $winAddRanges->tvGetRangesASN->Hide();
  $winAddRanges->tfGetRangesRouteRaw->Hide();
  $winAddRanges->tfGetRangesOrgRaw->Hide();
  $winAddRanges->tfGetRangesASNRaw->Hide();  
  if    ($curTabSel eq $STR{'Route'}) { $winAddRanges->tfGetRangesRouteRaw->Show(); }
  elsif ($curTabSel eq $STR{'Org'}  ) { $winAddRanges->tfGetRangesOrgRaw->Show();   }
  else                                { $winAddRanges->tfGetRangesASNRaw->Show();   }

}  #--- End rbGetRangesRaw_Click

#--------------------------#
sub btnGetRangesORG_Click
#--------------------------#
{
  &getRanges('ORG', $winAddRanges->tfRangesORGVal->Text()) if $winAddRanges->tfRangesORGVal->Text();

}  #--- End btnGetRangesORG_Click

#--------------------------#
sub btnGetRangesASN_Click
#--------------------------#
{
  &getRanges($winAddRanges->lblRangesASN->Text(), $winAddRanges->cbRangesASNVal->GetString($winAddRanges->cbRangesASNVal->GetCurSel()));

}  #--- End btnGetRangesASN_Click

#--------------------------#
sub getRanges
#--------------------------#
{
  # Local variables
  my $type = shift; # $type: ORG, ASN: or Admin-c:
  my $id   = shift; # OrgID, ASN or Admin-c value
  # Avoid new thread
  if ($THR and $THR->is_running()) { Win32::GUI::MessageBox($win, $STR{'errProcessRun'},$STR{'Error'},0x40010); }
  else {
    $THR = threads->create(sub {
      # Thread 'cancellation' signal handler
      $SIG{'KILL'} = sub {
        $winAddRanges->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        threads->exit();
      };
      # Thread 'die' signal handler
      $SIG{__DIE__} = sub {
        return if $_[0] and ($_[0]->isa('GeoIP2::Error::Generic') or $_[0]->isa('GeoIP2::Error::IPAddressNotFound'));
        my $errMsg = (split(/ at /,$_[0]))[0];
        chomp($errMsg);
        $errMsg =~ s/[\t\r\n]/ /g;
        $winAddRanges->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        Win32::GUI::MessageBox($winAddRanges, "$STR{'errorMsg'}: $errMsg", $STR{'Error'}, 0x40010);
      };
      # Reset window controls (Related ranges)
      $winAddRanges->btnRemNetNames->Disable();
      $winAddRanges->cbShowRanges->SetCurSel(0);
      $winAddRanges->cbChoiceSel->SetCurSel(0);
      for (my $row = $winAddRanges->GridISPRanges->GetRows(); $row >= 1; $row--) { $winAddRanges->GridISPRanges->DeleteRow($row); }
      $winAddRanges->GridISPRanges->SetColumns(5);
      $winAddRanges->GridISPRanges->Refresh();
      $winAddRanges->btnAddRSelected->Disable();
      $winAddRanges->btnAddRSelected->Text("$STR{'winAddRSelected'} >>");
      # Turn on progress bar
      $winPb->Center($winAddRanges);
      $winPb->Show();
      $winPb->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
      $winDB->Disable();
      $winAddRanges->ChangeCursor($HOURGLASS);
      # Progress bar
      $winPb->pbWinPb->SetRange(0, 1);
      $winPb->pbWinPb->SetPos(0);
      $winPb->pbWinPb->SetStep(1);
      # Variables
      my $nameORG = $winAddRanges->lblRangesOrgNameVal->Text();
      my $source  = $winAddRanges->lblRangesSourceVal->Text();
      my ($return, $refRangesISP);
      ($return, $source, $refRangesISP) = &getRangesARIN(   $type, $nameORG, $id) if $source eq 'ARIN';
      ($return, $source, $refRangesISP) = &getRangesRIPE(   $type, $nameORG, $id) if $source eq 'RIPE'   or $source eq 'AFRINIC';
      ($return, $source, $refRangesISP) = &getRangesLACNIC( $type, $nameORG, $id) if $source eq 'LACNIC' or $source eq 'NICBR';
      ($return, $source, $refRangesISP) = &getRangesAPNIC(  $type, $nameORG, $id) if $source eq 'APNIC'  or $source eq 'KRNIC' or $source eq 'TWNIC';
      ($return, $source, $refRangesISP) = &getRangesJPNIC(  $type, $nameORG, $id) if $source eq 'JPNIC';
      # Prepare results
      if ($return) {
        my $hasNetname = 0;
        my $hasChoice  = 0;
        # Show ranges found
        my $nbrRanges = scalar(keys %{$refRangesISP});
        $winAddRanges->GridISPRanges->SetRows($nbrRanges+1);
        $winAddRanges->GridISPRanges->SetCellText( 0, 0, ""         );
        $winAddRanges->GridISPRanges->SetCellType( 0, 0, GVIT_CHECK );
        $winAddRanges->GridISPRanges->SetCellCheck(0, 0, 1);
        $winAddRanges->GridISPRanges->SetCellText( 0, 1, $STR{'cbFilterField1'});
        $winAddRanges->GridISPRanges->SetCellText( 0, 2, $STR{'cbFilterField2'});
        $winAddRanges->GridISPRanges->SetCellText( 0, 3, $STR{'ISP'});
        $winAddRanges->GridISPRanges->SetCellText( 0, 4, $STR{'Country'});
        my $i = 1;
        foreach my $range (sort keys %{$refRangesISP}) {
          my ($name, $country)    = split(/\t/, $$refRangesISP{$range});
          my ($range_s, $range_e) = split(/-/, $range);
          $winAddRanges->GridISPRanges->SetCellText( $i, 0, "");
          $winAddRanges->GridISPRanges->SetCellType( $i, 0, GVIT_CHECK);
          $winAddRanges->GridISPRanges->SetCellCheck($i, 0, 1);
          $winAddRanges->GridISPRanges->SetCellText( $i, 1, $range_s);
          $winAddRanges->GridISPRanges->SetCellText( $i, 2, $range_e);
          if ($name =~ /\|/) {
            $hasChoice++;
            if ($hasChoice == 1) {
              $winAddRanges->GridISPRanges->SetColumns(6); # Add a column
              $winAddRanges->GridISPRanges->SetColumnWidth(5, 0); # Hide the column
            }
            $winAddRanges->GridISPRanges->SetCellType(    $i, 3, GVIT_LIST);
            my @names = split(/\|/, $name);
            $winAddRanges->GridISPRanges->SetCellText(    $i, 3, $names[0]);
            $winAddRanges->GridISPRanges->SetCellOptions( $i, 3, @names);
            $winAddRanges->GridISPRanges->SetCellText(    $i, 5, $name);
          } else {
            $winAddRanges->GridISPRanges->SetCellText( $i, 3, $name);
            $hasNetname = 1 if $name =~ /\([^\)]+\)$/;
          }
          $winAddRanges->GridISPRanges->SetCellText( $i, 4, $country) if $country;
          $i++;
        }
        $winAddRanges->GridISPRanges->SortCells(1, 1, \&sortIP);
        $winAddRanges->GridISPRanges->Refresh();
        $winAddRanges->GridISPRanges->AutoSize();
        $winAddRanges->GridISPRanges->ExpandColumnsToFit(0);
        $winAddRanges->GridISPRanges->BringWindowToTop();
        if ($nbrRanges) {
          if ($hasNetname) { $winAddRanges->btnRemNetNames->Enable();  }
          else             { $winAddRanges->btnRemNetNames->Disable(); }
          if ($hasChoice)  {
            $winAddRanges->lblChoiceSel->Show();
            $winAddRanges->cbChoiceSel->Show();
            $winAddRanges->lblChoiceSel2->Show();
          }
          $winAddRanges->btnAddRSelected->Text("$STR{'winAddRSelected'} ($nbrRanges) >>");
          $winAddRanges->btnAddRSelected->Enable();
        } else {
          $winAddRanges->btnRemNetNames->Disable();
          $winAddRanges->btnAddRSelected->Disable();
        }
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        &winPb_Terminate;
        $winDB->ChangeCursor($ARROW);
        # Shift window controls
        $winAddRanges->lblTitle->Text($STR{'RelatedRanges'}.':');
        $winAddRanges->lblShowRanges->Show();
        $winAddRanges->cbShowRanges->Show();
        $winAddRanges->btnRemNetNames->Show();
        $winAddRanges->GridISPRanges->Show();
        $winAddRanges->btnGetRangesPrev->Show();
        $winAddRanges->btnAddRSelected->Show();
        $winAddRanges->lblRangesOrgName->Hide();
        $winAddRanges->lblRangesOrgNameVal->Hide();
        $winAddRanges->lblRangesSource->Hide();
        $winAddRanges->lblRangesSourceVal->Hide();
        $winAddRanges->lblRangesORG->Hide();
        $winAddRanges->tfRangesORGVal->Hide();
        $winAddRanges->btnGetRangesORG->Hide();
        $winAddRanges->lblRangesASN->Hide();
        $winAddRanges->cbRangesASNVal->Hide();
        $winAddRanges->btnGetRangesASN->Hide();
        $winAddRanges->tsGetRanges->Hide();
        $winAddRanges->tfGetRangesRoute->Hide();
        $winAddRanges->tfGetRangesOrg->Hide();
        $winAddRanges->tfGetRangesASN->Hide();
        $winAddRanges->tvGetRangesRoute->Hide();
        $winAddRanges->tvGetRangesOrg->Hide();
        $winAddRanges->tvGetRangesASN->Hide();
        $winAddRanges->tfGetRangesRouteRaw->Hide();
        $winAddRanges->tfGetRangesOrgRaw->Hide();
        $winAddRanges->tfGetRangesASNRaw->Hide();
        $winAddRanges->rbGetRangesForm->Hide();
        $winAddRanges->rbGetRangesTV->Hide();
        $winAddRanges->rbGetRangesRaw->Hide();
      } else {
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        &winPb_Terminate;
        $winAddRanges->ChangeCursor($ARROW);
        # Connection error
        if ($refRangesISP eq $STR{'noRangeISP'}) {
          Win32::GUI::MessageBox($winAddRanges, "$refRangesISP", $STR{'RelatedRanges'}, 0x40040);
        } else {
          Win32::GUI::MessageBox($winAddRanges, "$STR{'errorMsg'}: $refRangesISP", $STR{'Error'}, 0x40010);
        }
      }
    });
  }
  return(1);

}  #--- End getRanges

#--------------------------#
sub getRangesARIN
#--------------------------#
{
  # Local variables
  my ($type, $nameORG, $id) = @_;
  my %rangesISP;
  my $reader;
  # Create an agent
  my $ua = LWP::UserAgent->new;
  $ua->agent($CONFIG{'USERAGENT'});
  $ua->default_header('Accept-Language' => 'en', 'Accept' => 'application/json');
  my $client = REST::Client->new(useragent => $ua, timeout => $CONFIG{'NSLOOKUP_TIMEOUT'}, follow => 1);
  # Get all ranges
  $winPb->lblPbCurr->Text("ARIN: $STR{'SearchFor'} $id...");
  if ($type eq 'ORG') { $client->GET("http://whois.arin.net/rest/org/$id/nets"); }
  else                { $client->GET("http://whois.arin.net/rest/asn/$id/nets"); }
  # Get the organisation ID for the ASN
  if ($type eq 'ASN:' and $client->responseCode() eq '404') {
    $client->GET("http://whois.arin.net/rest/asn/$id");
    if ($client->responseCode() eq '200' and $client->responseContent() and $client->responseContent() !~ /^Can't connect to/) {
      # Parse answer
      if ($client->responseContent() =~ /text="(ERROR[^\"]+)/) { return(0, 'ARIN', $1); }
      my $json = parse_json($client->responseContent());
      if ($winConfig->chRelRangeSearches->Checked()) {
        my $f_getAllRanges = "$CONFIG{'SEARCHES_CACHE'}\\$id asn\.txt";
        open(FH_ALLRANGES2, ">$f_getAllRanges");
        print FH_ALLRANGES2 $client->responseContent();
        close(FH_ALLRANGES2);
      }
      # This is an organisation range
      if (my $refOrg = $$json{asn}{orgRef}) {
        $nameORG    = $$refOrg{'@name'}   if exists($$refOrg{'@name'}  ) and $$refOrg{'@name'};
        $id         = $$refOrg{'@handle'} if exists($$refOrg{'@handle'}) and $$refOrg{'@handle'};
        my $hrefORG = $$refOrg{'$'}       if exists($$refOrg{'$'}      ) and $$refOrg{'$'};
        if ($nameORG and $id and $hrefORG) {
          $hrefORG =~ s/^https/http/;
          $client->GET($hrefORG.'/nets');
        }
      }
    } else { return(0, 'ARIN', $STR{'errConnection'}.': '.$client->responseCode().' - '.$$client{_res}{_msg}); }
  }
  if ($client->responseCode() eq '200' and $client->responseContent() and $client->responseContent() !~ /^Can't connect to/) {
    # Parse answer
    if ($client->responseContent() =~ /text="(ERROR[^\"]+)/) { return(0, 'ARIN', $1); }
    my $json = parse_json($client->responseContent());
    if ($winConfig->chRelRangeSearches->Checked()) {
      my $f_getAllRanges = "$CONFIG{'SEARCHES_CACHE'}\\$id ranges\.txt";
      open(FH_ALLRANGES3, ">$f_getAllRanges");
      print FH_ALLRANGES3 $client->responseContent();
      close(FH_ALLRANGES3);
    }
    my $country;
    if ($nameORG =~ /(.+), ([A-Z]{2})$/) {
      $nameORG = $1;
      $country = $2;
    }
    if (exists($$json{nets}) and exists($$json{nets}{netRef}) and ref($$json{nets}{netRef}) eq 'ARRAY') {
      foreach my $nets (@{$$json{nets}{netRef}}) {
        if (my $range_s = $$nets{'@startAddress'} and my $range_e = $$nets{'@endAddress'}) {
          $rangesISP{"$range_s-$range_e"}  = "$nameORG";
          $rangesISP{"$range_s-$range_e"} .= ' (' . $$nets{'@name'} . ')' if $$nets{'@name'};
          $rangesISP{"$range_s-$range_e"} .= "\t";
          if ($country) { $rangesISP{"$range_s-$range_e"} .= uc($country); }
          elsif ($reader or my $geoIPDB = $winConfig->tfGeoIPDB->Text()) { # No country, use GeoIP
            if (!$reader and $geoIPDB) { $reader = GeoIP2::Database::Reader->new(file => $geoIPDB, locales => ['en']); }
            if ($reader) {
              my $record;
              eval { $record = $reader->city(ip => $range_s) };
              if (!$@) {
                $rangesISP{"$range_s-$range_e"} .= uc($record->country()->iso_code()) if $record->country()->iso_code();
              }
            }
          }
        }
      }
    }
    if (scalar(keys %rangesISP)) { return(1, 'ARIN', \%rangesISP);        }
    else                         { return(0, 'ARIN', $STR{'noRangeISP'}); }
  } else { return(0, 'ARIN', $STR{'errConnection'}.': '.$client->responseCode().' - '.$$client{_res}{_msg}); }
  
  
}  #--- End getRangesARIN

#--------------------------#
sub getRangesRIPE
#--------------------------#
{
  # Local variables
  my ($type, $nameORG, $id) = @_;
  my %rangesISP;
  my $reader;
  # Create an agent
  my $ua = LWP::UserAgent->new;
  $ua->agent($CONFIG{'USERAGENT'});
  $ua->default_header('Accept-Language' => 'en', 'Accept' => 'application/json');
  my $client = REST::Client->new(useragent => $ua, timeout => $CONFIG{'NSLOOKUP_TIMEOUT'}, follow => 1);
  # Get all ranges
  $winPb->lblPbCurr->Text("RIPE: $STR{'SearchFor'} $id...");
  if ($type eq 'ORG') { $client->GET("http://rest.db.ripe.net/search?inverse-attribute=org&query-string=$id");    }
  else                { $client->GET("http://rest.db.ripe.net/search?inverse-attribute=origin&query-string=$id"); }
  if ($client->responseCode() eq '200' and $client->responseContent() and $client->responseContent() !~ /^Can't connect to/) {
    # Parse answer
    if ($client->responseContent() =~ /text="(ERROR[^\"]+)/) { return(0, 'RIPE', $1); }
    my $json = parse_json($client->responseContent());
    if ($winConfig->chRelRangeSearches->Checked()) {
      my $f_getAllRanges = "$CONFIG{'SEARCHES_CACHE'}\\$id ranges\.txt";
      open(FH_ALLRANGES3, ">$f_getAllRanges");
      print FH_ALLRANGES3 $client->responseContent();
      close(FH_ALLRANGES3);
    }
    my $country;
    if ($nameORG =~ /(.+), ([A-Z]{2})$/) {
      $nameORG = $1;
      $country = $2;
    }
    foreach my $object (@{$$json{objects}{object}}) {
      my ($range_s, $range_e, $netname, $name, $country);
      if ($$object{type} eq 'inetnum') {
        foreach my $attr ((@{$$object{attributes}{attribute}})) {
          $netname = $$attr{value}     if $$attr{name} eq 'netname';
          $name   .= $$attr{value}.'|' if $$attr{name} eq 'descr';
          $country = $$attr{value}     if $$attr{name} eq 'country';
          if ($$attr{name} eq 'inetnum'and $$attr{value} =~ /([^\-]+) ?- ?([^\-]+)/) {
            $range_s = $1;
            $range_e = $2;
          }
        }
        chop($name) if $name and $name =~ /\|$/;
      } elsif ($$object{type} eq 'route' or $$object{type} eq 'route6') {
        foreach my $attr ((@{$$object{attributes}{attribute}})) {
          $netname = $$attr{value}     if $$attr{name} eq 'netname';
          $name   .= $$attr{value}.'|' if $$attr{name} eq 'descr';
          $country = $$attr{value}     if $$attr{name} eq 'country';
          ($range_s, $range_e) = split(/ \- /, &CIDR2Range($$attr{value}))
          if ($$attr{name} eq 'route' or $$attr{name} eq 'route6') and $$attr{value};
        }
        chop($name) if $name and $name =~ /\|$/;
      }
      if ($range_s and $range_e) {
        my $listNames;
        if ($nameORG and $netname and !$name) { $listNames = "$nameORG ($netname)"; }
        else {
          $listNames  = $nameORG.'|'           if $nameORG;
          $listNames .= "$nameORG ($netname)|" if $nameORG and $netname;
          $listNames .= $netname.'|'           if $netname;
          $listNames .= $name.'|'              if $name;
          chop($listNames);
        }
        $rangesISP{"$range_s-$range_e"} .= "$listNames\t";
        if ($country) { $rangesISP{"$range_s-$range_e"} .= uc($country); }
        elsif ($reader or my $geoIPDB = $winConfig->tfGeoIPDB->Text()) { # No country, use GeoIP
          if (!$reader and $geoIPDB) { $reader = GeoIP2::Database::Reader->new(file => $geoIPDB, locales => ['en']); }
          if ($reader) {
            my $record;
            eval { $record = $reader->city(ip => $range_s) };
            if (!$@) {
              $rangesISP{"$range_s-$range_e"} .= uc($record->country()->iso_code()) if $record->country()->iso_code();
            }
          }
        }
      }
    }
    if (scalar(keys %rangesISP)) { return(1, 'RIPE', \%rangesISP);        }
    else                         { return(0, 'RIPE', $STR{'noRangeISP'}); }
  } else { return(0, 'RIPE', $STR{'errConnection'}.': '.$client->responseCode().' - '.$$client{_res}{_msg}); }
  
}  #--- End getRangesRIPE

#--------------------------#
sub getRangesLACNIC
#--------------------------#
{
  # Local variables
  my ($type, $nameORG, $id) = @_;
  my %rangesISP;
  my $reader;
  my $json;
  # Verify the source
  my $source = $winAddRanges->lblRangesSourceVal->Text();
  # Get all ranges
  $winPb->lblPbCurr->Text("$source: $STR{'SearchFor'} $id...");
  # Create an agent
  my $ua = LWP::UserAgent->new;
  $ua->agent($CONFIG{'USERAGENT'});
  $ua->default_header('Accept-Language' => 'en');
  my $client = REST::Client->new(useragent => $ua, timeout => $CONFIG{'NSLOOKUP_TIMEOUT'}, follow => 1);
  if ($source eq 'LACNIC') {
    if ($type eq 'ORG') { $client->GET("http://rdap.lacnic.net/rdap/entity/$id"); }
    else                { $client->GET("http://rdap.lacnic.net/rdap/autnum/$id"); }
  } else { # NICBR
    if ($type eq 'ORG') { $client->GET("http://rdap.registro.br/entity/$id");     }
    else                { $client->GET("http://rdap.registro.br/autnum/$id");     }
  }
  if ($client->responseCode() eq '200' and $client->responseContent() and $client->responseContent() !~ /^Can't connect to/) {
    # Parser answer
    $json = parse_json($client->responseContent());
    if ($winConfig->chRelRangeSearches->Checked()) {
      my $f_getAllRanges = "$CONFIG{'SEARCHES_CACHE'}\\$id ranges\.txt";
      open(FH_ALLRANGES3, ">$f_getAllRanges");
      print FH_ALLRANGES3 $client->responseContent();
      close(FH_ALLRANGES3);
    }
    my $country;
    if ($nameORG =~ /(.+), ([A-Z]{2})$/) {
      $nameORG = $1;
      $country = $2;
    }
    my $refNetworks;
    if    (exists($$json{networks})                ) { $refNetworks = $$json{networks};                 }
    elsif (exists($$json{nicbr_reverseDelegations})) { $refNetworks = $$json{nicbr_reverseDelegations}; }
    elsif (exists($$json{links})                   ) { $refNetworks = $$json{links};                    }
    else { return(0, $source, $STR{'noRangeISP'}); }
    foreach my $network (@{$refNetworks}) {
      my ($range_s, $range_e);
      if (exists($$network{startAddress}) and exists($$network{endAddress})) {
        $range_s = $$network{startAddress};
        $range_e = $$network{endAddress};
      } elsif (exists($$network{href}) and $$network{href} and $$network{href} =~ /\/ip\/([^\/]+\/[0-9]+)/) {
        ($range_s, $range_e) = split(/ \- /, &CIDR2Range($1));
      }
      my $name;
      if ($range_s and $range_e) {
        if ($nameORG) {
          if ($name) { $rangesISP{"$range_s-$range_e"} .= "$nameORG ($name)\t"; }
          else       { $rangesISP{"$range_s-$range_e"} .= "$nameORG\t"; }
        } elsif ($name) { $rangesISP{"$range_s-$range_e"} .= "$name\t"; }
        else { $rangesISP{"$range_s-$range_e"} .= "\t"; }
        if ($country) { $rangesISP{"$range_s-$range_e"} .= uc($country); }
        elsif ($reader or my $geoIPDB = $winConfig->tfGeoIPDB->Text()) { # No country, use GeoIP
          if (!$reader and $geoIPDB) { $reader = GeoIP2::Database::Reader->new(file => $geoIPDB, locales => ['en']); }
          if ($reader) {
            my $record;
            eval { $record = $reader->city(ip => $range_s) };
            if (!$@) {
              $rangesISP{"$range_s-$range_e"} .= uc($record->country()->iso_code()) if $record->country()->iso_code();
            }
          }
        }
      }
    }
    if (scalar(keys %rangesISP)) { return(1, $source, \%rangesISP);        }
    else                         { return(0, $source, $STR{'noRangeISP'}); }
  } else { return(0, $source, $STR{'errConnection'}.': '.$client->responseCode().' - '.$$client{_res}{_msg}); }

}  #--- End getRangesLACNIC

#--------------------------#
sub getRangesAPNIC
#--------------------------#
{
  # Local variables
  my ($type, $nameORG, $id) = @_;
  my %rangesISP;
  my $reader;
  # Create an agent
  my $ua = LWP::UserAgent->new;
  $ua->agent($CONFIG{'USERAGENT'});
  $ua->default_header('Accept-Language' => 'en', 'Accept' => 'application/json');
  my $client = REST::Client->new(useragent => $ua, timeout => $CONFIG{'NSLOOKUP_TIMEOUT'}, follow => 1);
  # Verify the source
  my $source = $winAddRanges->lblRangesSourceVal->Text();
  # Get all ranges
  $winPb->lblPbCurr->Text("$source: $STR{'SearchFor'} $id...");
  if    ($type eq 'ORG'         ) { $client->GET("http://wq.apnic.net/query?searchtext=-i%20org%20$id");     }
  elsif ($type eq "$STR{'ASN'}:") { $client->GET("http://wq.apnic.net/query?searchtext=-i%20origin%20$id");  }
  else                            { $client->GET("http://wq.apnic.net/query?searchtext=-i%20admin-c%20$id"); }
  if ($client->responseCode() eq '200' and $client->responseContent() and $client->responseContent() !~ /^Can't connect to/) {
    # Parse answer
    if ($client->responseContent() =~ /text="(ERROR[^\"]+)/) { return(0, $source, $1); }
    my $json = parse_json($client->responseContent());
    if ($winConfig->chRelRangeSearches->Checked()) {
      my $f_getAllRanges = "$CONFIG{'SEARCHES_CACHE'}\\$id ranges\.txt";
      open(FH_ALLRANGES3, ">$f_getAllRanges");
      print FH_ALLRANGES3 $client->responseContent();
      close(FH_ALLRANGES3);
    }
    my $country;
    if ($nameORG =~ /(.+), ([A-Z]{2})$/) {
      $nameORG = $1;
      $country = $2;
    }
    # Progress bar
    $winPb->lblPbCurr->Text("$source: $STR{'ParsingResp'}...");
    my $nbrParts = scalar(@{$json});
    $winPb->pbWinPb->SetRange(0, $nbrParts);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    # Browse json tree
    foreach my $part (@{$json}) {
      my ($range_s, $range_e, $name);
      if (exists($$part{objectType}) and exists($$part{primaryKey})) {
        if ($$part{objectType} eq 'inetnum' and $$part{primaryKey} =~ /([^ ]+) - ([^ ]+)/) { # Inetnum
          $range_s = $1;
          $range_e = $2;
          foreach my $attr ((@{$$part{attributes}})) {
            $name    = $$attr{values}[0]     if $$attr{name} eq 'netname' and $type ne "$STR{'AdminC'}:";
            $name   .= $$attr{values}[0].'|' if $$attr{name} eq 'descr' and $type eq "$STR{'AdminC'}:";
            $country = $$attr{values}[0]     if $$attr{name} eq 'country';
          }
          chop($name) if $name and $name =~ /\|$/;
        } elsif ($$part{objectType} eq 'route' and $$part{primaryKey} =~ /([^\/]+\/[0-9]+)/) { # Route
          ($range_s, $range_e) = split(/ \- /, &CIDR2Range($1));
          foreach my $attr ((@{$$part{attributes}})) {
            $name    = $$attr{values}[0] if $$attr{name} eq 'netname';
            $country = $$attr{values}[0] if $$attr{name} eq 'country';
          }
        }
      }
      if ($range_s and $range_e and !exists($rangesISP{"$range_s-$range_e"})) {
        if ($name) {
          if ($type ne "$STR{'AdminC'}:") { $rangesISP{"$range_s-$range_e"} = "$nameORG ($name)\t"; }
          else                            { $rangesISP{"$range_s-$range_e"} = "$name\t";            }
        } else { $rangesISP{"$range_s-$range_e"} = "$nameORG\t"; }
        if ($country) { $rangesISP{"$range_s-$range_e"} .= uc($country); }
        elsif ($reader or my $geoIPDB = $winConfig->tfGeoIPDB->Text()) { # No country, use GeoIP
          if (!$reader and $geoIPDB) { $reader = GeoIP2::Database::Reader->new(file => $geoIPDB, locales => ['en']); }
          if ($reader) {
            my $record;
            eval { $record = $reader->city(ip => $range_s) };
            if (!$@) {
              $rangesISP{"$range_s-$range_e"} .= uc($record->country()->iso_code()) if $record->country()->iso_code();
            }
          }
        }
      }
      $winPb->pbWinPb->StepIt();
    }
    if (scalar(keys %rangesISP)) { return(1, $source, \%rangesISP);        }
    else                         { return(0, $source, $STR{'noRangeISP'}); }
  } else { return(0, $source, $STR{'errConnection'}.': '.$client->responseCode().' - '.$$client{_res}{_msg}); }
  
}  #--- End getRangesAPNIC

#--------------------------#
sub getRangesJPNIC
#--------------------------#
{
  # Local variables
  my ($type, $nameORG, $id) = @_;
  my %rangesISP;
  my $reader;
  # Get all ranges
  $winPb->lblPbCurr->Text("JPNIC: $STR{'SearchFor'} $id...");
  my $country;
  if ($nameORG =~ /(.+), ([A-Z]{2})$/) {
    $nameORG = $1;
    $country = $2;
  }
  if (my $refResponses = &whoisQuery('whois.nic.ad.jp', "^$id/e")) {
    # Progress bar
    $winPb->lblPbCurr->Text("JPNIC: $STR{'ParsingResp'}...");
    my $nbrParts = scalar(@{$refResponses});
    $winPb->pbWinPb->SetRange(0, $nbrParts);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    # Parse answer
    my $f_getAllRanges = "$CONFIG{'SEARCHES_CACHE'}\\$id ranges\.txt";
    open(FH_ALLRANGES3, ">$f_getAllRanges");
    foreach (@{$refResponses}) {
      if (/NET\/([^\/]+\/[0-9]{1,3})/i or /NET\/([0-9a-fA-F\.\:]+\-[0-9a-fA-F\.\:]+)/i) {
        my $range = $1;
        my ($range_s, $range_e);
        if ($range =~ /\-/) { ($range_s, $range_e) = split(/\-/, $range); }
        else                { ($range_s, $range_e) = split(/ \- /, &CIDR2Range($range)); }
        $rangesISP{"$range_s-$range_e"} = "$nameORG\t$country" if !exists($rangesISP{"$range_s-$range_e"});
      }
      print FH_ALLRANGES3 $_;
      $winPb->pbWinPb->StepIt();
    }
    close(FH_ALLRANGES3);
    unlink($f_getAllRanges) if !$winConfig->chRelRangeSearches->Checked();
    if (scalar(keys %rangesISP)) { return(1, 'JPNIC', \%rangesISP);        }
    else                         { return(0, 'JPNIC', $STR{'noRangeISP'}); }
  } else { return(0, 'JPNIC', $STR{'errConnection'}); }
  
}  #--- End getRangesJPNIC

#--------------------------#
sub winAddRanges_Resize
#--------------------------#
{
  $winAddRanges->lblRangesOrgNameVal->Width( $winAddRanges->ScaleWidth()-332);
  $winAddRanges->btnGetRangesORG->Left(      $winAddRanges->ScaleWidth()-67);
  $winAddRanges->tfRangesORGVal->Left(       $winAddRanges->ScaleWidth()-192);
  $winAddRanges->lblRangesORG->Left(         $winAddRanges->ScaleWidth()-257);
  $winAddRanges->btnGetRangesASN->Left(      $winAddRanges->ScaleWidth()-67);
  $winAddRanges->cbRangesASNVal->Left(       $winAddRanges->ScaleWidth()-192);
  $winAddRanges->lblRangesASN->Left(         $winAddRanges->ScaleWidth()-257);
  $winAddRanges->tsGetRanges->Resize(        $winAddRanges->ScaleWidth()     , $winAddRanges->ScaleHeight()-128);
  $winAddRanges->tfGetRangesRoute->Resize(   $winAddRanges->ScaleWidth()-12  , $winAddRanges->ScaleHeight()-187);
  $winAddRanges->tfGetRangesOrg->Resize(     $winAddRanges->ScaleWidth()-12  , $winAddRanges->ScaleHeight()-187);
  $winAddRanges->tfGetRangesASN->Resize(     $winAddRanges->ScaleWidth()-12  , $winAddRanges->ScaleHeight()-187);
  $winAddRanges->tvGetRangesRoute->Resize(   $winAddRanges->ScaleWidth()-12  , $winAddRanges->ScaleHeight()-187);
  $winAddRanges->tvGetRangesOrg->Resize(     $winAddRanges->ScaleWidth()-12  , $winAddRanges->ScaleHeight()-187);
  $winAddRanges->tvGetRangesASN->Resize(     $winAddRanges->ScaleWidth()-12  , $winAddRanges->ScaleHeight()-187);
  $winAddRanges->tfGetRangesRouteRaw->Resize($winAddRanges->ScaleWidth()-12  , $winAddRanges->ScaleHeight()-187);
  $winAddRanges->tfGetRangesOrgRaw->Resize(  $winAddRanges->ScaleWidth()-12  , $winAddRanges->ScaleHeight()-187);
  $winAddRanges->tfGetRangesASNRaw->Resize(  $winAddRanges->ScaleWidth()-12  , $winAddRanges->ScaleHeight()-187);
  $winAddRanges->rbGetRangesForm->Top(       $winAddRanges->ScaleHeight()-73);
  $winAddRanges->rbGetRangesTV->Top(         $winAddRanges->ScaleHeight()-73);
  $winAddRanges->rbGetRangesRaw->Top(        $winAddRanges->ScaleHeight()-73);
  $winAddRanges->GridISPRanges->Resize(      $winAddRanges->ScaleWidth()-12  , $winAddRanges->ScaleHeight()-105);
  $winAddRanges->btnGetRangesPrev->Top(      $winAddRanges->ScaleHeight()-38);
  $winAddRanges->btnAddRCancel->Move(        $winAddRanges->ScaleWidth()/2-50, $winAddRanges->ScaleHeight()-38);
  $winAddRanges->btnAddRSelected->Move(      $winAddRanges->ScaleWidth()-220 , $winAddRanges->ScaleHeight()-38);
  $winAddRanges->GridISPRanges->AutoSizeColumns();
  $winAddRanges->GridISPRanges->ExpandColumnsToFit(0);
  $winAddRanges->GridISPRanges->Refresh();
  return(1);

}  #--- End winAddRanges_Resize

#--------------------------#
sub cbShowRanges_Change
#--------------------------#
{
  # Local variables
  my $curSel  = $winAddRanges->cbShowRanges->GetCurSel();
  my $nbrRows = $winAddRanges->GridISPRanges->GetRows();
  # Show or hide rows
  if (!$curSel) { # All Ranges
    my $nbrSel = 0;
    for (my $i = 1; $i < $nbrRows; $i++) {
      $winAddRanges->GridISPRanges->SetRowHeight($i, 23);
      $winAddRanges->GridISPRanges->SetCellCheck($i, 0, 1);
      $nbrSel++ if $winAddRanges->GridISPRanges->GetCellCheck($i, 0);
    }
    $winAddRanges->GridISPRanges->Refresh();
    # Enable btnAddRSelected?
    if ($nbrSel) {
      $winAddRanges->btnAddRSelected->Text("$STR{'winAddRSelected'} ($nbrSel) >>");
      $winAddRanges->btnAddRSelected->Enable();
    } else {
      $winAddRanges->btnAddRSelected->Text("$STR{'winAddRSelected'} >>");
      $winAddRanges->btnAddRSelected->Disable(); # No selection
    }
  } else { # Parent (1) or small (2) range only
    if ($nbrRows < 500) { &showRanges(   $curSel, $nbrRows); }
    else                { &showRangesThr($curSel, $nbrRows); }
  }
  
}  #--- End cbShowRanges_Change

#--------------------------#
sub showRanges
#--------------------------#
{
  # Local variables
  my ($curSel, $nbrRows) = @_;
  # Browse the grid
  for (my $i = 1; $i < $nbrRows; $i++) {
    my $j        = $i + 1;
    my $included = 1;
    while ($j < $nbrRows and $included < 3) {
      my $up_range_s = $winAddRanges->GridISPRanges->GetCellText($i, 1);
      my $up_range_e = $winAddRanges->GridISPRanges->GetCellText($i, 2);
      my $do_range_s = $winAddRanges->GridISPRanges->GetCellText($j, 1);
      my $do_range_e = $winAddRanges->GridISPRanges->GetCellText($j, 2);
      my ($up_range_sInt, $up_range_eInt, $do_range_sInt, $do_range_eInt);
      # Compare 2 IPv4
      if ($up_range_s =~ /\./ and $do_range_s =~ /\./ and $up_range_e and $do_range_e) {
        $up_range_sInt = unpack 'N', pack 'C4', split '\.', $up_range_s;
        $up_range_eInt = unpack 'N', pack 'C4', split '\.', $up_range_e;
        $do_range_sInt = unpack 'N', pack 'C4', split '\.', $do_range_s;
        $do_range_eInt = unpack 'N', pack 'C4', split '\.', $do_range_e;
      # Compare 2 IPv6
      } elsif ($up_range_s =~ /\:/ and $do_range_s =~ /\:/ and $up_range_e and $do_range_e) {
        my $up_range_sObj = NetAddr::IP::Lite->new6($up_range_s);
        my $up_range_eObj = NetAddr::IP::Lite->new6($up_range_e);
        my $do_range_sObj = NetAddr::IP::Lite->new6($do_range_s);
        my $do_range_eObj = NetAddr::IP::Lite->new6($do_range_e);
        $up_range_sInt    = $up_range_sObj->bigint();
        $up_range_eInt    = $up_range_eObj->bigint();
        $do_range_sInt    = $do_range_sObj->bigint();
        $do_range_eInt    = $do_range_eObj->bigint();
      }
      if ($up_range_sInt and $up_range_eInt and $do_range_sInt and $do_range_eInt) {
        $included = &inRange($up_range_sInt, $up_range_eInt, $do_range_sInt, $do_range_eInt);
        if ($included == 1 or $included == 2) {
          if      ($curSel == 1) { # Parent only
            if      ($included == 1) { # range1 in range2
              $winAddRanges->GridISPRanges->SetRowHeight($i, 0);    # Hide small
              $winAddRanges->GridISPRanges->SetCellCheck($i, 0, 0); # Uncheck small
              $winAddRanges->GridISPRanges->SetRowHeight($j, 23);
              $winAddRanges->GridISPRanges->SetCellCheck($j, 0, 1);
            } elsif ($included == 2) { # range2 in range1
              $winAddRanges->GridISPRanges->SetRowHeight($i, 23);
              $winAddRanges->GridISPRanges->SetCellCheck($i, 0, 1);
              $winAddRanges->GridISPRanges->SetRowHeight($j, 0);    # Hide small
              $winAddRanges->GridISPRanges->SetCellCheck($j, 0, 0); # Uncheck small
            } elsif ($included == 3) { last; } # range2 and range1 are different, continue with the next range
          } elsif ($curSel == 2) { # Small only
            if      ($included == 1) { # range1 in range2
              $winAddRanges->GridISPRanges->SetRowHeight($i, 23);
              $winAddRanges->GridISPRanges->SetCellCheck($i, 0, 1);
              $winAddRanges->GridISPRanges->SetRowHeight($j, 0);    # Hide parent
              $winAddRanges->GridISPRanges->SetCellCheck($j, 0, 0); # Uncheck parent
            } elsif ($included == 2) { # range2 in range1
              $winAddRanges->GridISPRanges->SetRowHeight($i, 0);    # Hide parent
              $winAddRanges->GridISPRanges->SetCellCheck($i, 0, 0); # Uncheck parent
              $winAddRanges->GridISPRanges->SetRowHeight($j, 23);
              $winAddRanges->GridISPRanges->SetCellCheck($j, 0, 1);
            } elsif ($included == 3) { last; } # range2 and range1 are different, continue with the next range
          }
        }
      }
      $j++;
    }
  }
  $winAddRanges->GridISPRanges->Refresh();
  $winAddRanges->GridISPRanges->BringWindowToTop();
  # Enable btnAddRSelected?
  my $nbrSel = 0;
  for (my $i = 1; $i < $winAddRanges->GridISPRanges->GetRows(); $i++) {
    $nbrSel++ if $winAddRanges->GridISPRanges->GetCellCheck($i, 0);
  }
  if ($nbrSel) {
    $winAddRanges->btnAddRSelected->Text("$STR{'winAddRSelected'} ($nbrSel) >>");
    $winAddRanges->btnAddRSelected->Enable();
  } else {
    $winAddRanges->btnAddRSelected->Text("$STR{'winAddRSelected'} >>");
    $winAddRanges->btnAddRSelected->Disable(); # No selection
  }
  
}  #--- End showRanges

#--------------------------#
sub showRangesThr
#--------------------------#
{
  # Local variables
  my ($curSel, $nbrRows) = @_;
  # Avoid new thread
  if ($THR and $THR->is_running()) { Win32::GUI::MessageBox($win, $STR{'errProcessRun'},$STR{'Error'},0x40010); }
  else {
    $THR = threads->create(sub {
      # Thread 'cancellation' signal handler
      $SIG{'KILL'} = sub {
        $winAddRanges->GridISPRanges->Refresh();
        &winPb_Terminate;
        $winAddRanges->ChangeCursor($ARROW);
        $winAddRanges->Enable();
        threads->exit();
      };
      # Thread 'die' signal handler
      $SIG{__DIE__} = sub {
        $winAddRanges->GridISPRanges->Refresh();
        &winPb_Terminate;
        $winAddRanges->ChangeCursor($ARROW);
        $winAddRanges->Enable();
      };
      # Show progress window
      $winPb->lblPbCurr->Text($STR{'applyFilters'});
      $winPb->lblCount->Text("0 / $nbrRows");
      $winPb->pbWinPb->SetRange(0, $nbrRows);
      $winPb->pbWinPb->SetPos(0);
      $winPb->pbWinPb->SetStep(1);
      $winPb->Center($winLogDB);
      $winPb->Show();
      $winAddRanges->Disable();
      $winAddRanges->ChangeCursor($HOURGLASS);
      # Browse the grid
      for (my $i = 1; $i < $nbrRows; $i++) {
        my $j        = $i + 1;
        my $included = 1;
        while ($j < $nbrRows and $included < 3) {
          my $up_range_s = $winAddRanges->GridISPRanges->GetCellText($i, 1);
          my $up_range_e = $winAddRanges->GridISPRanges->GetCellText($i, 2);
          my $do_range_s = $winAddRanges->GridISPRanges->GetCellText($j, 1);
          my $do_range_e = $winAddRanges->GridISPRanges->GetCellText($j, 2);
          my ($up_range_sInt, $up_range_eInt, $do_range_sInt, $do_range_eInt);
          # Compare 2 IPv4
          if ($up_range_s =~ /\./ and $do_range_s =~ /\./ and $up_range_e and $do_range_e) {
            $up_range_sInt = unpack 'N', pack 'C4', split '\.', $up_range_s;
            $up_range_eInt = unpack 'N', pack 'C4', split '\.', $up_range_e;
            $do_range_sInt = unpack 'N', pack 'C4', split '\.', $do_range_s;
            $do_range_eInt = unpack 'N', pack 'C4', split '\.', $do_range_e;
          # Compare 2 IPv6
          } elsif ($up_range_s =~ /\:/ and $do_range_s =~ /\:/ and $up_range_e and $do_range_e) {
            my $up_range_sObj = NetAddr::IP::Lite->new6($up_range_s);
            my $up_range_eObj = NetAddr::IP::Lite->new6($up_range_e);
            my $do_range_sObj = NetAddr::IP::Lite->new6($do_range_s);
            my $do_range_eObj = NetAddr::IP::Lite->new6($do_range_e);
            $up_range_sInt    = $up_range_sObj->bigint();
            $up_range_eInt    = $up_range_eObj->bigint();
            $do_range_sInt    = $do_range_sObj->bigint();
            $do_range_eInt    = $do_range_eObj->bigint();
          }
          if ($up_range_sInt and $up_range_eInt and $do_range_sInt and $do_range_eInt) {
            $included = &inRange($up_range_sInt, $up_range_eInt, $do_range_sInt, $do_range_eInt);
            if ($included == 1 or $included == 2) {
              if      ($curSel == 1) { # Parent only
                if      ($included == 1) { # range1 in range2
                  $winAddRanges->GridISPRanges->SetRowHeight($i, 0);    # Hide small
                  $winAddRanges->GridISPRanges->SetCellCheck($i, 0, 0); # Uncheck small
                  $winAddRanges->GridISPRanges->SetRowHeight($j, 23);
                  $winAddRanges->GridISPRanges->SetCellCheck($j, 0, 1);
                } elsif ($included == 2) { # range2 in range1
                  $winAddRanges->GridISPRanges->SetRowHeight($i, 23);
                  $winAddRanges->GridISPRanges->SetCellCheck($i, 0, 1);
                  $winAddRanges->GridISPRanges->SetRowHeight($j, 0);    # Hide small
                  $winAddRanges->GridISPRanges->SetCellCheck($j, 0, 0); # Uncheck small
                } elsif ($included == 3) { last; } # range2 and range1 are different, continue with the next range
              } elsif ($curSel == 2) { # Small only
                if      ($included == 1) { # range1 in range2
                  $winAddRanges->GridISPRanges->SetRowHeight($i, 23);
                  $winAddRanges->GridISPRanges->SetCellCheck($i, 0, 1);
                  $winAddRanges->GridISPRanges->SetRowHeight($j, 0);    # Hide parent
                  $winAddRanges->GridISPRanges->SetCellCheck($j, 0, 0); # Uncheck parent
                } elsif ($included == 2) { # range2 in range1
                  $winAddRanges->GridISPRanges->SetRowHeight($i, 0);    # Hide parent
                  $winAddRanges->GridISPRanges->SetCellCheck($i, 0, 0); # Uncheck parent
                  $winAddRanges->GridISPRanges->SetRowHeight($j, 23);
                  $winAddRanges->GridISPRanges->SetCellCheck($j, 0, 1);
                } elsif ($included == 3) { last; } # range2 and range1 are different, continue with the next range
              }
            }
          }
          $j++;
        }
        $winPb->lblCount->Text("$i / $nbrRows");
        $winPb->pbWinPb->StepIt();
      }# Enable btnAddRSelected?
      my $nbrSel = 0;
      for (my $i = 1; $i < $winAddRanges->GridISPRanges->GetRows(); $i++) {
        $nbrSel++ if $winAddRanges->GridISPRanges->GetCellCheck($i, 0);
      }
      if ($nbrSel) {
        $winAddRanges->btnAddRSelected->Text("$STR{'winAddRSelected'} ($nbrSel) >>");
        $winAddRanges->btnAddRSelected->Enable();
      } else {
        $winAddRanges->btnAddRSelected->Text("$STR{'winAddRSelected'} >>");
        $winAddRanges->btnAddRSelected->Disable(); # No selection
      }
      $winAddRanges->GridISPRanges->Refresh();
      $winAddRanges->GridISPRanges->BringWindowToTop();
      $winAddRanges->ChangeCursor($ARROW);
      &winPb_Terminate;
      $winAddRanges->Enable();
    });
  }
  
}  #--- End showRangesThr

#--------------------------#
sub btnRemNetNames_Click
#--------------------------#
{
  # Browse ISP column and remove netnames
  for (my $i = 1; $i < $winAddRanges->GridISPRanges->GetRows(); $i++) {
    my $ispName = $winAddRanges->GridISPRanges->GetCellText($i, 3);
    $ispName =~ s/ \([^\)]+\)$//;
    $winAddRanges->GridISPRanges->SetCellText($i, 3, $ispName);
  }
  $winAddRanges->GridISPRanges->AutoSizeColumns();
  $winAddRanges->GridISPRanges->ExpandColumnsToFit(0);
  $winAddRanges->GridISPRanges->Refresh();
  $winAddRanges->btnRemNetNames->Disable();
  return(1);
  
}  #--- End btnRemNetNames_Click

#--------------------------#
sub cbChoiceSel_Change
#--------------------------#
{
  # Local variables
  my $selChoice = $winAddRanges->cbChoiceSel->GetCurSel(); # First, Second or Last
  # Browse each row and set the selected choice
  for (my $i = 1; $i < $winAddRanges->GridISPRanges->GetRows(); $i++) {
    my $choicesStr = $winAddRanges->GridISPRanges->GetCellText($i, 5);
    my @choices    = split(/\|/, $choicesStr);
    if ($selChoice < 2) {
      $winAddRanges->GridISPRanges->SetCellText($i, 3, $choices[$selChoice]) if $choices[$selChoice];
    } else { $winAddRanges->GridISPRanges->SetCellText($i, 3, $choices[-1]); }
  }
  $winAddRanges->GridISPRanges->AutoSizeColumns();
  $winAddRanges->GridISPRanges->ExpandColumnsToFit(0);
  $winAddRanges->GridISPRanges->Refresh();

}  #--- End cbChoiceSel_Change

#--------------------------#
sub GridISPRanges_Click
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  # Sorting
  if (!$row and $column) {
    $winAddRanges->GridISPRanges->SetHeaderSort();
    my $order = $winAddRanges->GridISPRanges->GetSortAscending();
    if    ($column < 3) { $winAddRanges->GridISPRanges->SortCells($column, $order, \&sortIP); }
    else                { $winAddRanges->GridISPRanges->SortCells($column, $order, sub { my ($e1, $e2) = @_; return (lc($e1) cmp lc($e2)); }); }
  }
  # Select
  if (!$column) {
    my $selStatus = $winAddRanges->GridISPRanges->GetCellCheck($row, 0);
    if (!$row) { # Check/Uncheck all
      if (!$selStatus) {
				for (my $i = 0; $i < $winAddRanges->GridISPRanges->GetRows(); $i++) { $winAddRanges->GridISPRanges->SetCellCheck($i, 0, 1); }
			} else {
				for (my $i = 0; $i < $winAddRanges->GridISPRanges->GetRows(); $i++) { $winAddRanges->GridISPRanges->SetCellCheck($i, 0, 0); }
			}
    } else { # Check/Uncheck one row
      if (!$selStatus) { $winAddRanges->GridISPRanges->SetCellCheck($row, 0, 1); } # Check
      else             { $winAddRanges->GridISPRanges->SetCellCheck($row, 0, 0); } # Uncheck
    }
  }
  $winAddRanges->GridISPRanges->Refresh();
  # Enable btnAddRSelected?
  my $nbrSel = 0;
  for (my $i = 1; $i < $winAddRanges->GridISPRanges->GetRows(); $i++) {
    $nbrSel++ if $winAddRanges->GridISPRanges->GetCellCheck($i, 0);
  }
  if ($nbrSel) {
    $winAddRanges->btnAddRSelected->Text("$STR{'winAddRSelected'} ($nbrSel) >>");
    $winAddRanges->btnAddRSelected->Enable();
  } else {
    $winAddRanges->btnAddRSelected->Text("$STR{'winAddRSelected'} >>");
    $winAddRanges->btnAddRSelected->Disable(); # No selection
  }
  
}  #--- End GridISPRanges_Click

#--------------------------#
sub btnGetRangesPrev_Click
#--------------------------#
{
  # Reset window controls
  $winAddRanges->lblTitle->Text($STR{'Organisation'}.':');
  $winAddRanges->lblShowRanges->Hide();
  $winAddRanges->cbShowRanges->Hide();
  $winAddRanges->btnRemNetNames->Hide();
  $winAddRanges->lblChoiceSel->Hide();
  $winAddRanges->cbChoiceSel->Hide();
  $winAddRanges->lblChoiceSel2->Hide();
  $winAddRanges->GridISPRanges->Hide();
  $winAddRanges->btnGetRangesPrev->Hide();
  $winAddRanges->btnAddRSelected->Hide();
  $winAddRanges->lblRangesOrgName->Show();
  $winAddRanges->lblRangesOrgNameVal->Show();
  $winAddRanges->lblRangesSource->Show();
  $winAddRanges->lblRangesSourceVal->Show();
  $winAddRanges->tsGetRanges->Show();
  $winAddRanges->rbGetRangesForm->Show();
  $winAddRanges->rbGetRangesTV->Show();
  $winAddRanges->rbGetRangesRaw->Show();
  $winAddRanges->tfGetRangesRoute->Hide();
  $winAddRanges->tfGetRangesOrg->Hide();
  $winAddRanges->tfGetRangesASN->Hide();
  $winAddRanges->tvGetRangesRoute->Hide();
  $winAddRanges->tvGetRangesOrg->Hide();
  $winAddRanges->tvGetRangesASN->Hide();
  $winAddRanges->tfGetRangesRouteRaw->Hide();
  $winAddRanges->tfGetRangesOrgRaw->Hide();
  $winAddRanges->tfGetRangesASNRaw->Hide();
  $winAddRanges->rbGetRangesForm->Checked(1);
  $winAddRanges->rbGetRangesTV->Checked(0);
  $winAddRanges->rbGetRangesRaw->Checked(0);
  my $curTabSel = $winAddRanges->tsGetRanges->GetString($winAddRanges->tsGetRanges->GetCurSel());
  if    ($curTabSel eq $STR{'Route'}) { $winAddRanges->tfGetRangesRoute->Show();   }
  elsif ($curTabSel eq $STR{'Org'}  ) { $winAddRanges->tfGetRangesOrg->Show(); }
  else                                { $winAddRanges->tfGetRangesASN->Show();   }
  if ($winAddRanges->tfRangesORGVal->Text()) {
    $winAddRanges->lblRangesORG->Show();
    $winAddRanges->tfRangesORGVal->Show();
    $winAddRanges->btnGetRangesORG->Show();
  }
  if ($winAddRanges->cbRangesASNVal->GetString($winAddRanges->cbRangesASNVal->GetCurSel())) {
    $winAddRanges->lblRangesASN->Show();
    $winAddRanges->cbRangesASNVal->Show();
    $winAddRanges->btnGetRangesASN->Show();
  }
  return(1);
  
}  #--- End btnGetRangesPrev_Click

#--------------------------#
sub btnAddRSelected_Click { $THR = threads->create(sub { &addRangeWhoisDB(); }); }
#--------------------------#

#--------------------------#
sub addRangeWhoisDB
#--------------------------#
{
  # Local variables
  my $dateStr = &time2DateLong(time);
  my @listRanges;
  my $i = 1;
  # Turn on progress bar
  &winAddRanges_Terminate;
  $winPb->Center($winDB);
  $winPb->Show();
  $winPb->lblPbCurr->Text('');
  $winPb->lblCount->Text('');
  $winDB->Disable();
  $winDB->ChangeCursor($HOURGLASS);
  # List of ISP ranges to add and add missing data
  # To Fields: 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
  while ($i < $winAddRanges->GridISPRanges->GetRows()) {
    if ($winAddRanges->GridISPRanges->GetCellCheck($i, 0) == 1) {
      my $newISP;
      my $range_s = $winAddRanges->GridISPRanges->GetCellText($i, 1);
      my $range_e = $winAddRanges->GridISPRanges->GetCellText($i, 2);
      my $ispName = $winAddRanges->GridISPRanges->GetCellText($i, 3);
      my $country = $winAddRanges->GridISPRanges->GetCellText($i, 4);
      if ($range_s and $range_e and $ispName and $country) {
        # IPv4
        if ($range_s !~ /\:/) { $newISP = "IPv4\t$range_s\t$range_e\t$ispName\t$country\t$dateStr"; }
        # IPv6
        else {
          my $cidr = Net::CIDR::range2cidr("$range_s\-$range_e");
          $newISP = "IPv6\t$cidr\tNULL\t$ispName\t$country\t$dateStr";
        }
        push(@listRanges, $newISP);
      }
    }
    $i++;
  }
  # Update DB
  my $nbrISP = scalar(@listRanges);
  $winPb->lblPbCurr->Text($STR{'winAddRSelected'}.'...');
  my ($nbrAdd, $nbrModif) = &feedWhoisDatabase(\@listRanges, $nbrISP);
  # Refresh grid
  $winDB->DBGrid->AutoSizeColumns();
  $winDB->DBGrid->ExpandColumnsToFit(0);
  $winDB->DBGrid->SetListMode();
  $winDB->DBGrid->ScrollPos(1,0);
  $winDB->DBGrid->SortCells(0, 1, \&sortIP);
  $winDB->DBGrid->Refresh();
  # Status bar
  $nbrISP = $winDB->DBGrid->GetRows() - 1;
  $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP | $STR{'numberISP'} $STR{'added'}: $nbrAdd | $STR{'numberISP'} $STR{'modified'}: $nbrModif");
  # Turn off progress bar
  $winPb->lblPbCurr->Text('');
  $winPb->lblCount->Text('');
  $winPb->pbWinPb->SetPos(0);
  &winPb_Terminate;
  $winDB->ChangeCursor($ARROW);
  
}  #--- End addRangeWhoisDB

#--------------------------#
sub btnAddRCancel_Click { &winAddRanges_Terminate; }
#--------------------------#

#--------------------------#
sub winAddRanges_Terminate
#--------------------------#
{
  $winAddRanges->Hide();
  return(0);
  
}  #--- End winAddRanges_Terminate

#--------------------------#
sub gridSelectAll_Click
#--------------------------#
{
  $winDB->DBGrid->OnEditSelectAll();
  return(1);

}  #--- End GridSelectAll_Click

#--------------------------#
sub lineCopy_Click
#--------------------------#
{
  my (@coord) = $winDB->DBGrid->GetSelectedCellRange();
  my $content;
  # Selected ISPs
  my $lastSelectedRow; 
  if ($coord[2]) { $lastSelectedRow = $coord[2]; }
  else           { $lastSelectedRow = $coord[0]; }
  # Header is always inserted
  for (my $col = 0; $col <= $winDB->DBGrid->GetColumns(); $col++) {
    $content .= $winDB->DBGrid->GetCellText(0, $col) . "\t";
  }
  chop($content);
  $content .= "\r\n";
  for (my $row = $coord[0]; $row <= $lastSelectedRow; $row++) {
    if ($winDB->DBGrid->IsCellSelected($row, 1)) {
      for (my $col = 0; $col <= $winDB->DBGrid->GetColumns(); $col++) {
        $content .= $winDB->DBGrid->GetCellText($row, $col) . "\t";
      }
      chop($content);
      $content .= "\r\n";
    }
  }
  Win32::Clipboard::Set($content) if $content;
  return(1);

}  #--- End lineCopy

#--------------------------#
sub deleteLine_Click
#--------------------------#
{
  # Local variables
  my(@coord)  = $winDB->DBGrid->GetSelectedCellRange();
  my $nbrISP  = $winDB->DBGrid->GetRows();
  my $whoisDB = $winConfig->tfDbFile->Text();
  my @ISP2del;
  # Select data to delete
  my $lastSelectedRow; 
  if ($coord[2]) { $lastSelectedRow = $coord[2]; }
  else           { $lastSelectedRow = $coord[0]; }
  for (my $row = $coord[0]; $row <= $lastSelectedRow; $row++) {
    if ($winDB->DBGrid->IsCellSelected ($row, 0) and $winDB->DBGrid->GetRowHeight($row)) { # Selected and not hidden
      my $range_s = $winDB->DBGrid->GetCellText($row, 0);
      my $range_e = $winDB->DBGrid->GetCellText($row, 1);
      push(@ISP2del, "$range_s\-$range_e");
    }
  }
  $THR = threads->create(sub {
    # Thread 'cancellation' signal handler
    $SIG{'KILL'} = sub {
      # Sort grid
      $winDB->DBGrid->SortCells(0, 1, \&sortIP);
      $winDB->DBGrid->Refresh();
      # Status bar
      $nbrISP = $winDB->DBGrid->GetRows() - 1;
      $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP");
      &winPb_Terminate;
      $winDB->ChangeCursor($ARROW);
      threads->exit();
    };
    # Show progress window
    my $nbrISP2del = @ISP2del;
    $winPb->lblPbCurr->Text($STR{'deletingISP'});
    $winPb->lblCount->Text("0 / $nbrISP2del");
    $winPb->pbWinPb->SetRange(0, $nbrISP2del);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    $winPb->Center($winDB);
    $winPb->Show();
    $winDB->Disable();
    $winDB->ChangeCursor($HOURGLASS);
    # Connect to DB
    my $dsn = "DBI:SQLite:dbname=$whoisDB";
    my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
              or Win32::GUI::MessageBox($winDB, $STR{'errCreating'}.' '.$STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010);
    # Loop each entry and delete
    my $j = 0;
    foreach my $ISP (@ISP2del) {
      my ($ISPRange_s, $ISPRange_e) = split(/\-/, $ISP);
      for (my $i = 0; $i < $nbrISP; $i++) {
        my $range_s = $winDB->DBGrid->GetCellText($i, 0);
        my $range_e = $winDB->DBGrid->GetCellText($i, 1);
        # Entry have been found
        if (($ISPRange_s eq $range_s) and ($ISPRange_e eq $range_e)) {
          my $return;
          if    ($ISPRange_s =~ /\./) { $return = &deleteISP_IPv4(\$dbh, $ISPRange_s, $ISPRange_e); } # Delete in Database (IPv4)
          elsif ($ISPRange_s =~ /\:/) { $return = &deleteISP_IPv6(\$dbh, $ISPRange_s, $ISPRange_e); } # Delete in Database (IPv6)
          if ($return) {
            &deleteISPGrid($i, $ISPRange_s, $ISPRange_e); # Delete in Grid
            # Delete the Network Whois Data File
            my $networkWhoisDataFile = "$CONFIG{'WHOIS_DATA_CACHE'}\\$ISPRange_s\-$ISPRange_e\.txt";
            unlink($networkWhoisDataFile) if -e $networkWhoisDataFile;
          }
          last;
        }
      }
      $j++;
      $winPb->lblCount->Text("$j / $nbrISP2del");
      $winPb->pbWinPb->StepIt();
    }
    $winDB->ChangeCursor($ARROW);
    &winPb_Terminate;
    $dbh->disconnect();
    # Sort grid
    $winDB->DBGrid->SortCells(0, 1, \&sortIP);
    $winDB->DBGrid->Refresh();
    # Status bar
    $nbrISP = $winDB->DBGrid->GetRows() - 1;
    $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP");
  });
  return(1);

}  #--- End deleteLine_Click

#--------------------------#
sub sortLC
#--------------------------#
{
  my ($a, $b) = @_;
  return (lc($a) cmp lc($b));

}  #--- End sortLC

#--------------------------#
sub sortIP
#--------------------------#
{
  # Split IP addresses
  my ($a, $b) = @_;
  # Both IPv4
  if ($a and $b and $a !~ /\:/ and $b !~ /\:/) {
    my ($a1, $a2, $a3, $a4) = split(/\./, $a);
    my ($b1, $b2, $b3, $b4) = split(/\./, $b);
    # Compare each part
    if ($a1 == $b1) {
      if ($a2 == $b2) {
        if ($a3 == $b3) {
          return $a4 <=> $b4;
        } else { return $a3 <=> $b3; }
      } else { return $a2 <=> $b2; }
    } else { return $a1 <=> $b1; }
  }
  # IPv6 always greate than IPv4
  elsif ($a =~ /\:/ and $b !~ /\:/) { return(1);  } # IPv6 > IPv4
  elsif ($a !~ /\:/ and $b =~ /\:/) { return(-1); } # IPv4 < IPv6
  # If both are IPv6:
  else {
    my $ipv6_a = new NetAddr::IP($a);
    my $ipv6_b = new NetAddr::IP($b);
    return ($ipv6_a <=> $ipv6_b);
  }
  
}  #--- End sortIP

#--------------------------#
sub btnWhois_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) { Win32::GUI::MessageBox($win, $STR{'errProcessRun'},$STR{'Error'},0x40010); }
  else {
    # Extract Items from Clipboard
    my %itemsIndex;
    my %itemsType;
    my $nbrItems = &extractRequestItems(\%itemsIndex, \%itemsType);
    if (!$nbrItems) {
      Win32::GUI::MessageBox($win, $STR{'errClipboard'}, $STR{'Error'}, 0x40010);
      return(0);
    # Whois Request
    } else {
      $THR = threads->create(sub {
        # Thread 'cancellation' signal handler
        $SIG{'KILL'} = sub {
          &winPb_Terminate;
          $win->ChangeCursor($ARROW);
          threads->exit();
        };
        # Thread 'die' signal handler
        $SIG{__DIE__} = sub {
          return if $_[0] and ($_[0]->isa('GeoIP2::Error::Generic') or $_[0]->isa('GeoIP2::Error::IPAddressNotFound'));
          my $errMsg = (split(/ at /,$_[0]))[0];
          chomp($errMsg);
          $errMsg =~ s/[\t\r\n]/ /g;
          $win->ChangeCursor($ARROW);
          &winPb_Terminate;
          Win32::GUI::MessageBox($winDB, "$STR{'Error'}: $errMsg", $STR{'Error'}, 0x40010);
        };
        # Show progress window
        $winPb->lblPbCurr->Text($STR{'whoisProgress'});
        $winPb->lblCount->Text("0 / $nbrItems");
        $winPb->pbWinPb->SetRange(0, $nbrItems);
        $winPb->pbWinPb->SetPos(0);
        $winPb->pbWinPb->SetStep(1);
        $winPb->Center($win);
        $winPb->Show();
        $win->Disable();
        $win->ChangeCursor($HOURGLASS);
        # Local variables
        my $targetDir     = $winConfig->tfReportDir->Text();
        my $whoisDB       = $winConfig->tfDbFile->Text();
        my $dbLogFile     = $winConfig->tfLogDbFile->Text();
        my $nbrAdded      = 0;
        my $nbrModified   = 0;
        my $checkDBOpt    = $win->cbCheckWhoisDB->GetCurSel();
        # Possible values for $checkDBOpt: 0 = Don't check, 1 = If present, ask, 2 = If present, ignore, 3 = Check after
        my $checkLogging  = $win->chCheckLogging->Checked(); # If == 1, check logging database for item
        my $count         = 0;
        my $dbh;
        my $dbhLog;
        my %nwData;
        my $refNWData     = \%nwData; # To store network whois data
        my @newISP;
        my %IPv4; # IPv4 Database
        my %IPv6; # IPv6 Database
        # Load IPv4 and IPv6
        if ($winConfig->rbNWModeNormal->Checked()) { # Mode WHOIS
          &loadIPv4DB(\%IPv4)      if $CONFIG{'IPv4_DB_FILE'} and -T $CONFIG{'IPv4_DB_FILE'};
          &loadIPv6DB(\%IPv6)      if $CONFIG{'IPv6_DB_FILE'} and -T $CONFIG{'IPv6_DB_FILE'};
        } else {                                     # Mode RDAP
          &loadIPv4DB_RDAP(\%IPv4) if $CONFIG{'IPv4_DB_FILE'} and -T $CONFIG{'IPv4_DB_FILE'};
          &loadIPv6DB_RDAP(\%IPv6) if $CONFIG{'IPv6_DB_FILE'} and -T $CONFIG{'IPv6_DB_FILE'};
        }
        # Connect to Whois Database
        if ($whoisDB and -f $whoisDB) {
          my $dsn  = "DBI:SQLite:dbname=$whoisDB";
             $dbh  = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
                     or Win32::GUI::MessageBox($win, $STR{'errConnectingDB'}.$DBI::errstr, $STR{'Error'}, 0x40010);
        }
        # Connect to Logging Database
        if ($winConfig->chLogActivate->Checked() and $dbLogFile and -f $dbLogFile) {
          my $dsnLog = "DBI:SQLite:dbname=$dbLogFile";
          $dbhLog    = DBI->connect($dsnLog, undef, undef, { RaiseError => 1, AutoCommit => 1 })
                       or Win32::GUI::MessageBox($win, $STR{'errConnectingDB'}.$DBI::errstr, $STR{'Error'}, 0x40010);
        }
        # Load Whois Server Database
        my $ref_WSDB = json_file_to_perl($CONFIG{'WS_DB_FILE'});
        if (!$TLDDB) {
          $TLDDB = Domain::PublicSuffix->new({ 'data_file' => $CONFIG{'TLD_DB_FILE'} }) or
          Win32::GUI::MessageBox($win, $STR{'errLoadingDB'}, $STR{'Error'},0x40010);
        }
        foreach my $item (sort { $itemsIndex{$a} <=> $itemsIndex{$b} } keys(%itemsIndex)) {
          my $answer;
          my $return;
          $count++;
          $winPb->lblCount->Text("$count / $nbrItems");
          $winPb->lblPbCurr->Text("Whois on $item...");
          # Check databases
          if (($checkDBOpt and ($checkDBOpt == 1 or $checkDBOpt == 2) and $win->chNetwork->Checked()) or $checkLogging) {
            my $resCheckDB;
            # Check Whois Database (Network whois only)
            if ($checkDBOpt and ($checkDBOpt == 1 or $checkDBOpt == 2) and $win->chNetwork->Checked() and
                ($itemsType{$item} eq 'IPv4' or $itemsType{$item} eq 'IPv6')) {
              my ($isp, $country, $time);
              if    ($item =~ /\./) { ($isp, $country, $time) = &checkIP_WhoisDB_IPv4($item, \$dbh); } # IPv4
              elsif ($item =~ /\:/) { ($isp, $country, $time) = &checkIP_WhoisDB_IPv6($item, \$dbh); } # IPv6
              # ISP is already known, ignore the request
              if    ($checkDBOpt == 2 and $isp) { $answer = 7; }
              # ISP is already known, ask user what to do
              elsif ($checkDBOpt == 1 and $isp) {
                my $dateStr  = &time2DateLong($time);
                my $ispStr   = "$STR{'ISP'}: $isp\n$STR{'Country'}: $country\n$STR{'date'}: $dateStr";
                $resCheckDB .= "$STR{'item'} \xAB $item \xBB $STR{'wasFoundWhoisDB'}:\n\n$ispStr\n\n";
              }
            }
            # Check Logging Database
            if ($checkLogging and !$answer) {
              my ($nbrResults, @results) = &check_LoggingDB($item, \$dbhLog);
              if ($nbrResults) {
                # More than 3 results
                if ($nbrResults > 3) { $resCheckDB .= "$STR{'more3entries'} \xAB $item \xBB $STR{'inLoggingDBLast3'}:\n\n"; }
                else                 { $resCheckDB .= "$STR{'item'} \xAB $item \xBB $STR{'wasFoundLoggingDB'}:\n\n"; }
                # Add entries to message
                foreach my $entry (@results) {
                  my @fields = split(/\t/, $entry);
                  my $logStr = "$STR{'date'}: $fields[0]\n$STR{'request'}: $fields[1]\n";
                  if ($fields[2] ne 'NULL') { $logStr .= "$STR{'details'}: $fields[2]\n"; }
                  else                      { $logStr .= "$STR{'details'}:\n";            }
                  if ($fields[3] ne 'NULL') { $logStr .= "$STR{'comment'}: $fields[3]\n"; }
                  else                      { $logStr .= "$STR{'comment'}:\n";            }
                  $resCheckDB .= "$logStr\n";
                }
              }
            }
            # Entry was found, Ask the user?
            if (!$answer and $resCheckDB) {
              $answer = Win32::GUI::MessageBox($win, $resCheckDB.$STR{'sendQueryAnyway'}, $STR{'checkDB'}, 0x1023);
              $winPb->SetForegroundWindow();
            }
          }
          # Cancel (2), finish all requests
          if ($answer and $answer == 2) {
            &winPb_Terminate;
            last;
          # Answer is No (7) or Check database option is ignore, ignore this request
          } elsif ($answer and $answer == 7) { next; }
          # Answer is Yes (6), send the request
          my $refAnswer = &whoisReq($item, $itemsType{$item}, $ref_WSDB, \$TLDDB, \%IPv4, \%IPv6);
          # Get local time
          my $dateStr    = &time2DateLong(time);
          my $dateOffset = gmt_offset();
          my $dateStrGMT = "$dateStr GMT $dateOffset";
          # Write the report
          $return = &writeReport($refAnswer, $dateStrGMT, $winConfig->rbNWModeNormal->Checked());
          # Feed logging database
          if ($winConfig->chLogActivate->Checked()) {
            # Set lookup string
            my $lookup;
            my $i = 1;
            if    ($$refAnswer{'lookup1'})  { $lookup  = "Resolved: " . $$refAnswer{"lookup$i"}; $i++; }
            while ($$refAnswer{"lookup$i"}) { $lookup .= ", ".$$refAnswer{"lookup$i"}; $i++; }
            my $comment = $win->tfComment->Text();
            $comment    = 'NULL' if !$comment;
            $lookup     = 'NULL' if !$lookup;
            &logRequest($item, \$dbhLog, $lookup, $dateStrGMT, $comment);
            &addToLogDBGrid($dateStrGMT, $item, $lookup, $comment);
          }
          # Set report filename
          my $filename   = $item;
          $filename      =~ s/[\<\>\:\"\/\\\|\?\*]/_/g; # Replace unauthorized character by _
          my $reportPath =  "$targetDir\\$filename\.html";
          # Check if report already exists
          if (!$winConfig->chReplace->Checked()) {
            my $k = 1;
            while (-e $reportPath) {
              $k++;
              $reportPath = "$targetDir\\$filename req$k\.html";
            }
          }
          # Write report to file
          open(HTML, ">$reportPath") or Win32::GUI::MessageBox($win, $STR{'errWriting'}.' '.$STR{'report'}.': '.$!, $STR{'Error'}, 0x40010);
          flock(HTML, 2);
          print HTML $return;
          close(HTML);
          # Update Logging database
          &modLogDBGrid($item) if $winConfig->chLogActivate->Checked();
          # Feed whois database
          my $refExtractedISP;
          # Mode WHOIS
          if ($winConfig->rbNWModeNormal->Checked())  { $refExtractedISP = &extractISPData($reportPath);    }
          # Mode RDAP
          else                                        { $refExtractedISP = &extractISPDataRDAP($refAnswer); }
          my $result2log;
          foreach my $newISP (keys %{$refExtractedISP}) {
            my $lineInGrid;
            if ($newISP) {
              # Fields ($newISP): 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
              my @fields = split(/\t/, $newISP);
              # Check if ISP already exists in database
              my $response;
              if    ($fields[0] eq 'IPv4') { $response = &checkISP_IPv4(\$dbh, $fields[1], $fields[2]); }
              elsif ($fields[0] eq 'IPv6') { $response = &checkISP_IPv6(\$dbh, $fields[1]); }
              # Fields ($response): 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
              # ISP exists, modify it?
              if ($response) {
                my @oldFields = split(/\t/, $response);
                # If option is Check After
                if ($checkDBOpt == 3) {
                  my $oldISPStr = "$STR{'inDatabase'}:\n$STR{'ISP'}: $oldFields[3]\n$STR{'Country'}: $oldFields[4]\n$STR{'date'}: $oldFields[5]";
                  my $newISPStr = "$STR{'Current'}:\n$STR{'ISP'}: $fields[3]\n$STR{'Country'}: $fields[4]\n$STR{'date'}: $fields[5]";
                  $answer = Win32::GUI::MessageBox($win,
                                                   "$STR{'item'} \xAB $item \xBB $STR{'wasFoundWhoisDB'}\n\n$oldISPStr\n\n$newISPStr\n\n$STR{'updateEntry'}?",
                                                   $STR{'checkWhois'},
                                                   0x1023);
                  $winPb->SetForegroundWindow();
                  # Cancel (2), finish all requests
                  if ($answer == 2) {
                    &winPb_Terminate;
                    last;
                  # Answer is No (7), ignore this result and continue
                  } elsif ($answer == 7) { next; }
                }
                # Answer is Yes (6), modify entry
                if ($checkDBOpt != 3 or $answer == 6) {
                  my $return = &modifyISP(\$dbh, \@fields);
                  if ($return) {
                    $lineInGrid = &modifyISPGrid(\@fields);
                    $nbrModified++;
                    # Store Network whois data
                    &storeNWData($fields[1], $fields[2], \$$refExtractedISP{$newISP}, $lineInGrid)
                    if $winConfig->chDBCache->Checked() and exists($$refExtractedISP{$newISP}) and length($$refExtractedISP{$newISP}) > 1;
                  }
                }
              }
              # ISP doesn't exist, add it
              else {
                my $return = &addISP(\$dbh, \@fields);
                if ($return) {
                  $lineInGrid = &addISPGrid(\@fields);
                  $nbrAdded++;
                  # Store Network whois data
                  &storeNWData($fields[1], $fields[2], \$$refExtractedISP{$newISP}, $lineInGrid)
                  if $winConfig->chDBCache->Checked() and exists($$refExtractedISP{$newISP}) and length($$refExtractedISP{$newISP}) > 1;
                }
              }
            }
          }
          $winPb->pbWinPb->StepIt();
          # Show report depending on config
          if ((!$answer or $answer == 6) and $reportPath) {
            # Auto view reports in default HTML viewer
            if ($winConfig->chAutoViewing->Checked() and $nbrItems <= $winConfig->tfMaxView->Text()) {
              $win->ShellExecute('open', $reportPath,'','',1)
                or Win32::GUI::MessageBox($win, $STR{'errViewingReport'}.Win32::GetLastError(), $STR{'Error'}, 0x40010);
            }
            &btnOpenDir_Click if $winConfig->chAutoViewDir->Checked(); # Auto view folder
          }
        }
        $dbh->disconnect()    if $dbh;
        $dbhLog->disconnect() if $dbhLog;
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        &winPb_Terminate;
        $win->ChangeCursor($ARROW);
        # Refresh grid
        if ($nbrAdded) {
          $winDB->DBGrid->AutoSizeColumns();
          $winDB->DBGrid->ExpandColumnsToFit(0);
          $winDB->DBGrid->SetListMode();
          $winDB->DBGrid->ScrollPos(1,0);
          $winDB->DBGrid->SortCells(0, 1, \&sortIP);
          $winDB->DBGrid->Refresh();
        }
        # Message
        my $nbrISP = $winDB->DBGrid->GetRows() - 1;
        my $msg;
        $msg .= "$STR{'numberISP'} $STR{'added'}: $nbrAdded\n"       if $nbrAdded;
        $msg .= "$STR{'numberISP'} $STR{'modified'}: $nbrModified\n" if $nbrModified;
        $msg .= "$STR{'totalNumberISP'}: $nbrISP\n";
        $winDB->statusBar->Text(" $STR{'numberISP'}: ".$nbrISP);
        # Final message
        $win->Tray->Change(-tip => $msg);
        if (!$win->IsVisible() and !$winDB->IsVisible()) {
          $win->Tray->Change(-balloon_icon => 'info', -balloon_title => "XL-Whois",
                             -balloon_tip => $msg);
          $win->Tray->ShowBalloon(1);
        } else {
          my $winH = $win;
          $winH    = $winDB if $winDB->IsVisible();
          Win32::GUI::MessageBox($winH, $msg, $STR{'winDB'}, 0x40040);
        }
      });
    }
  }

}  #--- End btnWhois_Click

#--------------------------#
sub createCommentPrompt
#--------------------------#
{
  # Comment prompt Window
  $winComment = Win32::GUI::Window->new( -name        => 'winComment'          ,
                                         -background  => [255, 255, 255]       ,
                                         -text        => $STR{'lblAddComment'} ,
                                         -pos         => [$winPosX, $winPosY]  ,
                                         -size        => [320,100]             ,
                                         -hasmaximize => 0                     ,
                                         -hasminimize => 0                     ,
                                         -resizable   => 0                     ,
                                         -dialogui    => 1                     , );
  $winComment->SetIcon($winICO);
  $winComment->AddTextfield(-name     => 'tfComment2'     ,
                            -size     => [305, 24]        ,
                            -pos      => [  5,  5]        ,
                            -font     => $font10          , );
  $winComment->AddButton(   -name     => 'btnCommentOk'   ,
                            -text     => $STR{'Whois'}    ,
                            -size     => [ 80, 30]        ,
                            -pos      => [120, 35]        ,
                            -font     => $font10          ,
                            -ok       => 1                ,
                            -default  => 1                , );
  
}  #--- End createCommentPrompt

#--------------------------#
sub btnWhoisComment_Click
#--------------------------#
{
  # Open comment prompt
  &createCommentPrompt() if !$winComment;
  $winComment->tfComment2->Text('');
  $winComment->Center($win);
  $winComment->Show();
  return(1);  

}  #--- End btnWhoisComment_Click

#--------------------------#
sub btnCommentOk_Click
#--------------------------#
{
  # Local variables
  my $comment = $winComment->tfComment2->Text();
  $win->tfComment->Text($comment);
  $winComment->tfComment2->Text('');
  $winComment->Hide();
  &btnWhois_Click();  

}  #--- End btnCommentOk_Click

#--------------------------#
sub winComment_Terminate
#--------------------------#
{
  $winComment->Hide();
  return(0);

}  #--- End winComment_Terminate

#--------------------------#
sub whoisReq
#--------------------------#
{
  # Local variables
  my ($item, $type, $refWSL, $refTLD, $refIPv4, $refIPv6) = @_;
  my $isIP;
  my $domain;
  my %response;
  my $error = 0;
  # If IP
  $item =~ s/ //g;
  if      ($type eq 'IPv4' or $type eq 'IPv6') {
    $isIP   = 1;
  } elsif (my $extDom = $$refTLD->get_root_domain($item)) {
    $domain = $extDom;
  } else { $error = 1; }
  if ($error != 1) {
    # Do main request
    $response{'query'} = $item;
    if    ($isIP   and ($win->chNetwork->Checked())) {
      $response{'ip1'} = $item;
      if ($winConfig->rbNWModeNormal->Checked()) { # Mode WHOIS
        &networkWhois(    $response{'query'}, 1, $item, \%response, $refIPv4, $refIPv6);
      } else {                                     # Mode RDAP
        &networkWhoisRDAP($response{'query'}, 1, $item, \%response, $refIPv4, $refIPv6);
      }
    }
    elsif ($domain and ($win->chDomain->Checked())) {
      $response{'domain1'} = $domain;
      &domainWhois($response{'query'}, 1, $domain, \%response, $refTLD, $refWSL);
    }
    # Do secondary request
    my @resps;
    if (($isIP and ($win->chDomain->Checked())) or ($domain and ($win->chNetwork->Checked()))) {
      # NSlookup
      $winPb->lblPbCurr->Text("$response{'query'}: nslookup -> $item");
      my $lookup = &nsLookup($response{'query'}, $type);
      if ($lookup =~ /, /) { @resps = split(/, /, $lookup); }
      else                 { push(@resps, $lookup);         }
      my $i = 1;
      foreach my $resp (@resps) {
        $response{"lookup$i"} = $resp;
        # Do additionnal requests
        if ($isIP) {
          # Domain Whois
          if (my $extDom = $$refTLD->get_root_domain($resp)) {
            $response{"domain$i"} = $extDom;
            &domainWhois($response{'query'}, $i, $extDom, \%response, $refTLD, $refWSL);
          } else { $error = 1; }
          # Network Whois
        } elsif ($resp =~ /^((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))/ or $resp =~ /^($IPv6_re$)/) {
          $response{"ip$i"} = $1;
          if ($winConfig->rbNWModeNormal->Checked()) { # Mode WHOIS
            &networkWhois(    $response{'query'}, $i, $1, \%response, $refIPv4, $refIPv6);
          } else {                                     # Mode RDAP
            &networkWhoisRDAP($response{'query'}, $i, $1, \%response, $refIPv4, $refIPv6);
          }
        } # Else = No match
        $i++;
      }
    }
    # GeoIP
    if ($win->chGeoIP->Checked() and my $geoIPDB = $winConfig->tfGeoIPDB->Text()) {
      my $i = 1;
      foreach my $key (keys %response) {
        my $ip;
        if ($ip = $response{"ip$i"} or $ip = $response{"lookup$i"}) {
          &getGeoIPData($response{'query'}, $ip, $i, \%response, $geoIPDB);
        }
        $i++;
      }
    }
    # DNS Records
    if ($win->chDNS->Checked()) {
      my @host;
      if ($isIP) { # Initial request was an IP address
        if (!scalar(@resps)) { # NSLookup not done
          # NSlookup
          $winPb->lblPbCurr->Text("$item: nslookup -> $item");
          my $lookup = &nsLookup($item, $type);
          if ($lookup =~ /, /) { @host = split(/, /, $lookup); }
          else                 { push(@host, $lookup);         }
        # NSLookup already done
        } else { push(@host, @resps); }
      # Initial request was not an IP address
      } else { push(@host, $item); }
      # Get DNS Infos
      my $j = 1;
      foreach my $domainHost (@host) {
        if (my $extDom = $$refTLD->get_root_domain($domainHost)) {
          $domain = $extDom if !$domain;
          $winPb->lblPbCurr->Text("$item : DNS records -> $domain");
          $response{"dnsRecords$j"} = &dnsRecords($domainHost, $domain);
        }
        $j++;
      }
    }
  # Erreur
  } else { $response{'Error'} = $STR{'errResolver'}."\n"; }
  
  return(\%response);

}  #--- End whoisReq

#--------------------------#
sub whoisQuery
#--------------------------#
{
  # Local variables
  my $registry = shift;
  my $query    = shift;
  my $sock     = IO::Socket::INET->new( PeerAddr => $registry, PeerPort =>'43', Timeout  =>'60');
  if ($sock) {
    print $sock "$query\n";
    my @response = <$sock>;
    close($sock);
    return(\@response);
  } else { return(0); }
  
}  #--- End whoisQuery

#--------------------------#
sub networkWhois
#--------------------------#
{
  # Local variables
  my ($item, $i, $ip, $refResponse, $refIPv4, $refIPv6) = @_;
  my %rirName = ( 'whois.arin.net'    => 'ARIN'   ,
                  'whois.ripe.net'    => 'RIPE'   ,
                  'whois.apnic.net'   => 'APNIC'  ,
                  'whois.krnic.net'   => 'KRNIC'  ,
                  'whois.lacnic.net'  => 'LACNIC' ,
                  'whois.afrinic.net' => 'AFRINIC', );
  my $tempResponse;
  my $search_options = ['NetName','OrgName'];
  my $authority;
  my $whoisServer;
  # Find Authority
  if (!$win->cbWSSelect->GetCurSel()) {                     # Auto select registry
    $whoisServer = &registry($ip, $refIPv4, $refIPv6);
    $whoisServer = 'whois.arin.net' if !$whoisServer;
    $authority = $rirName{$whoisServer};
  } else {                                                  # Force registry
    $authority = $win->cbWSSelect->GetString($win->cbWSSelect->GetCurSel());
  }
  # Whois to ARIN
  if ($authority eq 'ARIN') {
    $winPb->lblPbCurr->Text("$item: ARIN Network whois -> $ip");
    my $refTab;
    ($tempResponse, $refTab) = &whoisip_query($ip, $authority, 'true', 'true', $search_options);
    # Find if other authority or if incomplete IPv6 response
    my $ipv6net;
    my $complete = 0;
    foreach (@{$tempResponse}) {
      if ((/NetType:\s+Allocated to (\w+)/i) or (/NetType:\s+Early Registrations\, Transferred to (\w+)/i) or (/NetType:\s+Transferred to (\w+)/i)) {
        $authority = uc($1);
      } elsif (/\((NET6[^\)]+)/                 ) { $ipv6net  = $1; }
      elsif (/(?:CustName|OrgName|org-name):\s*/) { $complete = 1;  } 
    }
    # Response not complete (IPv6)
    if ($authority and $authority eq 'ARIN' and !$complete and $ipv6net) {
      my ($tempResponse2, $refTab2) = &whoisip_query($ipv6net, $authority, 'true', 'true', $search_options);
      push(@{$tempResponse}, @{$tempResponse2});
    }
  }
  # Authority is RIPE
  if ($authority and $authority eq 'RIPE') {
    $winPb->lblPbCurr->Text("$item: RIPE Network whois -> $ip");
    $tempResponse = &whoisip_query($ip, 'RIPE', 'true', 'true', $search_options);
    foreach (@{$tempResponse}) {
      if (/descr:\s+This network has been transferred to (\w+)/i) { $authority = uc($1); last; }
    }
  }
  # Authority is APNIC, AFRINIC, LACNIC or IANA
  if ($authority and $authority ne 'ARIN' and $authority ne 'RIPE') {
    $winPb->lblPbCurr->Text("$item: $authority Network whois -> $ip");
    $tempResponse = &whoisip_query($ip, $authority, 'true', 'true', $search_options);
  }
  # For LACNIC, remove double line break
  if ($authority eq 'LACNIC') {
    my @tempResponse2;
    foreach my $line (@{$tempResponse}) {
      chomp($line) if ($line =~ /(?:\r\r|\n\n|\r\n\r\n)/);
      push(@tempResponse2, $line);
    }
    $tempResponse = \@tempResponse2;
  }
  # Keep responses
  $$refResponse{"networkAuth$i"}  = $authority;
  $$refResponse{"networkInfos$i"} = $tempResponse;

}  #--- End networkWhois

#--------------------------#
sub networkWhoisRDAP
#--------------------------#
{
  # Local variables
  my ($item, $i, $ip, $refResponse, $refIPv4, $refIPv6) = @_;
  my %rirName = ( 'http://rdap.arin.net/registry'  => 'ARIN'   ,
                  'http://rdap.db.ripe.net'        => 'RIPE'   ,
                  'http://rdap.apnic.net'          => 'APNIC'  ,
                  'http://rdap.lacnic.net/rdap'    => 'LACNIC' ,
                  'http://rdap.afrinic.net/rdap'   => 'AFRINIC', );
  my $authority;
  my $whoisServer;
  # Find Authority
  if (!$win->cbWSSelect->GetCurSel()) { # Auto select registry
    $whoisServer = &registry($ip, $refIPv4, $refIPv6);
    while ($whoisServer =~ /\/$/) { chop($whoisServer); }
    $whoisServer = 'http://rdap.arin.net/registry' if !$whoisServer;
    $authority   = $rirName{$whoisServer};
  } else {                              # Force registry
    $authority = $win->cbWSSelect->GetString($win->cbWSSelect->GetCurSel());
  }
  # Whois
  $winPb->lblPbCurr->Text("$item: Network whois -> $ip");
  if (my $return = &whoisRDAP('ip', $ip, $whoisServer)) {
    # Keep responses
    $$refResponse{"networkAuth$i"}  = $authority;
    $$refResponse{"networkInfos$i"} = $return;
  }  
  
}  #--- End networkWhoisRDAP

#--------------------------#
sub domainWhois
#--------------------------#
{
  # Local variables
  my ($item, $i, $domain, $refResponse, $refTLD, $refWSL) = @_;
  my ($whois_server, $whois, $server);
  # Determine the good server
  my $domainExt;
  if ($domainExt = $$refTLD->get_root_domain($domain)) {
    $whois_server = $$refWSL{$domainExt}{host} if exists($$refWSL{$domainExt}{host});
    if (!$whois_server) {
      $domainExt    = $$refTLD->tld();
      $whois_server = $$refWSL{$domainExt}{host} if exists($$refWSL{$domainExt}{host});
    }
  }
  # Do whois
  $winPb->lblPbCurr->Text("$item: Domain whois -> $domain");
  if ($domainExt !~ /\.ar$/ and $domainExt !~ /\.pk$/ and $domainExt !~ /\.es$/) {
    if ($whois_server) { eval { ($whois, $server) = whois($domain, $whois_server); }; }
    # No known whois server, ask Internic
    else {
      eval { ($whois, $server) = whois($domain, 'whois.internic.net'); };
      sleep(1);
      if ($whois and $whois =~ /Registrar WHOIS Server:\s*([^\s]+)/) {
        eval { ($whois, $server) = whois($domain, $1); };
      } elsif ($whois =~ /Invalid query/ and $server) {
        eval { ($whois, $server) = whois($domain, $server); };
      } else { eval { ($whois, $server) = whois($domain); }; }
    }
  }
  if (!$whois and !$server) {
    if ($domainExt =~ /\.ar$/ or $domainExt =~ /\.pk$/ or $domainExt =~ /\.es$/) {
      $$refResponse{"domainRegistrar$i"} = $STR{'WS_Undefined'};
      $$refResponse{"domainInfos$i"}     = $STR{'WS_NoWhoisServer'};
    } else {
      $$refResponse{"domainRegistrar$i"} = $whois_server;
      $$refResponse{"domainInfos$i"}    .= $STR{'errUnknown'};
    }
  } else {
    $$refResponse{"domainRegistrar$i"} = $server;
    $$refResponse{"domainInfos$i"}    .= $whois;
    $$refResponse{"domainInfos$i"}    =~ s/\</\&lt\;/g;
    $$refResponse{"domainInfos$i"}    =~ s/\>/\&gt\;/g;
  }
  
}  #--- End domainWhois

#--------------------------#
sub getGeoIPData
#--------------------------#
{
  # Local variables
  my ($item, $ip, $i, $refResponse, $geoIPDB) = @_;
  my $lang = $winConfig->cbGeoIPLang->GetString($winConfig->cbGeoIPLang->GetCurSel());
  $winPb->lblPbCurr->Text("$item: GeoIP -> $ip");
  if (my $reader = GeoIP2::Database::Reader->new(file => $geoIPDB, locales => [$lang, 'en'])) {
    my $record;
    try   { $record = $reader->city(ip => $ip) }
    catch { $$refResponse{"geoIP$i"} = $_[0]->message if $_[0]->message; };
    if ($record) {
      $$refResponse{"geoIP$i"} .= $STR{'Continent'}."\t".$record->continent()->name()."\n"      if $record->continent()->name();
      $$refResponse{"geoIP$i"} .= $STR{'countryCode'}."\t".$record->country()->iso_code()."\n"  if $record->country()->iso_code();
      $$refResponse{"geoIP$i"} .= $STR{'Country'}."\t".$record->country()->name()."\n"          if $record->country()->name();
      $$refResponse{"geoIP$i"} .= $STR{'regionCode'}."\t".$record->most_specific_subdivision->iso_code()."\n" if $record->most_specific_subdivision->iso_code();
      $$refResponse{"geoIP$i"} .= $STR{'Region'}."\t".$record->most_specific_subdivision->name()."\n"         if $record->most_specific_subdivision->name();
      $$refResponse{"geoIP$i"} .= $STR{'City'}."\t".$record->city()->name()."\n"              if $record->city()->name();
      $$refResponse{"geoIP$i"} .= $STR{'postalCode'}."\t".$record->postal()->code()."\n"      if $record->postal()->code();
      $$refResponse{"geoIP$i"} .= $STR{'gpsLat'}."\t".$record->location()->latitude()."\n"    if $record->location()->latitude();
      $$refResponse{"geoIP$i"} .= $STR{'gpsLong'}."\t".$record->location()->longitude()."\n"  if $record->location()->longitude();
      if ($record->location()->time_zone()) {
        $$refResponse{"geoIP$i"} .= $STR{'tzName'}."\t".$record->location()->time_zone()."\n";
      }
      $$refResponse{"geoIP$i"} = unidecode($$refResponse{"geoIP$i"});
    } elsif (!exists($$refResponse{"geoIP$i"})) { $$refResponse{"geoIP$i"} = $STR{'notFound'}; }
  } else { $$refResponse{"geoIP$i"} = $STR{'errGeoIPResolve'}; }
  
}  #--- End getGeoIPData

#--------------------------#
sub dnsRecords
#--------------------------#
{
  # Local variables
  my ($host, $domain) = @_;
  my @dnsRecords;
  my @IPaddresses;
  my @nservers;
  # NS Records
  my $res = Net::DNS::Resolver->new();
  my @listNSservers = $res->nameservers;
  #$res->defnames(0);
  #$res->retry(2);
  my $ns_req = $res->query($domain, "NS");
  if (defined($ns_req) and ($ns_req->header->ancount > 0)) {
    #$res->recurse(0);
    $| = 1;
    foreach my $nsrr (grep {$_->type eq "NS" } $ns_req->answer) {
      push(@dnsRecords, $nsrr->string);
      my $ns = $nsrr->nsdname;
      push(@nservers, $ns);
      my $local_res = Net::DNS::Resolver->new();
      my $a_req = $local_res->query($ns, 'A');
      if ($a_req) {
        foreach my $ip (map { $_->address } grep { $_->type eq 'A' } $a_req->answer) {
          push(@listNSservers, $ip);
        }
      }
    }
    $res->nameservers(@listNSservers);
    if (@nservers) {
      # Records for host
      if ($host ne $domain) {
        my $host_res     = Net::DNS::Resolver->new();
        my $host_query   = $host_res->search($host);
        if ($host_query) {
          foreach my $rr ($host_query->answer) {
            push(@IPaddresses, $rr->address) if $rr->type eq "A";
            push(@dnsRecords, $rr->string);
          }
        }
      }
      # A Records
      my $packet1   = $res->query($domain, 'A');
      if ($packet1) { foreach my $rr ($packet1->answer) { push(@dnsRecords, $rr->string); push(@IPaddresses, $rr->address); } }
      # AAAA Records
      my $packet8   = $res->query($domain, 'AAAA');
      if ($packet8) { foreach my $rr ($packet8->answer) { push(@dnsRecords, $rr->string); } }
      # MX Records
      my $packet2   = $res->query($domain, 'MX');
      if ($packet2) { foreach my $rr ($packet2->answer) { push(@dnsRecords, $rr->string); } }
      # CNAME Records
      my $packet3   = $res->query($domain, 'CNAME');
      if ($packet3) { foreach my $rr ($packet3->answer) { push(@dnsRecords, $rr->string); } }
      # TXT Records
      my $packet4   = $res->query($domain, 'TXT');
      if ($packet4) { foreach my $rr ($packet4->answer) { push(@dnsRecords, $rr->string); } }
      my $packet5   = $res->query("_domainkey.".$domain, 'TXT');
      if ($packet5) { foreach my $rr ($packet5->answer) { push(@dnsRecords, $rr->string); } }
      # SOA Records
      my $packet6   = $res->query($domain, 'SOA');
      if ($packet6) { foreach my $rr ($packet6->answer) { push(@dnsRecords, $rr->string); } }
      # PTR Records
      foreach my $ip (@IPaddresses) {
        my $res2      = Net::DNS::Resolver->new();
        $res2->tcp_timeout(2);
        my $reverse   = join( '.', reverse( split /\./, $ip )) . '.in-addr.arpa';
        my $packet7   = $res2->query($reverse, 'PTR');
        if ($packet7) { foreach my $rr ($packet7->answer) { push(@dnsRecords, $rr->string); } }
      }
    }
  } else { return(''); }
  # Sort records
  my @sdnsRecords = map  { $_->[0] }
                    sort { $a->[1] cmp $b->[1] }
                    map  { [ $_, (split(/\t/))[3] ] } @dnsRecords;
  @dnsRecords     = ();
  @dnsRecords     = map  { $_->[0] }
                    sort { $b->[1] cmp $a->[1] }
                    map  { [ $_, (split(/\t/))[0] ] } @sdnsRecords;
  return(\@dnsRecords);
  
}  #--- End dnsRecords

#--------------------------#
sub nsLookup
#--------------------------#
{
  # Local variables
  my($req, $type) = @_;
  my $resp;
  # Resolve IP address
  if ($type eq 'IPv4' or $type eq 'IPv6') {
    my $res = Net::DNS::Resolver->new;
    $res->tcp_timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
    $res->udp_timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
    my $packet = $res->query($req, "PTR", "IN");
    if ($packet) {
      my @addrs  = $packet->answer;
      my $hostname = '';
      foreach (@addrs) { $hostname .= $_->ptrdname.", " if $_->type eq 'PTR' and $_->ptrdname; }
      if ($hostname) {
        chop($hostname); chop($hostname);
        $resp = $hostname;
      } else { $resp = $STR{'noMatch'}; }
    } else {
      if ($res->errorstring eq 'no nameservers') { $resp = $STR{'errConnection'}; }
      else                                       { $resp = $STR{'noMatch'};       }
    }
  }
  # Resolve domain
  else {
    my $res = Net::DNS::Resolver->new;
    $res->tcp_timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
    $res->udp_timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
    my $packet = $res->query($req);
    if ($packet) {
      my @addrs  = $packet->answer;
      my $addr = '';
      foreach (@addrs) { $addr .= $_->address.", " if $_->type eq 'A' and $_->address; }
      if ($addr) {
        chop($addr); chop($addr);
        $resp = $addr;
      } else { $resp = $STR{'noMatch'}; }
    } else {
      if ($res->errorstring eq 'no nameservers') { $resp = $STR{'errConnection'}; }
      else                                       { $resp = $STR{'noMatch'};       }
    }
  }
  return($resp);
  
}  #--- End nsLookup

#--------------------------#
sub whoisRDAP
#--------------------------#
{
  # Local variables
  my ($type, $item, $whoisServer) = @_;
  # $type can be: ip, autnum, domain, nameserver, entity
  # Create agent
  my $ua = LWP::UserAgent->new;
  $ua->agent($CONFIG{'USERAGENT'});
  $ua->timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
  $ua->default_header('Accept-Language' => 'en');
  #$ua->default_header('Accept' => 'application/json');
  # Create request
  my $reqURL = "$whoisServer/$type/$item";
  my $res    = $ua->get($reqURL);
  if ($res->is_success) {
    return($res->content);
  } else { return(0); }
  
}  #--- End whoisRDAP

#--------------------------#
sub registry
#--------------------------#
{
  # Local variables
  my ($ip, $refIPv4, $refIPv6) = @_;
  # IPv4
  if ($ip =~ /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/) {
    my @partsIP  = split(/\./, $ip);
    my $prefixIP = shift(@partsIP);
    while (length($prefixIP) < 3) { $prefixIP = '0'.$prefixIP; } # 53 becomes 053
    return($$refIPv4{$prefixIP}) if exists($$refIPv4{$prefixIP});
  # IPv6
  } else {
    foreach my $range (keys %{$refIPv6}) {
      return($$refIPv6{$range}) if ip_in_range($ip, $range);
    }
  }
  return(0); # Not found
  
}  #--- End registry
  
#--------------------------#
sub writeReport
#--------------------------#
{
  # Local variables
  my ($refAnswer, $date, $mode) = @_;
  # $mode = 1=normal, 0=RDAP
  my $html;
  my $comment = $win->tfComment->Text();
  # Server list
  my %authServers = ('ARIN'    => 'whois.arin.net'   ,
                     'RIPE'    => 'whois.ripe.net'   ,
                     'APNIC'   => 'whois.apnic.net'  ,
                     'LACNIC'  => 'whois.lacnic.net' ,
                     'AFRINIC' => 'whois.afrinic.net',
                     'KRNIC'   => 'whois.krnic.net'  , );
  $html  = '<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">' . "\n";
  $html .= '<html>' . "\n";
  $html .= '<head>' . "\n";
  $html .= '<title>';
  $html .= $$refAnswer{'query'};
  $html .= " - XL-Whois $STR{'report'}</title>\n";
  #$html .= "<meta charset=\"utf8\">\n";
  $html .= "<meta name=\"generator\" content=\"XL-Whois $VERSION\">\n";
  $html .= '<style>' . "\n";
  $html .= 'body { font-family: arial; font-size: 14px; }' . "\n";
  $html .= 'h1 { font-size: 24px; text-align: center; color: #0066CC; }' . "\n";
  $html .= 'h2 { font-size: 20px; text-align: center; color: #FFF; background: #91bbed; width: 100%; max-width: 1024px; margin-left: auto; margin-right: auto; padding: 5px; }' . "\n";
  $html .= 'p {	margin-left: auto; margin-right: auto; width: 100%;	max-width: 1024px; font-size: 16px; }' . "\n";
  $html .= 'pre { margin-left: auto; margin-right: auto; width: 100%; max-width: 1024px; text-align: justify; white-space: pre-wrap; }' . "\n";
  $html .= 'table {	margin-left: auto; margin-right: auto; width: 100%;	max-width: 1024px; }' . "\n";
  $html .= '#header { width: 100%; max-width: 1024px; margin-left: auto; margin-right: auto; }' . "\n";
  $html .= '#query { float: left; margin-left: auto; width: 100px; font-size: 16px; }' . "\n";
  $html .= '#queryItems { font-weight: bold; color: #0066CC; margin-left: 100px; width: auto; font-size: 16px; }' . "\n";
  $html .= '#tdHeader {	background: #91bbed; color: #FFF; text-align: center; font-weight: bold; }' . "\n";
  $html .= '</style>' . "\n";
  $html .= '</head>' . "\n";
  $html .= '<body>' . "\n";
  $html .= "<h1>XL-Whois $STR{'report'}</h1>\n";
  $html .= "<h2>$STR{'query'}</h2>\n";
  $html .= '<div id="header">'."\n".'<div id="query">' . "\n";
  $html .= 'Whois:<br/>' . "\n";
  $html .= "$STR{'resolve'}:<br/>\n" if $$refAnswer{'lookup1'};
  $html .= "$STR{'date'}:<br/>\n";
  $html .= "$STR{'comment'}:\n" if $comment;
  $html .= '</div>' . "\n";
  $html .= '<div id="queryItems">' . "\n";
  if ($$refAnswer{'Error'}) { $html .= "$STR{'Error'} = $$refAnswer{'Error'})\n</div>\n"; }
  else {
    # Query
    $html .= "$$refAnswer{'query'}<br/>\n";
    my $i = 1;
    if ($$refAnswer{'lookup1'})  {
      $html .= $$refAnswer{"lookup$i"}; $i++;
      while ($$refAnswer{"lookup$i"}) { $html .= ", ".$$refAnswer{"lookup$i"}; $i++; }
      $html .= "<br/>\n";
    }
    $html .= $date."<br/>\n";
    $html .= $comment . "\n" if $comment;
    $html .= '</div>'."\n".'</div>'."\n";
    # Domain whois
    if ($$refAnswer{'domainInfos1'} and ($win->chDomain->Checked())) {
      $html .= '<h2>Domain whois</h2>' . "\n";
      my $j = 1;
      while ($$refAnswer{"domainInfos$j"}) {
        $html .= '<p>Queried <strong style="color:#0066CC;">';
        $html .= $$refAnswer{"domainRegistrar$j"};
        $html .= '</strong> with "<strong style="color:#0066CC;">';
        $html .= $$refAnswer{"domain$j"};
        $html .= '</strong>"...</p>'."\n";
        $html .= '<pre>' . "\n";
        $html .= $$refAnswer{"domainInfos$j"};
        $html .= '</pre>' . "\n";
        $j++;
      }
    }
    # Network whois
    if ($$refAnswer{'networkInfos1'} and ($win->chNetwork->Checked())) {
      $html .= '<h2>Network whois</h2>' . "\n";
      my $k = 1;
      while ($$refAnswer{"networkInfos$k"}) {
        $html .= '<p>Queried <strong style="color:#0066CC;">';
        if ($authServers{$$refAnswer{"networkAuth$k"}}) { $html .= $authServers{$$refAnswer{"networkAuth$k"}}; }
        else                                            { $html .= $$refAnswer{"networkAuth$k"};               }
        $html .= '</strong> with "<strong style="color:#0066CC;">';
        if    ($$refAnswer{"networkAuth$k"} eq 'ARIN') { $html .= "n "; }
        elsif ($$refAnswer{"networkAuth$k"} eq 'RIPE') { $html .= "-B "; }
        $html .= $$refAnswer{"ip$k"};
        $html .= '</strong>"...</p>' . "\n";
        $html .= '<pre>' . "\n";
        # Mode normal
        if ($mode) { foreach (@{$$refAnswer{"networkInfos$k"}}) { $html .= $_; } }
        # Mode RDAP
        else { &addNWJSON(\$html, $refAnswer, $k); }
        $html .= '</pre>' . "\n";
        $k++;
      }
    }
    # GeoIP data
    if ($$refAnswer{'geoIP1'} and $win->chGeoIP->Checked() and my $geoIPDB = $winConfig->tfGeoIPDB->Text()) {
      $html .= '<h2>GeoIP Data</h2>' . "\n";
      $html .= '<p>This product includes GeoLite2 data created by MaxMind, available from ';
      $html .= '<a href="https://www.maxmind.com">https://www.maxmind.com</a>.';
      $html .= '</p>' . "\n";
      my $k = 1;
      while ($$refAnswer{"geoIP$k"}) {
        my @geoIPlines = split(/\n/, $$refAnswer{"geoIP$k"});
        $html .= '<table cellspacing=0 cellpadding=2 border=1>' . "\n";
        $html .= '<tr><td id="tdHeader" colspan=2>'.$$refAnswer{"ip$k"}.'</td></tr>' . "\n";
        foreach my $line (@geoIPlines) {
          my ($name, $value) = split(/\t/, $line);
          $html .= "<tr><td>$name</td><td>";
          $html .= $value if $value;
          $html .= "</td></tr>\n";
        }
        $k++;
      }
    }
    # DNS Records
    if ($$refAnswer{'dnsRecords1'} and ($win->chDNS->Checked())) {
      $html .= '<h2>DNS Records</h2>' . "\n";
      my $l = 1;
      while ($$refAnswer{"dnsRecords$l"}) {
        $html .= '<p>NS Records for <strong style="color:#0066CC;">"';
        if (exists($$refAnswer{"domain$l"})) { $html .= $$refAnswer{"domain$l"}; }
        else                                 { $html .= $$refAnswer{'query'};    }
        $html .= '</strong>"...</p>';
        $html .= '<table cellspacing=0 cellpadding=2 border=1>' . "\n";
        $html .= '<tr>' . "\n";
        $html .= '<td id="tdHeader">name</td>' . "\n";
        $html .= '<td id="tdHeader">ttl</td>' . "\n";
        $html .= '<td id="tdHeader">class</td>' . "\n";
        $html .= '<td id="tdHeader">type</td>' . "\n";
        $html .= '<td id="tdHeader">data</td>' . "\n";
        $html .= '</tr>' . "\n";
        foreach my $line (@{$$refAnswer{"dnsRecords$l"}}) {
          $html .= '<tr>' . "\n";
          $line =~ s/\t;/;/g;
          my(@fields) = split(/\t/, $line);
          my $name  = shift(@fields);
          my $ttl   = shift(@fields);
          my $class = shift(@fields);
          my $type  = shift(@fields);
          my $data  = join(' ', @fields);
          chop($name) if $name =~ /\.$/;
          chop($data) if $data =~ /\.$/;
          $data =~ s/ \)$//g;
          $data =~ s/^\( //g;
          $html .= '<td>' . $name  . '</td>' . "\n";
          $html .= '<td>' . $ttl   . '</td>' . "\n";
          $html .= '<td>' . $class . '</td>' . "\n";
          $html .= '<td>' . $type  . '</td>' . "\n";
          if ($type =~ /SOA/) {
            $html .= '<td>';
            $data =~ s/\n//g;
            $data =~ s/ ?;[^ ]*//g;
            my @soa = split(/\s+/, $data);
            $html .= "Server: $soa[0]<br>";
            $html .= "Email: $soa[1]<br>";
            $html .= "Serial: $soa[2]<br>";
            $html .= "Refresh: $soa[3]<br>";
            $html .= "Retry: $soa[4]<br>";
            $html .= "Expire: $soa[5]<br>";
            $html .= "Minimum: $soa[6]<br>";
            $html .= '</td>';
          } elsif ($type =~ /MX/) {
            my ($preference, $exchange) = split(/ /, $data);
            $html .= '<td>' . "preference = $preference<BR>exchange = $exchange" . '</td>' . "\n";
          } else {
            $html .= '<td>' . $data . '</td>' . "\n";
          }
          $html .= '</tr>' . "\n";
        }
        $html .= '</table><br>' . "\n";
        $l++;
      }
    }
  }
  $html .= '</body>' . "\n";
  $html .= '</html>' . "\n";
  
  return($html);
  
}  #--- End writeReport

#--------------------------#
sub addNWJSON
#--------------------------#
{
  # Local variables
  my ($refHtml, $refAnswer, $id) = @_;
  my $json = parse_json($$refAnswer{"networkInfos$id"});
  # Network details
  if ($$json{startAddress} and $$json{endAddress}) {
    my $startIP = (split(/\//, $$json{startAddress}))[0];
    my $endIP   = (split(/\//, $$json{endAddress}))[0];
    $$refHtml .= "$STR{'NetRange'}: $startIP - $endIP\n";
  }
  $$refHtml .= "$STR{'Handle'}: $$json{handle}\n"             if exists($$json{handle})       and $$json{handle};
  $$refHtml .= "$STR{'ParentHandle'}: $$json{parentHandle}\n" if exists($$json{parentHandle}) and $$json{parentHandle};
  $$refHtml .= "$STR{'Name'}: $$json{name}\n"                 if exists($$json{name})         and $$json{name};
  $$refHtml .= "$STR{'Country'}: $$json{country}\n"           if exists($$json{country})      and $$json{country};
  $$refHtml .= "$STR{'NicbAutnum'}: $$json{nicbr_autnum}\n"   if exists($$json{nicbr_autnum}) and $$json{nicbr_autnum};
  # Remarks (RIPE, APNIC, LACNIC)
  if (exists($$json{remarks})) {
    foreach my $remark (@{$$json{remarks}}) {
      if ($$remark{description}) {
        foreach my $remarkText (@{$$remark{description}}) {
          $$refHtml .= "$STR{'Remark'}: $remarkText\n" if $remarkText;
        }
      }
    }
  }
  # Events
  if (exists($$json{events})) {
    foreach my $event (@{$$json{events}}) {
      $$refHtml .= ucfirst($$event{eventAction}) . ': '. $$event{eventDate} . "\n";
    }
    $$refHtml .= "\n";
  }
  # Notices
  if (exists($$json{notices})) {
    foreach my $notice (@{$$json{notices}}) {
      foreach my $noticeName (keys %{$notice}) {
        if    ($noticeName eq 'title') { $$refHtml .= "$STR{'Notice'}: $$notice{$noticeName}\n"; }
        elsif ($noticeName eq 'description') {
          foreach my $text (@{$$notice{$noticeName}}) { $$refHtml .= "$STR{'Notice'}: $text\n"; }
        } elsif ($noticeName eq 'links') {
          foreach my $link (@{$$notice{$noticeName}}) {
            $$refHtml .= "$STR{'Notice'}: $$link{href}\n";
          }
        }
      }
      $$refHtml .= "\n";
    }
  }
  # Entities
  $$refHtml .= "$STR{'Entities'}:\n\n";
  if (exists($$json{entities})) {
    foreach my $entity (@{$$json{entities}}) {
      $$refHtml .= "$STR{'Handle'}: $$entity{handle}\n" if exists($$entity{handle}) and $$entity{handle};
      # Roles
      if (exists($$entity{roles})) {
        foreach my $roles (@{$$entity{roles}}) { $$refHtml .= "$STR{'Role'}: $roles\n"; }
      }
      # Status
      if (exists($$entity{status})) {
        foreach my $status (@{$$entity{status}}) { $$refHtml .= "$STR{'Status'}: $status\n"; }
      }
      # Vcard
      if (exists($$entity{vcardArray})) {
        foreach my $vcard (@{$$entity{vcardArray}[1]}) {
          if      ($$vcard[0] eq 'adr') {
            if ($$vcard[1]{label}) {
              my $addr = $$vcard[1]{label} =~ s/\n/, /gr;
              $$refHtml .= "$STR{'Address'}: $addr\n";
            } elsif ($$vcard[3]) {
              my $addr;
              foreach (@{$$vcard[3]}) { $addr .= $_ .', ' if $_; }
              chop($addr); chop($addr);
              $$refHtml .= "$STR{'Address'}: $addr\n";
            }
          } elsif ($$vcard[0] ne 'n' and $$vcard[0] ne 'version' and $$vcard[0] ne 'kind') {
            my $field = ucfirst($$vcard[0]);
            $field    = 'Name' if $field eq 'Fn';
            if ($field eq 'Tel') {
              $field = $STR{'Phone'};
              my $type;
              if ($$vcard[1] and exists($$vcard[1]{type}) and $$vcard[1]{type}) {
                if (ref($$vcard[1]{type}) eq 'ARRAY') {
                  foreach (@{$$vcard[1]{type}}) { $type .= $_ . ', '; }
                  chop($type); chop($type);
                } else { $type = $$vcard[1]{type}; }
                $field .= " ($type)";
              }
              $$vcard[3] =~ s/tel://;
            }
            $$refHtml .= "$field: " . $$vcard[3] . "\n";
          }
        }
      }
      # Events
      if (exists($$entity{events})) {
        foreach my $event (@{$$entity{events}}) {
          $$refHtml .= ucfirst($$event{eventAction}) . ': '. $$event{eventDate} . "\n";
        }
      }
      # Links
      if (exists($$entity{links})) {
        foreach my $link (@{$$entity{links}}) {
          $$refHtml .= "$STR{'Link'}: $$link{href}\n";
        }
      }
      # Remarks (RIPE, APNIC, LACNIC)
      if (exists($$entity{remarks})) {
        foreach my $remark (@{$$entity{remarks}}) {
          if ($$remark{description}) {
            foreach my $remarkText (@{$$remark{description}}) {
              $$refHtml .= "$STR{'Remark'}: $remarkText\n" if $remarkText;
            }
          }
        }
      }
      $$refHtml .= "\n";
    }
  }

}  #--- End addNWJSON

#--------------------------#
sub storeNWData
#--------------------------#
{
  # Local variables
  my ($range_s, $range_e, $refNWData, $lineInGrid) = @_;  
  # Replace not allowed characters for windows filename (IPv6)
  if ($range_s =~ /\:/) {
    my ($ipStart, $ipEnd) = split(/\-/, (Net::CIDR::cidr2range($range_s))[0]);
    $ipStart =~ s/\:/_/g;
    $ipEnd   =~ s/\:/_/g;
    $range_s = $ipStart;
    $range_e = $ipEnd;
  }
  my $networkWhoisDataFile = "$CONFIG{'WHOIS_DATA_CACHE'}\\$range_s\-$range_e\.txt";
  # Write Network whois data to file
  my @lines = split(/[\r\n]/, $$refNWData);
  if (open(HTML, ">$networkWhoisDataFile")) {
    flock(HTML, 2);
    foreach (@lines) {
      if ($_) {
        s/[\r\n]//g; # Remove any line break
        if ($_) {
          s/<\/?pre>//g; # Remove <pre> and </pre> tag
          print HTML $_ . "\n";
        }
      }
    }
    close(HTML);
    # Set background color to green in Grid
    if ($lineInGrid) {
      $winDB->DBGrid->SetCellBkColor($lineInGrid, 0, 0x33FF66);
      $winDB->DBGrid->SetCellBkColor($lineInGrid, 1, 0x33FF66);
      $winDB->DBGrid->SetCellBkColor($lineInGrid, 2, 0x33FF66);
      $winDB->DBGrid->SetCellBkColor($lineInGrid, 3, 0x33FF66);
      $winDB->DBGrid->SetCellBkColor($lineInGrid, 4, 0x33FF66);
      $winDB->DBGrid->Refresh();
    }
  } else { Win32::GUI::MessageBox($win, $STR{'errWriting'}.' '.$STR{'winNWP'}.' '.$STR{'toCache'}.': '.$!, $STR{'Error'}, 0x40010); }
  return($networkWhoisDataFile);
  
}  #--- End storeNWData
  
#--------------------------#
sub logRequest
#--------------------------#
{
  # Local variables
  my ($item, $refDbhLog, $details, $date, $comment) = @_;
  # Add entry in database
  # Database: table = LOGGING_DB, Fields = date, request, details, comment
  my $sth = $$refDbhLog->prepare("INSERT OR REPLACE INTO LOGGING_DB (date, request, details, comment) VALUES(?,?,?,?)");
  my $rv  = $sth->execute($date, $item, $details, $comment);
  if ($rv < 0) {
    Win32::GUI::MessageBox($win, $STR{'errWriting'}.' '.$STR{'winLogDB'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010);
    return(0);
  } else { return(1); }

}  #--- End logRequest

#--------------------------#
sub check_LoggingDB
#--------------------------#
{
  # Local variables
  my ($item, $refDbhLog) = @_;
  my $nbrResults = 0;
  my @results;
  # Check if item is present in database
  # Database: table = LOGGING_DB, Fields = date, request, details, comment
  my $sth = $$refDbhLog->prepare("SELECT date, request, details, comment FROM LOGGING_DB ORDER BY date DESC");
  my $rv  = $sth->execute();
  if ($rv < 0) { Win32::GUI::MessageBox($win, $STR{'Error'}.' '.STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010); }
  else {
    my $refAllRows = $sth->fetchall_arrayref();
    foreach my $refRow (@{$refAllRows}) {
      if ($$refRow[1] =~ /$item/ or $$refRow[2] =~ /$item/ or $$refRow[3] =~ /$item/) {
        $nbrResults++;
        last if $nbrResults > 3; # Max 3 results
        push(@results, "$$refRow[0]\t$$refRow[1]\t$$refRow[2]\t$$refRow[3]");
      }
    }
  }
  if ($nbrResults) { return($nbrResults, @results); }
  else             { return($nbrResults, undef);    }

}  #--- End check_LoggingDB

#--------------------------#
sub btnCancel_Click
#--------------------------#
{
  # Stop requests
  if ($THR) {
    $winPb->lblPbCurr->Text($STR{'Cancelling'});
    $winPb->lblCount->Text('');
    &winPb_Terminate;
    $THR->kill('KILL')->detach();
    $winPb->ChangeCursor($ARROW);
  } elsif ($THR_UPDATE and $THR_UPDATE->is_running()) { $THR_UPDATE->kill('KILL')->detach(); }
  return(1);

}  #--- End btnCancel_Click

#--------------------------#
sub winPb_Terminate
#--------------------------#
{
  $win->Enable();
  $winPb->Hide();
  if    ($winDB->IsVisible()) {
    $winDB->Enable();
    $winDB->SetForegroundWindow();
  }
  elsif ($winLogDB->IsVisible()) {
    $winLogDB->Enable();
    $winLogDB->SetForegroundWindow();
  }
  return(1);

}  #--- End winPb_Terminate

#--------------------------#
sub selectAll_Click
#--------------------------#
{
  if    ($LISTNO == 1) { &gridSelectAll_Click;          } # Select All Whois DB Grid
  elsif ($LISTNO == 2) { &logDBGridSelectAll_Click;     } # Select All Logging DB Grid
  elsif ($LISTNO == 3) { $winClip->tfClip->SelectAll(); } # Select All Clipboard Textfield
  
}  #--- End selectAll_Click

#--------------------------#
sub btnHelp_Click
#--------------------------#
{
  # Open XL-Whois documentation page with default browser
  $win->ShellExecute('open', $URL_DOC,'','',1) or Win32::GUI::MessageBox($win, Win32::FormatMessage(Win32::GetLastError()), "$STR{'Update'} XL-Whois",0x40010);

}  #--- End btnHelp_Click

#--------------------------#
sub btnAbout_Click
#--------------------------#
{
  # Create the window
  my $winAbout  = Win32::GUI::DialogBox->new( -name        => 'winAbout'                ,
                                              -parent      => $win                      ,
                                              -text        => $STR{'About'}.' XL-Whois' ,
                                              -pos         => [$winPosX, $winPosY]      ,
                                              -size        => [520, 170]                ,
                                              -background  => [255, 255, 255]           ,
                                              -hasmaximize => 0                         ,
                                              -hasminimize => 1                         ,
                                              -helpbutton  => 0                         ,
                                              -resizable   => 0                         ,
                                              -dialogui    => 1                         , );
  $winAbout->SetIcon($winICO);
  # About tab
  $winAbout->AddLabel(  -name        => 'lblLogo128'            ,
                        -size        => [128,128]               ,
                        -pos         => [  0,  5]               ,
                        -background  => [255, 255, 255]         ,
                        -bitmap      => $logo128Bmp             , );
  $winAbout->AddLabel(  -name        => 'lblAbout1'             ,
                        -size        => [ 90, 75]               ,
                        -pos         => [140, 10]               ,
                        -font        => $font10                 ,
                        -background  => [255, 255, 255]         ,
                        -text        => "$STR{'Version'}:\n$STR{'Website'}:\n$STR{'Author'}:\n$STR{'TranslatedBy'}:", );
  $winAbout->AddLabel(  -name        => 'lblAbout2'             ,
                        -size        => [230, 75]               ,
                        -pos         => [235, 10]               ,
                        -font        => $font10b                ,
                        -foreground  => [  90, 150, 255]        ,
                        -background  => [255, 255, 255]         ,
                        -text        => "$VERSION\nhttp://www.le-tools.com\nAlain Rioux (admin\@le-tools.com)\n$STR{'translatorName'}", );
  $winAbout->AddLabel(  -name        => 'lblAbout3'             ,
                        -size        => [300, 20]               ,
                        -pos         => [140, 80]               ,
                        -font        => $font10                 ,
                        -background  => [255, 255, 255]         ,
                        -text        => ' Copyright 2015-2019 Alain Rioux', );
  $winAbout->Center($win);
  $winAbout->DoModal();
  return(1);

}  #--- End btnAbout_Click

#--------------------------#
sub time2Date
#--------------------------#
{
  # Local variables
  my $unixtime = shift;
  # Convert to string, local timezone
  my ($d,$m,$y) = (localtime($unixtime))[3,4,5];
  return(sprintf("%04d\-%02d\-%02d", $y+1900, $m+1, $d));

}  #--- End time2Date

#--------------------------#
sub time2DateLong
#--------------------------#
{
  # Local variables
  my $unixtime = shift;
  # Convert to string, local timezone
  my ($s,$min,$h,$d,$m,$y) = (localtime($unixtime))[0,1,2,3,4,5];
  return(sprintf("%04d\-%02d\-%02d %02d:%02d:%02d", $y+1900, $m+1, $d, $h, $min, $s));

}  #--- End time2DateLong

#--------------------------#
sub updateAll
#--------------------------#
{
  # Thread 'cancellation' signal handler
  $SIG{'KILL'} = sub {
    $win->ChangeCursor($ARROW);
    # Turn off progress bar
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    $winPb->Hide();
    threads->exit();
  };
  # Thread 'die' signal handler
  $SIG{__DIE__} = sub {
    my $errMsg = (split(/ at /,$_[0]))[0];
    chomp($errMsg);
    $errMsg =~ s/[\t\r\n]/ /g;
    $win->ChangeCursor($ARROW);
    # Turn off progress bar
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    $winPb->Hide();
    Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'Error'}, 0x40010);
  };
  sleep(1);
  &updateTool(0)  if $CONFIG{'TOOL_AUTO_UPDATE'};     # Update Tool?
  &updateDB(0, 'TLD', $STR{'lblTLDDB'}, $winConfig->tfTLDDB->Text(), $TLDDB_URL, 'publicsuffix.org',
            'effective_tld_names.dat')              if $CONFIG{'TLD_DB_AUTO_UPDATE'};   # Update TLDDB?
  &updateDB(0, 'WS', $STR{'lblWSDB'}, $winConfig->tfWSDB->Text(), $WSLOG_URL, 'github.com (weppos)',
            'tld.json')                             if $CONFIG{'WS_DB_AUTO_UPDATE'};    # Update Whois Server DB?
  &updateDB(0, 'IPv4', $STR{'lblIPv4DB'}, $winConfig->tfIPv4DB->Text(), $IPv4DB_URL, 'iana.org',
            'ipv4-address-space.csv')               if $CONFIG{'IPv4_DB_AUTO_UPDATE'};  # Update IPv4 DB?
  &updateDB(0, 'IPv6', $STR{'lblIPv6DB'}, $winConfig->tfIPv6DB->Text(), $IPv6DB_URL, 'iana.org',
            'ipv6-unicast-address-assignments.csv') if $CONFIG{'IPv6_DB_AUTO_UPDATE'};  # Update IPv6 DB?
  &updateDB(0, 'GeoIP', $STR{'GeoIPDB'}, $winConfig->tfGeoIPDB->Text(), $GEOIPDB_URL, 'Maxmind',
            'GeoLite2-City.mmdb')                   if $CONFIG{'GEOIP_DB_AUTO_UPDATE'}; # Update GeoIP DB?
  
}  #--- End updateAll

#--------------------------#
sub createCW
#--------------------------#
{
  # Create Config Wizard Window
  my $winCW  = Win32::GUI::DialogBox->new(-name        => 'winCW'             ,
                                          -parent      => $win                , # May be open from many Window
                                          -text        => $STR{'winCW'}       ,
                                          -pos         => [$winPosX, $winPosY],
                                          -size        => [400, 230]          ,
                                          -background  => [255, 255, 255]     ,
                                          -hasmaximize => 0                   ,
                                          -hasminimize => 1                   ,
                                          -helpbutton  => 0                   ,
                                          -resizable   => 0                   ,
                                          -dialogui    => 1                   , );
  $winCW->SetIcon($winICO);
  $winCW->AddLabel(     -name        => 'lblConfigLogo'       ,
                        -size        => [128,128]             ,
                        -pos         => [  0,  5]             ,
                        -bitmap      => $config128Bmp         , );
  $winCW->AddLabel(     -name        => 'lblSetGenOpt'        ,
                        -size        => [220, 22]             ,
                        -pos         => [140, 10]             ,
                        -font        => $font10               ,
                        -text        => $STR{'SetGenOpt'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblSetGenOptDone'    ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 10]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblReportFolder'     ,
                        -size        => [220, 22]             ,
                        -pos         => [140, 30]             ,
                        -font        => $font10               ,
                        -text        => $STR{'createReportFolder'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblReportFolderDone' ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 30]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLoggingDB'        ,
                        -size        => [220, 22]             ,
                        -pos         => [140, 50]             ,
                        -font        => $font10               ,
                        -text        => $STR{'btnLogDbFileNewTip'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLoggingDBDone'    ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 50]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLoggingDBError'   ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 50]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblWhoisDB'          ,
                        -size        => [220, 22]             ,
                        -pos         => [140, 70]             ,
                        -font        => $font10               ,
                        -text        => $STR{'btnDbFileNewTip'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblWhoisDBDone'      ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 70]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblWhoisDBError'     ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 70]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLTLDDB'          ,
                        -size        => [220, 22]             ,
                        -pos         => [140, 90]             ,
                        -font        => $font10               ,
                        -text        => "$STR{'Download'} $STR{'lblTLDDB'}...",
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLTLDDBDone'      ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 90]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLTLDDBError'     ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 90]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLWSDB'           ,
                        -size        => [220, 22]             ,
                        -pos         => [140,110]             ,
                        -font        => $font10               ,
                        -text        => "$STR{'Download'} $STR{'lblWSDB'}...",
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLWSDBDone'       ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365,110]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLWSDBError'      ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365,110]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLIPv4DB'         ,
                        -size        => [220, 22]             ,
                        -pos         => [140,130]             ,
                        -font        => $font10               ,
                        -text        => "$STR{'Download'} $STR{'lblIPv4DB'}...",
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLIPv4DBDone'     ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365,130]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLIPv4DBError'    ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365,130]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLIPv6DB'         ,
                        -size        => [220, 22]             ,
                        -pos         => [140,150]             ,
                        -font        => $font10               ,
                        -text        => "$STR{'Download'} $STR{'lblIPv6DB'}...",
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLIPv6DBDone'     ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365,150]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLIPv6DBError'    ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365,150]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLGeoIPDB'        ,
                        -size        => [220, 22]             ,
                        -pos         => [140,170]             ,
                        -font        => $font10               ,
                        -text        => "$STR{'Download'} $STR{'GeoIPDB'}...",
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLGeoIPDBDone'    ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365,170]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLGeoIPDBError'   ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365,170]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  return(\$winCW);

}  #--- End createCW

#--------------------------#
sub firstStart
#--------------------------#
{
  # Local variables
  my $refWinCW = shift;
  # Thread 'cancellation' signal handler
  $SIG{'KILL'} = sub {
    $win->ChangeCursor($ARROW);
    # Turn off progress bar
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    $winPb->Hide();
    $$refWinCW->Hide();
    Win32::GUI::MessageBox($win, $STR{'configSetPart'}, "XL-Whois $VERSION", 0x40040);
    threads->exit();
  };
  # Thread 'die' signal handler
  $SIG{__DIE__} = sub {
    my $errMsg = (split(/ at /,$_[0]))[0];
    chomp($errMsg);
    $errMsg =~ s/[\t\r\n]/ /g;
    $win->ChangeCursor($ARROW);
    # Turn off progress bar
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    $winPb->Hide();
    $$refWinCW->Hide();
    Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'Error'}, 0x40010);
  };
  my $answer = Win32::GUI::MessageBox($win, $STR{'firstUse'}, $STR{'config'}, 0x1024);
  # Yes (6), No (7)
  if ($answer == 6) {
    my $dir;
    # Use default directory? (program directory)
    $answer = Win32::GUI::MessageBox($win, $STR{'defaultDir'}.'('.$USERDIR.')?', $STR{'config'}, 0x1024);
    # Answer is no, open popup to let user choose a different location
    if ($answer == 7) {
      # Select a folder
      $dir = Win32::GUI::BrowseForFolder( -owner      => $$refWinCW               ,
                                          -title      => $STR{'selectFolder'}.':' ,
                                          -folderonly => 1                        ,
                                          -newui      => 1                        ,
                                          -directory  => $USERDIR                 , );
    # Answer is yes, use default dir
    } else { $dir = $USERDIR; }
    # Selected folder
    if ($dir and -d $dir) {
      $$refWinCW->Top($win->Top()+5);
      $$refWinCW->Left($win->Left()+310);
      $$refWinCW->Show();
      # Configuring General Options
      $$refWinCW->lblSetGenOpt->Show();
      # Tool
      $winConfig->chAutoUpdate->Checked(1);      
      $CONFIG{'TOOL_AUTO_UPDATE'} = 1;
      # General
      $winConfig->tfLookupTO->Text(10); # Set Nslookup timeout to 10 seconds
      $CONFIG{'NSLOOKUP_TIMEOUT'} = 10;
      $winConfig->tfUserAgent->Text('XL-Whois (http://www.le-tools.com)'); # Default User-Agent
      $CONFIG{'USERAGENT'} = 'XL-Whois (http://www.le-tools.com)'; 
      # Parser
      $winConfig->chIPv4->Checked(1);
      $winConfig->chIPv6->Checked(1);
      $winConfig->chHostname->Checked(1);
      $winConfig->chDomainName->Checked(1);
      $CONFIG{'OPT_IPv4'}        = 1;
      $CONFIG{'OPT_IPv6'}        = 1;
      $CONFIG{'OPT_HOSTNAME'}    = 1;
      $CONFIG{'OPT_DOMAIN_NAME'} = 1;
      $$refWinCW->lblSetGenOptDone->Show();
      &saveConfig(\%CONFIG);
      # Configuring Storage
      # Folder for Report
      $$refWinCW->lblReportFolder->Show();
      my $reportDir = "$dir\\whois";
      mkdir($reportDir) if !-d $reportDir;
      $winConfig->tfReportDir->Text($reportDir);
      $winConfig->chAutoViewing->Checked(1); # Set auto viewing
      $CONFIG{'AUTO_VIEWING'} = 1;
      $winConfig->tfMaxView->Text(25); # Set auto viewing max to 25
      $CONFIG{'MAX_VIEW'}   = 25;
      $CONFIG{'DIR_REPORT'} = $reportDir;
      $winConfig->chReplace->Checked(0); # "If report exist, replace" not checked
      $CONFIG{'REPORT_REPLACE'} = 0;
      $winConfig->chAutoViewDir->Checked(0); # Auto view dir not checked
      $CONFIG{'AUTO_VIEW_DIR'}  = 0;
      &saveConfig(\%CONFIG);
      $$refWinCW->lblReportFolderDone->Show();
      # Create Logging Database
      $$refWinCW->lblLoggingDB->Show();
      my $logDbFile = "$dir\\Logging.db";
      my $return = &createLoggingDB($logDbFile);
      # Success
      if ($return) {
        $winConfig->tfLogDbFile->Text($logDbFile);
        $CONFIG{'LOGGING_DB_FILE'} = $logDbFile;
        $winConfig->chLogActivate->Enable();    # Enable Activate Logging option
        $winConfig->chLogActivate->Checked(1);  # Activate Logging
        $CONFIG{'LOGGING'} = 1;
        $win->tfComment->Enable();        # Enable Add Comment
        $win->chCheckLogging->Checked(1); # Set Check Logging Database
        $CONFIG{'CHECK_LOGGING_DB'} = 1;
        $$refWinCW->lblLoggingDBDone->Show();
      # Error
      } else {
        $$refWinCW->lblLoggingDBError->Show();
        Win32::GUI::MessageBox($$refWinCW, $STR{'errCreating'}.' '.$STR{'winLogDB'}.$DBI::errstr, $STR{'Error'}, 0x40010);
      }
      &saveConfig(\%CONFIG);
      # Create Whois Database
      $$refWinCW->lblWhoisDB->Show();
      $return    = 0;
      my $dbFile = "$dir\\Whois.db";
      $return    = &createWhoisDB($dbFile);
      # Success
      if ($return) {
        $winConfig->tfDbFile->Text($dbFile);
        $CONFIG{'WHOIS_DB_FILE'} = $dbFile;
        $winConfig->chDBCache->Checked(1);  # Set Store Network whois data
        $CONFIG{'WHOIS_CACHE'} = 1;
        $winConfig->chRelRangeSearches->Checked(1);  # Set Store Get Related Ranges searches
        $CONFIG{'REL_RANGES_CACHE'} = 1;
        $win->cbCheckWhoisDB->SetCurSel(1); # Default is "If present, ask"
        $CONFIG{'CHECK_WHOIS_DB'} = 1;
        $$refWinCW->lblWhoisDBDone->Show();
      # Error
      } else {
        $$refWinCW->lblWhoisDBDone->Show();
        Win32::GUI::MessageBox($$refWinCW, $STR{'errCreating'}.' '.$STR{'winDB'}.$DBI::errstr, $STR{'Error'}, 0x40010);
      }
      &saveConfig(\%CONFIG);
      # Configuring Databases
      # Download TLD Database
      $$refWinCW->lblDLTLDDB->Show();
      my $status;
      my $defaultPath = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Parser\\effective_tld_names.dat";
      if (-f $defaultPath and &validTLDDB($defaultPath)) { # Database exists in XL-Whois user dir, check if update available
        $winConfig->tfTLDDB->Text($defaultPath);
        $$refWinCW->lblDLTLDDB->Text("$STR{'Update'} $STR{'lblTLDDB'}");
        &updateDB(0, 'TLD', $STR{'lblTLDDB'}, $winConfig->tfTLDDB->Text(), 'publicsuffix.org', 'effective_tld_names.dat');
        $$refWinCW->lblDLTLDDBDone->Show();
      } else {
        $$refWinCW->lblDLTLDDB->Text("$STR{'Download'} $STR{'lblTLDDB'}");
        ($status, $return) = &downloadDB($refWinCW, 'TLD', $STR{'lblTLDDB'}, "$dir\\effective_tld_names.dat", $TLDDB_URL, 'publicsuffix.org');
        if ($status) { $$refWinCW->lblDLTLDDBDone->Show(); } # Success
        else { # Error
          $$refWinCW->lblDLTLDDBError->Show();
          Win32::GUI::MessageBox($$refWinCW, $return, $STR{'Error'}, 0x40010);
        }
      }
      $winConfig->chTLDDBAutoUpt->Checked(1); # Set auto update for TLD Database
      $CONFIG{'TLD_DB_AUTO_UPDATE'} = 1;
      &saveConfig(\%CONFIG);
      # Download Whois Server Database
      $$refWinCW->lblDLWSDB->Show();
      ($status, $return) = &downloadDB($refWinCW, 'WS', $STR{'lblWSDB'}, "$dir\\tld.json", $WSDB_URL, 'github.com (weppos)');
      if ($status) { $$refWinCW->lblDLWSDBDone->Show(); } # Success
      else { # Error
        $$refWinCW->lblDLWSDBError->Show();
        Win32::GUI::MessageBox($$refWinCW, $return, $STR{'Error'}, 0x40010);
      }
      $winConfig->chWSDBAutoUpt->Checked(1); # Set auto update for Whois Server Database
      $CONFIG{'WS_DB_AUTO_UPDATE'} = 1;
      &saveConfig(\%CONFIG);
      # Download IPv4 Database
      $$refWinCW->lblDLIPv4DB->Show();
      $return = &downloadDBLite("$dir\\ipv4-address-space.csv", $IPv4DB_CSV);
      if ($return) { # Success
        $winConfig->tfIPv4DB->Text("$dir\\ipv4-address-space.csv");
        $CONFIG{'IPv4_DB_FILE'} = "$dir\\ipv4-address-space.csv";
        &saveConfig(\%CONFIG);
        $$refWinCW->lblDLIPv4DBDone->Show();
      } else { # Error
        $$refWinCW->lblDLIPv4DBError->Show();
        Win32::GUI::MessageBox($$refWinCW, "$STR{'errDownloading'} $STR{'lblIPv4DB'}: $return", $STR{'Error'}, 0x40010);
      }
      $winConfig->chIPv4DBAutoUpt->Checked(1); # Set auto update for IPv4 Database
      $CONFIG{'IPv4_DB_AUTO_UPDATE'} = 1;
      &saveConfig(\%CONFIG);
      # Download IPv6 Database
      $$refWinCW->lblDLIPv6DB->Show();
      $return = &downloadDBLite("$dir\\ipv6-unicast-address-assignments.csv", $IPv6DB_CSV);
      if ($return) { # Success
        $winConfig->tfIPv6DB->Text("$dir\\ipv6-unicast-address-assignments.csv");
        $CONFIG{'IPv6_DB_FILE'} = "$dir\\ipv6-unicast-address-assignments.csv";
        &saveConfig(\%CONFIG);
        $$refWinCW->lblDLIPv6DBDone->Show();
      } else { # Error
        $$refWinCW->lblDLIPv6DBError->Show();
        Win32::GUI::MessageBox($$refWinCW, "$STR{'errDownloading'} $STR{'lblIPv6DB'}: $return", $STR{'Error'}, 0x40010);
      }
      $winConfig->chIPv6DBAutoUpt->Checked(1); # Set auto update for IPv6 Database
      $CONFIG{'IPv6_DB_AUTO_UPDATE'} = 1;
      &saveConfig(\%CONFIG);
      # Download GeoIP Database
      $$refWinCW->lblDLGeoIPDB->Show();
      $defaultPath = &findXLTKfile('GeoIPDB');
      if ($defaultPath and -e $defaultPath and &validGeoIPDB($defaultPath)) { # GeoIP database exists, check if update available
        $winConfig->tfGeoIPDB->Text($defaultPath);
        $$refWinCW->lblDLGeoIPDB->Text("$STR{'Update'} $STR{'GeoIPDB'}");
        &updateDB(0, 'GeoIP', $STR{'GeoIPDB'}, $winConfig->tfGeoIPDB->Text(), $GEOIPDB_URL, 'Maxmind', 'GeoLite2-City.mmdb');
        $$refWinCW->lblDLGeoIPDBDone->Show();
      } else {
        $$refWinCW->lblDLGeoIPDB->Text("$STR{'Download'} $STR{'GeoIPDB'}");
        ($status, $return) = &downloadDB($refWinCW, 'GeoIP', $STR{'GeoIPDB'}, $dir, $GEOIPDB_URL, 'Maxmind'); # Fix input and output for this function
        if ($status) { $$refWinCW->lblDLGeoIPDBDone->Show(); } # Success
        else { # Error
          $$refWinCW->lblDLGeoIPDBError->Show();
          Win32::GUI::MessageBox($$refWinCW, $return, $STR{'Error'}, 0x40010);
        }
      }
      $winConfig->chGeoIPDBAutoUpt->Checked(1); # Set auto update for GeoIP Database
      $CONFIG{'GEOIP_DB_AUTO_UPDATE'} = 1;
      &saveConfig(\%CONFIG);
      &isWhoisReady(0);
      sleep(1);
      $$refWinCW->Hide(); # Close Configuration Wizard
      $win->ChangeCursor($ARROW);
      # Send a test? (program directory)
      $answer = Win32::GUI::MessageBox($win, $STR{'defaultConfigSet'}, $STR{'config'}, 0x41024);
      if ($answer == 6) {
        $win->chDomain->Checked(1);
        $win->chNetwork->Checked(1);
        Win32::Clipboard::Set('test.com');
        &btnWhois_Click;
      }
    }
  }

}  #--- End firstStart

#--------------------------#
sub findXLTKfile
#--------------------------#
{
  my $file = shift;
  my $defPath;
  if ($file eq 'GeoIPDB') {
    if      (-e "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Parser\\GeoLite2-City.mmdb") { # In XL-Parser dir
      $defPath = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Parser\\GeoLite2-City.mmdb";
    } elsif (-e "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Tools\\GeoLite2-City.mmdb" ) { # In XL-Tools dir
      $defPath = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Tools\\GeoLite2-City.mmdb";
    }
    return($defPath) if $defPath;
  }
  return('');

}  #--- End findXLTKfile

#--------------------------#
sub btnWinConfig_Click
#--------------------------#
{
  # Show Config window with General Tab
  $winConfig->configTab->SetCurSel(0);
  &configTab_Click;
  $winConfig->Center();
  $winConfig->DoModal();

}  #--- End btnWinConfig_Click

#--------------------------#
sub configTab_Click
#--------------------------#
{
  # Show General tab
  if (!$winConfig->configTab->SelectedItem()) {
    # General tab
    $winConfig->lblToolShadowT->Show();
    $winConfig->lblToolT->Show();
    $winConfig->btnCheckUpdate->Show();
    $winConfig->chAutoUpdate->Show();
    $winConfig->btnExportLang->Show();
    $winConfig->btnOpenUserDir->Show();
    $winConfig->lblGeneralShadowT->Show();
    $winConfig->lblGeneralT->Show();
    $winConfig->chStartMinimized->Show();
    $winConfig->lblNWMode->Show();
    $winConfig->rbNWModeNormal->Show();
    $winConfig->rbNWModeRDAP->Show();
    $winConfig->lblGeoIPLang->Show();
    $winConfig->cbGeoIPLang->Show();
    $winConfig->lblNsLookupTO1->Show();
    $winConfig->tfLookupTO->Show();
    $winConfig->lblNsLookupTO2->Show();
    $winConfig->lblUserAgent->Show();
    $winConfig->tfUserAgent->Show();
    $winConfig->lblParserShadowT->Show();
    $winConfig->lblParserT->Show();
    $winConfig->chIPv4->Show();
    $winConfig->chIPv6->Show();
    $winConfig->chHostname->Show();
    $winConfig->chDomainName->Show();
    # Storage tab
    $winConfig->lblReportShadowT->Hide();
    $winConfig->lblReportT->Hide();
    $winConfig->tfReportDir->Hide();
    $winConfig->btnReportDir->Hide();
    $winConfig->btnOpenDir->Hide();
    $winConfig->chReplace->Hide();
    $winConfig->chAutoViewDir->Hide();
    $winConfig->chAutoViewing->Hide();
    $winConfig->tfMaxView->Hide();
    $winConfig->lblLogDbFileShadowT->Hide();
    $winConfig->lblLogDbFileT->Hide();
    $winConfig->tfLogDbFile->Hide();
    $winConfig->btnLogDbFile->Hide();
    $winConfig->btnLogDbFileNew->Hide();
    $winConfig->btnLogDbView->Hide();
    $winConfig->chLogActivate->Hide();
    $winConfig->lblDbFileShadowT->Hide();
    $winConfig->lblDbFileT->Hide();
    $winConfig->tfDbFile->Hide();
    $winConfig->btnDbFile->Hide();
    $winConfig->btnDbFileNew->Hide();
    $winConfig->btnWhoisDbView->Hide();
    $winConfig->chDBCache->Hide();
    $winConfig->chRelRangeSearches->Hide();
    # Databases tab
    $winConfig->lblTLDDBShadowT->Hide();
    $winConfig->lblTLDDBT->Hide();
    $winConfig->chTLDDBAutoUpt->Hide();
    $winConfig->tfTLDDB->Hide();
    $winConfig->btnTLDDB->Hide();
    $winConfig->btnTLDDBUpt->Hide();
    $winConfig->lblWSDBShadowT->Hide();
    $winConfig->lblWSDBT->Hide();
    $winConfig->chWSDBAutoUpt->Hide();
    $winConfig->tfWSDB->Hide();
    $winConfig->btnWSDB->Hide();
    $winConfig->btnWSDBUpt->Hide();
    $winConfig->lblIPv4ShadowT->Hide();
    $winConfig->lblIPv4T->Hide();
    $winConfig->chIPv4DBAutoUpt->Hide();
    $winConfig->tfIPv4DB->Hide();
    $winConfig->btnIPv4DB->Hide();
    $winConfig->btnIPv4DBUpt->Hide();
    $winConfig->lblIPv6ShadowT->Hide();
    $winConfig->lblIPv6T->Hide();
    $winConfig->chIPv6DBAutoUpt->Hide();
    $winConfig->tfIPv6DB->Hide();
    $winConfig->btnIPv6DB->Hide();
    $winConfig->btnIPv6DBUpt->Hide();
    $winConfig->lblGeoIPDBShadowT->Hide();
    $winConfig->lblGeoIPDBT->Hide();
    $winConfig->chGeoIPDBAutoUpt->Hide();
    $winConfig->tfGeoIPDB->Hide();
    $winConfig->btnGeoIPDB->Hide();
    $winConfig->btnGeoIPDBUpt->Hide();
  # Show Storage tab
  } elsif ($winConfig->configTab->SelectedItem() == 1) {
    # General tab
    $winConfig->lblToolShadowT->Hide();
    $winConfig->lblToolT->Hide();
    $winConfig->lblReportShadowT->Hide();
    $winConfig->lblReportT->Hide();
    $winConfig->tfReportDir->Hide();
    $winConfig->btnReportDir->Hide();
    $winConfig->btnOpenDir->Hide();
    $winConfig->chReplace->Hide();
    $winConfig->chAutoViewDir->Hide();
    $winConfig->chAutoViewing->Hide();
    $winConfig->tfMaxView->Hide();
    $winConfig->btnCheckUpdate->Hide();
    $winConfig->chAutoUpdate->Hide();
    $winConfig->btnExportLang->Hide();
    $winConfig->btnOpenUserDir->Hide();
    $winConfig->lblGeneralShadowT->Hide();
    $winConfig->lblGeneralT->Hide();
    $winConfig->chStartMinimized->Hide();
    $winConfig->lblNWMode->Hide();
    $winConfig->rbNWModeNormal->Hide();
    $winConfig->rbNWModeRDAP->Hide();
    $winConfig->lblGeoIPLang->Hide();
    $winConfig->cbGeoIPLang->Hide();
    $winConfig->lblNsLookupTO1->Hide();
    $winConfig->tfLookupTO->Hide();
    $winConfig->lblNsLookupTO2->Hide();
    $winConfig->lblUserAgent->Hide();
    $winConfig->tfUserAgent->Hide();
    $winConfig->lblParserShadowT->Hide();
    $winConfig->lblParserT->Hide();
    $winConfig->chIPv4->Hide();
    $winConfig->chIPv6->Hide();
    $winConfig->chHostname->Hide();
    $winConfig->chDomainName->Hide();
    # Storage tab
    $winConfig->lblReportShadowT->Show();
    $winConfig->lblReportT->Show();
    $winConfig->tfReportDir->Show();
    $winConfig->btnReportDir->Show();
    $winConfig->btnOpenDir->Show();
    $winConfig->chReplace->Show();
    $winConfig->chAutoViewDir->Show();
    $winConfig->chAutoViewing->Show();
    $winConfig->tfMaxView->Show();
    $winConfig->lblLogDbFileShadowT->Show();
    $winConfig->lblLogDbFileT->Show();
    $winConfig->tfLogDbFile->Show();
    $winConfig->btnLogDbFile->Show();
    $winConfig->btnLogDbFileNew->Show();
    $winConfig->btnLogDbView->Show();
    $winConfig->chLogActivate->Show();
    $winConfig->lblDbFileShadowT->Show();
    $winConfig->lblDbFileT->Show();
    $winConfig->tfDbFile->Show();
    $winConfig->btnDbFile->Show();
    $winConfig->btnDbFileNew->Show();
    $winConfig->btnWhoisDbView->Show();
    $winConfig->chDBCache->Show();
    $winConfig->chRelRangeSearches->Show();
    # Databases tab
    $winConfig->lblTLDDBShadowT->Hide();
    $winConfig->lblTLDDBT->Hide();
    $winConfig->chTLDDBAutoUpt->Hide();
    $winConfig->tfTLDDB->Hide();
    $winConfig->btnTLDDB->Hide();
    $winConfig->btnTLDDBUpt->Hide();
    $winConfig->lblWSDBShadowT->Hide();
    $winConfig->lblWSDBT->Hide();
    $winConfig->chWSDBAutoUpt->Hide();
    $winConfig->tfWSDB->Hide();
    $winConfig->btnWSDB->Hide();
    $winConfig->btnWSDBUpt->Hide();
    $winConfig->lblIPv4ShadowT->Hide();
    $winConfig->lblIPv4T->Hide();
    $winConfig->chIPv4DBAutoUpt->Hide();
    $winConfig->tfIPv4DB->Hide();
    $winConfig->btnIPv4DB->Hide();
    $winConfig->btnIPv4DBUpt->Hide();
    $winConfig->lblIPv6ShadowT->Hide();
    $winConfig->lblIPv6T->Hide();
    $winConfig->chIPv6DBAutoUpt->Hide();
    $winConfig->tfIPv6DB->Hide();
    $winConfig->btnIPv6DB->Hide();
    $winConfig->btnIPv6DBUpt->Hide();
    $winConfig->lblGeoIPDBShadowT->Hide();
    $winConfig->lblGeoIPDBT->Hide();
    $winConfig->chGeoIPDBAutoUpt->Hide();
    $winConfig->tfGeoIPDB->Hide();
    $winConfig->btnGeoIPDB->Hide();
    $winConfig->btnGeoIPDBUpt->Hide();
  # Show Databases tab
  } elsif ($winConfig->configTab->SelectedItem() == 2) {
    # General tab
    $winConfig->lblToolShadowT->Hide();
    $winConfig->lblToolT->Hide();
    $winConfig->lblReportShadowT->Hide();
    $winConfig->lblReportT->Hide();
    $winConfig->tfReportDir->Hide();
    $winConfig->btnReportDir->Hide();
    $winConfig->btnOpenDir->Hide();
    $winConfig->chReplace->Hide();
    $winConfig->chAutoViewDir->Hide();
    $winConfig->chAutoViewing->Hide();
    $winConfig->tfMaxView->Hide();
    $winConfig->btnCheckUpdate->Hide();
    $winConfig->chAutoUpdate->Hide();
    $winConfig->btnExportLang->Hide();
    $winConfig->btnOpenUserDir->Hide();
    $winConfig->lblGeneralShadowT->Hide();
    $winConfig->lblGeneralT->Hide();
    $winConfig->chStartMinimized->Hide();
    $winConfig->lblNWMode->Hide();
    $winConfig->rbNWModeNormal->Hide();
    $winConfig->rbNWModeRDAP->Hide();
    $winConfig->lblGeoIPLang->Hide();
    $winConfig->cbGeoIPLang->Hide();
    $winConfig->lblNsLookupTO1->Hide();
    $winConfig->tfLookupTO->Hide();
    $winConfig->lblNsLookupTO2->Hide();
    $winConfig->lblUserAgent->Hide();
    $winConfig->tfUserAgent->Hide();
    $winConfig->lblParserShadowT->Hide();
    $winConfig->lblParserT->Hide();
    $winConfig->chIPv4->Hide();
    $winConfig->chIPv6->Hide();
    $winConfig->chHostname->Hide();
    $winConfig->chDomainName->Hide();
    # Storage tab
    $winConfig->lblReportShadowT->Hide();
    $winConfig->lblReportT->Hide();
    $winConfig->tfReportDir->Hide();
    $winConfig->btnReportDir->Hide();
    $winConfig->btnOpenDir->Hide();
    $winConfig->chReplace->Hide();
    $winConfig->chAutoViewDir->Hide();
    $winConfig->chAutoViewing->Hide();
    $winConfig->tfMaxView->Hide();
    $winConfig->lblLogDbFileShadowT->Hide();
    $winConfig->lblLogDbFileT->Hide();
    $winConfig->tfLogDbFile->Hide();
    $winConfig->btnLogDbFile->Hide();
    $winConfig->btnLogDbFileNew->Hide();
    $winConfig->btnLogDbView->Hide();
    $winConfig->chLogActivate->Hide();
    $winConfig->lblDbFileShadowT->Hide();
    $winConfig->lblDbFileT->Hide();
    $winConfig->tfDbFile->Hide();
    $winConfig->btnDbFile->Hide();
    $winConfig->btnDbFileNew->Hide();
    $winConfig->btnWhoisDbView->Hide();
    $winConfig->chDBCache->Hide();
    $winConfig->chRelRangeSearches->Hide();
    # Databases tab
    $winConfig->lblTLDDBShadowT->Show();
    $winConfig->lblTLDDBT->Show();
    $winConfig->chTLDDBAutoUpt->Show();
    $winConfig->tfTLDDB->Show();
    $winConfig->btnTLDDB->Show();
    $winConfig->btnTLDDBUpt->Show();
    $winConfig->lblWSDBShadowT->Show();
    $winConfig->lblWSDBT->Show();
    $winConfig->chWSDBAutoUpt->Show();
    $winConfig->tfWSDB->Show();
    $winConfig->btnWSDB->Show();
    $winConfig->btnWSDBUpt->Show();
    $winConfig->lblIPv4ShadowT->Show();
    $winConfig->lblIPv4T->Show();
    $winConfig->chIPv4DBAutoUpt->Show();
    $winConfig->tfIPv4DB->Show();
    $winConfig->btnIPv4DB->Show();
    $winConfig->btnIPv4DBUpt->Show();
    $winConfig->lblIPv6ShadowT->Show();
    $winConfig->lblIPv6T->Show();
    $winConfig->chIPv6DBAutoUpt->Show();
    $winConfig->tfIPv6DB->Show();
    $winConfig->btnIPv6DB->Show();
    $winConfig->btnIPv6DBUpt->Show();
    $winConfig->lblGeoIPDBShadowT->Show();
    $winConfig->lblGeoIPDBT->Show();
    $winConfig->chGeoIPDBAutoUpt->Show();
    $winConfig->tfGeoIPDB->Show();
    $winConfig->btnGeoIPDB->Show();
    $winConfig->btnGeoIPDBUpt->Show();
  }

}  #--- End configTab_Click

#--------------------------#
sub btnCheckUpdate_Click { &updateTool(1); }
#--------------------------#

#--------------------------#
sub updateTool
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  # Download the version file  
  my $ua = LWP::UserAgent->new;
  $ua->agent($CONFIG{'USERAGENT'});
  $ua->timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
  $ua->default_header('Accept-Language' => 'en');
  my $req = new HTTP::Request GET => $URL_VER;
  my $res = $ua->request($req);
  # Success, compare versions
  if ($res->is_success) {
    my $status  = $res->code;
    my $content = $res->content;
    my $currVer;
    if ($content =~ /([\d\.]+)/i) { $currVer = $1; }
    # No update available
    if ($currVer le $VERSION) {
      if ($confirm) { Win32::GUI::MessageBox($winConfig, $STR{'update1'}, $STR{'update2'}, 0x40040); } # Up to date
    } else {
      my $answer = Win32::GUI::MessageBox($winConfig, "$STR{'Version'} $currVer $STR{'update5'}?", $STR{'Update'}, 0x40024); # Download available
      # Download the update
      if ($answer == 6) {
        # Open XL-Whois page with default browser
        $win->ShellExecute('open', $URL_TOOL,'','',1) or
          Win32::GUI::MessageBox($winConfig, Win32::FormatMessage(Win32::GetLastError()), $STR{'Error'},0x40010);
      }
    }
  } elsif ($confirm) { Win32::GUI::MessageBox($winConfig, $STR{'errConnection'}.': '.$res->status_line, $STR{'Error'},0x40010); } # Error

}  #--- End updateTool

#--------------------------#
sub chAutoUpdate_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chAutoUpdate->Checked()) {
    $CONFIG{'TOOL_AUTO_UPDATE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'TOOL_AUTO_UPDATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chAutoUpdate_Click

#--------------------------#
sub btnExportLang_Click
#--------------------------#
{
  # Save strings in Lang.ini
  open(LANG, ">$LANG_FILE");
  flock(LANG, 2);
  foreach my $cle (keys %STR) { print LANG "$cle = $STR{$cle}\n"; }
  close(LANG);
  # Open the page
  $win->ShellExecute('open', $LANG_FILE,'','',1);

}  #--- End btnExportLang_Click

#--------------------------#
sub btnOpenUserDir_Click
#--------------------------#
{
  # Open Window Explorer
  Win32::Process::Create(my $ProcessObj, "$ENV{'WINDIR'}\\explorer.exe", "explorer $USERDIR", 0, NORMAL_PRIORITY_CLASS, ".") if -d $USERDIR;

}  #--- End btnOpenUserDir_Click

#--------------------------#
sub rbNWModeNormal_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->rbNWModeNormal->Checked()) {
    $CONFIG{'OPT_NWMODE'} = 0;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'OPT_NWMODE'} = 1;
    &saveConfig(\%CONFIG);
  }

}  #--- End rbNWModeNormal_Click

#--------------------------#
sub rbNWModeRDAP_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->rbNWModeRDAP->Checked()) {
    $CONFIG{'OPT_NWMODE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'OPT_NWMODE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End rbNWModeRDAP_Click

#--------------------------#
sub chIPv4_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chIPv4->Checked()) {
    $CONFIG{'OPT_IPv4'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'OPT_IPv4'} = 0;
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End chIPv4_Click

#--------------------------#
sub chIPv6_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chIPv6->Checked()) {
    $CONFIG{'OPT_IPv6'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'OPT_IPv6'} = 0;
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End chIPv6_Click

#--------------------------#
sub chHostname_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chHostname->Checked()) {
    $CONFIG{'OPT_HOSTNAME'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'OPT_HOSTNAME'} = 0;
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End chHostname_Click

#--------------------------#
sub chDomainName_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chDomainName->Checked()) {
    $CONFIG{'OPT_DOMAIN_NAME'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'OPT_DOMAIN_NAME'} = 0;
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End chDomainName_Click

#--------------------------#
sub chStartMinimized_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chStartMinimized->Checked()) {
    $CONFIG{'START_MINIMIZED'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'START_MINIMIZED'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chStartMinimized_Click

#--------------------------#
sub cbGeoIPLang_Change
#--------------------------#
{
  # Local variables
  my $lang = $winConfig->cbGeoIPLang->GetString($winConfig->cbGeoIPLang->GetCurSel());
  # Remember
  if ($lang) {
    $CONFIG{'GEOIP_LANG'} = $lang;
    &saveConfig(\%CONFIG);
  }

}  #--- End cbGeoIPLang_Change

#--------------------------#
sub tfLookupTO_Change
#--------------------------#
{
  # Local variables
  my $lookupTO = $winConfig->tfLookupTO->Text();
  # Remember
  if ($lookupTO) {
    $CONFIG{'NSLOOKUP_TIMEOUT'} = $lookupTO;
    &saveConfig(\%CONFIG);
  }

}  #--- End tfLookupTO_Change

#--------------------------#
sub tfUserAgent_Change
#--------------------------#
{
  # Local variables
  my $userAgent = $winConfig->tfUserAgent->Text();
  # Remember
  if ($userAgent) {
    $CONFIG{'USERAGENT'} = $userAgent;
    &saveConfig(\%CONFIG);
  }

}  #--- End tfUserAgent_Change

#--------------------------#
sub chAutoViewing_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chAutoViewing->Checked()) {
    $CONFIG{'AUTO_VIEWING'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'AUTO_VIEWING'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chAutoViewing_Click

#--------------------------#
sub tfMaxView_Change
#--------------------------#
{
  # Local variables
  my $maxView = $winConfig->tfMaxView->Text();
  # Remember
  if ($maxView) {
    $CONFIG{'MAX_VIEW'} = $maxView;
    &saveConfig(\%CONFIG);
  }

}  #--- End tfMaxView_Change

#--------------------------#
sub tfReportDir_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $winConfig->tfReportDir->Text();
  # Remember
  if ($saveDir and -d $saveDir) {
    $CONFIG{'DIR_REPORT'} = $saveDir;
    &saveConfig(\%CONFIG);
  } else { # Invalid file or no file
    delete($CONFIG{'DIR_REPORT'});
    &saveConfig(\%CONFIG);
    if ($saveDir) {
      $winConfig->tfReportDir->Text('');
      Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'Error'}, 0x40010) if $START;
    }
  }
  &isWhoisReady(0) if $START;

}  #--- End tfReportDir_Change

#--------------------------#
sub btnReportDir_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfReportDir->Text();
  my $dir;
  # Show BrowseForFolder dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winConfig             ,
                                        -title      => $STR{'btnReportDirTip'},
                                        -folderonly => 1                      ,
                                        -directory  => $lastDir               ,
                                        -newui      => 1                      , );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winConfig             ,
                                        -title      => $STR{'btnReportDirTip'},
                                        -folderonly => 1                      ,
                                        -newui      => 1                      , );
  }
  # Selected folder
  if ($dir and -d $dir) {
    chop($dir) if $dir =~ /\\$/;
    $winConfig->tfReportDir->Text($dir);
  }
  &isWhoisReady(0);
  
}  #--- End btnReportDir_Click

#--------------------------#
sub btnOpenDir_Click
#--------------------------#
{
  # Local variables
  my $outputDir = $winConfig->tfReportDir->Text();
  # Open Window Explorer
  Win32::Process::Create(my $ProcessObj, "$ENV{'WINDIR'}\\explorer.exe", "explorer $outputDir", 0, NORMAL_PRIORITY_CLASS, ".") if -d $outputDir;

}  #--- End btnOpenDir_Click

#--------------------------#
sub chReplace_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chReplace->Checked()) {
    $CONFIG{'REPORT_REPLACE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'REPORT_REPLACE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chReplace_Click

#--------------------------#
sub chAutoViewDir_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chAutoViewDir->Checked()) {
    $CONFIG{'AUTO_VIEW_DIR'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'AUTO_VIEW_DIR'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chAutoViewDir_Click

#--------------------------#
sub chLogActivate_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chLogActivate->Checked()) {
    $CONFIG{'LOGGING'} = 1;
    &saveConfig(\%CONFIG);
    $win->tfComment->Enable();
  } else {
    $CONFIG{'LOGGING'} = 0;
    &saveConfig(\%CONFIG);
    $win->tfComment->Disable();
  }

}  #--- End chLogActivate_Click

#--------------------------#
sub tfLogDbFile_Change
#--------------------------#
{
  # Local variables
  my $logDbFile = $winConfig->tfLogDbFile->Text();
  # Remember
  if ($logDbFile and -f $logDbFile) {
    # Reload Whois Database
    threads->create(sub {
      if(&loadLoggingDB) {
      $CONFIG{'LOGGING_DB_FILE'} = $logDbFile;
      $winConfig->chLogActivate->Enable();
      $win->chCheckLogging->Enable();
      &saveConfig(\%CONFIG);
      } else {
        delete($CONFIG{'LOGGING_DB_FILE'});
        $winConfig->chLogActivate->Checked(0);
        $winConfig->chLogActivate->Disable();
        $CONFIG{'LOGGING'} = 0;
        $win->chCheckLogging->Checked(0);
        $win->chCheckLogging->Disable();
        $CONFIG{'CHECK_LOGGING_DB'} = 0;
        $win->tfComment->Text('');
        $win->tfComment->Disable();
        &saveConfig(\%CONFIG);
        if ($logDbFile) {
          $winConfig->tfLogDbFile->Text('') ;
          Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'Error'}, 0x40010) if $START;
        }
      }
      &isWhoisReady(0) if $START;
    });
  } else { # Invalid file or no file
    delete($CONFIG{'LOGGING_DB_FILE'});
    $winConfig->chLogActivate->Checked(0);
    $winConfig->chLogActivate->Disable();
    $CONFIG{'LOGGING'} = 0;
    $win->chCheckLogging->Checked(0);
    $win->chCheckLogging->Disable();
    $CONFIG{'CHECK_LOGGING_DB'} = 0;
    $win->tfComment->Text('');
    $win->tfComment->Disable();
    &saveConfig(\%CONFIG);
    if ($logDbFile) {
      $winConfig->tfLogDbFile->Text('') ;
      Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'Error'}, 0x40010) if $START;
    }
    &isWhoisReady(0) if $START;
  }

}  #--- End tfLogDbFile_Change

#--------------------------#
sub btnLogDbFile_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfLogDbFile->Text();
  my $logDbFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $logDbFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                  ,
                                              -title         => "$STR{'Select'} $STR{'winLogDB'} $STR{'file'}:",
                                              -defaultfilter => 0                           ,
                                              -filemustexist => 1                           ,
                                              -directory     => $lastDir                    ,
                                              -explorer      => 1                           , );
  } else {
    $logDbFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                  ,
                                              -title         => "$STR{'Select'} $STR{'winLogDB'} $STR{'file'}:",
                                              -defaultfilter => 0                           ,
                                              -filemustexist => 1                           ,
                                              -explorer      => 1                           , );
  }
  # Selected file
  $winConfig->tfLogDbFile->Text($logDbFile) if $logDbFile and -f $logDbFile;
  return(1);

}  #--- End btnLogDbFile_Click

#--------------------------#
sub btnLogDbFileNew_Click
#--------------------------#
{
  my $logDbFile = Win32::GUI::GetOpenFileName(-owner            => $winConfig             ,
                                              -title            => $STR{'btnLogDbFileNew'},
                                              -defaultfilter    => 0              ,
                                              -directory        => $USERDIR       ,
                                              -file             => 'Logging.db'   ,
                                              -defaultextension => 'db'           ,
                                              -explorer         => 1              , );
  # Selected file
  if ($logDbFile) {
    # Create a new Logging Database
    my $return = &createLoggingDB($logDbFile);
    # Success
    if ($return) {
      $winConfig->tfLogDbFile->Text($logDbFile);
      Win32::GUI::MessageBox($winConfig, $STR{'dbCreated'}, $STR{'winLogDB'}, 0x40040);
    } else { Win32::GUI::MessageBox($winConfig, $STR{'errCreating'}.' '.$STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010); } # Error
  }

}  #--- End btnLogDbFileNew_Click

#--------------------------#
sub createLoggingDB
#--------------------------#
{
  # Local variables
  my $logDbFile = shift;
  # Create a new database
  my $dsn = "DBI:SQLite:dbname=$logDbFile";
  my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 }) or return(0);
  # Create main table
  my $stmt = qq(CREATE TABLE IF NOT EXISTS LOGGING_DB
                (date       DATE          NOT NULL,
                 request    VARCHAR(255)  NOT NULL,
                 details    VARCHAR(255)  NOT NULL,
                 comment    VARCHAR(255)  NOT NULL,
                 PRIMARY KEY (date)));
  my $rv = $dbh->do($stmt);
  return(0) if $rv < 0;
  $dbh->disconnect();
  return(1);
  
}  #--- End createLoggingDB

#--------------------------#
sub validLoggingDB
#--------------------------#
{
  # Local variables
  my $logDbFile = shift;
  if (-f $logDbFile) {
    # Connect to DB
    my $dsn = "DBI:SQLite:dbname=$logDbFile";
    if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
      my $sth;
      eval { $sth = $dbh->table_info(undef, undef, '%', 'TABLE'); };
      return(0) if $@;
      # If table LOGGING_DB exists, database is valid
      my @info = $sth->fetchrow_array;
      $sth->finish();
      return(1) if $info[2] eq 'LOGGING_DB';
    }
  }
  return(0);
  
}  #--- End validLoggingDB

#--------------------------#
sub btnLogDbView_Click
#--------------------------#
{
  # Local variables
  my $logDbFile = $winConfig->tfLogDbFile->Text();
  # Database must exist
  if ($logDbFile and -f $logDbFile) {
    # Show Window
    $winLogDB->Center($winConfig);
    $winLogDB->Show();
  } else { Win32::GUI::MessageBox($winConfig, $STR{'errNoDB'}, $STR{'Error'}, 0x40010); }
  return(1);

}  #--- End btnLogDbView_Click

#--------------------------#
sub chDBCache_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chDBCache->Checked()) {
    $CONFIG{'WHOIS_CACHE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'WHOIS_CACHE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chDBCache_Click

#--------------------------#
sub chRelRangeSearches_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chRelRangeSearches->Checked()) {
    $CONFIG{'REL_RANGES_CACHE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'REL_RANGES_CACHE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chRelRangeSearches_Click

#--------------------------#
sub tfDbFile_Change
#--------------------------#
{
  # Local variables
  my $dbFile = $winConfig->tfDbFile->Text();
  my $networkWhoisCacheDir;
  my $searchesCacheDir;
  # Set Network Whois and searches data cache folder
  if ($dbFile) {
    my $whoisDir = $dbFile; # Same folder of Whois Database
    my(@partsWhoisDBPath) = split(/\\/, $whoisDir);
    if (pop(@partsWhoisDBPath) =~ /\./) { while ($whoisDir =~ /[^\\]$/) { chop($whoisDir); } }
    $networkWhoisCacheDir = $whoisDir. 'cache';
    $CONFIG{'WHOIS_DATA_CACHE'} = $networkWhoisCacheDir;
    $searchesCacheDir = $whoisDir. 'searches';
    $CONFIG{'SEARCHES_CACHE'} = $searchesCacheDir;
  }
  # Remember
  if ($dbFile and -f $dbFile) {
    # Reload Whois Database
    threads->create(sub {
      if(&loadWhoisDB) {
        $CONFIG{'WHOIS_DB_FILE'} = $dbFile;
        mkdir($networkWhoisCacheDir) if !-d $networkWhoisCacheDir;
        mkdir($searchesCacheDir)     if !-d $searchesCacheDir;
        &saveConfig(\%CONFIG);
      } else { # Invalid database
        delete($CONFIG{'WHOIS_DB_FILE'});
        delete($CONFIG{'WHOIS_DATA_CACHE'});
        delete($CONFIG{'SEARCHES_CACHE'});
        $win->cbCheckWhoisDB->SetCurSel(0);
        $CONFIG{'CHECK_WHOIS_DB'} = 0;
        $winConfig->chDBCache->Checked(0);
        $CONFIG{'WHOIS_CACHE'} = 0;
        $winConfig->chRelRangeSearches->Checked(0);
        $CONFIG{'REL_RANGES_CACHE'} = 0;
        &saveConfig(\%CONFIG);
        $winConfig->tfDbFile->Text('');
      }
      &isWhoisReady(0) if $START;
    });
  } else { # Invalid file or no file
    delete($CONFIG{'WHOIS_DB_FILE'});
    delete($CONFIG{'WHOIS_DATA_CACHE'});
    delete($CONFIG{'SEARCHES_CACHE'});
    $win->cbCheckWhoisDB->SetCurSel(0);
    $CONFIG{'CHECK_WHOIS_DB'} = 0;
    $winConfig->chDBCache->Checked(0);
    $CONFIG{'WHOIS_CACHE'} = 0;
    $winConfig->chRelRangeSearches->Checked(0);
    $CONFIG{'REL_RANGES_CACHE'} = 0;
    
    &saveConfig(\%CONFIG);
    if ($dbFile) {
      $winConfig->tfDbFile->Text('');
      Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'Error'}, 0x40010) if $START;
    }
    &isWhoisReady(0) if $START;
  }

}  #--- End tfDbFile_Change

#--------------------------#
sub btnDbFile_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfDbFile->Text();
  my $dbFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $dbFile = Win32::GUI::GetOpenFileName(  -owner         => $winConfig,
                                            -title         => "$STR{'Select'} $STR{'winDB'} $STR{'file'}:",
                                            -defaultfilter => 0         ,
                                            -file          => 'Whois.db',
                                            -filemustexist => 1         ,
                                            -directory     => $lastDir  ,
                                            -explorer      => 1         , );
  } else {
    $dbFile = Win32::GUI::GetOpenFileName(  -owner         => $winConfig,
                                            -title         => "$STR{'Select'} $STR{'winDB'} $STR{'file'}:",
                                            -defaultfilter => 0         ,
                                            -file          => 'Whois.db',
                                            -filemustexist => 1         ,
                                            -explorer      => 1         , );
  }
  # Selected file
  $winConfig->tfDbFile->Text($dbFile) if $dbFile and -f $dbFile;
  &isWhoisReady(0);

}  #--- End btnDbFile_Click

#--------------------------#
sub btnDbFileNew_Click
#--------------------------#
{
  my $dbFile = Win32::GUI::GetOpenFileName( -owner            => $winConfig          ,
                                            -title            => $STR{'btnDbFileNew'},
                                            -defaultfilter    => 0                   ,
                                            -directory        => $USERDIR            ,
                                            -file             => 'Whois.db'          ,
                                            -defaultextension => 'db'                ,
                                            -explorer         => 1                   , );
  # Selected file
  if ($dbFile) {
    # Create a new database
    my $return = &createWhoisDB($dbFile);
    # Success
    if ($return) {
      $winConfig->tfDbFile->Text($dbFile);
      Win32::GUI::MessageBox($winConfig, $STR{'dbCreated'}, $STR{'winDB'}, 0x40040);
    } else { Win32::GUI::MessageBox($winConfig, $STR{'errCreating'}.' '.$STR{'database'}.': '.$DBI::errstr, $STR{'Error'}, 0x40010); } # Error
  }
  &isWhoisReady(0);

}  #--- End btnDbFileNew_Click

#--------------------------#
sub createWhoisDB
#--------------------------#
{
  # Local variables
  my $dbFile = shift;
  # Create a new database
  my $dsn = "DBI:SQLite:dbname=$dbFile";
  my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 }) or return(0);
  # Create main table
  my $stmt = qq(CREATE TABLE IF NOT EXISTS WHOIS_DB
                (range_s    INT           NOT NULL,
                 range_e    INT           NOT NULL,
                 isp        VARCHAR(255)  NOT NULL,
                 country    VARCHAR(2)    NOT NULL,
                 date       INT           NOT NULL,
                 PRIMARY KEY (range_s, range_e)));
  my $rv = $dbh->do($stmt);
  return(0) if $rv < 0;
  $dbh->disconnect();
  # Add header to the grid
  $winDB->DBGrid->SetCellText(0, 0, $STR{'cbFilterField1'});
  $winDB->DBGrid->SetCellText(0, 1, $STR{'cbFilterField2'});
  $winDB->DBGrid->SetCellText(0, 2, $STR{'ISP'});
  $winDB->DBGrid->SetCellText(0, 3, $STR{'Country'});
  $winDB->DBGrid->SetCellText(0, 4, $STR{'date'});
  return(1);
  
}  #--- End createWhoisDB

#--------------------------#
sub createWhoisDB_IPV6
#--------------------------#
{
  # Local variables
  my $refDbh = shift;
  # Create a the WHOIS_DB_6 table
  my $stmt = qq(CREATE TABLE IF NOT EXISTS WHOIS_DB_6
                (ipv6_range   VARCHAR(255)  NOT NULL,
                 isp          VARCHAR(255)  NOT NULL,
                 country      VARCHAR(2)    NOT NULL,
                 date         INT           NOT NULL,
                 PRIMARY KEY (ipv6_range)));
  my $rv = $$refDbh->do($stmt);
  
}  #--- End createWhoisDB_IPV6

#--------------------------#
sub btnWhoisDbView_Click
#--------------------------#
{
  my $whoisDB = $winConfig->tfDbFile->Text();
  # Database must exist
  if ($whoisDB and -f $whoisDB) {
    $winDB->Center($winConfig);
    $winDB->DoModal();
  } else { Win32::GUI::MessageBox($winConfig, $STR{'errNoDB'}, $STR{'Error'}, 0x40010); }
  return(1);

}  #--- End btnWhoisDbView_Click

#--------------------------#
sub chTLDDBAutoUpt_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chTLDDBAutoUpt->Checked()) {
    $CONFIG{'TLD_DB_AUTO_UPDATE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'TLD_DB_AUTO_UPDATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chTLDDBAutoUpt_Click

#--------------------------#
sub tfTLDDB_Change
#--------------------------#
{
  # Local variables
  my $TLDdbFile = $winConfig->tfTLDDB->Text();
  # Remember
  if ($TLDdbFile and -f $TLDdbFile and &validTLDDB($TLDdbFile)) {
    $CONFIG{'TLD_DB_FILE'} = $TLDdbFile;
    &saveConfig(\%CONFIG);
  } else {
    delete($CONFIG{'TLD_DB_FILE'});
    &saveConfig(\%CONFIG);
    if ($TLDdbFile) {
      $winConfig->tfTLDDB->Text('');
      Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'Error'}, 0x40010) if $START;
    }
  }

}  #--- End tfTLDDB_Change

#--------------------------#
sub validTLDDB
#--------------------------#
{
  my $TLDdbFile = shift;
  $TLDDB = Domain::PublicSuffix->new({ 'data_file' => $TLDdbFile });
  return(1) if $TLDDB->get_root_domain('www.google.com');
  return(0);
  
}  #--- End validTLDDB

#--------------------------#
sub btnTLDDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfTLDDB->Text();
  my $TLDdbFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $TLDdbFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                ,
                                              -title         => "$STR{'Select'} $STR{'lblTLDDB'} $STR{'file'}:",
                                              -defaultfilter => 0                         ,
                                              -filemustexist => 1                         ,
                                              -directory     => $lastDir                  ,
                                              -file          => 'effective_tld_names.dat' ,
                                              -explorer      => 1                         , );
  } else {
    $TLDdbFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                ,
                                              -title         => "$STR{'Select'} $STR{'lblTLDDB'} $STR{'file'}:",
                                              -defaultfilter => 0                         ,
                                              -filemustexist => 1                         ,
                                              -file          => 'effective_tld_names.dat' ,
                                              -explorer      => 1                         , );
  }
  # Selected file
  $winConfig->tfTLDDB->Text($TLDdbFile) if $TLDdbFile and -f $TLDdbFile;
  return(1);

}  #--- End btnTLDDB_Click

#--------------------------#
sub btnTLDDBUpt_Click
#--------------------------#
{
  threads->create(sub { &updateDB(1, 'TLD', $STR{'lblTLDDB'}, $winConfig->tfTLDDB->Text(), $TLDDB_URL, 'publicsuffix.org', 'effective_tld_names.dat'); });
  return(1);
  
}  #--- End btnTLDDBUpt_Click

#--------------------------#
sub chWSDBAutoUpt_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chWSDBAutoUpt->Checked()) {
    $CONFIG{'WS_DB_AUTO_UPDATE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'WS_DB_AUTO_UPDATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chWSDBAutoUpt_Click

#--------------------------#
sub tfWSDB_Change
#--------------------------#
{
  # Local variables
  my $WSdbFile = $winConfig->tfWSDB->Text();
  # Remember
  if ($WSdbFile and -f $WSdbFile and &validWSDB($WSdbFile)) {
    $CONFIG{'WS_DB_FILE'} = $WSdbFile;
    &saveConfig(\%CONFIG);
  } else {
    delete($CONFIG{'WS_DB_FILE'});
    &saveConfig(\%CONFIG);
    if ($WSdbFile) {
      $winConfig->tfWSDB->Text('');
      Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'Error'}, 0x40010) if $START;
    }
  }

}  #--- End tfWSDB_Change

#--------------------------#
sub validWSDB
#--------------------------#
{
  my $WSdbFile = shift;
  eval { json_file_to_perl($WSdbFile); };
  return(1) if !$@;
  return(0);
  
}  #--- End validWSDB

#--------------------------#
sub btnWSDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfWSDB->Text();
  my $WSdbFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $WSdbFile = Win32::GUI::GetOpenFileName(  -owner         => $winConfig            ,
                                              -title         => "$STR{'Select'} $STR{'lblWSDB'} $STR{'file'}:",
                                              -defaultfilter => 0                     ,
                                              -filemustexist => 1                     ,
                                              -directory     => $lastDir              ,
                                              -file          => 'tld.json'            ,
                                              -explorer      => 1                     , );
  } else {
    $WSdbFile = Win32::GUI::GetOpenFileName(  -owner         => $winConfig            ,
                                              -title         => "$STR{'Select'} $STR{'lblWSDB'} $STR{'file'}:",
                                              -defaultfilter => 0                     ,
                                              -filemustexist => 1                     ,
                                              -file          => 'tld.json'            ,
                                              -explorer      => 1                     , );
  }
  # Selected file
  $winConfig->tfWSDB->Text($WSdbFile) if $WSdbFile and -f $WSdbFile;
  return(1);

}  #--- End btnWSDB_Click

#--------------------------#
sub btnWSDBUpt_Click
#--------------------------#
{
  threads->create(sub { &updateDB(1, 'WS', $STR{'lblWSDB'}, $winConfig->tfWSDB->Text(), $WSLOG_URL, 'github.com (weppos)', 'tld.json'); });
  return(1);
  
}  #--- End btnWSDBUpt_Click

#--------------------------#
sub chIPv4DBAutoUpt_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chIPv4DBAutoUpt->Checked()) {
    $CONFIG{'IPv4_DB_AUTO_UPDATE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'IPv4_DB_AUTO_UPDATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chIPv4DBAutoUpt_Click

#--------------------------#
sub tfIPv4DB_Change
#--------------------------#
{
  # Local variables
  my $IPv4dbFile = $winConfig->tfIPv4DB->Text();
  # Remember
  if ($IPv4dbFile and -f $IPv4dbFile and &validIPv4DB($IPv4dbFile)) {
    $CONFIG{'IPv4_DB_FILE'} = $IPv4dbFile;
    &saveConfig(\%CONFIG);
  } else {
    delete($CONFIG{'IPv4_DB_FILE'});
    &saveConfig(\%CONFIG);
    if ($IPv4dbFile) {
      $winConfig->tfIPv4DB->Text('');
      Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'Error'}, 0x40010) if $START;
    }
  }

}  #--- End tfIPv4DB_Change

#--------------------------#
sub validIPv4DB
#--------------------------#
{
  # Local variables
  my $IPv4dbFile = shift;
  my $first;
  my $second;
  # Open IPv4 CSV file and read first two lines
  if (open(my $IPv4_CSV, '<', $IPv4dbFile)) {
    while( my $line = <$IPv4_CSV>)  {
      if (!$first) { $first  = $line;       }
      else         { $second = $line; last; }
    }
    close $IPv4_CSV;
    return(1) if $first =~ /^Prefix,/ and $second =~ /^\d{3}\//;
  }
  return(0);

}  #--- End validIPv4DB

#--------------------------#
sub loadIPv4DB
#--------------------------#
{
  # Local variables
  my $refIPv4    = shift;
  my $IPv4dbFile = $winConfig->tfIPv4DB->Text();
  %{$refIPv4}    = ();
  # Open IPv4 CSV file
  open(IPV4, $IPv4dbFile) or Win32::GUI::MessageBox($win, $STR{'errReading'}.$!, $STR{'Error'},0x40010);
  my @tab = <IPV4>;
  close(IPV4);
  # Store data in memory
  my $header = shift(@tab);
  if ($header =~ /^Prefix,/) {
    foreach (@tab) {
      my @fields = split(/,/, $_);
      if ($fields[3] and $fields[3] =~ /^whois/) {
        my ($prefix, $mask) = split(/\//, $fields[0]);
        $$refIPv4{$prefix} = $fields[3];
      }
    }
    return(1);
  } else { return(0); }  

}  #--- End loadIPv4DB

#--------------------------#
sub loadIPv4DB_RDAP
#--------------------------#
{
  # Local variables
  my $refIPv4    = shift;
  my $IPv4dbFile = $winConfig->tfIPv4DB->Text();
  %{$refIPv4}    = ();
  # Open IPv4 CSV file
  open(IPV4, $IPv4dbFile) or Win32::GUI::MessageBox($win, $STR{'errReading'}.$!, $STR{'Error'},0x40010);
  my @tab = <IPV4>;
  close(IPV4);
  # Store data in memory
  my $header = shift(@tab);
  if ($header =~ /^Prefix,/) {
    foreach (@tab) {
      my @fields = split(/,/, $_);
      if ($fields[4] and $fields[4] =~ /rdap/) {
        my (@parts) = split(/http:/, $fields[4]);
        my $https = $parts[0];
        my ($prefix, $mask) = split(/\//, $fields[0]);
        $$refIPv4{$prefix} = $https;
      }
    }
    return(1);
  } else { return(0); }  

}  #--- End loadIPv4DB_RDAP

#--------------------------#
sub btnIPv4DB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfIPv4DB->Text();
  my $IPv4dbFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $IPv4dbFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                ,
                                              -title         => "$STR{'Select'} $STR{'lblIPv4DB'} $STR{'file'}:",
                                              -defaultfilter => 0                         ,
                                              -filemustexist => 1                         ,
                                              -directory     => $lastDir                  ,
                                              -file          => 'ipv4-address-space.csv'  ,
                                              -explorer      => 1                         , );
  } else {
    $IPv4dbFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                ,
                                              -title         => "$STR{'Select'} $STR{'lblIPv4DB'} $STR{'file'}:",
                                              -defaultfilter => 0                         ,
                                              -filemustexist => 1                         ,
                                              -file          => 'ipv4-address-space.csv'  ,
                                              -explorer      => 1                         , );
  }
  # Selected file
  $winConfig->tfIPv4DB->Text($IPv4dbFile) if $IPv4dbFile and -f $IPv4dbFile;
  return(1);

}  #--- End btnIPv4DB_Click

#--------------------------#
sub btnIPv4DBUpt_Click
#--------------------------#
{
  threads->create(sub { &updateDB(1, 'IPv4', $STR{'lblIPv4DB'}, $winConfig->tfIPv4DB->Text(), $IPv4DB_URL, 'iana.org', 'ipv4-address-space.csv'); });
  return(1);
  
}  #--- End btnIPv4DBUpt_Click

#--------------------------#
sub chIPv6DBAutoUpt_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chIPv6DBAutoUpt->Checked()) {
    $CONFIG{'IPv6_DB_AUTO_UPDATE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'IPv6_DB_AUTO_UPDATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chIPv6DBAutoUpt_Click

#--------------------------#
sub tfIPv6DB_Change
#--------------------------#
{
  # Local variables
  my $IPv6dbFile = $winConfig->tfIPv6DB->Text();
  # Remember
  if ($IPv6dbFile and -f $IPv6dbFile and &validIPv6DB($IPv6dbFile)) {
    $CONFIG{'IPv6_DB_FILE'} = $IPv6dbFile;
    &saveConfig(\%CONFIG);
  } else {
    delete($CONFIG{'IPv6_DB_FILE'});
    &saveConfig(\%CONFIG);
    if ($IPv6dbFile) {
      $winConfig->tfIPv6DB->Text('');
      Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'Error'}, 0x40010) if $START;
    }
  }

}  #--- End tfIPv6DB_Change

#--------------------------#
sub validIPv6DB
#--------------------------#
{
  # Local variables
  my $IPv6dbFile = shift;
  my $first;
  my $second;
  # Open IPv6 CSV file and read first two lines
  if (open(my $IPv6_CSV, '<', $IPv6dbFile)) {
    while( my $line = <$IPv6_CSV>)  {
      if (!$first) { $first  = $line;       }
      else         { $second = $line; last; }
    }
    close $IPv6_CSV;
    return(1) if $first =~ /^Prefix,/ and $second =~ /^\d{4}\:/;
  }
  return(0);

}  #--- End validIPv6DB

#--------------------------#
sub loadIPv6DB
#--------------------------#
{
  # Local variables
  my $refIPv6    = shift;
  my $IPv6dbFile = $winConfig->tfIPv6DB->Text();
  %{$refIPv6}    = ();
  # Open IPv6 CSV file
  open(IPV6, $IPv6dbFile) or Win32::GUI::MessageBox($win, $STR{'errReading'}.$!, $STR{'Error'},0x40010);
  my @tab = <IPV6>;
  close(IPV6);
  # Store data in memory
  my $header = shift(@tab);
  if ($header =~ /^Prefix,/) {
    foreach (@tab) {
      my @fields = split(/,/, $_);
      $$refIPv6{$fields[0]} = $fields[3] if $fields[3] and $fields[3] =~ /^whois/;
    }
    return(1);
  } else { return(0); }  

}  #--- End loadIPv6DB

#--------------------------#
sub loadIPv6DB_RDAP
#--------------------------#
{
  # Local variables
  my $refIPv6    = shift;
  my $IPv6dbFile = $winConfig->tfIPv6DB->Text();
  %{$refIPv6}    = ();
  # Open IPv6 CSV file
  open(IPV6, $IPv6dbFile) or Win32::GUI::MessageBox($win, $STR{'errReading'}.$!, $STR{'Error'},0x40010);
  my @tab = <IPV6>;
  close(IPV6);
  # Store data in memory
  my $header = shift(@tab);
  if ($header =~ /^Prefix,/) {
    foreach (@tab) {
      my @fields = split(/,/, $_);
      if ($fields[4] and $fields[4] =~ /rdap/) {
        my (@parts) = split(/http:/, $fields[4]);
        my $https = $parts[0];
        my ($prefix, $mask) = split(/\//, $fields[0]);
        $$refIPv6{$prefix} = $https;
      }
    }
    return(1);
  } else { return(0); }  

}  #--- End loadIPv6DB_RDAP

#--------------------------#
sub btnIPv6DB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfIPv6DB->Text();
  my $IPv6dbFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $IPv6dbFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                              ,
                                              -title         => "$STR{'Select'} $STR{'lblIPv6DB'} $STR{'file'}:",
                                              -defaultfilter => 0                                       ,
                                              -filemustexist => 1                                       ,
                                              -directory     => $lastDir                                ,
                                              -file          => 'ipv6-unicast-address-assignments.csv'  ,
                                              -explorer      => 1                                       , );
  } else {
    $IPv6dbFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                              ,
                                              -title         => "$STR{'Select'} $STR{'lblIPv6DB'} $STR{'file'}:",
                                              -defaultfilter => 0                                       ,
                                              -filemustexist => 1                                       ,
                                              -file          => 'ipv6-unicast-address-assignments.csv'  ,
                                              -explorer      => 1                                       , );
  }
  # Selected file
  $winConfig->tfIPv6DB->Text($IPv6dbFile) if $IPv6dbFile and -f $IPv6dbFile;
  return(1);

}  #--- End btnIPv6DB_Click

#--------------------------#
sub btnIPv6DBUpt_Click
#--------------------------#
{
  threads->create(sub { &updateDB(1, 'IPv6', $STR{'lblIPv6DB'}, $winConfig->tfIPv6DB->Text(), $IPv6DB_URL, 'iana.org', 'ipv6-unicast-address-assignments.csv'); });
  return(1);
  
}  #--- End btnIPv6DBUpt_Click


#--------------------------#
sub chGeoIPDBAutoUpt_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chGeoIPDBAutoUpt->Checked() == 1) {
    $CONFIG{'GEOIP_DB_AUTO_UPDATE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'GEOIP_DB_AUTO_UPDATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chGeoIPDBAutoUpt_Click

#--------------------------#
sub tfGeoIPDB_Change
#--------------------------#
{
  # Local variables
  my $GeoIPDBFile = $winConfig->tfGeoIPDB->Text();
  # Remember
  if ($GeoIPDBFile and -f $GeoIPDBFile and &validGeoIPDB($GeoIPDBFile)) {
    $CONFIG{'GEOIP_DB_FILE'} = $GeoIPDBFile;
    &saveConfig(\%CONFIG);
    $trayMenu->{'geoip'}->Enabled(1);
    $win->chGeoIP->Enable();
  } else {
    delete($CONFIG{'GEOIP_DB_FILE'});
    &saveConfig(\%CONFIG);
    $trayMenu->{'geoip'}->Enabled(0);
    $win->chGeoIP->Disable();
    if ($GeoIPDBFile) {
      $winConfig->tfGeoIPDB->Text('');
      Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'Error'}, 0x40010) if $START;
    }
  }

}  #--- End tfGeoIPDB_Change

#--------------------------#
sub btnGeoIPDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfGeoIPDB->Text();
  my $GeoIPDBFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $GeoIPDBFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                ,
                                                -title         => "$STR{'Select'} $STR{'GeoIPDB'} $STR{'file'}",
                                                -defaultfilter => 0                         ,
                                                -filemustexist => 1                         ,
                                                -directory     => $lastDir                  ,
                                                -file          => 'GeoLite2-City.mmdb'      ,
                                                -explorer      => 1                         , );
  } else {
    $GeoIPDBFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                ,
                                                -title         => "$STR{'Select'} $STR{'GeoIPDB'} $STR{'file'}",
                                                -defaultfilter => 0                         ,
                                                -filemustexist => 1                         ,
                                                -file          => 'GeoLite2-City.mmdb'      ,
                                                -explorer      => 1                         , );
  }
  # Selected file
  $winConfig->tfGeoIPDB->Text($GeoIPDBFile) if $GeoIPDBFile and -f $GeoIPDBFile;
  return(1);

}  #--- End btnGeoIPDB_Click

#--------------------------#
sub btnGeoIPDBUpt_Click
#--------------------------#
{
  threads->create(sub { &updateDB(1, 'GeoIP', $STR{'GeoIPDB'}, $winConfig->tfGeoIPDB->Text(), $GEOIPDB_URL, 'Maxmind', 'GeoLite2-City.mmdb'); });
  return(1);
  
}  #--- End btnGeoIPDBUpt_Click

#--------------------------#
sub validGeoIPDB
#--------------------------#
{
  # Local variables
  my $GeoIPDBFile = shift;
  if (-e $GeoIPDBFile and MaxMind::DB::Reader->new(file => $GeoIPDBFile)) {
    return(1);
  } else { return(0); }
  
}  #--- End validGeoIPDB

#--------------------------#
sub updateDB
#--------------------------#
{
  # This function may be called in 2 ways
  # 1. User click on the update button ($confirm == 1)
  # 2. Auto update at start up: If database is up to date, we don't show message
  
  # Local variables
	my ($confirm, $db, $dbStr, $localFile, $url, $site, $filename) = @_;
  # if $confirm == 1, show message
  # $db: IPv4, IPv6, GeoIP, WS, TLD
  my $head_only = 1;
  $head_only    = 0 if $db eq 'WS';
	if (!$localFile and $db eq 'GeoIP' and $localFile = &findXLTKfile('GeoIPDB')) {
		$winConfig->tfGeoIPDB->Text($localFile);
		$CONFIG{'GEOIP_DB_FILE'} = $localFile;
		&saveConfig($CONFIG_FILE);
	}
  $localFile = "$USERDIR\\$filename" if !$localFile;  # Default location
  # Check if update available or necessary
  my $winH = $win;
  $winH    = $winConfig if $confirm;
  my ($upToDate, $return, $dateLocalFile, $dateRemoteFile) = &checkUpdate($confirm, $winH, $localFile, $url, $head_only);
  # Values for $upToDate
  # 0: Database doesn't exist  
  # 1: Database is up to date
  # 2: Database is outdated
  # 3: Error connection
  # 4: Unknown error
  # Database is outdated or doesn't exist
  if (!$upToDate or $upToDate == 2) {
    my $msg;
    if ($dateLocalFile and $dateRemoteFile) {
      Encode::from_to($dateRemoteFile, 'utf8', 'iso-8859-1');
      $msg = "$STR{'currDBDate'}: $dateLocalFile\n$STR{'remoteDBDate'} $site: $dateRemoteFile\n\n$STR{'updateAvailable'}?";
    } else { $msg .= "$dbStr ($filename) $STR{'NotExistDownload'}?"; }
    my $answer = Win32::GUI::MessageBox($winH, $msg, "$STR{'Update'} $dbStr", 0x1024);
    # Answer is No (7)
    if ($answer == 7) { return(0); }
    # Answer is Yes (6), download the update
    else {
      $winH->ChangeCursor($HOURGLASS);
      my ($status, $msg);
      if      ($db eq 'IPv4') {
        if ($status = &downloadDBLite($localFile, $IPv4DB_CSV)) {
          $winConfig->tfIPv4DB->Text($localFile);
          $CONFIG{'IPv4_DB_FILE'} = $localFile;
          &saveConfig(\%CONFIG);
        }
      } elsif ($db eq 'IPv6') {
        if ($status  = &downloadDBLite($localFile, $IPv6DB_CSV)) {
          $winConfig->tfIPv6DB->Text($localFile);
          $CONFIG{'IPv6_DB_FILE'} = $localFile;
          &saveConfig(\%CONFIG);
        }
      } elsif ($db eq 'GeoIP' or $db eq 'WS' or $db eq 'TLD') {
        if      ($db eq 'GeoIP') {
          if ($localFile) { $localFile =~ s/\\[^\\]+$//; }
          else            { $localFile = $USERDIR;       }
        } elsif ($db eq 'WS') { $url = $WSDB_URL; }
        ($status, $msg)  = &downloadDB(\$winH, $db, $dbStr, $localFile, $url, $site);
      }
      if ($status) {
        $winH->ChangeCursor($ARROW);
        Win32::GUI::MessageBox($winH, "$dbStr $STR{'HasBeenUpdated'}", "$STR{'Update'} $dbStr", 0x40040);
      } else {
        $winH->ChangeCursor($ARROW);
        $msg = "$STR{'errDownloading'} $dbStr..." if !$msg;
        Win32::GUI::MessageBox($winH, $msg, $STR{'Error'}, 0x40010);
      }
    }
  # DB is up to date, show message if $confirm == 1
  } elsif ($upToDate == 1) {
    if ($confirm) {
      Encode::from_to($dateRemoteFile, 'utf8', 'iso-8859-1');
      my $msg = "$STR{'currDBDate'}: $dateLocalFile\n$STR{'remoteDBDate'} $site: $dateRemoteFile\n\n$STR{'DBUpToDate'}!";
      Win32::GUI::MessageBox($winH, $msg, "$STR{'Update'} $dbStr", 0x40040);
    }
  # Connection error, show message if $confirm == 1
  } elsif (($upToDate == 3 or $upToDate == 4) and $confirm) {
    if ($upToDate == 3) { Win32::GUI::MessageBox($winH, "$STR{'errConnection'}: $return", $STR{'Error'}, 0x40010); }
    else                { Win32::GUI::MessageBox($winH, "$STR{'errUnknown'}: $return", $STR{'Error'}   , 0x40010); }
  }

}  #--- End updateDB

#--------------------------#
sub downloadDBLite
#--------------------------#
{
  # Local variables
  my ($localDB, $url) = @_;
  if (is_success(getstore($url, $localDB))) { return(1); }
  else                                      { return(0); }
  
}  #--- End downloadDBLite

#--------------------------#
sub downloadDB
#--------------------------#
{
  # Local variables
  my ($refWin, $db, $dbStr, $localFile, $url, $site) = @_;
  # Start an agent
  my $ua = LWP::UserAgent->new;
  $ua->agent($CONFIG{'USERAGENT'});
  $ua->timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
  $ua->default_header('Accept-Language' => 'en');
  # Set the progress bar
  $$refWin->ChangeCursor($HOURGLASS);
  $winPb->Text("$STR{'Download'} $dbStr...");
  $winPb->lblPbCurr->Text("$STR{'Connecting'} $site...");
  $winPb->lblCount->Text("0 %");
  $winPb->pbWinPb->SetRange(0, 100);
  $winPb->pbWinPb->SetPos(0);
  $winPb->pbWinPb->SetStep(1);
  $winPb->Center($$refWin);
  $winPb->Show();
  # Check size of the remote file
  if (!$TOTAL_SIZE) {
    my $req    = new HTTP::Request HEAD => $url;
    my $res    = $ua->request($req);
    print $res->request()->uri() . "\n";
    my $return = $res->status_line;
    if ($res->code == 200) { $TOTAL_SIZE = $res->header('content_length'); }
    else {
      # Turn off progress bar
      $$refWin->ChangeCursor($ARROW);
      $winPb->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
      $winPb->pbWinPb->SetPos(0);
      &winPb_Terminate;
      $TOTAL_SIZE = 0;
      return(0, $STR{'errConnection'});
    }
  }
  # Download the file
  my $errorMsg;
  if ($TOTAL_SIZE) {
    my $downloadData;
    # Download the file
    $winPb->Text("$STR{'Download'} $dbStr...");
    $winPb->lblPbCurr->Text("$STR{'Download'} $dbStr...");
    my $response = $ua->get($url, ':content_cb' => sub {
      # Local variables
      my ($data, $response, $protocol) = @_;
      $downloadData       .= $data;                                     # Downloaded data
      my $totalDownloaded  = length($downloadData);                     # Size of downloaded data
      my $completed        = int($totalDownloaded / $TOTAL_SIZE * 100); # Pourcentage of download completed
      $winPb->pbWinPb->SetPos($completed);    # Set the progress bar
      $winPb->lblCount->Text("$completed %"); # Indicate purcentage
    });
    if ($response and $response->is_success) {
      # Save data in a file
      if ($db eq 'TLD') {
        if (open(TLDDB,">$localFile")) {
          print TLDDB $downloadData;
          close(TLDDB);
          # Vaidate file
          if (-f $localFile) {
            $winConfig->tfTLDDB->Text($localFile);
            $CONFIG{'TLD_DB_FILE'} = $localFile;
          } else { $errorMsg = "$STR{'errDownloading'} $dbStr..."; }
        } else { $errorMsg = "$STR{'errorMsg'}: $STR{'errCreating'} $localFile"; }
      } elsif ($db eq 'WS') {
        if (open(WSDB,">$localFile")) {
          my @lines = split(/\n/, $downloadData);
          # Remove comments from the JSON File (comments crash the parser)
          foreach (@lines) { if ($_ !~ /\s+\/\//) { print WSDB "$_\n"; } }
          close(WSDB);
          # Validate file
          if (-f $localFile) {
            $winConfig->tfWSDB->Text($localFile);
            $CONFIG{'WS_DB_FILE'} = $localFile;
          } else { $errorMsg = "$STR{'errDownloading'} $dbStr..."; }
        } else { $errorMsg = "$STR{'errorMsg'}: $STR{'errCreating'} $localFile"; }
      # Uncompress GeoIP downloaded file
      } elsif ($db eq 'GeoIP') {
        my $GeoIPGZIP = $localFile . '\GeoLite2-City.tar.gz';
        if (open(GEOIPGZ,">$GeoIPGZIP")) {
          binmode(GEOIPGZ);
          print GEOIPGZ $downloadData;
          close(GEOIPGZ);
          # Uncompress GEOIP GZIP
          $TOTAL_SIZE = 0;
          my $tar   = Archive::Tar->new($GeoIPGZIP);
          my @files = $tar->list_files;
          my $db_file;
          foreach my $file (@files) {
            if ($file =~ /mmdb/) {
              $db_file = (split(/\//, $file))[-1];
              $tar->extract_file($file, "$localFile\\$db_file");
            }
          }
          # Validate file
          if (-e "$localFile\\$db_file" and &validGeoIPDB("$localFile\\$db_file")) {
            unlink($GeoIPGZIP);
            my $lastModifDate = $response->header('last-modified');
            if ($lastModifDate and my ($y, $m, $d) = parse_date($lastModifDate)) { # Parse date
              my $dateUpt = sprintf("%4d-%02d-%02d", $y, $m, $d);
              utime(time, str2time($dateUpt), "$localFile\\$db_file"); # Change the last modified date of the db file
            }
            $winConfig->tfGeoIPDB->Text("$localFile\\$db_file");
            $CONFIG{'GEOIP_DB_FILE'} = "$localFile\\$db_file";
            &saveConfig(\%CONFIG);
          } else { $errorMsg = "$STR{'errorMsg'}: $STR{'errNoValidFile'}"; }
        } else { $errorMsg = "$STR{'errorMsg'}: $STR{'errCreating'} $GeoIPGZIP"; }
      }
      $downloadData = undef;
      if (!$errorMsg) {
        # Turn off progress bar
        $$refWin->ChangeCursor($ARROW);
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        &winPb_Terminate;
        $TOTAL_SIZE = 0;
        return(1);
      }
    } else { $errorMsg = "$STR{'errDownloading'} $dbStr..."; }
  } else { $errorMsg = "$STR{'errDownloading'} $dbStr..."; }
  if ($errorMsg) {
    # Turn off progress bar
    $$refWin->ChangeCursor($ARROW);
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    &winPb_Terminate;
    $TOTAL_SIZE = 0;
    return(0, $errorMsg);
  }
  $TOTAL_SIZE = 0;
  
}  #--- End downloadDB

#--------------------------#
sub checkUpdate
#--------------------------#
{
  # Local variables
  my ($confirm, $winH, $localFile, $url, $head_only)  = @_;
  my $lastModifDate;
  # File doesn't exist or invalid
  return(0, undef, undef, undef) if !$localFile or !-f $localFile;
  # Check date of local file
  my $dateLocalFile = &time2Date((stat($localFile))[9]);
  if ($confirm) {
    # Set the progress bar
    $winH->ChangeCursor($HOURGLASS);
    $winPb->Text($STR{'Update'});
    $winPb->lblPbCurr->Text($STR{'update2'}.'...');
    $winPb->pbWinPb->SetRange(0, 1);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    $winPb->Center($winH);
    $winPb->Show();
  }
  # Check date of the remote file
  my $ua = LWP::UserAgent->new;
  $ua->agent($CONFIG{'USERAGENT'}, verify_hostname => 0);
  $ua->timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
  $ua->default_header('Accept-Language' => 'en');
  my $req;
  if ($head_only) { $req = HTTP::Request->new(HEAD => $url); }
  else            { $req = HTTP::Request->new(GET  => $url); }
  my $res    = $ua->request($req);
  my $return = $res->status_line;
  if ($confirm) {
    # Turn off progress bar
    $winH->ChangeCursor($ARROW);
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    $winPb->Hide();
  }
  if ($res->code == 200) {
    $lastModifDate = $res->header('last-modified');
    $TOTAL_SIZE    = $res->header('content_length');
    if (!$head_only and !$lastModifDate and $res->content =~ /datetime="([^\"]+)"/) {
      $lastModifDate = $1;
    }
  } else { return(3, $return, undef, undef); } # Error connection
  # Compare local et remote file date
  if ($lastModifDate and my ($y, $m, $d) = parse_date($lastModifDate)) { # Parse date
    my $dateUpt = sprintf("%4d-%02d-%02d", $y, $m, $d);
    my $time1 = str2time($dateLocalFile);
    my $time2 = str2time($dateUpt);
    if ($time1 >= $time2) { return(1, $return, $dateLocalFile, $dateUpt); } # File is up to date
    else { return(2, $return, $dateLocalFile, $dateUpt);                  } # File is outdated
  } else { return(3, $return, undef, undef);                              } # Connection error

}  #--- End checkUpdate

#--------------------------#
sub saveConfig
#--------------------------#
{
  # Local variables
  my $refConfig = shift;
  # Save configuration hash values
  open(CONFIG,">$CONFIG_FILE");
  flock(CONFIG, 2);
  foreach my $cle (keys %{$refConfig}) { print CONFIG "$cle = $$refConfig{$cle}\n"; }
  close(CONFIG);

}  #--- End saveConfig

#--------------------------#
sub loadConfig
#--------------------------#
{
  # Local variables
  my $refConfig = shift;
  # Open and load config values
  open(CONFIG, $CONFIG_FILE);
  my @tab = <CONFIG>;
  close(CONFIG);
  foreach (@tab) {
    chomp($_);
    my ($key, $value) = split(/ = /, $_);
    $$refConfig{$key} = $value if $key;
  }
  # Options
  if (exists($$refConfig{'OPT_DOMAIN'}))          { $win->chDomain->Checked($$refConfig{'OPT_DOMAIN'});                       }
  else                                            { $win->chDomain->Checked(1);                                               } # Default checked
  if (exists($$refConfig{'OPT_NETWORK'}))         { $win->chNetwork->Checked($$refConfig{'OPT_NETWORK'});                     }
  else                                            { $win->chNetwork->Checked(1);                                              } # Default checked
  if (exists($$refConfig{'OPT_DNS'}))             { $win->chDNS->Checked($$refConfig{'OPT_DNS'});                             }
  else                                            { $win->chDNS->Checked(0);                                                  } # Default is not checked
  if (exists($$refConfig{'OPT_GEOIP'}))           { $win->chGeoIP->Checked($$refConfig{'OPT_GEOIP'});                         }
  else                                            { $win->chGeoIP->Checked(0);                                                } # Default is not checked
  # General tab
  if (exists($$refConfig{'TOOL_AUTO_UPDATE'}))    { $winConfig->chAutoUpdate->Checked($$refConfig{'TOOL_AUTO_UPDATE'});       }
  else                                            { $winConfig->chAutoUpdate->Checked(1);                                     } # Default checked
  if (exists($$refConfig{'START_MINIMIZED'}))     { $winConfig->chStartMinimized->Checked($$refConfig{'START_MINIMIZED'});    }
  else                                            { $winConfig->chStartMinimized->Checked(0);                                 } # Default is not checked
  if (exists($$refConfig{'OPT_NWMODE'}))          {                                                                             # Default is normal (WHOIS)
    if ($$refConfig{'OPT_NWMODE'}) { # Change mode to RDAP
      $winConfig->rbNWModeRDAP->Checked(1);
      $winConfig->rbNWModeNormal->Checked(0);
    }
  }
  if (exists($$refConfig{'GEOIP_LANG'}))          {
    my $index = $winConfig->cbGeoIPLang->FindStringExact($$refConfig{'GEOIP_LANG'});
    $winConfig->cbGeoIPLang->SetCurSel($index);
  }
  if (exists($$refConfig{'NSLOOKUP_TIMEOUT'}))    { $winConfig->tfLookupTO->Text($$refConfig{'NSLOOKUP_TIMEOUT'});            }
  else                                            { $winConfig->tfLookupTO->Text(10); $$refConfig{'NSLOOKUP_TIMEOUT'} = 10;   } # Default is 10 seconds
  if (exists($$refConfig{'USERAGENT'}))           { $winConfig->tfUserAgent->Text($$refConfig{'USERAGENT'});                  }
  else                                            { $winConfig->tfUserAgent->Text('XL-Whois (http://www.le-tools.com)');
                                                    $$refConfig{'USERAGENT'} = 'XL-Whois (http://www.le-tools.com)';          } # Use Default
  if (exists($$refConfig{'OPT_IPv4'}))            { $winConfig->chIPv4->Checked($$refConfig{'OPT_IPv4'});                     }
  else                                            { $winConfig->chIPv4->Checked(1);                                           } # Default checked
  if (exists($$refConfig{'OPT_IPv6'}))            { $winConfig->chIPv6->Checked($$refConfig{'OPT_IPv6'});                     }
  else                                            { $winConfig->chIPv6->Checked(1);                                           } # Default checked
  if (exists($$refConfig{'OPT_HOSTNAME'}))        { $winConfig->chHostname->Checked($$refConfig{'OPT_HOSTNAME'});             }
  else                                            { $winConfig->chHostname->Checked(1);                                       } # Default checked
  if (exists($$refConfig{'OPT_DOMAIN_NAME'}))     { $winConfig->chDomainName->Checked($$refConfig{'OPT_DOMAIN_NAME'});        }
  else                                            { $winConfig->chDomainName->Checked(1);                                     } # Default checked
  # Folder for report
  if (exists($$refConfig{'DIR_REPORT'}) and
      -d $$refConfig{'DIR_REPORT'})               { $winConfig->tfReportDir->Text($$refConfig{'DIR_REPORT'});                 }
  if (exists($$refConfig{'REPORT_REPLACE'}))      { $winConfig->chReplace->Checked($$refConfig{'REPORT_REPLACE'});            }
  else                                            { $winConfig->chReplace->Checked(0);                                        } # Default is not checked
  if (exists($$refConfig{'AUTO_VIEWING'}))        { $winConfig->chAutoViewing->Checked($$refConfig{'AUTO_VIEWING'});          }
  else                                            { $winConfig->chAutoViewing->Checked(1);                                    } # Default is checked
  if (exists($$refConfig{'MAX_VIEW'}))            { $winConfig->tfMaxView->Text($$refConfig{'MAX_VIEW'});                     }
  else                                            { $winConfig->tfMaxView->Text(25); $$refConfig{'MAX_VIEW'} = 25;            } # Default is 25
  if (exists($$refConfig{'AUTO_VIEW_DIR'}))       { $winConfig->chAutoViewDir->Checked($$refConfig{'AUTO_VIEW_DIR'});         }
  else                                            { $winConfig->chAutoViewDir->Checked(0);                                    } # Default is not checked
  # Check Logging db
  if (exists($$refConfig{'CHECK_LOGGING_DB'}))    {
    $win->chCheckLogging->Checked($$refConfig{'CHECK_LOGGING_DB'});
    $trayMenu->{'chLogDB'}->Checked($$refConfig{'CHECK_LOGGING_DB'});
  } else { # Default is checked
    $win->chCheckLogging->Checked(1);
    $trayMenu->{'chLogDB'}->Checked(1);
  }
  # Logging Database location
  if (exists($$refConfig{'LOGGING_DB_FILE'}) and
      -f $$refConfig{'LOGGING_DB_FILE'})          { $winConfig->tfLogDbFile->Text($$refConfig{'LOGGING_DB_FILE'}); $winConfig->chLogActivate->Enable(); }
  if (exists($$refConfig{'LOGGING'}))             { $winConfig->chLogActivate->Checked($$refConfig{'LOGGING'});               }
  else                                            { $winConfig->chLogActivate->Checked(1);                                    } # Default is checked
  if ($$refConfig{'LOGGING'}) { $win->tfComment->Enable(); } # If logging activated, comment can be added
  # Check db: Whois Database
  if (exists($$refConfig{'CHECK_WHOIS_DB'}))      {
    $win->cbCheckWhoisDB->SetCurSel($$refConfig{'CHECK_WHOIS_DB'});
    if    (!$$refConfig{'CHECK_WHOIS_DB'}    ) { $trayMenu->{'chDB1'}->Checked(1); }
    elsif ($$refConfig{'CHECK_WHOIS_DB'} == 1) { $trayMenu->{'chDB2'}->Checked(1); }
    elsif ($$refConfig{'CHECK_WHOIS_DB'} == 2) { $trayMenu->{'chDB3'}->Checked(1); }
    elsif ($$refConfig{'CHECK_WHOIS_DB'} == 3) { $trayMenu->{'chDB4'}->Checked(1); }
  } else { # Default is "If present, ask"
    $win->cbCheckWhoisDB->SetCurSel(1);
    $trayMenu->{'chDB2'}->Checked(1);
  }
  if (exists($$refConfig{'WHOIS_DB_FILE'}) and -f $$refConfig{'WHOIS_DB_FILE'}) {
    $winConfig->tfDbFile->Text($$refConfig{'WHOIS_DB_FILE'}); # Whois Data File
    # Set Network Whois and searches data cache folder
    my $whoisDir = $$refConfig{'WHOIS_DB_FILE'}; # Same folder of Whois Database
    my(@partsWhoisDBPath) = split(/\\/, $whoisDir);
    if (pop(@partsWhoisDBPath) =~ /\./) { while ($whoisDir =~ /[^\\]$/) { chop($whoisDir); } }
    my $networkWhoisCacheDir = $whoisDir. 'cache';
    mkdir($networkWhoisCacheDir) if !-d $networkWhoisCacheDir;
    $$refConfig{'WHOIS_DATA_CACHE'} = $networkWhoisCacheDir;
    my $searchesCacheDir = $whoisDir. 'searches';
    mkdir($searchesCacheDir) if !-d $searchesCacheDir;
    $$refConfig{'SEARCHES_CACHE'} = $searchesCacheDir;
  }
  if (exists($$refConfig{'WHOIS_CACHE'}))         { $winConfig->chDBCache->Checked($$refConfig{'WHOIS_CACHE'});               }
  else                                            { $winConfig->chDBCache->Checked(1);                                        } # Default is checked
  if (exists($$refConfig{'REL_RANGES_CACHE'}))    { $winConfig->chRelRangeSearches->Checked($$refConfig{'REL_RANGES_CACHE'}); }
  else                                            { $winConfig->chRelRangeSearches->Checked(1);                               } # Default is checked
  # TLD Database location
  if (exists($$refConfig{'TLD_DB_FILE'}) and
      -f $$refConfig{'TLD_DB_FILE'})              { $winConfig->tfTLDDB->Text($$refConfig{'TLD_DB_FILE'});                    }
  if (exists($$refConfig{'TLD_DB_AUTO_UPDATE'}))  { $winConfig->chTLDDBAutoUpt->Checked($$refConfig{'TLD_DB_AUTO_UPDATE'});   }
  else                                            { $winConfig->chTLDDBAutoUpt->Checked(1);                                   } # Default is checked
  # WS Database location
  if (exists($$refConfig{'WS_DB_FILE'}) and
      -f $$refConfig{'WS_DB_FILE'})               { $winConfig->tfWSDB->Text($$refConfig{'WS_DB_FILE'});                      }
  if (exists($$refConfig{'WS_DB_AUTO_UPDATE'}))   { $winConfig->chWSDBAutoUpt->Checked($$refConfig{'WS_DB_AUTO_UPDATE'});     }
  else                                            { $winConfig->chWSDBAutoUpt->Checked(1);                                    } # Default is checked
  # IPv4 Database location
  if (exists($$refConfig{'IPv4_DB_FILE'}) and
      -f $$refConfig{'IPv4_DB_FILE'})             { $winConfig->tfIPv4DB->Text($$refConfig{'IPv4_DB_FILE'});                  }
  if (exists($$refConfig{'IPv4_DB_AUTO_UPDATE'})) { $winConfig->chIPv4DBAutoUpt->Checked($$refConfig{'IPv4_DB_AUTO_UPDATE'}); }
  else                                            { $winConfig->chIPv4DBAutoUpt->Checked(1);                                  } # Default is checked
  # IPv6 Database location
  if (exists($$refConfig{'IPv6_DB_FILE'}) and
      -f $$refConfig{'IPv6_DB_FILE'})             { $winConfig->tfIPv6DB->Text($$refConfig{'IPv6_DB_FILE'});                  }
  if (exists($$refConfig{'IPv6_DB_AUTO_UPDATE'})) { $winConfig->chIPv6DBAutoUpt->Checked($$refConfig{'IPv6_DB_AUTO_UPDATE'}); }
  else                                            { $winConfig->chIPv6DBAutoUpt->Checked(1);                                  } # Default is checked
  # GeoIPDB Database location
  if (exists($$refConfig{'GEOIP_DB_FILE'}) and -f $$refConfig{'GEOIP_DB_FILE'}) {
    $winConfig->tfGeoIPDB->Text($$refConfig{'GEOIP_DB_FILE'});
    $trayMenu->{'geoip'}->Enabled(1);
    $win->chGeoIP->Enable();
  } else {
    $trayMenu->{'geoip'}->Enabled(0);
    $win->chGeoIP->Disable();
  }
  if (exists($$refConfig{'GEOIP_DB_AUTO_UPDATE'})) { $winConfig->chGeoIPDBAutoUpt->Checked($$refConfig{'GEOIP_DB_AUTO_UPDATE'}); }
  else                                             { $winConfig->chGeoIPDBAutoUpt->Checked(1);                                   } # Default is checked

}  #--- End loadConfig
#!/usr/bin/perl
# Perl - v: 5.16.3
#------------------------------------------------------------------------------#
# Tool name     : XL-Whois
# Description   : Part of the XL-Toolkit, XL-Whois is a tool to gather whois
#                 information on domain and IP address. It store the responses
#                 into a database that can be used with other tools of the
#                 XL-Toolkit.
# WebSite				: http://le-tools.com/XL-Whois.html
# Documentation	: http://le-tools.com/XL-WhoisDoc.html
# CodePlex			: https://xlwhois.codeplex.com/
# GitHub				: https://github.com/arioux/XL-Whois
# Creation      : 2015-09-30
# Modified      : 2017-03-09
my $VERSION     = "4.1.1";
# Author        : Alain Rioux (admin@le-tools.com)
#
# Copyright (C) 2015-2017  Alain Rioux (le-tools.com)
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#------------------------------------------------------------------------------#
# Modules
#------------------------------------------------------------------------------#
use strict;
use warnings;
use ActiveState::DateTime qw(gmt_offset);
use HTTP::Date qw(parse_date str2time);
use Encode qw(decode encode decode_utf8);
use Win32::API();
use Win32::GUI();
use Win32::GUI 1.06 qw(:toolbar ILC_MASK CW_USEDEFAULT);
use Win32::GUI::Grid;
use Win32::Clipboard;
use Win32::Process;
use threads;
use threads::shared;
use Thread::Queue;
use DBI;
use Regexp::IPv6 qw($IPv6_re);
use Domain::PublicSuffix;
use Net::Whois::IP qw(whoisip_query);
use Net::Whois::Raw qw(whois);
use Net::DNS;
use Net::CIDR 'cidr2range';
use Net::IP::Lite;
use NetAddr::IP;
use JSON::Parse 'json_file_to_perl';
use base qw/Net::DNS::Resolver::Base/;
use HTTP::Request::Common qw(POST);
use LWP::UserAgent;
use LWP::Simple;
use REST::Client;
use XML::MyXML qw(xml_to_object);
use Geo::IP;
require "XL-WhoisGraph.pl";
require "XL-WhoisLang.pl";

#------------------------------------------------------------------------------#
# Global variables
#------------------------------------------------------------------------------#
my $PROGDIR = $0;                                                              # Program path
while (chop($PROGDIR) ne "\\") { }                                             # Dir only
my $USERDIR;                                                                   # User path
if (-d "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Whois") { $USERDIR = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Whois"; }
else                                            { $USERDIR = $PROGDIR;                                }
my $CONFIG_FILE = "$USERDIR\\XL-Whois.ini";                                    # Configuration file
my $LANG_FILE   = "$USERDIR\\Lang.ini";                                        # Langage file
my $URL_DOC     = "http://le-tools.com/XL-WhoisDoc.html";                      # Online documentation
my $URL_TOOL    = 'http://le-tools.com/XL-Whois.html#Download';                # Url of the tool
my $URL_VER     = 'http://www.le-tools.com/download/XL-WhoisVer.txt';          # Url of the version file
my %CONFIG      :shared;                                                       # Configuration
my %STR;                                                                       # Strings for GUI
my $TLDDB_URL  = 'https://publicsuffix.org/list/effective_tld_names.dat';                       # URL of the TLD DB
my $WSDB_URL   = 'https://raw.githubusercontent.com/weppos/whois/master/data/tld.json';         # URL of the Whois Server DB
my $WSLOG_URL  = 'https://github.com/weppos/whois/commits/master/data/tld.json';                # URL of the Whois Server DB (Commit page)
my $IPv4DB_URL = 'http://www.iana.org/assignments/ipv4-address-space/ipv4-address-space.xhtml'; # URL of the IPv4 Address Space (to get modified date)
my $IPv4DB_CSV = 'http://www.iana.org/assignments/ipv4-address-space/ipv4-address-space.csv';   # URL of the IPv4 Address Space (the csv file)
my $IPv6DB_URL = 'http://www.iana.org/assignments/ipv6-unicast-address-assignments/ipv6-unicast-address-assignments.xhtml'; # URL of the IPv6 Address Space (to get modified date)
my $IPv6DB_CSV = 'http://www.iana.org/assignments/ipv6-unicast-address-assignments/ipv6-unicast-address-assignments.csv';   # URL of the IPv6 Address Space (the csv file)
my $TOTAL_SIZE      :shared = 0;                                               # Total size for download
my $START = 0;                                                                 # Indicate when program is started
my $ARROW           :shared;                                                   # Arrow pointer
my $HOURGLASS       :shared;                                                   # Hourglass pointer
my $THR;                                                                       # Thread
my $THR_UPDATE;                                                                # Thread for update
my $LISTNO          = 0;                                                       # For CTRL+A
my $NBR_CHARS       = 0;                                                       # Number of CHAR in search DB
my $ADD_FILTER      = 0;                                                       # Indicate that filter must be added to current value
my $ANALYSIS_QUEUE;                                                            # Queue for Whois Database Analysis
my $NBR_DELETED_ISP :shared = 0;                                               # Number of deleted ISP in Whois Database Analysis
my $TLDDB;                                                                     # TLD Database

#------------------------------------------------------------------------------#
# Graphic elements
#------------------------------------------------------------------------------#
my ($winICO, $logoBmp, $logo128Bmp, $browseBmp, $openDirBmp, $fileOpenBmp, $fileNewBmp,
    $downloadBmp, $clipboardBmp, $whoisBmp, $databaseBmp, $config32Bmp, $config128Bmp,
    $helpBmp, $aboutBmp, $exportBmp, $importBmp, $extractBmp, $validdbBmp, $searchDB,
    $searchDB_p, $searchDB_n, $filterDB, $filterDB_p, $filterDB_n, $database16,
    $checkBmp, $errorBmp) = &loadGraph();

#------------------------------------------------------------------------------#
# Strings
#------------------------------------------------------------------------------#
&loadDefaultStr(\%STR); # Load default language (en)
if (-e $LANG_FILE and -T $LANG_FILE) { &loadStr(\%STR, $LANG_FILE); } # If language file, load translated strings

#------------------------------------------------------------------------------#
# Main window
#------------------------------------------------------------------------------#
my $screen    = Win32::GUI::GetDesktopWindow(); # Screen resolution
my $scrnX     = Win32::GUI::Width($screen);
my $scrnY     = Win32::GUI::Height($screen);
my $winWidth  = 503;
my $winHeight = 347;
my $winPosX   = ($scrnX - $winWidth)  / 2;
my $winPosY   = ($scrnY - $winHeight) / 2;
# Keyboard shorcut
my $accel = new Win32::GUI::AcceleratorTable("Ctrl-A" => "selectAll");
# Main Window
my $win = Win32::GUI::Window->new( -name        => 'winMain'                           ,
                                   -text        => 'XL-Whois'                          ,
                                   -background  => [255, 255, 255]                     ,
                                   -size        => [$winWidth, $winHeight]             ,
                                   -pos         => [$winPosX , $winPosY]               ,
                                   -resizable   => 0                                   ,
                                   -hasmaximize => 0                                   , 
                                   -accel       => $accel                              , );
$win->SetIcon($winICO);
# Fonts
sub LOGPIXELSX() {88}
sub getDPI       { return(Win32::GUI::DC->new()->GetDeviceCaps(LOGPIXELSX)); }
my $DPI = &getDPI();
my $fontGB;
my $font10;
my $font10b;
my $font10u;
my $font12;
# Larger size (125% and 150%)
if ($DPI >= 120) {
  $fontGB = new Win32::GUI::Font( -name => 'Arial', -size => 10, -bold => 1, -underline => 1);
  $font10  = new Win32::GUI::Font(-name => 'Arial', -size =>  8);
  $font10b = new Win32::GUI::Font(-name => 'Arial', -size =>  8, -bold => 1);
  $font10u = new Win32::GUI::Font(-name => 'Arial', -size =>  8, -bold => 1, -underline => 1);
  $font12  = new Win32::GUI::Font(-name => 'Arial', -size =>  9);
# Normal size
} else {
  $fontGB = new Win32::GUI::Font( -name => 'Arial', -size => 12, -bold => 1, -underline => 1);
  $font10  = new Win32::GUI::Font(-name => 'Arial', -size => 10);
  $font10b = new Win32::GUI::Font(-name => 'Arial', -size => 10, -bold => 1);
  $font10u = new Win32::GUI::Font(-name => 'Arial', -size => 10, -bold => 1, -underline => 1);
  $font12  = new Win32::GUI::Font(-name => 'Arial', -size => 11);  
}
# Load Pointers
my $loadImage = new Win32::API('user32', 'LoadImage', ['N','N','I','I','I','I'],'N');
$HOURGLASS    = $loadImage->Call(0, 32514, 2, 0, 0, 0x8040);
$ARROW        = $loadImage->Call(0, 32512, 2, 0, 0, 0x8040);
# Taskbar
$win->AddNotifyIcon(  -name        => "Tray"                  , 
                      -icon        => $winICO                 ,
                      -tip         => 'XL-Whois'              ,
                      -balloon     => 1                       , );
# Title
$win->AddLabel(       -name        => 'lblLogo'               ,
                      -size        => [499, 70]               ,
                      -pos         => [  0,  0]               ,
                      -bitmap      => $logoBmp                ,
                      -background  => [255, 255, 255]         , );  # Text color in image: #54a0eeff

$win->AddButton(      -name        => 'btnItemClip'           ,
                      -size        => [ 40, 40]               ,
                      -pos         => [  5, 75]               ,
                      -bitmap      => $clipboardBmp           ,
                      -tip         => $STR{'btnItemClip'}     , );
$win->AddLabel(       -name        => 'lblInput'              ,
                      -size        => [350, 22]               ,
                      -pos         => [ 55, 85]               ,
                      -background  => [255, 255, 255]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'lblInput'}        ,
                      -font        => $font12                 , );
$win->AddLabel(       -name        => 'lblOptions'            ,
                      -size        => [115, 22]               ,
                      -pos         => [  5,125]               ,
                      -background  => [255, 255, 255]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'Options'}.':'     ,
                      -font        => $fontGB                 , );
$win->AddCheckbox(    -name        => 'chDomain'              ,
                      -size        => [120, 20]               ,
                      -pos         => [130,125]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => 'Domain whois'          ,
                      -font        => $font10                 , );
$win->AddCheckbox(    -name        => 'chNetwork'             ,
                      -size        => [120, 20]               ,
                      -pos         => [255,125]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => 'Network whois'         ,
                      -font        => $font10                 , );
$win->AddCheckbox(    -name        => 'chDNS'                 ,
                      -size        => [110, 20]               ,
                      -pos         => [380,125]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => 'DNS Records'           ,
                      -font        => $font10                 , );
$win->AddLabel(       -name        => 'lblWSSelect'           ,
                      -size        => [115, 22]               ,
                      -pos         => [  5,157]               ,
                      -background  => [255, 255, 255]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'WSSelect'}.':'    ,
                      -font        => $fontGB                 , );
$win->AddCombobox(    -name        => 'cbWSSelect'            ,
                      -dropdownlist => 1                      ,
                      -vscroll     => 1                       ,
                      -size        => [130, 80]               ,
                      -pos         => [130,155]               ,
                      -font        => $font10                 , );
$win->cbWSSelect->Add($STR{'WSSelect1'}, 'ARIN', 'LACNIC', 'RIPE', 'AFRINIC', 'APNIC');
$win->cbWSSelect->SetCurSel(0);
$win->AddLabel(       -name        => 'lblCheckDB'            ,
                      -size        => [115, 22]               ,
                      -pos         => [  5,192]               ,
                      -background  => [255, 255, 255]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'lblCheckDB'}      ,
                      -font        => $fontGB                 , );
$win->AddCombobox(    -name        => 'cbCheckWhoisDB'        ,
                      -dropdownlist => 1                       ,
                      -vscroll     => 1                       ,
                      -size        => [130, 80]               ,
                      -pos         => [130,190]               ,
                      -font        => $font10                 , );
$win->cbCheckWhoisDB->Add($STR{'cbCheckWhoisDB1'}, $STR{'cbCheckWhoisDB2'}, $STR{'cbCheckWhoisDB3'}, $STR{'cbCheckWhoisDB4'});
$win->AddCheckbox(    -name        => 'chCheckLogging'        ,
                      -size        => [210, 20]               ,
                      -pos         => [275,191]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => $STR{'chCheckLogging'}  ,
                      -font        => $font10                 , );
$win->AddLabel(       -name        => 'lblAddComment'         ,
                      -size        => [115, 22]               ,
                      -pos         => [  5,225]               ,
                      -background  => [255, 255, 255]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'lblAddComment'}.':',
                      -font        => $fontGB                 , );
$win->AddTextfield(   -name        => 'tfComment'             ,
                      -size        => [300, 22]               ,
                      -pos         => [130,225]               ,
                      -disabled    => 1                       , );
# Buttons
$win->AddLabel(       -name        => 'lblFooter'             ,
                      -size        => [494, 80]               ,
                      -pos         => [  2,265]               ,
                      -valign      => 'top'                   ,
                      -background  => [250, 250, 250]         ,
                      -foreground  => [128, 128, 128]         , );
$win->AddLabel(       -name        => 'lblNotReady'           ,
                      -size        => [170, 22]               ,
                      -pos         => [ 10,275]               ,
                      -background  => [250, 250, 250]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'lblNotReady'}     ,
                      -font        => $font10u                ,
                      -notify      => 1                       , );
$win->AddButton(      -name        => 'btnWhois'              ,
                      -size        => [ 40, 40]               ,
                      -pos         => [270,273]               ,
                      -bitmap      => $whoisBmp               ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'btnWhoisTip'}     ,
                      -disabled    => 1                       ,
                      -ok          => 1                       ,
                      -default     => 1                       , );
$win->AddButton(      -name        => 'btnWinDatabase'        ,
                      -size        => [ 40, 40]               ,
                      -pos         => [315,273]               ,
                      -bitmap      => $databaseBmp            ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'btnWinDatabaseTip'}, );
$win->AddButton(      -name        => 'btnWinConfig'          ,
                      -size        => [ 40, 40]               ,
                      -pos         => [360,273]               ,
                      -bitmap      => $config32Bmp            ,
                      -background  => [250, 250, 250]         ,
                      -tip         => 'Configuration'         , );
$win->AddButton(      -name        => 'btnHelp'               ,
                      -size        => [ 40, 40]               ,
                      -pos         => [405,273]               ,
                      -bitmap      => $helpBmp                ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'btnHelpTip'}      , );
$win->AddButton(      -name        => 'btnAbout'              ,
                      -size        => [ 40, 40]               ,
                      -pos         => [450,273]               ,
                      -bitmap      => $aboutBmp               ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'btnAboutTip'}     , );
# Load taskbar menu
my $trayMenu = Win32::GUI::Menu->new(
 	"SysTray"                   => "SysTray",
  ">$STR{'menu2'}"            => { -name => 'whois'       , -onClick => \&btnWhois_Click         },
  ">$STR{'btnItemClip'}..."   => { -name => 'clipboard'   , -onClick => \&btnItemClip_Click      },
  " > -"                      => 0,
  ">Domain whois"             => { -name => 'domainWhois' , -onClick => \&DWTrayMenu_Click       },
  ">Network whois"            => { -name => 'networkWhois', -onClick => \&NWTrayMenu_Click       },
  ">DNS Records"              => { -name => 'dnsRecords'  , -onClick => \&DRTrayMenu_Click       },
  " > -"                      => 0,
  ">$STR{'menu1'}..."         => { -name => 'showWin'     , -onClick => \&Tray_DblClick          },
  ">$STR{'menu3'}"            => { -name => 'whoisdb'     , -onClick => \&btnWinDatabase_Click   },
  ">$STR{'menu4'}"            => { -name => 'loggingdb'   , -onClick => \&btnLogDbView_Click     },
  " > -"                      => 0,
  ">$STR{'config'}..."        => { -name => "Config"      , -onClick => \&btnWinConfig_Click     },
  ">$STR{'checkUpdate'}"      => { -name => 'Update'      , -onClick => \&btnCheckUpdate_Click   },
  " > -"                      => 0,
  ">$STR{'menu5'}"            => { -name => 'Help'        , -onClick => \&btnHelp_Click          },
  ">$STR{'about'}..."         => { -name => 'About'       , -onClick => \&btnAbout_Click         },
  ">$STR{'menu6'}"            => { -name => 'Quit'        , -onClick => \&winMain_Terminate      },
);

#------------------------------------------------------------------------------#
# Clipboard Window
#------------------------------------------------------------------------------#
my $winClip = Win32::GUI::Window->new( -name        => 'winClip'             ,
                                       -background  => [255, 255, 255]       ,
                                       #-parent      => $win                  ,
                                       -text        => $STR{'winClip'}       ,
                                       -pos         => [$winPosX, $winPosY]  ,
                                       -size        => [$winWidth,$winHeight],
                                       -minsize     => [$winWidth,$winHeight],
                                       -hasmaximize => 1                     ,
                                       -hasminimize => 1                     ,
                                       -resizable   => 1                     ,
                                       -dialogui    => 1                     ,
                                       -accel       => $accel                , );
$winClip->SetIcon($winICO);
$winClip->AddTextfield( -name        => 'tfClip'            ,
                        -size        => [$winWidth-25, $winHeight-85] ,
                        -pos         => [  5,  5]           ,
                        -background  => [255, 255, 255]     ,
                        -multiline   => 1                   ,
                        -wantreturn  => 1                   ,
                        -hscroll     => 1                   ,
                        -vscroll     => 1                   , );
$winClip->AddButton(    -name        => 'btnClipOk'         ,
                        -text        => $STR{'btnClipOk'}   ,
                        -size        => [ 80, 30]           ,
                        -pos         => [($winWidth-280)/2,$winHeight-73] ,
                        -ok          => 1                   ,
                        -default     => 1                   , );
$winClip->AddButton(    -name        => 'btnClipEdit'       ,
                        -text        => $STR{'btnClipEdit'} ,
                        -size        => [ 80, 30]           ,
                        -pos         => [($winWidth-280)/2+100,$winHeight-73] ,
                        -disabled    => 1                   , );
$winClip->AddButton(    -name        => 'btnClipParse'      ,
                        -text        => $STR{'btnClipParse'},
                        -size        => [ 80, 30]           ,
                        -pos         => [($winWidth-280)/2+200,$winHeight-73] , );

#------------------------------------------------------------------------------#
# Config window
#------------------------------------------------------------------------------#
my $winConfig = Win32::GUI::DialogBox->new( -name        => 'winConfig'             ,
                                            -parent      => $win                    ,
                                            -text        => $STR{'config'}          ,
                                            -pos         => [$winPosX, $winPosY]    ,
                                            -size        => [650, 340]              ,
                                            -background  => [255, 255, 255]         ,
                                            -hasmaximize => 0                       ,
                                            -hasminimize => 0                       ,
                                            -helpbutton  => 0                       ,
                                            -resizable   => 0                       ,
                                            -dialogui    => 1                       , );
$winConfig->SetIcon($winICO);
$winConfig->AddLabel(     -name         => 'lblLogo'             ,
                          -size         => [128,128]             ,
                          -pos          => [  0,  5]             ,
                          -bitmap       => $config128Bmp         ,
                          -background   => [255, 255, 255]       , );
# Tabstrip
$winConfig->AddTabStrip(            -name         => 'configTab'           ,
                                    -size         => [505,305]             ,
                                    -pos          => [140,  5]             ,
                                    -fixedwidth   => 1                     ,
                                    -background   => [255, 255, 255]       , );
$winConfig->configTab->InsertItem(  -text         => $STR{'general'}       , );
$winConfig->configTab->InsertItem(  -text         => $STR{'storage'}       , );
$winConfig->configTab->InsertItem(  -text         => $STR{'database'}      , );
$winConfig->configTab->SetItemSize(167,20);
# General tab - Tool Section
$winConfig->AddLabel(     -name        => 'lblToolShadowT'        ,
                          -size        => [ 80, 22]               ,
                          -pos         => [151, 36]               ,
                          -foreground  => [180, 180, 180]         ,
                          -background  => [255, 255, 255]         ,
                          -text        => $STR{'tool'}.':'        ,
                          -font        => $fontGB                 , );
$winConfig->AddLabel(     -name        => 'lblToolT'              ,
                          -size        => [ 80, 22]               ,
                          -pos         => [150, 35]               ,
                          -addstyle    => 11                      , # Transparent
                          -foreground  => [  90, 150, 255]        ,
                          -text        => $STR{'tool'}.':'        ,
                          -font        => $fontGB                 , );
$winConfig->AddButton(    -name        => 'btnExportLang'         ,
                          -size        => [125, 24]               ,
                          -pos         => [150, 68]               ,
                          -text        => $STR{'export'}.' Lang.ini',
                          -font        => $font10                 , );
$winConfig->AddButton(    -name        => 'btnCheckUpdate'        ,
                          -size        => [125, 24]               ,
                          -pos         => [150, 98]               ,
                          -text        => $STR{'checkUpdate'}     ,
                          -font        => $font10                 , );
$winConfig->AddCheckbox(  -name        => 'chAutoUpdate'          ,
                          -size        => [200, 20]               ,
                          -pos         => [285,100]               ,
                          -text        => $STR{'chAutoUpdate'}    ,
                          -background  => [255, 255, 255]         ,
                          -font        => $font10                 ,
                          -checked     => 1                       , );
# General tab - Whois section
$winConfig->AddLabel(     -name        => 'lblGeneralShadowT'     ,
                          -size        => [115, 22]               ,
                          -pos         => [151,136]               ,
                          -foreground  => [180, 180, 180]         ,
                          -background  => [255, 255, 255]         ,
                          -text        => $STR{'general'}.':'     ,
                          -font        => $fontGB                 , );
$winConfig->AddLabel(     -name        => 'lblGeneralT'           ,
                          -size        => [115, 22]               ,
                          -pos         => [150,135]               ,
                          -addstyle    => 11                      , # Transparent
                          -foreground  => [  90, 150, 255]        ,
                          -text        => $STR{'general'}.':'     ,
                          -font        => $fontGB                 , );
$winConfig->AddCheckbox(  -name        => 'chStartMinimized'      ,
                          -size        => [220, 20]               ,
                          -pos         => [270,136]               ,
                          -text        => $STR{'chStartMinimized'},
                          -background  => [255, 255, 255]         ,
                          -font        => $font10                 ,
                          -checked     => 1                       , );
$winConfig->AddLabel(     -name        => 'lblNsLookupTO1'        ,
                          -size        => [115, 22]               ,
                          -pos         => [150,167]               ,
                          -background  => [255, 255, 255]         ,
                          -text        => $STR{'lblNsLookupTO1'}.':',
                          -font        => $font10                 , );
$winConfig->AddTextfield( -name        => 'tfLookupTO'            ,
                          -size        => [ 30, 22]               ,
                          -pos         => [270,165]               , );
$winConfig->AddLabel(     -name        => 'lblNsLookupTO2'        ,
                          -size        => [ 70, 22]               ,
                          -pos         => [305,167]               ,
                          -background  => [255, 255, 255]         ,
                          -text        => $STR{'lblNsLookupTO2'}  ,
                          -font        => $font10                 , );
$winConfig->AddLabel(     -name        => 'lblUserAgent'          ,
                          -size        => [115, 22]               ,
                          -pos         => [150,197]               ,
                          -background  => [255, 255, 255]         ,
                          -text        => $STR{'UserAgent'}.':'   ,
                          -font        => $font10                 , );
$winConfig->AddTextfield( -name        => 'tfUserAgent'           ,
                          -size        => [350, 22]               ,
                          -pos         => [270,195]               , );
# General tab - Parser section
$winConfig->AddLabel(     -name        => 'lblParserShadowT'      ,
                          -size        => [ 80, 22]               ,
                          -pos         => [151,231]               ,
                          -foreground  => [180, 180, 180]         ,
                          -background  => [255, 255, 255]         ,
                          -text        => $STR{'lblParser'}.':'   ,
                          -font        => $fontGB                 , );
$winConfig->AddLabel(     -name        => 'lblParserT'            ,
                          -size        => [ 80, 22]               ,
                          -pos         => [150,230]               ,
                          -addstyle    => 11                      , # Transparent
                          -foreground  => [  90, 150, 255]        ,
                          -text        => $STR{'lblParser'}.':'   ,
                          -font        => $fontGB                 , );
$winConfig->AddCheckbox(  -name        => 'chIPv4'                ,
                          -size        => [ 40, 20]               ,
                          -pos         => [150,260]               ,
                          -background  => [255, 255, 255]         ,
                          -text        => 'IPv4'                  ,
                          -font        => $font10                 , );
$winConfig->AddCheckbox(  -name        => 'chIPv6'                ,
                          -size        => [ 40, 20]               ,
                          -pos         => [215,260]               ,
                          -background  => [255, 255, 255]         ,
                          -text        => 'IPv6'                  ,
                          -font        => $font10                 , );
$winConfig->AddCheckbox(  -name        => 'chHostname'            ,
                          -size        => [ 80, 20]               ,
                          -pos         => [280,260]               ,
                          -background  => [255, 255, 255]         ,
                          -text        => 'Hostname'              ,
                          -font        => $font10                 , );
$winConfig->AddCheckbox(  -name        => 'chDomainName'          ,
                          -size        => [100, 20]               ,
                          -pos         => [380,260]               ,
                          -background  => [255, 255, 255]         ,
                          -text        => 'Domain Name'           ,
                          -font        => $font10                 , );
# Storage tab - Report section
$winConfig->AddLabel(       -name        => 'lblReportShadowT'      ,
                            -size        => [260, 22]               ,
                            -pos         => [151, 36]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'lblReport'}.':'   ,
                            -font        => $fontGB                , 
                            -visible     => 0                       , );
$winConfig->AddLabel(       -name        => 'lblReportT'            ,
                            -size        => [260, 22]               ,
                            -pos         => [150, 35]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [  90, 150, 255]        ,
                            -text        => $STR{'lblReport'}.':'   ,
                            -font        => $fontGB                ,
                            -visible     => 0                       ,  );
$winConfig->AddCheckbox(    -name        => 'chAutoViewing'         ,
                            -size        => [175, 20]               ,
                            -pos         => [415, 38]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chAutoViewing'}   ,
                            -font        => $font10                 ,
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfMaxView'             ,
                            -size        => [ 30, 22]               ,
                            -pos         => [595, 38]               ,
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfReportDir'           ,
                            -size        => [412, 22]               ,
                            -pos         => [150, 68]               ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnReportDir'          ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565, 68]               ,
                            -bitmap      => $browseBmp              ,
                            -tip         => $STR{'btnReportDirTip'} ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnOpenDir'            ,
                            -size        => [ 22, 22]               ,
                            -pos         => [588, 68]               ,
                            -bitmap      => $openDirBmp             ,
                            -tip         => $STR{'btnOpenDirTip'}   ,
                            -visible     => 0                       , );
$winConfig->AddCheckbox(    -name        => 'chReplace'             ,
                            -size        => [200, 20]               ,
                            -pos         => [150, 98]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chReplace'}       ,
                            -font        => $font10                 ,
                            -visible     => 0                       , );
$winConfig->AddCheckbox(    -name        => 'chAutoViewDir'         ,
                            -size        => [175, 20]               ,
                            -pos         => [415, 98]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chAutoViewDir'}   ,
                            -font        => $font10                 ,
                            -visible     => 0                       , );
# Storage tab - Logging Database section
$winConfig->AddLabel(       -name        => 'lblLogDbFileShadowT'   ,
                            -size        => [260, 22]               ,
                            -pos         => [151,134]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'lblLogDbFile'}.':',
                            -font        => $fontGB                 , 
                            -visible     => 0                       , );
$winConfig->AddLabel(       -name        => 'lblLogDbFileT'         ,
                            -size        => [260, 22]               ,
                            -pos         => [150,133]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [  90, 150, 255]        ,
                            -text        => $STR{'lblLogDbFile'}.':',
                            -font        => $fontGB                 ,
                            -visible     => 0                       ,  );
$winConfig->AddCheckbox(    -name        => 'chLogActivate'         ,
                            -size        => [220, 20]               ,
                            -pos         => [415,133]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chLogActivate'}   ,
                            -font        => $font10                 ,
                            -visible     => 0                       ,
                            -disabled    => 1                       , );
$winConfig->AddTextfield(   -name        => 'tfLogDbFile'           ,
                            -size        => [412, 22]               ,
                            -pos         => [150,163]               ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnLogDbFile'          ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565,163]               ,
                            -bitmap      => $fileOpenBmp            ,
                            -tip         => $STR{'btnLogDbFileTip'} ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnLogDbFileNew'       ,
                            -size        => [ 22, 22]               ,
                            -pos         => [588,163]               ,
                            -bitmap      => $fileNewBmp             ,
                            -tip         => $STR{'btnLogDbFileNewTip'},
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnLogDbView'          ,
                            -size        => [ 22, 22]               ,
                            -pos         => [611,163]               ,
                            -bitmap      => $database16             ,
                            -tip         => $STR{'btnLogDbViewTip'} ,
                            -visible     => 0                       , );
# Storage tab - Whois Database Section
$winConfig->AddLabel(       -name        => 'lblDbFileShadowT'      ,
                            -size        => [260, 22]               ,
                            -pos         => [151,204]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'lblDbFile'}.':'   ,
                            -font        => $fontGB                 , 
                            -visible     => 0                       , );
$winConfig->AddLabel(       -name        => 'lblDbFileT'            ,
                            -size        => [260, 22]               ,
                            -pos         => [150,203]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [  90, 150, 255]        ,
                            -text        => $STR{'lblDbFile'}.':'   ,
                            -font        => $fontGB                 ,
                            -visible     => 0                       ,  );
$winConfig->AddCheckbox(    -name        => 'chDBCache'             ,
                            -size        => [220, 20]               ,
                            -pos         => [415,203]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chDBCache'}       ,
                            -font        => $font10                 ,
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfDbFile'              ,
                            -size        => [412, 22]               ,
                            -pos         => [150,233]               ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnDbFile'             ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565,233]               ,
                            -bitmap      => $fileOpenBmp            ,
                            -tip         => $STR{'btnDbFileTip'}    ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnDbFileNew'          ,
                            -size        => [ 22, 22]               ,
                            -pos         => [588,233]               ,
                            -bitmap      => $fileNewBmp             ,
                            -tip         => $STR{'btnDbFileNewTip'} ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnWhoisDbView'        ,
                            -size        => [ 22, 22]               ,
                            -pos         => [611,233]               ,
                            -bitmap      => $database16             ,
                            -tip         => $STR{'btnWhoisDbViewTip'} ,
                            -visible     => 0                       , );
# Database tab - TLD Database section
$winConfig->AddLabel(       -name        => 'lblTLDDBShadowT'       ,
                            -size        => [260, 22]               ,
                            -pos         => [151, 36]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'lblTLDDB'}.':'    ,
                            -font        => $fontGB                 , 
                            -visible     => 0                       , );
$winConfig->AddLabel(       -name        => 'lblTLDDBT'             ,
                            -size        => [260, 22]               ,
                            -pos         => [150, 35]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [  90, 150, 255]        ,
                            -text        => $STR{'lblTLDDB'}.':'    ,
                            -font        => $fontGB                 ,
                            -visible     => 0                       ,  );
$winConfig->AddCheckbox(    -name        => 'chTLDDBAutoUpt'        ,
                            -size        => [220, 20]               ,
                            -pos         => [415, 38]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chDBAutoUpt'}     ,
                            -font        => $font10                 ,
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfTLDDB'               ,
                            -size        => [412, 22]               ,
                            -pos         => [150, 68]               ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnTLDDB'              ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565, 68]               ,
                            -bitmap      => $fileOpenBmp            ,
                            -tip         => $STR{'btnTLDDBTip'}     ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnTLDDBUpt'           ,
                            -size        => [ 22, 22]               ,
                            -pos         => [588, 68]               ,
                            -bitmap      => $downloadBmp            ,
                            -tip         => $STR{'btnTLDDBUptTip'}  ,
                            -visible     => 0                       , );
# Database tab - Whois Server Database section
$winConfig->AddLabel(       -name        => 'lblWSDBShadowT'        ,
                            -size        => [260, 22]               ,
                            -pos         => [151,104]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'lblWSDB'}.':'     ,
                            -font        => $fontGB                 , 
                            -visible     => 0                       , );
$winConfig->AddLabel(       -name        => 'lblWSDBT'              ,
                            -size        => [260, 22]               ,
                            -pos         => [150,103]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [  90, 150, 255]        ,
                            -text        => $STR{'lblWSDB'}.':'     ,
                            -font        => $fontGB                 ,
                            -visible     => 0                       ,  );
$winConfig->AddCheckbox(    -name        => 'chWSDBAutoUpt'         ,
                            -size        => [220, 20]               ,
                            -pos         => [415,103]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chDBAutoUpt'}     ,
                            -font        => $font10                 ,
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfWSDB'                ,
                            -size        => [412, 22]               ,
                            -pos         => [150,133]               ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnWSDB'               ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565,133]               ,
                            -bitmap      => $fileOpenBmp            ,
                            -tip         => $STR{'btnWSDBTip'}      ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnWSDBUpt'            ,
                            -size        => [ 22, 22]               ,
                            -pos         => [588,133]               ,
                            -bitmap      => $downloadBmp            ,
                            -tip         => $STR{'btnWSDBUptTip'}   ,
                            -visible     => 0                       , );
# Database tab - IPv4 Database section
$winConfig->AddLabel(       -name        => 'lblIPv4ShadowT'        ,
                            -size        => [260, 22]               ,
                            -pos         => [151,169]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'lblIPv4DB'}.':'   ,
                            -font        => $fontGB                 , 
                            -visible     => 0                       , );
$winConfig->AddLabel(       -name        => 'lblIPv4T'              ,
                            -size        => [260, 22]               ,
                            -pos         => [150,168]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [  90, 150, 255]        ,
                            -text        => $STR{'lblIPv4DB'}.':'   ,
                            -font        => $fontGB                 ,
                            -visible     => 0                       ,  );
$winConfig->AddCheckbox(    -name        => 'chIPv4DBAutoUpt'       ,
                            -size        => [220, 20]               ,
                            -pos         => [415,168]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chDBAutoUpt'}     ,
                            -font        => $font10                 ,
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfIPv4DB'              ,
                            -size        => [412, 22]               ,
                            -pos         => [150,198]               ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnIPv4DB'             ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565,198]               ,
                            -bitmap      => $fileOpenBmp            ,
                            -tip         => $STR{'btnIPv4DBTip'}    ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnIPv4DBUpt'          ,
                            -size        => [ 22, 22]               ,
                            -pos         => [588,198]               ,
                            -bitmap      => $downloadBmp            ,
                            -tip         => $STR{'btnIPv4DBUptTip'} ,
                            -visible     => 0                       , );
# Database tab - IPv6 Database section
$winConfig->AddLabel(       -name        => 'lblIPv6ShadowT'        ,
                            -size        => [260, 22]               ,
                            -pos         => [151,234]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'lblIPv6DB'}.':'   ,
                            -font        => $fontGB                 , 
                            -visible     => 0                       , );
$winConfig->AddLabel(       -name        => 'lblIPv6T'              ,
                            -size        => [260, 22]               ,
                            -pos         => [150,233]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [  90, 150, 255]        ,
                            -text        => $STR{'lblIPv6DB'}.':'   ,
                            -font        => $fontGB                 ,
                            -visible     => 0                       ,  );
$winConfig->AddCheckbox(    -name        => 'chIPv6DBAutoUpt'       ,
                            -size        => [220, 20]               ,
                            -pos         => [415,233]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chDBAutoUpt'}     ,
                            -font        => $font10                 ,
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfIPv6DB'              ,
                            -size        => [412, 22]               ,
                            -pos         => [150,263]               ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnIPv6DB'             ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565,263]               ,
                            -bitmap      => $fileOpenBmp            ,
                            -tip         => $STR{'btnIPv6DBTip'}    ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnIPv6DBUpt'          ,
                            -size        => [ 22, 22]               ,
                            -pos         => [588,263]               ,
                            -bitmap      => $downloadBmp            ,
                            -tip         => $STR{'btnIPv6DBUptTip'} ,
                            -visible     => 0                       , );

#------------------------------------------------------------------------------#
# Whois Database Window
#------------------------------------------------------------------------------#
my $winDBw = 750;
my $winDBh = 500;
my $winDB = Win32::GUI::Window->new(  -name        => 'winDB'               ,
                                      -background  => [255, 255, 255]       ,
                                      -parent      => $winConfig            ,
                                      -text        => $STR{'winDB'}         ,
                                      -pos         => [$winPosX, $winPosY]  ,
                                      -size        => [$winDBw+150, $winDBh],
                                      -minsize     => [$winDBw, $winDBh]    ,
                                      -hasmaximize => 1                     ,
                                      -hasminimize => 1                     ,
                                      -resizable   => 1                     , );
$winDB->SetIcon($winICO);
# Functions
$winDB->AddButton(    -name        => 'btnExportDB'           ,
                      -size        => [ 40, 40]               ,
                      -pos         => [  5,  8]               ,
                      -bitmap      => $exportBmp              ,
                      -background  => [255, 255, 255]         ,
                      -tip         => $STR{'btnExportDBTip'}  , );
$winDB->AddButton(    -name        => 'btnImportDB'           ,
                      -size        => [ 40, 40]               ,
                      -pos         => [ 50,  8]               ,
                      -bitmap      => $importBmp              ,
                      -background  => [255, 255, 255]         ,
                      -tip         => $STR{'btnImportDBTip'}  , );
$winDB->AddButton(    -name        => 'btnExtract2DB'         ,
                      -size        => [ 40, 40]               ,
                      -pos         => [ 95,  8]               ,
                      -bitmap      => $extractBmp             ,
                      -background  => [255, 255, 255]         ,
                      -tip         => $STR{'btnExtract2DBTip'}, );
$winDB->AddButton(    -name        => 'btnValidDB'            ,
                      -size        => [ 40, 40]               ,
                      -pos         => [140,  8]               ,
                      -bitmap      => $validdbBmp             ,
                      -background  => [255, 255, 255]         ,
                      -tip         => $STR{'btnValidDBTip'}   , );
# Search
$winDB->AddLabel(     -name        => 'lblSearchDB'           ,
                      -size        => [ 60, 22]               ,
                      -pos         => [190,  8]               ,
                      -background  => [255, 255, 255]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'lblSearchDB'}.':' ,
                      -font        => $font10                 , );
$winDB->AddTextfield( -name        => 'tfSearchDB'            ,
                      -size        => [$winDBw-350, 22]       ,
                      -pos         => [255,  5]               , );
$winDB->AddButton(    -name        => 'btnSearchDB'           ,
                      -size        => [ 22, 22]               ,
                      -pos         => [$winDBw-92,  5]        ,
                      -bitmap      => $searchDB               ,
                      -tip         => $STR{'btnSearchDBTip'}  ,
                      -disabled    => 1                       , );
$winDB->AddButton(    -name        => 'btnSearchDB_p'         ,
                      -size        => [ 22, 22]               ,
                      -pos         => [$winDBw-67,  5]        ,
                      -bitmap      => $searchDB_p             ,
                      -tip         => $STR{'btnSearchDB_pTip'},
                      -disabled    => 1                       , );
$winDB->AddButton(    -name        => 'btnSearchDB_n'         ,
                      -size        => [ 22, 22]               ,
                      -pos         => [$winDBw-42,  5]        ,
                      -bitmap      => $searchDB_n             ,
                      -tip         => $STR{'btnSearchDB_nTip'},
                      -disabled    => 1                       , );
# Filter
$winDB->AddLabel(     -name        => 'lblFilterDB'           ,
                      -size        => [ 60, 22]               ,
                      -pos         => [190, 33]               ,
                      -background  => [255, 255, 255]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'lblFilterDB'}.':' ,
                      -font        => $font10                 , );
$winDB->AddTextfield( -name        => 'tfFilterDB'            ,
                      -size        => [$winDBw-350, 22]       ,
                      -pos         => [255, 30]               ,
                      -readonly    => 1                       , );
$winDB->AddButton(    -name        => 'btnFilterDB'           ,
                      -size        => [ 22, 22]               ,
                      -pos         => [$winDBw-92, 30]        ,
                      -bitmap      => $filterDB               ,
                      -tip         => $STR{'btnFilterDBTip'}  , );
$winDB->AddButton(    -name        => 'btnFilterDB_del'       ,
                      -size        => [ 22, 22]               ,
                      -pos         => [$winDBw-67, 30]        ,
                      -bitmap      => $filterDB_p             ,
                      -tip         => $STR{'btnFilterDB_delTip'},
                      -disabled    => 1                       , );
$winDB->AddButton(    -name        => 'btnFilterDB_add'       ,
                      -size        => [ 22, 22]               ,
                      -pos         => [$winDBw-42, 30]        ,
                      -bitmap      => $filterDB_n             ,
                      -tip         => $STR{'btnFilterDB_addTip'},
                      -disabled    => 1                       , );
# Grid
$winDB->AddGrid(      -name         => 'DBGrid'               ,
                      -size         => [$winDBw-14, $winDBh-116]  ,
                      -pos          => [  0, 60]              ,
                      -background   => [255, 255, 255]        ,
                      -columns      => 5                      ,
                      -fixedrows    => 1                      ,
                      -fixedcolumns => 0                      ,
                      -editable     => 1                      , );
$winDB->DBGrid->EnableRowHide();
# Status bar
$winDB->AddStatusBar( -name         => 'statusBar'            , );
# Popup menu for grid
my $GridPopupMenu = new Win32::GUI::Menu(
  "GridMenu"                => "GridMenu"      ,
  "> $STR{'getAllRanges'}"  => "getAllRanges"  ,
  " > -"                    => 0               ,
  "> $STR{'gridSelectAll'}" => "gridSelectAll" ,
  "> $STR{'lineCopy'}"      => "lineCopy"      ,
  " > -"                    => 0               ,
  "> $STR{'deleteLine'}"    => "deleteLine"    ,
);

#------------------------------------------------------------------------------#
# Add ISP Ranges Window
#------------------------------------------------------------------------------#
my $winAddRanges = Win32::GUI::Window->new( -name        => 'winAddRanges'            ,
                                            -background  => [255, 255, 255]           ,
                                            -parent      => $winDB                    ,
                                            -text        => $STR{'winAddRanges'}      ,
                                            -pos         => [$winPosX, $winPosY]      ,
                                            -size        => [$winDBw, $winDBh]        ,
                                            -minsize     => [$winDBw, $winDBh]        ,
                                            -hasmaximize => 0                         ,
                                            -hasminimize => 0                         ,
                                            -resizable   => 0                         ,
                                            -dialogui    => 1                         , );
$winAddRanges->SetIcon($winICO);
# Matches found section
$winAddRanges->AddLabel(        -name         => 'lblChoice'              ,
                                -size         => [150, 20]                ,
                                -pos          => [  5,  5]                ,
                                -background   => [255, 255, 255]          ,
                                -foreground   => [  0, 102, 204]          ,
                                -text         => $STR{'lblChoice'}        ,
                                -font         => $fontGB                  , );
$winAddRanges->AddGrid (        -name         => 'GridISPRanges'          ,
                                -size         => [$winDBw-15, $winDBh-115],
                                -pos          => [  5, 30]                ,
                                -background   => [255, 255, 255]          ,
                                -columns      => 5                        ,
                                -fixedrows    => 1                        ,
                                -fixedcolumns => 0                        ,
                                -editable     => 0                        , );
$winAddRanges->GridISPRanges->SetListMode();
# Buttons
$winAddRanges->AddButton(       -name         => 'btnAddRCancel'          ,
                                -size         => [100, 30]                ,
                                -pos          => [$winDBw-275,$winDBh-65] ,
                                -text         => $STR{'cancel'}           ,
                                -font         => $font10                  , );
$winAddRanges->AddButton(       -name         => 'btnAddRSelected'        ,
                                -size         => [160, 30]                ,
                                -pos          => [$winDBw-170,$winDBh-65] ,
                                -text         => $STR{'winAddRSelected'}  ,
                                -font         => $font10                  ,
                                -disabled     => 1                        , );

#------------------------------------------------------------------------------#
# Network Whois Data Window
#------------------------------------------------------------------------------#
my $winNWD = Win32::GUI::Window->new(  -name        => 'winNWD'              ,
                                       -background  => [255, 255, 255]       ,
                                       -parent      => $winDB                ,
                                       -text        => $STR{'winNWD'}        ,
                                       -pos         => [$winPosX, $winPosY]  ,
                                       -size        => [$winDBw, $winDBh]    ,
                                       -minsize     => [$winDBw, $winDBh]    ,
                                       -hasmaximize => 1                     ,
                                       -hasminimize => 1                     ,
                                       -resizable   => 1                     ,
                                       -dialogui    => 1                     , );
$winNWD->SetIcon($winICO);
$winNWD->AddTextfield(  -name        => 'tfNWD'             ,
                        -size        => [$winDBw-25, $winDBh-85] ,
                        -pos         => [  5,  5]           ,
                        -background  => [255, 255, 255]     ,
                        -multiline   => 1                   ,
                        -wantreturn  => 1                   ,
                        -hscroll     => 1                   ,
                        -vscroll     => 1                   ,
                        -readonly    => 1                   , );
$winNWD->AddButton(     -name        => 'btnNWDOk'          ,
                        -text        => $STR{'btnClipOk'}   ,
                        -size        => [ 80, 30]           ,
                        -pos         => [($winDBw-180)/2,$winDBh-73] ,
                        -ok          => 1                   ,
                        -default     => 1                   , );

#------------------------------------------------------------------------------#
# Filter window
#------------------------------------------------------------------------------#
my $winFilter  = Win32::GUI::DialogBox->new(-name        => 'winFilter'               ,
                                            -parent      => $winDB                    ,
                                            -text        => $STR{'winFilter'}         ,
                                            -pos         => [$winPosX, $winPosY]      ,
                                            -size        => [260,170]                 ,
                                            -background  => [255, 255, 255]           ,
                                            -hasmaximize => 0                         ,
                                            -hasminimize => 1                         ,
                                            -helpbutton  => 0                         ,
                                            -resizable   => 0                         ,
                                            -dialogui    => 1                         , );
$winFilter->SetIcon($winICO);
# Add filter operator
$winFilter->AddLabel(     -name         => 'lblAddFilterOp'       ,
                          -size         => [120, 22]              ,
                          -pos          => [ 10,  5]              ,
                          -background   => [255, 255, 255]        ,
                          -text         => $STR{'lblAddFilterOp'} ,
                          -font         => $font10                , );
$winFilter->AddCombobox(  -name         => 'cbAddFilterOp'        ,
                          -dropdownlist => 1                      ,
                          -vscroll      => 1                      ,
                          -size         => [105, 30]              ,
                          -pos          => [135,  5]              ,
                          -disabled     => 1                      , );
# Selected field
$winFilter->AddLabel(     -name         => 'lblFilterField'       ,
                          -size         => [120, 22]              ,
                          -pos          => [ 10, 33]              ,
                          -background   => [255, 255, 255]        ,
                          -text         => $STR{'lblFilterField'}.':',
                          -font         => $font10                , );
$winFilter->AddCombobox(  -name         => 'cbFilterField'        ,
                          -dropdownlist => 1                      ,
                          -vscroll      => 1                      ,
                          -size         => [105, 80]              ,
                          -pos          => [135, 30]              , );
$winFilter->cbFilterField->Add('', $STR{'cbFilterField1'}, $STR{'cbFilterField2'},
                               $STR{'cbFilterField3'}, $STR{'cbFilterField4'},
                               $STR{'date'});
$winFilter->cbFilterField->SetCurSel(0);
# Operator
$winFilter->AddLabel(     -name         => 'lblOperator'          ,
                          -size         => [120, 22]              ,
                          -pos          => [ 10, 58]              ,
                          -background   => [255, 255, 255]        ,
                          -text         => $STR{'lblOperator'}    ,
                          -font         => $font10                , );
$winFilter->AddCombobox(  -name         => 'cbOperator'           ,
                          -dropdownlist => 1                      ,
                          -vscroll      => 1                      ,
                          -size         => [105, 80]              ,
                          -pos          => [135, 55]              ,
                          -disabled     => 1                      , );
# Value
$winFilter->AddLabel(     -name         => 'lblFilterValue'       ,
                          -size         => [ 60, 22]              ,
                          -pos          => [ 10, 83]              ,
                          -background   => [255, 255, 255]        ,
                          -text         => $STR{'lblFilterValue'} ,
                          -font         => $font10                , );
$winFilter->AddTextfield( -name         => 'tfFilterValue'        ,
                          -size         => [155, 22]              ,
                          -pos          => [ 85, 80]              ,
                          -visible      => 0                      ,
                          -disabled     => 1                      , );
$winFilter->AddCombobox(  -name         => 'cbFilterValue'        ,
                          -dropdownlist => 1                      ,
                          -vscroll      => 1                      ,
                          -size         => [105, 80]              ,
                          -pos          => [135, 80]              ,
                          -visible      => 1                      ,
                          -disabled     => 1                      , );
# Button
$winFilter->AddButton(    -name         => 'btnApplyFilter'       ,
                          -size         => [100, 25]              ,
                          -pos          => [ 80,110]              ,
                          -text         => $STR{'btnApplyFilter'} ,
                          -font         => $font10                ,
                          -disabled     => 1                      , );

#------------------------------------------------------------------------------#
# Analysis Whois Database Window (AWD)
#------------------------------------------------------------------------------#

my $winAWD = Win32::GUI::Window->new( -name        => 'winAWD'                  ,
                                      -background  => [255, 255, 255]           ,
                                      -parent      => $winDB                    ,
                                      -text        => $STR{'winAWD'}            ,
                                      -pos         => [$winPosX, $winPosY]      ,
                                      -size        => [$winDBw, $winDBh]        ,
                                      -minsize     => [$winDBw, $winDBh]        ,
                                      -hasmaximize => 0                         ,
                                      -hasminimize => 0                         ,
                                      -resizable   => 0                         ,
                                      -dialogui    => 1                         , );
$winAWD->SetIcon($winICO);
# Matches found section
$winAWD->AddLabel(        -name         => 'lblChoice'              ,
                          -size         => [$winDBw-25, $winDBh-122],
                          -pos          => [  5,  5]                ,
                          -background   => [255, 255, 255]          ,
                          -foreground   => [  0, 102, 204]          ,
                          -text         => $STR{'lblChoice'}        ,
                          -font         => $fontGB                  , );
$winAWD->AddLabel(        -name         => 'lblISPWide'             ,
                          -size         => [$winDBw-60, 20]         ,
                          -pos          => [  5, 27]                ,
                          -background   => [255, 255, 255]          ,
                          -font         => $font10                  ,
                          -text         => $STR{'lblISPWide'}       , );
$winAWD->AddGrid (        -name         => 'GridISPWide'            ,
                          -size         => [$winDBw-15, 67]         ,
                          -pos          => [  5, 45]                ,
                          -background   => [255, 255, 255]          ,
                          -columns      => 6                        ,
                          -fixedrows    => 1                        ,
                          -fixedcolumns => 0                        ,
                          -editable     => 0                        , );
$winAWD->GridISPWide->SetListMode();
$winAWD->AddLabel(        -name         => 'lblISPin'               ,
                          -size         => [$winDBw-60, 20]         ,
                          -pos          => [  5,122]                ,
                          -background   => [255, 255, 255]          ,
                          -font         => $font10                  ,
                          -text         => $STR{'lblISPin'}         , );
$winAWD->AddGrid (        -name         => 'GridISPin'              ,
                          -size         => [$winDBw-15,195]         ,
                          -pos          => [  5,140]                ,
                          -background   => [255, 255, 255]          ,
                          -columns      => 6                        ,
                          -fixedrows    => 1                        ,
                          -fixedcolumns => 0                        ,
                          -editable     => 0                        , );
$winAWD->GridISPin->SetListMode();
$winAWD->AddLabel(        -name         => 'lblISPMsg'              ,
                          -size         => [$winDBw-60, 20]         ,
                          -pos          => [  5,345]                ,
                          -background   => [255, 255, 255]          ,
                          -font         => $font10                  ,
                          -text         => $STR{'lblISPMsg'}        , );
# Progress
$winAWD->AddLabel(        -name         => 'lblPbCurr'              ,
                          -size         => [$winDBw-140, 22]        ,
                          -pos          => [  5,370]                ,
                          -background   => [255, 255, 255]          ,
                          -foreground   => [  0, 102, 204]          ,
                          -font         => $font10                  ,
                          -truncate     => 1                        , );
$winAWD->AddProgressBar(  -name         => 'pbWinPb'                ,
                          -size         => [$winDBw-140, 22]        ,
                          -pos          => [  5,395]                ,
                          -background   => [255, 255, 255]          ,
                          -smooth       => 1                        , );
$winAWD->AddLabel(        -name         => 'lblWinPb'               ,
                          -size         => [100, 22]                ,
                          -pos          => [$winDBw-125,397]        ,
                          -background   => [255, 255, 255]          ,
                          -foreground   => [  0, 102, 204]          ,
                          -font         => $font10                  ,
                          -truncate     => 1                        , );
# Buttons
$winAWD->AddButton(       -name         => 'btnAWDCancel'           ,
                          -size         => [100, 30]                ,
                          -pos          => [$winDBw-215,$winDBh-65] ,
                          -text         => $STR{'cancel'}           ,
                          -font         => $font10                  , );
$winAWD->AddButton(       -name         => 'btnAWDNext'             ,
                          -size         => [100, 30]                ,
                          -pos          => [$winDBw-110,$winDBh-65] ,
                          -text         => $STR{'btnAWDNext'}.' >>' ,
                          -font         => $font10                  , );

#------------------------------------------------------------------------------#
# Logging Database Window
#------------------------------------------------------------------------------#
my $winLogDB = Win32::GUI::Window->new( -name        => 'winLogDB'            ,
                                        -background  => [255, 255, 255]       ,
                                        -parent      => $winConfig            ,
                                        -text        => $STR{'winLogDB'}      ,
                                        -pos         => [$winPosX, $winPosY]  ,
                                        -size        => [$winDBw, $winDBh]    ,
                                        -minsize     => [$winDBw, $winDBh]    ,
                                        -hasmaximize => 1                     ,
                                        -hasminimize => 1                     ,
                                        -resizable   => 1                     , );
$winLogDB->SetIcon($winICO);
# Grid
$winLogDB->AddGrid( -name         => 'LogDBGrid'              ,
                    -size         => [$winDBw-14, $winDBh-36],
                    -pos          => [  0,  0]                ,
                    -background   => [255, 255, 255]          ,
                    -columns      => 4                        ,
                    -fixedrows    => 1                        ,
                    -fixedcolumns => 0                        , );
# Popup menu fro grid
my $LogDBGridPopupMenu = new Win32::GUI::Menu("logDBGridMenu"             => "logDBGridMenu"      ,
                                              "> $STR{'gridSelectAll'}"   => "logDBGridSelectAll" ,
                                              "> $STR{'lineCopy'}"        => "logDBlineCopy"      ,
                                              "> $STR{'deleteLine'}"      => "logDBlineDelete"    ,
                                              " > -"                      => 0                    ,
                                              "> $STR{'btnImportDBTip'}"  => "importLogDB"        ,
                                              "> $STR{'btnExportDBTip'}"  => "exportLogDB"        , );

#------------------------------------------------------------------------------#
# Simple Progress window
#------------------------------------------------------------------------------#
my $winPbW = 600;
my $winPbH = 170;
my $winPb  = Win32::GUI::DialogBox->new(-name        => 'winPb'                   ,
                                        #-parent      => $win                      ,
                                        -text        => $STR{'winPb'}             ,
                                        -pos         => [$winPosX, $winPosY]      ,
                                        -size        => [$winPbW , $winPbH]       ,
                                        -background  => [255, 255, 255]           ,
                                        -hasmaximize => 0                         ,
                                        -hasminimize => 1                         ,
                                        -helpbutton  => 0                         ,
                                        -resizable   => 0                         ,
                                        -dialogui    => 1                         , );
$winPb->SetIcon($winICO);
$winPb->AddLabel(       -name        => 'lblLogo2'       ,
                        -size        => [128,128]        ,
                        -pos         => [  0,  5]        ,
                        -bitmap      => $logo128Bmp      , );
$winPb->AddLabel(       -name        => 'lblPbCurr'      ,
                        -size        => [360, 22]        ,
                        -pos         => [140, 25]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0, 102, 204]  , );
$winPb->AddProgressBar( -name        => 'pbWinPb'        ,
                        -size        => [355, 22]        ,
                        -pos         => [140, 50]        ,
                        -smooth      => 1                , );
$winPb->AddLabel(       -name        => 'lblCount'       ,
                        -size        => [100, 22]        ,
                        -pos         => [500, 52]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0, 102, 204]  , );
$winPb->AddButton(      -name        => 'btnCancel'      ,
                        -text        => $STR{'cancel'}   ,
                        -font        => $font10          ,
                        -size        => [ 80, 30]        ,
                        -pos         => [300, 95]        ,
                        -cancel      => 1                , );

#------------------------------------------------------------------------------#
# Starting program
#------------------------------------------------------------------------------#
if (-T $CONFIG_FILE) {
  &loadConfig(\%CONFIG);
  # Check update for tool and databases ?
  if ($CONFIG{'TOOL_AUTO_UPDATE'}    or $CONFIG{'TLD_DB_AUTO_UPDATE'} or $CONFIG{'WS_DB_AUTO_UPDATE'} or
      $CONFIG{'IPv4_DB_AUTO_UPDATE'} or $CONFIG{'IPv6_DB_AUTO_UPDATE'}) {
    $THR_UPDATE = threads->create(sub { &updateAll(); });
  }
  &isWhoisReady(0);
} else { # Configuration Wizard Window
  my $refWinCW = &createCW();
  $THR_UPDATE = threads->create(sub { &firstStart($refWinCW); });
}
$START = 1;
if (!$CONFIG{'START_MINIMIZED'}) { $win->Show(); }
Win32::GUI::Dialog();

#--------------------------#
sub winMain_Terminate
#--------------------------#
{
  $win->Tray->Remove();
  -1; # Exit signal

}  #--- End winMain_Terminate

#--------------------------#
sub winMain_Minimize
#--------------------------#
{
  $win->Hide();
  if ($THR and $THR->is_running()) { $win->Tray->ShowBalloon(); }
  return(0);

}  #--- End winMain_Minimize

#--------------------------#
sub DWTrayMenu_Click
#--------------------------#
{
  # Save the choice
  if (!$trayMenu->{'domainWhois'}->Checked()) {
    $trayMenu->{'domainWhois'}->Checked(1);
    $CONFIG{'OPT_DOMAIN'} = 1;
    $win->chDomain->Checked(1);
    &saveConfig(\%CONFIG);
  } else {
    $trayMenu->{'domainWhois'}->Checked(0);
    $CONFIG{'OPT_DOMAIN'} = 0;
    $win->chDomain->Checked(0);
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End DWTrayMenu_Click

#--------------------------#
sub NWTrayMenu_Click
#--------------------------#
{
  # Save the choice
  if (!$trayMenu->{'networkWhois'}->Checked()) {
    $trayMenu->{'networkWhois'}->Checked(1);
    $CONFIG{'OPT_NETWORK'} = 1;
    $win->chNetwork->Checked(1);
    &saveConfig(\%CONFIG);
  } else {
    $trayMenu->{'networkWhois'}->Checked(0);
    $CONFIG{'OPT_NETWORK'} = 0;
    $win->chNetwork->Checked(0);
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End NWTrayMenu_Click

#--------------------------#
sub DRTrayMenu_Click
#--------------------------#
{
  # Save the choice
  if (!$trayMenu->{'dnsRecords'}->Checked()) {
    $trayMenu->{'dnsRecords'}->Checked(1);
    $CONFIG{'OPT_DNS'} = 1;
    $win->chDNS->Checked(1);
    &saveConfig(\%CONFIG);
  } else {
    $trayMenu->{'dnsRecords'}->Checked(0);
    $CONFIG{'OPT_DNS'} = 0;
    $win->chDNS->Checked(0);
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End DRTrayMenu_Click

#--------------------------#
sub Tray_DblClick { $win->Show(1); }
#--------------------------#

#--------------------------#
sub Tray_RightClick
#--------------------------#
{
  if ($win->chDomain->Checked())  { $trayMenu->{'domainWhois'}->Checked(1);  }
  if ($win->chNetwork->Checked()) { $trayMenu->{'networkWhois'}->Checked(1); }
  if ($win->chDNS->Checked())     { $trayMenu->{'dnsRecords'}->Checked(1);   }
  &isWhoisReady(0);
  if ($trayMenu->{'whois'}->Enabled()) {
    # Parse the first item of clipboard
    my $menuText;
    my %itemsIndex;
    my %itemsType;
    my $nbrItems = &extractRequestItems(\%itemsIndex, \%itemsType);
    if ($nbrItems > 0) {
      # Found the first extracted item
      foreach my $item (sort { $itemsIndex{$a} <=> $itemsIndex{$b} } keys(%itemsIndex)) {
        $menuText .= $item;
        last;
      }
      # More than one item
      if ($nbrItems > 1) { $menuText .= '...'; }
      $trayMenu->{'whois'}->Change( -text => "Whois $menuText");
    # Disable Whois function in Tray Menu
    } else {
      $trayMenu->{'whois'}->Change( -text => "Whois");
      $trayMenu->{'whois'}->Enabled(0);
    }    
  # Menu item disabled
  } else { $trayMenu->{'whois'}->Change( -text => "Whois"); }
  $win->TrackPopupMenu($trayMenu->{SysTray});
  return(1);

}  #--- End Tray_Click

#--------------------------#
sub btnItemClip_Click
#--------------------------#
{
  # Gather clipboard content
  if (my $text = Win32::Clipboard::GetText()) {
    $winClip->tfClip->Text($text);
  } else { $winClip->tfClip->Text($STR{'errNoTextData'}); }
  $winClip->Center($win);
  $winClip->DoModal();
  return(1);

}  #--- End btnItemClip_Click

#--------------------------#
sub winClip_Resize
#--------------------------#
{
  $winClip->tfClip->Resize(     $winClip->ScaleWidth()-12         , $winClip->ScaleHeight()-50);
  $winClip->btnClipOk->Move(    ($winClip->ScaleWidth()-280)/2    , $winClip->ScaleHeight()-38);
  $winClip->btnClipEdit->Move(  ($winClip->ScaleWidth()-280)/2+100, $winClip->ScaleHeight()-38);
  $winClip->btnClipParse->Move( ($winClip->ScaleWidth()-280)/2+200, $winClip->ScaleHeight()-38);
  return(1);

}  #--- End winClip_Resize

#--------------------------#
sub tfClip_Change
#--------------------------#
{
  my $tfClip = $winClip->tfClip->Text();
  if ($tfClip)  { $winClip->btnClipEdit->Enable();  }
  else          { $winClip->btnClipEdit->Disable(); }

}  #--- End tfClip_Change

#--------------------------#
sub tfClip_GotFocus { $LISTNO = 3; }
#--------------------------#

#--------------------------#
sub btnClipOk_Click { return(-1); }
#--------------------------#

#--------------------------#
sub btnClipEdit_Click
#--------------------------#
{
  # Set clipboard content
  my $text = $winClip->tfClip->Text();
  Win32::Clipboard::Set($text);
  $winClip->btnClipEdit->Disable();

}  #--- End btnClipEdit_Click

#--------------------------#
sub btnClipParse_Click
#--------------------------#
{
  # Local variables
  my $text = $winClip->tfClip->Text();
  # Extract Items from Clipboard
  my %itemsIndex;
  my %itemsType;
  my $nbrItems = &extractRequestItems(\%itemsIndex, \%itemsType);
  if (!$nbrItems) {
    Win32::GUI::MessageBox($win, $STR{'errNoValidData'}, $STR{'error'}, 0x40010);
    return(0);
  # Whois Request
  } else {
    my $parsedItems;
    foreach my $item (sort { $itemsIndex{$a} <=> $itemsIndex{$b} } keys(%itemsIndex)) { $parsedItems .= "$item\r\n"; }
    $winClip->tfClip->Text($parsedItems);
    Win32::Clipboard::Set($parsedItems);
  }
  return(1);

}  #--- End btnClipParse_Click

#--------------------------#
sub chDomain_Click
#--------------------------#
{
  # Save the choice
  if ($win->chDomain->Checked()) {
    $CONFIG{'OPT_DOMAIN'} = 1;
    $trayMenu->{'domainWhois'}->Checked(1);
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'OPT_DOMAIN'} = 0;
    $trayMenu->{'domainWhois'}->Checked(0);
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End chDomain_Click

#--------------------------#
sub chNetwork_Click
#--------------------------#
{
  # Save the choice
  if ($win->chNetwork->Checked()) {
    $CONFIG{'OPT_NETWORK'} = 1;
    $trayMenu->{'networkWhois'}->Checked(1);
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'OPT_NETWORK'} = 0;
    $trayMenu->{'networkWhois'}->Checked(0);
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End chNetwork_Click

#--------------------------#
sub chDNS_Click
#--------------------------#
{
  # Save the choice
  if ($win->chDNS->Checked()) {
    $CONFIG{'OPT_DNS'} = 1;
    $trayMenu->{'dnsRecords'}->Checked(1);
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'OPT_DNS'} = 0;
    $trayMenu->{'dnsRecords'}->Checked(0);
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End chDNS_Click

#--------------------------#
sub cbCheckWhoisDB_Change
#--------------------------#
{
  # Local variables
  my $field = $win->cbCheckWhoisDB->GetCurSel();
  # Possible values for field: 0 = Don't check, 1 = If present, ask, 2 = If present, ignore, 3 = Check after
  $CONFIG{'CHECK_WHOIS_DB'} = $field;
  &saveConfig(\%CONFIG);

}  #--- End cbCheckWhoisDB_Change

#--------------------------#
sub chCheckLogging_Click
#--------------------------#
{
  # Save the choice
  if ($win->chCheckLogging->Checked()) {
    $CONFIG{'CHECK_LOGGING_DB'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'CHECK_LOGGING_DB'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chCheckLogging_Click


#--------------------------#
sub winLogDB_Resize
#--------------------------#
{
  $winLogDB->LogDBGrid->Resize($winLogDB->ScaleWidth(), $winLogDB->ScaleHeight());
  $winLogDB->LogDBGrid->AutoSizeColumns();
  $winLogDB->LogDBGrid->ExpandColumnsToFit();
  return(1);

}  #--- End winLogDB_Resize

#--------------------------#
sub loadLoggingDB
#--------------------------#
{
  # Local variables
  my $logDbFile = $winConfig->tfLogDbFile->Text();
  if (-f $logDbFile) {
    my $dsn = "DBI:SQLite:dbname=$logDbFile";
    my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
              or Win32::GUI::MessageBox($win, $STR{'errConnectingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
    # Check if LOGGING_DB table exists
    my $sth;
    eval { $sth = $dbh->table_info(undef, undef, '%', 'TABLE'); };
    if ($@) {
      Win32::GUI::MessageBox($win, $STR{'errConnectingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      return(0);
    }
    # If table LOGGING_DB exists, than load data
    my @info = $sth->fetchrow_array;
    $sth->finish();
    if ($info[2] eq 'LOGGING_DB') {
      my $all = $dbh->selectall_arrayref("SELECT * FROM LOGGING_DB ORDER BY date DESC");
      # Database: table = LOGGING_DB, Fields = date, request, details, comment
      # Feed the grid
      my $i = 0;
      $winLogDB->LogDBGrid->SetRows(scalar(@$all)+1);
      $winLogDB->LogDBGrid->SetCellText($i, 0, $STR{'date'}    );
      $winLogDB->LogDBGrid->SetCellText($i, 1, $STR{'request'} );
      $winLogDB->LogDBGrid->SetCellText($i, 2, $STR{'details'} );
      $winLogDB->LogDBGrid->SetCellText($i, 3, $STR{'comment'} );
      $i++;
      foreach my $row (@$all) {
        my (@values) = @$row;
        $winLogDB->LogDBGrid->SetCellText($i, 0, $values[0]);
        $winLogDB->LogDBGrid->SetCellText($i, 1, $values[1]);
        if ($values[2] ne 'NULL') { $winLogDB->LogDBGrid->SetCellText($i, 2, $values[2]); }
        if ($values[3] ne 'NULL') { $winLogDB->LogDBGrid->SetCellText($i, 3, $values[3]); }
        $winLogDB->LogDBGrid->SetCellEditable($i, 0, 0);
        $winLogDB->LogDBGrid->SetCellEditable($i, 1, 0);
        $winLogDB->LogDBGrid->SetCellEditable($i, 2, 0);
        $winLogDB->LogDBGrid->SetCellEditable($i, 3, 1);
        $i++;
      }
      # Refresh grid
      $winLogDB->LogDBGrid->AutoSizeColumns();
      $winLogDB->LogDBGrid->ExpandColumnsToFit();
      $winLogDB->LogDBGrid->ScrollPos(1,0);
      $winLogDB->LogDBGrid->SetListMode();
      $dbh->disconnect();
      return(1);
    } else { Win32::GUI::MessageBox($win, $STR{'errTableLoggingDB'}, $STR{'error'}, 0x40010); return(0); }
  } else { return(0); }

}  #--- End loadLoggingDB

#--------------------------#
sub LogDBGrid_Click
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  $LISTNO = 2;
  if ($row == 0) {
    $winLogDB->LogDBGrid->SetHeaderSort();
    my $order = $winLogDB->LogDBGrid->GetSortAscending();
    if    ($column > 1) { $winLogDB->LogDBGrid->SortCells($column, $order, \&sortLC); }
    $winLogDB->LogDBGrid->Refresh();
  }
  return(1);

}  #--- End LogDBGrid_Click

#--------------------------#
sub LogDBGrid_RClick
#--------------------------#
{
  # Show popup menu
  my ($row, $column) = @_;
  my(@coord) = $winLogDB->LogDBGrid->GetSelectedCellRange();
  if (($coord[0] and ($row < $coord[0])) or
      ($coord[2] and ($row > $coord[2])) or
      !$coord[0]) {
    $winLogDB->LogDBGrid->SetSelectedCellRange($row, 0, $row, 4);
  }
  my ($X, $Y) = Win32::GUI::GetCursorPos();
  $winLogDB->TrackPopupMenu($LogDBGridPopupMenu->{logDBGridMenu},$X, $Y);
  return(1);

}  #--- End LogDBGrid_RClick

#--------------------------#
sub logDBGridSelectAll_Click
#--------------------------#
{
  $winLogDB->LogDBGrid->OnEditSelectAll();
  return(1);

}  #--- End logDBGridSelectAll_Click

#--------------------------#
sub logDBlineCopy_Click
#--------------------------#
{
  $winLogDB->LogDBGrid->OnEditCopy();
  return(1);

}  #--- End logDBlineCopy_Click

#--------------------------#
sub logDBlineDelete_Click
#--------------------------#
{
  # Local variables
  my(@coord)      = $winLogDB->LogDBGrid->GetSelectedCellRange();
  my $nbrEntries  = $winLogDB->LogDBGrid->GetRows();
  my $logDbFile   = $winConfig->tfLogDbFile->Text();
  my @Entries2del;
  # Select data to delete
  my $lastSelectedRow; 
  if ($coord[2]) { $lastSelectedRow = $coord[2]; }
  else           { $lastSelectedRow = $coord[0]; }
  for (my $row = $coord[0]; $row <= $lastSelectedRow; $row++) {
    if ($winLogDB->LogDBGrid->IsCellSelected ($row, 0)) {
      my $dateEntry = $winLogDB->LogDBGrid->GetCellText($row, 0);
      push(@Entries2del, $dateEntry);
    }
  }
  $THR = threads->create(sub {
    # Thread 'cancellation' signal handler
    $SIG{'KILL'} = sub {
      $winLogDB->LogDBGrid->Refresh();
      # Status bar
      &winPb_Terminate;
      $winLogDB->ChangeCursor($ARROW);
      threads->exit();
    };
    # Show progress window
    my $nbrEntries2del = @Entries2del;
    $winPb->lblPbCurr->Text($STR{'deletingEntries'});
    $winPb->lblCount->Text("0 / $nbrEntries2del");
    $winPb->pbWinPb->SetRange(0, $nbrEntries2del);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    $winPb->Center($winLogDB);
    $winPb->Show();
    $winLogDB->Disable();
    $winLogDB->ChangeCursor($HOURGLASS);
    # Connect to DB
    my $dsn = "DBI:SQLite:dbname=$logDbFile";
    my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
              or Win32::GUI::MessageBox($win, $STR{'errCreatingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
    # Loop each entry and delete
    my $j = 0;
    foreach my $dateEntry2del (@Entries2del) {
      for (my $i = 0; $i < $nbrEntries; $i++) {
        my $dateEntry = $winLogDB->LogDBGrid->GetCellText($i, 0);
        # Entry have been found
        if ($dateEntry eq $dateEntry2del) {
          # Delete entry in DB
          # Database: table = LOGGING_DB, Fields = date, request, details, comment
          my $sth = $dbh->prepare("DELETE from LOGGING_DB where date == ?");
          my $rv = $sth->execute($dateEntry);
          if ($rv < 0) { Win32::GUI::MessageBox($winLogDB, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010); }
          else { 
            # Find the entry in grid and delete
            for (my $k = $i; $k < $winLogDB->LogDBGrid->GetRows(); $k++) {
              my $currEntryDate = $winLogDB->LogDBGrid->GetCellText($k, 0);
              if ($dateEntry eq $currEntryDate) {
                $winLogDB->LogDBGrid->DeleteRow($k);
                last;
              }
            }
          }
          last;
        }
      }
      $j++;
      $winPb->lblCount->Text("$j / $nbrEntries2del");
      $winPb->pbWinPb->StepIt();
    }
    $winLogDB->ChangeCursor($ARROW);
    &winPb_Terminate;
    $dbh->disconnect();
    $winLogDB->LogDBGrid->Refresh();
  });
  return(1);
  
}  #--- End logDBlineDelete_Click

#--------------------------#
sub LogDBGrid_EndEdit
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  my $logDbFile      = $winConfig->tfLogDbFile->Text();
  my $date           = $winLogDB->LogDBGrid->GetCellText($row, 0);
  my $comment        = $winLogDB->LogDBGrid->GetCellText($row, 3);
  if (!$comment) { $comment = 'NULL'; }
  # Add or modify comment in Logging Database
  if (-f $logDbFile) {
    # Connect to DB
    my $dsn = "DBI:SQLite:dbname=$logDbFile";
    my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
              or Win32::GUI::MessageBox($win, $STR{'errCreatingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
    # Database: table = LOGGING_DB, Fields = date, request, details, comment
    my $sth = $dbh->prepare("UPDATE LOGGING_DB SET comment = ? WHERE ? == date");
    my $rv  = $sth->execute($comment, $date);
    if ($rv < 0) {
      Win32::GUI::MessageBox($win, $STR{'errUpdatingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      $dbh->disconnect();
      return(0);
    }
    $dbh->disconnect();
  }
  return(1);

}  #--- End LogDBGrid_EndEdit

#--------------------------#
sub importLogDB_Click
#--------------------------#
{
  # Local variables
  my $logFile = Win32::GUI::GetOpenFileName(-owner            => $winLogDB            ,
                                            -title            => $STR{'selectLogFile'},
                                            -defaultfilter    => 0                    ,
                                            -directory        => $USERDIR             ,
                                            -file             => 'Logging_db.txt'     ,
                                            -defaultextension => 'txt'                ,
                                            -explorer         => 1                    , );
  # Selected file
  if ($logFile and -T $logFile) {
    # Validate content
    open(FILE, $logFile) or Win32::GUI::MessageBox($win, $STR{'errReading'}.$!, $STR{'error'}, 0x40010);
    my @logging = <FILE>;
    close(FILE);
    shift(@logging); # Remove headers
    my $nbrEntries = @logging;
    if ($nbrEntries > 1 and $logging[0]) { # At least one entry
      my @fields = split(/\t/, $logging[0]);
      # 4 fields and first one is a date
      if ($fields[0] and $fields[1] and $fields[2] and $fields[3] and $fields[0] =~ /\d{4}\-\d{2}\-\d{2} \d{2}\:\d{2}\:\d{2}/) {
        # Import
        $THR = threads->create(sub { &importLoggingDB(\@logging, $nbrEntries); });
      } else { Win32::GUI::MessageBox($winLogDB, $STR{'errNoValidFile'}, $STR{'error'}, 0x40010); }
    } else { Win32::GUI::MessageBox($winLogDB, $STR{'errFileEmpty'}, $STR{'error'}, 0x40010); }
  } else { Win32::GUI::MessageBox($winLogDB, $STR{'selectValidFile'}, $STR{'error'}, 0x40010); }
  return(1);

}  #--- End importLogDB_Click

#--------------------------#
sub importLoggingDB
#--------------------------#
{
  # Local variables
  my ($refLogging, $nbrEntries) = @_;
  my $dbLogFile = $winConfig->tfLogDbFile->Text();
  # Cancel button
  $SIG{'KILL'} = sub {
    # Sort grid
    $winLogDB->LogDBGrid->SortCells(0, 0, \&sortLC);
    $winLogDB->LogDBGrid->Refresh();
    # Turn off progress bar
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    &winPb_Terminate;
    $winLogDB->ChangeCursor($ARROW);
    threads->exit();
  };
  # Turn on progress bar
  $winPb->Center($winDB);
  $winPb->Show();
  $winPb->lblPbCurr->Text('');
  $winPb->lblCount->Text('');
  $winLogDB->Disable();
  $winLogDB->ChangeCursor($HOURGLASS);
  # Update DB
  # Database: table = LOGGING_DB, Fields = date, request, details, comment
  $winPb->lblPbCurr->Text($STR{'importingLoggingData'});
  my $dsn = "DBI:SQLite:dbname=$dbLogFile";
  my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
              or Win32::GUI::MessageBox($win, $STR{'errConnectingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
  foreach my $entry (@{$refLogging}) {
    chomp($entry);
    my @fields = split(/\t/, $entry);
    # Add to Logging Database
    &logRequest($fields[1], \$dbh, $fields[2], $fields[0], $fields[3]);
    # Verify if entry already exists in Logging Grid
    my $entryExists = 0;
    for (my $i = 1; $i < $winLogDB->LogDBGrid->GetRows(); $i++) {
      my $date = $winLogDB->LogDBGrid->GetCellText($i, 0);
      if ($fields[0] eq $date) { $entryExists = 1; }
    }
    # Add to Logging Grid
    if (!$entryExists) {
      if (my $newLine = $winLogDB->LogDBGrid->InsertRow($fields[0], -1)) {
        $winLogDB->LogDBGrid->SetCellText($newLine, 0, $fields[0]);
        $winLogDB->LogDBGrid->SetCellText($newLine, 1, $fields[1]);
        if ($fields[2] ne 'NULL') {$winLogDB->LogDBGrid->SetCellText($newLine, 2, $fields[2]); }
        if ($fields[3] ne 'NULL') {$winLogDB->LogDBGrid->SetCellText($newLine, 3, $fields[3]); }
        $winLogDB->LogDBGrid->SetCellEditable($newLine, 0, 0);
        $winLogDB->LogDBGrid->SetCellEditable($newLine, 1, 0);
        $winLogDB->LogDBGrid->SetCellEditable($newLine, 2, 0);
        $winLogDB->LogDBGrid->SetCellEditable($newLine, 3, 1);
      } else { Win32::GUI::MessageBox($win, $STR{'errNewLine'}, $STR{'error'}, 0x40010); }
    }
  }
  # Refresh grid
  $winLogDB->LogDBGrid->AutoSizeColumns();
  $winLogDB->LogDBGrid->ExpandColumnsToFit();
  $winLogDB->LogDBGrid->ScrollPos(1,0);
  $winLogDB->LogDBGrid->SortCells(0, 0, \&sortLC);
  $winLogDB->LogDBGrid->Refresh();
  # Turn off progress bar
  $winPb->lblPbCurr->Text('');
  $winPb->lblCount->Text('');
  $winPb->pbWinPb->SetPos(0);
  &winPb_Terminate;
  $winLogDB->ChangeCursor($ARROW);
  
}  #--- End importLoggingDB

#--------------------------#
sub exportLogDB_Click
#--------------------------#
{
  # Local variables
  my $logDbFile = $winConfig->tfLogDbFile->Text();
  # Show SaveFileWindow
  my $file = Win32::GUI::GetSaveFileName( -owner            => $winLogDB                  ,
                                          -title            => $STR{'btnExportDBTip'}.':' ,
                                          -file             => 'Logging_db.txt'           ,
                                          -defaultextension => 'txt'                      ,
                                          -createprompt     => 1                          ,
                                          -explorer         => 1                          , );
  if ($file) {
    $THR = threads->create(sub {
      # Thread 'cancellation' signal handler
      $SIG{'KILL'} = sub {
        &winPb_Terminate;
        $winLogDB->ChangeCursor($ARROW);
        threads->exit();
      };
      # Connect to DB
      my $dsn = "DBI:SQLite:dbname=$logDbFile";
      my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
                or Win32::GUI::MessageBox($win, $STR{'errCreatingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      # Database: table = LOGGING_DB, Fields = date, request, details, comment
      my $all = $dbh->selectall_arrayref("SELECT * FROM LOGGING_DB ORDER BY date ASC");
      my $nbrEntries = scalar(@$all);
      $winLogDB->ChangeCursor($HOURGLASS);
      # Show progress window
      $winPb->lblPbCurr->Text($STR{'exportLoggingDB'});
      $winPb->lblCount->Text("0 / $nbrEntries");
      $winPb->pbWinPb->SetRange(0, $nbrEntries);
      $winPb->pbWinPb->SetPos(0);
      $winPb->pbWinPb->SetStep(1);
      $winPb->Center($winLogDB);
      $winPb->Show();
      $winLogDB->Disable();
      $winLogDB->ChangeCursor($HOURGLASS);
      # Export DB
      &exportLoggingDB($file, $all, $nbrEntries);
      $dbh->disconnect();
      # Message
      $winLogDB->ChangeCursor($ARROW);
      &winPb_Terminate;
      Win32::GUI::MessageBox($winLogDB, $STR{'exportSucess'}, "XL-Whois $VERSION", 0x40040);
      $winLogDB->BringWindowToTop();
    });
  }
  return(1);

}  #--- End exportLogDB_Click

#--------------------------#
sub exportLoggingDB
#--------------------------#
{
  # Local variables
  my ($file, $refData, $nbrEntries) = @_;
  my $i = 0;
  # Open and write data to file
  open my $db_export, '>', $file or Win32::GUI::MessageBox($win, $STR{'errWriting'}.$!, $STR{'error'}, 0x40010);
  print $db_export "$STR{'date'}\t$STR{'request'}\t$STR{'details'}\t$STR{'comment'}\n";
  foreach my $row (@$refData) {
    my (@fields) = @$row;
    print $db_export "$fields[0]\t$fields[1]\t$fields[2]\t$fields[3]\n";
    $i++;
    # Display progress and refresh
    $winPb->lblCount->Text("$i / $nbrEntries");
    $winPb->pbWinPb->StepIt();
  }
  close($db_export);
  
}  #--- End exportLoggingDB

#--------------------------#
sub lblNotReady_Click { &isWhoisReady(1); }
#--------------------------#

#--------------------------#
sub isWhoisReady
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  my $nextStep;
  # Parser
  if (!$winConfig->chIPv4->Checked() and !$winConfig->chIPv6->Checked() and !$winConfig->chHostname->Checked() and !$winConfig->chDomainName->Checked()) {
    $nextStep = $STR{'readyParserOpt'};
  }
  # Options
  if (!$win->chDomain->Checked() and !$win->chNetwork->Checked() and !$win->chDNS->Checked()) { $nextStep = $STR{'readySelWhoisOpt'}; }
  # Folder for report
  my $saveDir = $winConfig->tfReportDir->Text();
  if (!$saveDir or !-d $saveDir) { $nextStep = $STR{'btnReportDirTip'}; }
  # Whois Database location
  if (!$CONFIG{'WHOIS_DB_FILE'} or !-f $CONFIG{'WHOIS_DB_FILE'}) { $nextStep = $STR{'readySelWhoisDB'}; }
  # Logging Database location (optional)
  if (($CONFIG{'CHECK_LOGGING_DB'} or $winConfig->chLogActivate->Checked()) and (!$CONFIG{'LOGGING_DB_FILE'} or !-f $CONFIG{'LOGGING_DB_FILE'})) {
    $nextStep = $STR{'readySelLoggingDB'};
  }
  # TLD Database location
  if (!$CONFIG{'TLD_DB_FILE'} or !-f $CONFIG{'TLD_DB_FILE'}) { $nextStep = $STR{'readySelTLDDB'}; }
  # Whois Server Database location
  if (!$CONFIG{'WS_DB_FILE'} or !-f $CONFIG{'WS_DB_FILE'}) { $nextStep = $STR{'readySelWSDB'}; }
  # Return an error message or enable the button
  if ($nextStep) {
    $win->btnWhois->Disable();
    $trayMenu->{'whois'}->Enabled(0);
    $win->lblNotReady->Show();
    if ($confirm) { Win32::GUI::MessageBox($win, "$STR{'notReady'} ?\n\n$STR{'nextStep'}: $nextStep", $STR{'notReady'}, 0x40040); }
  } else {
    $win->btnWhois->Enable();
    $trayMenu->{'whois'}->Enabled(1);
    $win->lblNotReady->Hide();
  }

}  #--- End isWhoisReady

#--------------------------#
sub extractRequestItems
#--------------------------#
{
  # Local variables
  my ($refItemsIndex, $refItemsType)  = @_;
  # $refItemsIndex: hash contains item original position in list
  # $refItemsType:  hash contains item value type: IPv4, Hostname, Domain, IPv6
  my $nbrItems = 0;
  my @content  = split(/\r\n/, Win32::Clipboard::GetText());
  # Load TLD Database
  if (!$TLDDB) {
    $TLDDB = Domain::PublicSuffix->new({ 'data_file' => $CONFIG{'TLD_DB_FILE'} }) or Win32::GUI::MessageBox($win, $STR{'errLoadingDB'}, $STR{'error'},0x40010);
  }
  # List items
  foreach my $item (@content) {
    while ($item =~ /(?:[^0-9]|^)(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(?:[^0-9\.]|$)/ or
           $item =~ /(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.){2,}[a-zA-Z]{2,}(?:[^a-zA-Z]|$)/ or
           $item =~ /(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}(?:[^\w\.\-]|$)/ or
           $item =~ /$IPv6_re/) {
      my $el;
      my $ipv4Found     = 0;
      my $hostnameFound = 0;
      my $domainFound   = 0;
      my $ipv6Found     = 0;
      # IPv4
      if ($item =~ /(?:[^0-9]|^)((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))(?:[^0-9\.]|$)/ and
          $winConfig->chIPv4->Checked()) {
        $nbrItems++;
        $el = $1;
        $$refItemsIndex{$el} = $nbrItems;
        $$refItemsType{$el} = 'IPv4';
        $item =~ s/$el//;
        $ipv4Found = 1;
      }
      # Hostname
      if ($item =~ /((?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.){2,}[a-zA-Z]{2,})(?:[^a-zA-Z]|$)/ and $winConfig->chHostname->Checked()) {
        $el         = $1;
        my $testObj = $el;
        # Domain must be valid
        if ($el and my $ext = $TLDDB->get_root_domain(lc($el))) {
          $testObj =~ s/$ext//i;
          if ($testObj) {
            $nbrItems++;
            $$refItemsIndex{$el} = $nbrItems;
            $$refItemsType{$el} = 'Hostname';
            $item =~ s/$el//;
            $hostnameFound = 1;
          }
        }
      }
      # Domain name
      if ($item =~ /((?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z]{2,})(?:[^\w\.\-]|$)/ and $winConfig->chDomainName->Checked()) {
        $el = $1;
        # Domain must be valid
        if ($el and my $dom = $TLDDB->get_root_domain(lc($el))) {
          $nbrItems++;
          $$refItemsIndex{$el} = $nbrItems;
          $$refItemsType{$el} = 'Domain';
          $item =~ s/$el//;
          $domainFound = 1;
        }
      }
      # IPv6
      if ($item =~ /($IPv6_re)/ and $winConfig->chIPv6->Checked()) {
        $el = $1;
        if ($el =~ /^$IPv6_re$/) {
          $nbrItems++;
          $$refItemsIndex{$el} = $nbrItems;
          $$refItemsType{$el} = 'IPv6';
          $item =~ s/$el//;
          $ipv6Found = 0;
        }
      }
      # Nothing found
      if (!$ipv4Found and !$hostnameFound and !$domainFound and !$ipv6Found) { last; }
    }
  }
  return($nbrItems);
  
}  #--- End extractRequestItems

#--------------------------#
sub btnWinDatabase_Click { &btnWhoisDbView_Click; }
#--------------------------#

#--------------------------#
sub winDB_Resize
#--------------------------#
{
  $winDB->tfSearchDB->Resize(       $winDB->ScaleWidth()-335   , 22);
  $winDB->btnSearchDB->Move(        $winDB->ScaleWidth()-77    , 5);
  $winDB->btnSearchDB_p->Move(      $winDB->ScaleWidth()-52    , 5);
  $winDB->btnSearchDB_n->Move(      $winDB->ScaleWidth()-27    , 5);
  $winDB->tfFilterDB->Resize(       $winDB->ScaleWidth()-335   , 22);
  $winDB->btnFilterDB->Move(        $winDB->ScaleWidth()-77    , 30);
  $winDB->btnFilterDB_del->Move(    $winDB->ScaleWidth()-52    , 30);
  $winDB->btnFilterDB_add->Move(    $winDB->ScaleWidth()-27    , 30);
  $winDB->DBGrid->Resize(           $winDB->ScaleWidth()       , $winDB->ScaleHeight()-80);
  $winDB->statusBar->Move(          0                          , $winDB->ScaleHeight()-120);
  $winDB->statusBar->Resize(        $winDB->ScaleWidth()       , 40);
  $winDB->statusBar->Move(          0                          , $winDB->ScaleHeight() - $winDB->statusBar->Height);
  $winDB->statusBar->Resize(        $winDB->ScaleWidth()       , $winDB->statusBar->Height);
  $winDB->DBGrid->AutoSizeColumns();
  $winDB->DBGrid->ExpandColumnsToFit();
  return(1);

}  #--- End winDB_Resize

#--------------------------#
sub loadWhoisDB
#--------------------------#
{
  # Local variables
  my $whoisDB = $winConfig->tfDbFile->Text();
  if (-f $whoisDB) {
    my $nbrISP = 0;
    my $i      = 0;
    # Connect to DB
    my $dsn = "DBI:SQLite:dbname=$whoisDB";
    my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 }) or Win32::GUI::MessageBox($win, $STR{'errConnectingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
    # Check if WHOIS_DB table exists
    my $sth;
    eval { $sth = $dbh->table_info(undef, undef, '%', 'TABLE'); };
    if ($@) {
      Win32::GUI::MessageBox($win, $STR{'errConnectingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      return(0);
    }
    # If table WHOIS_DB exists, than load data
    my $refInfo = $sth->fetchall_arrayref;
    $sth->finish();
    if ($$refInfo[0][2] eq 'WHOIS_DB') {
      my $all = $dbh->selectall_arrayref("SELECT * FROM WHOIS_DB ORDER BY range_s ASC");
      # Fields: 0 = ip start, 1 = ip end, 2 = ISP name, 3 = country, 4 = date
      $nbrISP = scalar(@$all);
      $winDB->statusBar->Text(" $STR{'numberISP'}: ".$nbrISP);
      $winDB->DBGrid->SetRows($nbrISP + 1);
      # Feed the grid - Header
      $winDB->DBGrid->SetCellText($i, 0, $STR{'cbFilterField1'});
      $winDB->DBGrid->SetCellText($i, 1, $STR{'cbFilterField2'});
      $winDB->DBGrid->SetCellText($i, 2, $STR{'cbFilterField3'});
      $winDB->DBGrid->SetCellText($i, 3, $STR{'cbFilterField4'});
      $winDB->DBGrid->SetCellText($i, 4, $STR{'date'});
      $i++;
      # Feed data
      foreach my $row (@$all) {
        my (@values) = @$row;
        my $ipStart = join '.', unpack 'C4', pack 'N', $values[0];
        my $ipEnd   = join '.', unpack 'C4', pack 'N', $values[1];
        $winDB->DBGrid->SetCellText($i, 0, $ipStart);
        $winDB->DBGrid->SetCellText($i, 1, $ipEnd);
        $winDB->DBGrid->SetCellText($i, 2, $values[2]);
        $winDB->DBGrid->SetCellText($i, 3, $values[3]);
        $winDB->DBGrid->SetCellText($i, 4, &time2DateLong($values[4]));
        $winDB->DBGrid->SetCellEditable($i, 0, 0);
        $winDB->DBGrid->SetCellEditable($i, 1, 0);
        $winDB->DBGrid->SetCellEditable($i, 2, 1); # Only ISP and country are editable
        $winDB->DBGrid->SetCellEditable($i, 3, 1);
        $winDB->DBGrid->SetCellEditable($i, 4, 0);
        # If Network Whois Data exist, set background color to green
        my $networkWhoisDataFile = "$CONFIG{'WHOIS_DATA_CACHE'}\\$ipStart\-$ipEnd\.txt";
        if (-T $networkWhoisDataFile) {
          $winDB->DBGrid->SetCellBkColor($i, 0, 0x33FF66);
          $winDB->DBGrid->SetCellBkColor($i, 1, 0x33FF66);
          $winDB->DBGrid->SetCellBkColor($i, 2, 0x33FF66);
          $winDB->DBGrid->SetCellBkColor($i, 3, 0x33FF66);
          $winDB->DBGrid->SetCellBkColor($i, 4, 0x33FF66);
        }
        $i++;
      }
    } else {
      Win32::GUI::MessageBox($win, $STR{'errTableWhoisDB'}, $STR{'error'}, 0x40010);
      $dbh->disconnect();
      return(0);
    }
    # If table WHOIS_DB_IPV6 exists, than load data
    if ($$refInfo[1] and $$refInfo[1][2] eq 'WHOIS_DB_6') {
      my $all = $dbh->selectall_arrayref("SELECT * FROM WHOIS_DB_6 ORDER BY ipv6_range ASC");
      $nbrISP += scalar(@$all);
      $winDB->statusBar->Text(" $STR{'numberISP'}: ".$nbrISP);
      $winDB->DBGrid->SetRows($nbrISP + 1);
      # Create header if it doesn't exist
      if ($i == 0) {
        # Header
        $winDB->DBGrid->SetCellText($i, 0, $STR{'cbFilterField1'});
        $winDB->DBGrid->SetCellText($i, 1, $STR{'cbFilterField2'});
        $winDB->DBGrid->SetCellText($i, 2, $STR{'cbFilterField3'});
        $winDB->DBGrid->SetCellText($i, 3, $STR{'cbFilterField4'});
        $winDB->DBGrid->SetCellText($i, 4, $STR{'date'});
        $i++;
      }
      # Feed data
      foreach my $row (@$all) {
        my (@values) = @$row;
        # Fields: 0 = cidr, 2 = ISP name, 3 = country, 4 = date
        my ($ipStart, $ipEnd) = split(/\-/, (Net::CIDR::cidr2range($values[0]))[0]);
        $winDB->DBGrid->SetCellText($i, 0, $ipStart);
        $winDB->DBGrid->SetCellText($i, 1, $ipEnd);
        $winDB->DBGrid->SetCellText($i, 2, $values[1]);
        $winDB->DBGrid->SetCellText($i, 3, $values[2]);
        $winDB->DBGrid->SetCellText($i, 4, &time2DateLong($values[3]));
        $winDB->DBGrid->SetCellEditable($i, 0, 0);
        $winDB->DBGrid->SetCellEditable($i, 1, 0);
        $winDB->DBGrid->SetCellEditable($i, 2, 1); # Only ISP and country are editable
        $winDB->DBGrid->SetCellEditable($i, 3, 1);
        $winDB->DBGrid->SetCellEditable($i, 4, 0);
        # If Network Whois Data exist, set background color to green
        $ipStart =~ s/\:/_/g;
        $ipEnd   =~ s/\:/_/g;
        my $networkWhoisDataFile = "$CONFIG{'WHOIS_DATA_CACHE'}\\$ipStart\-$ipEnd\.txt";
        if (-T $networkWhoisDataFile) {
          $winDB->DBGrid->SetCellBkColor($i, 0, 0x33FF66);
          $winDB->DBGrid->SetCellBkColor($i, 1, 0x33FF66);
          $winDB->DBGrid->SetCellBkColor($i, 2, 0x33FF66);
          $winDB->DBGrid->SetCellBkColor($i, 3, 0x33FF66);
          $winDB->DBGrid->SetCellBkColor($i, 4, 0x33FF66);
        }
        $i++;
      }
    # If table WHOIS_DB_6 does not exist, create the table
    } else { &createWhoisDB_IPV6(\$dbh); }
    # Refresh grid
    $winDB->DBGrid->AutoSizeColumns();
    $winDB->DBGrid->ExpandColumnsToFit();
    $winDB->DBGrid->SetListMode();
    $winDB->DBGrid->ScrollPos(1,0);
    $winDB->DBGrid->SortCells(0, 1, \&sortIP);
    $winDB->DBGrid->Refresh();
    $dbh->disconnect();
    return(1);
  } else { return(0); } # No valid WhoisDB file

}  #--- End loadWhoisDB

#--------------------------#
sub btnImportDB_Click
#--------------------------#
{
  # Show OpenFile dialog window
  my $importFile = Win32::GUI::GetOpenFileName( -owner         => $winDB                  ,
                                                -title         => $STR{'btnDbFileTip'}.':',
                                                -defaultfilter => 0                       ,
                                                -filemustexist => 1                       ,
                                                -explorer      => 1                       , );
  # Selected file
  if ($importFile and -T $importFile) {
    # Validate content
    open(FILE, $importFile) or Win32::GUI::MessageBox($win, $STR{'errReading'}.$!, $STR{'error'}, 0x40010);
    my @newISP = <FILE>;
    close(FILE);
    my $nbrISP = @newISP;
    if ($nbrISP > 0 and $newISP[0]) { # At least one item
      my @fields = split(/\t/, $newISP[0]);
      # At least 3 fields and first start with an IP range (IPv4 or IPv6)
      if ($fields[0] and $fields[1] and $fields[2] and
          ($fields[0] =~ /^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\-[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/ or
           $fields[0] =~ /$IPv6_re\-$IPv6_re/)) {
        # Import
        $THR = threads->create(sub { &importWhoisDB(\@newISP, $nbrISP); });
      } else { Win32::GUI::MessageBox($win, $STR{'errNoValidFile'}, $STR{'error'}, 0x40010); }
    } else { Win32::GUI::MessageBox($win, $STR{'errFileEmpty'}, $STR{'error'}, 0x40010); }
  } else { Win32::GUI::MessageBox($win, $STR{'selectValidFile'}, $STR{'error'}, 0x40010); }

}  #--- End btnImportDB_Click

#--------------------------#
sub importWhoisDB
#--------------------------#
{
  # Local variables
  my ($refImportedISPs, $nbrISP) = @_;
  my @newISPs;
  # Cancel button
  $SIG{'KILL'} = sub {
    # Sort grid
    $winDB->DBGrid->SortCells(0, 1, \&sortIP);
    $winDB->DBGrid->Refresh();
    # Status bar
    $nbrISP = $winDB->DBGrid->GetRows() - 1;
    $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP");
    # Turn off progress bar
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    &winPb_Terminate;
    $winDB->ChangeCursor($ARROW);
    threads->exit();
  };
  # Turn on progress bar
  $winPb->Center($winDB);
  $winPb->Show();
  $winPb->lblPbCurr->Text('');
  $winPb->lblCount->Text('');
  $winDB->Disable();
  $winDB->ChangeCursor($HOURGLASS);
  # Convert IP range
  # To Fields: 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
  while (my $isp = shift @{$refImportedISPs}) {
    my @fields = split(/\t/, $isp);
    # IPv4
    if      ($fields[0] =~ /^([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})\-/) {
      my ($ipStart,$ipEnd) = split(/\-/, $fields[0]);
      push(@newISPs, "IPv4\t$ipStart\t$ipEnd\t$fields[1]\t$fields[2]\t$fields[3]");
    # IPv6
    } elsif ($fields[0] =~ /^$IPv6_re\-/) {
      my ($ipStart,$ipEnd) = split(/\-/, $fields[0]);
      my $cidr = Net::CIDR::range2cidr("$ipStart\-$ipEnd");
      push(@newISPs, "IPv6\t$cidr\tNULL\t$fields[1]\t$fields[2]\t$fields[3]");
    }
  }
  # Update DB
  $winPb->lblPbCurr->Text($STR{'importingWhoisData'});
  my ($nbrAdd, $nbrModif) = &feedWhoisDatabase(\@newISPs, $nbrISP);
  # Refresh grid
  $winDB->DBGrid->AutoSizeColumns();
  $winDB->DBGrid->ExpandColumnsToFit();
  $winDB->DBGrid->SetListMode();
  $winDB->DBGrid->ScrollPos(1,0);
  $winDB->DBGrid->SortCells(0, 1, \&sortIP);
  $winDB->DBGrid->Refresh();
  # Status bar
  $nbrISP = $winDB->DBGrid->GetRows() - 1;
  $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP | $STR{'numberISP'} $STR{'added'}: $nbrAdd | $STR{'numberISP'} $STR{'modified'}: $nbrModif");
  # Turn off progress bar
  $winPb->lblPbCurr->Text('');
  $winPb->lblCount->Text('');
  $winPb->pbWinPb->SetPos(0);
  &winPb_Terminate;
  $winDB->ChangeCursor($ARROW);
  
}  #--- End importWhoisDB

#--------------------------#
sub feedWhoisDatabase
#--------------------------#
{
  # Local variables
  my ($refNewISP, $nbrISP, $refNWData) = @_;
  my $whoisDB   = $winConfig->tfDbFile->Text();
  my $nbrAdd    = 0;
  my $nbrModif  = 0;
  my $count     = 0;
  # Connect to DB
  my $dsn = "DBI:SQLite:dbname=$whoisDB";
  my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
            or Win32::GUI::MessageBox($win, $STR{'errCreatingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
  # Progress bar
  $winPb->pbWinPb->SetRange(0, $nbrISP);
  $winPb->pbWinPb->SetPos(0);
  $winPb->pbWinPb->SetStep(1);
  # Check if ISP is known
  foreach my $newISP (@{$refNewISP}) {
    my $lineInGrid;
    $count++;
    $winPb->lblCount->Text("$count / $nbrISP");
    $winPb->pbWinPb->StepIt();
    if ($newISP) {
      my $key = $newISP;
      chomp($newISP);
      my @fieldsNewISP = split(/\t/, $newISP); # Fields: 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
      # If known ISP (same range), keep the newer
      my $response;
      if    ($fieldsNewISP[0] eq 'IPv4') { $response = &checkISP_IPv4(\$dbh, $fieldsNewISP[1], $fieldsNewISP[2]); }
      elsif ($fieldsNewISP[0] eq 'IPv6') { $response = &checkISP_IPv6(\$dbh, $fieldsNewISP[1]); }
      # Fields($response): 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
      if ($response) {
        my $newer = &newerISP($newISP, $response);
        # $newISP is newer
        if ($newer) {
          my @ISP2add = split(/\t/, $newISP);
          # Modify in database
          my $return = &modifyISP(\$dbh, \@ISP2add);
          if ($return) {
            $lineInGrid = &modifyISPGrid(\@ISP2add);
            $nbrModif++;
          }
          # Network whois data extracted (btnExtract2DB_Click only)
          if ($winConfig->chDBCache->Checked() and exists($$refNWData{$key}) and length($$refNWData{$key}) > 1) {
            &storeNWData($fieldsNewISP[1], $fieldsNewISP[2], \$$refNWData{$key}, $lineInGrid);
          }
        }
      }
      # ISP is unknown, add it
      else {
        my $return = &addISP(\$dbh, \@fieldsNewISP);
        if ($return) {
          $lineInGrid = &addISPGrid(\@fieldsNewISP);
          $nbrAdd++;
          # Network whois data extracted (btnExtract2DB_Click only)
          if ($winConfig->chDBCache->Checked() and exists($$refNWData{$key}) and length($$refNWData{$key}) > 1) {
            &storeNWData($fieldsNewISP[1], $fieldsNewISP[2], \$$refNWData{$key}, $lineInGrid);
          }
        }
      }
    }
  }
  $dbh->disconnect();
  return($nbrAdd, $nbrModif);

}  #--- End feedWhoisDatabase

#--------------------------#
sub btnExportDB_Click
#--------------------------#
{
  # Local variables
  my $whoisDB = $winConfig->tfDbFile->Text();
  # Show SaveFileWindow
  my $file = Win32::GUI::GetSaveFileName( -owner            => $winDB                     ,
                                          -title            => $STR{'btnExportDBTip'}.':' ,
                                          -file             => 'ISPdb.txt'                ,
                                          -defaultextension => 'txt'                      ,
                                          -createprompt     => 1                          ,
                                          -explorer         => 1                          , );
  if ($file) {
    $THR = threads->create(sub {
      # Thread 'cancellation' signal handler
      $SIG{'KILL'} = sub {
        &winPb_Terminate;
        $winDB->ChangeCursor($ARROW);
        threads->exit();
      };
      # Connect to DB
      my $dsn = "DBI:SQLite:dbname=$whoisDB";
      my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
                or Win32::GUI::MessageBox($win, $STR{'errCreatingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      # Count number of ISP
      # Database: table = WHOIS_DB, Fields = range_s, range_e, isp, country, date
      my $allIPv4 = $dbh->selectall_arrayref("SELECT * FROM WHOIS_DB ORDER BY range_s ASC");
      my $allIPv6 = $dbh->selectall_arrayref("SELECT * FROM WHOIS_DB_6 ORDER BY ipv6_range ASC");
      my @all = (@$allIPv4, @$allIPv6);
      my $nbrISP = scalar(@all);
      # Show progress window
      $winDB->ChangeCursor($HOURGLASS);
      $winPb->lblPbCurr->Text($STR{'exportingWhoisDB'});
      $winPb->lblCount->Text("0 / $nbrISP");
      $winPb->pbWinPb->SetRange(0, $nbrISP);
      $winPb->pbWinPb->SetPos(0);
      $winPb->pbWinPb->SetStep(1);
      $winPb->Center($winDB);
      $winPb->Show();
      $winDB->Disable();
      $winDB->ChangeCursor($HOURGLASS);
      # Export DB
      &exportWhoisDB($file, \@all, $nbrISP);
      $dbh->disconnect();
      # Message
      $winDB->ChangeCursor($ARROW);
      &winPb_Terminate;
      Win32::GUI::MessageBox($winDB, $STR{'exportSucess'}, "XL-Whois $VERSION", 0x40040);
    });
  }
  return(1);
  
}  #--- End btnExportDB_Click

#--------------------------#
sub exportWhoisDB
#--------------------------#
{
  # Local variables
  my ($DBFile, $refData, $nbrISP) = @_;
  my $i = 0;
  # Open and write data to file
  open my $db_export, '>', $DBFile or Win32::GUI::MessageBox($win, $STR{'errWriting'}.$!, $STR{'error'}, 0x40010);
  foreach my $row (@$refData) {
    my (@fields) = @$row;
    my $str;
    my $ipStart;
    my $ipEnd;
    my $i;
    # Convert IPv4 addresses
    if ($fields[0] !~ /\:/) {
      $ipStart = join '.', unpack 'C4', pack 'N', $fields[0];
      $ipEnd   = join '.', unpack 'C4', pack 'N', $fields[1];
      $i = 2;
    # Convert IPv6 cidr to range
    } else {
      ($ipStart, $ipEnd) = split(/\-/, (Net::CIDR::cidr2range($fields[0]))[0]);
      $i = 1;
    }
    # Convert date
    my $dateStr = &time2DateLong($fields[$i+2]);
    # Display progress
    $winPb->lblPbCurr->Text("$STR{'exporting'} [$ipStart, $ipEnd]");
    # Save entry to file
    $str .= "$ipStart\-$ipEnd\t";
    $str .= "$fields[$i]\t$fields[$i+1]\t$dateStr";
    print $db_export "$str\n";
    $i++;
    # Display progress and refresh
    $winPb->lblCount->Text("$i / $nbrISP");
    $winPb->pbWinPb->StepIt();
  }
  close($db_export);
  
}  #--- End exportWhoisDB

#--------------------------#
sub btnExtract2DB_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'errProcessRun'},$STR{'error'},0x40010);
  } else {
    # Show OpenFile dialog window
    my @target = Win32::GUI::GetOpenFileName( -owner         => $winDB                    ,
                                              -title         => $STR{'selectFileExtract'} ,
                                              -filemustexist => 1                         ,
                                              -multisel      => 1                         ,
                                              -explorer      => 1                         , );
    # List the target files, must be readable
    my @listFiles;
    my $target = shift(@target);
    # No file or too much selected files
    if (!$target) {
      Win32::GUI::MessageBox($win, $STR{'errFileSelectedMax'},$STR{'error'},0x40010);
    } else {
      # Multiple selection
      if (-d $target) {
        foreach (@target) {
          my $filePath = "$target\\$_";
          if (-T $filePath) { push(@listFiles, $filePath); }
        }
      # Single selection
      } else {
        if (-T $target) { push(@listFiles, $target); }
      }
    }
    my $nbrFiles = @listFiles;
    if ($nbrFiles > 0) {
      $THR = threads->create(sub {
        # Thread 'cancellation' signal handler
        $SIG{'KILL'} = sub {
          &winPb_Terminate;
          $winDB->ChangeCursor($ARROW);
          threads->exit();
        };
        # Show progress window
        $winDB->ChangeCursor($HOURGLASS);
        $winPb->lblPbCurr->Text($STR{'extractingFiles'});
        $winPb->lblCount->Text("0 / $nbrFiles");
        $winPb->pbWinPb->SetRange(0, $nbrFiles);
        $winPb->pbWinPb->SetPos(0);
        $winPb->pbWinPb->SetStep(1);
        $winPb->Center($win);
        $winPb->Show();
        $winDB->Disable();
        # Extract ISP data from each files
        my $count = 0;
        my @newISP;
        my %NWData;
        foreach my $file (@listFiles) {
          $count++;
          $winPb->lblCount->Text("$count / $nbrFiles");
          my $refExtractedISP = &extractISPData($file);
          foreach my $ISP (keys %{$refExtractedISP}) {
            push(@newISP, $ISP);
            if (length($$refExtractedISP{$ISP}) > 1) {
              $NWData{$ISP} = $$refExtractedISP{$ISP};
            }
          }
          $winPb->pbWinPb->StepIt();
        }
        # Update DB
        $winPb->lblPbCurr->Text($STR{'updatingDB'});
        my $nbrISP = @newISP;
        my ($nbrAdd, $nbrModif) = &feedWhoisDatabase(\@newISP, $nbrISP, \%NWData);
        # Refresh grid
        $winDB->DBGrid->AutoSizeColumns();
        $winDB->DBGrid->ExpandColumnsToFit();
        $winDB->DBGrid->SetListMode();
        $winDB->DBGrid->ScrollPos(1,0);
        $winDB->DBGrid->SortCells(0, 1, \&sortIP);
        $winDB->DBGrid->Refresh();
        # Status bar
        $nbrISP = $winDB->DBGrid->GetRows() - 1;
        $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP | $STR{'numberISP'} $STR{'added'}: $nbrAdd | $STR{'numberISP'} $STR{'modified'}: $nbrModif");
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        &winPb_Terminate;
        $winDB->ChangeCursor($ARROW);
      });
    }
  }
  
}  #--- End btnExtract2DB_Click

#--------------------------#
sub btnValidDB_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'errProcessRun'},$STR{'error'},0x40010);
  } else {
    # Display Analyse Window
    $winDB->Disable();
    $winAWD->Center($win);
    $winAWD->Show();
    # Progress
    my $nbrISP = $winDB->DBGrid->GetRows() - 1;
    $winAWD->pbWinPb->SetRange(0, $nbrISP);
    $winAWD->pbWinPb->SetPos(0);
    $winAWD->pbWinPb->SetStep(1);
    $NBR_DELETED_ISP = 0;
    $ANALYSIS_QUEUE = new Thread::Queue;
    $ANALYSIS_QUEUE->enqueue('start');
    $THR = threads->new(\&validWhoisDB);
  }

}  #--- End btnValidDB_Click

#--------------------------#
sub validWhoisDB
#--------------------------#
{
  $SIG{'KILL'} = sub { threads->exit(); }; # Cancel button
  $winDB->ChangeCursor($HOURGLASS);
  # Analyse each ISP starting from the end
  # IPv6 must be ignored in this function
  while (my $lastISP = $ANALYSIS_QUEUE->dequeue) {
    if ($lastISP eq 'start') { $lastISP = 0; }
    my $nbrISP = $winDB->DBGrid->GetRows();
    my $i      = $lastISP + 1;
    $winAWD->pbWinPb->SetPos($i);
    while ($i < $nbrISP) {
      my $range_s = $winDB->DBGrid->GetCellText($i, 0);
      # IPv6 must be ignored in this function
      if ($range_s =~ /\./) {
        my $range_e = $winDB->DBGrid->GetCellText($i, 1);
        my $isp     = $winDB->DBGrid->GetCellText($i, 2);
        my $country = $winDB->DBGrid->GetCellText($i, 3);
        my $date    = $winDB->DBGrid->GetCellText($i, 4);
        # Fields: 0 = ip start, 1 = ip end, 2 = ISP name, 3 = country, 4 = date
        $winAWD->lblPbCurr->Text("$STR{'analysing'}: $range_s-$range_e");
        my $curr       = $i;
        my $realNbrISP = $nbrISP - 1;
        $winAWD->lblWinPb->Text("$curr / $realNbrISP");
        # If a range is included
        my @rangesIn;
        for (my $j = $i; $j < $nbrISP; $j++) {
          if ($winDB->DBGrid->GetCellText($j, 0)) {
            my $range_s2cmp = $winDB->DBGrid->GetCellText($j, 0);
            # IPv6 must be ignored in this function
            if ($range_s2cmp =~ /\./) {
              my $range_e2cmp = $winDB->DBGrid->GetCellText($j, 1);
              my $isp2cmp     = $winDB->DBGrid->GetCellText($j, 2);
              my $country2cmp = $winDB->DBGrid->GetCellText($j, 3);
              my $date2cmp    = $winDB->DBGrid->GetCellText($j, 4);
              # If compared range is included in analysed range, keep it
              my $range_sInt     = unpack 'N', pack 'C4', split '\.', $range_s;
              my $range_eInt     = unpack 'N', pack 'C4', split '\.', $range_e;
              my $range_s2cmpInt = unpack 'N', pack 'C4', split '\.', $range_s2cmp;
              my $range_e2cmpInt = unpack 'N', pack 'C4', split '\.', $range_e2cmp;
              my $included       = &inRange($range_sInt, $range_eInt, $range_s2cmpInt, $range_e2cmpInt);
              # Compared range is in the parent range
              if ($included == 2) {
                my $ISP2cmpStr = "$range_s2cmp|$range_e2cmp|$isp2cmp|$country2cmp|$date2cmp";
                push(@rangesIn, $ISP2cmpStr);
              }
              # If start IP to compare is greater than the end IP to check, we overstep the ranges
              elsif ($range_s2cmpInt >= $range_eInt) { last; }
            }
          }
        }
        my $nbrRangesIn = @rangesIn;
        if ($nbrRangesIn > 0) {
          $winAWD->GridISPWide->SetRows(2);
          $winAWD->GridISPWide->SetCellText( 0, 1, $STR{'cbFilterField1'});
          $winAWD->GridISPWide->SetCellText( 0, 2, $STR{'cbFilterField2'});
          $winAWD->GridISPWide->SetCellText( 0, 3, $STR{'cbFilterField3'});
          $winAWD->GridISPWide->SetCellText( 0, 4, $STR{'cbFilterField4'});
          $winAWD->GridISPWide->SetCellText( 0, 5, $STR{'date'});
          $winAWD->GridISPWide->SetCellText( 1, 0, ""         );
          $winAWD->GridISPWide->SetCellType( 1, 0, GVIT_CHECK );
          $winAWD->GridISPWide->SetCellCheck(1, 0, 1);
          $winAWD->GridISPWide->SetCellText( 1, 1, $range_s);
          $winAWD->GridISPWide->SetCellText( 1, 2, $range_e);
          $winAWD->GridISPWide->SetCellText( 1, 3, $isp);
          $winAWD->GridISPWide->SetCellText( 1, 4, $country);
          $winAWD->GridISPWide->SetCellText( 1, 5, $date);
          $winAWD->GridISPin->SetRows($nbrRangesIn+1);
          $winAWD->GridISPin->SetCellText( 0, 1, $STR{'cbFilterField1'});
          $winAWD->GridISPin->SetCellText( 0, 2, $STR{'cbFilterField2'});
          $winAWD->GridISPin->SetCellText( 0, 3, $STR{'cbFilterField3'});
          $winAWD->GridISPin->SetCellText( 0, 4, $STR{'cbFilterField4'});
          $winAWD->GridISPin->SetCellText( 0, 5, $STR{'date'});
          my $i = 1;
          foreach my $ispStr (@rangesIn) {
            my (@fields) = split(/\|/, $ispStr);
            $winAWD->GridISPin->SetCellText( $i, 0, "");
            $winAWD->GridISPin->SetCellType( $i, 0, GVIT_CHECK);
            $winAWD->GridISPin->SetCellCheck($i, 0, 1);
            $winAWD->GridISPin->SetCellText( $i, 1, $fields[0]);
            $winAWD->GridISPin->SetCellText( $i, 2, $fields[1]);
            $winAWD->GridISPin->SetCellText( $i, 3, $fields[2]);
            $winAWD->GridISPin->SetCellText( $i, 4, $fields[3]);
            $winAWD->GridISPin->SetCellText( $i, 5, $fields[4]);
            $i++;
          }
          $winAWD->GridISPWide->AutoSize();
          $winAWD->GridISPin->AutoSize();
          if ($winAWD->GridISPWide->GetColumnWidth(1) > $winAWD->GridISPin->GetColumnWidth(1)) {
            $winAWD->GridISPin->SetColumnWidth(1, $winAWD->GridISPWide->GetColumnWidth(1));
          } else { $winAWD->GridISPWide->SetColumnWidth(1, $winAWD->GridISPin->GetColumnWidth(1)); }
          if ($winAWD->GridISPWide->GetColumnWidth(2) > $winAWD->GridISPin->GetColumnWidth(2)) {
            $winAWD->GridISPin->SetColumnWidth(2, $winAWD->GridISPWide->GetColumnWidth(2));
          } else { $winAWD->GridISPWide->SetColumnWidth(2, $winAWD->GridISPin->GetColumnWidth(2)); }
          if ($winAWD->GridISPWide->GetColumnWidth(3) > $winAWD->GridISPin->GetColumnWidth(3)) {
            $winAWD->GridISPin->SetColumnWidth(3, $winAWD->GridISPWide->GetColumnWidth(3));
          } else { $winAWD->GridISPWide->SetColumnWidth(3, $winAWD->GridISPin->GetColumnWidth(3)); }
          if ($winAWD->GridISPWide->GetColumnWidth(4) > $winAWD->GridISPin->GetColumnWidth(4)) {
            $winAWD->GridISPin->SetColumnWidth(4, $winAWD->GridISPWide->GetColumnWidth(4));
          } else { $winAWD->GridISPWide->SetColumnWidth(4, $winAWD->GridISPin->GetColumnWidth(4)); }
          if ($winAWD->GridISPWide->GetColumnWidth(5) > $winAWD->GridISPin->GetColumnWidth(5)) {
            $winAWD->GridISPin->SetColumnWidth(5, $winAWD->GridISPWide->GetColumnWidth(5));
          } else { $winAWD->GridISPWide->SetColumnWidth(5, $winAWD->GridISPin->GetColumnWidth(5)); }
          $winAWD->GridISPWide->ExpandLastColumn();
          $winAWD->GridISPin->ExpandLastColumn();
          last;
        }
      }
      $winAWD->pbWinPb->StepIt();
      $i++;
    } # End browsing rows
    if ($i == $nbrISP) {
      # Refresh grid
      $winDB->DBGrid->AutoSizeColumns();
      $winDB->DBGrid->ExpandColumnsToFit();
      $winDB->DBGrid->SetListMode();
      $winDB->DBGrid->ScrollPos(1,0);
      $winDB->DBGrid->SortCells(0, 1, \&sortIP);
      $winDB->DBGrid->Refresh();
      # Status bar
      $nbrISP = $winDB->DBGrid->GetRows() - 1;
      $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP | $STR{'numberISP'} $STR{'deleted'}: $NBR_DELETED_ISP");
      # Turn off progress bar
      $winAWD->lblPbCurr->Text('');
      $winAWD->lblWinPb->Text('');
      $winAWD->pbWinPb->SetPos(0);
      &winAWD_Terminate;
      $winDB->ChangeCursor($ARROW);
      threads->exit();
    }
  } # End queue

}  #--- End validWhoisDB

#--------------------------#
sub GridISPWide_DblClick
#--------------------------#
{
  # Local variables
  my $row = shift;
  my $selStatus = $winAWD->GridISPWide->GetCellCheck($row, 0);
  if (!$selStatus) { $winAWD->GridISPWide->SetCellCheck($row, 0, 1); } # Check
  else             { $winAWD->GridISPWide->SetCellCheck($row, 0, 0); } # Uncheck
  return(1);

}  #--- End GridISPWide_DblClick

#--------------------------#
sub GridISPin_DblClick
#--------------------------#
{
  # Local variables
  my $row = shift;
  my $selStatus = $winAWD->GridISPin->GetCellCheck($row, 0);
  if (!$selStatus) { $winAWD->GridISPin->SetCellCheck($row, 0, 1); } # Check
  else             { $winAWD->GridISPin->SetCellCheck($row, 0, 0); } # Uncheck
  return(1);

}  #--- End GridISPin_DblClick

#--------------------------#
sub btnAWDNext_Click
#--------------------------#
{
  # List of entries to delete
  my @listRanges;
  my $nbrDeleted = 0;
  if ($winAWD->GridISPWide->GetCellCheck(1, 0) == 0) {
    my $range_s = $winAWD->GridISPWide->GetCellText(1, 1);
    my $range_e = $winAWD->GridISPWide->GetCellText(1, 2);
    push(@listRanges, "$range_s\-$range_e");
  }
  my $i = 1;
  while ($i < $winAWD->GridISPin->GetRows()) {
    if ($winAWD->GridISPin->GetCellCheck($i, 0) == 0) {
      my $range_s = $winAWD->GridISPin->GetCellText($i, 1);
      my $range_e = $winAWD->GridISPin->GetCellText($i, 2);
      push(@listRanges, "$range_s\-$range_e");
      $nbrDeleted++
    }
    $i++;
  }
  # Delete ISP
  if (scalar(@listRanges) > 0) {
    # Connect to DB
    my $whoisDB = $winConfig->tfDbFile->Text();
    my $dsn = "DBI:SQLite:dbname=$whoisDB";
    my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
              or Win32::GUI::MessageBox($win, $STR{'errCreatingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
    # Delete from database
    foreach my $isp2del (@listRanges) {
      my ($ipStart2del, $ipEnd2del) = split(/\-/, $isp2del);
      my $return = &deleteISP_IPv4(\$dbh, $ipStart2del, $ipEnd2del);
      if ($return) {
        # Delete in the grid
        if ($return) { &deleteISPGrid(0, $ipStart2del, $ipEnd2del); }
        $NBR_DELETED_ISP++;
      }
    }
    $dbh->disconnect();
  }
  # Row number of the last processed entry
  my $progress = $winAWD->lblWinPb->Text();
  my $lastISP  = (split(/ \/ /, $progress))[0];
  $lastISP    += $nbrDeleted;
  $ANALYSIS_QUEUE->enqueue($lastISP);

}  #--- End btnAWDNext_Click

#--------------------------#
sub btnAWDCancel_Click
#--------------------------#
{
  # Stop requests
  if ($THR) {
    $ANALYSIS_QUEUE->end();
    $winAWD->lblPbCurr->Text($STR{'cancelling'});
    $winAWD->lblWinPb->Text('');
    &winAWD_Terminate;
    $winDB->ChangeCursor($ARROW);
    if ($THR and $THR->is_running()) { $THR->kill('KILL')->detach(); }
  } else { &winAWD_Terminate; }
  return(1);
  
}  #--- End btnAWDCancel_Click

#--------------------------#
sub winAWD_Terminate
#--------------------------#
{
  $winAWD->Hide();
  $win->Enable();
  $winDB->Enable();
  $winDB->SetForegroundWindow();
  return(1);
  
}  #--- End winAWD_Terminate

#--------------------------#
sub tfSearchDB_Change
#--------------------------#
{
  # Local variables
  my $searchStr   = $winDB->tfSearchDB->Text();
  my $nbrStrChars = length($searchStr);
  # Activate search button
  if ($searchStr) {
    $winDB->btnSearchDB->Enable();
    $winDB->btnSearchDB_p->Disable();
    $winDB->btnSearchDB_n->Disable();
  } else {
    $winDB->DBGrid->SetSelectedCellRange(0, 0, 0, 4);
    $winDB->DBGrid->EnsureCellVisible(0,0);
    $winDB->btnSearchDB->Disable();
    $winDB->btnSearchDB_p->Disable();
    $winDB->btnSearchDB_n->Disable();
  }
  # Select line with partial IP
  if ($searchStr =~ /^([0-9\.]+)/) {
    $winDB->ChangeCursor($HOURGLASS);
    my ($ip) = $1;
    my ($nMinRow, $nMinCol, $nMaxRow, $nMaxCol) = $winDB->DBGrid->GetSelectedCellRange();
    my $rang = 0;
    if ($nbrStrChars > $NBR_CHARS) { $rang = $nMinRow; }
    $NBR_CHARS = $nbrStrChars;
    for (my $i = $rang; $i < $winDB->DBGrid->GetRows(); $i++) {
      my $range_s = $winDB->DBGrid->GetCellText($i, 0);
      if ($range_s =~ /^$ip/) {
        $winDB->DBGrid->SetSelectedCellRange($i, 0, $i, 4);
        $winDB->DBGrid->EnsureCellVisible($i,0);
        last;
      }
      my ($searchIP_s, $searchIP_cmp);
      if ($searchStr =~ /^([0-9]+)\./) { $searchIP_s   = $1; }
      if ($range_s   =~ /^([0-9]+)\./) { $searchIP_cmp = $1; }
      if ($searchIP_s and $searchIP_cmp) {
        if ($searchIP_cmp gt $searchIP_s) { last; }
      }
    }
    $winDB->ChangeCursor($ARROW);
  }

}  #--- End tfSearchDB_Change

#--------------------------#
sub btnSearchDB_Click
#--------------------------#
{
  # Local variables
  my $searchStr = $winDB->tfSearchDB->Text();
  my $found     = 0;
  # Search IPv4
  if ($searchStr =~ /^([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})$/) {
    my $searchIP = $1;
    $winDB->ChangeCursor($HOURGLASS);
    for (my $i = 1; $i < $winDB->DBGrid->GetRows(); $i++) {
      my $range_s = $winDB->DBGrid->GetCellText($i, 0);
      my $range_e = $winDB->DBGrid->GetCellText($i, 1);
      if ($range_s !~ /\:/ and
          (pack('C4', split(/\./,$searchIP)) ge pack('C4', split(/\./,$range_s))) and
          (pack('C4', split(/\./,$searchIP)) le pack('C4', split(/\./,$range_e)))) {
        $winDB->DBGrid->SetSelectedCellRange($i, 0, $i, 4);
        $winDB->DBGrid->EnsureCellVisible($i,0);
        $found = 1;
      }
    }
  # Search IPv6
  } elsif ($searchStr =~ /($IPv6_re)/) {
    my $searchIP = $1;
    for (my $i = $winDB->DBGrid->GetRows()-1; $i > 1; $i--) {
      my $range_s = $winDB->DBGrid->GetCellText($i, 0);
      if ($range_s =~ /\:/) {
        my $range_e = $winDB->DBGrid->GetCellText($i, 1);
        my $cidr = Net::CIDR::range2cidr("$range_s\-$range_e");
        if (Net::CIDR::cidrlookup($searchIP, ($cidr))) {
          $winDB->DBGrid->SetSelectedCellRange($i, 0, $i, 4);
          $winDB->DBGrid->EnsureCellVisible($i,0);
          $found = 1;
        }
      }
    }
  # Search text in ISP field
  } elsif ($searchStr) {
    $winDB->ChangeCursor($HOURGLASS);
    for (my $i = 1; $i < $winDB->DBGrid->GetRows(); $i++) {
      my $ISPGrid = $winDB->DBGrid->GetCellText($i, 2);
      if ($ISPGrid =~ /$searchStr/i) {
        $winDB->DBGrid->SetSelectedCellRange($i, 0, $i, 4);
        $winDB->DBGrid->EnsureCellVisible($i,0);
        $winDB->DBGrid->AutoSizeRows();
        $found = 1;
        $winDB->btnSearchDB_p->Enable();
        $winDB->btnSearchDB_n->Enable();
        last;
      }
    }
  }
  # If not found
  $winDB->ChangeCursor($ARROW);
  if ($found == 0) { Win32::GUI::MessageBox($win, $STR{'notFoundStr'}, $STR{'notFound'}, 0x40040); }
  
}  #--- End btnSearchDB_Click

#--------------------------#
sub btnSearchDB_p_Click
#--------------------------#
{
  # Local variables
  my $searchStr = $winDB->tfSearchDB->Text();
  my $selRow    = ($winDB->DBGrid->GetSelectedCellRange())[0];
  my $found     = 0;
  # Search in FSI field
  if ($searchStr) {
    for (my $i = $selRow-1; $i > 0; $i--) {
      my $ISPGrid = $winDB->DBGrid->GetCellText($i, 2);
      if ($ISPGrid =~ /$searchStr/i) {
        $winDB->DBGrid->SetSelectedCellRange($i, 0, $i, 4);
        $winDB->DBGrid->EnsureCellVisible($i,0);
        $winDB->DBGrid->AutoSizeRows();
        $found = 1;
        last;
      }
    }
  }
  # If not found
  $winDB->ChangeCursor($ARROW);
  if ($found == 0) { Win32::GUI::MessageBox($win, $STR{'noMoreResults'}, $STR{'searching'}, 0x40040); }

}  #--- End btnSearchDB_p_Click

#--------------------------#
sub btnSearchDB_n_Click
#--------------------------#
{
  # Local variables
  my $searchStr = $winDB->tfSearchDB->Text();
  my $selRow    = ($winDB->DBGrid->GetSelectedCellRange())[0];
  my $found     = 0;
  # Search in FSI field
  if ($searchStr) {
    for (my $i = $selRow+1; $i < $winDB->DBGrid->GetRows(); $i++) {
      my $ISPGrid = $winDB->DBGrid->GetCellText($i, 2);
      if ($ISPGrid =~ /$searchStr/i) {
        $winDB->DBGrid->SetSelectedCellRange($i, 0, $i, 4);
        $winDB->DBGrid->EnsureCellVisible($i,0);
        $winDB->DBGrid->AutoSizeRows();
        $found = 1;
        last;
      }
    }
  }
  # If not found
  $winDB->ChangeCursor($ARROW);
  if ($found == 0) { Win32::GUI::MessageBox($win, $STR{'noMoreResults'}, $STR{'searching'}, 0x40040); }

}  #--- End btnSearchDB_n_Click

#--------------------------#
sub btnFilterDB_Click
#--------------------------#
{
  $ADD_FILTER = 0;
  $winFilter->cbAddFilterOp->ResetContent();
  $winFilter->cbAddFilterOp->Disable();
  $winFilter->cbFilterField->SetCurSel(0);
  $winFilter->cbOperator->ResetContent();
  $winFilter->cbOperator->Disable();
  $winFilter->cbFilterValue->ResetContent();
  $winFilter->cbFilterValue->Disable();
  $winFilter->cbFilterValue->Show();
  $winFilter->tfFilterValue->Text('');
  $winFilter->tfFilterValue->Disable();
  $winFilter->tfFilterValue->Hide();
  $winFilter->Center($win);
  $winFilter->Show();
  $winDB->Disable();
  return(1);

}  #--- End btnFilterDB_Click

#--------------------------#
sub btnFilterDB_add_Click
#--------------------------#
{
  $ADD_FILTER = 1;
  $winFilter->cbAddFilterOp->ResetContent();
  $winFilter->cbAddFilterOp->Add('OR', 'AND');
  $winFilter->cbAddFilterOp->SetCurSel(0);
  $winFilter->cbAddFilterOp->Enable();
  $winFilter->cbFilterField->SetCurSel(0);
  $winFilter->cbOperator->ResetContent();
  $winFilter->cbOperator->Disable();
  $winFilter->cbFilterValue->ResetContent();
  $winFilter->cbFilterValue->Disable();
  $winFilter->cbFilterValue->Show();
  $winFilter->tfFilterValue->Text('');
  $winFilter->tfFilterValue->Disable();
  $winFilter->tfFilterValue->Hide();
  $winFilter->Center($win);
  $winFilter->Show();
  $winDB->Disable();
  return(1);

}  #--- End btnFilterDB_add_Click

#--------------------------#
sub cbFilterField_Change
#--------------------------#
{
  # Local variables
  my $field        = $winFilter->cbFilterField->GetCurSel();
  my %operators    = (1 => ['', $STR{'equal'}, $STR{'notEqual'}, $STR{'greater'}, $STR{'greaterEqual'}, $STR{'lower'}, $STR{'lowerEqual'}],
                      2 => ['', $STR{'equal'}, $STR{'notEqual'}, $STR{'greater'}, $STR{'greaterEqual'}, $STR{'lower'}, $STR{'lowerEqual'}],
                      3 => ['', $STR{'equal'}, $STR{'notEqual'}, $STR{'contains'}, $STR{'notContains'}],
                      4 => ['', $STR{'equal'}, $STR{'notEqual'}],
                      5 => ['', $STR{'equal'}, $STR{'notEqual'}, $STR{'greater'}, $STR{'greaterEqual'}, $STR{'lower'}, $STR{'lowerEqual'}], );
  # Possible values for field: 0 = '' (No value), 1 = 'Start IP', 2 = 'End IP', 3 = 'ISP', 4 = 'Country', 5 = 'Date'
  # Start IP
  if ($field) {
    $winFilter->cbOperator->ResetContent();
    foreach (@{$operators{$field}}) { $winFilter->cbOperator->Add($_); }
    $winFilter->cbOperator->SetCurSel(0);
    $winFilter->cbOperator->Enable();
    $winFilter->cbFilterValue->Enable();
    $winFilter->cbFilterValue->ResetContent();
    $winFilter->tfFilterValue->Enable();
    $winFilter->tfFilterValue->Text('');
    if (!$ADD_FILTER) { $winDB->tfFilterDB->Text(''); } # Reset filter
  # There is no value
  } else {
    $winFilter->cbOperator->ResetContent();
    $winFilter->cbOperator->Disable();
    $winFilter->cbFilterValue->ResetContent();
    $winFilter->cbFilterValue->Disable();
    $winFilter->cbFilterValue->Show();
    $winFilter->tfFilterValue->Text('');
    $winFilter->tfFilterValue->Disable();
    $winFilter->tfFilterValue->Hide();
  }
  
}  #--- End cbFilterField_Change

#--------------------------#
sub cbOperator_Change
#--------------------------#
{
  # Local variables
  my $addOperator = $winFilter->cbAddFilterOp->GetCurSel(); # Add operator: 0 == OR, 1 == AND
  my $field       = $winFilter->cbFilterField->GetCurSel();
  my $operator    = $winFilter->cbOperator->GetCurSel();
  # Possible values for field: 0 = '' (No value), 1 = 'Start IP', 2 = 'End IP', 3 = 'ISP', 4 = 'Country', 5 = 'Date'
  # Values of operator depend on field value
  if ($operator) {
    # Case of a simple textfield (ISP, Contains or Not contains)
    if ($field == 3 and ($operator == 3 or $operator == 4)) {
      $winFilter->btnApplyFilter->Disable;
      $winFilter->cbFilterValue->Hide();
      $winFilter->tfFilterValue->Show();
    # Case of combobox values
    } else {
      $winFilter->cbFilterValue->Show();
      $winFilter->tfFilterValue->Hide();
      my %values;
      # Gather each row value
      for (my $row = 1; $row < $winDB->DBGrid->GetRows(); $row++) {
        if ($addOperator) {
          my $rowHeight = $winDB->DBGrid->GetRowHeight($row);
          if ($rowHeight > 0) {
            my $value = $winDB->DBGrid->GetCellText($row, $field-1);
            if (!exists($values{$value})) { $values{$value} = 1; }
          }
        } else {
          my $value = $winDB->DBGrid->GetCellText($row, $field-1);
          if (!exists($values{$value})) { $values{$value} = 1; }
        }
      }
      # Fill the combobox after sort
      my @listValues;
      if ($field == 1 or $field == 2) {
        @listValues = map { $_->[0] }
                      sort { $a->[1] cmp $b->[1] }
                      map { [ $_, eval { if (/\./) { unpack 'N', pack 'C4', split '\.', $_ } else { $_ } } ]} keys %values;
      } else {
        @listValues = sort {lc($a) cmp lc($b)} keys %values;
      }
      foreach (@listValues) { $winFilter->cbFilterValue->Add($_); }
      $winFilter->cbFilterValue->SetCurSel(0);
      $winFilter->btnApplyFilter->Enable;
    }
  # No operator selected
  } else {
    $winFilter->btnApplyFilter->Disable;
    $winFilter->cbFilterValue->ResetContent();
    $winFilter->cbFilterValue->Disable();
    $winFilter->cbFilterValue->Show();
    $winFilter->tfFilterValue->Text('');
    $winFilter->tfFilterValue->Disable();
    $winFilter->tfFilterValue->Hide();
  }
  
}  #--- End cbOperator_Change
  
#--------------------------#
sub tfFilterValue_Change
#--------------------------#
{
  my $filterValue = $winFilter->tfFilterValue->Text();
  if ($filterValue) { $winFilter->btnApplyFilter->Enable;  }
  else              { $winFilter->btnApplyFilter->Disable; }
  
}  #--- End tfFilterValue_Change

#--------------------------#
sub btnApplyFilter_Click
#--------------------------#
{
  # Local variables
  my $field       = $winFilter->cbFilterField->GetCurSel(); # Field: 0 = '' (No value), 1 = 'StartIP', 2 = 'EndIP', 3 = 'ISP', 4 = 'Country', 5 = 'Date'
  my $fieldStr    = $winFilter->cbFilterField->GetString($field);
  my $operator    = $winFilter->cbOperator->GetCurSel();
  my $valueStr    = $winFilter->cbFilterValue->GetString($winFilter->cbFilterValue->GetCurSel());
  # Operator symbol
  my %operatorSymbol = (1 => ['', '==', '!=', '>', '>=', '<', '<='],
                        2 => ['', '==', '!=', '>', '>=', '<', '<='],
                        3 => ['', '==', '!=', '=~', '!~'],
                        4 => ['', '==', '!='],
                        5 => ['', '==', '!=', '>', '>=', '<', '<='], );
  my $addOperatorStr;
  my @currFilters;
  my $filterStr;
  # If Add Filter, keep the current filter
  if ($ADD_FILTER == 1) {
    my $currFilterStr  = $winDB->tfFilterDB->Text();
    $addOperatorStr = $winFilter->cbAddFilterOp->GetString($winFilter->cbAddFilterOp->GetCurSel()); # Add operator: 0 == OR, 1 == AND
    $addOperatorStr =~ s/AND/&&/;
    $addOperatorStr =~ s/OR/||/;
    $filterStr .= "$currFilterStr $addOperatorStr ";
  }
  # Case of a simple textfield (ISP, Contains or Not contains)
  if ($field == 3 and ($operator == 3 or $operator == 4)) { $valueStr = $winFilter->tfFilterValue->Text(); }
  # Filter string
  $filterStr .= "$fieldStr $operatorSymbol{$field}[$operator] \"$valueStr\"";
  # Write new filter string in filter textfield
  $winDB->tfFilterDB->Text($filterStr);
  # Load Whois Database with Filters
  &applyFilters();
  &winFilter_Terminate;

}  #--- End btnApplyFilter_Click

#--------------------------#
sub applyFilters
#--------------------------#
{
  # Local variables
  my $filterStr = $winDB->tfFilterDB->Text();
  my @filters;
  my $nbrDisplayedRow = 0;
  # Split filters
  while ($filterStr =~ /((?: && | \|\| )?[^ ]+ [^ ]+ \"[^\"]+\")/) {
    my $filter = $1;
    push(@filters, $filter);
    my $filter2rem = quotemeta($filter);
    $filterStr =~ s/$filter2rem//;
  }
  # Apply each filter
  foreach (@filters) {
    my @partFilter = split(/ /, $_);
    my $addOperator;
    my $field;
    my $operator;
    my $value;
    # Additional filter
    if ($partFilter[1] eq '&&' or $partFilter[1] eq '||') {
      $addOperator = $partFilter[1];
      $field       = $partFilter[2];
      $operator    = $partFilter[3];
      for (my $i = 4; $i < scalar(@partFilter); $i++) { $value .= "$partFilter[$i] "; }
      $value =~ s/^\"//;
      $value =~ s/\" $//;
    # First filter
    } else {
      $field       = $partFilter[0];
      $operator    = $partFilter[1];
      for (my $i = 2; $i < scalar(@partFilter); $i++) { $value .= "$partFilter[$i] "; }
      $value =~ s/^\"//;
      $value =~ s/\" $//;
    }
    # Determine column to filter
    my $col2Filter;
    if    ($field eq $STR{'cbFilterField1'}) { $col2Filter = 0; }
    elsif ($field eq $STR{'cbFilterField2'}) { $col2Filter = 1; }
    elsif ($field eq $STR{'cbFilterField3'}) { $col2Filter = 2; }
    elsif ($field eq $STR{'cbFilterField4'}) { $col2Filter = 3; }
    else                                     { $col2Filter = 4; }
    # Operator is AND, look at displayed rows
    if ($addOperator and $addOperator eq '&&') {
      # Test each row
      for (my $i = 1; $i < $winDB->DBGrid->GetRows(); $i++) {
        my $rowHeight = $winDB->DBGrid->GetRowHeight($i);
        if ($rowHeight > 0) {
          my $f2filter = $winDB->DBGrid->GetCellText($i, $col2Filter);
          if    ($operator eq '==' and $f2filter eq $value   ) { $winDB->DBGrid->SetRowHeight($i, 22); }
          elsif ($operator eq '!=' and $f2filter ne $value   ) { $winDB->DBGrid->SetRowHeight($i, 22); }
          elsif ($operator eq '>'  and $f2filter gt $value   ) { $winDB->DBGrid->SetRowHeight($i, 22); }
          elsif ($operator eq '>=' and $f2filter ge $value   ) { $winDB->DBGrid->SetRowHeight($i, 22); }
          elsif ($operator eq '<'  and $f2filter lt $value   ) { $winDB->DBGrid->SetRowHeight($i, 22); }
          elsif ($operator eq '<=' and $f2filter le $value   ) { $winDB->DBGrid->SetRowHeight($i, 22); }
          elsif ($operator eq '=~' and $f2filter =~ /$value/ ) { $winDB->DBGrid->SetRowHeight($i, 22); }
          elsif ($operator eq '!~' and $f2filter !~ /$value/ ) { $winDB->DBGrid->SetRowHeight($i, 22); }
          elsif ($operator)                                    { $winDB->DBGrid->SetRowHeight($i, 0); $nbrDisplayedRow--; }
        }
      }
    # Operator is OR, only look at hidden rows
    } elsif ($addOperator and $addOperator eq '||') {
      # Test each row
      for (my $i = 1; $i < $winDB->DBGrid->GetRows(); $i++) {
        my $rowHeight = $winDB->DBGrid->GetRowHeight($i);
        if ($rowHeight == 0) {
          my $f2filter = $winDB->DBGrid->GetCellText($i, $col2Filter);
          if    ($operator eq '==' and $f2filter eq $value   ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '!=' and $f2filter ne $value   ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '>'  and $f2filter gt $value   ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '>=' and $f2filter ge $value   ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '<'  and $f2filter lt $value   ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '<=' and $f2filter le $value   ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '=~' and $f2filter =~ /$value/ ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '!~' and $f2filter !~ /$value/ ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator)                                    { $winDB->DBGrid->SetRowHeight($i, 0); }
        }
      }
    # First filter, browse all the grid
    } else {
      # Test each row
      for (my $i = 1; $i < $winDB->DBGrid->GetRows(); $i++) {
        my $f2filter = $winDB->DBGrid->GetCellText($i, $col2Filter);
          if    ($operator eq '==' and $f2filter eq $value   ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '!=' and $f2filter ne $value   ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '>'  and $f2filter gt $value   ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '>=' and $f2filter ge $value   ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '<'  and $f2filter lt $value   ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '<=' and $f2filter le $value   ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '=~' and $f2filter =~ /$value/ ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
          elsif ($operator eq '!~' and $f2filter !~ /$value/ ) { $winDB->DBGrid->SetRowHeight($i, 22); $nbrDisplayedRow++; }
        elsif ($operator)                                                    { $winDB->DBGrid->SetRowHeight($i, 0); } 
      }
    }
  }
  $winDB->DBGrid->Refresh();
  my $nbrISP = $winDB->DBGrid->GetRows() - 1;
  $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP | $STR{'numberISP'} $STR{'displayed'}: $nbrDisplayedRow");

}  #--- End applyFilters

#--------------------------#
sub winFilter_Terminate
#--------------------------#
{
  $winFilter->Hide();
  $win->Enable();
  $winDB->Enable();
  $winDB->SetForegroundWindow();
  return(0);

}  #--- End winFilter_Terminate

#--------------------------#
sub tfFilterDB_Change
#--------------------------#
{
  my $currFilterStr = $winDB->tfFilterDB->Text();
  if ($currFilterStr) {
    $winDB->btnFilterDB_del->Enable;
    $winDB->btnFilterDB_add->Enable;
  } else {
    $winDB->btnFilterDB_del->Disable;
    $winDB->btnFilterDB_add->Disable;
  }
  
}  #--- End tfFilterDB_Change

#--------------------------#
sub btnFilterDB_del_Click
#--------------------------#
{
  $winDB->tfFilterDB->Text('');
  $ADD_FILTER = 0;
  $winDB->btnFilterDB_del->Disable;
  $winDB->btnFilterDB_add->Disable;
  # Resize Rows
  for (my $i = 1; $i < $winDB->DBGrid->GetRows(); $i++) { $winDB->DBGrid->SetRowHeight($i, 22); }
  $winDB->DBGrid->Refresh();
  my $nbrISP = $winDB->DBGrid->GetRows() - 1;
  $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP");
  
}  #--- End btnFilterDB_del_Click

#--------------------------#
sub extractISPData
#--------------------------#
{
  # Local variables
  my ($file)  = shift;
  my $c1      = 0;  # Correspond to field order in typical whois answer, $c1 >= 1 when description has been found
  my $c2      = 0;  # $c2 >= 1 if range has been found
  my $c3      = 0;  # $c3 >= 1 if cidr has been found
  my $c4      = 0;  # $c4 >= 1 if country has been found
  my @parentRange;  # Parent ranges
  my %tempNewISP;   # Temp storage
  my %newISPs;      # All ISP entries returned
  my @tempNWData;   # Storage for raw Network Whois data
  my $startPre = 0; # Indicates that we are in <pre>...</pre>
  my $i = 1;        # Incremental value, used for multiple extractions
  my $last;         # Last extracted ISP
  # Open file
  open(FILE, $file) or Win32::GUI::MessageBox($win, $STR{'errReading'}.$!, $STR{'error'}, 0x40010);
  my @tab = <FILE>;
  close(FILE);
  my ($s,$min,$h,$d,$m,$y) = (&date((stat($file))[9]))[0,1,2,3,4,5];
  my $dateFile             = "$y-$m-$d $h:$min:$s";
  # Split lines
  my @tabLines;
  foreach my $line (@tab) {
    if ($line =~ /[\r\n]/) { push(@tabLines, split(/[\r\n]/, $line)); }
    else                   { push(@tabLines, $line);                  }
  }
  # ExtractData
  foreach my $line (@tabLines) {
    if ($line =~ /<pre(?:[^>]+)?>/) { $startPre = 1; } # Start of <pre>...</pre> 
    if ($line =~ /Date \: \<strong style\=\"color\:\#0099ff\;\"\>(\d{4}\-\d{2}\-\d{2}) /) { $tempNewISP{"date-$i"}     = $1; }
    if ($line =~ /OrgName\:\s*([^\r^\n]*) ?/i                                           ) { $tempNewISP{"provider-$i"} = $1; }
    if ($line =~ /CustName\:\s*([^\r^\n]*) ?/i                                          ) { $tempNewISP{"provider-$i"} = $1; }
    if ($line =~ /^owner\:\s*([^\r^\n]*) ?/i                                            ) { $tempNewISP{"provider-$i"} = $1; }
    if ($line =~ /^descr\:\s*(\w[^\r^\n]*) ?/i and ($c2 or $c3)) { if ($c1 == 0) { $tempNewISP{"descr-$i"} = $1; $c1++; } }
    # Range IPv4
    if ($line =~ /(?:inetnum|NetRange):\s*([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\s*-\s*[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})/i) {
      $tempNewISP{"type-$i"}  = 'IPv4';
      $tempNewISP{"range-$i"} = $1;
      $c2++;
    }
    # Range IPv4 (CIDR notation, used by LACNIC)
    if ($line =~ /inetnum:\s*((?:\d{1,3}\.){1,3}\d{1,3}\/\d{1,2})/i) {
      if ($c3 == 0) {
        $tempNewISP{"type-$i"} = 'IPv4';
        $tempNewISP{"cidr-$i"} = $1;
        $c3++;
      }
    }
    if ($line =~ /^Country\:\s*(\w+) ?/i and ($c2 or $c3)) { if ($c4 == 0) { $tempNewISP{"country-$i"} = $1; $c4++; } }
    # Parent Range IPv4 (ARIN only)
    if ($line =~ /\(NET-(?:[0-9]{1,3}\-){4}[0-9]{1,3}\) (?:[0-9]{1,3}\.){3}[0-9]{1,3}\s*-\s*(?:[0-9]{1,3}\.){3}[0-9]{1,3}/) {
      push(@parentRange, $line);
    }
    # Range IPv6
    if ($line =~ /(?:inetnum|NetRange):\s*([0-9A-Fa-f\:]+\s*-\s*[0-9A-Fa-f\:]+)/i) {
      $tempNewISP{"type-$i"}  = 'IPv6';
      $tempNewISP{"range-$i"} = $1;
      $c2++;
    }
    # CIDR (necessary for IPv6, optional for IPv4)
    if ($line =~ /CIDR:\s*((?:[0-9A-Fa-f\:]+\/\d{1,3}))/i) {
      $tempNewISP{"type-$i"} = 'IPv6';
      $tempNewISP{"cidr-$i"} = $1;
      $c3++;
    }
    if ($startPre == 1) { push(@tempNWData, "$line\n"); }
    # End of <pre>...</pre>, if correspond to Network Whois data, keep it
    if ($line =~ /<\/pre>/) {
      $startPre = 0;
      if ($last) {
        $newISPs{$last} = join('', @tempNWData);
        $last = '';
      } else { # Empty temp storage
        @tempNWData = ();
      }
    }
    # Process the first ISP (if all necessary details have been found)
    if ($tempNewISP{"type-$i"} and
        ((($tempNewISP{"type-$i"} eq 'IPv4' and ($tempNewISP{"range-$i"} or $tempNewISP{"cidr-$i"})) or # Range IPv4
          ($tempNewISP{"type-$i"} eq 'IPv6' and $tempNewISP{"cidr-$i"})) and                            # Range IPv6
         ($tempNewISP{"provider-$i"} or $tempNewISP{"descr-$i"})         and                            # Description
         $tempNewISP{"country-$i"})) {                                                                  # Country
      # Post processing on IPv4 entry
      if ($tempNewISP{"type-$i"} eq 'IPv4') {
        # Convert CIDR if necessary
        if ($tempNewISP{"cidr-$i"} and !$tempNewISP{"range-$i"}) { $tempNewISP{"range-$i"} = &CIDR2Range($tempNewISP{"cidr-$i"}); }
        # If parent ISP is the same, keep the major range, keep both if different
        my $j = 0;
        my %parent;
        foreach my $parent (@parentRange) {
          my $tmpISP;
          my $tmpDesc;
          if ($tempNewISP{"provider-$i"}) { $tmpISP  = quotemeta($tempNewISP{"provider-$i"}); }
          if ($tempNewISP{"descr-$i"}   ) { $tmpDesc = quotemeta($tempNewISP{"descr-$i"});    }
          # If the same
          if (($tmpISP and $parent =~ /$tmpISP/i) or ($tmpDesc and $parent =~ /$tmpDesc/i)) {
            if ($parent =~ /((?:[0-9]{1,3}\.){3}[0-9]{1,3}) - ((?:[0-9]{1,3}\.){3}[0-9]{1,3})/) {
              my $IpStartParentRange          = $1;
              my $IpEndParentRange            = $2;
              my $IpStartIntParentRange       = unpack 'N', pack 'C4', split '\.', $IpStartParentRange;
              my $IpEndIntParentRange         = unpack 'N', pack 'C4', split '\.', $IpEndParentRange;
              my ($IpStartRange, $IpEndRange) = split(/ ?\- ?/, $tempNewISP{"range-$i"});
              my $IpStartIntRange             = unpack 'N', pack 'C4', split '\.', $IpStartRange;
              my $IpEndIntRange               = unpack 'N', pack 'C4', split '\.', $IpEndRange;
              my $compRange                   = &inRange($IpStartIntRange, $IpEndIntRange, $IpStartIntParentRange, $IpEndIntParentRange);
              if ($compRange == 1) { $tempNewISP{"range-$i"} = "$IpStartParentRange - $IpEndParentRange"; }
            }
          # If different
          } else {
            if ($parent =~ /(.+) \(NET[^\)]+\) ((?:[0-9]{1,3}\.){3}[0-9]{1,3}) - ((?:[0-9]{1,3}\.){3}[0-9]{1,3})/) {
              $parent{"type-$j"}     = 'IPv4';
              $parent{"range-$j"}    = "$2 - $3";
              $parent{"provider-$j"} = $1;
              $parent{"country-$j"}  = $tempNewISP{"country-$i"};
              if ($tempNewISP{"date-$i"}) { $parent{"date-$j"} = $tempNewISP{"date-$i"}; }
              else                        { $parent{"date-$j"} = $dateFile;          }
              my $parentISP = &formatISP(\%parent, $j);
              $newISPs{$parentISP} = 1;
              $j++;
            }
          }
        }
      }
      # Build new entries
      if ((($tempNewISP{"type-$i"} eq 'IPv4' and $tempNewISP{"range-$i"}) or
           ($tempNewISP{"type-$i"} eq 'IPv6' and $tempNewISP{"cidr-$i"})) and
          ($tempNewISP{"provider-$i"} or $tempNewISP{"descr-$i"}) and $tempNewISP{"country-$i"}) {
        if (!exists($tempNewISP{"date-$i"})) { $tempNewISP{"date-$i"} = $dateFile; }
        my $ISP2add = &formatISP(\%tempNewISP, $i);
        $newISPs{$ISP2add} = 1;
        $last = $ISP2add;
      }
      # Reset counter
      $i++;
      $c1 = 0; $c2 = 0; $c3 = 0; $c4 = 0;
    }
  }
  return(\%newISPs);
  
}  #--- End extractISPData

#--------------------------#
sub inRange
#--------------------------#
{
  # Local variables
  my($ipIntStart1, $ipIntEnd1, $ipIntStart2, $ipIntEnd2) = @_; # Parameters ex.: 24.37.0.0, 24.37.255.255, 24.37.63.0, 24.37.63.255
  my $results; # 0 = range1 == range2, 1 = range1 in range2, 2 = range2 in range1, 3 = Ranges are different
  # Check if range1 == range2
  if    (($ipIntStart1 == $ipIntStart2) and ($ipIntEnd1   == $ipIntEnd2)) { return(0); }
  # Check if range1 in range2
  elsif (($ipIntStart1 >= $ipIntStart2) and ($ipIntStart1 <= $ipIntEnd2) and
         ($ipIntEnd1   >= $ipIntStart2) and ($ipIntEnd1   <= $ipIntEnd2)) { return(1); }
  # Check if range2 in range1
  elsif (($ipIntStart2 >= $ipIntStart1) and ($ipIntStart2 <= $ipIntEnd1) and
         ($ipIntEnd2   >= $ipIntStart1) and ($ipIntEnd2   <= $ipIntEnd1)) { return(2); }
  # Ranges are different
  else { return(3); }
    
}  #--- End inRange

#--------------------------#
sub CIDR2Range
#--------------------------#
{
  # Local variables
  my ($range) = shift;
  # Convert range from CIDR to IP range (Ex.: 123.123/16 to 123.123.0.0 - 123.123.255.255)
  if ($range =~ /(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){0,3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\/[0-9]{1,2}/) {
    my($refIp, $mask) = split(/\//, $range);
    my($range_s, $range_e) = split(/\-/, (Net::CIDR::cidr2range($range))[0]);
    while ($range_s !~ /(?:[0-9]{1,3}\.){3}[0-9]{1,3}/) { $range_s .= '.0';   }
    while ($range_e !~ /(?:[0-9]{1,3}\.){3}[0-9]{1,3}/) { $range_e .= '.255'; }
    if ($range_s and $range_e) { return("$range_s - $range_e"); }
  }

}  #--- End CIDR2Range

#--------------------------#
sub formatISP
#--------------------------#
{
  # Local variables
  my ($refISP, $ind) = @_;
  my $newISP; # Ex.: IPv4\t123.123.0.0\t123.123.255.255\tProvider\tCountry\tDate
              # Ex.: IPv6\t2001:568::/29\tNULL\tProvider\tCountry\tDate
  # Format entry
  $newISP = $$refISP{"type-$ind"}; # Type: IPv4 or IPv6
  # IPv4
  if ($$refISP{"type-$ind"} eq 'IPv4') {
    $$refISP{"range-$ind"} =~ s/ //g;
    my ($ipStart, $ipEnd) = split(/\-/, $$refISP{"range-$ind"});
    $newISP .= "\t"."$ipStart\t$ipEnd";    # Range for IPv4
  # IPv6
  } else {
    $newISP .= "\t".$$refISP{"cidr-$ind"}; # CIDR for IPv6
    $newISP .= "\t".'NULL';
  }
  if ($$refISP{"provider-$ind"}) {
    $$refISP{"provider-$ind"} =~ s/&amp;/&/g;
    $$refISP{"provider-$ind"} =~ s/&quot;/\"/g;
    while ($$refISP{"provider-$ind"} =~ / $/) { chop($$refISP{"provider-$ind"}); }
    $newISP .= "\t".$$refISP{"provider-$ind"}; # Provider
  } elsif ($$refISP{"descr-$ind"}) {
    $$refISP{"descr-$ind"}        =~ s/&amp;/&/g;
    $$refISP{"descr-$ind"}        =~ s/&quot;/\"/g;
    while ($$refISP{"descr-$ind"} =~ / $/) { chop($$refISP{"descr-$ind"});       }
    $newISP .= "\t".$$refISP{"descr-$ind"};    # If no provider, descr
  }
  $newISP .= "\t".$$refISP{"country-$ind"}; # Country
  $newISP .= "\t".$$refISP{"date-$ind"};    # Date
  return($newISP);

}  #--- End formatISP

#--------------------------#
sub checkISP_IPv4
#--------------------------#
{
  # Local variables
  my ($refDbh, $ipStart, $ipEnd) = @_;
  my $ipStartInt = unpack 'N', pack 'C4', split '\.', $ipStart;
  my $ipEndInt   = unpack 'N', pack 'C4', split '\.', $ipEnd;
  my $response;
  # Check range in the database
  # Database: table = WHOIS_DB, Fields = range_s, range_e, isp, country, date
  my $sth = $$refDbh->prepare("SELECT range_s,range_e,isp,country,date from WHOIS_DB
                              WHERE $ipStartInt == range_s AND $ipEndInt == range_e");
  my $rv  = $sth->execute();
  if ($rv < 0) { Win32::GUI::MessageBox($win, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010); }
  while(my @row = $sth->fetchrow_array()) {
    my $ipStart = join '.', unpack 'C4', pack 'N', $row[0];
    my $ipEnd   = join '.', unpack 'C4', pack 'N', $row[1];
    my $dateStr = &time2DateLong($row[4]);
    $response .= "IPv4\t$ipStart\t$ipEnd\t$row[2]\t$row[3]\t$dateStr";
  }
  return($response);
  
}  #--- End checkISP_IPv4

#--------------------------#
sub checkISP_IPv6
#--------------------------#
{
  # Local variables
  my $refDbh = shift;
  my $cidr   = shift;
  my $response;
  # Check range in the database
  # Database: table = WHOIS_DB_6, Fields = ipv6_range, isp, country, date
  my $sth = $$refDbh->prepare("SELECT ipv6_range,isp,country,date from WHOIS_DB_6 WHERE ipv6_range == ?");
  my $rv  = $sth->execute(uc($cidr));
  if ($rv < 0) { Win32::GUI::MessageBox($win, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010); }
  while(my @row = $sth->fetchrow_array()) {
    my $dateStr = &time2DateLong($row[3]);
    $response .= "IPv6\t$cidr\t$row[1]\t$row[2]\t$dateStr";
  }
  return($response);
  
}  #--- End checkISP_IPv6

#--------------------------#
sub newerISP
#--------------------------#
{
  # Local variables
  my ($newISP, $response) = @_;
  # If no date, consider as older
  if (!(split(/\t/, $response))[5]) { return(1); }
  if (!(split(/\t/, $newISP))[5]  ) { return(0); }
  # Date format 2016-01-01
  my ($dateNewISP) = (split(/\t/, $newISP))[5];
  my ($dateOld)    = (split(/\t/, $response))[5];
  # Convert to unixtime
  my $time1 = str2time($dateNewISP);
  my $time2 = str2time($dateOld);
  # Compare
  if ($time1 <= $time2) { return(0); } # $newISP is older or equal
  else                  { return(1); } # $newISP is newer

}  #--- End newerISP

#--------------------------#
sub modifyISP
#--------------------------#
{
  # Local variables
  my ($refDbh, $refISP2add) = @_;
  # Fields ($refISP2add): 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
  # Modify entry in IPv4 database
  if ($$refISP2add[0] eq 'IPv4') {
    # Database: table = WHOIS_DB, Fields = range_s, range_e, isp, country, date
    my $ipStart    = $$refISP2add[1];
    my $ipEnd      = $$refISP2add[2];
    my $ipStartInt = unpack 'N', pack 'C4', split '\.', $ipStart;
    my $ipEndInt   = unpack 'N', pack 'C4', split '\.', $ipEnd;
    my $isp        = $$refISP2add[3];
    my $country    = $$refISP2add[4];
    my $dateStr    = $$refISP2add[5];
    my $time       = str2time($dateStr);
    my $sth = $$refDbh->prepare("UPDATE WHOIS_DB SET isp = ?, country = ?, date = ?
                                WHERE $ipStartInt == range_s AND $ipEndInt == range_e");
    my $rv = $sth->execute($isp, $country, $time);
    if ($rv < 0) {
      Win32::GUI::MessageBox($win, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      return(0);
    } else { return(1); }
  # Modify entry in IPv6 database
  } elsif ($$refISP2add[0] eq 'IPv6') {
    # Database: table = WHOIS_DB_6, Fields = ipv6_range, isp, country, date
    my $ipv6_range = $$refISP2add[1];
    my $isp        = $$refISP2add[3];
    my $country    = $$refISP2add[4];
    my $dateStr    = $$refISP2add[5];
    my $time       = str2time($dateStr);
    my $sth = $$refDbh->prepare("UPDATE WHOIS_DB_6 SET isp = ?, country = ?, date = ? WHERE ipv6_range == ?");
    my $rv = $sth->execute($isp, $country, $time, uc($ipv6_range));
    if ($rv < 0) {
      Win32::GUI::MessageBox($win, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      return(0);
    } else { return(1); }
  }

}  #--- End modifyISP

#--------------------------#
sub modifyISPGrid
#--------------------------#
{
  # Local variables
  my ($refISP2add) = @_;
  # Fields ($refISP2add): 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
  # Find the older ISP in Grid and modify it
  if ($$refISP2add[0] eq 'IPv4') {
    for (my $i = 1; $i < $winDB->DBGrid->GetRows(); $i++) {
      my $range_s = $winDB->DBGrid->GetCellText($i, 0);
      my $range_e = $winDB->DBGrid->GetCellText($i, 1);
      if (($$refISP2add[1] eq $range_s) and ($$refISP2add[2] eq $range_e)) {
        $winDB->DBGrid->SetCellText($i, 2, $$refISP2add[3]);
        $winDB->DBGrid->SetCellText($i, 3, $$refISP2add[4]);
        $winDB->DBGrid->SetCellText($i, 4, $$refISP2add[5]);
        return($i);
      }
    }
  } elsif ($$refISP2add[0] eq 'IPv6') {
    my ($ipStart, $ipEnd) = split(/\-/, (Net::CIDR::cidr2range($$refISP2add[1]))[0]);
    for (my $i = $winDB->DBGrid->GetRows(); $i > 1; $i--) {
      my $range_s = $winDB->DBGrid->GetCellText($i, 0);
      my $range_e = $winDB->DBGrid->GetCellText($i, 1);
      if (($ipStart eq $range_s) and ($ipEnd eq $range_e)) {
        $winDB->DBGrid->SetCellText($i, 2, $$refISP2add[3]);
        $winDB->DBGrid->SetCellText($i, 3, $$refISP2add[4]);
        $winDB->DBGrid->SetCellText($i, 4, $$refISP2add[5]);
        return($i);
      }
    }
  }

}  #--- End modifyISPGrid

#--------------------------#
sub deleteISP_IPv4
#--------------------------#
{
  # Local variables
  my ($refDbh, $ipStart, $ipEnd) = @_;
  my $ipStartInt = unpack 'N', pack 'C4', split '\.', $ipStart;
  my $ipEndInt   = unpack 'N', pack 'C4', split '\.', $ipEnd;
  my $response;
  # Delete entry in DB
  # Database: table = WHOIS_DB, Fields = range_s, range_e, isp, country, date
  my $sth = $$refDbh->prepare("DELETE from WHOIS_DB where $ipStartInt == range_s AND $ipEndInt == range_e");
  my $rv = $sth->execute();
  if ($rv < 0) {
    Win32::GUI::MessageBox($win, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
    return(0);
  } else { return(1); }
  
}  #--- End deleteISP_IPv4

#--------------------------#
sub deleteISP_IPv6
#--------------------------#
{
  # Local variables
  my ($refDbh, $ipStart, $ipEnd) = @_;
  my $cidr = Net::CIDR::range2cidr("$ipStart\-$ipEnd");
  my $response;
  # Delete entry in DB
  # Database: table = WHOIS_DB_6, Fields = ipv6_range, isp, country, date
  my $sth = $$refDbh->prepare("DELETE from WHOIS_DB_6 WHERE ipv6_range == ?");
  my $rv  = $sth->execute(uc($cidr));
  if ($rv < 0) {
    Win32::GUI::MessageBox($win, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
    return(0);
  } else { return(1); }
  
}  #--- End deleteISP_IPv6

#--------------------------#
sub deleteISPGrid
#--------------------------#
{
  # Local variables
  my ($noRow, $ipStart, $ipEnd) = @_;
  # Find the ISP in grid and delete
  for (my $i = $noRow; $i < $winDB->DBGrid->GetRows(); $i++) {
    my $range_s = $winDB->DBGrid->GetCellText($i, 0);
    if ($ipStart eq $range_s) {
      my $range_e = $winDB->DBGrid->GetCellText($i, 1);
      if ($ipEnd eq $range_e) {
        $winDB->DBGrid->DeleteRow($i);
        last;
      }
    }
  }

}  #--- End deleteISPGrid

#--------------------------#
sub addISP
#--------------------------#
{
  # Local variables
  my ($refDbh, $refNewISP) = @_;
  # Fields ($refNewISP): 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
  # Add entry in IPv4 database
  if ($$refNewISP[0] eq 'IPv4') {
    # Database: table = WHOIS_DB, Fields = range_s, range_e, isp, country, date
    my $sth = $$refDbh->prepare("insert into WHOIS_DB (range_s,range_e,isp,country,date) values(?,?,?,?,?)");
    my $ipStart    = $$refNewISP[1];
    my $ipEnd      = $$refNewISP[2];
    my $ipStartInt = unpack 'N', pack 'C4', split '\.', $ipStart;
    my $ipEndInt   = unpack 'N', pack 'C4', split '\.', $ipEnd;
    my $isp        = $$refNewISP[3];
    my $country    = $$refNewISP[4];
    my $dateStr    = $$refNewISP[5];
    my $time       = str2time($dateStr);
    my $rv = $sth->execute($ipStartInt, $ipEndInt, $isp, $country, $time);
    if ($rv < 0) {
      Win32::GUI::MessageBox($win, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      return(0);
    } else { return(1); }
  # Add entry in IPv6 database
  } elsif ($$refNewISP[0] eq 'IPv6') {
    # Database: table = WHOIS_DB_6, Fields = ipv6_range, isp, country, date
    my $sth = $$refDbh->prepare("insert into WHOIS_DB_6 (ipv6_range,isp,country,date) values(?,?,?,?)");
    my $ipv6_range = uc($$refNewISP[1]);
    my $isp        = $$refNewISP[3];
    my $country    = $$refNewISP[4];
    my $dateStr    = $$refNewISP[5];
    my $time       = str2time($dateStr);
    my $rv = $sth->execute($ipv6_range, $isp, $country, $time);
    if ($rv < 0) {
      Win32::GUI::MessageBox($win, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      return(0);
    } else { return(1); }
  }

}  #--- End addISP

#--------------------------#
sub checkIP_WhoisDB_IPv4
#--------------------------#
{
  # Local variables
  my ($ip, $refDbh) = @_;
  my $ipInt = unpack 'N', pack 'C4', split '\.', $ip;
  my $isp;
  my $country;
  my $date;
  my $interMin = 4294967295;
  # Check if IP address fit any range in database
  my $sth = $$refDbh->prepare("SELECT range_s,range_e,isp,country,date from WHOIS_DB
                              WHERE $ipInt >= range_s AND $ipInt <= range_e");
  my $rv  = $sth->execute();
  if ($rv < 0) { Win32::GUI::MessageBox($win, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010); }
  # Select the best answer (smaller range)
  my $refAllRows = $sth->fetchall_arrayref();
  foreach my $refRow (@{$refAllRows}) {
    my $inter = $$refRow[1] - $$refRow[0];
    if ($inter < $interMin) {
      $interMin = $inter;
      $isp     = $$refRow[2];
      $country = $$refRow[3];
      $date    = $$refRow[4];
    }
  }
  return($isp, $country, $date);

}  #--- End checkIP_WhoisDB_IPv4

#--------------------------#
sub checkIP_WhoisDB_IPv6
#--------------------------#
{
  # Local variables
  my ($ip, $refDbh) = @_;
  # Check if IP address fit any range in database
  my $all = $$refDbh->selectall_arrayref("SELECT * FROM WHOIS_DB_6");
  foreach my $row (@$all) {
    my $cidr = @$row[0];
    if (Net::CIDR::cidrlookup($ip, ($cidr))) {
      return(@$row[1], @$row[2], @$row[3]);
    }
  }

}  #--- End checkIP_WhoisDB_IPv6

#--------------------------#
sub checkRange_WhoisDB_IPv4
#--------------------------#
{
  # Local variables
  my ($ip, $refDbh) = @_;
  my $ipInt = unpack 'N', pack 'C4', split '\.', $ip;
  my $range_s;
  my $range_e;
  my $interMin = 4294967295;
  # Check if IP address fit any range in database
  my $sth = $$refDbh->prepare("SELECT range_s,range_e from WHOIS_DB
                              WHERE $ipInt >= range_s AND $ipInt <= range_e");
  my $rv  = $sth->execute();
  if ($rv < 0) { Win32::GUI::MessageBox($win, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010); }
  # Select the best answer (smaller range)
  my $refAllRows = $sth->fetchall_arrayref();
  foreach my $refRow (@{$refAllRows}) {
    my $inter = $$refRow[1] - $$refRow[0];
    if ($inter < $interMin) {
      $interMin = $inter;
      $range_s = join '.', unpack 'C4', pack 'N', $$refRow[0];
      $range_e = join '.', unpack 'C4', pack 'N', $$refRow[1];
    }
  }
  if ($range_s and $range_e) { return($range_s, $range_e); }
  else                       { return(undef   , undef);    }

}  #--- End checkRange_WhoisDB_IPv4

#--------------------------#
sub checkRange_WhoisDB_IPv6
#--------------------------#
{
  # Local variables
  my ($ip, $refDbh) = @_;
  # Check if IP address fit any range in database
  my $all = $$refDbh->selectall_arrayref("SELECT ipv6_range FROM WHOIS_DB_6");
  foreach my $row (@$all) {
    my $cidr = @$row[0];
    if (Net::CIDR::cidrlookup($ip, ($cidr))) {
      my ($range_s, $range_e) = split(/\-/, (Net::CIDR::cidr2range($cidr))[0]);
      return($range_s, $range_e);
    }
  }
  return(undef, undef); # Not found

}  #--- End checkRange_WhoisDB_IPv6

#--------------------------#
sub addISPGrid
#--------------------------#
{
  # Local variables
  my ($refNewISP) = @_;
  # Fields ($refNewISP): 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
  # Add entry in grid (IPv4)
  if ($$refNewISP[0] eq 'IPv4') {
    if (my $newLine = $winDB->DBGrid->InsertRow($$refNewISP[0], -1)) {
      $winDB->DBGrid->SetCellText($newLine, 0, $$refNewISP[1]);
      $winDB->DBGrid->SetCellText($newLine, 1, $$refNewISP[2]);
      $winDB->DBGrid->SetCellText($newLine, 2, $$refNewISP[3]);
      $winDB->DBGrid->SetCellText($newLine, 3, $$refNewISP[4]);
      $winDB->DBGrid->SetCellText($newLine, 4, $$refNewISP[5]);
      return($newLine);
    } else { Win32::GUI::MessageBox($win, $STR{'errNewLine'}, $STR{'error'}, 0x40010); }
  }
  # Add entry in grid (IPv6)
  elsif ($$refNewISP[0] eq 'IPv6') {
    if (my $newLine = $winDB->DBGrid->InsertRow($$refNewISP[0], -1)) {
      my ($start, $end) = split(/\-/, (Net::CIDR::cidr2range($$refNewISP[1]))[0]);
      $winDB->DBGrid->SetCellText($newLine, 0, $start);
      $winDB->DBGrid->SetCellText($newLine, 1, $end);
      $winDB->DBGrid->SetCellText($newLine, 2, $$refNewISP[3]);
      $winDB->DBGrid->SetCellText($newLine, 3, $$refNewISP[4]);
      $winDB->DBGrid->SetCellText($newLine, 4, $$refNewISP[5]);
      return($newLine);
    } else { Win32::GUI::MessageBox($win, $STR{'errNewLine'}, $STR{'error'}, 0x40010); }
  }
  
}  #--- End addISPGrid

#--------------------------#
sub DBGrid_Click
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  $LISTNO = 1;
  if ($row == 0) {
    threads->create(sub {
      $winDB->DBGrid->SetHeaderSort();
      my $order = $winDB->DBGrid->GetSortAscending();
      my $statusBarText = $winDB->statusBar->Text();
      $winDB->statusBar->Text($STR{'sortProgress'}.'...');
      if   ($column > 1) { $winDB->DBGrid->SortCells($column, $order, \&sortLC); }
      else               { $winDB->DBGrid->SortCells($column, $order, \&sortIP); }
      $winDB->DBGrid->Refresh();
      $winDB->statusBar->Text($statusBarText);
    });
  }
  return(1);

}  #--- End DBGrid_Click

#--------------------------#
sub DBGrid_RClick
#--------------------------#
{
  # Show popup menu
  my ($row, $column) = @_;
  my (@coord) = $winDB->DBGrid->GetSelectedCellRange();
  # Select the right entry if not selected or select has change
  if (($coord[0] and ($row < $coord[0])) or
      ($coord[2] and ($row > $coord[2])) or
      !$coord[0]) {
    $winDB->DBGrid->SetSelectedCellRange($row, 0, $row, 4);
  }
  my ($X, $Y) = Win32::GUI::GetCursorPos();
  $winDB->TrackPopupMenu($GridPopupMenu->{GridMenu},$X, $Y);
  return(1);

}  #--- End DBGrid_RClick

#--------------------------#
sub DBGrid_DblClick
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  my $range_s = $winDB->DBGrid->GetCellText($row, 0);
  my $range_e = $winDB->DBGrid->GetCellText($row, 1);
  # Replace not allowed characters for windows filename (IPv6)
  if ($range_s =~ /\:/) {
    $range_s =~ s/\:/_/g;
    $range_e =~ s/\:/_/g;
  }
  # If Network Whois Data exist, show it
  my $networkWhoisDataFile = "$CONFIG{'WHOIS_DATA_CACHE'}\\$range_s\-$range_e\.txt";
  if (-T $networkWhoisDataFile) {
    open(FILE, $networkWhoisDataFile) or Win32::GUI::MessageBox($winDB, $STR{'errReadingNetworkData'}.$!, $STR{'error'}, 0x40010);
    my @networkWhoisData = <FILE>;
    close(FILE);
    my $data;
    if (scalar(@networkWhoisData) < 2) { @networkWhoisData = split(/\r/, $networkWhoisData[0]); }
    foreach my $line (@networkWhoisData) { $line =~ s/[\r\n]//g; $data .= "$line\r\n"; }
    $winNWD->tfNWD->Text($data);
    $winNWD->Center($winDB);
    $winNWD->DoModal();
  }
  return(1);

}  #--- End DBGrid_RClick

#--------------------------#
sub winNWD_Resize
#--------------------------#
{
  $winNWD->tfNWD->Resize( $winNWD->ScaleWidth()-12    , $winNWD->ScaleHeight()-50);
  $winNWD->btnNWDOk->Move(($winNWD->ScaleWidth()-80)/2, $winNWD->ScaleHeight()-38);
  return(1);

}  #--- End winNWD_Resize

#--------------------------#
sub btnNWDOk_Click { return(-1); }
#--------------------------#

#--------------------------#
sub DBGrid_EndEdit
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  my $whoisDB   = $winConfig->tfDbFile->Text();
  my $range_s   = $winDB->DBGrid->GetCellText($row, 0);
  my $range_e   = $winDB->DBGrid->GetCellText($row, 1);
  my $isp       = $winDB->DBGrid->GetCellText($row, 2);
  my $country   = $winDB->DBGrid->GetCellText($row, 3);
  # Get date and time
  my ($s,$min,$h,$d,$m,$y) = (&date(0))[0,1,2,3,4,5];
  my $date                 = "$y-$m-$d $h:$min:$s";
  # Check values
  if ($range_s and $range_e and $isp and $country and $date) {
    # Check IP address
    if ((($range_s =~ /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/) and
         ($range_e =~ /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/)) or
        ($range_s =~ /$IPv6_re/ and $range_e =~ /$IPv6_re/ )) {
      my @newISP;
      # IPv4
      if    ($range_s =~ /\./) { @newISP = ('IPv4', $range_s, $range_e, $isp, $country, $date); }
      # IPv6
      elsif ($range_s =~ /\:/) {
        my $cidr = Net::CIDR::range2cidr("$range_s\-$range_e");
        @newISP = ('IPv6', $cidr, 'NULL', $isp, $country, $date);
      }
      # Connect to DB
      my $dsn = "DBI:SQLite:dbname=$whoisDB";
      my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
                or Win32::GUI::MessageBox($win, $STR{'errCreatingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      # Check if ISP already exists
      my $response;
      if    ($range_s =~ /\./) { $response = &checkISP_IPv4(\$dbh, $newISP[1], $newISP[2]); }
      elsif ($range_s =~ /\:/) { $response = &checkISP_IPv6(\$dbh, $newISP[1]); }
      # Fields($response): 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
      # If exists, modify
      if ($response) {
        my $return = &modifyISP(\$dbh, \@newISP);
        # Modify in grid
        if ($return) { $winDB->DBGrid->SetCellText($row, 4, $date); }
      }
      # If ISP does not exist, add it
      else {
        my $return = &addISP(\$dbh, \@newISP);
        # Update Status bar
        my $nbrISP = $winDB->DBGrid->GetRows() - 1;
        $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP");
      }
      $dbh->disconnect();
    } else {
      # Bad entry, reload database
      threads->create(sub { &loadWhoisDB; });
      Win32::GUI::MessageBox($win, $STR{'errParams'}, $STR{'error'}, 0x40010);
    }
  } else {
    # Invalid modification
    my $nbrISPGrid   = $winDB->DBGrid->GetRows() - 1;
    my $nbrISPStatus = (split(/ = /, $winDB->statusBar->Text()))[1];
    if ($nbrISPGrid == $nbrISPStatus) {
      # Bad entry, reload database
      threads->create(sub { &loadWhoisDB; });
      Win32::GUI::MessageBox($win, $STR{'errParams'}, $STR{'error'}, 0x40010);
    }
  }
  return(1);

}  #--- End DBGrid_EndEdit

#--------------------------#
sub getAllRanges_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'errProcessRun'},$STR{'error'},0x40010);
  } else {
    # Get range of the selected entry
    my (@coord) = $winDB->DBGrid->GetSelectedCellRange();
    # Check if row contains Network Whois Data (single row only)
    if ($coord[0] and $coord[2] and $coord[0] == $coord[2]) {
      my $range_s = $winDB->DBGrid->GetCellText($coord[0], 0);
      my $range_e = $winDB->DBGrid->GetCellText($coord[0], 1);
      my $isp     = $winDB->DBGrid->GetCellText($coord[0], 2);
      my $country = $winDB->DBGrid->GetCellText($coord[0], 3);
      $THR = threads->create(sub {
        # Thread 'cancellation' signal handler
        $SIG{'KILL'} = sub {
          $win->ChangeCursor($ARROW);
          # Turn off progress bar
          $winPb->lblPbCurr->Text('');
          $winPb->lblCount->Text('');
          $winPb->pbWinPb->SetPos(0);
          $winPb->Hide();
          threads->exit();
        };
        # Thread 'die' signal handler
        $SIG{__DIE__} = sub {
          my $errMsg = (split(/ at /,$_[0]))[0];
          chomp($errMsg);
          $errMsg =~ s/[\t\r\n]/ /g;
          $win->ChangeCursor($ARROW);
          # Turn off progress bar
          $winPb->lblPbCurr->Text('');
          $winPb->lblCount->Text('');
          $winPb->pbWinPb->SetPos(0);
          $winPb->Hide();
          Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'error'}, 0x40010);
        };
        # Turn on progress bar
        &winAddRanges_Terminate;
        $winPb->Center($winDB);
        $winPb->Show();
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winDB->Disable();
        $winDB->ChangeCursor($HOURGLASS);
        $winAddRanges->btnAddRSelected->Disable();
        # Progress bar
        $winPb->pbWinPb->SetRange(0, 3);
        $winPb->pbWinPb->SetPos(0);
        $winPb->pbWinPb->SetStep(1);
        # Request for the asn or the id
        $winPb->lblPbCurr->Text($STR{'queryASNorID'}.'...');
        $winPb->pbWinPb->StepIt();
        my ($registry, $asn, $id) = &getASNorIDForIP($range_s, $range_e);
        # Send the advanced query
        if ($registry and ($asn or $id)) {
          my $return;
          my $refRangesISP;
          my $ISPName;
          # Query the registry to gather all ranges for the ISP
          if    ($asn) { $winPb->lblPbCurr->Text($STR{'queryallRange1'}.$registry.$STR{'queryallRange2'}.$asn.'...'); }
          elsif ($id)  { $winPb->lblPbCurr->Text($STR{'queryallRange1'}.$registry.$STR{'queryallRange2'}.$id.'...');  }
          $winPb->pbWinPb->StepIt();
          # LACNIC
          if    ($registry eq 'LACNIC') { ($return, $refRangesISP)           = &getAllRangesLACNIC($registry, $asn, $id); }
          # APNIC
          elsif ($registry eq 'APNIC')  { ($return, $refRangesISP, $ISPName) = &getAllRangesAPNIC($registry,  $asn, $id); }
          # Other registry
          else                          { ($return, $refRangesISP, $ISPName) = &getAllRangesREST($registry,   $asn, $id); }
          # Remove overlapping ranges
          $winPb->lblPbCurr->Text($STR{'remOverlap'}.'...');
          $winPb->pbWinPb->StepIt();
          foreach my $range_s (sort keys %{$refRangesISP}) {
            foreach my $range2cmp_s (sort keys %{$refRangesISP}) {
              # Compare 2 IPv4
              if ($range_s =~ /\./ and $range2cmp_s =~ /\./ and $$refRangesISP{$range_s} and $$refRangesISP{$range2cmp_s}) {
                my $range_sInt     = unpack 'N', pack 'C4', split '\.', $range_s;
                my $range_eInt     = unpack 'N', pack 'C4', split '\.', $$refRangesISP{$range_s};
                my $range_s2cmpInt = unpack 'N', pack 'C4', split '\.', $range2cmp_s;
                my $range_e2cmpInt = unpack 'N', pack 'C4', split '\.', $$refRangesISP{$range2cmp_s};
                my $included = &inRange($range_sInt, $range_eInt, $range_s2cmpInt, $range_e2cmpInt);
                if ($included == 2) { delete($$refRangesISP{$range2cmp_s}); }
              # Compare 2 IPv6
              } elsif ($range_s =~ /\:/ and $range2cmp_s =~ /\:/ and $$refRangesISP{$range_s} and $$refRangesISP{$range2cmp_s}) {
                my $range_sObj       = NetAddr::IP::Lite->new6($range_s);
                my $range_eObj       = NetAddr::IP::Lite->new6($$refRangesISP{$range_s});
                my $range_s2cmpObj   = NetAddr::IP::Lite->new6($range2cmp_s);
                my $range_e2cmpObj   = NetAddr::IP::Lite->new6($$refRangesISP{$range2cmp_s});
                my $range_sInt       = $range_sObj->bigint();
                my $range_eInt       = $range_eObj->bigint();
                my $range_s2cmpInt   = $range_s2cmpObj->bigint();
                my $range_e2cmpInt   = $range_e2cmpObj->bigint();
                my $included = &inRange($range_sInt, $range_eInt, $range_s2cmpInt, $range_e2cmpInt);
                if ($included == 2) { delete($$refRangesISP{$range2cmp_s}); }
              }
            }
          }
          # Show ranges found 
          if ($return eq $STR{'lblChoice'}) {
            if ($ISPName) { $isp = $ISPName; }
            my $nbrRanges = scalar(keys %{$refRangesISP});
            $winAddRanges->GridISPRanges->SetRows($nbrRanges+1);
            $winAddRanges->GridISPRanges->SetCellText( 0, 1, $STR{'cbFilterField1'});
            $winAddRanges->GridISPRanges->SetCellText( 0, 2, $STR{'cbFilterField2'});
            $winAddRanges->GridISPRanges->SetCellText( 0, 3, $STR{'cbFilterField3'});
            $winAddRanges->GridISPRanges->SetCellText( 0, 4, $STR{'cbFilterField4'});
            my $i = 1;
            foreach my $range_s (sort keys %{$refRangesISP}) {
              $winAddRanges->GridISPRanges->SetCellText( $i, 0, "");
              $winAddRanges->GridISPRanges->SetCellType( $i, 0, GVIT_CHECK);
              $winAddRanges->GridISPRanges->SetCellCheck($i, 0, 1);
              $winAddRanges->GridISPRanges->SetCellText( $i, 1, $range_s);
              $winAddRanges->GridISPRanges->SetCellText( $i, 2, $$refRangesISP{$range_s});
              $winAddRanges->GridISPRanges->SetCellText( $i, 3, $isp      );
              $winAddRanges->GridISPRanges->SetCellText( $i, 4, $country  );
              $i++;
            }
            $winAddRanges->GridISPRanges->SortCells(1, 2, \&sortIP);
            $winAddRanges->GridISPRanges->Refresh();
            $winAddRanges->GridISPRanges->AutoSize();
            $winAddRanges->GridISPRanges->ExpandLastColumn();
            # Turn off progress bar
            $winPb->lblPbCurr->Text('');
            $winPb->lblCount->Text('');
            $winPb->pbWinPb->SetPos(0);
            &winPb_Terminate;
            $winDB->ChangeCursor($ARROW);
            # Display Add ISP Range Window
            $winAddRanges->Center($winDB);
            $winAddRanges->Show();          
            $winAddRanges->btnAddRSelected->Enable();
          # No match
          } elsif ($return eq $STR{'noMoreResults'}) {
            # Turn off progress bar
            $winPb->lblPbCurr->Text('');
            $winPb->lblCount->Text('');
            $winPb->pbWinPb->SetPos(0);
            &winPb_Terminate;
            $winDB->ChangeCursor($ARROW);
            Win32::GUI::MessageBox($winDB, $STR{'noRangeISP'}, $STR{'noMatch'}, 0x40040);
          # Error
          } else {
            # Turn off progress bar
            $winPb->lblPbCurr->Text('');
            $winPb->lblCount->Text('');
            $winPb->pbWinPb->SetPos(0);
            &winPb_Terminate;
            $winDB->ChangeCursor($ARROW);
            Win32::GUI::MessageBox($winDB, $return, $STR{'error'}, 0x40010);
          }
        } else {
          # Turn off progress bar
          $winPb->lblPbCurr->Text('');
          $winPb->lblCount->Text('');
          $winPb->pbWinPb->SetPos(0);
          &winPb_Terminate;
          $winDB->ChangeCursor($ARROW);
          # Connection error
          if ($registry eq $STR{'errConnection'}) {
            Win32::GUI::MessageBox($winDB, "$STR{'errConnection'}", $STR{'error'}, 0x40010);
          } else {
            Win32::GUI::MessageBox($winDB, $STR{'noASNorIDFound'}, $STR{'error'}, 0x40010);
          }
        }
      });
    }
  }
  return(1);

}  #--- End getAllRanges_Click

#--------------------------#
sub getASNorIDForIP
#--------------------------#
{
  # Local variables
  my $range_s = shift;
  my $range_e = shift;
  my %rirName = ( 'whois.arin.net'    => 'ARIN'   ,
                  'whois.ripe.net'    => 'RIPE'   ,
                  'whois.apnic.net'   => 'APNIC'  ,
                  'whois.krnic.net'   => 'KRNIC'  ,
                  'whois.lacnic.net'  => 'LACNIC' ,
                  'whois.afrinic.net' => 'AFRINIC', );
  my %IPv4; # IPv4 Database
  my %IPv6; # IPv6 Database
  # Complete IP
  if ($range_s =~ /\./) { while ($range_s !~ /(?:[0-9]{1,3}\.){3}[0-9]{1,3}/) { $range_s .= '.0';   } }
  # Find the registry
  if ($CONFIG{'IPv4_DB_FILE'} and -T $CONFIG{'IPv4_DB_FILE'}) { &loadIPv4DB(\%IPv4); }
  if ($CONFIG{'IPv6_DB_FILE'} and -T $CONFIG{'IPv6_DB_FILE'}) { &loadIPv6DB(\%IPv6); }
  my $whoisServer = &registry($range_s, \%IPv4, \%IPv6);
  if (!$whoisServer) { $whoisServer = 'whois.arin.net'; }
  if ($whoisServer) {
    my $authority = $rirName{$whoisServer};
    # ARIN
    if    ($authority eq 'ARIN') {
      my $client = REST::Client->new();
      $client->GET("http://whois.arin.net/rest/ip/$range_s");
      if ($client->responseContent() and $client->responseContent() =~ /Can't connect to /) { return($STR{'errConnection'}); }
      if (my $obj = xml_to_object($client->responseContent())) {
        if ($obj->path('netBlocks/netBlock/description') and $obj->path('netBlocks/netBlock/description')->value =~ /(?:Allocated|Transferred) to (\w+)/) {
          $authority = $1;
        }
        if ($authority eq 'ARIN' and $obj->path('originASes/originAS') and my $asn = $obj->path('originASes/originAS')->value) {
          return($authority, $asn, undef);
        } elsif ($authority eq 'ARIN' and my $orgRef = $obj->path('orgRef')) {
          if (my $id = $orgRef->attr('handle')) {
            return($authority, undef, $id);
          }
        }
      }
    }
    # RIPE or AFRINIC
    if ($authority eq 'RIPE' or $authority eq 'AFRINIC') {
      my $client = REST::Client->new();
      $client->GET("http://rest.db.ripe.net/search?query-string=$range_s");
      if ($client->responseContent() and $client->responseContent() =~ /Can't connect to /) { return($STR{'errConnection'}); }
      my $obj = xml_to_object($client->responseContent());
      my @objects = $obj->path('objects/object');
      foreach my $object (@objects) {
        if ($object->attr('type') eq 'route') {
          my @attr = $object->path('primary-key/attribute');
          foreach my $attr (@attr) {
            if ($attr->attr('name') eq 'origin') {
              my $asn = $attr->attr('value');
              return($authority, $asn, undef);
            }
          }
        }
      }
    }
    # APNIC
    if ($authority eq 'APNIC') {
      if (my $refResponses = &whoisQuery('whois.apnic.net', "-T inetnum $range_s - $range_e")) {
        foreach (@{$refResponses}) {
          if (/^admin-c\:\s*([^\r^\n]+)/i) { return($authority, undef, $1); }
        }
      } else { return($STR{'errConnection'}); }
    }
    # LACNIC
    if ($authority eq 'LACNIC') {
      # Send the query
      my $ua = new LWP::UserAgent;
      $ua->agent($CONFIG{'USERAGENT'});
      $ua->default_header('Accept-Language' => 'en');
      $ua->timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
      my $req = new HTTP::Request GET => "http://lacnic.net/cgi-bin/lacnic/whois?lg=EN&query=$range_s";
      my $res = $ua->request($req);
      # Success, compare versions
      if ($res->is_success) {
        my @content = split(/[\r\n]/, $res->content);
        foreach (@content) {
          if (/aut-num\:\s*([^\r^\n]*) ?/i) { if ($1 ne 'N/A') { return($authority, $1, undef); } }
          if (/ownerid\:\s*([^\r^\n]*) ?/i) { return($authority, undef, $1); }
        }
      } else { return($STR{'errConnection'}); }
    }
  }
  
}  #--- End getASNorIDForIP

#--------------------------#
sub getAllRangesAPNIC
#--------------------------#
{
  # Local variables
  my ($registry, $asn, $id) = @_;
  my $refResponses;
  my %rangesISP;
  my $ispName;
  if ($id) {
    # Get the ISP name
    if ($refResponses = &whoisQuery('whois.apnic.net', $id)) {
      if ($refResponses) {
        foreach (@{$refResponses}) {
          if    (/^role\:\s*([^\r^\n]+)/i)   { $ispName = $1; last; }
          elsif (/^person\:\s*([^\r^\n]+)/i) { $ispName = $1; last; }
        }
      }
    } else { return($STR{'errConnection'}); }
    # Get all range for the same admin-c
    if ($refResponses = &whoisQuery('whois.apnic.net', "-i admin-c $id")) {
      if ($refResponses) {
        foreach (@{$refResponses}) {
          # IPv4
          if (/inetnum:\s*([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\s*-\s*[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})/i) {
            my ($range_s, $range_e) = split(/\-/, (Net::CIDR::cidr2range($1))[0]);
            while ($range_s !~ /(?:[0-9]{1,3}\.){3}[0-9]{1,3}/) { $range_s .= '.0';   }
            while ($range_e !~ /(?:[0-9]{1,3}\.){3}[0-9]{1,3}/) { $range_e   .= '.255'; }
            # If already exists, keep the wide range
            if (exists($rangesISP{$range_s})) {
              my $rangeE_NewInt    = unpack 'N', pack 'C4', split '\.', $range_e;
              my $rangeE_StoredInt = unpack 'N', pack 'C4', split '\.', $rangesISP{$range_s};
              if ($rangeE_NewInt > $rangeE_StoredInt) { $rangesISP{$range_s} = $range_e; }
            } else { $rangesISP{$range_s} = $range_e; }
          # IPv6
          } elsif (/inetnum:\s*([0-9A-Fa-f\:]+\s*-\s*[0-9A-Fa-f\:]+)/i) {
            my ($range_s, $range_e) = split(/\-/, (Net::CIDR::cidr2range($1))[0]);
            # If already exists, keep the wide range
            if (exists($rangesISP{$range_s})) {
              my $rangeE_New       = NetAddr::IP::Lite->new6($range_e);
              my $rangeE_Stored    = NetAddr::IP::Lite->new6($rangesISP{$range_s});
              my $rangeE_NewInt    = $rangeE_New->bigint();
              my $rangeE_StoredInt = $rangeE_Stored->bigint();
              if ($rangeE_NewInt > $rangeE_StoredInt) { $rangesISP{$range_s} = $range_e; }
            } else { $rangesISP{$range_s} = $range_e; }
          } elsif (/inetnum/) { print "$_"; }
        }
      }
    } else { return($STR{'errConnection'}); }
  }
  # Return results
  if (scalar(keys %rangesISP) > 0) {
    if ($ispName) { return($STR{'lblChoice'}, \%rangesISP, $ispName); }
    else          { return($STR{'lblChoice'}, \%rangesISP, undef);    }
  } else { return($STR{'noMoreResults'}); } # No results

}  #--- End getAllRangesAPNIC

#--------------------------#
sub getAllRangesLACNIC
#--------------------------#
{
  # Local variables
  my ($registry, $asn, $id) = @_;
  my $whoisURL;
  my %rangesISP;
  # Send the query
  my $ua = new LWP::UserAgent;
  $ua->agent($CONFIG{'USERAGENT'});
  $ua->default_header('Accept-Language' => 'en');
  $ua->timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
  if ($asn) { $whoisURL = "http://lacnic.net/cgi-bin/lacnic/whois?lg=EN?query=$asn"; }
  else      { $whoisURL = "http://lacnic.net/cgi-bin/lacnic/whois?lg=EN?query=$id";  }
  my $req = new HTTP::Request GET => $whoisURL;
  my $res = $ua->request($req);
  # Success, compare versions
  if ($res->is_success) {
    my @content = split(/[\r\n]/, $res->content);
    foreach (@content) {
      # IPv4
      if (/inetnum:\s*(?:\<[^\>]+\>)?((?:\d{1,3}\.){1,3}\d{1,3}\/\d{1,2})/i) {
        my ($range_s, $range_e) = split(/\-/, (Net::CIDR::cidr2range($1))[0]);
        while ($range_s !~ /(?:[0-9]{1,3}\.){3}[0-9]{1,3}/) { $range_s .= '.0';   }
        while ($range_e !~ /(?:[0-9]{1,3}\.){3}[0-9]{1,3}/) { $range_e   .= '.255'; }
        # If already exists, keep the wide range
        if (exists($rangesISP{$range_s})) {
          my $rangeE_NewInt    = unpack 'N', pack 'C4', split '\.', $range_e;
          my $rangeE_StoredInt = unpack 'N', pack 'C4', split '\.', $rangesISP{$range_s};
          if ($rangeE_NewInt > $rangeE_StoredInt) { $rangesISP{$range_s} = $range_e; }
        } else { $rangesISP{$range_s} = $range_e; }
      # IPv6
      } elsif (/inetnum:\s*(?:\<[^\>]+\>)?((?:[0-9A-Fa-f\:]+\/\d{1,3}))/i) {
        my ($range_s, $range_e) = split(/\-/, (Net::CIDR::cidr2range($1))[0]);
        # If already exists, keep the wide range
        if (exists($rangesISP{$range_s})) {
          my $rangeE_New       = NetAddr::IP::Lite->new6($range_e);
          my $rangeE_Stored    = NetAddr::IP::Lite->new6($rangesISP{$range_s});
          my $rangeE_NewInt    = $rangeE_New->bigint();
          my $rangeE_StoredInt = $rangeE_Stored->bigint();
          if ($rangeE_NewInt > $rangeE_StoredInt) { $rangesISP{$range_s} = $range_e; }
        } else { $rangesISP{$range_s} = $range_e; }
      }
    }
  } else { return($STR{'errConnection'}); }
  # Return results
  if (scalar(keys %rangesISP) > 0) { return($STR{'lblChoice'}, \%rangesISP); }
  else { return($STR{'noMoreResults'}); } # No results

}  #--- End getAllRangesLACNIC

#--------------------------#
sub getAllRangesREST
#--------------------------#
{
  # Local variables
  my ($registry, $asn, $id) = @_;
  my $whoisURL;
  my @tabRangesISP;
  my %rangesISP;
  my $ispName;
  # Create an agent
  my $ua = new LWP::UserAgent;
  $ua->agent($CONFIG{'USERAGENT'});
  $ua->default_header('Accept-Language' => 'en');
  # Set the URL
  if      ($registry eq 'ARIN') {
    if    ($id)  { $whoisURL = "http://whois.arin.net/rest/org/$id/nets"; }
    elsif ($asn) {
      # Get the org ID
      my $client = REST::Client->new(useragent => $ua                        ,
                                     timeout   => $CONFIG{'NSLOOKUP_TIMEOUT'}, );
      $client->GET("http://whois.arin.net/rest/asn/$asn");
      if ($client->responseCode() eq '200') {
        if ($client->responseContent() and 
            ($client->responseContent() =~ /<orgRef handle="([^\"]+)" name="[^\"]+"|<orgRef name="[^\"]+" handle="([^\"]+)"/)) {
          my $orgID = $1;
          $whoisURL = "http://whois.arin.net/rest/org/$orgID/nets";
        }
      } else { return($STR{'errConnection'}); }
    }
  } elsif ($registry eq 'RIPE' or $registry eq 'AFRINIC') {
    if    ($id)  { $whoisURL = "http://rest.db.ripe.net/search?inverse-attribute=admin-c&query-string=$id"; }
    elsif ($asn) { $whoisURL = "http://rest.db.ripe.net/search?inverse-attribute=origin&query-string=$asn"; }
  }
  # Send the RESTful query
  if ($whoisURL) {
    my $client = REST::Client->new(useragent => $ua , timeout => $CONFIG{'NSLOOKUP_TIMEOUT'});
    $client->GET($whoisURL);
    # Parse the answer
    if ($client->responseCode() eq '200') {
      if ($client->responseContent() and my $obj = xml_to_object($client->responseContent())) {
        # List all networks
        if      ($registry eq 'ARIN') {
          my @nets = $obj->path('netRef');
          foreach my $nets (@nets) {
            if ($nets->attr('startAddress') and $nets->attr('endAddress')) {
              push(@tabRangesISP, $nets->attr('startAddress').'-'.$nets->attr('endAddress'));
            }
          }
        } elsif ($registry eq 'RIPE' or $registry eq 'AFRINIC') {
          # Get ranges
          my @objects = $obj->path('objects/object');
          foreach my $object (@objects) {
            if ($object->attr('type') eq 'route') {
              my @attr = $object->path('primary-key/attribute');
              foreach my $attr (@attr) {
                if ($attr->attr('name') eq 'route') {
                  my $cidr = $attr->attr('value');
                  my ($ipStart, $ipEnd) = split(/\-/, (Net::CIDR::cidr2range($cidr))[0]);
                  push(@tabRangesISP, $ipStart.'-'.$ipEnd);
                }
              }
            }
          }
          # Get ISP real name
          if ($asn and !$ispName) {
            $client->GET("http://rest.db.ripe.net/ripe/aut-num/$asn");
            if ($client->responseContent() and my $obj2 = xml_to_object($client->responseContent())) {
              my @objects = $obj2->path('objects/object');
              foreach my $object (@objects) {
                if ($object->attr('type') eq 'aut-num') {
                  my @attr = $object->path('attributes/attribute');
                  foreach my $attr (@attr) {
                    if ($attr->attr('name') eq 'descr') {
                      $ispName = $attr->attr('value'); # The first descr field only
                      last;
                    }
                  }
                }
              }
            }
          }
        }
      }
    } else { return($STR{'errConnection'}); }
  }
  # Remove overlapping range
  foreach my $range (@tabRangesISP) {
    my ($range_s, $range_e) = split(/\-/, $range);
    # IPv4
    if ($range_s =~ /\./) {
      while ($range_s !~ /(?:[0-9]{1,3}\.){3}[0-9]{1,3}/) { $range_s .= '.0';   }
      while ($range_e !~ /(?:[0-9]{1,3}\.){3}[0-9]{1,3}/) { $range_e .= '.255'; }
      # If already exists, keep the wide range
      if (exists($rangesISP{$range_s})) {
        my $rangeE_NewInt    = unpack 'N', pack 'C4', split '\.', $range_e;
        my $rangeE_StoredInt = unpack 'N', pack 'C4', split '\.', $rangesISP{$range_s};
        if ($rangeE_NewInt > $rangeE_StoredInt) { $rangesISP{$range_s} = $range_e; }
      } else { $rangesISP{$range_s} = $range_e; }
    # IPv6
    } else {
      # If already exists, keep the wide range
      if (exists($rangesISP{$range_s})) {
        my $rangeE_New       = NetAddr::IP::Lite->new6($range_e);
        my $rangeE_Stored    = NetAddr::IP::Lite->new6($rangesISP{$range_s});
        my $rangeE_NewInt    = $rangeE_New->bigint();
        my $rangeE_StoredInt = $rangeE_Stored->bigint();
        if ($rangeE_NewInt > $rangeE_StoredInt) { $rangesISP{$range_s} = $range_e; }
      } else { $rangesISP{$range_s} = $range_e; }
    }
  }
  # Return results
  if (scalar(keys %rangesISP) > 0) {
    if ($ispName) { return($STR{'lblChoice'}, \%rangesISP, $ispName); }
    else          { return($STR{'lblChoice'}, \%rangesISP, undef);    }
  } else { return($STR{'noMoreResults'}); } # No results

}  #--- End getAllRangesREST

#--------------------------#
sub GridISPRanges_Click
#--------------------------#
{
  # Local variables
  my $row = shift;
  my $i   = 1;
  my $nbrSelect = 0;
  # Select or not
  my $selStatus = $winAddRanges->GridISPRanges->GetCellCheck($row, 0);
  if (!$selStatus) { $winAddRanges->GridISPRanges->SetCellCheck($row, 0, 1); } # Check
  else             { $winAddRanges->GridISPRanges->SetCellCheck($row, 0, 0); } # Uncheck
  # List selected rows
  while ($i < $winAddRanges->GridISPRanges->GetRows()) {
    if ($winAddRanges->GridISPRanges->GetCellCheck($i, 0) == 1) {
      $nbrSelect++;
    }
    $i++;
  }
  # Enable btnAddRSelected ?
  if ($nbrSelect > 0) { $winAddRanges->btnAddRSelected->Enable();  }
  else                { $winAddRanges->btnAddRSelected->Disable(); }
  
}  #--- End GridISPRanges_Click

#--------------------------#
sub btnAddRSelected_Click { $THR = threads->create(sub { &addRangeWhoisDB(); }); }
#--------------------------#

#--------------------------#
sub addRangeWhoisDB
#--------------------------#
{
  # Local variables
  my ($s,$min,$h,$d,$m,$y) = (&date(0))[0,1,2,3,4,5];
  my $date                 = "$y-$m-$d $h:$min:$s";
  my @listRanges;
  my $i = 1;
  # Turn on progress bar
  &winAddRanges_Terminate;
  $winPb->Center($winDB);
  $winPb->Show();
  $winPb->lblPbCurr->Text('');
  $winPb->lblCount->Text('');
  $winDB->Disable();
  $winDB->ChangeCursor($HOURGLASS);
  # List of ISP ranges to add and add missing data
  # To Fields: 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
  while ($i < $winAddRanges->GridISPRanges->GetRows()) {
    if ($winAddRanges->GridISPRanges->GetCellCheck($i, 0) == 1) {
      my $newISP;
      my $range_s = $winAddRanges->GridISPRanges->GetCellText($i, 1);
      my $range_e = $winAddRanges->GridISPRanges->GetCellText($i, 2);
      my $ispName = $winAddRanges->GridISPRanges->GetCellText($i, 3);
      my $country = $winAddRanges->GridISPRanges->GetCellText($i, 4);
      # IPv4
      if ($range_s !~ /\:/) { $newISP = "IPv4\t$range_s\t$range_e\t$ispName\t$country\t$date"; }
      # IPv6
      else {
        my $cidr = Net::CIDR::range2cidr("$range_s\-$range_e");
        $newISP = "IPv6\t$cidr\tNULL\t$ispName\t$country\t$date";
      }
      push(@listRanges, $newISP);
    }
    $i++;
  }
  # Update DB
  my $nbrISP = scalar(@listRanges);
  $winPb->lblPbCurr->Text($STR{'winAddRSelected'}.'...');
  my ($nbrAdd, $nbrModif) = &feedWhoisDatabase(\@listRanges, $nbrISP);
  # Refresh grid
  $winDB->DBGrid->AutoSizeColumns();
  $winDB->DBGrid->ExpandColumnsToFit();
  $winDB->DBGrid->SetListMode();
  $winDB->DBGrid->ScrollPos(1,0);
  $winDB->DBGrid->SortCells(0, 1, \&sortIP);
  $winDB->DBGrid->Refresh();
  # Status bar
  $nbrISP = $winDB->DBGrid->GetRows() - 1;
  $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP | $STR{'numberISP'} $STR{'added'}: $nbrAdd | $STR{'numberISP'} $STR{'modified'}: $nbrModif");
  # Turn off progress bar
  $winPb->lblPbCurr->Text('');
  $winPb->lblCount->Text('');
  $winPb->pbWinPb->SetPos(0);
  &winPb_Terminate;
  $winDB->ChangeCursor($ARROW);
  
}  #--- End addRangeWhoisDB

#--------------------------#
sub btnAddRCancel_Click { &winAddRanges_Terminate; }
#--------------------------#

#--------------------------#
sub winAddRanges_Terminate
#--------------------------#
{
  $winAddRanges->Hide();
  return(0);
  
}  #--- End winAddRanges_Terminate

#--------------------------#
sub gridSelectAll_Click
#--------------------------#
{
  $winDB->DBGrid->OnEditSelectAll();
  return(1);

}  #--- End GridSelectAll_Click

#--------------------------#
sub lineCopy_Click
#--------------------------#
{
  $winDB->DBGrid->OnEditCopy();
  return(1);

}  #--- End lineCopy

#--------------------------#
sub deleteLine_Click
#--------------------------#
{
  # Local variables
  my(@coord)  = $winDB->DBGrid->GetSelectedCellRange();
  my $nbrISP  = $winDB->DBGrid->GetRows();
  my $whoisDB = $winConfig->tfDbFile->Text();
  my @ISP2del;
  # Select data to delete
  my $lastSelectedRow; 
  if ($coord[2]) { $lastSelectedRow = $coord[2]; }
  else           { $lastSelectedRow = $coord[0]; }
  for (my $row = $coord[0]; $row <= $lastSelectedRow; $row++) {
    if ($winDB->DBGrid->IsCellSelected ($row, 0)) {
      my $range_s = $winDB->DBGrid->GetCellText($row, 0);
      my $range_e = $winDB->DBGrid->GetCellText($row, 1);
      push(@ISP2del, "$range_s\-$range_e");
    }
  }
  $THR = threads->create(sub {
    # Thread 'cancellation' signal handler
    $SIG{'KILL'} = sub {
      # Sort grid
      $winDB->DBGrid->SortCells(0, 1, \&sortIP);
      $winDB->DBGrid->Refresh();
      # Status bar
      $nbrISP = $winDB->DBGrid->GetRows() - 1;
      $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP");
      &winPb_Terminate;
      $winDB->ChangeCursor($ARROW);
      threads->exit();
    };
    # Show progress window
    my $nbrISP2del = @ISP2del;
    $winPb->lblPbCurr->Text($STR{'deletingISP'});
    $winPb->lblCount->Text("0 / $nbrISP2del");
    $winPb->pbWinPb->SetRange(0, $nbrISP2del);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    $winPb->Center($winDB);
    $winPb->Show();
    $winDB->Disable();
    $winDB->ChangeCursor($HOURGLASS);
    # Connect to DB
    my $dsn = "DBI:SQLite:dbname=$whoisDB";
    my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
              or Win32::GUI::MessageBox($winDB, $STR{'errCreatingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
    # Loop each entry and delete
    my $j = 0;
    foreach my $ISP (@ISP2del) {
      my ($ISPRange_s, $ISPRange_e) = split(/\-/, $ISP);
      for (my $i = 0; $i < $nbrISP; $i++) {
        my $range_s = $winDB->DBGrid->GetCellText($i, 0);
        my $range_e = $winDB->DBGrid->GetCellText($i, 1);
        # Entry have been found
        if (($ISPRange_s eq $range_s) and ($ISPRange_e eq $range_e)) {
          my $return;
          if    ($ISPRange_s =~ /\./) { $return = &deleteISP_IPv4(\$dbh, $ISPRange_s, $ISPRange_e); } # Delete in Database (IPv4)
          elsif ($ISPRange_s =~ /\:/) { $return = &deleteISP_IPv6(\$dbh, $ISPRange_s, $ISPRange_e); } # Delete in Database (IPv6)
          if ($return) {
            &deleteISPGrid($i, $ISPRange_s, $ISPRange_e); # Delete in Grid
            # Delete the Network Whois Data File
            my $networkWhoisDataFile = "$CONFIG{'WHOIS_DATA_CACHE'}\\$ISPRange_s\-$ISPRange_e\.txt";
            if (-e $networkWhoisDataFile) { unlink($networkWhoisDataFile); }
          }
          last;
        }
      }
      $j++;
      $winPb->lblCount->Text("$j / $nbrISP2del");
      $winPb->pbWinPb->StepIt();
    }
    $winDB->ChangeCursor($ARROW);
    &winPb_Terminate;
    $dbh->disconnect();
    # Sort grid
    $winDB->DBGrid->SortCells(0, 1, \&sortIP);
    $winDB->DBGrid->Refresh();
    # Status bar
    $nbrISP = $winDB->DBGrid->GetRows() - 1;
    $winDB->statusBar->Text(" $STR{'numberISP'}: $nbrISP");
  });

  return(1);

}  #--- End deleteLine_Click

#--------------------------#
sub sortLC
#--------------------------#
{
  my ($a, $b) = @_;
  return (lc($a) cmp lc($b));

}  #--- End sortLC

#--------------------------#
sub sortIP
#--------------------------#
{
  # Split IP addresses
  my ($a, $b) = @_;
  # Both IPv4
  if ($a and $b and $a !~ /\:/ and $b !~ /\:/) {
    my ($a1, $a2, $a3, $a4) = split(/\./, $a);
    my ($b1, $b2, $b3, $b4) = split(/\./, $b);
    # Compare each part
    if ($a1 == $b1) {
      if ($a2 == $b2) {
        if ($a3 == $b3) {
          return $a4 <=> $b4;
        } else { return $a3 <=> $b3; }
      } else { return $a2 <=> $b2; }
    } else { return $a1 <=> $b1; }
  # If one of the address is IPv6, compare first number only
  } else { return (split(/[\.\:]/, $a))[0] <=> (split(/[\.\:]/, $b))[0]; }
  
}  #--- End sortIP

#--------------------------#
sub btnWhois_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'errProcessRun'},$STR{'error'},0x40010);
  } else {
    # Extract Items from Clipboard
    my %itemsIndex;
    my %itemsType;
    my $nbrItems = &extractRequestItems(\%itemsIndex, \%itemsType);
    if ($nbrItems == 0) {
      Win32::GUI::MessageBox($win, $STR{'errClipboard'}, $STR{'error'}, 0x40010);
      return(0);
    # Whois Request
    } else {
      $THR = threads->create(sub {
        # Thread 'cancellation' signal handler
        $SIG{'KILL'} = sub {
          &winPb_Terminate;
          $win->ChangeCursor($ARROW);
          threads->exit();
        };
        # Thread 'die' signal handler
        $SIG{__DIE__} = sub {
          my $errMsg = (split(/ at /,$_[0]))[0];
          chomp($errMsg);
          $errMsg =~ s/[\t\r\n]/ /g;
          $win->ChangeCursor($ARROW);
          &winPb_Terminate;
          Win32::GUI::MessageBox($winDB, "$STR{'error'}: $errMsg", $STR{'error'}, 0x40010);
        };
        # Show progress window
        $winPb->lblPbCurr->Text($STR{'whoisProgress'});
        $winPb->lblCount->Text("0 / $nbrItems");
        $winPb->pbWinPb->SetRange(0, $nbrItems);
        $winPb->pbWinPb->SetPos(0);
        $winPb->pbWinPb->SetStep(1);
        $winPb->Center($win);
        $winPb->Show();
        $win->Disable();
        $win->ChangeCursor($HOURGLASS);
        # Local variables
        my $targetDir     = $winConfig->tfReportDir->Text();
        my $whoisDB       = $winConfig->tfDbFile->Text();
        my $dbLogFile     = $winConfig->tfLogDbFile->Text();
        my $nbrAdded      = 0;
        my $nbrModified   = 0;
        my $checkDBOpt    = $win->cbCheckWhoisDB->GetCurSel();
        # Possible values for $checkDBOpt: 0 = Don't check, 1 = If present, ask, 2 = If present, ignore, 3 = Check after
        my $checkLogging  = $win->chCheckLogging->Checked(); # If == 1, check logging database for item
        my $count         = 0;
        my $dbh;
        my $dbhLog;
        my %nwData;
        my $refNWData     = \%nwData; # To store network whois data
        my @newISP;
        my %IPv4; # IPv4 Database
        my %IPv6; # IPv6 Database
        # Load IPv4 and IPv6
        if ($CONFIG{'IPv4_DB_FILE'} and -T $CONFIG{'IPv4_DB_FILE'}) { &loadIPv4DB(\%IPv4); }
        if ($CONFIG{'IPv6_DB_FILE'} and -T $CONFIG{'IPv6_DB_FILE'}) { &loadIPv6DB(\%IPv6); }
        # Connect to Whois Database
        if ($whoisDB and -f $whoisDB) {
          my $dsn  = "DBI:SQLite:dbname=$whoisDB";
             $dbh  = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
                     or Win32::GUI::MessageBox($win, $STR{'errConnectingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
        }
        # Connect to Logging Database
        if ($winConfig->chLogActivate->Checked() and $dbLogFile and -f $dbLogFile) {
          my $dsnLog = "DBI:SQLite:dbname=$dbLogFile";
          $dbhLog    = DBI->connect($dsnLog, undef, undef, { RaiseError => 1, AutoCommit => 1 })
                       or Win32::GUI::MessageBox($win, $STR{'errConnectingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
        }
        # Load Whois Server Database
        my $ref_WSDB = json_file_to_perl($CONFIG{'WS_DB_FILE'});
        foreach my $item (sort { $itemsIndex{$a} <=> $itemsIndex{$b} } keys(%itemsIndex)) {
          my $answer;
          my $return;
          $count++;
          $winPb->lblCount->Text("$count / $nbrItems");
          $winPb->lblPbCurr->Text("Whois on $item...");
          # Check databases
          if (($checkDBOpt and ($checkDBOpt == 1 or $checkDBOpt == 2) and $win->chNetwork->Checked()) or $checkLogging) {
            my $resCheckDB;
            # Check Whois Database (Network whois only)
            if ($checkDBOpt and ($checkDBOpt == 1 or $checkDBOpt == 2) and $win->chNetwork->Checked() and
                ($itemsType{$item} eq 'IPv4' or $itemsType{$item} eq 'IPv6')) {
              my ($isp, $country, $time);
              if    ($item =~ /\./) { ($isp, $country, $time) = &checkIP_WhoisDB_IPv4($item, \$dbh); } # IPv4
              elsif ($item =~ /\:/) { ($isp, $country, $time) = &checkIP_WhoisDB_IPv6($item, \$dbh); } # IPv6
              # ISP is already known, ignore the request
              if    ($checkDBOpt == 2 and $isp) { $answer = 7; }
              # ISP is already known, ask user what to do
              elsif ($checkDBOpt == 1 and $isp) {
                my $dateStr  = &time2DateLong($time);
                my $ispStr   = "$STR{'ISP'}: $isp\n$STR{'cbFilterField4'}: $country\n$STR{'date'}: $dateStr";
                $resCheckDB .= "$STR{'item'} \xAB $item \xBB $STR{'wasFoundWhoisDB'}:\n\n$ispStr\n\n";
              }
            }
            # Check Logging Database
            if ($checkLogging and !$answer) {
              my ($nbrResults, @results) = &check_LoggingDB($item, \$dbhLog);
              if ($nbrResults) {
                # More than 3 results
                if ($nbrResults > 3) { $resCheckDB .= "$STR{'more3entries'} \xAB $item \xBB $STR{'inLoggingDBLast3'}:\n\n"; }
                else                 { $resCheckDB .= "$STR{'item'} \xAB $item \xBB $STR{'wasFoundLoggingDB'}:\n\n"; }
                # Add entries to message
                foreach my $entry (@results) {
                  my @fields = split(/\t/, $entry);
                  my $logStr = "$STR{'date'}: $fields[0]\n$STR{'request'}: $fields[1]\n";
                  if ($fields[2] ne 'NULL') { $logStr .= "$STR{'details'}: $fields[2]\n"; }
                  else                      { $logStr .= "$STR{'details'}:\n";            }
                  if ($fields[3] ne 'NULL') { $logStr .= "$STR{'comment'}: $fields[3]\n"; }
                  else                      { $logStr .= "$STR{'comment'}:\n";            }
                  $resCheckDB .= "$logStr\n";
                }
              }
            }
            # Entry was found, Ask the user ?
            if (!$answer and $resCheckDB) {
              $answer = Win32::GUI::MessageBox($win, $resCheckDB.$STR{'sendQueryAnyway'}, $STR{'checkDB'}, 0x1023);
              $winPb->SetForegroundWindow();
            }
          }
          # Cancel (2), finish all requests
          if ($answer and $answer == 2) {
            &winPb_Terminate;
            last;
          # Answer is No (7) or Check database option is ignore, ignore this request
          } elsif ($answer and $answer == 7) { next; }
          # Answer is Yes (6), send the request
          else {
            # Send request
            my $refAnswer = &whoisReq($item, $itemsType{$item}, $ref_WSDB, \$TLDDB, \%IPv4, \%IPv6);
            # Get local time
            my ($s,$min,$hr,$d,$m,$y) = (&date(0))[0,1,2,3,4,5];
            my $dateOffset = gmt_offset();
            my $date       = "$y-$m-$d $hr:$min:$s GMT $dateOffset";
            # Write the report
            $return = &writeReport($refAnswer, $date);
            # Feed logging database
            if ($winConfig->chLogActivate->Checked()) {
              # Set lookup string
              my $lookup;
              my $i = 1;
              if    ($$refAnswer{'lookup'.'1'}){ $lookup  = "Resolved: " . $$refAnswer{"lookup$i"};      $i++; }
              while ($$refAnswer{"lookup$i"})  { $lookup .= ", ".$$refAnswer{"lookup$i"}; $i++; }
              my $comment = $win->tfComment->Text();
              if (!$comment) { $comment = 'NULL'; }
              if (!$lookup)  { $lookup  = 'NULL'; }
              &logRequest($item, \$dbhLog, $lookup, $date, $comment);
            }
          }
          # Set report filename
          my $filename = $item;
          $filename =~ s/[\<\>\:\"\/\\\|\?\*]/_/g; # Replace unauthorized character by _
          my $reportPath =  "$targetDir\\$filename\.html";
          # Check if report already exists
          if ($winConfig->chReplace->Checked() == 0) {
            my $k = 1;
            while (-e $reportPath) {
              $k++;
              $reportPath = "$targetDir\\$filename req$k\.html";
            }
          }
          # Write report to file
          open(HTML,">$reportPath") or Win32::GUI::MessageBox($win, $STR{'errWritingReport'}.$!, $STR{'error'}, 0x40010);
          flock(HTML, 2);
          print HTML $return;
          close(HTML);
          # Feed whois database
          my $refExtractedISP = &extractISPData($reportPath);
          my $result2log;
          foreach my $newISP (keys %{$refExtractedISP}) {
            my $lineInGrid;
            if ($newISP) {
              # Fields ($newISP): 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
              my @fields = split(/\t/, $newISP);
              # Check if ISP already exists in database
              my $response;
              if    ($fields[0] eq 'IPv4') { $response = &checkISP_IPv4(\$dbh, $fields[1], $fields[2]); }
              elsif ($fields[0] eq 'IPv6') { $response = &checkISP_IPv6(\$dbh, $fields[1]); }
              # Fields ($response): 0 = Type (IPv4 or IPv6), 1 and 2 = range or cidr, 3 = ISP name, 4 = country, 5 = date
              # ISP exists, modify it ?
              if ($response) {
                my @oldFields = split(/\t/, $response);
                # If option is Check After
                if ($checkDBOpt == 3) {
                  my $oldISPStr = "$STR{'inDatabase'}:\n$STR{'ISP'}: $oldFields[3]\n$STR{'cbFilterField4'}: $oldFields[4]\n$STR{'date'}: $oldFields[5]";
                  my $newISPStr = "$STR{'current'}:\n$STR{'ISP'}: $fields[3]\n$STR{'cbFilterField4'}: $fields[4]\n$STR{'date'}: $fields[5]";
                  $answer = Win32::GUI::MessageBox($win,
                                                   "$STR{'item'} \xAB $item \xBB $STR{'wasFoundWhoisDB'}\n\n$oldISPStr\n\n$newISPStr\n\n$STR{'updateEntry'} ?",
                                                   $STR{'checkWhois'},
                                                   0x1023);
                  $winPb->SetForegroundWindow();
                  # Cancel (2), finish all requests
                  if ($answer == 2) {
                    &winPb_Terminate;
                    last;
                  # Answer is No (7), ignore this result and continue
                  } elsif ($answer == 7) { next; }
                }
                # Answer is Yes (6), modify entry
                if ($checkDBOpt != 3 or $answer == 6) {
                  my $return = &modifyISP(\$dbh, \@fields);
                  if ($return) {
                    $lineInGrid = &modifyISPGrid(\@fields);
                    $nbrModified++;
                    # Store Network whois data
                    if ($winConfig->chDBCache->Checked() and exists($$refExtractedISP{$newISP}) and length($$refExtractedISP{$newISP}) > 1) {
                      &storeNWData($fields[1], $fields[2], \$$refExtractedISP{$newISP}, $lineInGrid);
                    }
                  }
                }
              }
              # ISP doesn't exist, add it
              else {
                my $return = &addISP(\$dbh, \@fields);
                if ($return) {
                  $lineInGrid = &addISPGrid(\@fields);
                  $nbrAdded++;
                  # Store Network whois data
                  if ($winConfig->chDBCache->Checked() and exists($$refExtractedISP{$newISP}) and length($$refExtractedISP{$newISP}) > 1) {
                    &storeNWData($fields[1], $fields[2], \$$refExtractedISP{$newISP}, $lineInGrid);
                  }
                }
              }
            }
          }
          $winPb->pbWinPb->StepIt();
          # Show report depending on config
          if ((!$answer or $answer == 6) and $reportPath) {
            # Auto view reports in default HTML viewer
            if ($winConfig->chAutoViewing->Checked() and $nbrItems <= $winConfig->tfMaxView->Text()) {
              $win->ShellExecute('open', $reportPath,'','',1)
                or Win32::GUI::MessageBox($win, $STR{'errViewingReport'}.Win32::GetLastError(), $STR{'error'}, 0x40010);
            }
            if ($winConfig->chAutoViewDir->Checked()) { &btnOpenDir_Click; } # Auto view folder
          }
        }
        if ($dbh   ) { $dbh->disconnect();    }
        if ($dbhLog) { $dbhLog->disconnect(); }
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        &winPb_Terminate;
        $win->ChangeCursor($ARROW);
        # Refresh grid
        if ($nbrAdded) {
          $winDB->DBGrid->AutoSizeColumns();
          $winDB->DBGrid->ExpandColumnsToFit();
          $winDB->DBGrid->SetListMode();
          $winDB->DBGrid->ScrollPos(1,0);
          $winDB->DBGrid->SortCells(0, 1, \&sortIP);
          $winDB->DBGrid->Refresh();
        }
        # Message
        my $nbrISP = $winDB->DBGrid->GetRows() - 1;
        my $msg;
        if ($nbrAdded)    { $msg .= "$STR{'numberISP'} $STR{'added'}: $nbrAdded\n"; }
        if ($nbrModified) { $msg .= "$STR{'numberISP'} $STR{'modified'}: $nbrModified\n"; }
        $msg .= "$STR{'totalNumberISP'}: $nbrISP\n";
        $winDB->statusBar->Text(" $STR{'numberISP'}: ".$nbrISP);
        Win32::GUI::MessageBox($winDB, $msg, $STR{'winDB'}, 0x40040);
      });
    }
  }

}  #--- End btnWhois_Click

#--------------------------#
sub whoisReq
#--------------------------#
{
  # Local variables
  my ($item, $type, $refWSL, $refTLD, $refIPv4, $refIPv6) = @_;
  my $isIP;
  my $domain;
  my %response;
  my $error = 0;
  # If IP
  $item =~ s/ //g;
  if      ($type eq 'IPv4' or $type eq 'IPv6') {
    $isIP   = 1;
  } elsif (my $extDom = $$refTLD->get_root_domain($item)) {
    $domain = $extDom;
  } else { $error = 1; }
  if ($error != 1) {
    # Do main request
    $response{'query'} = $item;
    if    ($isIP   and ($win->chNetwork->Checked())) {
      $response{'ip'.'1'} = $item;
      &networkWhois($response{'query'}, 1, $item, \%response, $refIPv4, $refIPv6);
    }
    elsif ($domain and ($win->chDomain->Checked())) {
      $response{'domain'.'1'} = $domain;
      &domainWhois($response{'query'}, 1, $domain, \%response, $refTLD, $refWSL);
    }
    # Do secondary request
    my @resps;
    if (($isIP and ($win->chDomain->Checked())) or ($domain and ($win->chNetwork->Checked()))) {
      # NSlookup
      $winPb->lblPbCurr->Text("$response{'query'}: nslookup -> $item");
      my $lookup = &nsLookup($response{'query'}, $type);
      if ($lookup =~ /, /) { @resps = split(/, /, $lookup); }
      else                 { push(@resps, $lookup);         }
      my $i = 1;
      foreach my $resp (@resps) {
        $response{"lookup$i"} = $resp;
        # Do additionnal requests
        if ($isIP) {
          # Domain Whois
          if (my $extDom = $$refTLD->get_root_domain($resp)) {
            $response{"domain$i"} = $extDom;
            &domainWhois($response{'query'}, $i, $extDom, \%response, $refTLD, $refWSL);
          } else { $error = 1; }
          # Network Whois
        } elsif ($resp =~ /^((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))/ or $resp =~ /^($IPv6_re$)/) {
          $response{"ip$i"} = $1;
          &networkWhois($response{'query'}, $i, $1, \%response, $refIPv4, $refIPv6);
        } # Else = No match
        $i++;
      }
    }
    # DNS Records
    if ($win->chDNS->Checked()) {
      my @host;
      # Initial request was an IP address
      if ($isIP) {
        # NSLookup not done
        if (@resps == 0) {
          # NSlookup
          $winPb->lblPbCurr->Text("$item: nslookup -> $item");
          my $lookup = &nsLookup($item, $type);
          if ($lookup =~ /, /) { @host = split(/, /, $lookup); }
          else                 { push(@host, $lookup);         }
        # NSLookup already done
        } else { push(@host, @resps); }
      # Initial request was not an IP address
      } else { push(@host, $item); }
      # Get DNS Infos
      my $j = 1;
      foreach my $domainHost (@host) {
        if (my $extDom = $$refTLD->get_root_domain($domainHost)) {
          if (!$domain) { $domain = $extDom; }
          $winPb->lblPbCurr->Text("$item : DNS records -> $domain");
          $response{"dnsRecords$j"} = &dnsRecords($domainHost, $domain);
        }
        $j++;
      }
    }
  # Erreur
  } else { $response{'error'} = $STR{'errResolver'}."\n"; }
  
  return(\%response);

}  #--- End whoisReq

#--------------------------#
sub whoisQuery
#--------------------------#
{
  # Local variables
  my $registry = shift;
  my $query    = shift;
  my $sock     = IO::Socket::INET->new( PeerAddr => $registry, PeerPort =>'43', Timeout  =>'60');
  if ($sock) {
    print $sock "$query\n";
    my @response = <$sock>;
    close($sock);
    return(\@response);
  } else { return(0); }
  
}  #--- End whoisQuery

#--------------------------#
sub networkWhois
#--------------------------#
{
  # Local variables
  my ($item, $i, $ip, $refResponse, $refIPv4, $refIPv6) = @_;
  my %rirName = ( 'whois.arin.net'    => 'ARIN'   ,
                  'whois.ripe.net'    => 'RIPE'   ,
                  'whois.apnic.net'   => 'APNIC'  ,
                  'whois.krnic.net'   => 'KRNIC'  ,
                  'whois.lacnic.net'  => 'LACNIC' ,
                  'whois.afrinic.net' => 'AFRINIC', );
  my $tempResponse;
  my $search_options = ['NetName','OrgName'];
  my $authority;
  # Find Authority
  if (!$win->cbWSSelect->GetCurSel()) {                     # Auto select registry
    my $whoisServer    = &registry($ip, $refIPv4, $refIPv6);
    if (!$whoisServer) { $whoisServer = 'whois.arin.net'; }
    $authority      = $rirName{$whoisServer};
  } else {                                                  # Force registry
    $authority = $win->cbWSSelect->GetString($win->cbWSSelect->GetCurSel());
  }
  # Whois to ARIN
  if ($authority eq 'ARIN') {
    $winPb->lblPbCurr->Text("$item: ARIN Network whois -> $ip");
    my $refTab;
    ($tempResponse, $refTab) = &whoisip_query($ip, $authority, 'true', 'true', $search_options);
    # Find if other authority
    foreach (@{$tempResponse}) {
      if ((/NetType:\s+Allocated to (\w+)/i) or (/NetType:\s+Early Registrations\, Transferred to (\w+)/i) or (/NetType:\s+Transferred to (\w+)/i)) {
        $authority = uc($1); last;
      } 
    }
  }
  # Authority is RIPE
  if ($authority and $authority eq 'RIPE') {
    $winPb->lblPbCurr->Text("$item: RIPE Network whois -> $ip");
    $tempResponse = &whoisip_query($ip, 'RIPE', 'true', 'true', $search_options);
    foreach (@{$tempResponse}) {
      if (/descr:\s+This network has been transferred to (\w+)/i) { $authority = uc($1); last; }
    }
  }
  # Authority is APNIC, AFRINIC, LACNIC or IANA
  if ($authority and $authority ne 'ARIN' and $authority ne 'RIPE') {
    $winPb->lblPbCurr->Text("$item: $authority Network whois -> $ip");
    $tempResponse = &whoisip_query($ip, $authority, 'true', 'true', $search_options);
  }
  # For LACNIC, remove double line break
  if ($authority eq 'LACNIC') {
    my @tempResponse2;
    foreach my $line (@{$tempResponse}) {
      chomp($line);
      push(@tempResponse2, $line);
    }
    $tempResponse = \@tempResponse2;
  }
  # Keep responses
  $$refResponse{"networkAuth$i"}  = $authority;
  $$refResponse{"networkInfos$i"} = $tempResponse;

}  #--- End networkWhois

#--------------------------#
sub domainWhois
#--------------------------#
{
  # Local variables
  my ($item, $i, $domain, $refResponse, $refTLD, $refWSL) = @_;
  my $whois_server;
  my $whois;
  my $server;
  # Determine the good server
  my $domainExt;
  if ($domainExt = $$refTLD->get_root_domain($domain)) {
    if (exists($$refWSL{$domainExt}{"host"})) { $whois_server = $$refWSL{$domainExt}{"host"}; }
  }
  # Do whois
  $winPb->lblPbCurr->Text("$item: Domain whois -> $domain");
  if ($domainExt !~ /\.ar$/ and $domainExt !~ /\.pk$/ and $domainExt !~ /\.es$/) {
    if ($whois_server) { eval { ($whois, $server) = whois($domain, $whois_server); }; }
    else               { eval { ($whois, $server) = whois($domain); }; }
  }
  if (!$whois and !$server) {
    if ($domainExt =~ /\.ar$/ or $domainExt =~ /\.pk$/ or $domainExt =~ /\.es$/) {
      $$refResponse{"domainRegistrar$i"} = $STR{'WS_Undefined'};
      $$refResponse{"domainInfos$i"}     = $STR{'WS_NoWhoisServer'};
    } else {
      $$refResponse{"domainRegistrar$i"} = $whois_server;
      $$refResponse{"domainInfos$i"}    .= $STR{'errUnknown'};
    }
  } else {
    $$refResponse{"domainRegistrar$i"} = $server;
    $$refResponse{"domainInfos$i"}    .= $whois;
    $$refResponse{"domainInfos$i"}    =~ s/\</\&lt\;/g;
    $$refResponse{"domainInfos$i"}    =~ s/\>/\&gt\;/g;
  }
  
}  #--- End domainWhois

#--------------------------#
sub dnsRecords
#--------------------------#
{
  # Local variables
  my ($host, $domain) = @_;
  my @dnsRecords;
  my @IPaddresses;
  my @nservers;
  # NS Records
  my $res = Net::DNS::Resolver->new();
  my @listNSservers = $res->nameservers;
  #$res->defnames(0);
  #$res->retry(2);
  my $ns_req = $res->query($domain, "NS");
  if (defined($ns_req) and ($ns_req->header->ancount > 0)) {
    #$res->recurse(0);
    $| = 1;
    foreach my $nsrr (grep {$_->type eq "NS" } $ns_req->answer) {
      push(@dnsRecords, $nsrr->string);
      my $ns = $nsrr->nsdname;
      push(@nservers, $ns);
      my $local_res = Net::DNS::Resolver->new();
      my $a_req = $local_res->query($ns, 'A');
      if ($a_req) {
        foreach my $ip (map { $_->address } grep { $_->type eq 'A' } $a_req->answer) {
          push(@listNSservers, $ip);
        }
      }
    }
    $res->nameservers(@listNSservers);
    if (@nservers) {
      # Records for host
      if ($host ne $domain) {
        my $host_res     = Net::DNS::Resolver->new();
        my $host_query   = $host_res->search($host);
        if ($host_query) {
          foreach my $rr ($host_query->answer) {
            if ($rr->type eq "A") { push(@IPaddresses, $rr->address); }
            push(@dnsRecords, $rr->string);
          }
        }
      }
      # A Records
      my $packet1   = $res->query($domain, 'A');
      if ($packet1) { foreach my $rr ($packet1->answer) { push(@dnsRecords, $rr->string); push(@IPaddresses, $rr->address); } }
      # AAAA Records
      my $packet8   = $res->query($domain, 'AAAA');
      if ($packet8) { foreach my $rr ($packet8->answer) { push(@dnsRecords, $rr->string); } }
      # MX Records
      my $packet2   = $res->query($domain, 'MX');
      if ($packet2) { foreach my $rr ($packet2->answer) { push(@dnsRecords, $rr->string); } }
      # CNAME Records
      my $packet3   = $res->query($domain, 'CNAME');
      if ($packet3) { foreach my $rr ($packet3->answer) { push(@dnsRecords, $rr->string); } }
      # TXT Records
      my $packet4   = $res->query($domain, 'TXT');
      if ($packet4) { foreach my $rr ($packet4->answer) { push(@dnsRecords, $rr->string); } }
      my $packet5   = $res->query("_domainkey.".$domain, 'TXT');
      if ($packet5) { foreach my $rr ($packet5->answer) { push(@dnsRecords, $rr->string); } }
      # SOA Records
      my $packet6   = $res->query($domain, 'SOA');
      if ($packet6) { foreach my $rr ($packet6->answer) { push(@dnsRecords, $rr->string); } }
      # PTR Records
      foreach my $ip (@IPaddresses) {
        my $res2      = Net::DNS::Resolver->new();
        $res2->tcp_timeout(2);
        my $reverse   = join( '.', reverse( split /\./, $ip )) . '.in-addr.arpa';
        my $packet7   = $res2->query($reverse, 'PTR');
        if ($packet7) { foreach my $rr ($packet7->answer) { push(@dnsRecords, $rr->string); } }
      }
    }
  } else { return(''); }
  # Sort records
  my @sdnsRecords = map  { $_->[0] }
                    sort { $a->[1] cmp $b->[1] }
                    map  { [ $_, (split(/\t/))[3] ] } @dnsRecords;
  @dnsRecords     = ();
  @dnsRecords     = map  { $_->[0] }
                    sort { $b->[1] cmp $a->[1] }
                    map  { [ $_, (split(/\t/))[0] ] } @sdnsRecords;
  return(\@dnsRecords);
  
}  #--- End dnsRecords

#--------------------------#
sub nsLookup
#--------------------------#
{
  # Local variables
  my($req, $type) = @_;
  my $resp;
  # Resolve IP address
  if ($type eq 'IPv4' or $type eq 'IPv6') {
    my $res = Net::DNS::Resolver->new;
    $res->tcp_timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
    $res->udp_timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
    my $packet = $res->query($req, "PTR", "IN");
    if ($packet) {
      my @addrs  = $packet->answer;
      my $hostname = '';
      foreach (@addrs) { if ($_->type eq 'PTR' and $_->ptrdname) { $hostname .= $_->ptrdname.", "; } }
      if ($hostname) {
        chop($hostname); chop($hostname);
        $resp = $hostname;
      } else { $resp = $STR{'noMatch'}; }
    } else {
      if ($res->errorstring eq 'no nameservers') { $resp = $STR{'errConnection'}; }
      else                                       { $resp = $STR{'noMatch'};       }
    }
  }
  # Resolve domain
  else {
    my $res = Net::DNS::Resolver->new;
    $res->tcp_timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
    $res->udp_timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
    my $packet = $res->query($req);
    if ($packet) {
      my @addrs  = $packet->answer;
      my $addr = '';
      foreach (@addrs) { if ($_->type eq 'A' and $_->address) { $addr .= $_->address.", "; } }
      if ($addr) {
        chop($addr); chop($addr);
        $resp = $addr;
      } else { $resp = $STR{'noMatch'}; }
    } else {
      if ($res->errorstring eq 'no nameservers') { $resp = $STR{'errConnection'}; }
      else                                       { $resp = $STR{'noMatch'};       }
    }
  }
  return($resp);
  
}  #--- End nsLookup

#--------------------------#
sub registry
#--------------------------#
{
  # Local variables
  my ($ip, $refIPv4, $refIPv6) = @_;
  # IPv4
  if ($ip =~ /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/) {
    my @partsIP  = split(/\./, $ip);
    my $prefixIP = shift(@partsIP);
    while (length($prefixIP) < 3) { $prefixIP = '0'.$prefixIP; } # 53 becomes 053
    if (exists($$refIPv4{$prefixIP})) { return($$refIPv4{$prefixIP}); }
  # IPv6
  } else {
    foreach my $range (keys %{$refIPv6}) {
      if (ip_in_range($ip, $range))   { return($$refIPv6{$range});    }
    }
  }
  return(0); # Not found
  
}  #--- End registry
  
#--------------------------#
sub writeReport
#--------------------------#
{
  # Local variables
  my ($refAnswer, $date) = @_;
  my $html;
  my $comment = $win->tfComment->Text();
  # Server list
  my %authServers = ('ARIN'    => 'whois.arin.net'   ,
                     'RIPE'    => 'whois.ripe.net'   ,
                     'APNIC'   => 'whois.apnic.net'  ,
                     'LACNIC'  => 'whois.lacnic.net' ,
                     'AFRINIC' => 'whois.afrinic.net',
                     'KRNIC'   => 'whois.krnic.net'  ,);
  $html  = '<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">' . "\n";
  $html .= '<html>' . "\n";
  $html .= '<head>' . "\n";
  $html .= '<title>';
  $html .= $$refAnswer{'query'};
  $html .= " - XL-Whois $STR{'report'}</title>\n";
  $html .= '<style>' . "\n";
  $html .= 'body { font-family: arial; font-size: 14px; }' . "\n";
  $html .= 'h1 { font-size: 24px; text-align: center; color: #0066CC; }' . "\n";
  $html .= 'h2 { font-size: 20px; text-align: center; color: #FFF; background: #91bbed; width: 100%; max-width: 1024px; margin-left: auto; margin-right: auto; padding: 5px; }' . "\n";
  $html .= 'p {	margin-left: auto; margin-right: auto; width: 100%;	max-width: 1024px; font-size: 16px; }' . "\n";
  $html .= 'pre { margin-left: auto; margin-right: auto; width: 100%; max-width: 1024px; text-align: justify; white-space: pre-wrap; }' . "\n";
  $html .= 'table {	margin-left: auto; margin-right: auto; width: 100%;	max-width: 1024px; }' . "\n";
  $html .= '#header { width: 100%; max-width: 1024px; margin-left: auto; margin-right: auto; }' . "\n";
  $html .= '#query { float: left; margin-left: auto; width: 100px; font-size: 16px; }' . "\n";
  $html .= '#queryItems { font-weight: bold; color: #0066CC; margin-left: 100px; width: auto; font-size: 16px; }' . "\n";
  $html .= '#tdHeader {	background: #91bbed; color: #FFF; text-align: center; font-weight: bold; }' . "\n";
  $html .= '</style>' . "\n";
  $html .= '</head>' . "\n";
  $html .= '<body>' . "\n";
  $html .= "<h1>XL-Whois $STR{'report'}</h1>\n";
  $html .= "<h2>$STR{'query'}</h2>\n";
  $html .= '<div id="header">'."\n".'<div id="query">' . "\n";
  $html .= 'Whois:<br/>' . "\n";
  if ($$refAnswer{'lookup'.'1'}) { $html .= "$STR{'resolve'}:<br/>\n"; }
  $html .= "$STR{'date'}:<br/>\n";
  if ($comment) { $html .= "$STR{'comment'}:\n"; }
  $html .= '</div>' . "\n";
  $html .= '<div id="queryItems">' . "\n";
  if ($$refAnswer{'error'}) { $html .= "$STR{'error'} = $$refAnswer{'error'})\n</div>\n"; }
  else {
    # Query
    $html .= "$$refAnswer{'query'}<br/>\n";
    my $i = 1;
    if ($$refAnswer{'lookup'.'1'})  {
      $html .= $$refAnswer{"lookup$i"}; $i++;
      while ($$refAnswer{"lookup$i"}) { $html .= ", ".$$refAnswer{"lookup$i"}; $i++; }
      $html .= "<br/>\n";
    }
    $html .= $date."<br/>\n";
    if ($comment) { $html .= $comment . "\n"; }
    $html .= '</div>'."\n".'</div>'."\n";
    # Domain whois
    if ($$refAnswer{'domainInfos'.'1'} and ($win->chDomain->Checked())) {
      $html .= '<h2>Domain whois</h2>' . "\n";
      my $j = 1;
      while ($$refAnswer{"domainInfos$j"}) {
        $html .= '<p>Queried <strong style="color:#0066CC;">';
        $html .= $$refAnswer{"domainRegistrar$j"};
        $html .= '</strong> with "<strong style="color:#0066CC;">';
        $html .= $$refAnswer{"domain$j"};
        $html .= '</strong>"...</p>'."\n";
        $html .= '<pre>' . "\n";
        $html .= $$refAnswer{"domainInfos$j"};
        $html .= '</pre>' . "\n";
        $j++;
      }
    }
    # Network whois
    if ($$refAnswer{'networkInfos'.'1'} and ($win->chNetwork->Checked())) {
      $html .= '<h2>Network whois</h2>' . "\n";
      my $k = 1;
      while ($$refAnswer{"networkInfos$k"}) {
        $html .= '<p>Queried <strong style="color:#0066CC;">';
        if ($authServers{$$refAnswer{"networkAuth$k"}}) { $html .= $authServers{$$refAnswer{"networkAuth$k"}}; }
        else                                            { $html .= $$refAnswer{"networkAuth$k"};               }
        $html .= '</strong> with "<strong style="color:#0066CC;">';
        if    ($$refAnswer{"networkAuth$k"} eq 'ARIN') { $html .= "n "; }
        elsif ($$refAnswer{"networkAuth$k"} eq 'RIPE') { $html .= "-B "; }
        $html .= $$refAnswer{"ip$k"};
        $html .= '</strong>"...</p>' . "\n";
        $html .= '<pre>' . "\n";
        foreach (@{$$refAnswer{"networkInfos$k"}}) { $html .= $_; }
        $html .= '</pre>' . "\n";
        $k++;
      }
    }
    # DNS Records
    if ($$refAnswer{'dnsRecords'.'1'}   and ($win->chDNS->Checked())) {
      $html .= '<h2>DNS Records</h2>' . "\n";
      my $l = 1;
      while ($$refAnswer{"dnsRecords$l"}) {
        $html .= '<p>NS Records for <strong style="color:#0066CC;">"';
        if (exists($$refAnswer{"domain$l"})) { $html .= $$refAnswer{"domain$l"}; }
        else                                 { $html .= $$refAnswer{'query'};    }
        $html .= '</strong>"...</p>';
        $html .= '<table cellspacing=0 cellpadding=2 border=1>' . "\n";
        $html .= '<tr>' . "\n";
        $html .= '<td id="tdHeader">name</td>' . "\n";
        $html .= '<td id="tdHeader">ttl</td>' . "\n";
        $html .= '<td id="tdHeader">class</td>' . "\n";
        $html .= '<td id="tdHeader">type</td>' . "\n";
        $html .= '<td id="tdHeader">data</td>' . "\n";
        $html .= '</tr>' . "\n";
        foreach my $line (@{$$refAnswer{"dnsRecords$l"}}) {
          $html .= '<tr>' . "\n";
          $line =~ s/\t;/;/g;
          my(@fields) = split(/\t/, $line);
          my $name  = shift(@fields);
          my $ttl   = shift(@fields);
          my $class = shift(@fields);
          my $type  = shift(@fields);
          my $data  = join(' ', @fields);
          if ($name =~ /\.$/) { chop($name); }
          if ($data =~ /\.$/) { chop($data); }
          $data =~ s/ \)$//g;
          $data =~ s/^\( //g;
          $html .= '<td>' . $name  . '</td>' . "\n";
          $html .= '<td>' . $ttl   . '</td>' . "\n";
          $html .= '<td>' . $class . '</td>' . "\n";
          $html .= '<td>' . $type  . '</td>' . "\n";
          if ($type =~ /SOA/) {
            $html .= '<td>';
            $data =~ s/\n//g;
            $data =~ s/ ?;[^ ]*//g;
            my @soa = split(/\s+/, $data);
            $html .= "Server: $soa[0]<br>";
            $html .= "Email: $soa[1]<br>";
            $html .= "Serial: $soa[2]<br>";
            $html .= "Refresh: $soa[3]<br>";
            $html .= "Retry: $soa[4]<br>";
            $html .= "Expire: $soa[5]<br>";
            $html .= "Minimum: $soa[6]<br>";
            $html .= '</td>';
          } elsif ($type =~ /MX/) {
            my ($preference, $exchange) = split(/ /, $data);
            $html .= '<td>' . "preference = $preference<BR>exchange = $exchange" . '</td>' . "\n";
          } else {
            $html .= '<td>' . $data . '</td>' . "\n";
          }
          $html .= '</tr>' . "\n";
        }
        $html .= '</table><br>' . "\n";
        $l++;
      }
    }
  }
  $html .= '</body>' . "\n";
  $html .= '</html>' . "\n";
  
  return($html);
  
}  #--- End writeReport

#--------------------------#
sub storeNWData
#--------------------------#
{
  # Local variables
  my $range_s    = shift;
  my $range_e    = shift;
  my $refNWData  = shift;
  my $lineInGrid = shift;  
  # Replace not allowed characters for windows filename (IPv6)
  if ($range_s =~ /\:/) {
    my ($ipStart, $ipEnd) = split(/\-/, (Net::CIDR::cidr2range($range_s))[0]);
    $ipStart =~ s/\:/_/g;
    $ipEnd   =~ s/\:/_/g;
    $range_s = $ipStart;
    $range_e = $ipEnd;
  }
  my $networkWhoisDataFile = "$CONFIG{'WHOIS_DATA_CACHE'}\\$range_s\-$range_e\.txt";
  # Write Network whois data to file
  my @lines = split(/[\r\n]/, $$refNWData);
  open(HTML,">$networkWhoisDataFile") or Win32::GUI::MessageBox($win, $STR{'errWritingCache'}.$!, $STR{'error'}, 0x40010);
  flock(HTML, 2);
  foreach (@lines) {
    if ($_) {
      s/[\r\n]//g; # Remove any line break
      if ($_) {
        s/<\/?pre>//g; # Remove <pre> and </pre> tag
        print HTML $_ . "\n";
      }
    }
  }
  close(HTML);
  # Set background color to green in Grid
  if ($lineInGrid) {
    $winDB->DBGrid->SetCellBkColor($lineInGrid, 0, 0x33FF66);
    $winDB->DBGrid->SetCellBkColor($lineInGrid, 1, 0x33FF66);
    $winDB->DBGrid->SetCellBkColor($lineInGrid, 2, 0x33FF66);
    $winDB->DBGrid->SetCellBkColor($lineInGrid, 3, 0x33FF66);
    $winDB->DBGrid->SetCellBkColor($lineInGrid, 4, 0x33FF66);
  }
  
}  #--- End storeNWData
  
#--------------------------#
sub logRequest
#--------------------------#
{
  # Local variables
  my ($item, $refDbhLog, $details, $date, $comment) = @_;
  # Add entry in database
  # Database: table = LOGGING_DB, Fields = date, request, details, comment
  my $sth = $$refDbhLog->prepare("insert or replace into LOGGING_DB (date, request, details, comment) values(?,?,?,?)");
  my $rv  = $sth->execute($date, $item, $details, $comment);
  if ($rv < 0) {
    Win32::GUI::MessageBox($win, $STR{'errUpdateLoggingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
    return(0);
  } else { return(1); }

}  #--- End logRequest

#--------------------------#
sub check_LoggingDB
#--------------------------#
{
  # Local variables
  my ($item, $refDbhLog) = @_;
  my $nbrResults = 0;
  my @results;
  # Check if item is present in database
  # Database: table = LOGGING_DB, Fields = date, request, details, comment
  my $sth = $$refDbhLog->prepare("SELECT date, request, details, comment from LOGGING_DB ORDER BY date DESC");
  my $rv  = $sth->execute();
  if ($rv < 0) { Win32::GUI::MessageBox($win, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010); }
  else {
    my $refAllRows = $sth->fetchall_arrayref();
    foreach my $refRow (@{$refAllRows}) {
      if ($$refRow[1] =~ /$item/ or $$refRow[2] =~ /$item/ or $$refRow[3] =~ /$item/) {
        $nbrResults++;
        if ($nbrResults > 3) { last; } # Max 3 results
        push(@results, "$$refRow[0]\t$$refRow[1]\t$$refRow[2]\t$$refRow[3]");
      }
    }
  }
  if ($nbrResults) { return($nbrResults, @results); }
  else             { return($nbrResults, undef);    }

}  #--- End check_LoggingDB

#--------------------------#
sub btnCancel_Click
#--------------------------#
{
  # Stop requests
  if ($THR) {
    $winPb->lblPbCurr->Text($STR{'cancelling'});
    $winPb->lblCount->Text('');
    &winPb_Terminate;
    $THR->kill('KILL')->detach();
    $winPb->ChangeCursor($ARROW);
  } elsif ($THR_UPDATE and $THR_UPDATE->is_running()) { $THR_UPDATE->kill('KILL')->detach(); }
  return(1);

}  #--- End btnCancel_Click

#--------------------------#
sub winPb_Terminate
#--------------------------#
{
  $winPb->Hide();
  if    ($winDB->IsVisible()) {
    $winDB->Enable();
    $winDB->SetForegroundWindow();
  }
  elsif ($winLogDB->IsVisible()) {
    $winLogDB->Enable();
    $winLogDB->SetForegroundWindow();
  }
  else { $win->Enable(); }
  return(1);

}  #--- End winPb_Terminate

#--------------------------#
sub selectAll_Click
#--------------------------#
{
  if   ($LISTNO == 1) { &gridSelectAll_Click;          } # Select All Whois DB Grid
  elsif($LISTNO == 2) { &logDBGridSelectAll_Click;     } # Select All Logging DB Grid
  elsif($LISTNO == 3) { $winClip->tfClip->SelectAll(); } # Select All Clipboard Textfield
  
}  #--- End selectAll_Click

#--------------------------#
sub btnHelp_Click
#--------------------------#
{
  # Open Firefox to XL-Tools page
  $win->ShellExecute('open', $URL_DOC,'','',1) or Win32::GUI::MessageBox($win, Win32::FormatMessage(Win32::GetLastError()), "$STR{'update3'} XL-Whois",0x40010);

}  #--- End btnHelp_Click

#--------------------------#
sub btnAbout_Click
#--------------------------#
{
  # Create the window
  my $winAbout  = Win32::GUI::DialogBox->new( -name        => 'winAbout'                ,
                                              -parent      => $win                      ,
                                              -text        => $STR{'about'}.' XL-Whois' ,
                                              -pos         => [$winPosX, $winPosY]      ,
                                              -size        => [520, 170]                ,
                                              -background  => [255, 255, 255]           ,
                                              -hasmaximize => 0                         ,
                                              -hasminimize => 1                         ,
                                              -helpbutton  => 0                         ,
                                              -resizable   => 0                         ,
                                              -dialogui    => 1                         , );
  $winAbout->SetIcon($winICO);
  # About tab
  $winAbout->AddLabel(  -name        => 'lblLogo128'            ,
                        -size        => [128,128]               ,
                        -pos         => [  0,  5]               ,
                        -background  => [255, 255, 255]         ,
                        -bitmap      => $logo128Bmp             , );
  $winAbout->AddLabel(  -name        => 'lblAbout1'             ,
                        -size        => [ 90, 75]               ,
                        -pos         => [140, 10]               ,
                        -font        => $font10                 ,
                        -background  => [255, 255, 255]         ,
                        -text        => "$STR{'version'}:\n$STR{'website'}:\n$STR{'author'}:\n$STR{'translatedBy'}:", );
  $winAbout->AddLabel(  -name        => 'lblAbout2'             ,
                        -size        => [230, 75]               ,
                        -pos         => [235, 10]               ,
                        -font        => $font10b                ,
                        -foreground  => [  90, 150, 255]        ,
                        -background  => [255, 255, 255]         ,
                        -text        => "$VERSION\nhttp://www.le-tools.com\nAlain Rioux (admin\@le-tools.com)\n$STR{'translatorName'}", );
  $winAbout->AddLabel(  -name        => 'lblAbout3'             ,
                        -size        => [300, 20]               ,
                        -pos         => [140, 80]               ,
                        -font        => $font10                 ,
                        -background  => [255, 255, 255]         ,
                        -text        => ' Copyright 2015-2016 Alain Rioux', );
  
  $winAbout->Center($win);
  $winAbout->DoModal();
  return(1);

}  #--- End btnAbout_Click

#--------------------------#
sub time2Date
#--------------------------#
{
  # Local variables
  my $unixtime = shift;
  # Convert to string, local timezone
  my ($d,$m,$y) = (localtime($unixtime))[3,4,5];
  $y += 1900;
  $m++;
  $m = $m < 10 ? $m = "0".$m : $m;
  $d = $d < 10 ? $d = "0".$d : $d;
  return("$y-$m-$d");

}  #--- End time2Date

#--------------------------#
sub time2DateLong
#--------------------------#
{
  # Local variables
  my $unixtime = shift;
  # Convert to string, local timezone
  my ($s,$min,$h,$d,$m,$y) = (localtime($unixtime))[0,1,2,3,4,5];
  $y += 1900;
  $m++;
  $m = $m < 10 ? $m = "0".$m : $m;
  $d = $d < 10 ? $d = "0".$d : $d;
  $h   = $h   < 10 ? $h   = "0".$h   : $h;
  $min = $min < 10 ? $min = "0".$min : $min;
  $s   = $s   < 10 ? $s   = "0".$s   : $s;
  return("$y-$m-$d $h:$min:$s");

}  #--- End time2DateLong

#--------------------------#
sub date
#--------------------------#
{
  # Local variables
  my ($time) = @_;
  # Conversion
  if (!$time or $time == 0) { $time = time; }
  my ($s,$min,$h,$d,$m,$y,$d_w,$ha,$isDST) = localtime($time);
  # Format
  $y += 1900;
  $m++;
  $m   = $m   < 10 ? $m   = "0".$m   : $m;
  $d   = $d   < 10 ? $d   = "0".$d   : $d;
  $h   = $h   < 10 ? $h   = "0".$h   : $h;
  $min = $min < 10 ? $min = "0".$min : $min;
  $s   = $s   < 10 ? $s   = "0".$s   : $s;
  return($s,$min,$h,$d,$m,$y,$d_w,$ha,$isDST);

}  #--- End date

#--------------------------#
sub updateAll
#--------------------------#
{
  # Thread 'cancellation' signal handler
  $SIG{'KILL'} = sub {
    $win->ChangeCursor($ARROW);
    # Turn off progress bar
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    $winPb->Hide();
    threads->exit();
  };
  # Thread 'die' signal handler
  $SIG{__DIE__} = sub {
    my $errMsg = (split(/ at /,$_[0]))[0];
    chomp($errMsg);
    $errMsg =~ s/[\t\r\n]/ /g;
    $win->ChangeCursor($ARROW);
    # Turn off progress bar
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    $winPb->Hide();
    Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'error'}, 0x40010);
  };
  sleep(1);
  if ($CONFIG{'TOOL_AUTO_UPDATE'})    { &updateTool(0);   } # Update Tool ?
  if ($CONFIG{'TLD_DB_AUTO_UPDATE'} ) { &updateTLDDB(0);  } # Update TLDDB ?
  if ($CONFIG{'WS_DB_AUTO_UPDATE'}  ) { &updateWSDB(0);   } # Update Whois Server DB ?
  if ($CONFIG{'IPv4_DB_AUTO_UPDATE'}) { &updateIPv4DB(0); } # Update IPv4 DB ?
  if ($CONFIG{'IPv6_DB_AUTO_UPDATE'}) { &updateIPv6DB(0); } # Update IPv6 DB ?
  
}  #--- End updateAll

#--------------------------#
sub createCW
#--------------------------#
{
  # Create Config Wizard Window
  my $winCW  = Win32::GUI::DialogBox->new(-name        => 'winCW'                   ,
                                          -parent      => $win                      , # May be open from many Window
                                          -text        => $STR{'winCW'}             ,
                                          -pos         => [$winPosX, $winPosY]      ,
                                          -size        => [400, 205]                ,
                                          -background  => [255, 255, 255]           ,
                                          -hasmaximize => 0                         ,
                                          -hasminimize => 1                         ,
                                          -helpbutton  => 0                         ,
                                          -resizable   => 0                         ,
                                          -dialogui    => 1                         , );
  $winCW->SetIcon($winICO);
  $winCW->AddLabel(     -name        => 'lblConfigLogo'       ,
                        -size        => [128,128]             ,
                        -pos         => [  0,  5]             ,
                        -bitmap      => $config128Bmp         , );
  $winCW->AddLabel(     -name        => 'lblSetGenOpt'        ,
                        -size        => [220, 22]             ,
                        -pos         => [140, 10]             ,
                        -font        => $font10               ,
                        -text        => $STR{'SetGenOpt'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblSetGenOptDone'    ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 10]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblReportFolder'     ,
                        -size        => [220, 22]             ,
                        -pos         => [140, 30]             ,
                        -font        => $font10               ,
                        -text        => $STR{'createReportFolder'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblReportFolderDone' ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 30]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLoggingDB'        ,
                        -size        => [220, 22]             ,
                        -pos         => [140, 50]             ,
                        -font        => $font10               ,
                        -text        => $STR{'btnLogDbFileNewTip'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLoggingDBDone'    ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 50]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLoggingDBError'   ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 50]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblWhoisDB'          ,
                        -size        => [220, 22]             ,
                        -pos         => [140, 70]             ,
                        -font        => $font10               ,
                        -text        => $STR{'btnDbFileNewTip'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblWhoisDBDone'      ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 70]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblWhoisDBError'     ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 70]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLTLDDB'          ,
                        -size        => [220, 22]             ,
                        -pos         => [140, 90]             ,
                        -font        => $font10               ,
                        -text        => $STR{'downloadTLDDB'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLTLDDBDone'      ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 90]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLTLDDBError'     ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 90]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLWSDB'           ,
                        -size        => [220, 22]             ,
                        -pos         => [140,110]             ,
                        -font        => $font10               ,
                        -text        => $STR{'downloadWSDB'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLWSDBDone'       ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365,110]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLWSDBError'      ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365,110]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLIPv4DB'         ,
                        -size        => [220, 22]             ,
                        -pos         => [140,130]             ,
                        -font        => $font10               ,
                        -text        => $STR{'downloadIPv4DB'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLIPv4DBDone'     ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365,130]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLIPv4DBError'    ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365,130]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLIPv6DB'         ,
                        -size        => [220, 22]             ,
                        -pos         => [140,150]             ,
                        -font        => $font10               ,
                        -text        => $STR{'downloadIPv6DB'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLIPv6DBDone'     ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365,150]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLIPv6DBError'    ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365,150]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  return(\$winCW);

}  #--- End createCW

#--------------------------#
sub firstStart
#--------------------------#
{
  # Local variables
  my $refWinCW = shift;
  # Thread 'cancellation' signal handler
  $SIG{'KILL'} = sub {
    $win->ChangeCursor($ARROW);
    # Turn off progress bar
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    $winPb->Hide();
    $$refWinCW->Hide();
    Win32::GUI::MessageBox($win, $STR{'configSetPart'}, "XL-Whois $VERSION", 0x40040);
    threads->exit();
  };
  # Thread 'die' signal handler
  $SIG{__DIE__} = sub {
    my $errMsg = (split(/ at /,$_[0]))[0];
    chomp($errMsg);
    $errMsg =~ s/[\t\r\n]/ /g;
    $win->ChangeCursor($ARROW);
    # Turn off progress bar
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    $winPb->Hide();
    $$refWinCW->Hide();
    Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'error'}, 0x40010);
  };
  my $answer = Win32::GUI::MessageBox($win, $STR{'firstUse'}, $STR{'config'}, 0x1024);
  # Yes (6), No (7)
  if ($answer == 6) {
    my $dir;
    # Use default directory ? (program directory)
    $answer = Win32::GUI::MessageBox($win, $STR{'defaultDir'}.'('.$USERDIR.') ?', $STR{'config'}, 0x1024);
    # Answer is no, open popup to let user choose a different location
    if ($answer == 7) {
      # Select a folder
      $dir = Win32::GUI::BrowseForFolder( -owner      => $$refWinCW               ,
                                          -title      => $STR{'selectFolder'}.':' ,
                                          -folderonly => 1                        ,
                                          -newui      => 1                        ,
                                          -directory  => $USERDIR                 , );
    # Answer is yes, use default dir
    } else { $dir = $USERDIR; }
    # Selected folder
    if ($dir and -d $dir) {
      $$refWinCW->Top($win->Top()+5);
      $$refWinCW->Left($win->Left()+310);
      $$refWinCW->Show();
      # Configuring General Options
      $$refWinCW->lblSetGenOpt->Show();
      # Tool
      $winConfig->chAutoUpdate->Checked(1);      
      $CONFIG{'TOOL_AUTO_UPDATE'} = 1;
      # General
      $winConfig->tfLookupTO->Text(10); # Set Nslookup timeout to 10 seconds
      $CONFIG{'NSLOOKUP_TIMEOUT'} = 10;
      $winConfig->tfUserAgent->Text('XL-Whois (http://www.le-tools.com)'); # Default User-Agent
      $CONFIG{'USERAGENT'} = 'XL-Whois (http://www.le-tools.com)'; 
      # Parser
      $winConfig->chIPv4->Checked(1);
      $winConfig->chIPv6->Checked(1);
      $winConfig->chHostname->Checked(1);
      $winConfig->chDomainName->Checked(1);
      $CONFIG{'OPT_IPv4'}        = 1;
      $CONFIG{'OPT_IPv6'}        = 1;
      $CONFIG{'OPT_HOSTNAME'}    = 1;
      $CONFIG{'OPT_DOMAIN_NAME'} = 1;
      $$refWinCW->lblSetGenOptDone->Show();
      &saveConfig(\%CONFIG);
      # Configuring Storage
      # Folder for Report
      $$refWinCW->lblReportFolder->Show();
      my $reportDir = "$dir\\whois";
      if (!-d $reportDir) { mkdir($reportDir); }
      $winConfig->tfReportDir->Text($reportDir);
      $winConfig->chAutoViewing->Checked(1); # Set auto viewing
      $CONFIG{'AUTO_VIEWING'} = 1;
      $winConfig->tfMaxView->Text(25); # Set auto viewing max to 25
      $CONFIG{'MAX_VIEW'}   = 25;
      $CONFIG{'DIR_REPORT'} = $reportDir;
      $winConfig->chReplace->Checked(0); # "If report exist, replace" not checked
      $CONFIG{'REPORT_REPLACE'} = 0;
      $winConfig->chAutoViewDir->Checked(0); # Auto view dir not checked
      $CONFIG{'AUTO_VIEW_DIR'}  = 0;
      &saveConfig(\%CONFIG);
      $$refWinCW->lblReportFolderDone->Show();
      # Create Logging Database
      $$refWinCW->lblLoggingDB->Show();
      my $logDbFile = "$dir\\Logging.db";
      my $return = &createLoggingDB($logDbFile);
      # Success
      if ($return) {
        $winConfig->tfLogDbFile->Text($logDbFile);
        $CONFIG{'LOGGING_DB_FILE'} = $logDbFile;
        $winConfig->chLogActivate->Enable();    # Enable Activate Logging option
        $winConfig->chLogActivate->Checked(1);  # Activate Logging
        $CONFIG{'LOGGING'} = 1;
        $win->tfComment->Enable();        # Enable Add Comment
        $win->chCheckLogging->Checked(1); # Set Check Logging Database
        $CONFIG{'CHECK_LOGGING_DB'} = 1;
        $$refWinCW->lblLoggingDBDone->Show();
      # Error
      } else {
        $$refWinCW->lblLoggingDBError->Show();
        Win32::GUI::MessageBox($$refWinCW, $STR{'errCreatingLoggingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      }
      &saveConfig(\%CONFIG);
      # Create Whois Database
      $return = 0;
      $$refWinCW->lblWhoisDB->Show();
      my $dbFile = "$dir\\Whois.db";
      $return = &createWhoisDB($dbFile);
      # Success
      if ($return) {
        $winConfig->tfDbFile->Text($dbFile);
        $CONFIG{'WHOIS_DB_FILE'} = $dbFile;
        $winConfig->chDBCache->Checked(1);  # Set Store Network whois data
        $CONFIG{'WHOIS_CACHE'} = 1;
        $win->cbCheckWhoisDB->SetCurSel(1); # Default is "If present, ask"
        $CONFIG{'CHECK_WHOIS_DB'} = 1;
        $$refWinCW->lblWhoisDBDone->Show();
      # Error
      } else {
        $$refWinCW->lblWhoisDBDone->Show();
        Win32::GUI::MessageBox($$refWinCW, $STR{'errCreatingWhoisDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      }
      &saveConfig(\%CONFIG);
      # Configuring Databases
      # Download TLD Database
      $$refWinCW->lblDLTLDDB->Show();
      $return = &downloadTLDDB(0, "$dir\\effective_tld_names.dat");
      if ($return) { # Error
        $$refWinCW->lblDLTLDDBError->Show();
        Win32::GUI::MessageBox($$refWinCW, "$STR{'errorMsg'}: $return", $STR{'error'}, 0x40010);
      } else { $$refWinCW->lblDLTLDDBDone->Show(); } # Success
      $winConfig->chTLDDBAutoUpt->Checked(1); # Set auto update for TLD Database
      $CONFIG{'TLD_DB_AUTO_UPDATE'} = 1;
      &saveConfig(\%CONFIG);
      # Download Whois Server Database
      $$refWinCW->lblDLWSDB->Show();
      $return = &downloadWSDB(0, "$dir\\tld.json");
      if ($return) { # Error
        $$refWinCW->lblDLWSDBError->Show();
        Win32::GUI::MessageBox($$refWinCW, "$STR{'errDownloadWSDB'}: $return", $STR{'error'}, 0x40010);
      } else { # Success
        $$refWinCW->lblDLWSDBDone->Show();
      }
      $winConfig->chWSDBAutoUpt->Checked(1); # Set auto update for Whois Server Database
      $CONFIG{'WS_DB_AUTO_UPDATE'} = 1;
      &saveConfig(\%CONFIG);
      # Download IPv4 Database
      $$refWinCW->lblDLIPv4DB->Show();
      $return = &downloadIPv4DB(0, "$dir\\ipv4-address-space.csv");
      if ($return) { # Error
        $$refWinCW->lblDLIPv4DBError->Show();
        Win32::GUI::MessageBox($$refWinCW, "$STR{'errDownloadIPv4DB'}: $return", $STR{'error'}, 0x40010);
      } else { # Success
        $$refWinCW->lblDLIPv4DBDone->Show();
      }
      $winConfig->chIPv4DBAutoUpt->Checked(1); # Set auto update for IPv4 Database
      $CONFIG{'IPv4_DB_AUTO_UPDATE'} = 1;
      &saveConfig(\%CONFIG);
      # Download IPv6 Database
      $$refWinCW->lblDLIPv6DB->Show();
      $return = &downloadIPv6DB(0, "$dir\\ipv6-unicast-address-assignments.csv");
      if ($return) { # Error
        $$refWinCW->lblDLIPv6DBError->Show();
        Win32::GUI::MessageBox($$refWinCW, "$STR{'errDownloadIPv6DB'}: $return", $STR{'error'}, 0x40010);
      } else { # Success
        $$refWinCW->lblDLIPv6DBDone->Show();
      }
      $winConfig->chIPv6DBAutoUpt->Checked(1); # Set auto update for IPv6 Database
      $CONFIG{'IPv6_DB_AUTO_UPDATE'} = 1;
      &saveConfig(\%CONFIG);
      &isWhoisReady(0);
      sleep(1);
      $$refWinCW->Hide(); # Close Configuration Wizard
      $win->ChangeCursor($ARROW);
      # Send a test ? (program directory)
      $answer = Win32::GUI::MessageBox($win, $STR{'defaultConfigSet'}, $STR{'config'}, 0x41024);
      if ($answer == 6) {
        # Check Domain and Network whois
        $win->chDomain->Checked(1);
        $win->chNetwork->Checked(1);
        # Push "test.com" to clipboard
        Win32::Clipboard::Set('test.com');
        # Send whois
        &btnWhois_Click;
      }
    }
  }

}  #--- End firstStart

#--------------------------#
sub btnWinConfig_Click
#--------------------------#
{
  # Show Config window with General Tab
  $winConfig->configTab->SetCurSel(0);
  &configTab_Click;
  $winConfig->Center();
  $winConfig->DoModal();

}  #--- End btnWinConfig_Click

#--------------------------#
sub configTab_Click
#--------------------------#
{
  # Show General tab
  if ($winConfig->configTab->SelectedItem() == 0) {
    # General tab
    $winConfig->lblToolShadowT->Show();
    $winConfig->lblToolT->Show();
    $winConfig->btnCheckUpdate->Show();
    $winConfig->chAutoUpdate->Show();
    $winConfig->btnExportLang->Show();
    $winConfig->lblGeneralShadowT->Show();
    $winConfig->lblGeneralT->Show();
    $winConfig->chStartMinimized->Show();
    $winConfig->lblNsLookupTO1->Show();
    $winConfig->tfLookupTO->Show();
    $winConfig->lblNsLookupTO2->Show();
    $winConfig->lblUserAgent->Show();
    $winConfig->tfUserAgent->Show();
    $winConfig->lblParserShadowT->Show();
    $winConfig->lblParserT->Show();
    $winConfig->chIPv4->Show();
    $winConfig->chIPv6->Show();
    $winConfig->chHostname->Show();
    $winConfig->chDomainName->Show();
    # Storage tab
    $winConfig->lblReportShadowT->Hide();
    $winConfig->lblReportT->Hide();
    $winConfig->tfReportDir->Hide();
    $winConfig->btnReportDir->Hide();
    $winConfig->btnOpenDir->Hide();
    $winConfig->chReplace->Hide();
    $winConfig->chAutoViewDir->Hide();
    $winConfig->chAutoViewing->Hide();
    $winConfig->tfMaxView->Hide();
    $winConfig->lblLogDbFileShadowT->Hide();
    $winConfig->lblLogDbFileT->Hide();
    $winConfig->tfLogDbFile->Hide();
    $winConfig->btnLogDbFile->Hide();
    $winConfig->btnLogDbFileNew->Hide();
    $winConfig->btnLogDbView->Hide();
    $winConfig->chLogActivate->Hide();
    $winConfig->lblDbFileShadowT->Hide();
    $winConfig->lblDbFileT->Hide();
    $winConfig->tfDbFile->Hide();
    $winConfig->btnDbFile->Hide();
    $winConfig->btnDbFileNew->Hide();
    $winConfig->btnWhoisDbView->Hide();
    $winConfig->chDBCache->Hide();
    # Databases tab
    $winConfig->lblTLDDBShadowT->Hide();
    $winConfig->lblTLDDBT->Hide();
    $winConfig->chTLDDBAutoUpt->Hide();
    $winConfig->tfTLDDB->Hide();
    $winConfig->btnTLDDB->Hide();
    $winConfig->btnTLDDBUpt->Hide();
    $winConfig->lblWSDBShadowT->Hide();
    $winConfig->lblWSDBT->Hide();
    $winConfig->chWSDBAutoUpt->Hide();
    $winConfig->tfWSDB->Hide();
    $winConfig->btnWSDB->Hide();
    $winConfig->btnWSDBUpt->Hide();
    $winConfig->lblIPv4ShadowT->Hide();
    $winConfig->lblIPv4T->Hide();
    $winConfig->chIPv4DBAutoUpt->Hide();
    $winConfig->tfIPv4DB->Hide();
    $winConfig->btnIPv4DB->Hide();
    $winConfig->btnIPv4DBUpt->Hide();
    $winConfig->lblIPv6ShadowT->Hide();
    $winConfig->lblIPv6T->Hide();
    $winConfig->chIPv6DBAutoUpt->Hide();
    $winConfig->tfIPv6DB->Hide();
    $winConfig->btnIPv6DB->Hide();
    $winConfig->btnIPv6DBUpt->Hide();
  # Show Storage tab
  } elsif ($winConfig->configTab->SelectedItem() == 1) {
    # General tab
    $winConfig->lblToolShadowT->Hide();
    $winConfig->lblToolT->Hide();
    $winConfig->lblReportShadowT->Hide();
    $winConfig->lblReportT->Hide();
    $winConfig->tfReportDir->Hide();
    $winConfig->btnReportDir->Hide();
    $winConfig->btnOpenDir->Hide();
    $winConfig->chReplace->Hide();
    $winConfig->chAutoViewDir->Hide();
    $winConfig->chAutoViewing->Hide();
    $winConfig->tfMaxView->Hide();
    $winConfig->btnCheckUpdate->Hide();
    $winConfig->chAutoUpdate->Hide();
    $winConfig->btnExportLang->Hide();
    $winConfig->lblGeneralShadowT->Hide();
    $winConfig->lblGeneralT->Hide();
    $winConfig->chStartMinimized->Hide();
    $winConfig->lblNsLookupTO1->Hide();
    $winConfig->tfLookupTO->Hide();
    $winConfig->lblNsLookupTO2->Hide();
    $winConfig->lblUserAgent->Hide();
    $winConfig->tfUserAgent->Hide();
    $winConfig->lblParserShadowT->Hide();
    $winConfig->lblParserT->Hide();
    $winConfig->chIPv4->Hide();
    $winConfig->chIPv6->Hide();
    $winConfig->chHostname->Hide();
    $winConfig->chDomainName->Hide();
    # Storage tab
    $winConfig->lblReportShadowT->Show();
    $winConfig->lblReportT->Show();
    $winConfig->tfReportDir->Show();
    $winConfig->btnReportDir->Show();
    $winConfig->btnOpenDir->Show();
    $winConfig->chReplace->Show();
    $winConfig->chAutoViewDir->Show();
    $winConfig->chAutoViewing->Show();
    $winConfig->tfMaxView->Show();
    $winConfig->lblLogDbFileShadowT->Show();
    $winConfig->lblLogDbFileT->Show();
    $winConfig->tfLogDbFile->Show();
    $winConfig->btnLogDbFile->Show();
    $winConfig->btnLogDbFileNew->Show();
    $winConfig->btnLogDbView->Show();
    $winConfig->chLogActivate->Show();
    $winConfig->lblDbFileShadowT->Show();
    $winConfig->lblDbFileT->Show();
    $winConfig->tfDbFile->Show();
    $winConfig->btnDbFile->Show();
    $winConfig->btnDbFileNew->Show();
    $winConfig->btnWhoisDbView->Show();
    $winConfig->chDBCache->Show();
    # Databases tab
    $winConfig->lblTLDDBShadowT->Hide();
    $winConfig->lblTLDDBT->Hide();
    $winConfig->chTLDDBAutoUpt->Hide();
    $winConfig->tfTLDDB->Hide();
    $winConfig->btnTLDDB->Hide();
    $winConfig->btnTLDDBUpt->Hide();
    $winConfig->lblWSDBShadowT->Hide();
    $winConfig->lblWSDBT->Hide();
    $winConfig->chWSDBAutoUpt->Hide();
    $winConfig->tfWSDB->Hide();
    $winConfig->btnWSDB->Hide();
    $winConfig->btnWSDBUpt->Hide();
    $winConfig->lblIPv4ShadowT->Hide();
    $winConfig->lblIPv4T->Hide();
    $winConfig->chIPv4DBAutoUpt->Hide();
    $winConfig->tfIPv4DB->Hide();
    $winConfig->btnIPv4DB->Hide();
    $winConfig->btnIPv4DBUpt->Hide();
    $winConfig->lblIPv6ShadowT->Hide();
    $winConfig->lblIPv6T->Hide();
    $winConfig->chIPv6DBAutoUpt->Hide();
    $winConfig->tfIPv6DB->Hide();
    $winConfig->btnIPv6DB->Hide();
    $winConfig->btnIPv6DBUpt->Hide();
  # Show Databases tab
  } elsif ($winConfig->configTab->SelectedItem() == 2) {
    # General tab
    $winConfig->lblToolShadowT->Hide();
    $winConfig->lblToolT->Hide();
    $winConfig->lblReportShadowT->Hide();
    $winConfig->lblReportT->Hide();
    $winConfig->tfReportDir->Hide();
    $winConfig->btnReportDir->Hide();
    $winConfig->btnOpenDir->Hide();
    $winConfig->chReplace->Hide();
    $winConfig->chAutoViewDir->Hide();
    $winConfig->chAutoViewing->Hide();
    $winConfig->tfMaxView->Hide();
    $winConfig->btnCheckUpdate->Hide();
    $winConfig->chAutoUpdate->Hide();
    $winConfig->btnExportLang->Hide();
    $winConfig->lblGeneralShadowT->Hide();
    $winConfig->lblGeneralT->Hide();
    $winConfig->chStartMinimized->Hide();
    $winConfig->lblNsLookupTO1->Hide();
    $winConfig->tfLookupTO->Hide();
    $winConfig->lblNsLookupTO2->Hide();
    $winConfig->lblUserAgent->Hide();
    $winConfig->tfUserAgent->Hide();
    $winConfig->lblParserShadowT->Hide();
    $winConfig->lblParserT->Hide();
    $winConfig->chIPv4->Hide();
    $winConfig->chIPv6->Hide();
    $winConfig->chHostname->Hide();
    $winConfig->chDomainName->Hide();
    # Storage tab
    $winConfig->lblReportShadowT->Hide();
    $winConfig->lblReportT->Hide();
    $winConfig->tfReportDir->Hide();
    $winConfig->btnReportDir->Hide();
    $winConfig->btnOpenDir->Hide();
    $winConfig->chReplace->Hide();
    $winConfig->chAutoViewDir->Hide();
    $winConfig->chAutoViewing->Hide();
    $winConfig->tfMaxView->Hide();
    $winConfig->lblLogDbFileShadowT->Hide();
    $winConfig->lblLogDbFileT->Hide();
    $winConfig->tfLogDbFile->Hide();
    $winConfig->btnLogDbFile->Hide();
    $winConfig->btnLogDbFileNew->Hide();
    $winConfig->btnLogDbView->Hide();
    $winConfig->chLogActivate->Hide();
    $winConfig->lblDbFileShadowT->Hide();
    $winConfig->lblDbFileT->Hide();
    $winConfig->tfDbFile->Hide();
    $winConfig->btnDbFile->Hide();
    $winConfig->btnDbFileNew->Hide();
    $winConfig->btnWhoisDbView->Hide();
    $winConfig->chDBCache->Hide();
    # Databases tab
    $winConfig->lblTLDDBShadowT->Show();
    $winConfig->lblTLDDBT->Show();
    $winConfig->chTLDDBAutoUpt->Show();
    $winConfig->tfTLDDB->Show();
    $winConfig->btnTLDDB->Show();
    $winConfig->btnTLDDBUpt->Show();
    $winConfig->lblWSDBShadowT->Show();
    $winConfig->lblWSDBT->Show();
    $winConfig->chWSDBAutoUpt->Show();
    $winConfig->tfWSDB->Show();
    $winConfig->btnWSDB->Show();
    $winConfig->btnWSDBUpt->Show();
    $winConfig->lblIPv4ShadowT->Show();
    $winConfig->lblIPv4T->Show();
    $winConfig->chIPv4DBAutoUpt->Show();
    $winConfig->tfIPv4DB->Show();
    $winConfig->btnIPv4DB->Show();
    $winConfig->btnIPv4DBUpt->Show();
    $winConfig->lblIPv6ShadowT->Show();
    $winConfig->lblIPv6T->Show();
    $winConfig->chIPv6DBAutoUpt->Show();
    $winConfig->tfIPv6DB->Show();
    $winConfig->btnIPv6DB->Show();
    $winConfig->btnIPv6DBUpt->Show();
  }

}  #--- End configTab_Click

#--------------------------#
sub btnCheckUpdate_Click { &updateTool(1); }
#--------------------------#

#--------------------------#
sub updateTool
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  # Download the version file  
  my $ua = new LWP::UserAgent;
  $ua->agent($CONFIG{'USERAGENT'});
  #$ua->timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
  $ua->default_header('Accept-Language' => 'en');
  my $req = new HTTP::Request GET => $URL_VER;
  my $res = $ua->request($req);
  # Success, compare versions
  if ($res->is_success) {
    my $status  = $res->code;
    my $content = $res->content;
    my $currVer;
    if ($content =~ /([\d\.]+)/i) { $currVer = $1; }
    # No update available
    if ($currVer le $VERSION) {
      if ($confirm) { Win32::GUI::MessageBox($winConfig, $STR{'update1'}, $STR{'update2'}, 0x40040); } # Up to date
    } else {
      my $answer = Win32::GUI::MessageBox($winConfig, "$STR{'update4'} $currVer $STR{'update5'} ?", $STR{'update3'}, 0x40024); # Download available
      # Download the update
      if ($answer == 6) {
        # Open Firefox to XL-Whois page
        $win->ShellExecute('open', $URL_TOOL,'','',1) or
          Win32::GUI::MessageBox($winConfig, Win32::FormatMessage(Win32::GetLastError()), $STR{'error'},0x40010);
      }
    }
  }
  elsif ($confirm) { Win32::GUI::MessageBox($winConfig, $STR{'errConnection'}.': '.$res->status_line, $STR{'error'},0x40010); } # Error

}  #--- End updateTool

#--------------------------#
sub chAutoUpdate_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chAutoUpdate->Checked()) {
    $CONFIG{'TOOL_AUTO_UPDATE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'TOOL_AUTO_UPDATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chAutoUpdate_Click

#--------------------------#
sub btnExportLang_Click
#--------------------------#
{
  # Save strings in Lang.ini
  open(LANG, ">$LANG_FILE");
  flock(LANG, 2);
  foreach my $cle (keys %STR) { print LANG "$cle = $STR{$cle}\n"; }
  close(LANG);
  # Open the page
  $win->ShellExecute('open', $LANG_FILE,'','',1);

}  #--- End btnExportLang_Click

#--------------------------#
sub chIPv4_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chIPv4->Checked()) {
    $CONFIG{'OPT_IPv4'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'OPT_IPv4'} = 0;
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End chIPv4_Click

#--------------------------#
sub chIPv6_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chIPv6->Checked()) {
    $CONFIG{'OPT_IPv6'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'OPT_IPv6'} = 0;
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End chIPv6_Click

#--------------------------#
sub chHostname_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chHostname->Checked()) {
    $CONFIG{'OPT_HOSTNAME'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'OPT_HOSTNAME'} = 0;
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End chHostname_Click

#--------------------------#
sub chDomainName_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chDomainName->Checked()) {
    $CONFIG{'OPT_DOMAIN_NAME'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'OPT_DOMAIN_NAME'} = 0;
    &saveConfig(\%CONFIG);
  }
  &isWhoisReady(0);

}  #--- End chDomainName_Click

#--------------------------#
sub chStartMinimized_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chStartMinimized->Checked()) {
    $CONFIG{'START_MINIMIZED'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'START_MINIMIZED'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chStartMinimized_Click

#--------------------------#
sub tfLookupTO_Change
#--------------------------#
{
  # Local variables
  my $lookupTO = $winConfig->tfLookupTO->Text();
  # Remember
  if ($lookupTO) {
    $CONFIG{'NSLOOKUP_TIMEOUT'} = $lookupTO;
    &saveConfig(\%CONFIG);
  }

}  #--- End tfLookupTO_Change

#--------------------------#
sub tfUserAgent_Change
#--------------------------#
{
  # Local variables
  my $userAgent = $winConfig->tfUserAgent->Text();
  # Remember
  if ($userAgent) {
    $CONFIG{'USERAGENT'} = $userAgent;
    &saveConfig(\%CONFIG);
  }

}  #--- End tfUserAgent_Change

#--------------------------#
sub chAutoViewing_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chAutoViewing->Checked()) {
    $CONFIG{'AUTO_VIEWING'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'AUTO_VIEWING'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chAutoViewing_Click

#--------------------------#
sub tfMaxView_Change
#--------------------------#
{
  # Local variables
  my $maxView = $winConfig->tfMaxView->Text();
  # Remember
  if ($maxView) {
      $CONFIG{'MAX_VIEW'} = $maxView;
      &saveConfig(\%CONFIG);
  }

}  #--- End tfMaxView_Change

#--------------------------#
sub tfReportDir_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $winConfig->tfReportDir->Text();
  # Remember
  if ($saveDir and -d $saveDir) {
    $CONFIG{'DIR_REPORT'} = $saveDir;
    &saveConfig(\%CONFIG);
  } else { # Invalid file or no file
    delete($CONFIG{'DIR_REPORT'});
    &saveConfig(\%CONFIG);
    if ($saveDir) {
      $winConfig->tfReportDir->Text('');
      if ($START == 1) { Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'error'}, 0x40010); }
    }
  }
  if ($START == 1) { &isWhoisReady(0); }

}  #--- End tfReportDir_Change

#--------------------------#
sub btnReportDir_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfReportDir->Text();
  my $dir;
  # Show BrowseForFolder dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winConfig             ,
                                        -title      => $STR{'btnReportDirTip'},
                                        -folderonly => 1                      ,
                                        -directory  => $lastDir               ,
                                        -newui      => 1                      , );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winConfig             ,
                                        -title      => $STR{'btnReportDirTip'},
                                        -folderonly => 1                      ,
                                        -newui      => 1                      , );
  }
  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $winConfig->tfReportDir->Text($dir);
  }
  &isWhoisReady(0);
  
}  #--- End btnReportDir_Click

#--------------------------#
sub btnOpenDir_Click
#--------------------------#
{
  # Local variables
  my $outputDir = $winConfig->tfReportDir->Text();
  if (-d $outputDir) {
    # Open Window Explorer
    Win32::Process::Create(my $ProcessObj                 ,
                           "$ENV{'WINDIR'}\\explorer.exe" ,
                           "explorer $outputDir"          ,
                           0                              ,
                           NORMAL_PRIORITY_CLASS          ,
                           ".");
  }

}  #--- End btnOpenDir_Click

#--------------------------#
sub chReplace_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chReplace->Checked()) {
    $CONFIG{'REPORT_REPLACE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'REPORT_REPLACE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chReplace_Click

#--------------------------#
sub chAutoViewDir_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chAutoViewDir->Checked()) {
    $CONFIG{'AUTO_VIEW_DIR'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'AUTO_VIEW_DIR'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chAutoViewDir_Click

#--------------------------#
sub chLogActivate_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chLogActivate->Checked()) {
    $CONFIG{'LOGGING'} = 1;
    &saveConfig(\%CONFIG);
    $win->tfComment->Enable();
  } else {
    $CONFIG{'LOGGING'} = 0;
    &saveConfig(\%CONFIG);
    $win->tfComment->Disable();
  }

}  #--- End chLogActivate_Click

#--------------------------#
sub tfLogDbFile_Change
#--------------------------#
{
  # Local variables
  my $dbLogFile = $winConfig->tfLogDbFile->Text();
  # Remember
  if ($dbLogFile and -f $dbLogFile) {
    # Reload Logging Database
    threads->create(sub {
      if(&loadLoggingDB) {
        $CONFIG{'LOGGING_DB_FILE'} = $dbLogFile;
        $winConfig->chLogActivate->Enable();
        $win->chCheckLogging->Enable();
        &saveConfig(\%CONFIG);
      } else { # Invalid database
        delete($CONFIG{'LOGGING_DB_FILE'});
        $winConfig->chLogActivate->Checked(0);
        $winConfig->chLogActivate->Disable();
        $CONFIG{'LOGGING'} = 0;
        $win->chCheckLogging->Checked(0);
        $win->chCheckLogging->Disable();
        $CONFIG{'CHECK_LOGGING_DB'} = 0;
        $win->tfComment->Text('');
        $win->tfComment->Disable();
        &saveConfig(\%CONFIG);
        $winConfig->tfLogDbFile->Text('');
      }
    });
  } else { # Invalid file or no file
    delete($CONFIG{'LOGGING_DB_FILE'});
    $winConfig->chLogActivate->Checked(0);
    $winConfig->chLogActivate->Disable();
    $CONFIG{'LOGGING'} = 0;
    $win->chCheckLogging->Checked(0);
    $win->chCheckLogging->Disable();
    $CONFIG{'CHECK_LOGGING_DB'} = 0;
    $win->tfComment->Text('');
    $win->tfComment->Disable();
    &saveConfig(\%CONFIG);
    if ($dbLogFile) {
      $winConfig->tfLogDbFile->Text('');
      if ($START == 1) { Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'error'}, 0x40010); }
    }
    if ($START == 1) { &isWhoisReady(0); }
  }

}  #--- End tfLogDbFile_Change

#--------------------------#
sub btnLogDbFile_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfLogDbFile->Text();
  my $logDbFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $logDbFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                  ,
                                              -title         => $STR{'btnLogDbFileTip'}.':' ,
                                              -defaultfilter => 0                           ,
                                              -filemustexist => 1                           ,
                                              -directory     => $lastDir                    ,
                                              -explorer      => 1                           , );
  } else {
    $logDbFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                  ,
                                              -title         => $STR{'btnLogDbFileTip'}.':' ,
                                              -defaultfilter => 0                           ,
                                              -filemustexist => 1                           ,
                                              -explorer      => 1                           , );
  }
  # Selected file
  if ($logDbFile and -f $logDbFile) { $winConfig->tfLogDbFile->Text($logDbFile); }

}  #--- End btnLogDbFile_Click

#--------------------------#
sub btnLogDbFileNew_Click
#--------------------------#
{
  my $logDbFile = Win32::GUI::GetOpenFileName(-owner            => $winConfig             ,
                                              -title            => $STR{'btnLogDbFileNew'},
                                              -defaultfilter    => 0              ,
                                              -directory        => $USERDIR       ,
                                              -file             => 'Logging.db'   ,
                                              -defaultextension => 'db'           ,
                                              -explorer         => 1              , );
  # Selected file
  if ($logDbFile) {
    # Create a new Logging Database
    my $return = &createLoggingDB($logDbFile);
    # Success
    if ($return) {
      $winConfig->tfLogDbFile->Text($logDbFile);
      Win32::GUI::MessageBox($winConfig, $STR{'dbCreated'}, $STR{'winLogDB'}, 0x40040);
    } else { Win32::GUI::MessageBox($winConfig, $STR{'errCreatingDB'}.$DBI::errstr, $STR{'error'}, 0x40010); } # Error
  }

}  #--- End btnLogDbFileNew_Click

#--------------------------#
sub createLoggingDB
#--------------------------#
{
  # Local variables
  my $logDbFile = shift;
  # Create a new database
  my $dsn = "DBI:SQLite:dbname=$logDbFile";
  my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 }) or return(0);
  # Create main table
  my $stmt = qq(CREATE TABLE IF NOT EXISTS LOGGING_DB
                (date       DATE          NOT NULL,
                 request    VARCHAR(255)  NOT NULL,
                 details    VARCHAR(255)  NOT NULL,
                 comment    VARCHAR(255)  NOT NULL,
                 PRIMARY KEY (date)));
  my $rv = $dbh->do($stmt);
  if ($rv < 0) { return(0); }
  $dbh->disconnect();
  return(1);
  
}  #--- End createLoggingDB

#--------------------------#
sub btnLogDbView_Click
#--------------------------#
{
  # Local variables
  my $logDbFile = $winConfig->tfLogDbFile->Text();
  # Database must exist
  if ($logDbFile and -f $logDbFile) {
    # Load Whois Database
    threads->create(sub { &loadLoggingDB; });
    # Show Window
    $winLogDB->Center($winConfig);
    $winLogDB->DoModal();
  } else { Win32::GUI::MessageBox($winConfig, $STR{'errNoDB'}, $STR{'error'}, 0x40010); }
  return(1);

}  #--- End btnLogDbView_Click

#--------------------------#
sub chDBCache_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chDBCache->Checked()) {
    $CONFIG{'WHOIS_CACHE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'WHOIS_CACHE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chDBCache_Click

#--------------------------#
sub tfDbFile_Change
#--------------------------#
{
  # Local variables
  my $dbFile = $winConfig->tfDbFile->Text();
  my $networkWhoisCacheDir;
  # Set Network Whois Data cache folder
  if ($dbFile) {
    my $whoisDir = $dbFile; # Same folder of Whois Database
    my(@partsWhoisDBPath) = split(/\\/, $whoisDir);
    if (pop(@partsWhoisDBPath) =~ /\./) { while ($whoisDir =~ /[^\\]$/) { chop($whoisDir); } }
    $networkWhoisCacheDir = $whoisDir. 'cache';
    $CONFIG{'WHOIS_DATA_CACHE'} = $networkWhoisCacheDir;
  }
  # Remember
  if ($dbFile and -f $dbFile) {
    # Reload Whois Database
    threads->create(sub {
      if(&loadWhoisDB) {
        $CONFIG{'WHOIS_DB_FILE'} = $dbFile;
        if (!-d $networkWhoisCacheDir) { mkdir($networkWhoisCacheDir); }
        &saveConfig(\%CONFIG);
      } else { # Invalid database
        delete($CONFIG{'WHOIS_DB_FILE'});
        delete($CONFIG{'WHOIS_DATA_CACHE'});
        $win->cbCheckWhoisDB->SetCurSel(0);
        $CONFIG{'CHECK_WHOIS_DB'} = 0;
        $winConfig->chDBCache->Checked(0);
        $CONFIG{'WHOIS_CACHE'} = 0;
        &saveConfig(\%CONFIG);
        $winConfig->tfDbFile->Text('');
      }
      if ($START == 1) { &isWhoisReady(0); }
    });
  } else { # Invalid file or no file
    delete($CONFIG{'WHOIS_DB_FILE'});
    delete($CONFIG{'WHOIS_DATA_CACHE'});
    $win->cbCheckWhoisDB->SetCurSel(0);
    $CONFIG{'CHECK_WHOIS_DB'} = 0;
    $winConfig->chDBCache->Checked(0);
    $CONFIG{'WHOIS_CACHE'} = 0;
    &saveConfig(\%CONFIG);
    if ($dbFile) {
      $winConfig->tfDbFile->Text('');
      if ($START == 1) { Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'error'}, 0x40010); }
    }
    if ($START == 1) { &isWhoisReady(0); }
  }

}  #--- End tfDbFile_Change

#--------------------------#
sub btnDbFile_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfDbFile->Text();
  my $dbFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dbFile = Win32::GUI::GetOpenFileName(  -owner         => $winConfig              ,
                                            -title         => $STR{'btnDbFileTip'}.':',
                                            -defaultfilter => 0                       ,
                                            -file          => 'Whois.db'              ,
                                            -filemustexist => 1                       ,
                                            -directory     => $lastDir                ,
                                            -explorer      => 1                       , );
  } else {
    $dbFile = Win32::GUI::GetOpenFileName(  -owner         => $winConfig              ,
                                            -title         => $STR{'btnDbFileTip'}.':',
                                            -defaultfilter => 0                       ,
                                            -file          => 'Whois.db'              ,
                                            -filemustexist => 1                       ,
                                            -explorer      => 1                       , );
  }
  # Selected file
  if ($dbFile and -f $dbFile) { $winConfig->tfDbFile->Text($dbFile); }
  &isWhoisReady(0);

}  #--- End btnDbFile_Click

#--------------------------#
sub btnDbFileNew_Click
#--------------------------#
{
  my $dbFile = Win32::GUI::GetOpenFileName( -owner            => $winConfig          ,
                                            -title            => $STR{'btnDbFileNew'},
                                            -defaultfilter    => 0                   ,
                                            -directory        => $USERDIR            ,
                                            -file             => 'Whois.db'          ,
                                            -defaultextension => 'db'                ,
                                            -explorer         => 1                   , );
  # Selected file
  if ($dbFile) {
    # Create a new database
    my $return = &createWhoisDB($dbFile);
    # Success
    if ($return) {
      $winConfig->tfDbFile->Text($dbFile);
      Win32::GUI::MessageBox($winConfig, $STR{'dbCreated'}, $STR{'winDB'}, 0x40040);
    } else { Win32::GUI::MessageBox($winConfig, $STR{'errCreatingDB'}.$DBI::errstr, $STR{'error'}, 0x40010); } # Error
  }
  &isWhoisReady(0);

}  #--- End btnDbFileNew_Click

#--------------------------#
sub createWhoisDB
#--------------------------#
{
  # Local variables
  my $dbFile = shift;
  # Create a new database
  my $dsn = "DBI:SQLite:dbname=$dbFile";
  my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 }) or return(0);
  # Create main table
  my $stmt = qq(CREATE TABLE IF NOT EXISTS WHOIS_DB
                (range_s    INT           NOT NULL,
                 range_e    INT           NOT NULL,
                 isp        VARCHAR(255)  NOT NULL,
                 country    VARCHAR(2)    NOT NULL,
                 date       INT           NOT NULL,
                 PRIMARY KEY (range_s, range_e)));
  my $rv = $dbh->do($stmt);
  if ($rv < 0) { return(0); }
  $dbh->disconnect();
  # Add header to the grid
  $winDB->DBGrid->SetCellText(0, 0, $STR{'cbFilterField1'});
  $winDB->DBGrid->SetCellText(0, 1, $STR{'cbFilterField2'});
  $winDB->DBGrid->SetCellText(0, 2, $STR{'cbFilterField3'});
  $winDB->DBGrid->SetCellText(0, 3, $STR{'cbFilterField4'});
  $winDB->DBGrid->SetCellText(0, 4, $STR{'date'});
  return(1);
  
}  #--- End createWhoisDB

#--------------------------#
sub createWhoisDB_IPV6
#--------------------------#
{
  # Local variables
  my $refDbh = shift;
  # Create a the WHOIS_DB_6 table
  my $stmt = qq(CREATE TABLE IF NOT EXISTS WHOIS_DB_6
                (ipv6_range   VARCHAR(255)  NOT NULL,
                 isp          VARCHAR(255)  NOT NULL,
                 country      VARCHAR(2)    NOT NULL,
                 date         INT           NOT NULL,
                 PRIMARY KEY (ipv6_range)));
  my $rv = $$refDbh->do($stmt);
  
}  #--- End createWhoisDB_IPV6

#--------------------------#
sub btnWhoisDbView_Click
#--------------------------#
{
  my $whoisDB = $winConfig->tfDbFile->Text();
  # Database must exist
  if ($whoisDB and -f $whoisDB) {
    $winDB->Center($winConfig);
    $winDB->DoModal();
  } else { Win32::GUI::MessageBox($winConfig, $STR{'errNoDB'}, $STR{'error'}, 0x40010); }
  return(1);

}  #--- End btnWhoisDbView_Click

#--------------------------#
sub chTLDDBAutoUpt_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chTLDDBAutoUpt->Checked()) {
    $CONFIG{'TLD_DB_AUTO_UPDATE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'TLD_DB_AUTO_UPDATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chTLDDBAutoUpt_Click

#--------------------------#
sub tfTLDDB_Change
#--------------------------#
{
  # Local variables
  my $TLDdbFile = $winConfig->tfTLDDB->Text();
  # Remember
  if ($TLDdbFile and -f $TLDdbFile and &validTLDDB($TLDdbFile)) {
    $CONFIG{'TLD_DB_FILE'} = $TLDdbFile;
    &saveConfig(\%CONFIG);
  } else {
    delete($CONFIG{'TLD_DB_FILE'});
    &saveConfig(\%CONFIG);
    if ($TLDdbFile) {
      $winConfig->tfTLDDB->Text('');
      if ($START == 1) { Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'error'}, 0x40010); }
    }
  }

}  #--- End tfTLDDB_Change

#--------------------------#
sub validTLDDB
#--------------------------#
{
  my $TLDdbFile = shift;
  $TLDDB = Domain::PublicSuffix->new({ 'data_file' => $TLDdbFile });
  if ($TLDDB->get_root_domain('www.google.com')) { return(1); }
  return(0);
  
}  #--- End validTLDDB

#--------------------------#
sub btnTLDDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfTLDDB->Text();
  my $TLDdbFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $TLDdbFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                ,
                                              -title         => $STR{'btnTLDDBTip'}.':'   ,
                                              -defaultfilter => 0                         ,
                                              -filemustexist => 1                         ,
                                              -directory     => $lastDir                  ,
                                              -file          => 'effective_tld_names.dat' ,
                                              -explorer      => 1                         , );
  } else {
    $TLDdbFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                ,
                                              -title         => $STR{'btnTLDDBTip'}.':'   ,
                                              -defaultfilter => 0                         ,
                                              -filemustexist => 1                         ,
                                              -file          => 'effective_tld_names.dat' ,
                                              -explorer      => 1                         , );
  }
  # Selected file
  if ($TLDdbFile and -f $TLDdbFile) { $winConfig->tfTLDDB->Text($TLDdbFile); }

}  #--- End btnTLDDB_Click

#--------------------------#
sub btnTLDDBUpt_Click
#--------------------------#
{
  threads->create(sub { &updateTLDDB(1); });
  return(1);
  
}  #--- End btnTLDDBUpt_Click

#--------------------------#
sub chWSDBAutoUpt_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chWSDBAutoUpt->Checked()) {
    $CONFIG{'WS_DB_AUTO_UPDATE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'WS_DB_AUTO_UPDATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chWSDBAutoUpt_Click

#--------------------------#
sub tfWSDB_Change
#--------------------------#
{
  # Local variables
  my $WSdbFile = $winConfig->tfWSDB->Text();
  # Remember
  if ($WSdbFile and -f $WSdbFile and &validWSDB($WSdbFile)) {
    $CONFIG{'WS_DB_FILE'} = $WSdbFile;
    &saveConfig(\%CONFIG);
  } else {
    delete($CONFIG{'WS_DB_FILE'});
    &saveConfig(\%CONFIG);
    if ($WSdbFile) {
      $winConfig->tfWSDB->Text('');
      if ($START == 1) { Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'error'}, 0x40010); }
    }
  }

}  #--- End tfWSDB_Change

#--------------------------#
sub validWSDB
#--------------------------#
{
  my $WSdbFile = shift;
  eval { json_file_to_perl($WSdbFile); };
  if (!$@) { return(1); }
  return(0);
  
}  #--- End validWSDB

#--------------------------#
sub btnWSDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfWSDB->Text();
  my $WSdbFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $WSdbFile = Win32::GUI::GetOpenFileName(  -owner         => $winConfig            ,
                                              -title         => $STR{'btnWSDBTip'}.':',
                                              -defaultfilter => 0                     ,
                                              -filemustexist => 1                     ,
                                              -directory     => $lastDir              ,
                                              -file          => 'tld.json'            ,
                                              -explorer      => 1                     , );
  } else {
    $WSdbFile = Win32::GUI::GetOpenFileName(  -owner         => $winConfig            ,
                                              -title         => $STR{'btnWSDBTip'}.':',
                                              -defaultfilter => 0                     ,
                                              -filemustexist => 1                     ,
                                              -file          => 'tld.json'            ,
                                              -explorer      => 1                     , );
  }
  # Selected file
  if ($WSdbFile and -f $WSdbFile) { $winConfig->tfWSDB->Text($WSdbFile); }

}  #--- End btnWSDB_Click

#--------------------------#
sub btnWSDBUpt_Click
#--------------------------#
{
  threads->create(sub { &updateWSDB(1); });
  return(1);
  
}  #--- End btnWSDBUpt_Click

#--------------------------#
sub chIPv4DBAutoUpt_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chIPv4DBAutoUpt->Checked()) {
    $CONFIG{'IPv4_DB_AUTO_UPDATE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'IPv4_DB_AUTO_UPDATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chIPv4DBAutoUpt_Click

#--------------------------#
sub tfIPv4DB_Change
#--------------------------#
{
  # Local variables
  my $IPv4dbFile = $winConfig->tfIPv4DB->Text();
  # Remember
  if ($IPv4dbFile and -f $IPv4dbFile and &validIPv4DB($IPv4dbFile)) {
    $CONFIG{'IPv4_DB_FILE'} = $IPv4dbFile;
    &saveConfig(\%CONFIG);
  } else {
    delete($CONFIG{'IPv4_DB_FILE'});
    &saveConfig(\%CONFIG);
    if ($IPv4dbFile) {
      $winConfig->tfIPv4DB->Text('');
      if ($START == 1) { Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'error'}, 0x40010); }
    }
  }

}  #--- End tfIPv4DB_Change

#--------------------------#
sub validIPv4DB
#--------------------------#
{
  # Local variables
  my $IPv4dbFile = shift;
  my $first;
  my $second;
  # Open IPv4 CSV file and read first two lines
  if (open(my $IPv4_CSV, '<', $IPv4dbFile)) {
    while( my $line = <$IPv4_CSV>)  {
      if (!$first) { $first  = $line;       }
      else         { $second = $line; last; }
    }
    close $IPv4_CSV;
    if ($first =~ /^Prefix,/ and $second =~ /^\d{3}\//) { return(1); }
  }
  return(0);

}  #--- End validIPv4DB

#--------------------------#
sub loadIPv4DB
#--------------------------#
{
  # Local variables
  my $refIPv4    = shift;
  my $IPv4dbFile = $winConfig->tfIPv4DB->Text();
  %{$refIPv4} = ();
  # Open IPv4 CSV file
  open(IPV4, $IPv4dbFile) or Win32::GUI::MessageBox($win, $STR{'errReading'}.$!, $STR{'error'},0x40010);
  my @tab = <IPV4>;
  close(IPV4);
  # Store data in memory
  my $header = shift(@tab);
  if ($header =~ /^Prefix,/) {
    foreach (@tab) {
      my @fields = split(/,/, $_);
      if ($fields[3] and $fields[3] =~ /^whois/) {
        my ($prefix, $mask) = split(/\//, $fields[0]);
        $$refIPv4{$prefix} = $fields[3];
      }
    }
    return(1);
  } else { return(0); }  

}  #--- End loadIPv4DB

#--------------------------#
sub btnIPv4DB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfIPv4DB->Text();
  my $IPv4dbFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $IPv4dbFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                ,
                                              -title         => $STR{'btnIPv4DBTip'}.':'  ,
                                              -defaultfilter => 0                         ,
                                              -filemustexist => 1                         ,
                                              -directory     => $lastDir                  ,
                                              -file          => 'ipv4-address-space.csv'  ,
                                              -explorer      => 1                         , );
  } else {
    $IPv4dbFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                ,
                                              -title         => $STR{'btnIPv4DBTip'}.':'  ,
                                              -defaultfilter => 0                         ,
                                              -filemustexist => 1                         ,
                                              -file          => 'ipv4-address-space.csv'  ,
                                              -explorer      => 1                         , );
  }
  # Selected file
  if ($IPv4dbFile and -f $IPv4dbFile) { $winConfig->tfIPv4DB->Text($IPv4dbFile); }

}  #--- End btnIPv4DB_Click

#--------------------------#
sub btnIPv4DBUpt_Click
#--------------------------#
{
  threads->create(sub { &updateIPv4DB(1); });
  return(1);
  
}  #--- End btnIPv4DBUpt_Click

#--------------------------#
sub chIPv6DBAutoUpt_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chIPv6DBAutoUpt->Checked()) {
    $CONFIG{'IPv6_DB_AUTO_UPDATE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'IPv6_DB_AUTO_UPDATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chIPv6DBAutoUpt_Click

#--------------------------#
sub tfIPv6DB_Change
#--------------------------#
{
  # Local variables
  my $IPv6dbFile = $winConfig->tfIPv6DB->Text();
  # Remember
  if ($IPv6dbFile and -f $IPv6dbFile and &validIPv6DB($IPv6dbFile)) {
    $CONFIG{'IPv6_DB_FILE'} = $IPv6dbFile;
    &saveConfig(\%CONFIG);
  } else {
    delete($CONFIG{'IPv6_DB_FILE'});
    &saveConfig(\%CONFIG);
    if ($IPv6dbFile) {
      $winConfig->tfIPv6DB->Text('');
      if ($START == 1) { Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'error'}, 0x40010); }
    }
  }

}  #--- End tfIPv6DB_Change

#--------------------------#
sub validIPv6DB
#--------------------------#
{
  # Local variables
  my $IPv6dbFile = shift;
  my $first;
  my $second;
  # Open IPv6 CSV file and read first two lines
  if (open(my $IPv6_CSV, '<', $IPv6dbFile)) {
    while( my $line = <$IPv6_CSV>)  {
      if (!$first) { $first  = $line;       }
      else         { $second = $line; last; }
    }
    close $IPv6_CSV;
    if ($first =~ /^Prefix,/ and $second =~ /^\d{4}\:/) { return(1); }
  }
  return(0);

}  #--- End validIPv6DB

#--------------------------#
sub loadIPv6DB
#--------------------------#
{
  # Local variables
  my $refIPv6    = shift;
  my $IPv6dbFile = $winConfig->tfIPv6DB->Text();
  %{$refIPv6} = ();
  # Open IPv6 CSV file
  open(IPV6, $IPv6dbFile) or Win32::GUI::MessageBox($win, $STR{'errReading'}.$!, $STR{'error'},0x40010);
  my @tab = <IPV6>;
  close(IPV6);
  # Store data in memory
  my $header = shift(@tab);
  if ($header =~ /^Prefix,/) {
    foreach (@tab) {
      my @fields = split(/,/, $_);
      if ($fields[3] and $fields[3] =~ /^whois/) {
        $$refIPv6{$fields[0]} = $fields[3];
      }
    }
    return(1);
  } else { return(0); }  

}  #--- End loadIPv6DB

#--------------------------#
sub btnIPv6DB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfIPv6DB->Text();
  my $IPv6dbFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $IPv6dbFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                              ,
                                              -title         => $STR{'btnIPv6DBTip'}.':'                ,
                                              -defaultfilter => 0                                       ,
                                              -filemustexist => 1                                       ,
                                              -directory     => $lastDir                                ,
                                              -file          => 'ipv6-unicast-address-assignments.csv'  ,
                                              -explorer      => 1                                       , );
  } else {
    $IPv6dbFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                              ,
                                              -title         => $STR{'btnIPv6DBTip'}.':'                ,
                                              -defaultfilter => 0                                       ,
                                              -filemustexist => 1                                       ,
                                              -file          => 'ipv6-unicast-address-assignments.csv'  ,
                                              -explorer      => 1                                       , );
  }
  # Selected file
  if ($IPv6dbFile and -f $IPv6dbFile) { $winConfig->tfIPv6DB->Text($IPv6dbFile); }

}  #--- End btnIPv6DB_Click

#--------------------------#
sub btnIPv6DBUpt_Click
#--------------------------#
{
  threads->create(sub { &updateIPv6DB(1); });
  return(1);
  
}  #--- End btnIPv6DBUpt_Click

#--------------------------#
sub updateTLDDB
#--------------------------#
{
  # Local variables
	my $confirm = shift;
  my ($upToDate, $return, $dateLocalFile, $dateRemoteFile) = &checkDateTLDDB($confirm);
  # Values for $upToDate
  # 0: Whois Server Database doesn't exist  
  # 1: Database is up to date
  # 2: Database is outdated
  # 3: Error connection
  # 4: Unknown error
  # TLD Database is outdated or doesn't exist
  if (!$upToDate or $upToDate == 2) {
    my $msg;
    if ($dateLocalFile and $dateRemoteFile) {
      Encode::from_to($dateRemoteFile, 'utf8', 'iso-8859-1');
      $msg = "$STR{'currDBDate'}: $dateLocalFile\n$STR{'remoteDBDate'} publicsuffix.org: $dateRemoteFile\n\n$STR{'updateAvailable'} ?";
    } else { $msg = "$STR{'TLDDBNotExist'} ?"; }
    my $answer = Win32::GUI::MessageBox($win, $msg, $STR{'updateTLDDB'}, 0x1024);
    # Answer is No (7)
    if ($answer == 7) { return(0); }
    # Answer is Yes (6), download the update
    else { &downloadTLDDB(1, $winConfig->tfTLDDB->Text()); }
  # TLDDB is up to date, show message if $confirm == 1
  } elsif ($upToDate == 1) {
    if ($confirm) {
      Encode::from_to($dateRemoteFile, 'utf8', 'iso-8859-1');
      Win32::GUI::MessageBox($win,  "$STR{'currDBDate'}: $dateLocalFile\n$STR{'remoteDBDate'} publicsuffix.org: ".
                                    "$dateRemoteFile\n\n$STR{'DBUpToDate'} !", $STR{'updateTLDDB'}, 0x40040);
    }
  # Connection error, show message if $confirm == 1
  } elsif (($upToDate == 3 or $upToDate == 4) and $confirm) {
    if ($upToDate == 3) { Win32::GUI::MessageBox($win, "$STR{'errConnection'}: $return", $STR{'error'}, 0x40010); }
    else                { Win32::GUI::MessageBox($win, "$STR{'errUnknown'}: $return", $STR{'error'}   , 0x40010); }
  }

}  #--- End updateTLDDB

#--------------------------#
sub checkDateTLDDB
#--------------------------#
{
  # Local variables
  my ($confirm)   = @_;
  my $localTLDDB  = $winConfig->tfTLDDB->Text();
  my $lastModifDate;
  # TLD Database doesn't exist or invalid file
  if (!$localTLDDB or !-f $localTLDDB) { return(0, undef, undef, undef); }
  # Check date of local file
  my $dateTLDDB       = (stat($localTLDDB))[9];
  my ($dl, $ml, $yl)  = (&date($dateTLDDB))[3,4,5];
  my $dateLocalFile   = "$yl-$ml-$dl";
  # Check date of the remote file
  my $ua = new LWP::UserAgent;
  $ua->agent($CONFIG{'USERAGENT'});
  #$ua->timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
  $ua->default_header('Accept-Language' => 'en');
  my $req    = new HTTP::Request HEAD => $TLDDB_URL;
  my $res    = $ua->request($req);
  my $return = $res->status_line;
  if ($res->code == 200) {
    $lastModifDate = $res->header('last-modified');
    $TOTAL_SIZE    = $res->header('content_length');
  } else { return(3, $return, undef, undef); } # Error connection
  # Compare local et remote file date
  if ($lastModifDate and my ($y, $m, $d) = parse_date($lastModifDate)) { # Parse date
    my $dateUpt = sprintf("%4d-%02d-%02d", $y, $m, $d);
    my ($yd, $md, $dd)  = split(/-/, $dateUpt);
    if    ($yl  > $yd) { return(1, $return, $dateLocalFile, $dateUpt);   } # TLDDB is up to date
    elsif ($yl == $yd) { # Same year
      if ($ml > $md)     { return(1, $return, $dateLocalFile, $dateUpt); } # TLDDB is up to date
      elsif ($ml == $md) { # Same month
        if ($dl >= $dd) { return(1, $return, $dateLocalFile, $dateUpt);  } # TLDDB is up to date
        else            { return(2, $return, $dateLocalFile, $dateUpt);  } # TLDDB is outdated
      } else { return(2, $return, $dateLocalFile, $dateUpt); }             # TLDDB is outdated
    } else { return(2, $return, $dateLocalFile, $dateUpt); }               # TLDDB is outdated
  } else { return(3, $return, undef, undef); }                  				   # Connection error

}  #--- End checkDateTLDDB

#--------------------------#
sub downloadTLDDB
#--------------------------#
{
  # Local variables
  my $confirm    = shift; # If $confirm == 1, show status in a popup, else return status
  my $localTLDDB = shift; # Local filepath
  if (!$localTLDDB) { $localTLDDB = "$USERDIR\\effective_tld_names.dat"; } # Default location
  # Start an agent
  my $ua = new LWP::UserAgent;
  $ua->agent($CONFIG{'USERAGENT'});
  #$ua->timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
  $ua->default_header('Accept-Language' => 'en');
  # Set the progress bar
  $win->ChangeCursor($HOURGLASS);
  $winPb->lblPbCurr->Text($STR{'connecting'}.' publicsuffix.org...');
  $winPb->lblCount->Text("0 %");
  $winPb->pbWinPb->SetRange(0, 100);
  $winPb->pbWinPb->SetPos(0);
  $winPb->pbWinPb->SetStep(1);
  $winPb->Center($win);
  $winPb->Show();
  # Check size of the remote file
  if (!$TOTAL_SIZE) {
    my $req    = new HTTP::Request HEAD => $TLDDB_URL;
    my $res    = $ua->request($req);
    my $return = $res->status_line;
    if ($res->code == 200) { $TOTAL_SIZE = $res->header('content_length'); }
    else {
      # Turn off progress bar
      $win->ChangeCursor($ARROW);
      $winPb->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
      $winPb->pbWinPb->SetPos(0);
      &winPb_Terminate;
      if ($confirm) {
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $STR{'errConnection'}...", $STR{'error'}, 0x40010);
      } else { return($STR{'errConnection'}); }
    }
  }
  # Download the file
  if ($TOTAL_SIZE) {
    my $downloadData;
    # Download the file
    $winPb->Text($STR{'downloadTLDDB'}.'...');
    $winPb->lblPbCurr->Text($STR{'downloadTLDDB'}.'...');
    my $response = $ua->get($TLDDB_URL, ':content_cb' => sub {
      # Local variables
      my ($data, $response, $protocol) = @_;
      $downloadData       .= $data;                                     # Downloaded data
      my $totalDownloaded  = length($downloadData);                     # Size of downloaded data
      my $completed        = int($totalDownloaded / $TOTAL_SIZE * 100); # Pourcentage of download completed
      $winPb->pbWinPb->SetPos($completed);    # Set the progress bar
      $winPb->lblCount->Text("$completed %"); # Indicate purcentage
    });
    # Save data in a file
    if ($response and $response->is_success) {
      open(TLDDB,">$localTLDDB");
      print TLDDB $downloadData;
      close(TLDDB);
    }
    $downloadData = undef;
    # Finished
    if (-T $localTLDDB) {
      # Turn off progress bar
      $win->ChangeCursor($ARROW);
      $winPb->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
      $winPb->pbWinPb->SetPos(0);
      &winPb_Terminate;
      # Update Config
      $winConfig->tfTLDDB->Text($localTLDDB);
      $CONFIG{'TLD_DB_FILE'} = $localTLDDB;
      if ($confirm) {
        &saveConfig(\%CONFIG);
        Win32::GUI::MessageBox($winConfig, $STR{'updatedTLDDB'}, $STR{'updateTLDDB'}, 0x40040);
      }
    } else {
      # Turn off progress bar
      $win->ChangeCursor($ARROW);
      $winPb->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
      $winPb->pbWinPb->SetPos(0);
      &winPb_Terminate;
      if ($confirm) {
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $STR{'errDownloadTLDDB'}...", $STR{'error'}, 0x40010);
      } else { return($STR{'errDownloadTLDDB'}); }
    }
  } else {
    # Turn off progress bar
    $win->ChangeCursor($ARROW);
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    &winPb_Terminate;
    if ($confirm) {
      Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $STR{'errDownloadTLDDB'}...", $STR{'error'}, 0x40010);
    } else { return($STR{'errDownloadTLDDB'}); }
  }
  $TOTAL_SIZE = 0;
  
}  #--- End downloadTLDDB

#--------------------------#
sub updateWSDB
#--------------------------#
{
  # Local variables
	my $confirm = shift;
  my ($upToDate, $return, $dateLocalFile, $dateRemoteFile) = &checkDateWSDB($confirm);
  # Values for $upToDate
  # 0: Whois Server Database doesn't exist  
  # 1: Database is up to date
  # 2: Database is outdated
  # 3: Error connection
  # 4: Unknown error
  # Whois Server Database is outdated or doesn't exist
  if (!$upToDate or $upToDate == 2) {
    my $msg;
    if ($dateLocalFile and $dateRemoteFile) {
      Encode::from_to($dateRemoteFile, 'utf8', 'iso-8859-1');
      $msg = "$STR{'currDBDate'}: $dateLocalFile\n$STR{'remoteDBDate'} github.com (weppos): $dateRemoteFile\n\n$STR{'updateAvailable'} ?";
    } else { $msg = "$STR{'WSDBNotExist'} ?"; }
    my $answer = Win32::GUI::MessageBox($win, $msg, $STR{'updateWSDB'}, 0x1024);
    # Answer is No (7)
    if ($answer == 7) { return(0); }
    # Answer is Yes (6), download the update
    else { &downloadWSDB(1, $winConfig->tfWSDB->Text()); }
  # WSDB is up to date, show message if $confirm == 1
  } elsif ($upToDate == 1) {
    if ($confirm) {
      Encode::from_to($dateRemoteFile, 'utf8', 'iso-8859-1');
      Win32::GUI::MessageBox($win,  "$STR{'currDBDate'}: $dateLocalFile\n$STR{'remoteDBDate'} github.com (weppos): ".
                                    "$dateRemoteFile\n\n$STR{'DBUpToDate'} !", $STR{'updateWSDB'}, 0x40040);
    }
  # Connection error, show message if $confirm == 1
  } elsif (($upToDate == 3 or $upToDate == 4) and $confirm) {
    if ($upToDate == 3) { Win32::GUI::MessageBox($win, "$STR{'errConnection'}: $return", $STR{'error'}, 0x40010); }
    else                { Win32::GUI::MessageBox($win, "$STR{'errUnknown'}: $return", $STR{'error'}   , 0x40010); }
  }

}  #--- End updateWSDB

#--------------------------#
sub checkDateWSDB
#--------------------------#
{
  # Local variables
  my ($confirm)   = @_;
  my $localWSDB   = $winConfig->tfWSDB->Text();
  my $lastModifDate;
  # if no database
  if (!$localWSDB or !-f $localWSDB) { return(0, undef, undef, undef); }
  # Check date of local file
  my $dateWSDB        = (stat($localWSDB))[9];
  my ($dl, $ml, $yl)  = (&date($dateWSDB))[3,4,5];
  my $dateLocalFile   = "$yl-$ml-$dl";
  # Check date of the remote file
  my $ua = new LWP::UserAgent;
  $ua->agent($CONFIG{'USERAGENT'});
  #$ua->timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
  $ua->default_header('Accept-Language' => 'en');
  my $req    = new HTTP::Request GET => $WSLOG_URL;
  my $res    = $ua->request($req);
  my $return = $res->status_line;
  if ($res->code == 200) {
    if ($res->content =~ /datetime="([^\"]+)"/) { $lastModifDate = $1; }
    $TOTAL_SIZE = $res->header('content_length');
  } else { return(3, $return, undef, undef); } # Error connection
  # Compare local and remote file date
  if ($lastModifDate and my ($y, $m, $d) = parse_date($lastModifDate)) {   # Parse date
    my $dateUpt = sprintf("%4d-%02d-%02d", $y, $m, $d);
    my ($yd, $md, $dd)  = split(/-/, $dateUpt);
    if    ($yl  > $yd) { return(1, $return, $dateLocalFile, $dateUpt);   } # WSDB is up to date
    elsif ($yl == $yd) { # Same year
      if ($ml > $md)     { return(1, $return, $dateLocalFile, $dateUpt); } # WSDB is up to date
      elsif ($ml == $md) { # Same month
        if ($dl >= $dd) { return(1, $return, $dateLocalFile, $dateUpt);  } # WSDB is up to date
        else            { return(2, $return, $dateLocalFile, $dateUpt);  } # WSDB is outdated
      } else { return(2, $return, $dateLocalFile, $dateUpt); }             # WSDB is outdated
    } else { return(2, $return, $dateLocalFile, $dateUpt); }               # WSDB is outdated
  } else { return(3, $return, undef, undef); }                             # Connection error

}  #--- End checkDateWSDB

#--------------------------#
sub downloadWSDB
#--------------------------#
{
  # Local variables
  my $confirm      = shift; # If $confirm == 1, show status in a popup, else return status
  my $localWSDB    = shift; # Local filepath
  if (!$localWSDB) { $localWSDB = "$USERDIR\\tld.json"; } # Default location
  # Start an agent
  my $ua = new LWP::UserAgent;
  $ua->agent($CONFIG{'USERAGENT'});
  #$ua->timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
  $ua->default_header('Accept-Language' => 'en');
  # Set the progress bar
  $win->ChangeCursor($HOURGLASS);
  $winPb->lblPbCurr->Text($STR{'connecting'}.' github.com...');
  $winPb->lblCount->Text("0 %");
  $winPb->pbWinPb->SetRange(0, 100);
  $winPb->pbWinPb->SetPos(0);
  $winPb->pbWinPb->SetStep(1);
  $winPb->Center($win);
  $winPb->Show();
  # Check size of the remote file
  if (!$TOTAL_SIZE) {
    my $req    = new HTTP::Request HEAD => $WSDB_URL;
    my $res    = $ua->request($req);
    my $return = $res->status_line;
    if ($res->code == 200) { $TOTAL_SIZE = $res->header('content_length'); }
    else {
      # Turn off progress bar
      $win->ChangeCursor($ARROW);
      $winPb->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
      $winPb->pbWinPb->SetPos(0);
      &winPb_Terminate;
      if ($confirm) {
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $STR{'errConnection'}...", $STR{'error'}, 0x40010);
      } else { return($STR{'errConnection'}); }
    }
  }
  # Download the file
  if ($TOTAL_SIZE) {
    my $downloadData;
    # Download the file
    $winPb->Text($STR{'downloadWSDB'}.'...');
    $winPb->lblPbCurr->Text($STR{'downloadWSDB'}.'...');
    my $response = $ua->get($WSDB_URL, ':content_cb' => sub {
      # Local variables
      my ($data, $response, $protocol) = @_;
      $downloadData       .= $data;                                     # Downloaded data
      my $totalDownloaded  = length($downloadData);                     # Size of downloaded data
      my $completed        = int($totalDownloaded / $TOTAL_SIZE * 100); # Pourcentage of download completed
      $winPb->pbWinPb->SetPos($completed);    # Set the progress bar
      $winPb->lblCount->Text("$completed %"); # Indicate purcentage
    });
    # Save data in a file
    my @lines = split(/\n/, $downloadData);
    if ($response and $response->is_success) {
      open(WSDB,">$localWSDB");
      # Remove comments from the JSON File (comments crash the parser)
      foreach (@lines) { if ($_ !~ /\s+\/\//) { print WSDB "$_\n"; } }
      close(WSDB);
    }
    $downloadData = undef;
    # Finished
    if (-T $localWSDB) {
      # Turn off progress bar
      $win->ChangeCursor($ARROW);
      $winPb->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
      $winPb->pbWinPb->SetPos(0);
      &winPb_Terminate;
      # Update Config
      $winConfig->tfWSDB->Text($localWSDB);
      $CONFIG{'WS_DB_FILE'} = $localWSDB;
      if ($confirm) {
        &saveConfig(\%CONFIG);
        Win32::GUI::MessageBox($winConfig, $STR{'updatedWSDB'}, $STR{'updateWSDB'}, 0x40040);
      }
    } else {
      # Turn off progress bar
      $win->ChangeCursor($ARROW);
      $winPb->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
      $winPb->pbWinPb->SetPos(0);
      &winPb_Terminate;
      if ($confirm) {
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $STR{'errDownloadWSDB'}...", $STR{'error'}, 0x40010);
      } else { return($STR{'errDownloadWSDB'}); }
    }
  } else {
    # Turn off progress bar
    $win->ChangeCursor($ARROW);
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    &winPb_Terminate;
    if ($confirm) {
      Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $STR{'errDownloadWSDB'}...", $STR{'error'}, 0x40010);
    } else { return($STR{'errDownloadWSDB'}); }
  }
  $TOTAL_SIZE = 0;
  
}  #--- End downloadWSDB

#--------------------------#
sub updateIPv4DB
#--------------------------#
{
  # Local variables
	my $confirm = shift;
  my ($upToDate, $return, $dateLocalFile, $dateRemoteFile) = &checkDateIPv4DB($confirm);
  # Values for $upToDate
  # 0: Whois Server Database doesn't exist  
  # 1: Database is up to date
  # 2: Database is outdated
  # 3: Error connection
  # 4: Unknown error
  # IPv4 Database is outdated or doesn't exist
  if (!$upToDate or $upToDate == 2) {
    my $msg;
    if ($dateLocalFile and $dateRemoteFile) {
      Encode::from_to($dateRemoteFile, 'utf8', 'iso-8859-1');
      $msg = "$STR{'currDBDate'}: $dateLocalFile\n$STR{'remoteDBDate'} iana.org: $dateRemoteFile\n\n$STR{'updateAvailable'} ?";
    } else { $msg = "$STR{'IPv4DBNotExist'} ?"; }
    my $answer = Win32::GUI::MessageBox($win, $msg, $STR{'updateIPv4DB'}, 0x1024);
    # Answer is No (7)
    if ($answer == 7) { return(0); }
    # Answer is Yes (6), download the update
    else { &downloadIPv4DB(1, $winConfig->tfIPv4DB->Text()); }
  # IPv4DB is up to date, show message if $confirm == 1
  } elsif ($upToDate == 1) {
    if ($confirm) {
      Encode::from_to($dateRemoteFile, 'utf8', 'iso-8859-1');
      Win32::GUI::MessageBox($win,  "$STR{'currDBDate'}: $dateLocalFile\n$STR{'remoteDBDate'} iana.org: ".
                                    "$dateRemoteFile\n\n$STR{'DBUpToDate'} !", $STR{'updateIPv4DB'}, 0x40040);
    }
  # Connection error, show message if $confirm == 1
  } elsif (($upToDate == 3 or $upToDate == 4) and $confirm) {
    if ($upToDate == 3) { Win32::GUI::MessageBox($win, "$STR{'errConnection'}: $return", $STR{'error'}, 0x40010); }
    else                { Win32::GUI::MessageBox($win, "$STR{'errUnknown'}: $return", $STR{'error'}   , 0x40010); }
  }

}  #--- End updateIPv4DB

#--------------------------#
sub checkDateIPv4DB
#--------------------------#
{
  # Local variables
  my ($confirm)   = @_;
  my $localIPv4DB = $winConfig->tfIPv4DB->Text();
  my $lastModifDate;
  # IPv4 Database doesn't exist or invalid file
  if (!$localIPv4DB or !-f $localIPv4DB) { return(0, undef, undef, undef); }
  # Check date of local file
  my $dateIPv4DB       = (stat($localIPv4DB))[9];
  my ($dl, $ml, $yl)  = (&date($dateIPv4DB))[3,4,5];
  my $dateLocalFile   = "$yl-$ml-$dl";
  # Check date of the remote file
  my $ua = new LWP::UserAgent;
  $ua->agent($CONFIG{'USERAGENT'});
  #$ua->timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
  $ua->default_header('Accept-Language' => 'en');
  my $req    = new HTTP::Request HEAD => $IPv4DB_URL;
  my $res    = $ua->request($req);
  my $return = $res->status_line;
  if ($res->code == 200) {
    $lastModifDate = $res->header('last-modified');
  } else { return(3, $return, undef, undef); } # Error connection
  # Compare local et remote file date
  if ($lastModifDate and my ($y, $m, $d) = parse_date($lastModifDate)) { # Parse date
    my $dateUpt = sprintf("%4d-%02d-%02d", $y, $m, $d);
    my ($yd, $md, $dd)  = split(/-/, $dateUpt);
    if    ($yl  > $yd) { return(1, $return, $dateLocalFile, $dateUpt);   } # IPv4DB is up to date
    elsif ($yl == $yd) { # Same year
      if ($ml > $md)     { return(1, $return, $dateLocalFile, $dateUpt); } # IPv4DB is up to date
      elsif ($ml == $md) { # Same month
        if ($dl >= $dd) { return(1, $return, $dateLocalFile, $dateUpt);  } # IPv4DB is up to date
        else            { return(2, $return, $dateLocalFile, $dateUpt);  } # IPv4DB is outdated
      } else { return(2, $return, $dateLocalFile, $dateUpt); }             # IPv4DB is outdated
    } else { return(2, $return, $dateLocalFile, $dateUpt); }               # IPv4DB is outdated
  } else { return(3, $return, undef, undef); }                  	  		   # Connection error

}  #--- End checkDateIPv4DB

#--------------------------#
sub downloadIPv4DB
#--------------------------#
{
  # Local variables
  my $confirm        = shift; # If $confirm == 1, show status in a popup, else return status
  my $localIPv4DB    = shift; # Local filepath
  if (!$localIPv4DB) { $localIPv4DB = "$USERDIR\\ipv4-address-space.csv"; } # Default location
  # IPv4DB is small, useless to show progress bar
  $win->ChangeCursor($HOURGLASS);
  if (is_success(getstore($IPv4DB_CSV, $localIPv4DB))) {
    $winConfig->tfIPv4DB->Text($localIPv4DB);
    $CONFIG{'IPv4_DB_FILE'} = $localIPv4DB;
    if ($confirm) {
      &saveConfig(\%CONFIG);
      $win->ChangeCursor($ARROW);
      Win32::GUI::MessageBox($winConfig, $STR{'updatedIPv4DB'}, $STR{'updateIPv4DB'}, 0x40040);
    }
  # Error
  } else {
    if ($confirm) {
      $win->ChangeCursor($ARROW);
      Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $STR{'errDownloadIPv4DB'}...", $STR{'error'}, 0x40010);
    } else { return($STR{'errDownloadIPv4DB'}); }
  }
  
}  #--- End downloadIPv4DB

#--------------------------#
sub updateIPv6DB
#--------------------------#
{
  # Local variables
	my $confirm = shift;
  my ($upToDate, $return, $dateLocalFile, $dateRemoteFile) = &checkDateIPv6DB($confirm);
  # Values for $upToDate
  # 0: Whois Server Database doesn't exist  
  # 1: Database is up to date
  # 2: Database is outdated
  # 3: Error connection
  # 4: Unknown error
  # IPv6 Database is outdated or doesn't exist
  if (!$upToDate or $upToDate == 2) {
    my $msg;
    if ($dateLocalFile and $dateRemoteFile) {
      Encode::from_to($dateRemoteFile, 'utf8', 'iso-8859-1');
      $msg = "$STR{'currDBDate'}: $dateLocalFile\n$STR{'remoteDBDate'} iana.org: $dateRemoteFile\n\n$STR{'updateAvailable'} ?";
    } else { $msg = "$STR{'IPv6DBNotExist'} ?"; }
    my $answer = Win32::GUI::MessageBox($win, $msg, $STR{'updateIPv6DB'}, 0x1024);
    # Answer is No (7)
    if ($answer == 7) { return(0); }
    # Answer is Yes (6), download the update
    else { &downloadIPv6DB(1, $winConfig->tfIPv6DB->Text()); }
  # IPv6DB is up to date, show message if $confirm == 1
  } elsif ($upToDate == 1) {
    if ($confirm) {
      Encode::from_to($dateRemoteFile, 'utf8', 'iso-8859-1');
      Win32::GUI::MessageBox($win,  "$STR{'currDBDate'}: $dateLocalFile\n$STR{'remoteDBDate'} iana.org: ".
                                    "$dateRemoteFile\n\n$STR{'DBUpToDate'} !", $STR{'updateIPv6DB'}, 0x40040);
    }
  # Connection error, show message if $confirm == 1
  } elsif (($upToDate == 3 or $upToDate == 4) and $confirm) {
    if ($upToDate == 3) { Win32::GUI::MessageBox($win, "$STR{'errConnection'}: $return", $STR{'error'}, 0x40010); }
    else                { Win32::GUI::MessageBox($win, "$STR{'errUnknown'}: $return", $STR{'error'}   , 0x40010); }
  }

}  #--- End updateIPv6DB

#--------------------------#
sub checkDateIPv6DB
#--------------------------#
{
  # Local variables
  my ($confirm)   = @_;
  my $localIPv6DB  = $winConfig->tfIPv6DB->Text();
  my $lastModifDate;
  # IPv6 Database doesn't exist or invalid file
  if (!$localIPv6DB or !-f $localIPv6DB) { return(0, undef, undef, undef); }
  # Check date of local file
  my $dateIPv6DB       = (stat($localIPv6DB))[9];
  my ($dl, $ml, $yl)  = (&date($dateIPv6DB))[3,4,5];
  my $dateLocalFile   = "$yl-$ml-$dl";
  # Check date of the remote file
  my $ua = new LWP::UserAgent;
  $ua->agent($CONFIG{'USERAGENT'});
  #$ua->timeout($CONFIG{'NSLOOKUP_TIMEOUT'});
  $ua->default_header('Accept-Language' => 'en');
  my $req    = new HTTP::Request HEAD => $IPv6DB_URL;
  my $res    = $ua->request($req);
  my $return = $res->status_line;
  if ($res->code == 200) {
    $lastModifDate = $res->header('last-modified');
  } else { return(3, $return, undef, undef); } # Error connection
  # Compare local et remote file date
  if ($lastModifDate and my ($y, $m, $d) = parse_date($lastModifDate)) { # Parse date
    my $dateUpt = sprintf("%4d-%02d-%02d", $y, $m, $d);
    my ($yd, $md, $dd)  = split(/-/, $dateUpt);
    if    ($yl  > $yd) { return(1, $return, $dateLocalFile, $dateUpt);   } # IPv6DB is up to date
    elsif ($yl == $yd) { # Same year
      if ($ml > $md)     { return(1, $return, $dateLocalFile, $dateUpt); } # IPv6DB is up to date
      elsif ($ml == $md) { # Same month
        if ($dl >= $dd) { return(1, $return, $dateLocalFile, $dateUpt);  } # IPv6DB is up to date
        else            { return(2, $return, $dateLocalFile, $dateUpt);  } # IPv6DB is outdated
      } else { return(2, $return, $dateLocalFile, $dateUpt); }             # IPv6DB is outdated
    } else { return(2, $return, $dateLocalFile, $dateUpt); }               # IPv6DB is outdated
  } else { return(3, $return, undef, undef); }                  				   # Connection error

}  #--- End checkDateIPv6DB

#--------------------------#
sub downloadIPv6DB
#--------------------------#
{
  # Local variables
  my $confirm        = shift; # If $confirm == 1, show status in a popup, else return status
  my $localIPv6DB    = shift; # Local filepath
  if (!$localIPv6DB) { $localIPv6DB = "$USERDIR\\ipv6-unicast-address-assignments.csv"; } # Default location
  # IPv6DB is small, useless to show progress bar
  $win->ChangeCursor($HOURGLASS);
  if (is_success(getstore($IPv6DB_CSV, $localIPv6DB))) {
    $winConfig->tfIPv6DB->Text($localIPv6DB);
    $CONFIG{'IPv6_DB_FILE'} = $localIPv6DB;
    if ($confirm) {
      &saveConfig(\%CONFIG);
      $win->ChangeCursor($ARROW);
      Win32::GUI::MessageBox($winConfig, $STR{'updatedIPv6DB'}, $STR{'updateIPv6DB'}, 0x40040);
    }
  # Error
  } else {
    if ($confirm) {
      $win->ChangeCursor($ARROW);
      Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $STR{'errDownloadIPv6DB'}...", $STR{'error'}, 0x40010);
    } else { return($STR{'errDownloadIPv6DB'}); }
  }

}  #--- End downloadIPv6DB

#--------------------------#
sub saveConfig
#--------------------------#
{
  # Local variables
  my $refConfig = shift;
  # Save configuration hash values
  open(CONFIG,">$CONFIG_FILE");
  flock(CONFIG, 2);
  foreach my $cle (keys %{$refConfig}) { print CONFIG "$cle = $$refConfig{$cle}\n"; }
  close(CONFIG);

}  #--- End saveConfig

#--------------------------#
sub loadConfig
#--------------------------#
{
  # Local variables
  my $refConfig = shift;
  # Open and load config values
  open(CONFIG, $CONFIG_FILE);
  my @tab = <CONFIG>;
  close(CONFIG);
  foreach (@tab) {
    chomp($_);
    my ($key, $value) = split(/ = /, $_);
    if ($key) { $$refConfig{$key}  = $value; }
  }
  # Options
  if (exists($$refConfig{'OPT_DOMAIN'}))          { $win->chDomain->Checked($$refConfig{'OPT_DOMAIN'});                       }
  else                                            { $win->chDomain->Checked(1);                                               } # Default checked
  if (exists($$refConfig{'OPT_NETWORK'}))         { $win->chNetwork->Checked($$refConfig{'OPT_NETWORK'});                     }
  else                                            { $win->chNetwork->Checked(1);                                              } # Default checked
  if (exists($$refConfig{'OPT_DNS'}))             { $win->chDNS->Checked($$refConfig{'OPT_DNS'});                             }
  else                                            { $win->chDNS->Checked(0);                                                  } # Default is not checked
  # General tab
  if (exists($$refConfig{'TOOL_AUTO_UPDATE'}))    { $winConfig->chAutoUpdate->Checked($$refConfig{'TOOL_AUTO_UPDATE'});       }
  else                                            { $winConfig->chAutoUpdate->Checked(1);                                     } # Default checked
  if (exists($$refConfig{'START_MINIMIZED'}))     { $winConfig->chStartMinimized->Checked($$refConfig{'START_MINIMIZED'});    }
  else                                            { $winConfig->chStartMinimized->Checked(0);                                 } # Default is not checked
  if (exists($$refConfig{'NSLOOKUP_TIMEOUT'}))    { $winConfig->tfLookupTO->Text($$refConfig{'NSLOOKUP_TIMEOUT'});            }
  else                                            { $winConfig->tfLookupTO->Text(10); $$refConfig{'NSLOOKUP_TIMEOUT'} = 10;   } # Default is 10 seconds
  if (exists($$refConfig{'USERAGENT'}))           { $winConfig->tfUserAgent->Text($$refConfig{'USERAGENT'});                  }
  else                                            { $winConfig->tfUserAgent->Text('XL-Whois (http://www.le-tools.com)');
                                                    $$refConfig{'USERAGENT'} = 'XL-Whois (http://www.le-tools.com)';          } # Use Default
  if (exists($$refConfig{'OPT_IPv4'}))            { $winConfig->chIPv4->Checked($$refConfig{'OPT_IPv4'});                     }
  else                                            { $winConfig->chIPv4->Checked(1);                                           } # Default checked
  if (exists($$refConfig{'OPT_IPv6'}))            { $winConfig->chIPv6->Checked($$refConfig{'OPT_IPv6'});                     }
  else                                            { $winConfig->chIPv6->Checked(1);                                           } # Default checked
  if (exists($$refConfig{'OPT_HOSTNAME'}))        { $winConfig->chHostname->Checked($$refConfig{'OPT_HOSTNAME'});             }
  else                                            { $winConfig->chHostname->Checked(1);                                       } # Default checked
  if (exists($$refConfig{'OPT_DOMAIN_NAME'}))     { $winConfig->chDomainName->Checked($$refConfig{'OPT_DOMAIN_NAME'});        }
  else                                            { $winConfig->chDomainName->Checked(1);                                     } # Default checked
  # Folder for report
  if (exists($$refConfig{'DIR_REPORT'}) and
      -d $$refConfig{'DIR_REPORT'})               { $winConfig->tfReportDir->Text($$refConfig{'DIR_REPORT'});                 }
  if (exists($$refConfig{'REPORT_REPLACE'}))      { $winConfig->chReplace->Checked($$refConfig{'REPORT_REPLACE'});            }
  else                                            { $winConfig->chReplace->Checked(0);                                        } # Default is not checked
  if (exists($$refConfig{'AUTO_VIEWING'}))        { $winConfig->chAutoViewing->Checked($$refConfig{'AUTO_VIEWING'});          }
  else                                            { $winConfig->chAutoViewing->Checked(1);                                    } # Default is checked
  if (exists($$refConfig{'MAX_VIEW'}))            { $winConfig->tfMaxView->Text($$refConfig{'MAX_VIEW'});                     }
  else                                            { $winConfig->tfMaxView->Text(25); $$refConfig{'MAX_VIEW'} = 25;            } # Default is 25
  if (exists($$refConfig{'AUTO_VIEW_DIR'}))       { $winConfig->chAutoViewDir->Checked($$refConfig{'AUTO_VIEW_DIR'});         }
  else                                            { $winConfig->chAutoViewDir->Checked(0);                                    } # Default is not checked
  # Logging Database location
  if (exists($$refConfig{'CHECK_LOGGING_DB'}))    { $win->chCheckLogging->Checked($$refConfig{'CHECK_LOGGING_DB'});           }
  else                                            { $win->chCheckLogging->Checked(1);                                         } # Default is checked
  if (exists($$refConfig{'LOGGING_DB_FILE'}) and
      -f $$refConfig{'LOGGING_DB_FILE'})          { $winConfig->tfLogDbFile->Text($$refConfig{'LOGGING_DB_FILE'}); $winConfig->chLogActivate->Enable(); }
  if (exists($$refConfig{'LOGGING'}))             { $winConfig->chLogActivate->Checked($$refConfig{'LOGGING'});               }
  else                                            { $winConfig->chLogActivate->Checked(1);                                    } # Default is checked
  if ($$refConfig{'LOGGING'}) { $win->tfComment->Enable(); } # If logging activated, comment can be added
  # Whois Database
  if (exists($$refConfig{'CHECK_WHOIS_DB'}))      { $win->cbCheckWhoisDB->SetCurSel($$refConfig{'CHECK_WHOIS_DB'});           }
  else                                            { $win->cbCheckWhoisDB->SetCurSel(1);                                       } # Default is "If present, ask"
  if (exists($$refConfig{'WHOIS_DB_FILE'}) and -f $$refConfig{'WHOIS_DB_FILE'}) {
    $winConfig->tfDbFile->Text($$refConfig{'WHOIS_DB_FILE'}); # Whois Data File
    # Set Network Whois Data cache folder
    my $whoisDir = $$refConfig{'WHOIS_DB_FILE'}; # Same folder of Whois Database
    my(@partsWhoisDBPath) = split(/\\/, $whoisDir);
    if (pop(@partsWhoisDBPath) =~ /\./) { while ($whoisDir =~ /[^\\]$/) { chop($whoisDir); } }
    my $networkWhoisCacheDir = $whoisDir. 'cache';
    if (!-d $networkWhoisCacheDir) { mkdir($networkWhoisCacheDir); }
    $$refConfig{'WHOIS_DATA_CACHE'} = $networkWhoisCacheDir;
  }
  if (exists($$refConfig{'WHOIS_CACHE'}))         { $winConfig->chDBCache->Checked($$refConfig{'WHOIS_CACHE'});               }
  else                                            { $winConfig->chDBCache->Checked(1);                                        } # Default is checked
  # TLD Database location
  if (exists($$refConfig{'TLD_DB_FILE'}) and
      -f $$refConfig{'TLD_DB_FILE'})              { $winConfig->tfTLDDB->Text($$refConfig{'TLD_DB_FILE'});                    }
  if (exists($$refConfig{'TLD_DB_AUTO_UPDATE'}))  { $winConfig->chTLDDBAutoUpt->Checked($$refConfig{'TLD_DB_AUTO_UPDATE'});   }
  else                                            { $winConfig->chTLDDBAutoUpt->Checked(1);                                   } # Default is checked
  # WS Database location
  if (exists($$refConfig{'WS_DB_FILE'}) and
      -f $$refConfig{'WS_DB_FILE'})               { $winConfig->tfWSDB->Text($$refConfig{'WS_DB_FILE'});                      }
  if (exists($$refConfig{'WS_DB_AUTO_UPDATE'}))   { $winConfig->chWSDBAutoUpt->Checked($$refConfig{'WS_DB_AUTO_UPDATE'});     }
  else                                            { $winConfig->chWSDBAutoUpt->Checked(1);                                    } # Default is checked
  # IPv4 Database location
  if (exists($$refConfig{'IPv4_DB_FILE'}) and
      -f $$refConfig{'IPv4_DB_FILE'})             { $winConfig->tfIPv4DB->Text($$refConfig{'IPv4_DB_FILE'});                  }
  if (exists($$refConfig{'IPv4_DB_AUTO_UPDATE'})) { $winConfig->chIPv4DBAutoUpt->Checked($$refConfig{'IPv4_DB_AUTO_UPDATE'}); }
  else                                            { $winConfig->chIPv4DBAutoUpt->Checked(1);                                  } # Default is checked
  # IPv6 Database location
  if (exists($$refConfig{'IPv6_DB_FILE'}) and
      -f $$refConfig{'IPv6_DB_FILE'})             { $winConfig->tfIPv6DB->Text($$refConfig{'IPv6_DB_FILE'});                  }
  if (exists($$refConfig{'IPv6_DB_AUTO_UPDATE'})) { $winConfig->chIPv6DBAutoUpt->Checked($$refConfig{'IPv6_DB_AUTO_UPDATE'}); }
  else                                            { $winConfig->chIPv6DBAutoUpt->Checked(1);                                  } # Default is checked

}  #--- End loadConfig